<hr>
<div class="td-content"><h1>Extend Kubernetes</h1><div class="lead">Understand advanced ways to adapt your Kubernetes cluster to the needs of your work environment.</div><div class="section-index"><hr class="panel-line"/><div class="entry"><h5><a href="/docs/tasks/extend-kubernetes/configure-aggregation-layer/">Configure the Aggregation Layer</a></h5><p/></div><div class="entry"><h5><a href="/docs/tasks/extend-kubernetes/custom-resources/">Use Custom Resources</a></h5><p/></div><div class="entry"><h5><a href="/docs/tasks/extend-kubernetes/setup-extension-api-server/">Set up an Extension API Server</a></h5><p/></div><div class="entry"><h5><a href="/docs/tasks/extend-kubernetes/configure-multiple-schedulers/">Configure Multiple Schedulers</a></h5><p/></div><div class="entry"><h5><a href="/docs/tasks/extend-kubernetes/http-proxy-access-api/">Use an HTTP Proxy to Access the Kubernetes API</a></h5><p/></div><div class="entry"><h5><a href="/docs/tasks/extend-kubernetes/socks5-proxy-access-api/">Use a SOCKS5 Proxy to Access the Kubernetes API</a></h5><p/></div><div class="entry"><h5><a href="/docs/tasks/extend-kubernetes/setup-konnectivity/">Set up Konnectivity service</a></h5><p/></div></div></div>
<hr>
<div class="td-content"><h1 data-pagefind-weight="10">Set up Konnectivity service</h1><p>The Konnectivity service provides a TCP level proxy for the control plane to cluster
communication.</p><h2 id="before-you-begin">Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this
tutorial on a cluster with at least two nodes that are not acting as control
plane hosts. If you do not already have a cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>.</p><h2 id="configure-the-konnectivity-service">Configure the Konnectivity service</h2><p>The following steps require an egress configuration, for example:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/konnectivity/egress-selector-configuration.yaml" download="admin/konnectivity/egress-selector-configuration.yaml"><code>admin/konnectivity/egress-selector-configuration.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;admin-konnectivity-egress-selector-configuration-yaml&quot;)" title="Copy admin/konnectivity/egress-selector-configuration.yaml to clipboard"/></div><div class="includecode" id="admin-konnectivity-egress-selector-configuration-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiserver.k8s.io/v1beta1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>EgressSelectorConfiguration<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">egressSelections</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># Since we want to control the egress traffic to the cluster, we use the</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># "cluster" as the name. Other supported values are "etcd", and "controlplane".</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>cluster<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">connection</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># This controls the protocol between the API Server and the Konnectivity</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># server. Supported values are "GRPC" and "HTTPConnect". There is no</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># end user visible difference between the two modes. You need to set the</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># Konnectivity server to work in the same mode.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">proxyProtocol</span>:<span style="color:#bbb"> </span>GRPC<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">transport</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># This controls what transport the API Server uses to communicate with the</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># Konnectivity server. UDS is recommended if the Konnectivity server</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># locates on the same machine as the API Server. You need to configure the</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># Konnectivity server to listen on the same UDS socket.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># The other supported transport is "tcp". You will need to set up TLS </span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># config to secure the TCP transport.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">uds</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">udsName</span>:<span style="color:#bbb"> </span>/etc/kubernetes/konnectivity-server/konnectivity-server.socket<span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>You need to configure the API Server to use the Konnectivity service
and direct the network traffic to the cluster nodes:</p><ol><li>Make sure that
<a href="/docs/tasks/configure-pod-container/configure-service-account/#serviceaccount-token-volume-projection">Service Account Token Volume Projection</a>
feature enabled in your cluster. It is enabled by default since Kubernetes v1.20.</li><li>Create an egress configuration file such as <code>admin/konnectivity/egress-selector-configuration.yaml</code>.</li><li>Set the <code>--egress-selector-config-file</code> flag of the API Server to the path of
your API Server egress configuration file.</li><li>If you use UDS connection, add volumes config to the kube-apiserver:<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">volumeMounts</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>konnectivity-uds<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span>/etc/kubernetes/konnectivity-server<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">readOnly</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">false</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>konnectivity-uds<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">hostPath</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">path</span>:<span style="color:#bbb"> </span>/etc/kubernetes/konnectivity-server<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>DirectoryOrCreate<span style="color:#bbb">
</span></span></span></code></pre></div></li></ol><p>Generate or obtain a certificate and kubeconfig for konnectivity-server.
For example, you can use the OpenSSL command line tool to issue a X.509 certificate,
using the cluster CA certificate <code>/etc/kubernetes/pki/ca.crt</code> from a control-plane host.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>openssl req -subj <span style="color:#b44">"/CN=system:konnectivity-server"</span> -new -newkey rsa:2048 -nodes -out konnectivity.csr -keyout konnectivity.key
</span></span><span style="display:flex"><span>openssl x509 -req -in konnectivity.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out konnectivity.crt -days <span style="color:#666">375</span> -sha256
</span></span><span style="display:flex"><span><span style="color:#b8860b">SERVER</span><span style="color:#666">=</span><span style="color:#a2f;font-weight:700">$(</span>kubectl config view -o <span style="color:#b8860b">jsonpath</span><span style="color:#666">=</span><span style="color:#b44">'{.clusters..server}'</span><span style="color:#a2f;font-weight:700">)</span>
</span></span><span style="display:flex"><span>kubectl --kubeconfig /etc/kubernetes/konnectivity-server.conf config set-credentials system:konnectivity-server --client-certificate konnectivity.crt --client-key konnectivity.key --embed-certs<span style="color:#666">=</span><span style="color:#a2f">true</span>
</span></span><span style="display:flex"><span>kubectl --kubeconfig /etc/kubernetes/konnectivity-server.conf config set-cluster kubernetes --server <span style="color:#b44">"</span><span style="color:#b8860b">$SERVER</span><span style="color:#b44">"</span> --certificate-authority /etc/kubernetes/pki/ca.crt --embed-certs<span style="color:#666">=</span><span style="color:#a2f">true</span>
</span></span><span style="display:flex"><span>kubectl --kubeconfig /etc/kubernetes/konnectivity-server.conf config set-context system:konnectivity-server@kubernetes --cluster kubernetes --user system:konnectivity-server
</span></span><span style="display:flex"><span>kubectl --kubeconfig /etc/kubernetes/konnectivity-server.conf config use-context system:konnectivity-server@kubernetes
</span></span><span style="display:flex"><span>rm -f konnectivity.crt konnectivity.key konnectivity.csr
</span></span></code></pre></div><p>Next, you need to deploy the Konnectivity server and agents.
<a href="https://github.com/kubernetes-sigs/apiserver-network-proxy">kubernetes-sigs/apiserver-network-proxy</a>
is a reference implementation.</p><p>Deploy the Konnectivity server on your control plane node. The provided
<code>konnectivity-server.yaml</code> manifest assumes
that the Kubernetes components are deployed as a <a class="glossary-tooltip" title="A pod managed directly by the kubelet daemon on a specific node." data-toggle="tooltip" data-placement="top" href="/docs/tasks/configure-pod-container/static-pod/" target="_blank" aria-label="static Pod">static Pod</a> in your cluster. If not, you can deploy the Konnectivity
server as a DaemonSet.</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/konnectivity/konnectivity-server.yaml" download="admin/konnectivity/konnectivity-server.yaml"><code>admin/konnectivity/konnectivity-server.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;admin-konnectivity-konnectivity-server-yaml&quot;)" title="Copy admin/konnectivity/konnectivity-server.yaml to clipboard"/></div><div class="includecode" id="admin-konnectivity-konnectivity-server-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Pod<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>konnectivity-server<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>kube-system<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">priorityClassName</span>:<span style="color:#bbb"> </span>system-cluster-critical<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">hostNetwork</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>konnectivity-server-container<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>registry.k8s.io/kas-network-proxy/proxy-server:v0.0.37<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">command</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"/proxy-server"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">args</span>:<span style="color:#bbb"> </span>[<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:#b44">"--logtostderr=true"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:#080;font-style:italic"># This needs to be consistent with the value set in egressSelectorConfiguration.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:#b44">"--uds-name=/etc/kubernetes/konnectivity-server/konnectivity-server.socket"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:#b44">"--delete-existing-uds-file"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:#080;font-style:italic"># The following two lines assume the Konnectivity server is</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:#080;font-style:italic"># deployed on the same machine as the apiserver, and the certs and</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:#080;font-style:italic"># key of the API Server are at the specified location.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:#b44">"--cluster-cert=/etc/kubernetes/pki/apiserver.crt"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:#b44">"--cluster-key=/etc/kubernetes/pki/apiserver.key"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:#080;font-style:italic"># This needs to be consistent with the value set in egressSelectorConfiguration.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:#b44">"--mode=grpc"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:#b44">"--server-port=0"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:#b44">"--agent-port=8132"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:#b44">"--admin-port=8133"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:#b44">"--health-port=8134"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:#b44">"--agent-namespace=kube-system"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:#b44">"--agent-service-account=konnectivity-agent"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:#b44">"--kubeconfig=/etc/kubernetes/konnectivity-server.conf"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:#b44">"--authentication-audience=system:konnectivity-server"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">livenessProbe</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">httpGet</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">scheme</span>:<span style="color:#bbb"> </span>HTTP<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">host</span>:<span style="color:#bbb"> </span><span style="color:#666">127.0.0.1</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">port</span>:<span style="color:#bbb"> </span><span style="color:#666">8134</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">path</span>:<span style="color:#bbb"> </span>/healthz<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">initialDelaySeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">30</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">timeoutSeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">60</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>agentport<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">8132</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">hostPort</span>:<span style="color:#bbb"> </span><span style="color:#666">8132</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>adminport<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">8133</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">hostPort</span>:<span style="color:#bbb"> </span><span style="color:#666">8133</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>healthport<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">8134</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">hostPort</span>:<span style="color:#bbb"> </span><span style="color:#666">8134</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">volumeMounts</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>k8s-certs<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span>/etc/kubernetes/pki<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">readOnly</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>kubeconfig<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span>/etc/kubernetes/konnectivity-server.conf<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">readOnly</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>konnectivity-uds<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span>/etc/kubernetes/konnectivity-server<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">readOnly</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">false</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>k8s-certs<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">hostPath</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">path</span>:<span style="color:#bbb"> </span>/etc/kubernetes/pki<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>kubeconfig<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">hostPath</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">path</span>:<span style="color:#bbb"> </span>/etc/kubernetes/konnectivity-server.conf<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>FileOrCreate<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>konnectivity-uds<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">hostPath</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">path</span>:<span style="color:#bbb"> </span>/etc/kubernetes/konnectivity-server<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>DirectoryOrCreate<span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>Then deploy the Konnectivity agents in your cluster:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/konnectivity/konnectivity-agent.yaml" download="admin/konnectivity/konnectivity-agent.yaml"><code>admin/konnectivity/konnectivity-agent.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;admin-konnectivity-konnectivity-agent-yaml&quot;)" title="Copy admin/konnectivity/konnectivity-agent.yaml to clipboard"/></div><div class="includecode" id="admin-konnectivity-konnectivity-agent-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># Alternatively, you can deploy the agents as Deployments. It is not necessary</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># to have an agent on each node.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>DaemonSet<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">addonmanager.kubernetes.io/mode</span>:<span style="color:#bbb"> </span>Reconcile<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">k8s-app</span>:<span style="color:#bbb"> </span>konnectivity-agent<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>kube-system<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>konnectivity-agent<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">k8s-app</span>:<span style="color:#bbb"> </span>konnectivity-agent<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">k8s-app</span>:<span style="color:#bbb"> </span>konnectivity-agent<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">priorityClassName</span>:<span style="color:#bbb"> </span>system-cluster-critical<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">tolerations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">key</span>:<span style="color:#bbb"> </span><span style="color:#b44">"CriticalAddonsOnly"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">operator</span>:<span style="color:#bbb"> </span><span style="color:#b44">"Exists"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>us.gcr.io/k8s-artifacts-prod/kas-network-proxy/proxy-agent:v0.0.37<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>konnectivity-agent<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">command</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"/proxy-agent"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">args</span>:<span style="color:#bbb"> </span>[<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:#b44">"--logtostderr=true"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:#b44">"--ca-cert=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:#080;font-style:italic"># Since the konnectivity server runs with hostNetwork=true,</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:#080;font-style:italic"># this is the IP address of the master machine.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:#b44">"--proxy-server-host=35.225.206.7"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:#b44">"--proxy-server-port=8132"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:#b44">"--admin-server-port=8133"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:#b44">"--health-server-port=8134"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:#b44">"--service-account-token-path=/var/run/secrets/tokens/konnectivity-agent-token"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">volumeMounts</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span>- <span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span>/var/run/secrets/tokens<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>konnectivity-agent-token<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">livenessProbe</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">httpGet</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">port</span>:<span style="color:#bbb"> </span><span style="color:#666">8134</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">path</span>:<span style="color:#bbb"> </span>/healthz<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">initialDelaySeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">15</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">timeoutSeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">15</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">serviceAccountName</span>:<span style="color:#bbb"> </span>konnectivity-agent<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>konnectivity-agent-token<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">projected</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">sources</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span>- <span style="color:green;font-weight:700">serviceAccountToken</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:green;font-weight:700">path</span>:<span style="color:#bbb"> </span>konnectivity-agent-token<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:green;font-weight:700">audience</span>:<span style="color:#bbb"> </span>system:konnectivity-server<span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>Last, if RBAC is enabled in your cluster, create the relevant RBAC rules:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/konnectivity/konnectivity-rbac.yaml" download="admin/konnectivity/konnectivity-rbac.yaml"><code>admin/konnectivity/konnectivity-rbac.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;admin-konnectivity-konnectivity-rbac-yaml&quot;)" title="Copy admin/konnectivity/konnectivity-rbac.yaml to clipboard"/></div><div class="includecode" id="admin-konnectivity-konnectivity-rbac-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>rbac.authorization.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ClusterRoleBinding<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>system:konnectivity-server<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kubernetes.io/cluster-service</span>:<span style="color:#bbb"> </span><span style="color:#b44">"true"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">addonmanager.kubernetes.io/mode</span>:<span style="color:#bbb"> </span>Reconcile<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">roleRef</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">apiGroup</span>:<span style="color:#bbb"> </span>rbac.authorization.k8s.io<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ClusterRole<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>system:auth-delegator<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">subjects</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">apiGroup</span>:<span style="color:#bbb"> </span>rbac.authorization.k8s.io<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>User<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>system:konnectivity-server<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#00f;font-weight:700">---</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ServiceAccount<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>konnectivity-agent<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>kube-system<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kubernetes.io/cluster-service</span>:<span style="color:#bbb"> </span><span style="color:#b44">"true"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">addonmanager.kubernetes.io/mode</span>:<span style="color:#bbb"> </span>Reconcile<span style="color:#bbb">
</span></span></span></code></pre></div></div></div></div>
<hr>
<div class="td-content"><h1 data-pagefind-weight="10">Extend the Kubernetes API with CustomResourceDefinitions</h1><p>This page shows how to install a
<a href="/docs/concepts/extend-kubernetes/api-extension/custom-resources/">custom resource</a>
into the Kubernetes API by creating a
<a href="/docs/reference/generated/kubernetes-api/v1.34/#customresourcedefinition-v1-apiextensions-k8s-io">CustomResourceDefinition</a>.</p><h2 id="before-you-begin">Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul>Your Kubernetes server must be at or later than version 1.16.<p>To check the version, enter <code>kubectl version</code>.</p>If you are using an older version of Kubernetes that is still supported, switch to
the documentation for that version to see advice that is relevant for your cluster.</p><h2 id="create-a-customresourcedefinition">Create a CustomResourceDefinition</h2><p>When you create a new CustomResourceDefinition (CRD), the Kubernetes API Server
creates a new RESTful resource path for each version you specify. The custom
resource created from a CRD object can be either namespaced or cluster-scoped,
as specified in the CRD's <code>spec.scope</code> field. As with existing built-in
objects, deleting a namespace deletes all custom objects in that namespace.
CustomResourceDefinitions themselves are non-namespaced and are available to
all namespaces.</p><p>For example, if you save the following CustomResourceDefinition to <code>resourcedefinition.yaml</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiextensions.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CustomResourceDefinition<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># name must match the spec fields below, and be in the form: &lt;plural&gt;.&lt;group&gt;</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>crontabs.stable.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># group name to use for REST API: /apis/&lt;group&gt;/&lt;version&gt;</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">group</span>:<span style="color:#bbb"> </span>stable.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># list of versions supported by this CustomResourceDefinition</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">versions</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># Each version can be enabled/disabled by Served flag.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">served</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># One and only one version must be marked as the storage version.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">storage</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">openAPIV3Schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                </span><span style="color:green;font-weight:700">cronSpec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>integer<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># either Namespaced or Cluster</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">scope</span>:<span style="color:#bbb"> </span>Namespaced<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">names</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># plural name to be used in the URL: /apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">plural</span>:<span style="color:#bbb"> </span>crontabs<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># singular name to be used as an alias on the CLI and for display</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">singular</span>:<span style="color:#bbb"> </span>crontab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># kind is normally the CamelCased singular type. Your resource manifests use this.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CronTab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># shortNames allow shorter string to match your resource on the CLI</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">shortNames</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- ct<span style="color:#bbb">
</span></span></span></code></pre></div><p>and create it:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f resourcedefinition.yaml
</span></span></code></pre></div><p>Then a new namespaced RESTful API endpoint is created at:</p><pre tabindex="0"><code>/apis/stable.example.com/v1/namespaces/*/crontabs/...
</code></pre><p>This endpoint URL can then be used to create and manage custom objects.
The <code>kind</code> of these objects will be <code>CronTab</code> from the spec of the
CustomResourceDefinition object you created above.</p><p>It might take a few seconds for the endpoint to be created.
You can watch the <code>Established</code> condition of your CustomResourceDefinition
to be true or watch the discovery information of the API server for your
resource to show up.</p><h2 id="create-custom-objects">Create custom objects</h2><p>After the CustomResourceDefinition object has been created, you can create
custom objects. Custom objects can contain custom fields. These fields can
contain arbitrary JSON.
In the following example, the <code>cronSpec</code> and <code>image</code> custom fields are set in a
custom object of kind <code>CronTab</code>. The kind <code>CronTab</code> comes from the spec of the
CustomResourceDefinition object you created above.</p><p>If you save the following YAML to <code>my-crontab.yaml</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span><span style="color:#b44">"stable.example.com/v1"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CronTab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-new-cron-object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">cronSpec</span>:<span style="color:#bbb"> </span><span style="color:#b44">"* * * * */5"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>my-awesome-cron-image<span style="color:#bbb">
</span></span></span></code></pre></div><p>and create it:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f my-crontab.yaml
</span></span></code></pre></div><p>You can then manage your CronTab objects using kubectl. For example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get crontab
</span></span></code></pre></div><p>Should print a list like this:</p><pre tabindex="0"><code class="language-none" data-lang="none">NAME                 AGE
my-new-cron-object   6s
</code></pre><p>Resource names are not case-sensitive when using kubectl, and you can use either
the singular or plural forms defined in the CRD, as well as any short names.</p><p>You can also view the raw YAML data:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get ct -o yaml
</span></span></code></pre></div><p>You should see that it contains the custom <code>cronSpec</code> and <code>image</code> fields
from the YAML you used to create it:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">items</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>stable.example.com/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CronTab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">annotations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">kubectl.kubernetes.io/last-applied-configuration</span>:<span style="color:#bbb"> </span>|<span style="color:#b44;font-style:italic">
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">        {"apiVersion":"stable.example.com/v1","kind":"CronTab","metadata":{"annotations":{},"name":"my-new-cron-object","namespace":"default"},"spec":{"cronSpec":"* * * * */5","image":"my-awesome-cron-image"}}</span><span style="color:#bbb">        
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">creationTimestamp</span>:<span style="color:#bbb"> </span><span style="color:#b44">"2021-06-20T07:35:27Z"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">generation</span>:<span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-new-cron-object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">resourceVersion</span>:<span style="color:#bbb"> </span><span style="color:#b44">"1326"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">uid</span>:<span style="color:#bbb"> </span>9aab1d66-628e-41bb-a422-57b8b3b1f5a9<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">cronSpec</span>:<span style="color:#bbb"> </span><span style="color:#b44">'* * * * */5'</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>my-awesome-cron-image<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>List<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">resourceVersion</span>:<span style="color:#bbb"> </span><span style="color:#b44">""</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selfLink</span>:<span style="color:#bbb"> </span><span style="color:#b44">""</span><span style="color:#bbb">
</span></span></span></code></pre></div><h2 id="delete-a-customresourcedefinition">Delete a CustomResourceDefinition</h2><p>When you delete a CustomResourceDefinition, the server will uninstall the RESTful API endpoint
and delete all custom objects stored in it.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl delete -f resourcedefinition.yaml
</span></span><span style="display:flex"><span>kubectl get crontabs
</span></span></code></pre></div><pre tabindex="0"><code class="language-none" data-lang="none">Error from server (NotFound): Unable to list {"stable.example.com" "v1" "crontabs"}: the server could not
find the requested resource (get crontabs.stable.example.com)
</code></pre><p>If you later recreate the same CustomResourceDefinition, it will start out empty.</p><h2 id="specifying-a-structural-schema">Specifying a structural schema</h2><p>CustomResources store structured data in custom fields (alongside the built-in
fields <code>apiVersion</code>, <code>kind</code> and <code>metadata</code>, which the API server validates
implicitly). With <a href="#validation">OpenAPI v3.0 validation</a> a schema can be
specified, which is validated during creation and updates, compare below for
details and limits of such a schema.</p><p>With <code>apiextensions.k8s.io/v1</code> the definition of a structural schema is
mandatory for CustomResourceDefinitions. In the beta version of
CustomResourceDefinition, the structural schema was optional.</p><p>A structural schema is an <a href="#validation">OpenAPI v3.0 validation schema</a> which:</p><ol><li>specifies a non-empty type (via <code>type</code> in OpenAPI) for the root, for each specified field of an object node
(via <code>properties</code> or <code>additionalProperties</code> in OpenAPI) and for each item in an array node
(via <code>items</code> in OpenAPI), with the exception of:<ul><li>a node with <code>x-kubernetes-int-or-string: true</code></li><li>a node with <code>x-kubernetes-preserve-unknown-fields: true</code></li></ul></li><li>for each field in an object and each item in an array which is specified within any of <code>allOf</code>, <code>anyOf</code>,
<code>oneOf</code> or <code>not</code>, the schema also specifies the field/item outside of those logical junctors (compare example 1 and 2).</li><li>does not set <code>description</code>, <code>type</code>, <code>default</code>, <code>additionalProperties</code>, <code>nullable</code> within an <code>allOf</code>, <code>anyOf</code>,
<code>oneOf</code> or <code>not</code>, with the exception of the two pattern for <code>x-kubernetes-int-or-string: true</code> (see below).</li><li>if <code>metadata</code> is specified, then only restrictions on <code>metadata.name</code> and <code>metadata.generateName</code> are allowed.</li></ol><p>Non-structural example 1:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">allOf</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">foo</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>conflicts with rule 2. The following would be correct:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">foo</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">allOf</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">foo</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>Non-structural example 2:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">allOf</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">items</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">foo</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>conflicts with rule 2. The following would be correct:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">items</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">foo</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">allOf</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">items</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">foo</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>Non-structural example 3:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">foo</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">pattern</span>:<span style="color:#bbb"> </span><span style="color:#b44">"abc"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">pattern</span>:<span style="color:#bbb"> </span><span style="color:#b44">"^a"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">finalizers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>array<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">items</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">pattern</span>:<span style="color:#bbb"> </span><span style="color:#b44">"my-finalizer"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">anyOf</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">bar</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>integer<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">minimum</span>:<span style="color:#bbb"> </span><span style="color:#666">42</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">required</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"bar"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">description</span>:<span style="color:#bbb"> </span><span style="color:#b44">"foo bar object"</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>is not a structural schema because of the following violations:</p><ul><li>the type at the root is missing (rule 1).</li><li>the type of <code>foo</code> is missing (rule 1).</li><li><code>bar</code> inside of <code>anyOf</code> is not specified outside (rule 2).</li><li><code>bar</code>'s <code>type</code> is within <code>anyOf</code> (rule 3).</li><li>the description is set within <code>anyOf</code> (rule 3).</li><li><code>metadata.finalizers</code> might not be restricted (rule 4).</li></ul><p>In contrast, the following, corresponding schema is structural:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">description</span>:<span style="color:#bbb"> </span><span style="color:#b44">"foo bar object"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">foo</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">pattern</span>:<span style="color:#bbb"> </span><span style="color:#b44">"abc"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">bar</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>integer<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">pattern</span>:<span style="color:#bbb"> </span><span style="color:#b44">"^a"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">anyOf</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">bar</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">minimum</span>:<span style="color:#bbb"> </span><span style="color:#666">42</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">required</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"bar"</span>]<span style="color:#bbb">
</span></span></span></code></pre></div><p>Violations of the structural schema rules are reported in the <code>NonStructural</code> condition in the
CustomResourceDefinition.</p><h3 id="field-pruning">Field pruning</h3><p>CustomResourceDefinitions store validated resource data in the cluster's persistence store, <a class="glossary-tooltip" title="Consistent and highly-available key value store used as backing store of Kubernetes for all cluster data." data-toggle="tooltip" data-placement="top" href="/docs/tasks/administer-cluster/configure-upgrade-etcd/" target="_blank" aria-label="etcd">etcd</a>.
As with native Kubernetes resources such as <a class="glossary-tooltip" title="An API object used to store non-confidential data in key-value pairs. Can be consumed as environment variables, command-line arguments, or configuration files in a volume." data-toggle="tooltip" data-placement="top" href="/docs/concepts/configuration/configmap/" target="_blank" aria-label="ConfigMap">ConfigMap</a>,
if you specify a field that the API server does not recognize, the unknown field is <em>pruned</em> (removed) before being persisted.</p><p>CRDs converted from <code>apiextensions.k8s.io/v1beta1</code> to <code>apiextensions.k8s.io/v1</code> might lack
structural schemas, and <code>spec.preserveUnknownFields</code> might be <code>true</code>.</p><p>For legacy CustomResourceDefinition objects created as
<code>apiextensions.k8s.io/v1beta1</code> with <code>spec.preserveUnknownFields</code> set to
<code>true</code>, the following is also true:</p><ul><li>Pruning is not enabled.</li><li>You can store arbitrary data.</li></ul><p>For compatibility with <code>apiextensions.k8s.io/v1</code>, update your custom
resource definitions to:</p><ol><li>Use a structural OpenAPI schema.</li><li>Set <code>spec.preserveUnknownFields</code> to <code>false</code>.</li></ol><p>If you save the following YAML to <code>my-crontab.yaml</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span><span style="color:#b44">"stable.example.com/v1"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CronTab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-new-cron-object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">cronSpec</span>:<span style="color:#bbb"> </span><span style="color:#b44">"* * * * */5"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>my-awesome-cron-image<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">someRandomField</span>:<span style="color:#bbb"> </span><span style="color:#666">42</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>and create it:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl create --validate<span style="color:#666">=</span><span style="color:#a2f">false</span> -f my-crontab.yaml -o yaml
</span></span></code></pre></div><p>Your output is similar to:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>stable.example.com/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CronTab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">creationTimestamp</span>:<span style="color:#bbb"> </span>2017-05-31T12:56:35Z<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">generation</span>:<span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-new-cron-object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">resourceVersion</span>:<span style="color:#bbb"> </span><span style="color:#b44">"285"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">uid</span>:<span style="color:#bbb"> </span>9423255b-4600-11e7-af6a-28d2447dc82b<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">cronSpec</span>:<span style="color:#bbb"> </span><span style="color:#b44">'* * * * */5'</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>my-awesome-cron-image<span style="color:#bbb">
</span></span></span></code></pre></div><p>Notice that the field <code>someRandomField</code> was pruned.</p><p>This example turned off client-side validation to demonstrate the API server's behavior, by adding
the <code>--validate=false</code> command line option.
Because the <a href="#publish-validation-schema-in-openapi">OpenAPI validation schemas are also published</a>
to clients, <code>kubectl</code> also checks for unknown fields and rejects those objects well before they
would be sent to the API server.</p><h4 id="controlling-pruning">Controlling pruning</h4><p>By default, all unspecified fields for a custom resource, across all versions, are pruned. It is possible though to
opt-out of that for specific sub-trees of fields by adding <code>x-kubernetes-preserve-unknown-fields: true</code> in the
<a href="#specifying-a-structural-schema">structural OpenAPI v3 validation schema</a>.</p><p>For example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">json</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">x-kubernetes-preserve-unknown-fields</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>The field <code>json</code> can store any JSON value, without anything being pruned.</p><p>You can also partially specify the permitted JSON; for example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">json</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">x-kubernetes-preserve-unknown-fields</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">description</span>:<span style="color:#bbb"> </span>this is arbitrary JSON<span style="color:#bbb">
</span></span></span></code></pre></div><p>With this, only <code>object</code> type values are allowed.</p><p>Pruning is enabled again for each specified property (or <code>additionalProperties</code>):</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">json</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">x-kubernetes-preserve-unknown-fields</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">foo</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">bar</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span></code></pre></div><p>With this, the value:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">json</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">foo</span>:<span style="color:#bbb"> </span>abc<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">bar</span>:<span style="color:#bbb"> </span>def<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">something</span>:<span style="color:#bbb"> </span>x<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">status</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">something</span>:<span style="color:#bbb"> </span>x<span style="color:#bbb">
</span></span></span></code></pre></div><p>is pruned to:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">json</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">foo</span>:<span style="color:#bbb"> </span>abc<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">bar</span>:<span style="color:#bbb"> </span>def<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">status</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">something</span>:<span style="color:#bbb"> </span>x<span style="color:#bbb">
</span></span></span></code></pre></div><p>This means that the <code>something</code> field in the specified <code>spec</code> object is pruned, but everything outside is not.</p><h3 id="intorstring">IntOrString</h3><p>Nodes in a schema with <code>x-kubernetes-int-or-string: true</code> are excluded from rule 1, such that the
following is structural:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">foo</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">x-kubernetes-int-or-string</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>Also those nodes are partially excluded from rule 3 in the sense that the following two patterns are allowed
(exactly those, without variations in order to additional fields):</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">x-kubernetes-int-or-string</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">anyOf</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>integer<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#00f;font-weight:700">...</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>and</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">x-kubernetes-int-or-string</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">allOf</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">anyOf</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>integer<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:#080;font-style:italic"># ... zero or more</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#00f;font-weight:700">...</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>With one of those specification, both an integer and a string validate.</p><p>In <a href="#publish-validation-schema-in-openapi">Validation Schema Publishing</a>,
<code>x-kubernetes-int-or-string: true</code> is unfolded to one of the two patterns shown above.</p><h3 id="rawextension">RawExtension</h3><p>RawExtensions (as in <a href="/docs/reference//kubernetes-api/workload-resources/controller-revision-v1#RawExtension"><code>runtime.RawExtension</code></a>)
holds complete Kubernetes objects, i.e. with <code>apiVersion</code> and <code>kind</code> fields.</p><p>It is possible to specify those embedded objects (both completely without constraints or partially specified)
by setting <code>x-kubernetes-embedded-resource: true</code>. For example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">foo</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">x-kubernetes-embedded-resource</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">x-kubernetes-preserve-unknown-fields</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>Here, the field <code>foo</code> holds a complete object, e.g.:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">foo</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Pod<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>Because <code>x-kubernetes-preserve-unknown-fields: true</code> is specified alongside, nothing is pruned.
The use of <code>x-kubernetes-preserve-unknown-fields: true</code> is optional though.</p><p>With <code>x-kubernetes-embedded-resource: true</code>, the <code>apiVersion</code>, <code>kind</code> and <code>metadata</code> are implicitly specified and validated.</p><h2 id="serving-multiple-versions-of-a-crd">Serving multiple versions of a CRD</h2><p>See <a href="/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definition-versioning/">Custom resource definition versioning</a>
for more information about serving multiple versions of your
CustomResourceDefinition and migrating your objects from one version to another.</p><h2 id="advanced-topics">Advanced topics</h2><h3 id="finalizers">Finalizers</h3><p><em>Finalizers</em> allow controllers to implement asynchronous pre-delete hooks.
Custom objects support finalizers similar to built-in objects.</p><p>You can add a finalizer to a custom object like this:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span><span style="color:#b44">"stable.example.com/v1"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CronTab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">finalizers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- stable.example.com/finalizer<span style="color:#bbb">
</span></span></span></code></pre></div><p>Identifiers of custom finalizers consist of a domain name, a forward slash and the name of
the finalizer. Any controller can add a finalizer to any object's list of finalizers.</p><p>The first delete request on an object with finalizers sets a value for the
<code>metadata.deletionTimestamp</code> field but does not delete it. Once this value is set,
entries in the <code>finalizers</code> list can only be removed. While any finalizers remain it is also
impossible to force the deletion of an object.</p><p>When the <code>metadata.deletionTimestamp</code> field is set, controllers watching the object execute any
finalizers they handle and remove the finalizer from the list after they are done. It is the
responsibility of each controller to remove its finalizer from the list.</p><p>The value of <code>metadata.deletionGracePeriodSeconds</code> controls the interval between polling updates.</p><p>Once the list of finalizers is empty, meaning all finalizers have been executed, the resource is
deleted by Kubernetes.</p><h3 id="validation">Validation</h3><p>Custom resources are validated via
<a href="https://github.com/OAI/OpenAPI-Specification/blob/3.0.0/versions/3.0.0.md#schema-object">OpenAPI v3.0 schemas</a>,
by x-kubernetes-validations when the <a href="#validation-rules">Validation Rules feature</a> is enabled, and you
can add additional validation using
<a href="/docs/reference/access-authn-authz/admission-controllers/#validatingadmissionwebhook">admission webhooks</a>.</p><p>Additionally, the following restrictions are applied to the schema:</p><ul><li><p>These fields cannot be set:</p><ul><li><code>definitions</code>,</li><li><code>dependencies</code>,</li><li><code>deprecated</code>,</li><li><code>discriminator</code>,</li><li><code>id</code>,</li><li><code>patternProperties</code>,</li><li><code>readOnly</code>,</li><li><code>writeOnly</code>,</li><li><code>xml</code>,</li><li><code>$ref</code>.</li></ul></li><li><p>The field <code>uniqueItems</code> cannot be set to <code>true</code>.</p></li><li><p>The field <code>additionalProperties</code> cannot be set to <code>false</code>.</p></li><li><p>The field <code>additionalProperties</code> is mutually exclusive with <code>properties</code>.</p></li></ul><p>The <code>x-kubernetes-validations</code> extension can be used to validate custom resources using
<a href="https://github.com/google/cel-spec">Common Expression Language (CEL)</a> expressions when the
<a href="#validation-rules">Validation rules</a> feature is enabled and the CustomResourceDefinition schema is a
<a href="#specifying-a-structural-schema">structural schema</a>.</p><p>Refer to the <a href="#specifying-a-structural-schema">structural schemas</a> section for other
restrictions and CustomResourceDefinition features.</p><p>The schema is defined in the CustomResourceDefinition. In the following example, the
CustomResourceDefinition applies the following validations on the custom object:</p><ul><li><code>spec.cronSpec</code> must be a string and must be of the form described by the regular expression.</li><li><code>spec.replicas</code> must be an integer and must have a minimum value of 1 and a maximum value of 10.</li></ul><p>Save the CustomResourceDefinition to <code>resourcedefinition.yaml</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiextensions.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CustomResourceDefinition<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>crontabs.stable.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">group</span>:<span style="color:#bbb"> </span>stable.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">versions</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">served</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">storage</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic"># openAPIV3Schema is the schema for validating custom objects.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">openAPIV3Schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                </span><span style="color:green;font-weight:700">cronSpec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:green;font-weight:700">pattern</span>:<span style="color:#bbb"> </span><span style="color:#b44">'^(\d+|\*)(/\d+)?(\s+(\d+|\*)(/\d+)?){4}$'</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>integer<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:green;font-weight:700">minimum</span>:<span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:green;font-weight:700">maximum</span>:<span style="color:#bbb"> </span><span style="color:#666">10</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">scope</span>:<span style="color:#bbb"> </span>Namespaced<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">names</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">plural</span>:<span style="color:#bbb"> </span>crontabs<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">singular</span>:<span style="color:#bbb"> </span>crontab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CronTab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">shortNames</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- ct<span style="color:#bbb">
</span></span></span></code></pre></div><p>and create it:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f resourcedefinition.yaml
</span></span></code></pre></div><p>A request to create a custom object of kind CronTab is rejected if there are invalid values in its fields.
In the following example, the custom object contains fields with invalid values:</p><ul><li><code>spec.cronSpec</code> does not match the regular expression.</li><li><code>spec.replicas</code> is greater than 10.</li></ul><p>If you save the following YAML to <code>my-crontab.yaml</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span><span style="color:#b44">"stable.example.com/v1"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CronTab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-new-cron-object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">cronSpec</span>:<span style="color:#bbb"> </span><span style="color:#b44">"* * * *"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>my-awesome-cron-image<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">15</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>and attempt to create it:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f my-crontab.yaml
</span></span></code></pre></div><p>then you get an error:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console"><span style="display:flex"><span><span style="color:#888">The CronTab "my-new-cron-object" is invalid: []: Invalid value: map[string]interface {}{"apiVersion":"stable.example.com/v1", "kind":"CronTab", "metadata":map[string]interface {}{"name":"my-new-cron-object", "namespace":"default", "deletionTimestamp":interface {}(nil), "deletionGracePeriodSeconds":(*int64)(nil), "creationTimestamp":"2017-09-05T05:20:07Z", "uid":"e14d79e7-91f9-11e7-a598-f0761cb232d1", "clusterName":""}, "spec":map[string]interface {}{"cronSpec":"* * * *", "image":"my-awesome-cron-image", "replicas":15}}:
</span></span></span><span style="display:flex"><span><span style="color:#888">validation failure list:
</span></span></span><span style="display:flex"><span><span style="color:#888">spec.cronSpec in body should match '^(\d+|\*)(/\d+)?(\s+(\d+|\*)(/\d+)?){4}$'
</span></span></span><span style="display:flex"><span><span style="color:#888">spec.replicas in body should be less than or equal to 10
</span></span></span></code></pre></div><p>If the fields contain valid values, the object creation request is accepted.</p><p>Save the following YAML to <code>my-crontab.yaml</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span><span style="color:#b44">"stable.example.com/v1"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CronTab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-new-cron-object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">cronSpec</span>:<span style="color:#bbb"> </span><span style="color:#b44">"* * * * */5"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>my-awesome-cron-image<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">5</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>And create it:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f my-crontab.yaml
</span></span><span style="display:flex"><span>crontab <span style="color:#b44">"my-new-cron-object"</span> created
</span></span></code></pre></div><h3 id="validation-ratcheting">Validation ratcheting</h3><div class="feature-state-notice feature-stable" title="Feature Gate: CRDValidationRatcheting"><span class="feature-state-name">FEATURE STATE:</span>
<code>Kubernetes v1.33 [stable]</code> (enabled by default: true)</div><p>If you are using a version of Kubernetes older than v1.30, you need to explicitly
enable the <code>CRDValidationRatcheting</code>
<a href="/docs/reference/command-line-tools-reference/feature-gates/">feature gate</a> to
use this behavior, which then applies to all CustomResourceDefinitions in your
cluster.</p><p>Provided you enabled the feature gate, Kubernetes implements <em>validation ratcheting</em>
for CustomResourceDefinitions. The API server is willing to accept updates to resources that
are not valid after the update, provided that each part of the resource that failed to validate
was not changed by the update operation. In other words, any invalid part of the resource
that remains invalid must have already been wrong.
You cannot use this mechanism to update a valid resource so that it becomes invalid.</p><p>This feature allows authors of CRDs to confidently add new validations to the
OpenAPIV3 schema under certain conditions. Users can update to the new schema
safely without bumping the version of the object or breaking workflows.</p><p>While most validations placed in the OpenAPIV3 schema of a CRD support
ratcheting, there are a few exceptions. The following OpenAPIV3 schema
validations are not supported by ratcheting under the implementation in Kubernetes
1.34 and if violated will continue to throw an error as normally:</p><ul><li><p>Quantors</p><ul><li><code>allOf</code></li><li><code>oneOf</code></li><li><code>anyOf</code></li><li><code>not</code></li><li>any validations in a descendent of one of these fields</li></ul></li><li><p><code>x-kubernetes-validations</code>
For Kubernetes 1.28, CRD <a href="#validation-rules">validation rules</a> are ignored by
ratcheting. Starting with Alpha 2 in Kubernetes 1.29, <code>x-kubernetes-validations</code>
are ratcheted only if they do not refer to <code>oldSelf</code>.</p><p>Transition Rules are never ratcheted: only errors raised by rules that do not
use <code>oldSelf</code> will be automatically ratcheted if their values are unchanged.</p><p>To write custom ratcheting logic for CEL expressions, check out <a href="#field-optional-oldself">optionalOldSelf</a>.</p></li><li><p><code>x-kubernetes-list-type</code>
Errors arising from changing the list type of a subschema will not be
ratcheted. For example adding <code>set</code> onto a list with duplicates will always
result in an error.</p></li><li><p><code>x-kubernetes-list-map-keys</code>
Errors arising from changing the map keys of a list schema will not be
ratcheted.</p></li><li><p><code>required</code>
Errors arising from changing the list of required fields will not be ratcheted.</p></li><li><p><code>properties</code>
Adding/removing/modifying the names of properties is not ratcheted, but
changes to validations in each properties' schemas and subschemas may be ratcheted
if the name of the property stays the same.</p></li><li><p><code>additionalProperties</code>
To remove a previously specified <code>additionalProperties</code> validation will not be
ratcheted.</p></li><li><p><code>metadata</code>
Errors that come from Kubernetes' built-in validation of an object's <code>metadata</code>
are not ratcheted (such as object name, or characters in a label value).
If you specify your own additional rules for the metadata of a custom resource,
that additional validation will be ratcheted.</p></li></ul><h3 id="validation-rules">Validation rules</h3><div class="feature-state-notice feature-stable"><span class="feature-state-name">FEATURE STATE:</span>
<code>Kubernetes v1.29 [stable]</code></div><p>Validation rules use the <a href="https://github.com/google/cel-spec">Common Expression Language (CEL)</a>
to validate custom resource values. Validation rules are included in
CustomResourceDefinition schemas using the <code>x-kubernetes-validations</code> extension.</p><p>The Rule is scoped to the location of the <code>x-kubernetes-validations</code> extension in the schema.
And <code>self</code> variable in the CEL expression is bound to the scoped value.</p><p>All validation rules are scoped to the current object: no cross-object or stateful validation
rules are supported.</p><p>For example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">openAPIV3Schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">x-kubernetes-validations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span>- <span style="color:green;font-weight:700">rule</span>:<span style="color:#bbb"> </span><span style="color:#b44">"self.minReplicas &lt;= self.replicas"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">message</span>:<span style="color:#bbb"> </span><span style="color:#b44">"replicas should be greater than or equal to minReplicas."</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span>- <span style="color:green;font-weight:700">rule</span>:<span style="color:#bbb"> </span><span style="color:#b44">"self.replicas &lt;= self.maxReplicas"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">message</span>:<span style="color:#bbb"> </span><span style="color:#b44">"replicas should be smaller than or equal to maxReplicas."</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">minReplicas</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>integer<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>integer<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">maxReplicas</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>integer<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">required</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span>- minReplicas<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span>- replicas<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span>- maxReplicas<span style="color:#bbb">
</span></span></span></code></pre></div><p>will reject a request to create this custom resource:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span><span style="color:#b44">"stable.example.com/v1"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CronTab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-new-cron-object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">minReplicas</span>:<span style="color:#bbb"> </span><span style="color:#666">0</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">20</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">maxReplicas</span>:<span style="color:#bbb"> </span><span style="color:#666">10</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>with the response:</p><pre tabindex="0"><code>The CronTab "my-new-cron-object" is invalid:
* spec: Invalid value: map[string]interface {}{"maxReplicas":10, "minReplicas":0, "replicas":20}: replicas should be smaller than or equal to maxReplicas.
</code></pre><p><code>x-kubernetes-validations</code> could have multiple rules.
The <code>rule</code> under <code>x-kubernetes-validations</code> represents the expression which will be evaluated by CEL.
The <code>message</code> represents the message displayed when validation fails. If message is unset, the
above response would be:</p><pre tabindex="0"><code>The CronTab "my-new-cron-object" is invalid:
* spec: Invalid value: map[string]interface {}{"maxReplicas":10, "minReplicas":0, "replicas":20}: failed rule: self.replicas &lt;= self.maxReplicas
</code></pre><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>You can quickly test CEL expressions in <a href="https://playcel.undistro.io">CEL Playground</a>.</div><p>Validation rules are compiled when CRDs are created/updated.
The request of CRDs create/update will fail if compilation of validation rules fail.
Compilation process includes type checking as well.</p><p>The compilation failure:</p><ul><li><p><code>no_matching_overload</code>: this function has no overload for the types of the arguments.</p><p>For example, a rule like <code>self == true</code> against a field of integer type will get error:</p><pre tabindex="0"><code class="language-none" data-lang="none">Invalid value: apiextensions.ValidationRule{Rule:"self == true", Message:""}: compilation failed: ERROR: \&lt;input&gt;:1:6: found no matching overload for '_==_' applied to '(int, bool)'
</code></pre></li><li><p><code>no_such_field</code>: does not contain the desired field.</p><p>For example, a rule like <code>self.nonExistingField &gt; 0</code> against a non-existing field will return
the following error:</p><pre tabindex="0"><code class="language-none" data-lang="none">Invalid value: apiextensions.ValidationRule{Rule:"self.nonExistingField &gt; 0", Message:""}: compilation failed: ERROR: \&lt;input&gt;:1:5: undefined field 'nonExistingField'
</code></pre></li><li><p><code>invalid argument</code>: invalid argument to macros.</p><p>For example, a rule like <code>has(self)</code> will return error:</p><pre tabindex="0"><code class="language-none" data-lang="none">Invalid value: apiextensions.ValidationRule{Rule:"has(self)", Message:""}: compilation failed: ERROR: &lt;input&gt;:1:4: invalid argument to has() macro
</code></pre></li></ul><p>Validation Rules Examples:</p><table><thead><tr><th>Rule</th><th>Purpose</th></tr></thead><tbody><tr><td><code>self.minReplicas &lt;= self.replicas &amp;&amp; self.replicas &lt;= self.maxReplicas</code></td><td>Validate that the three fields defining replicas are ordered appropriately</td></tr><tr><td><code>'Available' in self.stateCounts</code></td><td>Validate that an entry with the 'Available' key exists in a map</td></tr><tr><td><code>(size(self.list1) == 0) != (size(self.list2) == 0)</code></td><td>Validate that one of two lists is non-empty, but not both</td></tr><tr><td><code>!('MY_KEY' in self.map1) || self['MY_KEY'].matches('^[a-zA-Z]*$')</code></td><td>Validate the value of a map for a specific key, if it is in the map</td></tr><tr><td><code>self.envars.filter(e, e.name == 'MY_ENV').all(e, e.value.matches('^[a-zA-Z]*$')</code></td><td>Validate the 'value' field of a listMap entry where key field 'name' is 'MY_ENV'</td></tr><tr><td><code>has(self.expired) &amp;&amp; self.created + self.ttl &lt; self.expired</code></td><td>Validate that 'expired' date is after a 'create' date plus a 'ttl' duration</td></tr><tr><td><code>self.health.startsWith('ok')</code></td><td>Validate a 'health' string field has the prefix 'ok'</td></tr><tr><td><code>self.widgets.exists(w, w.key == 'x' &amp;&amp; w.foo &lt; 10)</code></td><td>Validate that the 'foo' property of a listMap item with a key 'x' is less than 10</td></tr><tr><td><code>type(self) == string ? self == '100%' : self == 1000</code></td><td>Validate an int-or-string field for both the int and string cases</td></tr><tr><td><code>self.metadata.name.startsWith(self.prefix)</code></td><td>Validate that an object's name has the prefix of another field value</td></tr><tr><td><code>self.set1.all(e, !(e in self.set2))</code></td><td>Validate that two listSets are disjoint</td></tr><tr><td><code>size(self.names) == size(self.details) &amp;&amp; self.names.all(n, n in self.details)</code></td><td>Validate the 'details' map is keyed by the items in the 'names' listSet</td></tr><tr><td><code>size(self.clusters.filter(c, c.name == self.primary)) == 1</code></td><td>Validate that the 'primary' property has one and only one occurrence in the 'clusters' listMap</td></tr></tbody></table><p>Xref: <a href="https://github.com/google/cel-spec/blob/v0.6.0/doc/langdef.md#evaluation">Supported evaluation on CEL</a></p><ul><li><p>If the Rule is scoped to the root of a resource, it may make field selection into any fields
declared in the OpenAPIv3 schema of the CRD as well as <code>apiVersion</code>, <code>kind</code>, <code>metadata.name</code> and
<code>metadata.generateName</code>. This includes selection of fields in both the <code>spec</code> and <code>status</code> in the
same expression:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">openAPIV3Schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">x-kubernetes-validations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">rule</span>:<span style="color:#bbb"> </span><span style="color:#b44">"self.status.availableReplicas &gt;= self.spec.minReplicas"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">minReplicas</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>integer<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">status</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">availableReplicas</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>integer<span style="color:#bbb">
</span></span></span></code></pre></div></li><li><p>If the Rule is scoped to an object with properties, the accessible properties of the object are field selectable
via <code>self.field</code> and field presence can be checked via <code>has(self.field)</code>. Null valued fields are treated as
absent fields in CEL expressions.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">openAPIV3Schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">x-kubernetes-validations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span>- <span style="color:green;font-weight:700">rule</span>:<span style="color:#bbb"> </span><span style="color:#b44">"has(self.foo)"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">foo</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>integer<span style="color:#bbb">
</span></span></span></code></pre></div></li><li><p>If the Rule is scoped to an object with additionalProperties (i.e. a map) the value of the map
are accessible via <code>self[mapKey]</code>, map containment can be checked via <code>mapKey in self</code> and all
entries of the map are accessible via CEL macros and functions such as <code>self.all(...)</code>.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">openAPIV3Schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">x-kubernetes-validations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span>- <span style="color:green;font-weight:700">rule</span>:<span style="color:#bbb"> </span><span style="color:#b44">"self['xyz'].foo &gt; 0"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">additionalProperties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">foo</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>integer<span style="color:#bbb">
</span></span></span></code></pre></div></li><li><p>If the Rule is scoped to an array, the elements of the array are accessible via <code>self[i]</code> and
also by macros and functions.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">openAPIV3Schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">foo</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>array<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">x-kubernetes-validations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span>- <span style="color:green;font-weight:700">rule</span>:<span style="color:#bbb"> </span><span style="color:#b44">"size(self) == 1"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">items</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span></code></pre></div></li><li><p>If the Rule is scoped to a scalar, <code>self</code> is bound to the scalar value.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">openAPIV3Schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">foo</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>integer<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">x-kubernetes-validations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span>- <span style="color:green;font-weight:700">rule</span>:<span style="color:#bbb"> </span><span style="color:#b44">"self &gt; 0"</span><span style="color:#bbb">
</span></span></span></code></pre></div></li></ul><p>Examples:</p><table><thead><tr><th>type of the field rule scoped to</th><th>Rule example</th></tr></thead><tbody><tr><td>root object</td><td><code>self.status.actual &lt;= self.spec.maxDesired</code></td></tr><tr><td>map of objects</td><td><code>self.components['Widget'].priority &lt; 10</code></td></tr><tr><td>list of integers</td><td><code>self.values.all(value, value &gt;= 0 &amp;&amp; value &lt; 100)</code></td></tr><tr><td>string</td><td><code>self.startsWith('kube')</code></td></tr></tbody></table><p>The <code>apiVersion</code>, <code>kind</code>, <code>metadata.name</code> and <code>metadata.generateName</code> are always accessible from
the root of the object and from any <code>x-kubernetes-embedded-resource</code> annotated objects. No other
metadata properties are accessible.</p><p>Unknown data preserved in custom resources via <code>x-kubernetes-preserve-unknown-fields</code> is not
accessible in CEL expressions. This includes:</p><ul><li><p>Unknown field values that are preserved by object schemas with <code>x-kubernetes-preserve-unknown-fields</code>.</p></li><li><p>Object properties where the property schema is of an "unknown type". An "unknown type" is
recursively defined as:</p><ul><li>A schema with no type and x-kubernetes-preserve-unknown-fields set to true</li><li>An array where the items schema is of an "unknown type"</li><li>An object where the additionalProperties schema is of an "unknown type"</li></ul></li></ul><p>Only property names of the form <code>[a-zA-Z_.-/][a-zA-Z0-9_.-/]*</code> are accessible.
Accessible property names are escaped according to the following rules when accessed in the expression:</p><table><thead><tr><th>escape sequence</th><th>property name equivalent</th></tr></thead><tbody><tr><td><code>__underscores__</code></td><td><code>__</code></td></tr><tr><td><code>__dot__</code></td><td><code>.</code></td></tr><tr><td><code>__dash__</code></td><td><code>-</code></td></tr><tr><td><code>__slash__</code></td><td><code>/</code></td></tr><tr><td><code>__{keyword}__</code></td><td><a href="https://github.com/google/cel-spec/blob/v0.6.0/doc/langdef.md#syntax">CEL RESERVED keyword</a></td></tr></tbody></table><p>Note: CEL RESERVED keyword needs to match the exact property name to be escaped (e.g. int in the word sprint would not be escaped).</p><p>Examples on escaping:</p><table><thead><tr><th>property name</th><th>rule with escaped property name</th></tr></thead><tbody><tr><td>namespace</td><td><code>self.__namespace__ &gt; 0</code></td></tr><tr><td>x-prop</td><td><code>self.x__dash__prop &gt; 0</code></td></tr><tr><td>redact__d</td><td><code>self.redact__underscores__d &gt; 0</code></td></tr><tr><td>string</td><td><code>self.startsWith('kube')</code></td></tr></tbody></table><p>Equality on arrays with <code>x-kubernetes-list-type</code> of <code>set</code> or <code>map</code> ignores element order,
i.e., <code>[1, 2] == [2, 1]</code>. Concatenation on arrays with x-kubernetes-list-type use the semantics of
the list type:</p><ul><li><p><code>set</code>: <code>X + Y</code> performs a union where the array positions of all elements in <code>X</code> are preserved
and non-intersecting elements in <code>Y</code> are appended, retaining their partial order.</p></li><li><p><code>map</code>: <code>X + Y</code> performs a merge where the array positions of all keys in <code>X</code> are preserved but
the values are overwritten by values in <code>Y</code> when the key sets of <code>X</code> and <code>Y</code> intersect. Elements
in <code>Y</code> with non-intersecting keys are appended, retaining their partial order.</p></li></ul><p>Here is the declarations type mapping between OpenAPIv3 and CEL type:</p><table><thead><tr><th>OpenAPIv3 type</th><th>CEL type</th></tr></thead><tbody><tr><td>'object' with Properties</td><td>object / "message type"</td></tr><tr><td>'object' with AdditionalProperties</td><td>map</td></tr><tr><td>'object' with x-kubernetes-embedded-type</td><td>object / "message type", 'apiVersion', 'kind', 'metadata.name' and 'metadata.generateName' are implicitly included in schema</td></tr><tr><td>'object' with x-kubernetes-preserve-unknown-fields</td><td>object / "message type", unknown fields are NOT accessible in CEL expression</td></tr><tr><td>x-kubernetes-int-or-string</td><td>dynamic object that is either an int or a string, <code>type(value)</code> can be used to check the type</td></tr><tr><td>'array</td><td>list</td></tr><tr><td>'array' with x-kubernetes-list-type=map</td><td>list with map based Equality &amp; unique key guarantees</td></tr><tr><td>'array' with x-kubernetes-list-type=set</td><td>list with set based Equality &amp; unique entry guarantees</td></tr><tr><td>'boolean'</td><td>boolean</td></tr><tr><td>'number' (all formats)</td><td>double</td></tr><tr><td>'integer' (all formats)</td><td>int (64)</td></tr><tr><td>'null'</td><td>null_type</td></tr><tr><td>'string'</td><td>string</td></tr><tr><td>'string' with format=byte (base64 encoded)</td><td>bytes</td></tr><tr><td>'string' with format=date</td><td>timestamp (google.protobuf.Timestamp)</td></tr><tr><td>'string' with format=datetime</td><td>timestamp (google.protobuf.Timestamp)</td></tr><tr><td>'string' with format=duration</td><td>duration (google.protobuf.Duration)</td></tr></tbody></table><p>xref: <a href="https://github.com/google/cel-spec/blob/v0.6.0/doc/langdef.md#values">CEL types</a>,
<a href="https://swagger.io/specification/#data-types">OpenAPI types</a>,
<a href="/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/#specifying-a-structural-schema">Kubernetes Structural Schemas</a>.</p><h4 id="the-messageexpression-field">The messageExpression field</h4><p>Similar to the <code>message</code> field, which defines the string reported for a validation rule failure,
<code>messageExpression</code> allows you to use a CEL expression to construct the message string.
This allows you to insert more descriptive information into the validation failure message.
<code>messageExpression</code> must evaluate a string and may use the same variables that are available to the <code>rule</code>
field. For example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">x-kubernetes-validations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">rule</span>:<span style="color:#bbb"> </span><span style="color:#b44">"self.x &lt;= self.maxLimit"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">messageExpression</span>:<span style="color:#bbb"> </span><span style="color:#b44">'"x exceeded max limit of " + string(self.maxLimit)'</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>Keep in mind that CEL string concatenation (<code>+</code> operator) does not auto-cast to string. If
you have a non-string scalar, use the <code>string(&lt;value&gt;)</code> function to cast the scalar to a string
like shown in the above example.</p><p><code>messageExpression</code> must evaluate to a string, and this is checked while the CRD is being written. Note that it is possible
to set <code>message</code> and <code>messageExpression</code> on the same rule, and if both are present, <code>messageExpression</code>
will be used. However, if <code>messageExpression</code> evaluates to an error, the string defined in <code>message</code>
will be used instead, and the <code>messageExpression</code> error will be logged. This fallback will also occur if
the CEL expression defined in <code>messageExpression</code> generates an empty string, or a string containing line
breaks.</p><p>If one of the above conditions are met and no <code>message</code> has been set, then the default validation failure
message will be used instead.</p><p><code>messageExpression</code> is a CEL expression, so the restrictions listed in <a href="#resource-use-by-validation-functions">Resource use by validation functions</a> apply. If evaluation halts due to resource constraints
during <code>messageExpression</code> execution, then no further validation rules will be executed.</p><p>Setting <code>messageExpression</code> is optional.</p><h4 id="field-message">The <code>message</code> field</h4><p>If you want to set a static message, you can supply <code>message</code> rather than <code>messageExpression</code>.
The value of <code>message</code> is used as an opaque error string if validation fails.</p><p>Setting <code>message</code> is optional.</p><h4 id="field-reason">The <code>reason</code> field</h4><p>You can add a machine-readable validation failure reason within a <code>validation</code>, to be returned
whenever a request fails this validation rule.</p><p>For example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">x-kubernetes-validations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">rule</span>:<span style="color:#bbb"> </span><span style="color:#b44">"self.x &lt;= self.maxLimit"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">reason</span>:<span style="color:#bbb"> </span><span style="color:#b44">"FieldValueInvalid"</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>The HTTP status code returned to the caller will match the reason of the first failed validation rule.
The currently supported reasons are: "FieldValueInvalid", "FieldValueForbidden", "FieldValueRequired", "FieldValueDuplicate".
If not set or unknown reasons, default to use "FieldValueInvalid".</p><p>Setting <code>reason</code> is optional.</p><h4 id="field-field-path">The <code>fieldPath</code> field</h4><p>You can specify the field path returned when the validation fails.</p><p>For example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">x-kubernetes-validations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">rule</span>:<span style="color:#bbb"> </span><span style="color:#b44">"self.foo.test.x &lt;= self.maxLimit"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">fieldPath</span>:<span style="color:#bbb"> </span><span style="color:#b44">".foo.test.x"</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>In the example above, the validation checks the value of field <code>x</code> should be less than the value of <code>maxLimit</code>.
If no <code>fieldPath</code> specified, when validation fails, the fieldPath would be default to wherever <code>self</code> scoped.
With <code>fieldPath</code> specified, the returned error will have <code>fieldPath</code> properly refer to the location of field <code>x</code>.</p><p>The <code>fieldPath</code> value must be a relative JSON path that is scoped to the location of this x-kubernetes-validations extension in the schema.
Additionally, it should refer to an existing field within the schema.
For example when validation checks if a specific attribute <code>foo</code> under a map <code>testMap</code>, you could set
<code>fieldPath</code> to <code>".testMap.foo"</code> or <code>.testMap['foo']'</code>.
If the validation requires checking for unique attributes in two lists, the fieldPath can be set to either of the lists.
For example, it can be set to <code>.testList1</code> or <code>.testList2</code>.
It supports child operation to refer to an existing field currently.
Refer to <a href="/docs/reference/kubectl/jsonpath/">JSONPath support in Kubernetes</a> for more info.
The <code>fieldPath</code> field does not support indexing arrays numerically.</p><p>Setting <code>fieldPath</code> is optional.</p><h4 id="field-optional-oldself">The <code>optionalOldSelf</code> field</h4><div class="feature-state-notice feature-stable" title="Feature Gate: CRDValidationRatcheting"><span class="feature-state-name">FEATURE STATE:</span>
<code>Kubernetes v1.33 [stable]</code> (enabled by default: true)</div><p>If your cluster does not have <a href="#validation-ratcheting">CRD validation ratcheting</a> enabled,
the CustomResourceDefinition API doesn't include this field, and trying to set it may result
in an error.</p><p>The <code>optionalOldSelf</code> field is a boolean field that alters the behavior of <a href="#transition-rules">Transition Rules</a> described
below. Normally, a transition rule will not evaluate if <code>oldSelf</code> cannot be determined:
during object creation or when a new value is introduced in an update.</p><p>If <code>optionalOldSelf</code> is set to true, then transition rules will always be
evaluated and the type of <code>oldSelf</code> be changed to a CEL <a href="https://pkg.go.dev/github.com/google/cel-go/cel#OptionalTypes"><code>Optional</code></a> type.</p><p><code>optionalOldSelf</code> is useful in cases where schema authors would like a more
control tool <a href="#validation-ratcheting">than provided by the default equality based behavior of</a>
to introduce newer, usually stricter constraints on new values, while still
allowing old values to be "grandfathered" or ratcheted using the older validation.</p><p>Example Usage:</p><table><thead><tr><th>CEL</th><th>Description</th></tr></thead><tbody><tr><td><code>self.foo == "foo" || (oldSelf.hasValue() &amp;&amp; oldSelf.value().foo != "foo")</code></td><td>Ratcheted rule. Once a value is set to "foo", it must stay foo. But if it existed before the "foo" constraint was introduced, it may use any value</td></tr><tr><td><code>[oldSelf.orValue(""), self].all(x, ["OldCase1", "OldCase2"].exists(case, x == case)) || ["NewCase1", "NewCase2"].exists(case, self == case) || ["NewCase"].has(self)</code></td><td>"Ratcheted validation for removed enum cases if oldSelf used them"</td></tr><tr><td><code>oldSelf.optMap(o, o.size()).orValue(0) &lt; 4 || self.size() &gt;= 4</code></td><td>Ratcheted validation of newly increased minimum map or list size</td></tr></tbody></table><h4 id="available-validation-functions">Validation functions</h4><p>Functions available include:</p><ul><li>CEL standard functions, defined in the <a href="https://github.com/google/cel-spec/blob/v0.7.0/doc/langdef.md#list-of-standard-definitions">list of standard definitions</a></li><li>CEL standard <a href="https://github.com/google/cel-spec/blob/v0.7.0/doc/langdef.md#macros">macros</a></li><li>CEL <a href="https://pkg.go.dev/github.com/google/cel-go@v0.11.2/ext#Strings">extended string function library</a></li><li>Kubernetes <a href="https://pkg.go.dev/k8s.io/apiextensions-apiserver@v0.24.0/pkg/apiserver/schema/cel/library#pkg-functions">CEL extension library</a></li></ul><h4 id="transition-rules">Transition rules</h4><p>A rule that contains an expression referencing the identifier <code>oldSelf</code> is implicitly considered a
<em>transition rule</em>. Transition rules allow schema authors to prevent certain transitions between two
otherwise valid states. For example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">enum</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"low"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"medium"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"high"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">x-kubernetes-validations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">rule</span>:<span style="color:#bbb"> </span><span style="color:#b44">"!(self == 'high' &amp;&amp; oldSelf == 'low') &amp;&amp; !(self == 'low' &amp;&amp; oldSelf == 'high')"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">message</span>:<span style="color:#bbb"> </span>cannot transition directly between 'low' and 'high'<span style="color:#bbb">
</span></span></span></code></pre></div><p>Unlike other rules, transition rules apply only to operations meeting the following criteria:</p><ul><li><p>The operation updates an existing object. Transition rules never apply to create operations.</p></li><li><p>Both an old and a new value exist. It remains possible to check if a value has been added or
removed by placing a transition rule on the parent node. Transition rules are never applied to
custom resource creation. When placed on an optional field, a transition rule will not apply to
update operations that set or unset the field.</p></li><li><p>The path to the schema node being validated by a transition rule must resolve to a node that is
comparable between the old object and the new object. For example, list items and their
descendants (<code>spec.foo[10].bar</code>) can't necessarily be correlated between an existing object and a
later update to the same object.</p></li></ul><p>Errors will be generated on CRD writes if a schema node contains a transition rule that can never be
applied, e.g. "oldSelf cannot be used on the uncorrelatable portion of the schema within <em>path</em>".</p><p>Transition rules are only allowed on <em>correlatable portions</em> of a schema.
A portion of the schema is correlatable if all <code>array</code> parent schemas are of type <code>x-kubernetes-list-type=map</code>;
any <code>set</code>or <code>atomic</code>array parent schemas make it impossible to unambiguously correlate a <code>self</code> with <code>oldSelf</code>.</p><p>Here are some examples for transition rules:</p><table><caption style="display:none">Transition rules examples</caption><thead><tr><th>Use Case</th><th>Rule</th></tr></thead><tbody><tr><td>Immutability</td><td><code>self.foo == oldSelf.foo</code></td></tr><tr><td>Prevent modification/removal once assigned</td><td><code>oldSelf != 'bar' || self == 'bar'</code> or <code>!has(oldSelf.field) || has(self.field)</code></td></tr><tr><td>Append-only set</td><td><code>self.all(element, element in oldSelf)</code></td></tr><tr><td>If previous value was X, new value can only be A or B, not Y or Z</td><td><code>oldSelf != 'X' || self in ['A', 'B']</code></td></tr><tr><td>Monotonic (non-decreasing) counters</td><td><code>self &gt;= oldSelf</code></td></tr></tbody></table><h4 id="resource-use-by-validation-functions">Resource use by validation functions</h4><p>When you create or update a CustomResourceDefinition that uses validation rules,
the API server checks the likely impact of running those validation rules. If a rule is
estimated to be prohibitively expensive to execute, the API server rejects the create
or update operation, and returns an error message.
A similar system is used at runtime that observes the actions the interpreter takes. If the interpreter executes
too many instructions, execution of the rule will be halted, and an error will result.
Each CustomResourceDefinition is also allowed a certain amount of resources to finish executing all of
its validation rules. If the sum total of its rules are estimated at creation time to go over that limit,
then a validation error will also occur.</p><p>You are unlikely to encounter issues with the resource budget for validation if you only
specify rules that always take the same amount of time regardless of how large their input is.
For example, a rule that asserts that <code>self.foo == 1</code> does not by itself have any
risk of rejection on validation resource budget groups.
But if <code>foo</code> is a string and you define a validation rule <code>self.foo.contains("someString")</code>, that rule takes
longer to execute depending on how long <code>foo</code> is.
Another example would be if <code>foo</code> were an array, and you specified a validation rule <code>self.foo.all(x, x &gt; 5)</code>.
The cost system always assumes the worst-case scenario if a limit on the length of <code>foo</code> is not
given, and this will happen for anything that can be iterated over (lists, maps, etc.).</p><p>Because of this, it is considered best practice to put a limit via <code>maxItems</code>, <code>maxProperties</code>, and
<code>maxLength</code> for anything that will be processed in a validation rule in order to prevent validation
errors during cost estimation. For example, given this schema with one rule:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">openAPIV3Schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">foo</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>array<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">items</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">x-kubernetes-validations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">rule</span>:<span style="color:#bbb"> </span><span style="color:#b44">"self.all(x, x.contains('a string'))"</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>then the API server rejects this rule on validation budget grounds with error:</p><pre tabindex="0"><code>spec.validation.openAPIV3Schema.properties[spec].properties[foo].x-kubernetes-validations[0].rule: Forbidden:
CEL rule exceeded budget by more than 100x (try simplifying the rule, or adding maxItems, maxProperties, and
maxLength where arrays, maps, and strings are used)
</code></pre><p>The rejection happens because <code>self.all</code> implies calling <code>contains()</code> on every string in <code>foo</code>,
which in turn will check the given string to see if it contains <code>'a string'</code>. Without limits, this
is a very expensive rule.</p><p>If you do not specify any validation limit, the estimated cost of this rule will exceed the
per-rule cost limit. But if you add limits in the appropriate places, the rule will be allowed:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">openAPIV3Schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">foo</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>array<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">maxItems</span>:<span style="color:#bbb"> </span><span style="color:#666">25</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">items</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">maxLength</span>:<span style="color:#bbb"> </span><span style="color:#666">10</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">x-kubernetes-validations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">rule</span>:<span style="color:#bbb"> </span><span style="color:#b44">"self.all(x, x.contains('a string'))"</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>The cost estimation system takes into account how many times the rule will be executed in addition to the
estimated cost of the rule itself. For instance, the following rule will have the same estimated cost as the
previous example (despite the rule now being defined on the individual array items):</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">openAPIV3Schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">foo</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>array<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">maxItems</span>:<span style="color:#bbb"> </span><span style="color:#666">25</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">items</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">x-kubernetes-validations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span>- <span style="color:green;font-weight:700">rule</span>:<span style="color:#bbb"> </span><span style="color:#b44">"self.contains('a string'))"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">maxLength</span>:<span style="color:#bbb"> </span><span style="color:#666">10</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>If a list inside of a list has a validation rule that uses <code>self.all</code>, that is significantly more expensive
than a non-nested list with the same rule. A rule that would have been allowed on a non-nested list might need
lower limits set on both nested lists in order to be allowed. For example, even without having limits set,
the following rule is allowed:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">openAPIV3Schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">foo</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>array<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">items</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>integer<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">x-kubernetes-validations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">rule</span>:<span style="color:#bbb"> </span><span style="color:#b44">"self.all(x, x == 5)"</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>But the same rule on the following schema (with a nested array added) produces a validation error:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">openAPIV3Schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">foo</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>array<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">items</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>array<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">items</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>integer<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">x-kubernetes-validations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span>- <span style="color:green;font-weight:700">rule</span>:<span style="color:#bbb"> </span><span style="color:#b44">"self.all(x, x == 5)"</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>This is because each item of <code>foo</code> is itself an array, and each subarray in turn calls <code>self.all</code>.
Avoid nested lists and maps if possible where validation rules are used.</p><h3 id="defaulting">Defaulting</h3><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>To use defaulting, your CustomResourceDefinition must use API version <code>apiextensions.k8s.io/v1</code>.</div><p>Defaulting allows to specify default values in the <a href="#validation">OpenAPI v3 validation schema</a>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiextensions.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CustomResourceDefinition<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>crontabs.stable.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">group</span>:<span style="color:#bbb"> </span>stable.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">versions</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">served</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">storage</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic"># openAPIV3Schema is the schema for validating custom objects.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">openAPIV3Schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                </span><span style="color:green;font-weight:700">cronSpec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:green;font-weight:700">pattern</span>:<span style="color:#bbb"> </span><span style="color:#b44">'^(\d+|\*)(/\d+)?(\s+(\d+|\*)(/\d+)?){4}$'</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:green;font-weight:700">default</span>:<span style="color:#bbb"> </span><span style="color:#b44">"5 0 * * *"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>integer<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:green;font-weight:700">minimum</span>:<span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:green;font-weight:700">maximum</span>:<span style="color:#bbb"> </span><span style="color:#666">10</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:green;font-weight:700">default</span>:<span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">scope</span>:<span style="color:#bbb"> </span>Namespaced<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">names</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">plural</span>:<span style="color:#bbb"> </span>crontabs<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">singular</span>:<span style="color:#bbb"> </span>crontab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CronTab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">shortNames</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- ct<span style="color:#bbb">
</span></span></span></code></pre></div><p>With this both <code>cronSpec</code> and <code>replicas</code> are defaulted:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span><span style="color:#b44">"stable.example.com/v1"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CronTab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-new-cron-object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>my-awesome-cron-image<span style="color:#bbb">
</span></span></span></code></pre></div><p>leads to</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span><span style="color:#b44">"stable.example.com/v1"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CronTab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-new-cron-object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">cronSpec</span>:<span style="color:#bbb"> </span><span style="color:#b44">"5 0 * * *"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>my-awesome-cron-image<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>Defaulting happens on the object</p><ul><li>in the request to the API server using the request version defaults,</li><li>when reading from etcd using the storage version defaults,</li><li>after mutating admission plugins with non-empty patches using the admission webhook object version defaults.</li></ul><p>Defaults applied when reading data from etcd are not automatically written back to etcd.
An update request via the API is required to persist those defaults back into etcd.</p><p>Default values for non-leaf fields must be pruned (with the exception of defaults for <code>metadata</code> fields) and must
validate against a provided schema. For example in the above example, a default of <code>{"replicas": "foo", "badger": 1}</code>
for the <code>spec</code> field would be invalid, because <code>badger</code> is an unknown field, and <code>replicas</code> is not a string.</p><p>Default values for <code>metadata</code> fields of <code>x-kubernetes-embedded-resources: true</code> nodes (or parts of
a default value covering <code>metadata</code>) are not pruned during CustomResourceDefinition creation, but
through the pruning step during handling of requests.</p><h4 id="defaulting-and-nullable">Defaulting and Nullable</h4><p>Null values for fields that either don't specify the nullable flag, or give it a
<code>false</code> value, will be pruned before defaulting happens. If a default is present, it will be
applied. When nullable is <code>true</code>, null values will be conserved and won't be defaulted.</p><p>For example, given the OpenAPI schema below:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">foo</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">nullable</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">false</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">default</span>:<span style="color:#bbb"> </span><span style="color:#b44">"default"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">bar</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">nullable</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">baz</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span></code></pre></div><p>creating an object with null values for <code>foo</code> and <code>bar</code> and <code>baz</code></p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">foo</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">null</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">bar</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">null</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">baz</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">null</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>leads to</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">foo</span>:<span style="color:#bbb"> </span><span style="color:#b44">"default"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">bar</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">null</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>with <code>foo</code> pruned and defaulted because the field is non-nullable, <code>bar</code> maintaining the null
value due to <code>nullable: true</code>, and <code>baz</code> pruned because the field is non-nullable and has no
default.</p><h3 id="publish-validation-schema-in-openapi">Publish Validation Schema in OpenAPI</h3><p>CustomResourceDefinition <a href="#validation">OpenAPI v3 validation schemas</a> which are
<a href="#specifying-a-structural-schema">structural</a> and <a href="#field-pruning">enable pruning</a> are published
as <a href="/docs/concepts/overview/kubernetes-api/#openapi-and-swagger-definitions">OpenAPI v3</a> and
OpenAPI v2 from Kubernetes API server. It is recommended to use the OpenAPI v3 document
as it is a lossless representation of the CustomResourceDefinition OpenAPI v3 validation schema
while OpenAPI v2 represents a lossy conversion.</p><p>The <a href="/docs/reference/kubectl/">kubectl</a> command-line tool consumes the published schema to perform
client-side validation (<code>kubectl create</code> and <code>kubectl apply</code>), schema explanation (<code>kubectl explain</code>)
on custom resources. The published schema can be consumed for other purposes as well, like client generation or documentation.</p><h4 id="compatibility-with-openapi-v2">Compatibility with OpenAPI V2</h4><p>For compatibility with OpenAPI V2, the OpenAPI v3 validation schema performs a lossy conversion
to the OpenAPI v2 schema. The schema show up in <code>definitions</code> and <code>paths</code> fields in the
<a href="/docs/concepts/overview/kubernetes-api/#openapi-and-swagger-definitions">OpenAPI v2 spec</a>.</p><p>The following modifications are applied during the conversion to keep backwards compatibility with
kubectl in previous 1.13 version. These modifications prevent kubectl from being over-strict and rejecting
valid OpenAPI schemas that it doesn't understand. The conversion won't modify the validation schema defined in CRD,
and therefore won't affect <a href="#validation">validation</a> in the API server.</p><ol><li><p>The following fields are removed as they aren't supported by OpenAPI v2.</p><ul><li>The fields <code>allOf</code>, <code>anyOf</code>, <code>oneOf</code> and <code>not</code> are removed</li></ul></li><li><p>If <code>nullable: true</code> is set, we drop <code>type</code>, <code>nullable</code>, <code>items</code> and <code>properties</code> because OpenAPI v2 is
not able to express nullable. To avoid kubectl to reject good objects, this is necessary.</p></li></ol><h3 id="additional-printer-columns">Additional printer columns</h3><p>The kubectl tool relies on server-side output formatting. Your cluster's API server decides which
columns are shown by the <code>kubectl get</code> command. You can customize these columns for a
CustomResourceDefinition. The following example adds the <code>Spec</code>, <code>Replicas</code>, and <code>Age</code>
columns.</p><p>Save the CustomResourceDefinition to <code>resourcedefinition.yaml</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiextensions.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CustomResourceDefinition<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>crontabs.stable.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">group</span>:<span style="color:#bbb"> </span>stable.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">scope</span>:<span style="color:#bbb"> </span>Namespaced<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">names</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">plural</span>:<span style="color:#bbb"> </span>crontabs<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">singular</span>:<span style="color:#bbb"> </span>crontab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CronTab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">shortNames</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- ct<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">versions</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">served</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">storage</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">openAPIV3Schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">cronSpec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>integer<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">additionalPrinterColumns</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>Spec<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">description</span>:<span style="color:#bbb"> </span>The cron spec defining the interval a CronJob is run<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">jsonPath</span>:<span style="color:#bbb"> </span>.spec.cronSpec<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>Replicas<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>integer<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">description</span>:<span style="color:#bbb"> </span>The number of jobs launched by the CronJob<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">jsonPath</span>:<span style="color:#bbb"> </span>.spec.replicas<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>Age<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>date<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">jsonPath</span>:<span style="color:#bbb"> </span>.metadata.creationTimestamp<span style="color:#bbb">
</span></span></span></code></pre></div><p>Create the CustomResourceDefinition:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f resourcedefinition.yaml
</span></span></code></pre></div><p>Create an instance using the <code>my-crontab.yaml</code> from the previous section.</p><p>Invoke the server-side printing:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get crontab my-new-cron-object
</span></span></code></pre></div><p>Notice the <code>NAME</code>, <code>SPEC</code>, <code>REPLICAS</code>, and <code>AGE</code> columns in the output:</p><pre tabindex="0"><code>NAME                 SPEC        REPLICAS   AGE
my-new-cron-object   * * * * *   1          7s
</code></pre><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>The <code>NAME</code> column is implicit and does not need to be defined in the CustomResourceDefinition.</div><h4 id="priority">Priority</h4><p>Each column includes a <code>priority</code> field. Currently, the priority
differentiates between columns shown in standard view or wide view (using the <code>-o wide</code> flag).</p><ul><li>Columns with priority <code>0</code> are shown in standard view.</li><li>Columns with priority greater than <code>0</code> are shown only in wide view.</li></ul><h4 id="type">Type</h4><p>A column's <code>type</code> field can be any of the following (compare
<a href="https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.0.md#dataTypes">OpenAPI v3 data types</a>):</p><ul><li><code>integer</code>  non-floating-point numbers</li><li><code>number</code>  floating point numbers</li><li><code>string</code>  strings</li><li><code>boolean</code>  <code>true</code> or <code>false</code></li><li><code>date</code>  rendered differentially as time since this timestamp.</li></ul><p>If the value inside a CustomResource does not match the type specified for the column,
the value is omitted. Use CustomResource validation to ensure that the value
types are correct.</p><h4 id="format">Format</h4><p>A column's <code>format</code> field can be any of the following:</p><ul><li><code>int32</code></li><li><code>int64</code></li><li><code>float</code></li><li><code>double</code></li><li><code>byte</code></li><li><code>date</code></li><li><code>date-time</code></li><li><code>password</code></li></ul><p>The column's <code>format</code> controls the style used when <code>kubectl</code> prints the value.</p><h3 id="field-selectors">Field selectors</h3><p><a href="/docs/concepts/overview/working-with-objects/field-selectors/">Field Selectors</a>
let clients select custom resources based on the value of one or more resource
fields.</p><p>All custom resources support the <code>metadata.name</code> and <code>metadata.namespace</code> field
selectors.</p><p>Fields declared in a <a class="glossary-tooltip" title="Custom code that defines a resource to add to your Kubernetes API server without building a complete custom server." data-toggle="tooltip" data-placement="top" href="/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/" target="_blank" aria-label="CustomResourceDefinition">CustomResourceDefinition</a>
may also be used with field selectors when included in the <code>spec.versions[*].selectableFields</code> field of the
<a class="glossary-tooltip" title="Custom code that defines a resource to add to your Kubernetes API server without building a complete custom server." data-toggle="tooltip" data-placement="top" href="/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/" target="_blank" aria-label="CustomResourceDefinition">CustomResourceDefinition</a>.</p><h4 id="crd-selectable-fields">Selectable fields for custom resources</h4><div class="feature-state-notice feature-stable" title="Feature Gate: CustomResourceFieldSelectors"><span class="feature-state-name">FEATURE STATE:</span>
<code>Kubernetes v1.32 [stable]</code> (enabled by default: true)</div><p>The <code>spec.versions[*].selectableFields</code> field of a <a class="glossary-tooltip" title="Custom code that defines a resource to add to your Kubernetes API server without building a complete custom server." data-toggle="tooltip" data-placement="top" href="/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/" target="_blank" aria-label="CustomResourceDefinition">CustomResourceDefinition</a> may be used to
declare which other fields in a custom resource may be used in field selectors
with the feature of <code>CustomResourceFieldSelectors</code>
<a href="/docs/reference/command-line-tools-reference/feature-gates/">feature gate</a> (This feature gate is enabled by default since Kubernetes v1.31).
The following example adds the <code>.spec.color</code> and <code>.spec.size</code> fields as
selectable fields.</p><p>Save the CustomResourceDefinition to <code>shirt-resource-definition.yaml</code>:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/customresourcedefinition/shirt-resource-definition.yaml" download="customresourcedefinition/shirt-resource-definition.yaml"><code>customresourcedefinition/shirt-resource-definition.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;customresourcedefinition-shirt-resource-definition-yaml&quot;)" title="Copy customresourcedefinition/shirt-resource-definition.yaml to clipboard"/></div><div class="includecode" id="customresourcedefinition-shirt-resource-definition-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiextensions.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CustomResourceDefinition<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>shirts.stable.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">group</span>:<span style="color:#bbb"> </span>stable.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">scope</span>:<span style="color:#bbb"> </span>Namespaced<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">names</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">plural</span>:<span style="color:#bbb"> </span>shirts<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">singular</span>:<span style="color:#bbb"> </span>shirt<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Shirt<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">versions</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">served</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">storage</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">openAPIV3Schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">color</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">size</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">selectableFields</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">jsonPath</span>:<span style="color:#bbb"> </span>.spec.color<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">jsonPath</span>:<span style="color:#bbb"> </span>.spec.size<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">additionalPrinterColumns</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">jsonPath</span>:<span style="color:#bbb"> </span>.spec.color<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>Color<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">jsonPath</span>:<span style="color:#bbb"> </span>.spec.size<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>Size<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>Create the CustomResourceDefinition:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f https://k8s.io/examples/customresourcedefinition/shirt-resource-definition.yaml
</span></span></code></pre></div><p>Define some Shirts by editing <code>shirt-resources.yaml</code>; for example:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/customresourcedefinition/shirt-resources.yaml" download="customresourcedefinition/shirt-resources.yaml"><code>customresourcedefinition/shirt-resources.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;customresourcedefinition-shirt-resources-yaml&quot;)" title="Copy customresourcedefinition/shirt-resources.yaml to clipboard"/></div><div class="includecode" id="customresourcedefinition-shirt-resources-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#00f;font-weight:700">---</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>stable.example.com/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Shirt<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>example1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">color</span>:<span style="color:#bbb"> </span>blue<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">size</span>:<span style="color:#bbb"> </span>S<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#00f;font-weight:700">---</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>stable.example.com/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Shirt<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>example2<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">color</span>:<span style="color:#bbb"> </span>blue<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">size</span>:<span style="color:#bbb"> </span>M<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#00f;font-weight:700">---</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>stable.example.com/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Shirt<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>example3<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">color</span>:<span style="color:#bbb"> </span>green<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">size</span>:<span style="color:#bbb"> </span>M<span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>Create the custom resources:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f https://k8s.io/examples/customresourcedefinition/shirt-resources.yaml
</span></span></code></pre></div><p>Get all the resources:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get shirts.stable.example.com
</span></span></code></pre></div><p>The output is:</p><pre tabindex="0"><code>NAME       COLOR  SIZE
example1   blue   S
example2   blue   M
example3   green  M
</code></pre><p>Fetch blue shirts (retrieve Shirts with a <code>color</code> of <code>blue</code>):</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get shirts.stable.example.com --field-selector spec.color<span style="color:#666">=</span>blue
</span></span></code></pre></div><p>Should output:</p><pre tabindex="0"><code>NAME       COLOR  SIZE
example1   blue   S
example2   blue   M
</code></pre><p>Get only resources with a <code>color</code> of <code>green</code> and a <code>size</code> of <code>M</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get shirts.stable.example.com --field-selector spec.color<span style="color:#666">=</span>green,spec.size<span style="color:#666">=</span>M
</span></span></code></pre></div><p>Should output:</p><pre tabindex="0"><code>NAME       COLOR  SIZE
example2   blue   M
</code></pre><h3 id="subresources">Subresources</h3><p>Custom resources support <code>/status</code> and <code>/scale</code> subresources.</p><p>The status and scale subresources can be optionally enabled by
defining them in the CustomResourceDefinition.</p><h4 id="status-subresource">Status subresource</h4><p>When the status subresource is enabled, the <code>/status</code> subresource for the custom resource is exposed.</p><ul><li><p>The status and the spec stanzas are represented by the <code>.status</code> and <code>.spec</code> JSONPaths
respectively inside of a custom resource.</p></li><li><p><code>PUT</code> requests to the <code>/status</code> subresource take a custom resource object and ignore changes to
anything except the status stanza.</p></li><li><p><code>PUT</code> requests to the <code>/status</code> subresource only validate the status stanza of the custom
resource.</p></li><li><p><code>PUT</code>/<code>POST</code>/<code>PATCH</code> requests to the custom resource ignore changes to the status stanza.</p></li><li><p>The <code>.metadata.generation</code> value is incremented for all changes, except for changes to
<code>.metadata</code> or <code>.status</code>.</p></li><li><p>Only the following constructs are allowed at the root of the CRD OpenAPI validation schema:</p><ul><li><code>description</code></li><li><code>example</code></li><li><code>exclusiveMaximum</code></li><li><code>exclusiveMinimum</code></li><li><code>externalDocs</code></li><li><code>format</code></li><li><code>items</code></li><li><code>maximum</code></li><li><code>maxItems</code></li><li><code>maxLength</code></li><li><code>minimum</code></li><li><code>minItems</code></li><li><code>minLength</code></li><li><code>multipleOf</code></li><li><code>pattern</code></li><li><code>properties</code></li><li><code>required</code></li><li><code>title</code></li><li><code>type</code></li><li><code>uniqueItems</code></li></ul></li></ul><h4 id="scale-subresource">Scale subresource</h4><p>When the scale subresource is enabled, the <code>/scale</code> subresource for the custom resource is exposed.
The <code>autoscaling/v1.Scale</code> object is sent as the payload for <code>/scale</code>.</p><p>To enable the scale subresource, the following fields are defined in the CustomResourceDefinition.</p><ul><li><p><code>specReplicasPath</code> defines the JSONPath inside of a custom resource that corresponds to <code>scale.spec.replicas</code>.</p><ul><li>It is a required value.</li><li>Only JSONPaths under <code>.spec</code> and with the dot notation are allowed.</li><li>If there is no value under the <code>specReplicasPath</code> in the custom resource,
the <code>/scale</code> subresource will return an error on GET.</li></ul></li><li><p><code>statusReplicasPath</code> defines the JSONPath inside of a custom resource that corresponds to <code>scale.status.replicas</code>.</p><ul><li>It is a required value.</li><li>Only JSONPaths under <code>.status</code> and with the dot notation are allowed.</li><li>If there is no value under the <code>statusReplicasPath</code> in the custom resource,
the status replica value in the <code>/scale</code> subresource will default to 0.</li></ul></li><li><p><code>labelSelectorPath</code> defines the JSONPath inside of a custom resource that corresponds to
<code>Scale.Status.Selector</code>.</p><ul><li>It is an optional value.</li><li>It must be set to work with HPA and VPA.</li><li>Only JSONPaths under <code>.status</code> or <code>.spec</code> and with the dot notation are allowed.</li><li>If there is no value under the <code>labelSelectorPath</code> in the custom resource,
the status selector value in the <code>/scale</code> subresource will default to the empty string.</li><li>The field pointed by this JSON path must be a string field (not a complex selector struct)
which contains a serialized label selector in string form.</li></ul></li></ul><p>In the following example, both status and scale subresources are enabled.</p><p>Save the CustomResourceDefinition to <code>resourcedefinition.yaml</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiextensions.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CustomResourceDefinition<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>crontabs.stable.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">group</span>:<span style="color:#bbb"> </span>stable.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">versions</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">served</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">storage</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">openAPIV3Schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                </span><span style="color:green;font-weight:700">cronSpec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>integer<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">status</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>integer<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                </span><span style="color:green;font-weight:700">labelSelector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># subresources describes the subresources for custom resources.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">subresources</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic"># status enables the status subresource.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">status</span>:<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic"># scale enables the scale subresource.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">scale</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:#080;font-style:italic"># specReplicasPath defines the JSONPath inside of a custom resource that corresponds to Scale.Spec.Replicas.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">specReplicasPath</span>:<span style="color:#bbb"> </span>.spec.replicas<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:#080;font-style:italic"># statusReplicasPath defines the JSONPath inside of a custom resource that corresponds to Scale.Status.Replicas.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">statusReplicasPath</span>:<span style="color:#bbb"> </span>.status.replicas<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:#080;font-style:italic"># labelSelectorPath defines the JSONPath inside of a custom resource that corresponds to Scale.Status.Selector.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">labelSelectorPath</span>:<span style="color:#bbb"> </span>.status.labelSelector<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">scope</span>:<span style="color:#bbb"> </span>Namespaced<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">names</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">plural</span>:<span style="color:#bbb"> </span>crontabs<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">singular</span>:<span style="color:#bbb"> </span>crontab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CronTab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">shortNames</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- ct<span style="color:#bbb">
</span></span></span></code></pre></div><p>And create it:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f resourcedefinition.yaml
</span></span></code></pre></div><p>After the CustomResourceDefinition object has been created, you can create custom objects.</p><p>If you save the following YAML to <code>my-crontab.yaml</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span><span style="color:#b44">"stable.example.com/v1"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CronTab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-new-cron-object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">cronSpec</span>:<span style="color:#bbb"> </span><span style="color:#b44">"* * * * */5"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>my-awesome-cron-image<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">3</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>and create it:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f my-crontab.yaml
</span></span></code></pre></div><p>Then new namespaced RESTful API endpoints are created at:</p><pre tabindex="0"><code class="language-none" data-lang="none">/apis/stable.example.com/v1/namespaces/*/crontabs/status
</code></pre><p>and</p><pre tabindex="0"><code class="language-none" data-lang="none">/apis/stable.example.com/v1/namespaces/*/crontabs/scale
</code></pre><p>A custom resource can be scaled using the <code>kubectl scale</code> command.
For example, the following command sets <code>.spec.replicas</code> of the
custom resource created above to 5:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl scale --replicas<span style="color:#666">=</span><span style="color:#666">5</span> crontabs/my-new-cron-object
</span></span><span style="display:flex"><span>crontabs <span style="color:#b44">"my-new-cron-object"</span> scaled
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>kubectl get crontabs my-new-cron-object -o <span style="color:#b8860b">jsonpath</span><span style="color:#666">=</span><span style="color:#b44">'{.spec.replicas}'</span>
</span></span><span style="display:flex"><span><span style="color:#666">5</span>
</span></span></code></pre></div><p>You can use a <a href="/docs/tasks/run-application/configure-pdb/">PodDisruptionBudget</a> to protect custom
resources that have the scale subresource enabled.</p><h3 id="categories">Categories</h3><p>Categories is a list of grouped resources the custom resource belongs to (eg. <code>all</code>).
You can use <code>kubectl get &lt;category-name&gt;</code> to list the resources belonging to the category.</p><p>The following example adds <code>all</code> in the list of categories in the CustomResourceDefinition
and illustrates how to output the custom resource using <code>kubectl get all</code>.</p><p>Save the following CustomResourceDefinition to <code>resourcedefinition.yaml</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiextensions.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CustomResourceDefinition<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>crontabs.stable.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">group</span>:<span style="color:#bbb"> </span>stable.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">versions</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">served</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">storage</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">openAPIV3Schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                </span><span style="color:green;font-weight:700">cronSpec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>integer<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">scope</span>:<span style="color:#bbb"> </span>Namespaced<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">names</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">plural</span>:<span style="color:#bbb"> </span>crontabs<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">singular</span>:<span style="color:#bbb"> </span>crontab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CronTab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">shortNames</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- ct<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># categories is a list of grouped resources the custom resource belongs to.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">categories</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- all<span style="color:#bbb">
</span></span></span></code></pre></div><p>and create it:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f resourcedefinition.yaml
</span></span></code></pre></div><p>After the CustomResourceDefinition object has been created, you can create custom objects.</p><p>Save the following YAML to <code>my-crontab.yaml</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span><span style="color:#b44">"stable.example.com/v1"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CronTab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-new-cron-object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">cronSpec</span>:<span style="color:#bbb"> </span><span style="color:#b44">"* * * * */5"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>my-awesome-cron-image<span style="color:#bbb">
</span></span></span></code></pre></div><p>and create it:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f my-crontab.yaml
</span></span></code></pre></div><p>You can specify the category when using <code>kubectl get</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get all
</span></span></code></pre></div><p>and it will include the custom resources of kind <code>CronTab</code>:</p><pre tabindex="0"><code class="language-none" data-lang="none">NAME                          AGE
crontabs/my-new-cron-object   3s
</code></pre><h2 id="what-s-next">What's next</h2><ul><li><p>Read about <a href="/docs/concepts/extend-kubernetes/api-extension/custom-resources/">custom resources</a>.</p></li><li><p>See <a href="/docs/reference/generated/kubernetes-api/v1.34/#customresourcedefinition-v1-apiextensions-k8s-io">CustomResourceDefinition</a>.</p></li><li><p>Serve <a href="/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definition-versioning/">multiple versions</a> of a
CustomResourceDefinition.</p></li></ul></div>
<hr>
<div class="td-content"><h1 data-pagefind-weight="10">Use an HTTP Proxy to Access the Kubernetes API</h1><p>This page shows how to use an HTTP proxy to access the Kubernetes API.</p><h2 id="before-you-begin">Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul><p>To check the version, enter <code>kubectl version</code>.</p></p><p>If you do not already have an application running in your cluster, start
a Hello world application by entering this command:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl create deployment hello-app --image<span style="color:#666">=</span>gcr.io/google-samples/hello-app:2.0 --port<span style="color:#666">=</span><span style="color:#666">8080</span>
</span></span></code></pre></div><h2 id="using-kubectl-to-start-a-proxy-server">Using kubectl to start a proxy server</h2><p>This command starts a proxy to the Kubernetes API server:</p><pre><code>kubectl proxy --port=8080
</code></pre><h2 id="exploring-the-kubernetes-api">Exploring the Kubernetes API</h2><p>When the proxy server is running, you can explore the API using <code>curl</code>, <code>wget</code>,
or a browser.</p><p>Get the API versions:</p><pre><code>curl http://localhost:8080/api/
</code></pre><p>The output should look similar to this:</p><pre><code>{
  "kind": "APIVersions",
  "versions": [
    "v1"
  ],
  "serverAddressByClientCIDRs": [
    {
      "clientCIDR": "0.0.0.0/0",
      "serverAddress": "10.0.2.15:8443"
    }
  ]
}
</code></pre><p>Get a list of pods:</p><pre><code>curl http://localhost:8080/api/v1/namespaces/default/pods
</code></pre><p>The output should look similar to this:</p><pre><code>{
  "kind": "PodList",
  "apiVersion": "v1",
  "metadata": {
    "resourceVersion": "33074"
  },
  "items": [
    {
      "metadata": {
        "name": "kubernetes-bootcamp-2321272333-ix8pt",
        "generateName": "kubernetes-bootcamp-2321272333-",
        "namespace": "default",
        "uid": "ba21457c-6b1d-11e6-85f7-1ef9f1dab92b",
        "resourceVersion": "33003",
        "creationTimestamp": "2016-08-25T23:43:30Z",
        "labels": {
          "pod-template-hash": "2321272333",
          "run": "kubernetes-bootcamp"
        },
        ...
}
</code></pre><h2 id="what-s-next">What's next</h2><p>Learn more about <a href="/docs/reference/generated/kubectl/kubectl-commands#proxy">kubectl proxy</a>.</p></div>
<hr>
<div class="td-content"><h1 data-pagefind-weight="10">Versions in CustomResourceDefinitions</h1><p>This page explains how to add versioning information to
<a href="/docs/reference/kubernetes-api/extend-resources/custom-resource-definition-v1/">CustomResourceDefinitions</a>, to indicate the stability
level of your CustomResourceDefinitions or advance your API to a new version with conversion between API representations. It also describes how to upgrade an object from one version to another.</p><h2 id="before-you-begin">Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul><p>You should have an initial understanding of <a href="/docs/concepts/extend-kubernetes/api-extension/custom-resources/">custom resources</a>.</p>Your Kubernetes server must be at or later than version v1.16.<p>To check the version, enter <code>kubectl version</code>.</p><h2 id="overview">Overview</h2><p>The CustomResourceDefinition API provides a workflow for introducing and upgrading
to new versions of a CustomResourceDefinition.</p><p>When a CustomResourceDefinition is created, the first version is set in the
CustomResourceDefinition <code>spec.versions</code> list to an appropriate stability level
and a version number. For example <code>v1beta1</code> would indicate that the first
version is not yet stable. All custom resource objects will initially be stored
at this version.</p><p>Once the CustomResourceDefinition is created, clients may begin using the
<code>v1beta1</code> API.</p><p>Later it might be necessary to add new version such as <code>v1</code>.</p><p>Adding a new version:</p><ol><li>Pick a conversion strategy. Since custom resource objects need the ability to
be served at both versions, that means they will sometimes be served in a
different version than the one stored. To make this possible, the custom resource objects must sometimes be converted between the
version they are stored at and the version they are served at. If the
conversion involves schema changes and requires custom logic, a conversion
webhook should be used. If there are no schema changes, the default <code>None</code>
conversion strategy may be used and only the <code>apiVersion</code> field will be
modified when serving different versions.</li><li>If using conversion webhooks, create and deploy the conversion webhook. See
the <a href="#webhook-conversion">Webhook conversion</a> for more details.</li><li>Update the CustomResourceDefinition to include the new version in the
<code>spec.versions</code> list with <code>served:true</code>. Also, set <code>spec.conversion</code> field
to the selected conversion strategy. If using a conversion webhook, configure
<code>spec.conversion.webhookClientConfig</code> field to call the webhook.</li></ol><p>Once the new version is added, clients may incrementally migrate to the new
version. It is perfectly safe for some clients to use the old version while
others use the new version.</p><p>Migrate stored objects to the new version:</p><ol><li>See the <a href="#upgrade-existing-objects-to-a-new-stored-version">upgrade existing objects to a new stored version</a> section.</li></ol><p>It is safe for clients to use both the old and new version before, during and
after upgrading the objects to a new stored version.</p><p>Removing an old version:</p><ol><li>Ensure all clients are fully migrated to the new version. The kube-apiserver
logs can be reviewed to help identify any clients that are still accessing via
the old version.</li><li>Set <code>served</code> to <code>false</code> for the old version in the <code>spec.versions</code> list. If
any clients are still unexpectedly using the old version they may begin reporting
errors attempting to access the custom resource objects at the old version.
If this occurs, switch back to using <code>served:true</code> on the old version, migrate the
remaining clients to the new version and repeat this step.</li><li>Ensure the <a href="#upgrade-existing-objects-to-a-new-stored-version">upgrade of existing objects to the new stored version</a> step has been completed.<ol><li>Verify that the <code>storage</code> is set to <code>true</code> for the new version in the <code>spec.versions</code> list in the CustomResourceDefinition.</li><li>Verify that the old version is no longer listed in the CustomResourceDefinition <code>status.storedVersions</code>.</li></ol></li><li>Remove the old version from the CustomResourceDefinition <code>spec.versions</code> list.</li><li>Drop conversion support for the old version in conversion webhooks.</li></ol><h2 id="specify-multiple-versions">Specify multiple versions</h2><p>The CustomResourceDefinition API <code>versions</code> field can be used to support multiple versions of custom resources that you
have developed. Versions can have different schemas, and conversion webhooks can convert custom resources between versions.
Webhook conversions should follow the <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md">Kubernetes API conventions</a> wherever applicable.
Specifically, See the <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api_changes.md">API change documentation</a> for a set of useful gotchas and suggestions.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>In <code>apiextensions.k8s.io/v1beta1</code>, there was a <code>version</code> field instead of <code>versions</code>. The
<code>version</code> field is deprecated and optional, but if it is not empty, it must
match the first item in the <code>versions</code> field.</div><p>This example shows a CustomResourceDefinition with two versions. For the first
example, the assumption is all versions share the same schema with no conversion
between them. The comments in the YAML provide more context.</p><ul class="nav nav-tabs" id="customresourcedefinition-versioning-example-1" role="tablist"><li class="nav-item"><a data-toggle="tab" class="nav-link active" href="#customresourcedefinition-versioning-example-1-0" role="tab" aria-controls="customresourcedefinition-versioning-example-1-0" aria-selected="true">apiextensions.k8s.io/v1</a></li><li class="nav-item"><a data-toggle="tab" class="nav-link" href="#customresourcedefinition-versioning-example-1-1" role="tab" aria-controls="customresourcedefinition-versioning-example-1-1">apiextensions.k8s.io/v1beta1</a></li></ul><div class="tab-content" id="customresourcedefinition-versioning-example-1"><div id="customresourcedefinition-versioning-example-1-0" class="tab-pane show active" role="tabpanel" aria-labelledby="customresourcedefinition-versioning-example-1-0"><p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiextensions.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CustomResourceDefinition<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># name must match the spec fields below, and be in the form: &lt;plural&gt;.&lt;group&gt;</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>crontabs.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># group name to use for REST API: /apis/&lt;group&gt;/&lt;version&gt;</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">group</span>:<span style="color:#bbb"> </span>example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># list of versions supported by this CustomResourceDefinition</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">versions</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>v1beta1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># Each version can be enabled/disabled by Served flag.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">served</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># One and only one version must be marked as the storage version.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">storage</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># A schema is required</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">openAPIV3Schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">host</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">port</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">served</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">storage</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">false</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">openAPIV3Schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">host</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">port</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># The conversion section is introduced in Kubernetes 1.13+ with a default value of</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># None conversion (strategy sub-field set to None).</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">conversion</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># None conversion assumes the same schema for all versions and only sets the apiVersion</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># field of custom resources to the proper value</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">strategy</span>:<span style="color:#bbb"> </span>None<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># either Namespaced or Cluster</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">scope</span>:<span style="color:#bbb"> </span>Namespaced<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">names</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># plural name to be used in the URL: /apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">plural</span>:<span style="color:#bbb"> </span>crontabs<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># singular name to be used as an alias on the CLI and for display</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">singular</span>:<span style="color:#bbb"> </span>crontab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># kind is normally the CamelCased singular type. Your resource manifests use this.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CronTab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># shortNames allow shorter string to match your resource on the CLI</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">shortNames</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- ct<span style="color:#bbb">
</span></span></span></code></pre></div></p></div><div id="customresourcedefinition-versioning-example-1-1" class="tab-pane" role="tabpanel" aria-labelledby="customresourcedefinition-versioning-example-1-1"><p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Deprecated in v1.16 in favor of apiextensions.k8s.io/v1</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiextensions.k8s.io/v1beta1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CustomResourceDefinition<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># name must match the spec fields below, and be in the form: &lt;plural&gt;.&lt;group&gt;</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>crontabs.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># group name to use for REST API: /apis/&lt;group&gt;/&lt;version&gt;</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">group</span>:<span style="color:#bbb"> </span>example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># list of versions supported by this CustomResourceDefinition</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">versions</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>v1beta1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># Each version can be enabled/disabled by Served flag.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">served</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># One and only one version must be marked as the storage version.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">storage</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">served</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">storage</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">false</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">validation</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">openAPIV3Schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">host</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">port</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># The conversion section is introduced in Kubernetes 1.13+ with a default value of</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># None conversion (strategy sub-field set to None).</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">conversion</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># None conversion assumes the same schema for all versions and only sets the apiVersion</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># field of custom resources to the proper value</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">strategy</span>:<span style="color:#bbb"> </span>None<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># either Namespaced or Cluster</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">scope</span>:<span style="color:#bbb"> </span>Namespaced<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">names</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># plural name to be used in the URL: /apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">plural</span>:<span style="color:#bbb"> </span>crontabs<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># singular name to be used as an alias on the CLI and for display</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">singular</span>:<span style="color:#bbb"> </span>crontab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># kind is normally the PascalCased singular type. Your resource manifests use this.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CronTab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># shortNames allow shorter string to match your resource on the CLI</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">shortNames</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- ct<span style="color:#bbb">
</span></span></span></code></pre></div></p></div></div><p>You can save the CustomResourceDefinition in a YAML file, then use
<code>kubectl apply</code> to create it.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f my-versioned-crontab.yaml
</span></span></code></pre></div><p>After creation, the API server starts to serve each enabled version at an HTTP
REST endpoint. In the above example, the API versions are available at
<code>/apis/example.com/v1beta1</code> and <code>/apis/example.com/v1</code>.</p><h3 id="version-priority">Version priority</h3><p>Regardless of the order in which versions are defined in a
CustomResourceDefinition, the version with the highest priority is used by
kubectl as the default version to access objects. The priority is determined
by parsing the <em>name</em> field to determine the version number, the stability
(GA, Beta, or Alpha), and the sequence within that stability level.</p><p>The algorithm used for sorting the versions is designed to sort versions in the
same way that the Kubernetes project sorts Kubernetes versions. Versions start with a
<code>v</code> followed by a number, an optional <code>beta</code> or <code>alpha</code> designation, and
optional additional numeric versioning information. Broadly, a version string might look
like <code>v2</code> or <code>v2beta1</code>. Versions are sorted using the following algorithm:</p><ul><li>Entries that follow Kubernetes version patterns are sorted before those that
do not.</li><li>For entries that follow Kubernetes version patterns, the numeric portions of
the version string is sorted largest to smallest.</li><li>If the strings <code>beta</code> or <code>alpha</code> follow the first numeric portion, they sorted
in that order, after the equivalent string without the <code>beta</code> or <code>alpha</code>
suffix (which is presumed to be the GA version).</li><li>If another number follows the <code>beta</code>, or <code>alpha</code>, those numbers are also
sorted from largest to smallest.</li><li>Strings that don't fit the above format are sorted alphabetically and the
numeric portions are not treated specially. Notice that in the example below,
<code>foo1</code> is sorted above <code>foo10</code>. This is different from the sorting of the
numeric portion of entries that do follow the Kubernetes version patterns.</li></ul><p>This might make sense if you look at the following sorted version list:</p><pre tabindex="0"><code class="language-none" data-lang="none">- v10
- v2
- v1
- v11beta2
- v10beta3
- v3beta1
- v12alpha1
- v11alpha2
- foo1
- foo10
</code></pre><p>For the example in <a href="#specify-multiple-versions">Specify multiple versions</a>, the
version sort order is <code>v1</code>, followed by <code>v1beta1</code>. This causes the kubectl
command to use <code>v1</code> as the default version unless the provided object specifies
the version.</p><h3 id="version-deprecation">Version deprecation</h3><div class="feature-state-notice feature-stable"><span class="feature-state-name">FEATURE STATE:</span>
<code>Kubernetes v1.19 [stable]</code></div><p>Starting in v1.19, a CustomResourceDefinition can indicate a particular version of the resource it defines is deprecated.
When API requests to a deprecated version of that resource are made, a warning message is returned in the API response as a header.
The warning message for each deprecated version of the resource can be customized if desired.</p><p>A customized warning message should indicate the deprecated API group, version, and kind,
and should indicate what API group, version, and kind should be used instead, if applicable.</p><ul class="nav nav-tabs" id="customresourcedefinition-versioning-deprecated" role="tablist"><li class="nav-item"><a data-toggle="tab" class="nav-link active" href="#customresourcedefinition-versioning-deprecated-0" role="tab" aria-controls="customresourcedefinition-versioning-deprecated-0" aria-selected="true">apiextensions.k8s.io/v1</a></li><li class="nav-item"><a data-toggle="tab" class="nav-link" href="#customresourcedefinition-versioning-deprecated-1" role="tab" aria-controls="customresourcedefinition-versioning-deprecated-1">apiextensions.k8s.io/v1beta1</a></li></ul><div class="tab-content" id="customresourcedefinition-versioning-deprecated"><div id="customresourcedefinition-versioning-deprecated-0" class="tab-pane show active" role="tabpanel" aria-labelledby="customresourcedefinition-versioning-deprecated-0"><p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiextensions.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CustomResourceDefinition<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>crontabs.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">group</span>:<span style="color:#bbb"> </span>example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">names</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">plural</span>:<span style="color:#bbb"> </span>crontabs<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">singular</span>:<span style="color:#bbb"> </span>crontab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CronTab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">scope</span>:<span style="color:#bbb"> </span>Namespaced<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">versions</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>v1alpha1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">served</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">storage</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">false</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># This indicates the v1alpha1 version of the custom resource is deprecated.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># API requests to this version receive a warning header in the server response.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">deprecated</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># This overrides the default warning returned to API clients making v1alpha1 API requests.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">deprecationWarning</span>:<span style="color:#bbb"> </span><span style="color:#b44">"example.com/v1alpha1 CronTab is deprecated; see http://example.com/v1alpha1-v1 for instructions to migrate to example.com/v1 CronTab"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">schema</span>:<span style="color:#bbb"> </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>v1beta1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">served</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># This indicates the v1beta1 version of the custom resource is deprecated.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># API requests to this version receive a warning header in the server response.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># A default warning message is returned for this version.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">deprecated</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">schema</span>:<span style="color:#bbb"> </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">served</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">storage</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">schema</span>:<span style="color:#bbb"> </span>...<span style="color:#bbb">
</span></span></span></code></pre></div></p></div><div id="customresourcedefinition-versioning-deprecated-1" class="tab-pane" role="tabpanel" aria-labelledby="customresourcedefinition-versioning-deprecated-1"><p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Deprecated in v1.16 in favor of apiextensions.k8s.io/v1</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiextensions.k8s.io/v1beta1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CustomResourceDefinition<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>crontabs.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">group</span>:<span style="color:#bbb"> </span>example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">names</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">plural</span>:<span style="color:#bbb"> </span>crontabs<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">singular</span>:<span style="color:#bbb"> </span>crontab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CronTab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">scope</span>:<span style="color:#bbb"> </span>Namespaced<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">validation</span>:<span style="color:#bbb"> </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">versions</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>v1alpha1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">served</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">storage</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">false</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># This indicates the v1alpha1 version of the custom resource is deprecated.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># API requests to this version receive a warning header in the server response.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">deprecated</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># This overrides the default warning returned to API clients making v1alpha1 API requests.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">deprecationWarning</span>:<span style="color:#bbb"> </span><span style="color:#b44">"example.com/v1alpha1 CronTab is deprecated; see http://example.com/v1alpha1-v1 for instructions to migrate to example.com/v1 CronTab"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>v1beta1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">served</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># This indicates the v1beta1 version of the custom resource is deprecated.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># API requests to this version receive a warning header in the server response.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># A default warning message is returned for this version.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">deprecated</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">served</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">storage</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span></code></pre></div></p></div></div><h3 id="version-removal">Version removal</h3><p>An older API version cannot be dropped from a CustomResourceDefinition manifest until existing stored data has been migrated to the newer API version for all clusters that served the older version of the custom resource, and the old version is removed from the <code>status.storedVersions</code> of the CustomResourceDefinition.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiextensions.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CustomResourceDefinition<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>crontabs.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">group</span>:<span style="color:#bbb"> </span>example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">names</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">plural</span>:<span style="color:#bbb"> </span>crontabs<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">singular</span>:<span style="color:#bbb"> </span>crontab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CronTab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">scope</span>:<span style="color:#bbb"> </span>Namespaced<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">versions</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>v1beta1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># This indicates the v1beta1 version of the custom resource is no longer served.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># API requests to this version receive a not found error in the server response.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">served</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">false</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">schema</span>:<span style="color:#bbb"> </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">served</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># The new served version should be set as the storage version</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">storage</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">schema</span>:<span style="color:#bbb"> </span>...<span style="color:#bbb">
</span></span></span></code></pre></div><h2 id="webhook-conversion">Webhook conversion</h2><div class="feature-state-notice feature-stable"><span class="feature-state-name">FEATURE STATE:</span>
<code>Kubernetes v1.16 [stable]</code></div><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>Webhook conversion is available as beta since 1.15, and as alpha since Kubernetes 1.13. The
<code>CustomResourceWebhookConversion</code> feature must be enabled, which is the case automatically for many clusters for beta features. Please refer to the <a href="/docs/reference/command-line-tools-reference/feature-gates/">feature gate</a> documentation for more information.</div><p>The above example has a None conversion between versions which only sets the <code>apiVersion</code> field
on conversion and does not change the rest of the object. The API server also supports webhook
conversions that call an external service in case a conversion is required. For example when:</p><ul><li>custom resource is requested in a different version than stored version.</li><li>Watch is created in one version but the changed object is stored in another version.</li><li>custom resource PUT request is in a different version than storage version.</li></ul><p>To cover all of these cases and to optimize conversion by the API server,
the conversion requests may contain multiple objects in order to minimize the external calls.
The webhook should perform these conversions independently.</p><h3 id="write-a-conversion-webhook-server">Write a conversion webhook server</h3><p>Please refer to the implementation of the <a href="https://github.com/kubernetes/kubernetes/tree/v1.25.3/test/images/agnhost/crd-conversion-webhook/main.go">custom resource conversion webhook
server</a>
that is validated in a Kubernetes e2e test. The webhook handles the
<code>ConversionReview</code> requests sent by the API servers, and sends back conversion
results wrapped in <code>ConversionResponse</code>. Note that the request
contains a list of custom resources that need to be converted independently without
changing the order of objects.
The example server is organized in a way to be reused for other conversions.
Most of the common code are located in the
<a href="https://github.com/kubernetes/kubernetes/tree/v1.25.3/test/images/agnhost/crd-conversion-webhook/converter/framework.go">framework file</a>
that leaves only
<a href="https://github.com/kubernetes/kubernetes/tree/v1.25.3/test/images/agnhost/crd-conversion-webhook/converter/example_converter.go#L29-L80">one function</a>
to be implemented for different conversions.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>The example conversion webhook server leaves the <code>ClientAuth</code> field
<a href="https://github.com/kubernetes/kubernetes/tree/v1.25.3/test/images/agnhost/crd-conversion-webhook/config.go#L47-L48">empty</a>,
which defaults to <code>NoClientCert</code>. This means that the webhook server does not
authenticate the identity of the clients, supposedly API servers. If you need
mutual TLS or other ways to authenticate the clients, see
how to <a href="/docs/reference/access-authn-authz/extensible-admission-controllers/#authenticate-apiservers">authenticate API servers</a>.</div><h4 id="permissible-mutations">Permissible mutations</h4><p>A conversion webhook must not mutate anything inside of <code>metadata</code> of the converted object
other than <code>labels</code> and <code>annotations</code>.
Attempted changes to <code>name</code>, <code>UID</code> and <code>namespace</code> are rejected and fail the request
which caused the conversion. All other changes are ignored.</p><h3 id="deploy-the-conversion-webhook-service">Deploy the conversion webhook service</h3><p>Documentation for deploying the conversion webhook is the same as for the
<a href="/docs/reference/access-authn-authz/extensible-admission-controllers/#deploy-the-admission-webhook-service">admission webhook example service</a>.
The assumption for next sections is that the conversion webhook server is deployed to a service
named <code>example-conversion-webhook-server</code> in <code>default</code> namespace and serving traffic on path <code>/crdconvert</code>.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>When the webhook server is deployed into the Kubernetes cluster as a
service, it has to be exposed via a service on port 443 (The server
itself can have an arbitrary port but the service object should map it to port 443).
The communication between the API server and the webhook service may fail
if a different port is used for the service.</div><h3 id="configure-customresourcedefinition-to-use-conversion-webhooks">Configure CustomResourceDefinition to use conversion webhooks</h3><p>The <code>None</code> conversion example can be extended to use the conversion webhook by modifying <code>conversion</code>
section of the <code>spec</code>:</p><ul class="nav nav-tabs" id="customresourcedefinition-versioning-example-2" role="tablist"><li class="nav-item"><a data-toggle="tab" class="nav-link active" href="#customresourcedefinition-versioning-example-2-0" role="tab" aria-controls="customresourcedefinition-versioning-example-2-0" aria-selected="true">apiextensions.k8s.io/v1</a></li><li class="nav-item"><a data-toggle="tab" class="nav-link" href="#customresourcedefinition-versioning-example-2-1" role="tab" aria-controls="customresourcedefinition-versioning-example-2-1">apiextensions.k8s.io/v1beta1</a></li></ul><div class="tab-content" id="customresourcedefinition-versioning-example-2"><div id="customresourcedefinition-versioning-example-2-0" class="tab-pane show active" role="tabpanel" aria-labelledby="customresourcedefinition-versioning-example-2-0"><p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiextensions.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CustomResourceDefinition<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># name must match the spec fields below, and be in the form: &lt;plural&gt;.&lt;group&gt;</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>crontabs.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># group name to use for REST API: /apis/&lt;group&gt;/&lt;version&gt;</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">group</span>:<span style="color:#bbb"> </span>example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># list of versions supported by this CustomResourceDefinition</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">versions</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>v1beta1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># Each version can be enabled/disabled by Served flag.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">served</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># One and only one version must be marked as the storage version.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">storage</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># Each version can define its own schema when there is no top-level</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># schema is defined.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">openAPIV3Schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">hostPort</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">served</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">storage</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">false</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">openAPIV3Schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">host</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">port</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">conversion</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># the Webhook strategy instructs the API server to call an external webhook for any conversion between custom resources.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">strategy</span>:<span style="color:#bbb"> </span>Webhook<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># webhook is required when strategy is `Webhook` and it configures the webhook endpoint to be called by API server.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">webhook</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># conversionReviewVersions indicates what ConversionReview versions are understood/preferred by the webhook.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># The first version in the list understood by the API server is sent to the webhook.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># The webhook must respond with a ConversionReview object in the same version it received.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">conversionReviewVersions</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"v1"</span>,<span style="color:#b44">"v1beta1"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">clientConfig</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">service</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>example-conversion-webhook-server<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">path</span>:<span style="color:#bbb"> </span>/crdconvert<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">caBundle</span>:<span style="color:#bbb"> </span><span style="color:#b44">"Ci0tLS0tQk...&lt;base64-encoded PEM bundle&gt;...tLS0K"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># either Namespaced or Cluster</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">scope</span>:<span style="color:#bbb"> </span>Namespaced<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">names</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># plural name to be used in the URL: /apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">plural</span>:<span style="color:#bbb"> </span>crontabs<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># singular name to be used as an alias on the CLI and for display</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">singular</span>:<span style="color:#bbb"> </span>crontab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># kind is normally the CamelCased singular type. Your resource manifests use this.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CronTab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># shortNames allow shorter string to match your resource on the CLI</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">shortNames</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- ct<span style="color:#bbb">
</span></span></span></code></pre></div></p></div><div id="customresourcedefinition-versioning-example-2-1" class="tab-pane" role="tabpanel" aria-labelledby="customresourcedefinition-versioning-example-2-1"><p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Deprecated in v1.16 in favor of apiextensions.k8s.io/v1</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiextensions.k8s.io/v1beta1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CustomResourceDefinition<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># name must match the spec fields below, and be in the form: &lt;plural&gt;.&lt;group&gt;</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>crontabs.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># group name to use for REST API: /apis/&lt;group&gt;/&lt;version&gt;</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">group</span>:<span style="color:#bbb"> </span>example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># prunes object fields that are not specified in OpenAPI schemas below.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">preserveUnknownFields</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">false</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># list of versions supported by this CustomResourceDefinition</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">versions</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>v1beta1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># Each version can be enabled/disabled by Served flag.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">served</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># One and only one version must be marked as the storage version.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">storage</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># Each version can define its own schema when there is no top-level</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># schema is defined.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">openAPIV3Schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">hostPort</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">served</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">storage</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">false</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">openAPIV3Schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">host</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">port</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">conversion</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># the Webhook strategy instructs the API server to call an external webhook for any conversion between custom resources.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">strategy</span>:<span style="color:#bbb"> </span>Webhook<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># webhookClientConfig is required when strategy is `Webhook` and it configures the webhook endpoint to be called by API server.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">webhookClientConfig</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">service</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>example-conversion-webhook-server<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">path</span>:<span style="color:#bbb"> </span>/crdconvert<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">caBundle</span>:<span style="color:#bbb"> </span><span style="color:#b44">"Ci0tLS0tQk...&lt;base64-encoded PEM bundle&gt;...tLS0K"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># either Namespaced or Cluster</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">scope</span>:<span style="color:#bbb"> </span>Namespaced<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">names</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># plural name to be used in the URL: /apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">plural</span>:<span style="color:#bbb"> </span>crontabs<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># singular name to be used as an alias on the CLI and for display</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">singular</span>:<span style="color:#bbb"> </span>crontab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># kind is normally the CamelCased singular type. Your resource manifests use this.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CronTab<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># shortNames allow shorter string to match your resource on the CLI</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">shortNames</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- ct<span style="color:#bbb">
</span></span></span></code></pre></div></p></div></div><p>You can save the CustomResourceDefinition in a YAML file, then use
<code>kubectl apply</code> to apply it.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f my-versioned-crontab-with-conversion.yaml
</span></span></code></pre></div><p>Make sure the conversion service is up and running before applying new changes.</p><h3 id="contacting-the-webhook">Contacting the webhook</h3><p>Once the API server has determined a request should be sent to a conversion webhook,
it needs to know how to contact the webhook. This is specified in the <code>webhookClientConfig</code>
stanza of the webhook configuration.</p><p>Conversion webhooks can either be called via a URL or a service reference,
and can optionally include a custom CA bundle to use to verify the TLS connection.</p><h3 id="url">URL</h3><p><code>url</code> gives the location of the webhook, in standard URL form
(<code>scheme://host:port/path</code>).</p><p>The <code>host</code> should not refer to a service running in the cluster; use
a service reference by specifying the <code>service</code> field instead.
The host might be resolved via external DNS in some apiservers
(i.e., <code>kube-apiserver</code> cannot resolve in-cluster DNS as that would
be a layering violation). <code>host</code> may also be an IP address.</p><p>Please note that using <code>localhost</code> or <code>127.0.0.1</code> as a <code>host</code> is
risky unless you take great care to run this webhook on all hosts
which run an apiserver which might need to make calls to this
webhook. Such installations are likely to be non-portable or not readily run in a new cluster.</p><p>The scheme must be "https"; the URL must begin with "https://".</p><p>Attempting to use a user or basic auth (for example "user:password@") is not allowed.
Fragments ("#...") and query parameters ("?...") are also not allowed.</p><p>Here is an example of a conversion webhook configured to call a URL
(and expects the TLS certificate to be verified using system trust roots, so does not specify a caBundle):</p><ul class="nav nav-tabs" id="customresourcedefinition-versioning-example-3" role="tablist"><li class="nav-item"><a data-toggle="tab" class="nav-link active" href="#customresourcedefinition-versioning-example-3-0" role="tab" aria-controls="customresourcedefinition-versioning-example-3-0" aria-selected="true">apiextensions.k8s.io/v1</a></li><li class="nav-item"><a data-toggle="tab" class="nav-link" href="#customresourcedefinition-versioning-example-3-1" role="tab" aria-controls="customresourcedefinition-versioning-example-3-1">apiextensions.k8s.io/v1beta1</a></li></ul><div class="tab-content" id="customresourcedefinition-versioning-example-3"><div id="customresourcedefinition-versioning-example-3-0" class="tab-pane show active" role="tabpanel" aria-labelledby="customresourcedefinition-versioning-example-3-0"><p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiextensions.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CustomResourceDefinition<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#00f;font-weight:700">...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">conversion</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">strategy</span>:<span style="color:#bbb"> </span>Webhook<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">webhook</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">clientConfig</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">url</span>:<span style="color:#bbb"> </span><span style="color:#b44">"https://my-webhook.example.com:9443/my-webhook-path"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#00f;font-weight:700">...</span><span style="color:#bbb">
</span></span></span></code></pre></div></p></div><div id="customresourcedefinition-versioning-example-3-1" class="tab-pane" role="tabpanel" aria-labelledby="customresourcedefinition-versioning-example-3-1"><p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Deprecated in v1.16 in favor of apiextensions.k8s.io/v1</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiextensions.k8s.io/v1beta1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CustomResourceDefinition<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#00f;font-weight:700">...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">conversion</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">strategy</span>:<span style="color:#bbb"> </span>Webhook<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">webhookClientConfig</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">url</span>:<span style="color:#bbb"> </span><span style="color:#b44">"https://my-webhook.example.com:9443/my-webhook-path"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#00f;font-weight:700">...</span><span style="color:#bbb">
</span></span></span></code></pre></div></p></div></div><h3 id="service-reference">Service Reference</h3><p>The <code>service</code> stanza inside <code>webhookClientConfig</code> is a reference to the service for a conversion webhook.
If the webhook is running within the cluster, then you should use <code>service</code> instead of <code>url</code>.
The service namespace and name are required. The port is optional and defaults to 443.
The path is optional and defaults to "/".</p><p>Here is an example of a webhook that is configured to call a service on port "1234"
at the subpath "/my-path", and to verify the TLS connection against the ServerName
<code>my-service-name.my-service-namespace.svc</code> using a custom CA bundle.</p><ul class="nav nav-tabs" id="customresourcedefinition-versioning-example-4" role="tablist"><li class="nav-item"><a data-toggle="tab" class="nav-link active" href="#customresourcedefinition-versioning-example-4-0" role="tab" aria-controls="customresourcedefinition-versioning-example-4-0" aria-selected="true">apiextensions.k8s.io/v1</a></li><li class="nav-item"><a data-toggle="tab" class="nav-link" href="#customresourcedefinition-versioning-example-4-1" role="tab" aria-controls="customresourcedefinition-versioning-example-4-1">apiextensions.k8s.io/v1beta1</a></li></ul><div class="tab-content" id="customresourcedefinition-versioning-example-4"><div id="customresourcedefinition-versioning-example-4-0" class="tab-pane show active" role="tabpanel" aria-labelledby="customresourcedefinition-versioning-example-4-0"><p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiextensions.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CustomResourceDefinition<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#00f;font-weight:700">...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">conversion</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">strategy</span>:<span style="color:#bbb"> </span>Webhook<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">webhook</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">clientConfig</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">service</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>my-service-namespace<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-service-name<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">path</span>:<span style="color:#bbb"> </span>/my-path<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">port</span>:<span style="color:#bbb"> </span><span style="color:#666">1234</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">caBundle</span>:<span style="color:#bbb"> </span><span style="color:#b44">"Ci0tLS0tQk...&lt;base64-encoded PEM bundle&gt;...tLS0K"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#00f;font-weight:700">...</span><span style="color:#bbb">
</span></span></span></code></pre></div></p></div><div id="customresourcedefinition-versioning-example-4-1" class="tab-pane" role="tabpanel" aria-labelledby="customresourcedefinition-versioning-example-4-1"><p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Deprecated in v1.16 in favor of apiextensions.k8s.io/v1</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiextensions.k8s.io/v1beta1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CustomResourceDefinition<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#00f;font-weight:700">...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">conversion</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">strategy</span>:<span style="color:#bbb"> </span>Webhook<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">webhookClientConfig</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">service</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>my-service-namespace<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-service-name<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">path</span>:<span style="color:#bbb"> </span>/my-path<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">port</span>:<span style="color:#bbb"> </span><span style="color:#666">1234</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">caBundle</span>:<span style="color:#bbb"> </span><span style="color:#b44">"Ci0tLS0tQk...&lt;base64-encoded PEM bundle&gt;...tLS0K"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#00f;font-weight:700">...</span><span style="color:#bbb">
</span></span></span></code></pre></div></p></div></div><h2 id="webhook-request-and-response">Webhook request and response</h2><h3 id="request">Request</h3><p>Webhooks are sent a POST request, with <code>Content-Type: application/json</code>,
with a <code>ConversionReview</code> API object in the <code>apiextensions.k8s.io</code> API group
serialized to JSON as the body.</p><p>Webhooks can specify what versions of <code>ConversionReview</code> objects they accept
with the <code>conversionReviewVersions</code> field in their CustomResourceDefinition:</p><ul class="nav nav-tabs" id="conversionreviewversions" role="tablist"><li class="nav-item"><a data-toggle="tab" class="nav-link active" href="#conversionreviewversions-0" role="tab" aria-controls="conversionreviewversions-0" aria-selected="true">apiextensions.k8s.io/v1</a></li><li class="nav-item"><a data-toggle="tab" class="nav-link" href="#conversionreviewversions-1" role="tab" aria-controls="conversionreviewversions-1">apiextensions.k8s.io/v1beta1</a></li></ul><div class="tab-content" id="conversionreviewversions"><div id="conversionreviewversions-0" class="tab-pane show active" role="tabpanel" aria-labelledby="conversionreviewversions-0"><p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiextensions.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CustomResourceDefinition<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#00f;font-weight:700">...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">conversion</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">strategy</span>:<span style="color:#bbb"> </span>Webhook<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">webhook</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">conversionReviewVersions</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"v1"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"v1beta1"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>...<span style="color:#bbb">
</span></span></span></code></pre></div><p><code>conversionReviewVersions</code> is a required field when creating
<code>apiextensions.k8s.io/v1</code> custom resource definitions.
Webhooks are required to support at least one <code>ConversionReview</code>
version understood by the current and previous API server.</p></p></div><div id="conversionreviewversions-1" class="tab-pane" role="tabpanel" aria-labelledby="conversionreviewversions-1"><p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Deprecated in v1.16 in favor of apiextensions.k8s.io/v1</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiextensions.k8s.io/v1beta1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CustomResourceDefinition<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#00f;font-weight:700">...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">conversion</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">strategy</span>:<span style="color:#bbb"> </span>Webhook<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">conversionReviewVersions</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"v1"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"v1beta1"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>...<span style="color:#bbb">
</span></span></span></code></pre></div><p>If no <code>conversionReviewVersions</code> are specified, the default when creating
<code>apiextensions.k8s.io/v1beta1</code> custom resource definitions is <code>v1beta1</code>.</p></p></div></div><p>API servers send the first <code>ConversionReview</code> version in the <code>conversionReviewVersions</code> list they support.
If none of the versions in the list are supported by the API server, the custom resource definition will not be allowed to be created.
If an API server encounters a conversion webhook configuration that was previously created and does not support any of the <code>ConversionReview</code>
versions the API server knows how to send, attempts to call to the webhook will fail.</p><p>This example shows the data contained in an <code>ConversionReview</code> object
for a request to convert <code>CronTab</code> objects to <code>example.com/v1</code>:</p><ul class="nav nav-tabs" id="conversionreview-request" role="tablist"><li class="nav-item"><a data-toggle="tab" class="nav-link active" href="#conversionreview-request-0" role="tab" aria-controls="conversionreview-request-0" aria-selected="true">apiextensions.k8s.io/v1</a></li><li class="nav-item"><a data-toggle="tab" class="nav-link" href="#conversionreview-request-1" role="tab" aria-controls="conversionreview-request-1">apiextensions.k8s.io/v1beta1</a></li></ul><div class="tab-content" id="conversionreview-request"><div id="conversionreview-request-0" class="tab-pane show active" role="tabpanel" aria-labelledby="conversionreview-request-0"><p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">"apiVersion": </span><span style="color:#b44">"apiextensions.k8s.io/v1"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">"kind": </span><span style="color:#b44">"ConversionReview"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">"request": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># Random uid uniquely identifying this conversion call</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"uid": </span><span style="color:#b44">"705ab4f5-6393-11e8-b7cc-42010a800002"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># The API group and version the objects should be converted to</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"desiredAPIVersion": </span><span style="color:#b44">"example.com/v1"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># The list of objects to convert.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># May contain one or more objects, in one or more versions.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"objects": </span>[<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"kind": </span><span style="color:#b44">"CronTab"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"apiVersion": </span><span style="color:#b44">"example.com/v1beta1"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"metadata": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"creationTimestamp": </span><span style="color:#b44">"2019-09-04T14:03:02Z"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"name": </span><span style="color:#b44">"local-crontab"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"namespace": </span><span style="color:#b44">"default"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"resourceVersion": </span><span style="color:#b44">"143"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"uid": </span><span style="color:#b44">"3415a7fc-162b-4300-b5da-fd6083580d66"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"hostPort": </span><span style="color:#b44">"localhost:1234"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"kind": </span><span style="color:#b44">"CronTab"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"apiVersion": </span><span style="color:#b44">"example.com/v1beta1"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"metadata": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"creationTimestamp": </span><span style="color:#b44">"2019-09-03T13:02:01Z"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"name": </span><span style="color:#b44">"remote-crontab"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"resourceVersion": </span><span style="color:#b44">"12893"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"uid": </span><span style="color:#b44">"359a83ec-b575-460d-b553-d859cedde8a0"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"hostPort": </span><span style="color:#b44">"example.com:2345"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>}<span style="color:#bbb">
</span></span></span></code></pre></div></p></div><div id="conversionreview-request-1" class="tab-pane" role="tabpanel" aria-labelledby="conversionreview-request-1"><p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># Deprecated in v1.16 in favor of apiextensions.k8s.io/v1</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">"apiVersion": </span><span style="color:#b44">"apiextensions.k8s.io/v1beta1"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">"kind": </span><span style="color:#b44">"ConversionReview"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">"request": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># Random uid uniquely identifying this conversion call</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"uid": </span><span style="color:#b44">"705ab4f5-6393-11e8-b7cc-42010a800002"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># The API group and version the objects should be converted to</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"desiredAPIVersion": </span><span style="color:#b44">"example.com/v1"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># The list of objects to convert.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># May contain one or more objects, in one or more versions.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"objects": </span>[<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"kind": </span><span style="color:#b44">"CronTab"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"apiVersion": </span><span style="color:#b44">"example.com/v1beta1"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"metadata": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"creationTimestamp": </span><span style="color:#b44">"2019-09-04T14:03:02Z"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"name": </span><span style="color:#b44">"local-crontab"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"namespace": </span><span style="color:#b44">"default"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"resourceVersion": </span><span style="color:#b44">"143"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"uid": </span><span style="color:#b44">"3415a7fc-162b-4300-b5da-fd6083580d66"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"hostPort": </span><span style="color:#b44">"localhost:1234"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"kind": </span><span style="color:#b44">"CronTab"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"apiVersion": </span><span style="color:#b44">"example.com/v1beta1"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"metadata": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"creationTimestamp": </span><span style="color:#b44">"2019-09-03T13:02:01Z"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"name": </span><span style="color:#b44">"remote-crontab"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"resourceVersion": </span><span style="color:#b44">"12893"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"uid": </span><span style="color:#b44">"359a83ec-b575-460d-b553-d859cedde8a0"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"hostPort": </span><span style="color:#b44">"example.com:2345"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>}<span style="color:#bbb">
</span></span></span></code></pre></div></p></div></div><h3 id="response">Response</h3><p>Webhooks respond with a 200 HTTP status code, <code>Content-Type: application/json</code>,
and a body containing a <code>ConversionReview</code> object (in the same version they were sent),
with the <code>response</code> stanza populated, serialized to JSON.</p><p>If conversion succeeds, a webhook should return a <code>response</code> stanza containing the following fields:</p><ul><li><code>uid</code>, copied from the <code>request.uid</code> sent to the webhook</li><li><code>result</code>, set to <code>{"status":"Success"}</code></li><li><code>convertedObjects</code>, containing all of the objects from <code>request.objects</code>, converted to <code>request.desiredAPIVersion</code></li></ul><p>Example of a minimal successful response from a webhook:</p><ul class="nav nav-tabs" id="conversionreview-response-success" role="tablist"><li class="nav-item"><a data-toggle="tab" class="nav-link active" href="#conversionreview-response-success-0" role="tab" aria-controls="conversionreview-response-success-0" aria-selected="true">apiextensions.k8s.io/v1</a></li><li class="nav-item"><a data-toggle="tab" class="nav-link" href="#conversionreview-response-success-1" role="tab" aria-controls="conversionreview-response-success-1">apiextensions.k8s.io/v1beta1</a></li></ul><div class="tab-content" id="conversionreview-response-success"><div id="conversionreview-response-success-0" class="tab-pane show active" role="tabpanel" aria-labelledby="conversionreview-response-success-0"><p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">"apiVersion": </span><span style="color:#b44">"apiextensions.k8s.io/v1"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">"kind": </span><span style="color:#b44">"ConversionReview"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">"response": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># must match &lt;request.uid&gt;</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"uid": </span><span style="color:#b44">"705ab4f5-6393-11e8-b7cc-42010a800002"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"result": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"status": </span><span style="color:#b44">"Success"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># Objects must match the order of request.objects, and have apiVersion set to &lt;request.desiredAPIVersion&gt;.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># kind, metadata.uid, metadata.name, and metadata.namespace fields must not be changed by the webhook.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># metadata.labels and metadata.annotations fields may be changed by the webhook.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># All other changes to metadata fields by the webhook are ignored.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"convertedObjects": </span>[<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"kind": </span><span style="color:#b44">"CronTab"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"apiVersion": </span><span style="color:#b44">"example.com/v1"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"metadata": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"creationTimestamp": </span><span style="color:#b44">"2019-09-04T14:03:02Z"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"name": </span><span style="color:#b44">"local-crontab"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"namespace": </span><span style="color:#b44">"default"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"resourceVersion": </span><span style="color:#b44">"143"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"uid": </span><span style="color:#b44">"3415a7fc-162b-4300-b5da-fd6083580d66"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"host": </span><span style="color:#b44">"localhost"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"port": </span><span style="color:#b44">"1234"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"kind": </span><span style="color:#b44">"CronTab"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"apiVersion": </span><span style="color:#b44">"example.com/v1"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"metadata": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"creationTimestamp": </span><span style="color:#b44">"2019-09-03T13:02:01Z"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"name": </span><span style="color:#b44">"remote-crontab"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"resourceVersion": </span><span style="color:#b44">"12893"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"uid": </span><span style="color:#b44">"359a83ec-b575-460d-b553-d859cedde8a0"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"host": </span><span style="color:#b44">"example.com"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"port": </span><span style="color:#b44">"2345"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>}<span style="color:#bbb">
</span></span></span></code></pre></div></p></div><div id="conversionreview-response-success-1" class="tab-pane" role="tabpanel" aria-labelledby="conversionreview-response-success-1"><p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># Deprecated in v1.16 in favor of apiextensions.k8s.io/v1</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">"apiVersion": </span><span style="color:#b44">"apiextensions.k8s.io/v1beta1"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">"kind": </span><span style="color:#b44">"ConversionReview"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">"response": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># must match &lt;request.uid&gt;</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"uid": </span><span style="color:#b44">"705ab4f5-6393-11e8-b7cc-42010a800002"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"result": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"status": </span><span style="color:#b44">"Failed"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># Objects must match the order of request.objects, and have apiVersion set to &lt;request.desiredAPIVersion&gt;.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># kind, metadata.uid, metadata.name, and metadata.namespace fields must not be changed by the webhook.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># metadata.labels and metadata.annotations fields may be changed by the webhook.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># All other changes to metadata fields by the webhook are ignored.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"convertedObjects": </span>[<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"kind": </span><span style="color:#b44">"CronTab"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"apiVersion": </span><span style="color:#b44">"example.com/v1"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"metadata": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"creationTimestamp": </span><span style="color:#b44">"2019-09-04T14:03:02Z"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"name": </span><span style="color:#b44">"local-crontab"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"namespace": </span><span style="color:#b44">"default"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"resourceVersion": </span><span style="color:#b44">"143"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"uid": </span><span style="color:#b44">"3415a7fc-162b-4300-b5da-fd6083580d66"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"host": </span><span style="color:#b44">"localhost"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"port": </span><span style="color:#b44">"1234"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"kind": </span><span style="color:#b44">"CronTab"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"apiVersion": </span><span style="color:#b44">"example.com/v1"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"metadata": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"creationTimestamp": </span><span style="color:#b44">"2019-09-03T13:02:01Z"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"name": </span><span style="color:#b44">"remote-crontab"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"resourceVersion": </span><span style="color:#b44">"12893"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">"uid": </span><span style="color:#b44">"359a83ec-b575-460d-b553-d859cedde8a0"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"host": </span><span style="color:#b44">"example.com"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"port": </span><span style="color:#b44">"2345"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>}<span style="color:#bbb">
</span></span></span></code></pre></div></p></div></div><p>If conversion fails, a webhook should return a <code>response</code> stanza containing the following fields:</p><ul><li><code>uid</code>, copied from the <code>request.uid</code> sent to the webhook</li><li><code>result</code>, set to <code>{"status":"Failed"}</code></li></ul><div class="alert alert-danger" role="alert"><h4 class="alert-heading">Warning:</h4>Failing conversion can disrupt read and write access to the custom resources,
including the ability to update or delete the resources. Conversion failures
should be avoided whenever possible, and should not be used to enforce validation
constraints (use validation schemas or webhook admission instead).</div><p>Example of a response from a webhook indicating a conversion request failed, with an optional message:<ul class="nav nav-tabs" id="conversionreview-response-failure" role="tablist"><li class="nav-item"><a data-toggle="tab" class="nav-link active" href="#conversionreview-response-failure-0" role="tab" aria-controls="conversionreview-response-failure-0" aria-selected="true">apiextensions.k8s.io/v1</a></li><li class="nav-item"><a data-toggle="tab" class="nav-link" href="#conversionreview-response-failure-1" role="tab" aria-controls="conversionreview-response-failure-1">apiextensions.k8s.io/v1beta1</a></li></ul><div class="tab-content" id="conversionreview-response-failure"><div id="conversionreview-response-failure-0" class="tab-pane show active" role="tabpanel" aria-labelledby="conversionreview-response-failure-0"><p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">"apiVersion": </span><span style="color:#b44">"apiextensions.k8s.io/v1"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">"kind": </span><span style="color:#b44">"ConversionReview"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">"response": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"uid": </span><span style="color:#b44">"&lt;value from request.uid&gt;"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"result": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"status": </span><span style="color:#b44">"Failed"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"message": </span><span style="color:#b44">"hostPort could not be parsed into a separate host and port"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>}<span style="color:#bbb">
</span></span></span></code></pre></div></p></div><div id="conversionreview-response-failure-1" class="tab-pane" role="tabpanel" aria-labelledby="conversionreview-response-failure-1"><p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># Deprecated in v1.16 in favor of apiextensions.k8s.io/v1</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">"apiVersion": </span><span style="color:#b44">"apiextensions.k8s.io/v1beta1"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">"kind": </span><span style="color:#b44">"ConversionReview"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">"response": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"uid": </span><span style="color:#b44">"&lt;value from request.uid&gt;"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"result": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"status": </span><span style="color:#b44">"Failed"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"message": </span><span style="color:#b44">"hostPort could not be parsed into a separate host and port"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>}<span style="color:#bbb">
</span></span></span></code></pre></div></p></div></div></p><h2 id="writing-reading-and-updating-versioned-customresourcedefinition-objects">Writing, reading, and updating versioned CustomResourceDefinition objects</h2><p>When an object is written, it is stored at the version designated as the
storage version at the time of the write. If the storage version changes,
existing objects are never converted automatically. However, newly-created
or updated objects are written at the new storage version. It is possible for an
object to have been written at a version that is no longer served.</p><p>When you read an object, you specify the version as part of the path.
You can request an object at any version that is currently served.
If you specify a version that is different from the object's stored version,
Kubernetes returns the object to you at the version you requested, but the
stored object is not changed on disk.</p><p>What happens to the object that is being returned while serving the read
request depends on what is specified in the CRD's <code>spec.conversion</code>:</p><ul><li>if the default <code>strategy</code> value <code>None</code> is specified, the only modifications
to the object are changing the <code>apiVersion</code> string and perhaps <a href="/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/#field-pruning">pruning
unknown fields</a>
(depending on the configuration). Note that this is unlikely to lead to good
results if the schemas differ between the storage and requested version.
In particular, you should not use this strategy if the same data is
represented in different fields between versions.</li><li>if <a href="#webhook-conversion">webhook conversion</a> is specified, then this
mechanism controls the conversion.</li></ul><p>If you update an existing object, it is rewritten at the version that is
currently the storage version. This is the only way that objects can change from
one version to another.</p><p>To illustrate this, consider the following hypothetical series of events:</p><ol><li>The storage version is <code>v1beta1</code>. You create an object. It is stored at version <code>v1beta1</code></li><li>You add version <code>v1</code> to your CustomResourceDefinition and designate it as
the storage version. Here the schemas for <code>v1</code> and <code>v1beta1</code> are identical,
which is typically the case when promoting an API to stable in the
Kubernetes ecosystem.</li><li>You read your object at version <code>v1beta1</code>, then you read the object again at
version <code>v1</code>. Both returned objects are identical except for the apiVersion
field.</li><li>You create a new object. It is stored at version <code>v1</code>. You now
have two objects, one of which is at <code>v1beta1</code>, and the other of which is at
<code>v1</code>.</li><li>You update the first object. It is now stored at version <code>v1</code> since that
is the current storage version.</li></ol><h3 id="previous-storage-versions">Previous storage versions</h3><p>The API server records each version which has ever been marked as the storage
version in the status field <code>storedVersions</code>. Objects may have been stored
at any version that has ever been designated as a storage version. No objects
can exist in storage at a version that has never been a storage version.</p><h2 id="upgrade-existing-objects-to-a-new-stored-version">Upgrade existing objects to a new stored version</h2><p>When deprecating versions and dropping support, select a storage upgrade
procedure.</p><p><em>Option 1:</em> Use the Storage Version Migrator</p><ol><li>Run the <a href="https://github.com/kubernetes-sigs/kube-storage-version-migrator">storage Version migrator</a></li><li>Remove the old version from the CustomResourceDefinition <code>status.storedVersions</code> field.</li></ol><p><em>Option 2:</em> Manually upgrade the existing objects to a new stored version</p><p>The following is an example procedure to upgrade from <code>v1beta1</code> to <code>v1</code>.</p><ol><li>Set <code>v1</code> as the storage in the CustomResourceDefinition file and apply it
using kubectl. The <code>storedVersions</code> is now <code>v1beta1, v1</code>.</li><li>Write an upgrade procedure to list all existing objects and write them with
the same content. This forces the backend to write objects in the current
storage version, which is <code>v1</code>.</li><li>Remove <code>v1beta1</code> from the CustomResourceDefinition <code>status.storedVersions</code> field.</li></ol><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4><p>Here is an example of how to patch the <code>status</code> subresource for a CRD object using <code>kubectl</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl patch customresourcedefinitions &lt;CRD_Name&gt; --subresource<span style="color:#666">=</span><span style="color:#b44">'status'</span> --type<span style="color:#666">=</span><span style="color:#b44">'merge'</span> -p <span style="color:#b44">'{"status":{"storedVersions":["v1"]}}'</span>
</span></span></code></pre></div></div></div>
<hr>
<div class="td-content"><h1 data-pagefind-weight="10">Configure Multiple Schedulers</h1><p>Kubernetes ships with a default scheduler that is described
<a href="/docs/reference/command-line-tools-reference/kube-scheduler/">here</a>.
If the default scheduler does not suit your needs you can implement your own scheduler.
Moreover, you can even run multiple schedulers simultaneously alongside the default
scheduler and instruct Kubernetes what scheduler to use for each of your pods. Let's
learn how to run multiple schedulers in Kubernetes with an example.</p><p>A detailed description of how to implement a scheduler is outside the scope of this
document. Please refer to the kube-scheduler implementation in
<a href="https://github.com/kubernetes/kubernetes/tree/master/pkg/scheduler">pkg/scheduler</a>
in the Kubernetes source directory for a canonical example.</p><h2 id="before-you-begin">Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul><p>To check the version, enter <code>kubectl version</code>.</p></p><h2 id="package-the-scheduler">Package the scheduler</h2><p>Package your scheduler binary into a container image. For the purposes of this example,
you can use the default scheduler (kube-scheduler) as your second scheduler.
Clone the <a href="https://github.com/kubernetes/kubernetes">Kubernetes source code from GitHub</a>
and build the source.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>git clone https://github.com/kubernetes/kubernetes.git
</span></span><span style="display:flex"><span><span style="color:#a2f">cd</span> kubernetes
</span></span><span style="display:flex"><span>make
</span></span></code></pre></div><p>Create a container image containing the kube-scheduler binary. Here is the <code>Dockerfile</code>
to build the image:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-docker" data-lang="docker"><span style="display:flex"><span><span style="color:#a2f;font-weight:700">FROM</span><span style="color:#b44"> busybox</span><span>
</span></span></span><span style="display:flex"><span><span/><span style="color:#a2f;font-weight:700">ADD</span> ./_output/local/bin/linux/amd64/kube-scheduler /usr/local/bin/kube-scheduler<span>
</span></span></span></code></pre></div><p>Save the file as <code>Dockerfile</code>, build the image and push it to a registry. This example
pushes the image to
<a href="https://cloud.google.com/container-registry/">Google Container Registry (GCR)</a>.
For more details, please read the GCR
<a href="https://cloud.google.com/container-registry/docs/">documentation</a>. Alternatively
you can also use the <a href="https://hub.docker.com/search?q=">docker hub</a>. For more details
refer to the docker hub <a href="https://docs.docker.com/docker-hub/repos/create/#create-a-repository">documentation</a>.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>docker build -t gcr.io/my-gcp-project/my-kube-scheduler:1.0 .     <span style="color:#080;font-style:italic"># The image name and the repository</span>
</span></span><span style="display:flex"><span>gcloud docker -- push gcr.io/my-gcp-project/my-kube-scheduler:1.0 <span style="color:#080;font-style:italic"># used in here is just an example</span>
</span></span></code></pre></div><h2 id="define-a-kubernetes-deployment-for-the-scheduler">Define a Kubernetes Deployment for the scheduler</h2><p>Now that you have your scheduler in a container image, create a pod
configuration for it and run it in your Kubernetes cluster. But instead of creating a pod
directly in the cluster, you can use a <a href="/docs/concepts/workloads/controllers/deployment/">Deployment</a>
for this example. A <a href="/docs/concepts/workloads/controllers/deployment/">Deployment</a> manages a
<a href="/docs/concepts/workloads/controllers/replicaset/">Replica Set</a> which in turn manages the pods,
thereby making the scheduler resilient to failures. Here is the deployment
config. Save it as <code>my-scheduler.yaml</code>:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/sched/my-scheduler.yaml" download="admin/sched/my-scheduler.yaml"><code>admin/sched/my-scheduler.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;admin-sched-my-scheduler-yaml&quot;)" title="Copy admin/sched/my-scheduler.yaml to clipboard"/></div><div class="includecode" id="admin-sched-my-scheduler-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ServiceAccount<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-scheduler<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>kube-system<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#00f;font-weight:700">---</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>rbac.authorization.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ClusterRoleBinding<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-scheduler-as-kube-scheduler<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">subjects</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ServiceAccount<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-scheduler<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>kube-system<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">roleRef</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ClusterRole<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>system:kube-scheduler<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">apiGroup</span>:<span style="color:#bbb"> </span>rbac.authorization.k8s.io<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#00f;font-weight:700">---</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>rbac.authorization.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ClusterRoleBinding<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-scheduler-as-volume-scheduler<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">subjects</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ServiceAccount<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-scheduler<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>kube-system<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">roleRef</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ClusterRole<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>system:volume-scheduler<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">apiGroup</span>:<span style="color:#bbb"> </span>rbac.authorization.k8s.io<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#00f;font-weight:700">---</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>rbac.authorization.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>RoleBinding<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-scheduler-extension-apiserver-authentication-reader<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>kube-system<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">roleRef</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Role<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>extension-apiserver-authentication-reader<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">apiGroup</span>:<span style="color:#bbb"> </span>rbac.authorization.k8s.io<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">subjects</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ServiceAccount<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-scheduler<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>kube-system<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#00f;font-weight:700">---</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ConfigMap<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-scheduler-config<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>kube-system<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">data</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">my-scheduler-config.yaml</span>:<span style="color:#bbb"> </span>|<span style="color:#b44;font-style:italic">
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">    apiVersion: kubescheduler.config.k8s.io/v1
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">    kind: KubeSchedulerConfiguration
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">    profiles:
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">      - schedulerName: my-scheduler
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">    leaderElection:
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">      leaderElect: false</span><span style="color:#bbb">    
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#00f;font-weight:700">---</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">component</span>:<span style="color:#bbb"> </span>scheduler<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">tier</span>:<span style="color:#bbb"> </span>control-plane<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-scheduler<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>kube-system<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">component</span>:<span style="color:#bbb"> </span>scheduler<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">tier</span>:<span style="color:#bbb"> </span>control-plane<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">component</span>:<span style="color:#bbb"> </span>scheduler<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">tier</span>:<span style="color:#bbb"> </span>control-plane<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">version</span>:<span style="color:#bbb"> </span>second<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">serviceAccountName</span>:<span style="color:#bbb"> </span>my-scheduler<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">command</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- /usr/local/bin/kube-scheduler<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- --config=/etc/kubernetes/my-scheduler/my-scheduler-config.yaml<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>gcr.io/my-gcp-project/my-kube-scheduler:1.0<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">livenessProbe</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">httpGet</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">path</span>:<span style="color:#bbb"> </span>/healthz<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">port</span>:<span style="color:#bbb"> </span><span style="color:#666">10259</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">scheme</span>:<span style="color:#bbb"> </span>HTTPS<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">initialDelaySeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">15</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>kube-second-scheduler<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">readinessProbe</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">httpGet</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">path</span>:<span style="color:#bbb"> </span>/healthz<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">port</span>:<span style="color:#bbb"> </span><span style="color:#666">10259</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">scheme</span>:<span style="color:#bbb"> </span>HTTPS<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">requests</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">cpu</span>:<span style="color:#bbb"> </span><span style="color:#b44">'0.1'</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">securityContext</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">privileged</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">false</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">volumeMounts</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>config-volume<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span>/etc/kubernetes/my-scheduler<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">hostNetwork</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">false</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">hostPID</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">false</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>config-volume<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">configMap</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-scheduler-config<span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>In the above manifest, you use a <a href="/docs/reference/scheduling/config/">KubeSchedulerConfiguration</a>
to customize the behavior of your scheduler implementation. This configuration has been passed to
the <code>kube-scheduler</code> during initialization with the <code>--config</code> option. The <code>my-scheduler-config</code> ConfigMap stores the configuration file. The Pod of the<code>my-scheduler</code> Deployment mounts the <code>my-scheduler-config</code> ConfigMap as a volume.</p><p>In the aforementioned Scheduler Configuration, your scheduler implementation is represented via
a <a href="/docs/reference/config-api/kube-scheduler-config.v1/#kubescheduler-config-k8s-io-v1-KubeSchedulerProfile">KubeSchedulerProfile</a>.<div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>To determine if a scheduler is responsible for scheduling a specific Pod, the <code>spec.schedulerName</code> field in a
PodTemplate or Pod manifest must match the <code>schedulerName</code> field of the <code>KubeSchedulerProfile</code>.
All schedulers running in the cluster must have unique names.</div></p><p>Also, note that you create a dedicated service account <code>my-scheduler</code> and bind the ClusterRole
<code>system:kube-scheduler</code> to it so that it can acquire the same privileges as <code>kube-scheduler</code>.</p><p>Please see the
<a href="/docs/reference/command-line-tools-reference/kube-scheduler/">kube-scheduler documentation</a> for
detailed description of other command line arguments and
<a href="/docs/reference/config-api/kube-scheduler-config.v1/">Scheduler Configuration reference</a> for
detailed description of other customizable <code>kube-scheduler</code> configurations.</p><h2 id="run-the-second-scheduler-in-the-cluster">Run the second scheduler in the cluster</h2><p>In order to run your scheduler in a Kubernetes cluster, create the deployment
specified in the config above in a Kubernetes cluster:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl create -f my-scheduler.yaml
</span></span></code></pre></div><p>Verify that the scheduler pod is running:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pods --namespace<span style="color:#666">=</span>kube-system
</span></span></code></pre></div><pre tabindex="0"><code>NAME                                           READY     STATUS    RESTARTS   AGE
....
my-scheduler-lnf4s-4744f                       1/1       Running   0          2m
...
</code></pre><p>You should see a "Running" my-scheduler pod, in addition to the default kube-scheduler
pod in this list.</p><h3 id="enable-leader-election">Enable leader election</h3><p>To run multiple-scheduler with leader election enabled, you must do the following:</p><p>Update the following fields for the KubeSchedulerConfiguration in the <code>my-scheduler-config</code> ConfigMap in your YAML file:</p><ul><li><code>leaderElection.leaderElect</code> to <code>true</code></li><li><code>leaderElection.resourceNamespace</code> to <code>&lt;lock-object-namespace&gt;</code></li><li><code>leaderElection.resourceName</code> to <code>&lt;lock-object-name&gt;</code></li></ul><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>The control plane creates the lock objects for you, but the namespace must already exist.
You can use the <code>kube-system</code> namespace.</div><p>If RBAC is enabled on your cluster, you must update the <code>system:kube-scheduler</code> cluster role.
Add your scheduler name to the resourceNames of the rule applied for <code>endpoints</code> and <code>leases</code> resources, as in the following example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl edit clusterrole system:kube-scheduler
</span></span></code></pre></div><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/sched/clusterrole.yaml" download="admin/sched/clusterrole.yaml"><code>admin/sched/clusterrole.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;admin-sched-clusterrole-yaml&quot;)" title="Copy admin/sched/clusterrole.yaml to clipboard"/></div><div class="includecode" id="admin-sched-clusterrole-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>rbac.authorization.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ClusterRole<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">annotations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">rbac.authorization.kubernetes.io/autoupdate</span>:<span style="color:#bbb"> </span><span style="color:#b44">"true"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kubernetes.io/bootstrapping</span>:<span style="color:#bbb"> </span>rbac-defaults<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>system:kube-scheduler<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">rules</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">apiGroups</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- coordination.k8s.io<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- leases<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">verbs</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- create<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">apiGroups</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- coordination.k8s.io<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">resourceNames</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- kube-scheduler<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- my-scheduler<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- leases<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">verbs</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- get<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- update<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">apiGroups</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:#b44">""</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">resourceNames</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- kube-scheduler<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- my-scheduler<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- endpoints<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">verbs</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- delete<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- get<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- patch<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- update<span style="color:#bbb">
</span></span></span></code></pre></div></div></div><h2 id="specify-schedulers-for-pods">Specify schedulers for pods</h2><p>Now that your second scheduler is running, create some pods, and direct them
to be scheduled by either the default scheduler or the one you deployed.
In order to schedule a given pod using a specific scheduler, specify the name of the
scheduler in that pod spec. Let's look at three examples.</p><ul><li><p>Pod spec without any scheduler name</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/sched/pod1.yaml" download="admin/sched/pod1.yaml"><code>admin/sched/pod1.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;admin-sched-pod1-yaml&quot;)" title="Copy admin/sched/pod1.yaml to clipboard"/></div><div class="includecode" id="admin-sched-pod1-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Pod<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">no</span>-annotation<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>multischeduler-example<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>pod-with-no-annotation-container<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>registry.k8s.io/pause:3.8</span></span></code></pre></div></div></div><p>When no scheduler name is supplied, the pod is automatically scheduled using the
default-scheduler.</p><p>Save this file as <code>pod1.yaml</code> and submit it to the Kubernetes cluster.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl create -f pod1.yaml
</span></span></code></pre></div></li><li><p>Pod spec with <code>default-scheduler</code></p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/sched/pod2.yaml" download="admin/sched/pod2.yaml"><code>admin/sched/pod2.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;admin-sched-pod2-yaml&quot;)" title="Copy admin/sched/pod2.yaml to clipboard"/></div><div class="includecode" id="admin-sched-pod2-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Pod<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>annotation-default-scheduler<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>multischeduler-example<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">schedulerName</span>:<span style="color:#bbb"> </span>default-scheduler<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>pod-with-default-annotation-container<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>registry.k8s.io/pause:3.8<span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>A scheduler is specified by supplying the scheduler name as a value to <code>spec.schedulerName</code>. In this case, we supply the name of the
default scheduler which is <code>default-scheduler</code>.</p><p>Save this file as <code>pod2.yaml</code> and submit it to the Kubernetes cluster.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl create -f pod2.yaml
</span></span></code></pre></div></li><li><p>Pod spec with <code>my-scheduler</code></p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/sched/pod3.yaml" download="admin/sched/pod3.yaml"><code>admin/sched/pod3.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;admin-sched-pod3-yaml&quot;)" title="Copy admin/sched/pod3.yaml to clipboard"/></div><div class="includecode" id="admin-sched-pod3-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Pod<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>annotation-second-scheduler<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>multischeduler-example<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">schedulerName</span>:<span style="color:#bbb"> </span>my-scheduler<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>pod-with-second-annotation-container<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>registry.k8s.io/pause:3.8<span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>In this case, we specify that this pod should be scheduled using the scheduler that we
deployed - <code>my-scheduler</code>. Note that the value of <code>spec.schedulerName</code> should match the name supplied for the scheduler
in the <code>schedulerName</code> field of the mapping <code>KubeSchedulerProfile</code>.</p><p>Save this file as <code>pod3.yaml</code> and submit it to the Kubernetes cluster.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl create -f pod3.yaml
</span></span></code></pre></div><p>Verify that all three pods are running.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pods
</span></span></code></pre></div></li></ul><h3 id="verifying-that-the-pods-were-scheduled-using-the-desired-schedulers">Verifying that the pods were scheduled using the desired schedulers</h3><p>In order to make it easier to work through these examples, we did not verify that the
pods were actually scheduled using the desired schedulers. We can verify that by
changing the order of pod and deployment config submissions above. If we submit all the
pod configs to a Kubernetes cluster before submitting the scheduler deployment config,
we see that the pod <code>annotation-second-scheduler</code> remains in "Pending" state forever
while the other two pods get scheduled. Once we submit the scheduler deployment config
and our new scheduler starts running, the <code>annotation-second-scheduler</code> pod gets
scheduled as well.</p><p>Alternatively, you can look at the "Scheduled" entries in the event logs to
verify that the pods were scheduled by the desired schedulers.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get events
</span></span></code></pre></div><p>You can also use a <a href="/docs/reference/scheduling/config/#multiple-profiles">custom scheduler configuration</a>
or a custom container image for the cluster's main scheduler by modifying its static pod manifest
on the relevant control plane nodes.</p></div>
<hr>
<div class="td-content"><h1>Use Custom Resources</h1><div class="section-index"><hr class="panel-line"/><div class="entry"><h5><a href="/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/">Extend the Kubernetes API with CustomResourceDefinitions</a></h5><p/></div><div class="entry"><h5><a href="/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definition-versioning/">Versions in CustomResourceDefinitions</a></h5><p/></div></div></div>
<hr>
<div class="td-content"><h1 data-pagefind-weight="10">Set up an Extension API Server</h1><p>Setting up an extension API server to work with the aggregation layer allows the Kubernetes apiserver to be extended with additional APIs, which are not part of the core Kubernetes APIs.</p><h2 id="before-you-begin">Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul><p>To check the version, enter <code>kubectl version</code>.</p></p><ul><li>You must <a href="/docs/tasks/extend-kubernetes/configure-aggregation-layer/">configure the aggregation layer</a> and enable the apiserver flags.</li></ul><h2 id="set-up-an-extension-api-server-to-work-with-the-aggregation-layer">Set up an extension api-server to work with the aggregation layer</h2><p>The following steps describe how to set up an extension-apiserver <em>at a high level</em>. These steps apply regardless if you're using YAML configs or using APIs. An attempt is made to specifically identify any differences between the two. For a concrete example of how they can be implemented using YAML configs, you can look at the <a href="https://github.com/kubernetes/sample-apiserver/blob/master/README.md">sample-apiserver</a> in the Kubernetes repo.</p><p>Alternatively, you can use an existing 3rd party solution, such as <a href="https://github.com/kubernetes-sigs/apiserver-builder-alpha/blob/master/README.md">apiserver-builder</a>, which should generate a skeleton and automate all of the following steps for you.</p><ol><li>Make sure the APIService API is enabled (check <code>--runtime-config</code>). It should be on by default, unless it's been deliberately turned off in your cluster.</li><li>You may need to make an RBAC rule allowing you to add APIService objects, or get your cluster administrator to make one. (Since API extensions affect the entire cluster, it is not recommended to do testing/development/debug of an API extension in a live cluster.)</li><li>Create the Kubernetes namespace you want to run your extension api-service in.</li><li>Create/get a CA cert to be used to sign the server cert the extension api-server uses for HTTPS.</li><li>Create a server cert/key for the api-server to use for HTTPS. This cert should be signed by the above CA. It should also have a CN of the Kube DNS name. This is derived from the Kubernetes service and be of the form <code>&lt;service name&gt;.&lt;service name namespace&gt;.svc</code></li><li>Create a Kubernetes secret with the server cert/key in your namespace.</li><li>Create a Kubernetes deployment for the extension api-server and make sure you are loading the secret as a volume. It should contain a reference to a working image of your extension api-server. The deployment should also be in your namespace.</li><li>Make sure that your extension-apiserver loads those certs from that volume and that they are used in the HTTPS handshake.</li><li>Create a Kubernetes service account in your namespace.</li><li>Create a Kubernetes cluster role for the operations you want to allow on your resources.</li><li>Create a Kubernetes cluster role binding from the service account in your namespace to the cluster role you created.</li><li>Create a Kubernetes cluster role binding from the service account in your namespace to the <code>system:auth-delegator</code> cluster role to delegate auth decisions to the Kubernetes core API server.</li><li>Create a Kubernetes role binding from the service account in your namespace to the <code>extension-apiserver-authentication-reader</code> role. This allows your extension api-server to access the <code>extension-apiserver-authentication</code> configmap.</li><li>Create a Kubernetes apiservice. The CA cert above should be base64 encoded, stripped of new lines and used as the spec.caBundle in the apiservice. This should not be namespaced. If using the <a href="https://github.com/kubernetes/kube-aggregator/">kube-aggregator API</a>, only pass in the PEM encoded CA bundle because the base 64 encoding is done for you.</li><li>Use kubectl to get your resource. When run, kubectl should return "No resources found.". This message
indicates that everything worked but you currently have no objects of that resource type created.</li></ol><h2 id="what-s-next">What's next</h2><ul><li>Walk through the steps to <a href="/docs/tasks/extend-kubernetes/configure-aggregation-layer/">configure the API aggregation layer</a> and enable the apiserver flags.</li><li>For a high level overview, see <a href="/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/">Extending the Kubernetes API with the aggregation layer</a>.</li><li>Learn how to <a href="/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/">Extend the Kubernetes API using Custom Resource Definitions</a>.</li></ul></div>
<hr>
<div class="td-content"><h1 data-pagefind-weight="10">Configure the Aggregation Layer</h1><p>Configuring the <a href="/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/">aggregation layer</a>
allows the Kubernetes apiserver to be extended with additional APIs, which are not
part of the core Kubernetes APIs.</p><h2 id="before-you-begin">Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul><p>To check the version, enter <code>kubectl version</code>.</p></p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>There are a few setup requirements for getting the aggregation layer working in
your environment to support mutual TLS auth between the proxy and extension apiservers.
Kubernetes and the kube-apiserver have multiple CAs, so make sure that the proxy is
signed by the aggregation layer CA and not by something else, like the Kubernetes general CA.</div><div class="alert alert-caution" role="alert"><h4 class="alert-heading">Caution:</h4>Reusing the same CA for different client types can negatively impact the cluster's
ability to function. For more information, see <a href="#ca-reusage-and-conflicts">CA Reusage and Conflicts</a>.</div><h2 id="authentication-flow">Authentication Flow</h2><p>Unlike Custom Resource Definitions (CRDs), the Aggregation API involves
another server - your Extension apiserver - in addition to the standard Kubernetes apiserver.
The Kubernetes apiserver will need to communicate with your extension apiserver,
and your extension apiserver will need to communicate with the Kubernetes apiserver.
In order for this communication to be secured, the Kubernetes apiserver uses x509
certificates to authenticate itself to the extension apiserver.</p><p>This section describes how the authentication and authorization flows work,
and how to configure them.</p><p>The high-level flow is as follows:</p><ol><li>Kubernetes apiserver: authenticate the requesting user and authorize their
rights to the requested API path.</li><li>Kubernetes apiserver: proxy the request to the extension apiserver</li><li>Extension apiserver: authenticate the request from the Kubernetes apiserver</li><li>Extension apiserver: authorize the request from the original user</li><li>Extension apiserver: execute</li></ol><p>The rest of this section describes these steps in detail.</p><p>The flow can be seen in the following diagram.</p><p><img alt="aggregation auth flows" src="/images/docs/aggregation-api-auth-flow.png"/></p><p>The source for the above swimlanes can be found in the source of this document.</p><h3 id="kubernetes-apiserver-authentication-and-authorization">Kubernetes Apiserver Authentication and Authorization</h3><p>A request to an API path that is served by an extension apiserver begins
the same way as all API requests: communication to the Kubernetes apiserver.
This path already has been registered with the Kubernetes apiserver by the extension apiserver.</p><p>The user communicates with the Kubernetes apiserver, requesting access to the path.
The Kubernetes apiserver uses standard authentication and authorization configured
with the Kubernetes apiserver to authenticate the user and authorize access to the specific path.</p><p>For an overview of authenticating to a Kubernetes cluster, see
<a href="/docs/reference/access-authn-authz/authentication/">"Authenticating to a Cluster"</a>.
For an overview of authorization of access to Kubernetes cluster resources, see
<a href="/docs/reference/access-authn-authz/authorization/">"Authorization Overview"</a>.</p><p>Everything to this point has been standard Kubernetes API requests, authentication and authorization.</p><p>The Kubernetes apiserver now is prepared to send the request to the extension apiserver.</p><h3 id="kubernetes-apiserver-proxies-the-request">Kubernetes Apiserver Proxies the Request</h3><p>The Kubernetes apiserver now will send, or proxy, the request to the extension
apiserver that registered to handle the request. In order to do so,
it needs to know several things:</p><ol><li>How should the Kubernetes apiserver authenticate to the extension apiserver,
informing the extension apiserver that the request, which comes over the network,
is coming from a valid Kubernetes apiserver?</li><li>How should the Kubernetes apiserver inform the extension apiserver of the
username and group for which the original request was authenticated?</li></ol><p>In order to provide for these two, you must configure the Kubernetes apiserver using several flags.</p><h4 id="kubernetes-apiserver-client-authentication">Kubernetes Apiserver Client Authentication</h4><p>The Kubernetes apiserver connects to the extension apiserver over TLS,
authenticating itself using a client certificate. You must provide the
following to the Kubernetes apiserver upon startup, using the provided flags:</p><ul><li>private key file via <code>--proxy-client-key-file</code></li><li>signed client certificate file via <code>--proxy-client-cert-file</code></li><li>certificate of the CA that signed the client certificate file via <code>--requestheader-client-ca-file</code></li><li>valid Common Name values (CNs) in the signed client certificate via <code>--requestheader-allowed-names</code></li></ul><p>The Kubernetes apiserver will use the files indicated by <code>--proxy-client-*-file</code>
to authenticate to the extension apiserver. In order for the request to be considered
valid by a compliant extension apiserver, the following conditions must be met:</p><ol><li>The connection must be made using a client certificate that is signed by
the CA whose certificate is in <code>--requestheader-client-ca-file</code>.</li><li>The connection must be made using a client certificate whose CN is one of
those listed in <code>--requestheader-allowed-names</code>.</li></ol><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>You can set this option to blank as <code>--requestheader-allowed-names=""</code>.
This will indicate to an extension apiserver that <em>any</em> CN is acceptable.</div><p>When started with these options, the Kubernetes apiserver will:</p><ol><li>Use them to authenticate to the extension apiserver.</li><li>Create a configmap in the <code>kube-system</code> namespace called <code>extension-apiserver-authentication</code>,
in which it will place the CA certificate and the allowed CNs. These in turn can be retrieved
by extension apiservers to validate requests.</li></ol><p>Note that the same client certificate is used by the Kubernetes apiserver to authenticate
against <em>all</em> extension apiservers. It does not create a client certificate per extension
apiserver, but rather a single one to authenticate as the Kubernetes apiserver.
This same one is reused for all extension apiserver requests.</p><h4 id="original-request-username-and-group">Original Request Username and Group</h4><p>When the Kubernetes apiserver proxies the request to the extension apiserver,
it informs the extension apiserver of the username and group with which the
original request successfully authenticated. It provides these in http headers
of its proxied request. You must inform the Kubernetes apiserver of the names
of the headers to be used.</p><ul><li>the header in which to store the username via <code>--requestheader-username-headers</code></li><li>the header in which to store the group via <code>--requestheader-group-headers</code></li><li>the prefix to append to all extra headers via <code>--requestheader-extra-headers-prefix</code></li></ul><p>These header names are also placed in the <code>extension-apiserver-authentication</code> configmap,
so they can be retrieved and used by extension apiservers.</p><h3 id="extension-apiserver-authenticates-the-request">Extension Apiserver Authenticates the Request</h3><p>The extension apiserver, upon receiving a proxied request from the Kubernetes apiserver,
must validate that the request actually did come from a valid authenticating proxy,
which role the Kubernetes apiserver is fulfilling. The extension apiserver validates it via:</p><ol><li>Retrieve the following from the configmap in <code>kube-system</code>, as described above:<ul><li>Client CA certificate</li><li>List of allowed names (CNs)</li><li>Header names for username, group and extra info</li></ul></li><li>Check that the TLS connection was authenticated using a client certificate which:<ul><li>Was signed by the CA whose certificate matches the retrieved CA certificate.</li><li>Has a CN in the list of allowed CNs, unless the list is blank, in which case all CNs are allowed.</li><li>Extract the username and group from the appropriate headers</li></ul></li></ol><p>If the above passes, then the request is a valid proxied request from a legitimate
authenticating proxy, in this case the Kubernetes apiserver.</p><p>Note that it is the responsibility of the extension apiserver implementation to provide
the above. Many do it by default, leveraging the <code>k8s.io/apiserver/</code> package.
Others may provide options to override it using command-line options.</p><p>In order to have permission to retrieve the configmap, an extension apiserver
requires the appropriate role. There is a default role named <code>extension-apiserver-authentication-reader</code>
in the <code>kube-system</code> namespace which can be assigned.</p><h3 id="extension-apiserver-authorizes-the-request">Extension Apiserver Authorizes the Request</h3><p>The extension apiserver now can validate that the user/group retrieved from
the headers are authorized to execute the given request. It does so by sending
a standard <a href="/docs/reference/access-authn-authz/authorization/">SubjectAccessReview</a>
request to the Kubernetes apiserver.</p><p>In order for the extension apiserver to be authorized itself to submit the
<code>SubjectAccessReview</code> request to the Kubernetes apiserver, it needs the correct permissions.
Kubernetes includes a default <code>ClusterRole</code> named <code>system:auth-delegator</code> that
has the appropriate permissions. It can be granted to the extension apiserver's service account.</p><h3 id="extension-apiserver-executes">Extension Apiserver Executes</h3><p>If the <code>SubjectAccessReview</code> passes, the extension apiserver executes the request.</p><h2 id="enable-kubernetes-apiserver-flags">Enable Kubernetes Apiserver flags</h2><p>Enable the aggregation layer via the following <code>kube-apiserver</code> flags.
They may have already been taken care of by your provider.</p><pre><code>--requestheader-client-ca-file=&lt;path to aggregator CA cert&gt;
--requestheader-allowed-names=front-proxy-client
--requestheader-extra-headers-prefix=X-Remote-Extra-
--requestheader-group-headers=X-Remote-Group
--requestheader-username-headers=X-Remote-User
--proxy-client-cert-file=&lt;path to aggregator proxy cert&gt;
--proxy-client-key-file=&lt;path to aggregator proxy key&gt;
</code></pre><h3 id="ca-reusage-and-conflicts">CA Reusage and Conflicts</h3><p>The Kubernetes apiserver has two client CA options:</p><ul><li><code>--client-ca-file</code></li><li><code>--requestheader-client-ca-file</code></li></ul><p>Each of these functions independently and can conflict with each other,
if not used correctly.</p><ul><li><code>--client-ca-file</code>: When a request arrives to the Kubernetes apiserver,
if this option is enabled, the Kubernetes apiserver checks the certificate
of the request. If it is signed by one of the CA certificates in the file referenced by
<code>--client-ca-file</code>, then the request is treated as a legitimate request,
and the user is the value of the common name <code>CN=</code>, while the group is the organization <code>O=</code>.
See the <a href="/docs/reference/access-authn-authz/authentication/#x509-client-certificates">documentation on TLS authentication</a>.</li><li><code>--requestheader-client-ca-file</code>: When a request arrives to the Kubernetes apiserver,
if this option is enabled, the Kubernetes apiserver checks the certificate of the request.
If it is signed by one of the CA certificates in the file reference by <code>--requestheader-client-ca-file</code>,
then the request is treated as a potentially legitimate request. The Kubernetes apiserver then
checks if the common name <code>CN=</code> is one of the names in the list provided by <code>--requestheader-allowed-names</code>.
If the name is allowed, the request is approved; if it is not, the request is not.</li></ul><p>If <em>both</em> <code>--client-ca-file</code> and <code>--requestheader-client-ca-file</code> are provided,
then the request first checks the <code>--requestheader-client-ca-file</code> CA and then the
<code>--client-ca-file</code>. Normally, different CAs, either root CAs or intermediate CAs,
are used for each of these options; regular client requests match against <code>--client-ca-file</code>,
while aggregation requests match against <code>--requestheader-client-ca-file</code>. However,
if both use the <em>same</em> CA, then client requests that normally would pass via <code>--client-ca-file</code>
will fail, because the CA will match the CA in <code>--requestheader-client-ca-file</code>,
but the common name <code>CN=</code> will <strong>not</strong> match one of the acceptable common names in
<code>--requestheader-allowed-names</code>. This can cause your kubelets and other control plane components,
as well as end-users, to be unable to authenticate to the Kubernetes apiserver.</p><p>For this reason, use different CA certs for the <code>--client-ca-file</code>
option - to authorize control plane components and end-users - and the <code>--requestheader-client-ca-file</code> option - to authorize aggregation apiserver requests.</p><div class="alert alert-danger" role="alert"><h4 class="alert-heading">Warning:</h4>Do <strong>not</strong> reuse a CA that is used in a different context unless you understand
the risks and the mechanisms to protect the CA's usage.</div><p>If you are not running kube-proxy on a host running the API server,
then you must make sure that the system is enabled with the following
<code>kube-apiserver</code> flag:</p><pre><code>--enable-aggregator-routing=true
</code></pre><h3 id="register-apiservice-objects">Register APIService objects</h3><p>You can dynamically configure what client requests are proxied to extension
apiserver. The following is an example registration:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiregistration.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>APIService<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>&lt;name of the registration object&gt;<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">group</span>:<span style="color:#bbb"> </span>&lt;API group name this extension apiserver hosts&gt;<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">version</span>:<span style="color:#bbb"> </span>&lt;API version this extension apiserver hosts&gt;<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">groupPriorityMinimum</span>:<span style="color:#bbb"> </span>&lt;priority this APIService for this group, see API documentation&gt;<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">versionPriority</span>:<span style="color:#bbb"> </span>&lt;prioritizes ordering of this version within a group, see API documentation&gt;<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">service</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>&lt;namespace of the extension apiserver service&gt;<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>&lt;name of the extension apiserver service&gt;<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">caBundle</span>:<span style="color:#bbb"> </span>&lt;pem encoded ca cert that signs the server cert used by the webhook&gt;<span style="color:#bbb">
</span></span></span></code></pre></div><p>The name of an APIService object must be a valid
<a href="/docs/concepts/overview/working-with-objects/names/#path-segment-names">path segment name</a>.</p><h4 id="contacting-the-extension-apiserver">Contacting the extension apiserver</h4><p>Once the Kubernetes apiserver has determined a request should be sent to an extension apiserver,
it needs to know how to contact it.</p><p>The <code>service</code> stanza is a reference to the service for an extension apiserver.
The service namespace and name are required. The port is optional and defaults to 443.</p><p>Here is an example of an extension apiserver that is configured to be called on port "1234",
and to verify the TLS connection against the ServerName
<code>my-service-name.my-service-namespace.svc</code> using a custom CA bundle.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiregistration.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>APIService<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#00f;font-weight:700">...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">service</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>my-service-namespace<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-service-name<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">port</span>:<span style="color:#bbb"> </span><span style="color:#666">1234</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">caBundle</span>:<span style="color:#bbb"> </span><span style="color:#b44">"Ci0tLS0tQk...&lt;base64-encoded PEM bundle&gt;...tLS0K"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#00f;font-weight:700">...</span><span style="color:#bbb">
</span></span></span></code></pre></div><h2 id="what-s-next">What's next</h2><ul><li><a href="/docs/tasks/extend-kubernetes/setup-extension-api-server/">Set up an extension api-server</a>
to work with the aggregation layer.</li><li>For a high level overview, see
<a href="/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/">Extending the Kubernetes API with the aggregation layer</a>.</li><li>Learn how to <a href="/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/">Extend the Kubernetes API Using Custom Resource Definitions</a>.</li></ul></div>
<hr>
<div class="td-content"><h1 data-pagefind-weight="10">Extend kubectl with plugins</h1><div class="lead">Extend kubectl by creating and installing kubectl plugins.</div><p>This guide demonstrates how to install and write extensions for <a href="/docs/reference/kubectl/kubectl/">kubectl</a>.
By thinking of core <code>kubectl</code> commands as essential building blocks for interacting with a Kubernetes cluster,
a cluster administrator can think of plugins as a means of utilizing these building blocks to create more complex behavior.
Plugins extend <code>kubectl</code> with new sub-commands, allowing for new and custom features not included in the main distribution of <code>kubectl</code>.</p><h2 id="before-you-begin">Before you begin</h2><p>You need to have a working <code>kubectl</code> binary installed.</p><h2 id="installing-kubectl-plugins">Installing kubectl plugins</h2><p>A plugin is a standalone executable file, whose name begins with <code>kubectl-</code>. To install a plugin, move its executable file to anywhere on your <code>PATH</code>.</p><p>You can also discover and install kubectl plugins available in the open source
using <a href="https://krew.dev/">Krew</a>. Krew is a plugin manager maintained by
the Kubernetes SIG CLI community.</p><div class="alert alert-caution" role="alert"><h4 class="alert-heading">Caution:</h4>Kubectl plugins available via the Krew <a href="https://krew.sigs.k8s.io/plugins/">plugin index</a>
are not audited for security. You should install and run third-party plugins at your
own risk, since they are arbitrary programs running on your machine.</div><h3 id="discovering-plugins">Discovering plugins</h3><p><code>kubectl</code> provides a command <code>kubectl plugin list</code> that searches your <code>PATH</code> for valid plugin executables.
Executing this command causes a traversal of all files in your <code>PATH</code>. Any files that are executable, and
begin with <code>kubectl-</code> will show up <em>in the order in which they are present in your <code>PATH</code></em> in this command's output.
A warning will be included for any files beginning with <code>kubectl-</code> that are <em>not</em> executable.
A warning will also be included for any valid plugin files that overlap each other's name.</p><p>You can use <a href="https://krew.dev/">Krew</a> to discover and install <code>kubectl</code>
plugins from a community-curated
<a href="https://krew.sigs.k8s.io/plugins/">plugin index</a>.</p><h4 id="create-plugins">Create plugins</h4><p><code>kubectl</code> allows plugins to add custom create commands of the shape <code>kubectl create something</code> by providing a <code>kubectl-create-something</code> binary in the <code>PATH</code>.</p><h4 id="limitations">Limitations</h4><p>It is currently not possible to create plugins that overwrite existing <code>kubectl</code> commands or extend commands other than <code>create</code>.
For example, creating a plugin <code>kubectl-version</code> will cause that plugin to never be executed, as the existing <code>kubectl version</code>
command will always take precedence over it.
Due to this limitation, it is also <em>not</em> possible to use plugins to add new subcommands to existing <code>kubectl</code> commands.
For example, adding a subcommand <code>kubectl attach vm</code> by naming your plugin <code>kubectl-attach-vm</code> will cause that plugin to be ignored.</p><p><code>kubectl plugin list</code> shows warnings for any valid plugins that attempt to do this.</p><h2 id="writing-kubectl-plugins">Writing kubectl plugins</h2><p>You can write a plugin in any programming language or script that allows you to write command-line commands.</p><p>There is no plugin installation or pre-loading required. Plugin executables receive
the inherited environment from the <code>kubectl</code> binary.
A plugin determines which command path it wishes to implement based on its name.
For example, a plugin named <code>kubectl-foo</code> provides a command <code>kubectl foo</code>. You must
install the plugin executable somewhere in your <code>PATH</code>.</p><h3 id="example-plugin">Example plugin</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#080">#!/bin/bash
</span></span></span><span style="display:flex"><span><span style="color:#080"/>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># optional argument handling</span>
</span></span><span style="display:flex"><span><span style="color:#a2f;font-weight:700">if</span> <span style="color:#666">[[</span> <span style="color:#b44">"</span><span style="color:#b8860b">$1</span><span style="color:#b44">"</span> <span style="color:#666">==</span> <span style="color:#b44">"version"</span> <span style="color:#666">]]</span>
</span></span><span style="display:flex"><span><span style="color:#a2f;font-weight:700">then</span>
</span></span><span style="display:flex"><span>    <span style="color:#a2f">echo</span> <span style="color:#b44">"1.0.0"</span>
</span></span><span style="display:flex"><span>    <span style="color:#a2f">exit</span> <span style="color:#666">0</span>
</span></span><span style="display:flex"><span><span style="color:#a2f;font-weight:700">fi</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># optional argument handling</span>
</span></span><span style="display:flex"><span><span style="color:#a2f;font-weight:700">if</span> <span style="color:#666">[[</span> <span style="color:#b44">"</span><span style="color:#b8860b">$1</span><span style="color:#b44">"</span> <span style="color:#666">==</span> <span style="color:#b44">"config"</span> <span style="color:#666">]]</span>
</span></span><span style="display:flex"><span><span style="color:#a2f;font-weight:700">then</span>
</span></span><span style="display:flex"><span>    <span style="color:#a2f">echo</span> <span style="color:#b44">"</span><span style="color:#b8860b">$KUBECONFIG</span><span style="color:#b44">"</span>
</span></span><span style="display:flex"><span>    <span style="color:#a2f">exit</span> <span style="color:#666">0</span>
</span></span><span style="display:flex"><span><span style="color:#a2f;font-weight:700">fi</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#a2f">echo</span> <span style="color:#b44">"I am a plugin named kubectl-foo"</span>
</span></span></code></pre></div><h3 id="using-a-plugin">Using a plugin</h3><p>To use a plugin, make the plugin executable:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>sudo chmod +x ./kubectl-foo
</span></span></code></pre></div><p>and place it anywhere in your <code>PATH</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>sudo mv ./kubectl-foo /usr/local/bin
</span></span></code></pre></div><p>You may now invoke your plugin as a <code>kubectl</code> command:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl foo
</span></span></code></pre></div><pre tabindex="0"><code>I am a plugin named kubectl-foo
</code></pre><p>All args and flags are passed as-is to the executable:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl foo version
</span></span></code></pre></div><pre tabindex="0"><code>1.0.0
</code></pre><p>All environment variables are also passed as-is to the executable:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#a2f">export</span> <span style="color:#b8860b">KUBECONFIG</span><span style="color:#666">=</span>~/.kube/config
</span></span><span style="display:flex"><span>kubectl foo config
</span></span></code></pre></div><pre tabindex="0"><code>/home/&lt;user&gt;/.kube/config
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#b8860b">KUBECONFIG</span><span style="color:#666">=</span>/etc/kube/config kubectl foo config
</span></span></code></pre></div><pre tabindex="0"><code>/etc/kube/config
</code></pre><p>Additionally, the first argument that is passed to a plugin will always be the full path to the location where it was invoked (<code>$0</code> would equal <code>/usr/local/bin/kubectl-foo</code> in the example above).</p><h3 id="naming-a-plugin">Naming a plugin</h3><p>As seen in the example above, a plugin determines the command path that it will implement based on its filename. Every sub-command in the command path that a plugin targets, is separated by a dash (<code>-</code>).
For example, a plugin that wishes to be invoked whenever the command <code>kubectl foo bar baz</code> is invoked by the user, would have the filename of <code>kubectl-foo-bar-baz</code>.</p><h4 id="flags-and-argument-handling">Flags and argument handling</h4><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4><p>The plugin mechanism does <em>not</em> create any custom, plugin-specific values or environment variables for a plugin process.</p><p>An older kubectl plugin mechanism provided environment variables such as <code>KUBECTL_PLUGINS_CURRENT_NAMESPACE</code>; that no longer happens.</p></div><p>kubectl plugins must parse and validate all of the arguments passed to them.
See <a href="#using-the-command-line-runtime-package">using the command line runtime package</a> for details of a Go library aimed at plugin authors.</p><p>Here are some additional cases where users invoke your plugin while providing additional flags and arguments. This builds upon the <code>kubectl-foo-bar-baz</code> plugin from the scenario above.</p><p>If you run <code>kubectl foo bar baz arg1 --flag=value arg2</code>, kubectl's plugin mechanism will first try to find the plugin with the longest possible name, which in this case
would be <code>kubectl-foo-bar-baz-arg1</code>. Upon not finding that plugin, kubectl then treats the last dash-separated value as an argument (<code>arg1</code> in this case), and attempts to find the next longest possible name, <code>kubectl-foo-bar-baz</code>.
Upon having found a plugin with this name, kubectl then invokes that plugin, passing all args and flags after the plugin's name as arguments to the plugin process.</p><p>Example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#080;font-style:italic"># create a plugin</span>
</span></span><span style="display:flex"><span><span style="color:#a2f">echo</span> -e <span style="color:#b44">'#!/bin/bash\n\necho "My first command-line argument was $1"'</span> &gt; kubectl-foo-bar-baz
</span></span><span style="display:flex"><span>sudo chmod +x ./kubectl-foo-bar-baz
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># "install" your plugin by moving it to a directory in your $PATH</span>
</span></span><span style="display:flex"><span>sudo mv ./kubectl-foo-bar-baz /usr/local/bin
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># check that kubectl recognizes your plugin</span>
</span></span><span style="display:flex"><span>kubectl plugin list
</span></span></code></pre></div><pre tabindex="0"><code>The following kubectl-compatible plugins are available:

/usr/local/bin/kubectl-foo-bar-baz
</code></pre><pre tabindex="0"><code># test that calling your plugin via a "kubectl" command works
# even when additional arguments and flags are passed to your
# plugin executable by the user.
kubectl foo bar baz arg1 --meaningless-flag=true
</code></pre><pre tabindex="0"><code>My first command-line argument was arg1
</code></pre><p>As you can see, your plugin was found based on the <code>kubectl</code> command specified by a user, and all extra arguments and flags were passed as-is to the plugin executable once it was found.</p><h4 id="names-with-dashes-and-underscores">Names with dashes and underscores</h4><p>Although the <code>kubectl</code> plugin mechanism uses the dash (<code>-</code>) in plugin filenames to separate the sequence of sub-commands processed by the plugin, it is still possible to create a plugin
command containing dashes in its commandline invocation by using underscores (<code>_</code>) in its filename.</p><p>Example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#080;font-style:italic"># create a plugin containing an underscore in its filename</span>
</span></span><span style="display:flex"><span><span style="color:#a2f">echo</span> -e <span style="color:#b44">'#!/bin/bash\n\necho "I am a plugin with a dash in my name"'</span> &gt; ./kubectl-foo_bar
</span></span><span style="display:flex"><span>sudo chmod +x ./kubectl-foo_bar
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># move the plugin into your $PATH</span>
</span></span><span style="display:flex"><span>sudo mv ./kubectl-foo_bar /usr/local/bin
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># You can now invoke your plugin via kubectl:</span>
</span></span><span style="display:flex"><span>kubectl foo-bar
</span></span></code></pre></div><pre tabindex="0"><code>I am a plugin with a dash in my name
</code></pre><p>Note that the introduction of underscores to a plugin filename does not prevent you from having commands such as <code>kubectl foo_bar</code>.
The command from the above example, can be invoked using either a dash (<code>-</code>) or an underscore (<code>_</code>):</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#080;font-style:italic"># You can invoke your custom command with a dash</span>
</span></span><span style="display:flex"><span>kubectl foo-bar
</span></span></code></pre></div><pre tabindex="0"><code>I am a plugin with a dash in my name
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#080;font-style:italic"># You can also invoke your custom command with an underscore</span>
</span></span><span style="display:flex"><span>kubectl foo_bar
</span></span></code></pre></div><pre tabindex="0"><code>I am a plugin with a dash in my name
</code></pre><h4 id="name-conflicts-and-overshadowing">Name conflicts and overshadowing</h4><p>It is possible to have multiple plugins with the same filename in different locations throughout your <code>PATH</code>.
For example, given a <code>PATH</code> with the following value: <code>PATH=/usr/local/bin/plugins:/usr/local/bin/moreplugins</code>, a copy of plugin <code>kubectl-foo</code> could exist in <code>/usr/local/bin/plugins</code> and <code>/usr/local/bin/moreplugins</code>,
such that the output of the <code>kubectl plugin list</code> command is:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#b8860b">PATH</span><span style="color:#666">=</span>/usr/local/bin/plugins:/usr/local/bin/moreplugins kubectl plugin list
</span></span></code></pre></div><pre tabindex="0"><code>The following kubectl-compatible plugins are available:

/usr/local/bin/plugins/kubectl-foo
/usr/local/bin/moreplugins/kubectl-foo
  - warning: /usr/local/bin/moreplugins/kubectl-foo is overshadowed by a similarly named plugin: /usr/local/bin/plugins/kubectl-foo

error: one plugin warning was found
</code></pre><p>In the above scenario, the warning under <code>/usr/local/bin/moreplugins/kubectl-foo</code> tells you that this plugin will never be executed. Instead, the executable that appears first in your <code>PATH</code>, <code>/usr/local/bin/plugins/kubectl-foo</code>, will always be found and executed first by the <code>kubectl</code> plugin mechanism.</p><p>A way to resolve this issue is to ensure that the location of the plugin that you wish to use with <code>kubectl</code> always comes first in your <code>PATH</code>. For example, if you want to always use <code>/usr/local/bin/moreplugins/kubectl-foo</code> anytime that the <code>kubectl</code> command <code>kubectl foo</code> was invoked, change the value of your <code>PATH</code> to be <code>/usr/local/bin/moreplugins:/usr/local/bin/plugins</code>.</p><h4 id="invocation-of-the-longest-executable-filename">Invocation of the longest executable filename</h4><p>There is another kind of overshadowing that can occur with plugin filenames. Given two plugins present in a user's <code>PATH</code>: <code>kubectl-foo-bar</code> and <code>kubectl-foo-bar-baz</code>, the <code>kubectl</code> plugin mechanism will always choose the longest possible plugin name for a given user command. Some examples below, clarify this further:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#080;font-style:italic"># for a given kubectl command, the plugin with the longest possible filename will always be preferred</span>
</span></span><span style="display:flex"><span>kubectl foo bar baz
</span></span></code></pre></div><pre tabindex="0"><code>Plugin kubectl-foo-bar-baz is executed
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl foo bar
</span></span></code></pre></div><pre tabindex="0"><code>Plugin kubectl-foo-bar is executed
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl foo bar baz buz
</span></span></code></pre></div><pre tabindex="0"><code>Plugin kubectl-foo-bar-baz is executed, with "buz" as its first argument
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl foo bar buz
</span></span></code></pre></div><pre tabindex="0"><code>Plugin kubectl-foo-bar is executed, with "buz" as its first argument
</code></pre><p>This design choice ensures that plugin sub-commands can be implemented across multiple files, if needed, and that these sub-commands can be nested under a "parent" plugin command:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>ls ./plugin_command_tree
</span></span></code></pre></div><pre tabindex="0"><code>kubectl-parent
kubectl-parent-subcommand
kubectl-parent-subcommand-subsubcommand
</code></pre><h3 id="checking-for-plugin-warnings">Checking for plugin warnings</h3><p>You can use the aforementioned <code>kubectl plugin list</code> command to ensure that your plugin is visible by <code>kubectl</code>, and verify that there are no warnings preventing it from being called as a <code>kubectl</code> command.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl plugin list
</span></span></code></pre></div><pre tabindex="0"><code>The following kubectl-compatible plugins are available:

test/fixtures/pkg/kubectl/plugins/kubectl-foo
/usr/local/bin/kubectl-foo
  - warning: /usr/local/bin/kubectl-foo is overshadowed by a similarly named plugin: test/fixtures/pkg/kubectl/plugins/kubectl-foo
plugins/kubectl-invalid
  - warning: plugins/kubectl-invalid identified as a kubectl plugin, but it is not executable

error: 2 plugin warnings were found
</code></pre><h3 id="using-the-command-line-runtime-package">Using the command line runtime package</h3><p>If you're writing a plugin for kubectl and you're using Go, you can make use
of the
<a href="https://github.com/kubernetes/cli-runtime">cli-runtime</a> utility libraries.</p><p>These libraries provide helpers for parsing or updating a user's
<a href="/docs/concepts/configuration/organize-cluster-access-kubeconfig/">kubeconfig</a>
file, for making REST-style requests to the API server, or to bind flags
associated with configuration and printing.</p><p>See the <a href="https://github.com/kubernetes/sample-cli-plugin">Sample CLI Plugin</a> for
an example usage of the tools provided in the CLI Runtime repo.</p><h2 id="distributing-kubectl-plugins">Distributing kubectl plugins</h2><p>If you have developed a plugin for others to use, you should consider how you
package it, distribute it and deliver updates to your users.</p><h3 id="distributing-krew">Krew</h3><p><a href="https://krew.dev/">Krew</a> offers a cross-platform way to package and
distribute your plugins. This way, you use a single packaging format for all
target platforms (Linux, Windows, macOS etc) and deliver updates to your users.
Krew also maintains a <a href="https://krew.sigs.k8s.io/plugins/">plugin
index</a> so that other people can
discover your plugin and install it.</p><h3 id="distributing-native">Native / platform specific package management</h3><p>Alternatively, you can use traditional package managers such as, <code>apt</code> or <code>yum</code>
on Linux, Chocolatey on Windows, and Homebrew on macOS. Any package
manager will be suitable if it can place new executables placed somewhere
in the user's <code>PATH</code>.
As a plugin author, if you pick this option then you also have the burden
of updating your kubectl plugin's distribution package across multiple
platforms for each release.</p><h3 id="distributing-source-code">Source code</h3><p>You can publish the source code; for example, as a Git repository. If you
choose this option, someone who wants to use that plugin must fetch the code,
set up a build environment (if it needs compiling), and deploy the plugin.
If you also make compiled packages available, or use Krew, that will make
installs easier.</p><h2 id="what-s-next">What's next</h2><ul><li>Check the Sample CLI Plugin repository for a
<a href="https://github.com/kubernetes/sample-cli-plugin">detailed example</a> of a
plugin written in Go.
In case of any questions, feel free to reach out to the
<a href="https://github.com/kubernetes/community/tree/master/sig-cli">SIG CLI team</a>.</li><li>Read about <a href="https://krew.dev/">Krew</a>, a package manager for kubectl plugins.</li></ul></div>
<hr>
<div class="td-content"><h1 data-pagefind-weight="10">Use a SOCKS5 Proxy to Access the Kubernetes API</h1><div class="feature-state-notice feature-stable"><span class="feature-state-name">FEATURE STATE:</span>
<code>Kubernetes v1.24 [stable]</code></div><p>This page shows how to use a SOCKS5 proxy to access the API of a remote Kubernetes cluster.
This is useful when the cluster you want to access does not expose its API directly on the public internet.</p><h2 id="before-you-begin">Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul>Your Kubernetes server must be at or later than version v1.24.<p>To check the version, enter <code>kubectl version</code>.</p></p><p>You need SSH client software (the <code>ssh</code> tool), and an SSH service running on the remote server.
You must be able to log in to the SSH service on the remote server.</p><h2 id="task-context">Task context</h2><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>This example tunnels traffic using SSH, with the SSH client and server acting as a SOCKS proxy.
You can instead use any other kind of <a href="https://en.wikipedia.org/wiki/SOCKS#SOCKS5">SOCKS5</a> proxies.</div><p>Figure 1 represents what you're going to achieve in this task.</p><ul><li>You have a client computer, referred to as local in the steps ahead, from where you're going to create requests to talk to the Kubernetes API.</li><li>The Kubernetes server/API is hosted on a remote server.</li><li>You will use SSH client and server software to create a secure SOCKS5 tunnel between the local and
the remote server. The HTTPS traffic between the client and the Kubernetes API will flow over the SOCKS5
tunnel, which is itself tunnelled over SSH.</li></ul><p><figure><div class="mermaid">graph LR;
subgraph local[Local client machine]
client([client])-. local<br/>traffic .-&gt; local_ssh[Local SSH<br/>SOCKS5 proxy];
end
local_ssh[SSH<br/>SOCKS5<br/>proxy]-- SSH Tunnel --&gt;sshd
subgraph remote[Remote server]
sshd[SSH<br/>server]-- local traffic --&gt;service1;
end
client([client])-. proxied HTTPs traffic<br/>going through the proxy .-&gt;service1[Kubernetes API];
classDef plain fill:#ddd,stroke:#fff,stroke-width:4px,color:#000;
classDef k8s fill:#326ce5,stroke:#fff,stroke-width:4px,color:#fff;
classDef cluster fill:#fff,stroke:#bbb,stroke-width:2px,color:#326ce5;
class ingress,service1,service2,pod1,pod2,pod3,pod4 k8s;
class client plain;
class cluster cluster;</div></figure><noscript><div class="alert alert-secondary callout" role="alert"><em class="javascript-required">JavaScript must be <a href="https://www.enable-javascript.com/">enabled</a> to view this content</em></div></noscript>Figure 1. SOCKS5 tutorial components</p><h2 id="using-ssh-to-create-a-socks5-proxy">Using ssh to create a SOCKS5 proxy</h2><p>The following command starts a SOCKS5 proxy between your client machine and the remote SOCKS server:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># The SSH tunnel continues running in the foreground after you run this</span>
</span></span><span style="display:flex"><span>ssh -D <span style="color:#666">1080</span> -q -N username@kubernetes-remote-server.example
</span></span></code></pre></div><p>The SOCKS5 proxy lets you connect to your cluster's API server based on the following configuration:</p><ul><li><code>-D 1080</code>: opens a SOCKS proxy on local port :1080.</li><li><code>-q</code>: quiet mode. Causes most warning and diagnostic messages to be suppressed.</li><li><code>-N</code>: Do not execute a remote command. Useful for just forwarding ports.</li><li><code>username@kubernetes-remote-server.example</code>: the remote SSH server behind which the Kubernetes cluster
is running (eg: a bastion host).</li></ul><h2 id="client-configuration">Client configuration</h2><p>To access the Kubernetes API server through the proxy you must instruct <code>kubectl</code> to send queries through
the <code>SOCKS</code> proxy we created earlier. Do this by either setting the appropriate environment variable,
or via the <code>proxy-url</code> attribute in the kubeconfig file. Using an environment variable:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#a2f">export</span> <span style="color:#b8860b">HTTPS_PROXY</span><span style="color:#666">=</span>socks5://localhost:1080
</span></span></code></pre></div><p>To always use this setting on a specific <code>kubectl</code> context, specify the <code>proxy-url</code> attribute in the relevant
<code>cluster</code> entry within the <code>~/.kube/config</code> file. For example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">clusters</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">cluster</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">certificate-authority-data</span>:<span style="color:#bbb"> </span>LRMEMMW2<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># shortened for readability </span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">server</span>:<span style="color:#bbb"> </span>https://&lt;API_SERVER_IP_ADDRESS&gt;:6443 <span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># the "Kubernetes API" server, in other words the IP address of kubernetes-remote-server.example</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">proxy-url</span>:<span style="color:#bbb"> </span>socks5://localhost:1080  <span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># the "SSH SOCKS5 proxy" in the diagram above</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">contexts</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">context</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">cluster</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">user</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">current-context</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Config<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">preferences</span>:<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">users</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">user</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">client-certificate-data</span>:<span style="color:#bbb"> </span>LS0tLS1CR==<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># shortened for readability</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">client-key-data</span>:<span style="color:#bbb"> </span>LS0tLS1CRUdJT=     <span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># shortened for readability</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>Once you have created the tunnel via the ssh command mentioned earlier, and defined either the environment variable or
the <code>proxy-url</code> attribute, you can interact with your cluster through that proxy. For example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pods
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console"><span style="display:flex"><span><span style="color:#888">NAMESPACE     NAME                                     READY   STATUS      RESTARTS   AGE
</span></span></span><span style="display:flex"><span><span style="color:#888">kube-system   coredns-85cb69466-klwq8                  1/1     Running     0          5m46s
</span></span></span></code></pre></div><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4><ul><li>Before <code>kubectl</code> 1.24, most <code>kubectl</code> commands worked when using a socks proxy, except <code>kubectl exec</code>.</li><li><code>kubectl</code> supports both <code>HTTPS_PROXY</code> and <code>https_proxy</code> environment variables. These are used by other
programs that support SOCKS, such as <code>curl</code>. Therefore in some cases it
will be better to define the environment variable on the command line:<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#b8860b">HTTPS_PROXY</span><span style="color:#666">=</span>socks5://localhost:1080 kubectl get pods
</span></span></code></pre></div></li><li>When using <code>proxy-url</code>, the proxy is used only for the relevant <code>kubectl</code> context,
whereas the environment variable will affect all contexts.</li><li>The k8s API server hostname can be further protected from DNS leakage by using the <code>socks5h</code> protocol name
instead of the more commonly known <code>socks5</code> protocol shown above. In this case, <code>kubectl</code> will ask the proxy server
(such as an ssh bastion) to resolve the k8s API server domain name, instead of resolving it on the system running
<code>kubectl</code>. Note also that with <code>socks5h</code>, a k8s API server URL like <code>https://localhost:6443/api</code> does not refer
to your local client computer. Instead, it refers to <code>localhost</code> as known on the proxy server (eg the ssh bastion).</li></ul></div><h2 id="clean-up">Clean up</h2><p>Stop the ssh port-forwarding process by pressing <code>CTRL+C</code> on the terminal where it is running.</p><p>Type <code>unset https_proxy</code> in a terminal to stop forwarding http traffic through the proxy.</p><h2 id="further-reading">Further reading</h2><ul><li><a href="https://man.openbsd.org/ssh">OpenSSH remote login client</a></li></ul></div>