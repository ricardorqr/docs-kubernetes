<hr>
<div class="td-content"><h1 data-pagefind-weight="10">Update API Objects in Place Using kubectl patch</h1><div class="lead">Use kubectl patch to update Kubernetes API objects in place. Do a strategic merge patch or a JSON merge patch.</div><p>This task shows how to use <code>kubectl patch</code> to update an API object in place. The exercises
in this task demonstrate a strategic merge patch and a JSON merge patch.</p><h2 id="before-you-begin">Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul><p>To check the version, enter <code>kubectl version</code>.</p></p><h2 id="use-a-strategic-merge-patch-to-update-a-deployment">Use a strategic merge patch to update a Deployment</h2><p>Here's the configuration file for a Deployment that has two replicas. Each replica
is a Pod that has one container:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/deployment-patch.yaml" download="application/deployment-patch.yaml"><code>application/deployment-patch.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;application-deployment-patch-yaml&quot;)" title="Copy application/deployment-patch.yaml to clipboard"/></div><div class="includecode" id="application-deployment-patch-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>patch-demo<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">2</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>patch-demo-ctr<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">tolerations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">effect</span>:<span style="color:#bbb"> </span>NoSchedule<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">key</span>:<span style="color:#bbb"> </span>dedicated<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">value</span>:<span style="color:#bbb"> </span>test-team<span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>Create the Deployment:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f https://k8s.io/examples/application/deployment-patch.yaml
</span></span></code></pre></div><p>View the Pods associated with your Deployment:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pods
</span></span></code></pre></div><p>The output shows that the Deployment has two Pods. The <code>1/1</code> indicates that
each Pod has one container:</p><pre tabindex="0"><code>NAME                        READY     STATUS    RESTARTS   AGE
patch-demo-28633765-670qr   1/1       Running   0          23s
patch-demo-28633765-j5qs3   1/1       Running   0          23s
</code></pre><p>Make a note of the names of the running Pods. Later, you will see that these Pods
get terminated and replaced by new ones.</p><p>At this point, each Pod has one Container that runs the nginx image. Now suppose
you want each Pod to have two containers: one that runs nginx and one that runs redis.</p><p>Create a file named <code>patch-file.yaml</code> that has this content:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>patch-demo-ctr-2<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>redis<span style="color:#bbb">
</span></span></span></code></pre></div><p>Patch your Deployment:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl patch deployment patch-demo --patch-file patch-file.yaml
</span></span></code></pre></div><p>View the patched Deployment:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get deployment patch-demo --output yaml
</span></span></code></pre></div><p>The output shows that the PodSpec in the Deployment has two Containers:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>redis<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">imagePullPolicy</span>:<span style="color:#bbb"> </span>Always<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>patch-demo-ctr-2<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">imagePullPolicy</span>:<span style="color:#bbb"> </span>Always<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>patch-demo-ctr<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>...<span style="color:#bbb">
</span></span></span></code></pre></div><p>View the Pods associated with your patched Deployment:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pods
</span></span></code></pre></div><p>The output shows that the running Pods have different names from the Pods that
were running previously. The Deployment terminated the old Pods and created two
new Pods that comply with the updated Deployment spec. The <code>2/2</code> indicates that
each Pod has two Containers:</p><pre tabindex="0"><code>NAME                          READY     STATUS    RESTARTS   AGE
patch-demo-1081991389-2wrn5   2/2       Running   0          1m
patch-demo-1081991389-jmg7b   2/2       Running   0          1m
</code></pre><p>Take a closer look at one of the patch-demo Pods:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pod &lt;your-pod-name&gt; --output yaml
</span></span></code></pre></div><p>The output shows that the Pod has two Containers: one running nginx and one running redis:</p><pre tabindex="0"><code>containers:
- image: redis
  ...
- image: nginx
  ...
</code></pre><h3 id="notes-on-the-strategic-merge-patch">Notes on the strategic merge patch</h3><p>The patch you did in the preceding exercise is called a <em>strategic merge patch</em>.
Notice that the patch did not replace the <code>containers</code> list. Instead it added a new
Container to the list. In other words, the list in the patch was merged with the
existing list. This is not always what happens when you use a strategic merge patch on a list.
In some cases, the list is replaced, not merged.</p><p>With a strategic merge patch, a list is either replaced or merged depending on its
patch strategy. The patch strategy is specified by the value of the <code>patchStrategy</code> key
in a field tag in the Kubernetes source code. For example, the <code>Containers</code> field of <code>PodSpec</code>
struct has a <code>patchStrategy</code> of <code>merge</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="display:flex"><span><span style="color:#a2f;font-weight:700">type</span> PodSpec <span style="color:#a2f;font-weight:700">struct</span> {
</span></span><span style="display:flex"><span>  <span style="color:#666">...</span>
</span></span><span style="display:flex"><span>  Containers []Container <span style="color:#b44">`json:"containers" patchStrategy:"merge" patchMergeKey:"name" ...`</span>
</span></span><span style="display:flex"><span>  <span style="color:#666">...</span>
</span></span><span style="display:flex"><span>}
</span></span></code></pre></div><p>You can also see the patch strategy in the
<a href="https://raw.githubusercontent.com/kubernetes/kubernetes/master/api/openapi-spec/swagger.json">OpenApi spec</a>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">"io.k8s.api.core.v1.PodSpec": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>...,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"containers": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"description": </span><span style="color:#b44">"List of containers belonging to the pod.  ...."</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"x-kubernetes-patch-merge-key": </span><span style="color:#b44">"name"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"x-kubernetes-patch-strategy": </span><span style="color:#b44">"merge"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>And you can see the patch strategy in the
<a href="/docs/reference/generated/kubernetes-api/v1.34/#podspec-v1-core">Kubernetes API documentation</a>.</p><p>Create a file named <code>patch-file-tolerations.yaml</code> that has this content:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">tolerations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">effect</span>:<span style="color:#bbb"> </span>NoSchedule<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">key</span>:<span style="color:#bbb"> </span>disktype<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">value</span>:<span style="color:#bbb"> </span>ssd<span style="color:#bbb">
</span></span></span></code></pre></div><p>Patch your Deployment:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl patch deployment patch-demo --patch-file patch-file-tolerations.yaml
</span></span></code></pre></div><p>View the patched Deployment:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get deployment patch-demo --output yaml
</span></span></code></pre></div><p>The output shows that the PodSpec in the Deployment has only one Toleration:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">tolerations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">effect</span>:<span style="color:#bbb"> </span>NoSchedule<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">key</span>:<span style="color:#bbb"> </span>disktype<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">value</span>:<span style="color:#bbb"> </span>ssd<span style="color:#bbb">
</span></span></span></code></pre></div><p>Notice that the <code>tolerations</code> list in the PodSpec was replaced, not merged. This is because
the Tolerations field of PodSpec does not have a <code>patchStrategy</code> key in its field tag. So the
strategic merge patch uses the default patch strategy, which is <code>replace</code>.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="display:flex"><span><span style="color:#a2f;font-weight:700">type</span> PodSpec <span style="color:#a2f;font-weight:700">struct</span> {
</span></span><span style="display:flex"><span>  <span style="color:#666">...</span>
</span></span><span style="display:flex"><span>  Tolerations []Toleration <span style="color:#b44">`json:"tolerations,omitempty" protobuf:"bytes,22,opt,name=tolerations"`</span>
</span></span><span style="display:flex"><span>  <span style="color:#666">...</span>
</span></span><span style="display:flex"><span>}
</span></span></code></pre></div><h2 id="use-a-json-merge-patch-to-update-a-deployment">Use a JSON merge patch to update a Deployment</h2><p>A strategic merge patch is different from a
<a href="https://tools.ietf.org/html/rfc7386">JSON merge patch</a>.
With a JSON merge patch, if you
want to update a list, you have to specify the entire new list. And the new list completely
replaces the existing list.</p><p>The <code>kubectl patch</code> command has a <code>type</code> parameter that you can set to one of these values:</p><table><tr><th>Parameter value</th><th>Merge type</th></tr><tr><td>json</td><td><a href="https://tools.ietf.org/html/rfc6902">JSON Patch, RFC 6902</a></td></tr><tr><td>merge</td><td><a href="https://tools.ietf.org/html/rfc7386">JSON Merge Patch, RFC 7386</a></td></tr><tr><td>strategic</td><td>Strategic merge patch</td></tr></table><p>For a comparison of JSON patch and JSON merge patch, see
<a href="https://erosb.github.io/post/json-patch-vs-merge-patch/">JSON Patch and JSON Merge Patch</a>.</p><p>The default value for the <code>type</code> parameter is <code>strategic</code>. So in the preceding exercise, you
did a strategic merge patch.</p><p>Next, do a JSON merge patch on your same Deployment. Create a file named <code>patch-file-2.yaml</code>
that has this content:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>patch-demo-ctr-3<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>gcr.io/google-samples/hello-app:2.0<span style="color:#bbb">
</span></span></span></code></pre></div><p>In your patch command, set <code>type</code> to <code>merge</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl patch deployment patch-demo --type merge --patch-file patch-file-2.yaml
</span></span></code></pre></div><p>View the patched Deployment:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get deployment patch-demo --output yaml
</span></span></code></pre></div><p>The <code>containers</code> list that you specified in the patch has only one Container.
The output shows that your list of one Container replaced the existing <code>containers</code> list.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>gcr.io/google-samples/hello-app:2.0<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>patch-demo-ctr-3<span style="color:#bbb">
</span></span></span></code></pre></div><p>List the running Pods:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pods
</span></span></code></pre></div><p>In the output, you can see that the existing Pods were terminated, and new Pods
were created. The <code>1/1</code> indicates that each new Pod is running only one Container.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>NAME                          READY     STATUS    RESTARTS   AGE
</span></span><span style="display:flex"><span>patch-demo-1307768864-69308   1/1       Running   <span style="color:#666">0</span>          1m
</span></span><span style="display:flex"><span>patch-demo-1307768864-c86dc   1/1       Running   <span style="color:#666">0</span>          1m
</span></span></code></pre></div><h2 id="use-strategic-merge-patch-to-update-a-deployment-using-the-retainkeys-strategy">Use strategic merge patch to update a Deployment using the retainKeys strategy</h2><p>Here's the configuration file for a Deployment that uses the <code>RollingUpdate</code> strategy:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/deployment-retainkeys.yaml" download="application/deployment-retainkeys.yaml"><code>application/deployment-retainkeys.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;application-deployment-retainkeys-yaml&quot;)" title="Copy application/deployment-retainkeys.yaml to clipboard"/></div><div class="includecode" id="application-deployment-retainkeys-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>retainkeys-demo<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">strategy</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">rollingUpdate</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">maxSurge</span>:<span style="color:#bbb"> </span><span style="color:#666">30</span>%<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>retainkeys-demo-ctr<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>Create the deployment:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f https://k8s.io/examples/application/deployment-retainkeys.yaml
</span></span></code></pre></div><p>At this point, the deployment is created and is using the <code>RollingUpdate</code> strategy.</p><p>Create a file named <code>patch-file-no-retainkeys.yaml</code> that has this content:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">strategy</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>Recreate<span style="color:#bbb">
</span></span></span></code></pre></div><p>Patch your Deployment:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl patch deployment retainkeys-demo --type strategic --patch-file patch-file-no-retainkeys.yaml
</span></span></code></pre></div><p>In the output, you can see that it is not possible to set <code>type</code> as <code>Recreate</code> when a value is defined for <code>spec.strategy.rollingUpdate</code>:</p><pre tabindex="0"><code>The Deployment "retainkeys-demo" is invalid: spec.strategy.rollingUpdate: Forbidden: may not be specified when strategy `type` is 'Recreate'
</code></pre><p>The way to remove the value for <code>spec.strategy.rollingUpdate</code> when updating the value for <code>type</code> is to use the <code>retainKeys</code> strategy for the strategic merge.</p><p>Create another file named <code>patch-file-retainkeys.yaml</code> that has this content:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">strategy</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">$retainKeys</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- type<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>Recreate<span style="color:#bbb">
</span></span></span></code></pre></div><p>With this patch, we indicate that we want to retain only the <code>type</code> key of the <code>strategy</code> object. Thus, the <code>rollingUpdate</code> will be removed during the patch operation.</p><p>Patch your Deployment again with this new patch:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl patch deployment retainkeys-demo --type strategic --patch-file patch-file-retainkeys.yaml
</span></span></code></pre></div><p>Examine the content of the Deployment:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get deployment retainkeys-demo --output yaml
</span></span></code></pre></div><p>The output shows that the strategy object in the Deployment does not contain the <code>rollingUpdate</code> key anymore:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">strategy</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>Recreate<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span></code></pre></div><h3 id="notes-on-the-strategic-merge-patch-using-the-retainkeys-strategy">Notes on the strategic merge patch using the retainKeys strategy</h3><p>The patch you did in the preceding exercise is called a <em>strategic merge patch with retainKeys strategy</em>. This method introduces a new directive <code>$retainKeys</code> that has the following strategies:</p><ul><li>It contains a list of strings.</li><li>All fields needing to be preserved must be present in the <code>$retainKeys</code> list.</li><li>The fields that are present will be merged with live object.</li><li>All of the missing fields will be cleared when patching.</li><li>All fields in the <code>$retainKeys</code> list must be a superset or the same as the fields present in the patch.</li></ul><p>The <code>retainKeys</code> strategy does not work for all objects. It only works when the value of the <code>patchStrategy</code> key in a field tag in the Kubernetes source code contains <code>retainKeys</code>. For example, the <code>Strategy</code> field of the <code>DeploymentSpec</code> struct has a <code>patchStrategy</code> of <code>retainKeys</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="display:flex"><span><span style="color:#a2f;font-weight:700">type</span> DeploymentSpec <span style="color:#a2f;font-weight:700">struct</span> {
</span></span><span style="display:flex"><span>  <span style="color:#666">...</span>
</span></span><span style="display:flex"><span>  <span style="color:#080;font-style:italic">// +patchStrategy=retainKeys
</span></span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"/>  Strategy DeploymentStrategy <span style="color:#b44">`json:"strategy,omitempty" patchStrategy:"retainKeys" ...`</span>
</span></span><span style="display:flex"><span>  <span style="color:#666">...</span>
</span></span><span style="display:flex"><span>}
</span></span></code></pre></div><p>You can also see the <code>retainKeys</code> strategy in the <a href="https://raw.githubusercontent.com/kubernetes/kubernetes/master/api/openapi-spec/swagger.json">OpenApi spec</a>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">"io.k8s.api.apps.v1.DeploymentSpec": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>...,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"strategy": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"$ref": </span><span style="color:#b44">"#/definitions/io.k8s.api.apps.v1.DeploymentStrategy"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"description": </span><span style="color:#b44">"The deployment strategy to use to replace existing pods with new ones."</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"x-kubernetes-patch-strategy": </span><span style="color:#b44">"retainKeys"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>....<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>And you can see the <code>retainKeys</code> strategy in the
<a href="/docs/reference/generated/kubernetes-api/v1.34/#deploymentspec-v1-apps">Kubernetes API documentation</a>.</p><h3 id="alternate-forms-of-the-kubectl-patch-command">Alternate forms of the kubectl patch command</h3><p>The <code>kubectl patch</code> command takes YAML or JSON. It can take the patch as a file or
directly on the command line.</p><p>Create a file named <code>patch-file.json</code> that has this content:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="display:flex"><span>{
</span></span><span style="display:flex"><span>   <span style="color:green;font-weight:700">"spec"</span>: {
</span></span><span style="display:flex"><span>      <span style="color:green;font-weight:700">"template"</span>: {
</span></span><span style="display:flex"><span>         <span style="color:green;font-weight:700">"spec"</span>: {
</span></span><span style="display:flex"><span>            <span style="color:green;font-weight:700">"containers"</span>: [
</span></span><span style="display:flex"><span>               {
</span></span><span style="display:flex"><span>                  <span style="color:green;font-weight:700">"name"</span>: <span style="color:#b44">"patch-demo-ctr-2"</span>,
</span></span><span style="display:flex"><span>                  <span style="color:green;font-weight:700">"image"</span>: <span style="color:#b44">"redis"</span>
</span></span><span style="display:flex"><span>               }
</span></span><span style="display:flex"><span>            ]
</span></span><span style="display:flex"><span>         }
</span></span><span style="display:flex"><span>      }
</span></span><span style="display:flex"><span>   }
</span></span><span style="display:flex"><span>}
</span></span></code></pre></div><p>The following commands are equivalent:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl patch deployment patch-demo --patch-file patch-file.yaml
</span></span><span style="display:flex"><span>kubectl patch deployment patch-demo --patch <span style="color:#b44">'spec:\n template:\n  spec:\n   containers:\n   - name: patch-demo-ctr-2\n     image: redis'</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>kubectl patch deployment patch-demo --patch-file patch-file.json
</span></span><span style="display:flex"><span>kubectl patch deployment patch-demo --patch <span style="color:#b44">'{"spec": {"template": {"spec": {"containers": [{"name": "patch-demo-ctr-2","image": "redis"}]}}}}'</span>
</span></span></code></pre></div><h3 id="scale-kubectl-patch">Update an object's replica count using <code>kubectl patch</code> with <code>--subresource</code></h3><p>The flag <code>--subresource=[subresource-name]</code> is used with kubectl commands like get, patch,
edit, apply and replace to fetch and update <code>status</code>, <code>scale</code> and <code>resize</code> subresource of the
resources you specify. You can specify a subresource for any of the Kubernetes API resources
(built-in and CRs) that have <code>status</code>, <code>scale</code> or <code>resize</code> subresource.</p><p>For example, a Deployment has a <code>status</code> subresource and a <code>scale</code> subresource, so you can
use <code>kubectl</code> to get or modify just the <code>status</code> subresource of a Deployment.</p><p>Here's a manifest for a Deployment that has two replicas:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/deployment.yaml" download="application/deployment.yaml"><code>application/deployment.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;application-deployment-yaml&quot;)" title="Copy application/deployment.yaml to clipboard"/></div><div class="includecode" id="application-deployment-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx-deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">2</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># tells deployment to run 2 pods matching the template</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>nginx:1.14.2<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>Create the Deployment:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f https://k8s.io/examples/application/deployment.yaml
</span></span></code></pre></div><p>View the Pods associated with your Deployment:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pods -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>nginx
</span></span></code></pre></div><p>In the output, you can see that Deployment has two Pods. For example:</p><pre tabindex="0"><code>NAME                                READY   STATUS    RESTARTS   AGE
nginx-deployment-7fb96c846b-22567   1/1     Running   0          47s
nginx-deployment-7fb96c846b-mlgns   1/1     Running   0          47s
</code></pre><p>Now, patch that Deployment with <code>--subresource=[subresource-name]</code> flag:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl patch deployment nginx-deployment --subresource<span style="color:#666">=</span><span style="color:#b44">'scale'</span> --type<span style="color:#666">=</span><span style="color:#b44">'merge'</span> -p <span style="color:#b44">'{"spec":{"replicas":3}}'</span>
</span></span></code></pre></div><p>The output is:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>scale.autoscaling/nginx-deployment patched
</span></span></code></pre></div><p>View the Pods associated with your patched Deployment:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pods -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>nginx
</span></span></code></pre></div><p>In the output, you can see one new pod is created, so now you have 3 running pods.</p><pre tabindex="0"><code>NAME                                READY   STATUS    RESTARTS   AGE
nginx-deployment-7fb96c846b-22567   1/1     Running   0          107s
nginx-deployment-7fb96c846b-lxfr2   1/1     Running   0          14s
nginx-deployment-7fb96c846b-mlgns   1/1     Running   0          107s
</code></pre><p>View the patched Deployment:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get deployment nginx-deployment -o yaml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#00f;font-weight:700">...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">3</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">status</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">availableReplicas</span>:<span style="color:#bbb"> </span><span style="color:#666">3</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">readyReplicas</span>:<span style="color:#bbb"> </span><span style="color:#666">3</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">3</span><span style="color:#bbb">
</span></span></span></code></pre></div><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>If you run <code>kubectl patch</code> and specify <code>--subresource</code> flag for resource that doesn't support that
particular subresource, the API server returns a 404 Not Found error.</div><h2 id="summary">Summary</h2><p>In this exercise, you used <code>kubectl patch</code> to change the live configuration
of a Deployment object. You did not change the configuration file that you originally used to
create the Deployment object. Other commands for updating API objects include
<a href="/docs/reference/generated/kubectl/kubectl-commands/#annotate">kubectl annotate</a>,
<a href="/docs/reference/generated/kubectl/kubectl-commands/#edit">kubectl edit</a>,
<a href="/docs/reference/generated/kubectl/kubectl-commands/#replace">kubectl replace</a>,
<a href="/docs/reference/generated/kubectl/kubectl-commands/#scale">kubectl scale</a>,
and
<a href="/docs/reference/generated/kubectl/kubectl-commands/#apply">kubectl apply</a>.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>Strategic merge patch is not supported for custom resources.</div><h2 id="what-s-next">What's next</h2><ul><li><a href="/docs/concepts/overview/working-with-objects/object-management/">Kubernetes Object Management</a></li><li><a href="/docs/tasks/manage-kubernetes-objects/imperative-command/">Managing Kubernetes Objects Using Imperative Commands</a></li><li><a href="/docs/tasks/manage-kubernetes-objects/imperative-config/">Imperative Management of Kubernetes Objects Using Configuration Files</a></li><li><a href="/docs/tasks/manage-kubernetes-objects/declarative-config/">Declarative Management of Kubernetes Objects Using Configuration Files</a></li></ul></div>
<hr>
<div class="td-content"><h1>Manage Cluster Daemons</h1><div class="lead">Perform common tasks for managing a DaemonSet, such as performing a rolling update.</div><div class="section-index"><hr class="panel-line"/><div class="entry"><h5><a href="/docs/tasks/manage-daemon/create-daemon-set/">Building a Basic DaemonSet</a></h5><p/></div><div class="entry"><h5><a href="/docs/tasks/manage-daemon/update-daemon-set/">Perform a Rolling Update on a DaemonSet</a></h5><p/></div><div class="entry"><h5><a href="/docs/tasks/manage-daemon/rollback-daemon-set/">Perform a Rollback on a DaemonSet</a></h5><p/></div><div class="entry"><h5><a href="/docs/tasks/manage-daemon/pods-some-nodes/">Running Pods on Only Some Nodes</a></h5><p/></div></div></div>
<hr>
<div class="td-content"><h1 data-pagefind-weight="10">Running Pods on Only Some Nodes</h1><p>This page demonstrates how can you run <a class="glossary-tooltip" title="A Pod represents a set of running containers in your cluster." data-toggle="tooltip" data-placement="top" href="/docs/concepts/workloads/pods/" target="_blank" aria-label="Pods">Pods</a> on only some <a class="glossary-tooltip" title="A node is a worker machine in Kubernetes." data-toggle="tooltip" data-placement="top" href="/docs/concepts/architecture/nodes/" target="_blank" aria-label="Nodes">Nodes</a> as part of a <a class="glossary-tooltip" title="Ensures a copy of a Pod is running across a set of nodes in a cluster." data-toggle="tooltip" data-placement="top" href="/docs/concepts/workloads/controllers/daemonset" target="_blank" aria-label="DaemonSet">DaemonSet</a></p><h2 id="before-you-begin">Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul><h2 id="running-pods-on-only-some-nodes">Running Pods on only some Nodes</h2><p>Imagine that you want to run a <a class="glossary-tooltip" title="Ensures a copy of a Pod is running across a set of nodes in a cluster." data-toggle="tooltip" data-placement="top" href="/docs/concepts/workloads/controllers/daemonset" target="_blank" aria-label="DaemonSet">DaemonSet</a>, but you only need to run those daemon pods
on nodes that have local solid state (SSD) storage. For example, the Pod might provide cache service to the
node, and the cache is only useful when low-latency local storage is available.</p><h3 id="step-1-add-labels-to-your-nodes">Step 1: Add labels to your nodes</h3><p>Add the label <code>ssd=true</code> to the nodes which have SSDs.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl label nodes example-node-1 example-node-2 <span style="color:#b8860b">ssd</span><span style="color:#666">=</span><span style="color:#a2f">true</span>
</span></span></code></pre></div><h3 id="step-2-create-the-manifest">Step 2: Create the manifest</h3><p>Let's create a <a class="glossary-tooltip" title="Ensures a copy of a Pod is running across a set of nodes in a cluster." data-toggle="tooltip" data-placement="top" href="/docs/concepts/workloads/controllers/daemonset" target="_blank" aria-label="DaemonSet">DaemonSet</a> which will provision the daemon pods on the SSD labeled <a class="glossary-tooltip" title="A node is a worker machine in Kubernetes." data-toggle="tooltip" data-placement="top" href="/docs/concepts/architecture/nodes/" target="_blank" aria-label="nodes">nodes</a> only.</p><p>Next, use a <code>nodeSelector</code> to ensure that the DaemonSet only runs Pods on nodes
with the <code>ssd</code> label set to <code>"true"</code>.</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/controllers/daemonset-label-selector.yaml" download="controllers/daemonset-label-selector.yaml"><code>controllers/daemonset-label-selector.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;controllers-daemonset-label-selector-yaml&quot;)" title="Copy controllers/daemonset-label-selector.yaml to clipboard"/></div><div class="includecode" id="controllers-daemonset-label-selector-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>DaemonSet<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>ssd-driver<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>ssd-driver-pod<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>ssd-driver-pod<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">nodeSelector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">ssd</span>:<span style="color:#bbb"> </span><span style="color:#b44">"true"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>example-container<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>example-image</span></span></code></pre></div></div></div><h3 id="step-3-create-the-daemonset">Step 3: Create the DaemonSet</h3><p>Create the DaemonSet from the manifest by using <code>kubectl create</code> or <code>kubectl apply</code></p><p>Let's label another node as <code>ssd=true</code>.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl label nodes example-node-3 <span style="color:#b8860b">ssd</span><span style="color:#666">=</span><span style="color:#a2f">true</span>
</span></span></code></pre></div><p>Labelling the node automatically triggers the control plane (specifically, the DaemonSet controller)
to run a new daemon pod on that node.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pods -o wide
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex="0"><code>NAME                              READY     STATUS    RESTARTS   AGE    IP      NODE
&lt;daemonset-name&gt;&lt;some-hash-01&gt;    1/1       Running   0          13s    .....   example-node-1
&lt;daemonset-name&gt;&lt;some-hash-02&gt;    1/1       Running   0          13s    .....   example-node-2
&lt;daemonset-name&gt;&lt;some-hash-03&gt;    1/1       Running   0          5s     .....   example-node-3
</code></pre></div>
<hr>
<div class="td-content"><h1 data-pagefind-weight="10">Perform a Rolling Update on a DaemonSet</h1><p>This page shows how to perform a rolling update on a DaemonSet.</p><h2 id="before-you-begin">Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul><h2 id="daemonset-update-strategy">DaemonSet Update Strategy</h2><p>DaemonSet has two update strategy types:</p><ul><li><code>OnDelete</code>: With <code>OnDelete</code> update strategy, after you update a DaemonSet template, new
DaemonSet pods will <em>only</em> be created when you manually delete old DaemonSet
pods. This is the same behavior of DaemonSet in Kubernetes version 1.5 or
before.</li><li><code>RollingUpdate</code>: This is the default update strategy.<br/>With <code>RollingUpdate</code> update strategy, after you update a
DaemonSet template, old DaemonSet pods will be killed, and new DaemonSet pods
will be created automatically, in a controlled fashion. At most one pod of
the DaemonSet will be running on each node during the whole update process.</li></ul><h2 id="performing-a-rolling-update">Performing a Rolling Update</h2><p>To enable the rolling update feature of a DaemonSet, you must set its
<code>.spec.updateStrategy.type</code> to <code>RollingUpdate</code>.</p><p>You may want to set
<a href="/docs/reference/kubernetes-api/workload-resources/daemon-set-v1/#DaemonSetSpec"><code>.spec.updateStrategy.rollingUpdate.maxUnavailable</code></a>
(default to 1),
<a href="/docs/reference/kubernetes-api/workload-resources/daemon-set-v1/#DaemonSetSpec"><code>.spec.minReadySeconds</code></a>
(default to 0) and
<a href="/docs/reference/kubernetes-api/workload-resources/daemon-set-v1/#DaemonSetSpec"><code>.spec.updateStrategy.rollingUpdate.maxSurge</code></a>
(defaults to 0) as well.</p><h3 id="creating-a-daemonset-with-rollingupdate-update-strategy">Creating a DaemonSet with <code>RollingUpdate</code> update strategy</h3><p>This YAML file specifies a DaemonSet with an update strategy as 'RollingUpdate'</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/controllers/fluentd-daemonset.yaml" download="controllers/fluentd-daemonset.yaml"><code>controllers/fluentd-daemonset.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;controllers-fluentd-daemonset-yaml&quot;)" title="Copy controllers/fluentd-daemonset.yaml to clipboard"/></div><div class="includecode" id="controllers-fluentd-daemonset-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>DaemonSet<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>fluentd-elasticsearch<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>kube-system<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">k8s-app</span>:<span style="color:#bbb"> </span>fluentd-logging<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>fluentd-elasticsearch<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">updateStrategy</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>RollingUpdate<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">rollingUpdate</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">maxUnavailable</span>:<span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>fluentd-elasticsearch<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">tolerations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># these tolerations are to have the daemonset runnable on control plane nodes</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># remove them if your control plane nodes should not run pods</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">key</span>:<span style="color:#bbb"> </span>node-role.kubernetes.io/control-plane<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">operator</span>:<span style="color:#bbb"> </span>Exists<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">effect</span>:<span style="color:#bbb"> </span>NoSchedule<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">key</span>:<span style="color:#bbb"> </span>node-role.kubernetes.io/master<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">operator</span>:<span style="color:#bbb"> </span>Exists<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">effect</span>:<span style="color:#bbb"> </span>NoSchedule<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>fluentd-elasticsearch<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>quay.io/fluentd_elasticsearch/fluentd:v5.0.1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">volumeMounts</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>varlog<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span>/var/log<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>varlibdockercontainers<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span>/var/lib/docker/containers<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">readOnly</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">terminationGracePeriodSeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">30</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>varlog<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">hostPath</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">path</span>:<span style="color:#bbb"> </span>/var/log<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>varlibdockercontainers<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">hostPath</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">path</span>:<span style="color:#bbb"> </span>/var/lib/docker/containers<span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>After verifying the update strategy of the DaemonSet manifest, create the DaemonSet:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl create -f https://k8s.io/examples/controllers/fluentd-daemonset.yaml
</span></span></code></pre></div><p>Alternatively, use <code>kubectl apply</code> to create the same DaemonSet if you plan to
update the DaemonSet with <code>kubectl apply</code>.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f https://k8s.io/examples/controllers/fluentd-daemonset.yaml
</span></span></code></pre></div><h3 id="checking-daemonset-rollingupdate-update-strategy">Checking DaemonSet <code>RollingUpdate</code> update strategy</h3><p>Check the update strategy of your DaemonSet, and make sure it's set to
<code>RollingUpdate</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get ds/fluentd-elasticsearch -o go-template<span style="color:#666">=</span><span style="color:#b44">'{{.spec.updateStrategy.type}}{{"\n"}}'</span> -n kube-system
</span></span></code></pre></div><p>If you haven't created the DaemonSet in the system, check your DaemonSet
manifest with the following command instead:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f https://k8s.io/examples/controllers/fluentd-daemonset.yaml --dry-run<span style="color:#666">=</span>client -o go-template<span style="color:#666">=</span><span style="color:#b44">'{{.spec.updateStrategy.type}}{{"\n"}}'</span>
</span></span></code></pre></div><p>The output from both commands should be:</p><pre tabindex="0"><code>RollingUpdate
</code></pre><p>If the output isn't <code>RollingUpdate</code>, go back and modify the DaemonSet object or
manifest accordingly.</p><h3 id="updating-a-daemonset-template">Updating a DaemonSet template</h3><p>Any updates to a <code>RollingUpdate</code> DaemonSet <code>.spec.template</code> will trigger a rolling
update. Let's update the DaemonSet by applying a new YAML file. This can be done with several different <code>kubectl</code> commands.</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/controllers/fluentd-daemonset-update.yaml" download="controllers/fluentd-daemonset-update.yaml"><code>controllers/fluentd-daemonset-update.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;controllers-fluentd-daemonset-update-yaml&quot;)" title="Copy controllers/fluentd-daemonset-update.yaml to clipboard"/></div><div class="includecode" id="controllers-fluentd-daemonset-update-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>DaemonSet<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>fluentd-elasticsearch<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>kube-system<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">k8s-app</span>:<span style="color:#bbb"> </span>fluentd-logging<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>fluentd-elasticsearch<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">updateStrategy</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>RollingUpdate<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">rollingUpdate</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">maxUnavailable</span>:<span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>fluentd-elasticsearch<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">tolerations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># these tolerations are to have the daemonset runnable on control plane nodes</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># remove them if your control plane nodes should not run pods</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">key</span>:<span style="color:#bbb"> </span>node-role.kubernetes.io/control-plane<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">operator</span>:<span style="color:#bbb"> </span>Exists<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">effect</span>:<span style="color:#bbb"> </span>NoSchedule<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">key</span>:<span style="color:#bbb"> </span>node-role.kubernetes.io/master<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">operator</span>:<span style="color:#bbb"> </span>Exists<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">effect</span>:<span style="color:#bbb"> </span>NoSchedule<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>fluentd-elasticsearch<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>quay.io/fluentd_elasticsearch/fluentd:v5.0.1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">limits</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">memory</span>:<span style="color:#bbb"> </span>200Mi<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">requests</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">cpu</span>:<span style="color:#bbb"> </span>100m<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">memory</span>:<span style="color:#bbb"> </span>200Mi<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">volumeMounts</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>varlog<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span>/var/log<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>varlibdockercontainers<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span>/var/lib/docker/containers<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">readOnly</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">terminationGracePeriodSeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">30</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>varlog<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">hostPath</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">path</span>:<span style="color:#bbb"> </span>/var/log<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>varlibdockercontainers<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">hostPath</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">path</span>:<span style="color:#bbb"> </span>/var/lib/docker/containers<span style="color:#bbb">
</span></span></span></code></pre></div></div></div><h4 id="declarative-commands">Declarative commands</h4><p>If you update DaemonSets using
<a href="/docs/tasks/manage-kubernetes-objects/declarative-config/">configuration files</a>,
use <code>kubectl apply</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f https://k8s.io/examples/controllers/fluentd-daemonset-update.yaml
</span></span></code></pre></div><h4 id="imperative-commands">Imperative commands</h4><p>If you update DaemonSets using
<a href="/docs/tasks/manage-kubernetes-objects/imperative-command/">imperative commands</a>,
use <code>kubectl edit</code> :</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl edit ds/fluentd-elasticsearch -n kube-system
</span></span></code></pre></div><h5 id="updating-only-the-container-image">Updating only the container image</h5><p>If you only need to update the container image in the DaemonSet template, i.e.
<code>.spec.template.spec.containers[*].image</code>, use <code>kubectl set image</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl <span style="color:#a2f">set</span> image ds/fluentd-elasticsearch fluentd-elasticsearch<span style="color:#666">=</span>quay.io/fluentd_elasticsearch/fluentd:v2.6.0 -n kube-system
</span></span></code></pre></div><h3 id="watching-the-rolling-update-status">Watching the rolling update status</h3><p>Finally, watch the rollout status of the latest DaemonSet rolling update:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl rollout status ds/fluentd-elasticsearch -n kube-system
</span></span></code></pre></div><p>When the rollout is complete, the output is similar to this:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>daemonset <span style="color:#b44">"fluentd-elasticsearch"</span> successfully rolled out
</span></span></code></pre></div><h2 id="troubleshooting">Troubleshooting</h2><h3 id="daemonset-rolling-update-is-stuck">DaemonSet rolling update is stuck</h3><p>Sometimes, a DaemonSet rolling update may be stuck. Here are some possible
causes:</p><h4 id="some-nodes-run-out-of-resources">Some nodes run out of resources</h4><p>The rollout is stuck because new DaemonSet pods can't be scheduled on at least one
node. This is possible when the node is
<a href="/docs/concepts/scheduling-eviction/node-pressure-eviction/">running out of resources</a>.</p><p>When this happens, find the nodes that don't have the DaemonSet pods scheduled on
by comparing the output of <code>kubectl get nodes</code> and the output of:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pods -l <span style="color:#b8860b">name</span><span style="color:#666">=</span>fluentd-elasticsearch -o wide -n kube-system
</span></span></code></pre></div><p>Once you've found those nodes, delete some non-DaemonSet pods from the node to
make room for new DaemonSet pods.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>This will cause service disruption when deleted pods are not controlled by any controllers or pods are not
replicated. This does not respect <a href="/docs/tasks/run-application/configure-pdb/">PodDisruptionBudget</a>
either.</div><h4 id="broken-rollout">Broken rollout</h4><p>If the recent DaemonSet template update is broken, for example, the container is
crash looping, or the container image doesn't exist (often due to a typo),
DaemonSet rollout won't progress.</p><p>To fix this, update the DaemonSet template again. New rollout won't be
blocked by previous unhealthy rollouts.</p><h4 id="clock-skew">Clock skew</h4><p>If <code>.spec.minReadySeconds</code> is specified in the DaemonSet, clock skew between
master and nodes will make DaemonSet unable to detect the right rollout
progress.</p><h2 id="clean-up">Clean up</h2><p>Delete DaemonSet from a namespace :</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl delete ds fluentd-elasticsearch -n kube-system
</span></span></code></pre></div><h2 id="what-s-next">What's next</h2><ul><li>See <a href="/docs/tasks/manage-daemon/rollback-daemon-set/">Performing a rollback on a DaemonSet</a></li><li>See <a href="/docs/concepts/workloads/controllers/daemonset/">Creating a DaemonSet to adopt existing DaemonSet pods</a></li></ul></div>
<hr>
<div class="td-content"><h1 data-pagefind-weight="10">Building a Basic DaemonSet</h1><p>This page demonstrates how to build a basic <a class="glossary-tooltip" title="Ensures a copy of a Pod is running across a set of nodes in a cluster." data-toggle="tooltip" data-placement="top" href="/docs/concepts/workloads/controllers/daemonset" target="_blank" aria-label="DaemonSet">DaemonSet</a>
that runs a Pod on every node in a Kubernetes cluster.
It covers a simple use case of mounting a file from the host, logging its contents using
an <a href="/docs/concepts/workloads/pods/init-containers/">init container</a>, and utilizing a pause container.</p><h2 id="before-you-begin">Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul><p>A Kubernetes cluster with at least two nodes (one control plane node and one worker node)
to demonstrate the behavior of DaemonSets.</p><h2 id="define-the-daemonset">Define the DaemonSet</h2><p>In this task, a basic DaemonSet is created which ensures that the copy of a Pod is scheduled on every node.
The Pod will use an init container to read and log the contents of <code>/etc/machine-id</code> from the host,
while the main container will be a <code>pause</code> container, which keeps the Pod running.</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/basic-daemonset.yaml" download="application/basic-daemonset.yaml"><code>application/basic-daemonset.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;application-basic-daemonset-yaml&quot;)" title="Copy application/basic-daemonset.yaml to clipboard"/></div><div class="includecode" id="application-basic-daemonset-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>DaemonSet<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>example-daemonset<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">app.kubernetes.io/name</span>:<span style="color:#bbb"> </span>example<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app.kubernetes.io/name</span>:<span style="color:#bbb"> </span>example<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>pause<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>registry.k8s.io/pause<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">initContainers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>log-machine-id<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>busybox:1.37<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">command</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">'sh'</span>,<span style="color:#bbb"> </span><span style="color:#b44">'-c'</span>,<span style="color:#bbb"> </span><span style="color:#b44">'cat /etc/machine-id &gt; /var/log/machine-id.log'</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">volumeMounts</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>machine-id<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span>/etc/machine-id<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">readOnly</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>log-dir<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span>/var/log<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>machine-id<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">hostPath</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">path</span>:<span style="color:#bbb"> </span>/etc/machine-id<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>File<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>log-dir<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">hostPath</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">path</span>:<span style="color:#bbb"> </span>/var/log</span></span></code></pre></div></div></div><ol><li><p>Create a DaemonSet based on the (YAML) manifest:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f https://k8s.io/examples/application/basic-daemonset.yaml
</span></span></code></pre></div></li><li><p>Once applied, you can verify that the DaemonSet is running a Pod on every node in the cluster:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pods -o wide
</span></span></code></pre></div><p>The output will list one Pod per node, similar to:</p><pre tabindex="0"><code>NAME                                READY   STATUS    RESTARTS   AGE    IP       NODE
example-daemonset-xxxxx             1/1     Running   0          5m     x.x.x.x  node-1
example-daemonset-yyyyy             1/1     Running   0          5m     x.x.x.x  node-2
</code></pre></li><li><p>You can inspect the contents of the logged <code>/etc/machine-id</code> file by checking
the log directory mounted from the host:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl <span style="color:#a2f">exec</span> &lt;pod-name&gt; -- cat /var/log/machine-id.log
</span></span></code></pre></div><p>Where <code>&lt;pod-name&gt;</code> is the name of one of your Pods.</p></li></ol><h2 id="cleaning-up">Cleaning up</h2><p>To delete the DaemonSet, run this command:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl delete --cascade<span style="color:#666">=</span>foreground --ignore-not-found --now daemonsets/example-daemonset
</span></span></code></pre></div><p>This simple DaemonSet example introduces key components like init containers and host path volumes,
which can be expanded upon for more advanced use cases. For more details refer to
<a href="/docs/concepts/workloads/controllers/daemonset/">DaemonSet</a>.</p><h2 id="what-s-next">What's next</h2><ul><li>See <a href="/docs/tasks/manage-daemon/update-daemon-set/">Performing a rolling update on a DaemonSet</a></li><li>See <a href="/docs/concepts/workloads/controllers/daemonset/">Creating a DaemonSet to adopt existing DaemonSet pods</a></li></ul></div>
<hr>
<div class="td-content"><h1 data-pagefind-weight="10">Schedule GPUs</h1><div class="lead">Configure and schedule GPUs for use as a resource by nodes in a cluster.</div><div class="feature-state-notice feature-stable"><span class="feature-state-name">FEATURE STATE:</span>
<code>Kubernetes v1.26 [stable]</code></div><p>Kubernetes includes <strong>stable</strong> support for managing AMD and NVIDIA GPUs
(graphical processing units) across different nodes in your cluster, using
<a class="glossary-tooltip" title="Software extensions to let Pods access devices that need vendor-specific initialization or setup" data-toggle="tooltip" data-placement="top" href="/docs/concepts/extend-kubernetes/compute-storage-net/device-plugins/" target="_blank" aria-label="device plugins">device plugins</a>.</p><p>This page describes how users can consume GPUs, and outlines
some of the limitations in the implementation.</p><h2 id="using-device-plugins">Using device plugins</h2><p>Kubernetes implements device plugins to let Pods access specialized hardware features such as GPUs.</p><div class="alert alert-secondary callout third-party-content" role="alert"><strong>Note:</strong>This section links to third party projects that provide functionality required by Kubernetes. The Kubernetes project authors aren't responsible for these projects, which are listed alphabetically. To add a project to this list, read the <a href="/docs/contribute/style/content-guide/#third-party-content">content guide</a> before submitting a change. <a href="#third-party-content-disclaimer">More information.</a></div><p>As an administrator, you have to install GPU drivers from the corresponding
hardware vendor on the nodes and run the corresponding device plugin from the
GPU vendor. Here are some links to vendors' instructions:</p><ul><li><a href="https://github.com/ROCm/k8s-device-plugin#deployment">AMD</a></li><li><a href="https://intel.github.io/intel-device-plugins-for-kubernetes/cmd/gpu_plugin/README.html">Intel</a></li><li><a href="https://github.com/NVIDIA/k8s-device-plugin#quick-start">NVIDIA</a></li></ul><p>Once you have installed the plugin, your cluster exposes a custom schedulable resource such as <code>amd.com/gpu</code> or <code>nvidia.com/gpu</code>.</p><p>You can consume these GPUs from your containers by requesting
the custom GPU resource, the same way you request <code>cpu</code> or <code>memory</code>.
However, there are some limitations in how you specify the resource
requirements for custom devices.</p><p>GPUs are only supposed to be specified in the <code>limits</code> section, which means:</p><ul><li>You can specify GPU <code>limits</code> without specifying <code>requests</code>, because
Kubernetes will use the limit as the request value by default.</li><li>You can specify GPU in both <code>limits</code> and <code>requests</code> but these two values
must be equal.</li><li>You cannot specify GPU <code>requests</code> without specifying <code>limits</code>.</li></ul><p>Here's an example manifest for a Pod that requests a GPU:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Pod<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>example-vector-add<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">restartPolicy</span>:<span style="color:#bbb"> </span>OnFailure<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>example-vector-add<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span><span style="color:#b44">"registry.example/example-vector-add:v42"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">limits</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">gpu-vendor.example/example-gpu</span>:<span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># requesting 1 GPU</span><span style="color:#bbb">
</span></span></span></code></pre></div><h2 id="manage-clusters-with-different-types-of-gpus">Manage clusters with different types of GPUs</h2><p>If different nodes in your cluster have different types of GPUs, then you
can use <a href="/docs/tasks/configure-pod-container/assign-pods-nodes/">Node Labels and Node Selectors</a>
to schedule pods to appropriate nodes.</p><p>For example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Label your nodes with the accelerator type they have.</span>
</span></span><span style="display:flex"><span>kubectl label nodes node1 <span style="color:#b8860b">accelerator</span><span style="color:#666">=</span>example-gpu-x100
</span></span><span style="display:flex"><span>kubectl label nodes node2 <span style="color:#b8860b">accelerator</span><span style="color:#666">=</span>other-gpu-k915
</span></span></code></pre></div><p>That label key <code>accelerator</code> is just an example; you can use
a different label key if you prefer.</p><h2 id="node-labeller">Automatic node labelling</h2><p>As an administrator, you can automatically discover and label all your GPU enabled nodes
by deploying Kubernetes <a href="https://github.com/kubernetes-sigs/node-feature-discovery">Node Feature Discovery</a> (NFD).
NFD detects the hardware features that are available on each node in a Kubernetes cluster.
Typically, NFD is configured to advertise those features as node labels, but NFD can also add extended resources, annotations, and node taints.
NFD is compatible with all <a href="/releases/version-skew-policy/#supported-versions">supported versions</a> of Kubernetes.
By default NFD create the <a href="https://kubernetes-sigs.github.io/node-feature-discovery/master/usage/features.html">feature labels</a> for the detected features.
Administrators can leverage NFD to also taint nodes with specific features, so that only pods that request those features can be scheduled on those nodes.</p><p>You also need a plugin for NFD that adds appropriate labels to your nodes; these might be generic
labels or they could be vendor specific. Your GPU vendor may provide a third party
plugin for NFD; check their documentation for more details.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Pod<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>example-vector-add<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">restartPolicy</span>:<span style="color:#bbb"> </span>OnFailure<span style="color:#bbb">
</span></span></span><span style="display:flex;background-color:#dfdfdf"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># You can use Kubernetes node affinity to schedule this Pod onto a node</span><span style="color:#bbb">
</span></span></span><span style="display:flex;background-color:#dfdfdf"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># that provides the kind of GPU that its container needs in order to work</span><span style="color:#bbb">
</span></span></span><span style="display:flex;background-color:#dfdfdf"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">affinity</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;background-color:#dfdfdf"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">nodeAffinity</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;background-color:#dfdfdf"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">requiredDuringSchedulingIgnoredDuringExecution</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;background-color:#dfdfdf"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">nodeSelectorTerms</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;background-color:#dfdfdf"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">matchExpressions</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;background-color:#dfdfdf"><span><span style="color:#bbb">          </span>- <span style="color:green;font-weight:700">key</span>:<span style="color:#bbb"> </span><span style="color:#b44">"gpu.gpu-vendor.example/installed-memory"</span><span style="color:#bbb">
</span></span></span><span style="display:flex;background-color:#dfdfdf"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">operator</span>:<span style="color:#bbb"> </span>Gt<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># (greater than)</span><span style="color:#bbb">
</span></span></span><span style="display:flex;background-color:#dfdfdf"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">values</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"40535"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex;background-color:#dfdfdf"><span><span style="color:#bbb">          </span>- <span style="color:green;font-weight:700">key</span>:<span style="color:#bbb"> </span><span style="color:#b44">"feature.node.kubernetes.io/pci-10.present"</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># NFD Feature label</span><span style="color:#bbb">
</span></span></span><span style="display:flex;background-color:#dfdfdf"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">values</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"true"</span>]<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># (optional) only schedule on nodes with PCI device 10</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>example-vector-add<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span><span style="color:#b44">"registry.example/example-vector-add:v42"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">limits</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">gpu-vendor.example/example-gpu</span>:<span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># requesting 1 GPU</span></span></span></code></pre></div><h4 id="gpu-vendor-implementations">GPU vendor implementations</h4><ul><li><a href="https://intel.github.io/intel-device-plugins-for-kubernetes/cmd/gpu_plugin/README.html">Intel</a></li><li><a href="https://github.com/NVIDIA/k8s-device-plugin">NVIDIA</a></li></ul></div>
<hr>
<div class="td-content"><h1 data-pagefind-weight="10">Imperative Management of Kubernetes Objects Using Configuration Files</h1><p>Kubernetes objects can be created, updated, and deleted by using the <code>kubectl</code>
command-line tool along with an object configuration file written in YAML or JSON.
This document explains how to define and manage objects using configuration files.</p><h2 id="before-you-begin">Before you begin</h2><p>Install <a href="/docs/tasks/tools/"><code>kubectl</code></a>.</p><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul><p>To check the version, enter <code>kubectl version</code>.</p></p><h2 id="trade-offs">Trade-offs</h2><p>The <code>kubectl</code> tool supports three kinds of object management:</p><ul><li>Imperative commands</li><li>Imperative object configuration</li><li>Declarative object configuration</li></ul><p>See <a href="/docs/concepts/overview/working-with-objects/object-management/">Kubernetes Object Management</a>
for a discussion of the advantages and disadvantage of each kind of object management.</p><h2 id="how-to-create-objects">How to create objects</h2><p>You can use <code>kubectl create -f</code> to create an object from a configuration file.
Refer to the <a href="/docs/reference/generated/kubernetes-api/v1.34/">kubernetes API reference</a>
for details.</p><ul><li><code>kubectl create -f &lt;filename|url&gt;</code></li></ul><h2 id="how-to-update-objects">How to update objects</h2><div class="alert alert-danger" role="alert"><h4 class="alert-heading">Warning:</h4>Updating objects with the <code>replace</code> command drops all
parts of the spec not specified in the configuration file. This
should not be used with objects whose specs are partially managed
by the cluster, such as Services of type <code>LoadBalancer</code>, where
the <code>externalIPs</code> field is managed independently from the configuration
file. Independently managed fields must be copied to the configuration
file to prevent <code>replace</code> from dropping them.</div><p>You can use <code>kubectl replace -f</code> to update a live object according to a
configuration file.</p><ul><li><code>kubectl replace -f &lt;filename|url&gt;</code></li></ul><h2 id="how-to-delete-objects">How to delete objects</h2><p>You can use <code>kubectl delete -f</code> to delete an object that is described in a
configuration file.</p><ul><li><code>kubectl delete -f &lt;filename|url&gt;</code></li></ul><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4><p>If configuration file has specified the <code>generateName</code> field in the <code>metadata</code>
section instead of the <code>name</code> field, you cannot delete the object using
<code>kubectl delete -f &lt;filename|url&gt;</code>.
You will have to use other flags for deleting the object. For example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl delete &lt;type&gt; &lt;name&gt;
</span></span><span style="display:flex"><span>kubectl delete &lt;type&gt; -l &lt;label&gt;
</span></span></code></pre></div></div><h2 id="how-to-view-an-object">How to view an object</h2><p>You can use <code>kubectl get -f</code> to view information about an object that is
described in a configuration file.</p><ul><li><code>kubectl get -f &lt;filename|url&gt; -o yaml</code></li></ul><p>The <code>-o yaml</code> flag specifies that the full object configuration is printed.
Use <code>kubectl get -h</code> to see a list of options.</p><h2 id="limitations">Limitations</h2><p>The <code>create</code>, <code>replace</code>, and <code>delete</code> commands work well when each object's
configuration is fully defined and recorded in its configuration
file. However when a live object is updated, and the updates are not merged
into its configuration file, the updates will be lost the next time a <code>replace</code>
is executed. This can happen if a controller, such as
a HorizontalPodAutoscaler, makes updates directly to a live object. Here's
an example:</p><ol><li>You create an object from a configuration file.</li><li>Another source updates the object by changing some field.</li><li>You replace the object from the configuration file. Changes made by
the other source in step 2 are lost.</li></ol><p>If you need to support multiple writers to the same object, you can use
<code>kubectl apply</code> to manage the object.</p><h2 id="creating-and-editing-an-object-from-a-url-without-saving-the-configuration">Creating and editing an object from a URL without saving the configuration</h2><p>Suppose you have the URL of an object configuration file. You can use
<code>kubectl create --edit</code> to make changes to the configuration before the
object is created. This is particularly useful for tutorials and tasks
that point to a configuration file that could be modified by the reader.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl create -f &lt;url&gt; --edit
</span></span></code></pre></div><h2 id="migrating-from-imperative-commands-to-imperative-object-configuration">Migrating from imperative commands to imperative object configuration</h2><p>Migrating from imperative commands to imperative object configuration involves
several manual steps.</p><ol><li><p>Export the live object to a local object configuration file:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get &lt;kind&gt;/&lt;name&gt; -o yaml &gt; &lt;kind&gt;_&lt;name&gt;.yaml
</span></span></code></pre></div></li><li><p>Manually remove the status field from the object configuration file.</p></li><li><p>For subsequent object management, use <code>replace</code> exclusively.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl replace -f &lt;kind&gt;_&lt;name&gt;.yaml
</span></span></code></pre></div></li></ol><h2 id="defining-controller-selectors-and-podtemplate-labels">Defining controller selectors and PodTemplate labels</h2><div class="alert alert-danger" role="alert"><h4 class="alert-heading">Warning:</h4>Updating selectors on controllers is strongly discouraged.</div><p>The recommended approach is to define a single, immutable PodTemplate label
used only by the controller selector with no other semantic meaning.</p><p>Example label:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">controller-selector</span>:<span style="color:#bbb"> </span><span style="color:#b44">"apps/v1/deployment/nginx"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">controller-selector</span>:<span style="color:#bbb"> </span><span style="color:#b44">"apps/v1/deployment/nginx"</span><span style="color:#bbb">
</span></span></span></code></pre></div><h2 id="what-s-next">What's next</h2><ul><li><a href="/docs/tasks/manage-kubernetes-objects/imperative-command/">Managing Kubernetes Objects Using Imperative Commands</a></li><li><a href="/docs/tasks/manage-kubernetes-objects/declarative-config/">Declarative Management of Kubernetes Objects Using Configuration Files</a></li><li><a href="/docs/reference/generated/kubectl/kubectl-commands/">Kubectl Command Reference</a></li><li><a href="/docs/reference/generated/kubernetes-api/v1.34/">Kubernetes API Reference</a></li></ul></div>
<hr>
<div class="td-content"><h1>Manage Kubernetes Objects</h1><div class="lead">Declarative and imperative paradigms for interacting with the Kubernetes API.</div><div class="section-index"><hr class="panel-line"/><div class="entry"><h5><a href="/docs/tasks/manage-kubernetes-objects/declarative-config/">Declarative Management of Kubernetes Objects Using Configuration Files</a></h5><p/></div><div class="entry"><h5><a href="/docs/tasks/manage-kubernetes-objects/kustomization/">Declarative Management of Kubernetes Objects Using Kustomize</a></h5><p/></div><div class="entry"><h5><a href="/docs/tasks/manage-kubernetes-objects/imperative-command/">Managing Kubernetes Objects Using Imperative Commands</a></h5><p/></div><div class="entry"><h5><a href="/docs/tasks/manage-kubernetes-objects/imperative-config/">Imperative Management of Kubernetes Objects Using Configuration Files</a></h5><p/></div><div class="entry"><h5><a href="/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/">Update API Objects in Place Using kubectl patch</a></h5><p>Use kubectl patch to update Kubernetes API objects in place. Do a strategic merge patch or a JSON merge patch.</p></div><div class="entry"><h5><a href="/docs/tasks/manage-kubernetes-objects/storage-version-migration/">Migrate Kubernetes Objects Using Storage Version Migration</a></h5><p/></div></div></div>
<hr>
<div class="td-content"><h1 data-pagefind-weight="10">Manage HugePages</h1><div class="lead">Configure and manage huge pages as a schedulable resource in a cluster.</div><div class="feature-state-notice feature-stable" title="Feature Gate: HugePages"><span class="feature-state-name">FEATURE STATE:</span>
<code>Kubernetes v1.14 [stable]</code> (enabled by default: true)</div><p>Kubernetes supports the allocation and consumption of pre-allocated huge pages
by applications in a Pod. This page describes how users can consume huge pages.</p><h2 id="before-you-begin">Before you begin</h2><p>Kubernetes nodes must
<a href="https://www.kernel.org/doc/html/latest/admin-guide/mm/hugetlbpage.html">pre-allocate huge pages</a>
in order for the node to report its huge page capacity.</p><p>A node can pre-allocate huge pages for multiple sizes, for instance,
the following line in <code>/etc/default/grub</code> allocates <code>2*1GiB</code> of 1 GiB
and <code>512*2 MiB</code> of 2 MiB pages:</p><pre tabindex="0"><code>GRUB_CMDLINE_LINUX="hugepagesz=1G hugepages=2 hugepagesz=2M hugepages=512"
</code></pre><p>The nodes will automatically discover and report all huge page resources as
schedulable resources.</p><p>When you describe the Node, you should see something similar to the following
in the following in the <code>Capacity</code> and <code>Allocatable</code> sections:</p><pre tabindex="0"><code>Capacity:
  cpu:                ...
  ephemeral-storage:  ...
  hugepages-1Gi:      2Gi
  hugepages-2Mi:      1Gi
  memory:             ...
  pods:               ...
Allocatable:
  cpu:                ...
  ephemeral-storage:  ...
  hugepages-1Gi:      2Gi
  hugepages-2Mi:      1Gi
  memory:             ...
  pods:               ...
</code></pre><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>For dynamically allocated pages (after boot), the Kubelet needs to be restarted
for the new allocations to be refrelected.</div><h2 id="api">API</h2><p>Huge pages can be consumed via container level resource requirements using the
resource name <code>hugepages-&lt;size&gt;</code>, where <code>&lt;size&gt;</code> is the most compact binary
notation using integer values supported on a particular node. For example, if a
node supports 2048KiB and 1048576KiB page sizes, it will expose a schedulable
resources <code>hugepages-2Mi</code> and <code>hugepages-1Gi</code>. Unlike CPU or memory, huge pages
do not support overcommit. Note that when requesting hugepage resources, either
memory or CPU resources must be requested as well.</p><p>A pod may consume multiple huge page sizes in a single pod spec. In this case it
must use <code>medium: HugePages-&lt;hugepagesize&gt;</code> notation for all volume mounts.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Pod<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>huge-pages-example<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>example<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>fedora:latest<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">command</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- sleep<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- inf<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">volumeMounts</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span>/hugepages-2Mi<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>hugepage-2mi<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span>/hugepages-1Gi<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>hugepage-1gi<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">limits</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">hugepages-2Mi</span>:<span style="color:#bbb"> </span>100Mi<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">hugepages-1Gi</span>:<span style="color:#bbb"> </span>2Gi<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">memory</span>:<span style="color:#bbb"> </span>100Mi<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">requests</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">memory</span>:<span style="color:#bbb"> </span>100Mi<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>hugepage-2mi<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">emptyDir</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">medium</span>:<span style="color:#bbb"> </span>HugePages-2Mi<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>hugepage-1gi<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">emptyDir</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">medium</span>:<span style="color:#bbb"> </span>HugePages-1Gi<span style="color:#bbb">
</span></span></span></code></pre></div><p>A pod may use <code>medium: HugePages</code> only if it requests huge pages of one size.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Pod<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>huge-pages-example<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>example<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>fedora:latest<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">command</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- sleep<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- inf<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">volumeMounts</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span>/hugepages<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>hugepage<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">limits</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">hugepages-2Mi</span>:<span style="color:#bbb"> </span>100Mi<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">memory</span>:<span style="color:#bbb"> </span>100Mi<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">requests</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">memory</span>:<span style="color:#bbb"> </span>100Mi<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>hugepage<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">emptyDir</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">medium</span>:<span style="color:#bbb"> </span>HugePages<span style="color:#bbb">
</span></span></span></code></pre></div><ul><li>Huge page requests must equal the limits. This is the default if limits are
specified, but requests are not.</li><li>Huge pages are isolated at a container scope, so each container has own
limit on their cgroup sandbox as requested in a container spec.</li><li>EmptyDir volumes backed by huge pages may not consume more huge page memory
than the pod request.</li><li>Applications that consume huge pages via <code>shmget()</code> with <code>SHM_HUGETLB</code> must
run with a supplemental group that matches <code>proc/sys/vm/hugetlb_shm_group</code>.</li><li>Huge page usage in a namespace is controllable via ResourceQuota similar
to other compute resources like <code>cpu</code> or <code>memory</code> using the <code>hugepages-&lt;size&gt;</code>
token.</li></ul></div>
<hr>
<div class="td-content"><h1 data-pagefind-weight="10">Migrate Kubernetes Objects Using Storage Version Migration</h1><div class="feature-state-notice feature-alpha" title="Feature Gate: StorageVersionMigrator"><span class="feature-state-name">FEATURE STATE:</span>
<code>Kubernetes v1.30 [alpha]</code> (enabled by default: false)</div><p>Kubernetes relies on API data being actively re-written, to support some
maintenance activities related to at rest storage. Two prominent examples are
the versioned schema of stored resources (that is, the preferred storage schema
changing from v1 to v2 for a given resource) and encryption at rest
(that is, rewriting stale data based on a change in how the data should be encrypted).</p><h2 id="before-you-begin">Before you begin</h2><p>Install <a href="/docs/tasks/tools/#kubectl"><code>kubectl</code></a>.</p><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul>Your Kubernetes server must be at or later than version v1.30.<p>To check the version, enter <code>kubectl version</code>.</p></p><p>Ensure that your cluster has the <code>StorageVersionMigrator</code> and <code>InformerResourceVersion</code>
<a href="/docs/reference/command-line-tools-reference/feature-gates/">feature gates</a>
enabled. You will need control plane administrator access to make that change.</p><p>Enable storage version migration REST api by setting runtime config
<code>storagemigration.k8s.io/v1alpha1</code> to <code>true</code> for the API server. For more information on
how to do that,
read <a href="/docs/tasks/administer-cluster/enable-disable-api/">enable or disable a Kubernetes API</a>.</p><h2 id="re-encrypt-kubernetes-secrets-using-storage-version-migration">Re-encrypt Kubernetes secrets using storage version migration</h2><ul><li><p>To begin with, <a href="/docs/tasks/administer-cluster/kms-provider/">configure KMS provider</a>
to encrypt data at rest in etcd using following encryption configuration.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>EncryptionConfiguration<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiserver.config.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- secrets<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">providers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">aescbc</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">keys</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>key1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">secret</span>:<span style="color:#bbb"> </span>c2VjcmV0IGlzIHNlY3VyZQ==<span style="color:#bbb">
</span></span></span></code></pre></div><p>Make sure to enable automatic reload of encryption
configuration file by setting <code>--encryption-provider-config-automatic-reload</code> to true.</p></li><li><p>Create a Secret using kubectl.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl create secret generic my-secret --from-literal<span style="color:#666">=</span><span style="color:#b8860b">key1</span><span style="color:#666">=</span>supersecret
</span></span></code></pre></div></li><li><p><a href="/docs/tasks/administer-cluster/kms-provider/#verifying-that-the-data-is-encrypted">Verify</a>
the serialized data for that Secret object is prefixed with <code>k8s:enc:aescbc:v1:key1</code>.</p></li><li><p>Update the encryption configuration file as follows to rotate the encryption key.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>EncryptionConfiguration<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiserver.config.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- secrets<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">providers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">aescbc</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">keys</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>key2<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">secret</span>:<span style="color:#bbb"> </span>c2VjcmV0IGlzIHNlY3VyZSwgaXMgaXQ/<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">aescbc</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">keys</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>key1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">secret</span>:<span style="color:#bbb"> </span>c2VjcmV0IGlzIHNlY3VyZQ==<span style="color:#bbb">
</span></span></span></code></pre></div></li><li><p>To ensure that previously created secret <code>my-secret</code> is re-encrypted
with new key <code>key2</code>, you will use <em>Storage Version Migration</em>.</p></li><li><p>Create a StorageVersionMigration manifest named <code>migrate-secret.yaml</code> as follows:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>StorageVersionMigration<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>storagemigration.k8s.io/v1alpha1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>secrets-migration<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">resource</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">group</span>:<span style="color:#bbb"> </span><span style="color:#b44">""</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">version</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">resource</span>:<span style="color:#bbb"> </span>secrets<span style="color:#bbb">
</span></span></span></code></pre></div><p>Create the object using <em>kubectl</em> as follows:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f migrate-secret.yaml
</span></span></code></pre></div></li><li><p>Monitor migration of Secrets by checking the <code>.status</code> of the StorageVersionMigration.
A successful migration should have its
<code>Succeeded</code> condition set to true. Get the StorageVersionMigration object as follows:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get storageversionmigration.storagemigration.k8s.io/secrets-migration -o yaml
</span></span></code></pre></div><p>The output is similar to:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>StorageVersionMigration<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>storagemigration.k8s.io/v1alpha1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>secrets-migration<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">uid</span>:<span style="color:#bbb"> </span>628f6922-a9cb-4514-b076-12d3c178967c<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">resourceVersion</span>:<span style="color:#bbb"> </span><span style="color:#b44">"90"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">creationTimestamp</span>:<span style="color:#bbb"> </span><span style="color:#b44">"2024-03-12T20:29:45Z"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">resource</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">group</span>:<span style="color:#bbb"> </span><span style="color:#b44">""</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">version</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">resource</span>:<span style="color:#bbb"> </span>secrets<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">status</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">conditions</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>Running<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">status</span>:<span style="color:#bbb"> </span><span style="color:#b44">"False"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">lastUpdateTime</span>:<span style="color:#bbb"> </span><span style="color:#b44">"2024-03-12T20:29:46Z"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">reason</span>:<span style="color:#bbb"> </span>StorageVersionMigrationInProgress<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>Succeeded<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">status</span>:<span style="color:#bbb"> </span><span style="color:#b44">"True"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">lastUpdateTime</span>:<span style="color:#bbb"> </span><span style="color:#b44">"2024-03-12T20:29:46Z"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">reason</span>:<span style="color:#bbb"> </span>StorageVersionMigrationSucceeded<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">resourceVersion</span>:<span style="color:#bbb"> </span><span style="color:#b44">"84"</span><span style="color:#bbb">
</span></span></span></code></pre></div></li><li><p><a href="/docs/tasks/administer-cluster/kms-provider/#verifying-that-the-data-is-encrypted">Verify</a>
the stored secret is now prefixed with <code>k8s:enc:aescbc:v1:key2</code>.</p></li></ul><h2 id="update-the-preferred-storage-schema-of-a-crd">Update the preferred storage schema of a CRD</h2><p>Consider a scenario where a <a class="glossary-tooltip" title="Custom code that defines a resource to add to your Kubernetes API server without building a complete custom server." data-toggle="tooltip" data-placement="top" href="/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/" target="_blank" aria-label="CustomResourceDefinition">CustomResourceDefinition</a>
(CRD) is created to serve custom resources (CRs) and is set as the preferred storage schema. When it's time
to introduce v2 of the CRD, it can be added for serving only with a conversion
webhook. This enables a smoother transition where users can create CRs using
either the v1 or v2 schema, with the webhook in place to perform the necessary
schema conversion between them. Before setting v2 as the preferred storage schema
version, it's important to ensure that all existing CRs stored as v1 are migrated to v2.
This migration can be achieved through <em>Storage Version Migration</em> to migrate all CRs from v1 to v2.</p><ul><li><p>Create a manifest for the CRD, named <code>test-crd.yaml</code>, as follows:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiextensions.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CustomResourceDefinition<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>selfierequests.stable.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">group</span>:<span style="color:#bbb"> </span>stable.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">names</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">plural</span>:<span style="color:#bbb"> </span>SelfieRequests<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">singular</span>:<span style="color:#bbb"> </span>SelfieRequest<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>SelfieRequest<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">listKind</span>:<span style="color:#bbb"> </span>SelfieRequestList<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">scope</span>:<span style="color:#bbb"> </span>Namespaced<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">versions</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">served</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">storage</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">openAPIV3Schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">hostPort</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">conversion</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">strategy</span>:<span style="color:#bbb"> </span>Webhook<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">webhook</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">clientConfig</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">url</span>:<span style="color:#bbb"> </span><span style="color:#b44">"https://127.0.0.1:9443/crdconvert"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">caBundle</span>:<span style="color:#bbb"> </span>&lt;CABundle info&gt;<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">conversionReviewVersions</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- v2<span style="color:#bbb">
</span></span></span></code></pre></div><p>Create CRD using kubectl:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f test-crd.yaml
</span></span></code></pre></div></li><li><p>Create a manifest for an example testcrd. Name the manifest <code>cr1.yaml</code> and use these contents:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>stable.example.com/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>SelfieRequest<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>cr1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span></span></span></code></pre></div><p>Create CR using kubectl:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f cr1.yaml
</span></span></code></pre></div></li><li><p>Verify that CR is written and stored as v1 by getting the object from etcd.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#b8860b">ETCDCTL_API</span><span style="color:#666">=</span><span style="color:#666">3</span> etcdctl get /kubernetes.io/stable.example.com/testcrds/default/cr1 <span style="color:#666">[</span>...<span style="color:#666">]</span> | hexdump -C
</span></span></code></pre></div><p>where <code>[...]</code> contains the additional arguments for connecting to the etcd server.</p></li><li><p>Update the CRD <code>test-crd.yaml</code> to include v2 version for serving and storage
and v1 as serving only, as follows:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiextensions.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CustomResourceDefinition<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>selfierequests.stable.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">group</span>:<span style="color:#bbb"> </span>stable.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">names</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">plural</span>:<span style="color:#bbb"> </span>SelfieRequests<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">singular</span>:<span style="color:#bbb"> </span>SelfieRequest<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>SelfieRequest<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">listKind</span>:<span style="color:#bbb"> </span>SelfieRequestList<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">scope</span>:<span style="color:#bbb"> </span>Namespaced<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">versions</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>v2<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">served</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">storage</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">openAPIV3Schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">host</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">port</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">served</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">storage</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">false</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">openAPIV3Schema</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>object<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">properties</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">hostPort</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>string<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">conversion</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">strategy</span>:<span style="color:#bbb"> </span>Webhook<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">webhook</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">clientConfig</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">url</span>:<span style="color:#bbb"> </span><span style="color:#b44">"https://127.0.0.1:9443/crdconvert"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">caBundle</span>:<span style="color:#bbb"> </span>&lt;CABundle info&gt;<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">conversionReviewVersions</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- v2<span style="color:#bbb">
</span></span></span></code></pre></div><p>Update CRD using kubectl:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f test-crd.yaml
</span></span></code></pre></div></li><li><p>Create CR resource file with name <code>cr2.yaml</code> as follows:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>stable.example.com/v2<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>SelfieRequest<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>cr2<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span></span></span></code></pre></div></li><li><p>Create CR using kubectl:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f cr2.yaml
</span></span></code></pre></div></li><li><p>Verify that CR is written and stored as v2 by getting the object from etcd.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#b8860b">ETCDCTL_API</span><span style="color:#666">=</span><span style="color:#666">3</span> etcdctl get /kubernetes.io/stable.example.com/testcrds/default/cr2 <span style="color:#666">[</span>...<span style="color:#666">]</span> | hexdump -C
</span></span></code></pre></div><p>where <code>[...]</code> contains the additional arguments for connecting to the etcd server.</p></li><li><p>Create a StorageVersionMigration manifest named <code>migrate-crd.yaml</code>, with the contents as follows:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>StorageVersionMigration<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>storagemigration.k8s.io/v1alpha1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>crdsvm<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">resource</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">group</span>:<span style="color:#bbb"> </span>stable.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">version</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">resource</span>:<span style="color:#bbb"> </span>SelfieRequest<span style="color:#bbb">
</span></span></span></code></pre></div><p>Create the object using <em>kubectl</em> as follows:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f migrate-crd.yaml
</span></span></code></pre></div></li><li><p>Monitor migration of secrets using status. Successful migration should have
<code>Succeeded</code> condition set to "True" in the status field. Get the migration resource
as follows:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get storageversionmigration.storagemigration.k8s.io/crdsvm -o yaml
</span></span></code></pre></div><p>The output is similar to:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>StorageVersionMigration<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>storagemigration.k8s.io/v1alpha1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>crdsvm<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">uid</span>:<span style="color:#bbb"> </span>13062fe4-32d7-47cc-9528-5067fa0c6ac8<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">resourceVersion</span>:<span style="color:#bbb"> </span><span style="color:#b44">"111"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">creationTimestamp</span>:<span style="color:#bbb"> </span><span style="color:#b44">"2024-03-12T22:40:01Z"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">resource</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">group</span>:<span style="color:#bbb"> </span>stable.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">version</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">resource</span>:<span style="color:#bbb"> </span>testcrds<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">status</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">conditions</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>Running<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">status</span>:<span style="color:#bbb"> </span><span style="color:#b44">"False"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">lastUpdateTime</span>:<span style="color:#bbb"> </span><span style="color:#b44">"2024-03-12T22:40:03Z"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">reason</span>:<span style="color:#bbb"> </span>StorageVersionMigrationInProgress<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>Succeeded<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">status</span>:<span style="color:#bbb"> </span><span style="color:#b44">"True"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">lastUpdateTime</span>:<span style="color:#bbb"> </span><span style="color:#b44">"2024-03-12T22:40:03Z"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">reason</span>:<span style="color:#bbb"> </span>StorageVersionMigrationSucceeded<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">resourceVersion</span>:<span style="color:#bbb"> </span><span style="color:#b44">"106"</span><span style="color:#bbb">
</span></span></span></code></pre></div></li><li><p>Verify that previously created cr1 is now written and stored as v2 by getting the object from etcd.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#b8860b">ETCDCTL_API</span><span style="color:#666">=</span><span style="color:#666">3</span> etcdctl get /kubernetes.io/stable.example.com/testcrds/default/cr1 <span style="color:#666">[</span>...<span style="color:#666">]</span> | hexdump -C
</span></span></code></pre></div><p>where <code>[...]</code> contains the additional arguments for connecting to the etcd server.</p></li></ul></div>
<hr>
<div class="td-content"><h1 data-pagefind-weight="10">Managing Kubernetes Objects Using Imperative Commands</h1><p>Kubernetes objects can quickly be created, updated, and deleted directly using
imperative commands built into the <code>kubectl</code> command-line tool. This document
explains how those commands are organized and how to use them to manage live objects.</p><h2 id="before-you-begin">Before you begin</h2><p>Install <a href="/docs/tasks/tools/"><code>kubectl</code></a>.</p><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul><p>To check the version, enter <code>kubectl version</code>.</p></p><h2 id="trade-offs">Trade-offs</h2><p>The <code>kubectl</code> tool supports three kinds of object management:</p><ul><li>Imperative commands</li><li>Imperative object configuration</li><li>Declarative object configuration</li></ul><p>See <a href="/docs/concepts/overview/working-with-objects/object-management/">Kubernetes Object Management</a>
for a discussion of the advantages and disadvantage of each kind of object management.</p><h2 id="how-to-create-objects">How to create objects</h2><p>The <code>kubectl</code> tool supports verb-driven commands for creating some of the most common
object types. The commands are named to be recognizable to users unfamiliar with
the Kubernetes object types.</p><ul><li><code>run</code>: Create a new Pod to run a Container.</li><li><code>expose</code>: Create a new Service object to load balance traffic across Pods.</li><li><code>autoscale</code>: Create a new Autoscaler object to automatically horizontally scale a controller, such as a Deployment.</li></ul><p>The <code>kubectl</code> tool also supports creation commands driven by object type.
These commands support more object types and are more explicit about
their intent, but require users to know the type of objects they intend
to create.</p><ul><li><code>create &lt;objecttype&gt; [&lt;subtype&gt;] &lt;instancename&gt;</code></li></ul><p>Some objects types have subtypes that you can specify in the <code>create</code> command.
For example, the Service object has several subtypes including ClusterIP,
LoadBalancer, and NodePort. Here's an example that creates a Service with
subtype NodePort:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl create service nodeport &lt;myservicename&gt;
</span></span></code></pre></div><p>In the preceding example, the <code>create service nodeport</code> command is called
a subcommand of the <code>create service</code> command.</p><p>You can use the <code>-h</code> flag to find the arguments and flags supported by
a subcommand:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl create service nodeport -h
</span></span></code></pre></div><h2 id="how-to-update-objects">How to update objects</h2><p>The <code>kubectl</code> command supports verb-driven commands for some common update operations.
These commands are named to enable users unfamiliar with Kubernetes
objects to perform updates without knowing the specific fields
that must be set:</p><ul><li><code>scale</code>: Horizontally scale a controller to add or remove Pods by updating the replica count of the controller.</li><li><code>annotate</code>: Add or remove an annotation from an object.</li><li><code>label</code>: Add or remove a label from an object.</li></ul><p>The <code>kubectl</code> command also supports update commands driven by an aspect of the object.
Setting this aspect may set different fields for different object types:</p><ul><li><code>set</code> <code>&lt;field&gt;</code>: Set an aspect of an object.</li></ul><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>In Kubernetes version 1.5, not every verb-driven command has an associated aspect-driven command.</div><p>The <code>kubectl</code> tool supports these additional ways to update a live object directly,
however they require a better understanding of the Kubernetes object schema.</p><ul><li><code>edit</code>: Directly edit the raw configuration of a live object by opening its configuration in an editor.</li><li><code>patch</code>: Directly modify specific fields of a live object by using a patch string.
For more details on patch strings, see the patch section in
<a href="https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#patch-operations">API Conventions</a>.</li></ul><h2 id="how-to-delete-objects">How to delete objects</h2><p>You can use the <code>delete</code> command to delete an object from a cluster:</p><ul><li><code>delete &lt;type&gt;/&lt;name&gt;</code></li></ul><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>You can use <code>kubectl delete</code> for both imperative commands and imperative object
configuration. The difference is in the arguments passed to the command. To use
<code>kubectl delete</code> as an imperative command, pass the object to be deleted as
an argument. Here's an example that passes a Deployment object named nginx:</div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl delete deployment/nginx
</span></span></code></pre></div><h2 id="how-to-view-an-object">How to view an object</h2><p>There are several commands for printing information about an object:</p><ul><li><code>get</code>: Prints basic information about matching objects. Use <code>get -h</code> to see a list of options.</li><li><code>describe</code>: Prints aggregated detailed information about matching objects.</li><li><code>logs</code>: Prints the stdout and stderr for a container running in a Pod.</li></ul><h2 id="using-set-commands-to-modify-objects-before-creation">Using <code>set</code> commands to modify objects before creation</h2><p>There are some object fields that don't have a flag you can use
in a <code>create</code> command. In some of those cases, you can use a combination of
<code>set</code> and <code>create</code> to specify a value for the field before object
creation. This is done by piping the output of the <code>create</code> command to the
<code>set</code> command, and then back to the <code>create</code> command. Here's an example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="display:flex"><span>kubectl create service clusterip my-svc --clusterip<span style="color:#666">=</span><span style="color:#b44">"None"</span> -o yaml --dry-run<span style="color:#666">=</span>client | kubectl <span style="color:#a2f">set</span> selector --local -f - <span style="color:#b44">'environment=qa'</span> -o yaml | kubectl create -f -
</span></span></code></pre></div><ol><li>The <code>kubectl create service -o yaml --dry-run=client</code> command creates the configuration for the Service, but prints it to stdout as YAML instead of sending it to the Kubernetes API server.</li><li>The <code>kubectl set selector --local -f - -o yaml</code> command reads the configuration from stdin, and writes the updated configuration to stdout as YAML.</li><li>The <code>kubectl create -f -</code> command creates the object using the configuration provided via stdin.</li></ol><h2 id="using-edit-to-modify-objects-before-creation">Using <code>--edit</code> to modify objects before creation</h2><p>You can use <code>kubectl create --edit</code> to make arbitrary changes to an object
before it is created. Here's an example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="display:flex"><span>kubectl create service clusterip my-svc --clusterip<span style="color:#666">=</span><span style="color:#b44">"None"</span> -o yaml --dry-run<span style="color:#666">=</span>client &gt; /tmp/srv.yaml
</span></span><span style="display:flex"><span>kubectl create --edit -f /tmp/srv.yaml
</span></span></code></pre></div><ol><li>The <code>kubectl create service</code> command creates the configuration for the Service and saves it to <code>/tmp/srv.yaml</code>.</li><li>The <code>kubectl create --edit</code> command opens the configuration file for editing before it creates the object.</li></ol><h2 id="what-s-next">What's next</h2><ul><li><a href="/docs/tasks/manage-kubernetes-objects/imperative-config/">Imperative Management of Kubernetes Objects Using Configuration Files</a></li><li><a href="/docs/tasks/manage-kubernetes-objects/declarative-config/">Declarative Management of Kubernetes Objects Using Configuration Files</a></li><li><a href="/docs/reference/generated/kubectl/kubectl-commands/">Kubectl Command Reference</a></li><li><a href="/docs/reference/generated/kubernetes-api/v1.34/">Kubernetes API Reference</a></li></ul></div>
<hr>
<div class="td-content"><h1 data-pagefind-weight="10">Declarative Management of Kubernetes Objects Using Kustomize</h1><p><a href="https://github.com/kubernetes-sigs/kustomize">Kustomize</a> is a standalone tool
to customize Kubernetes objects
through a <a href="https://kubectl.docs.kubernetes.io/references/kustomize/glossary/#kustomization">kustomization file</a>.</p><p>Since 1.14, kubectl also
supports the management of Kubernetes objects using a kustomization file.
To view resources found in a directory containing a kustomization file, run the following command:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl kustomize &lt;kustomization_directory&gt;
</span></span></code></pre></div><p>To apply those resources, run <code>kubectl apply</code> with <code>--kustomize</code> or <code>-k</code> flag:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -k &lt;kustomization_directory&gt;
</span></span></code></pre></div><h2 id="before-you-begin">Before you begin</h2><p>Install <a href="/docs/tasks/tools/"><code>kubectl</code></a>.</p><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul><p>To check the version, enter <code>kubectl version</code>.</p></p><h2 id="overview-of-kustomize">Overview of Kustomize</h2><p>Kustomize is a tool for customizing Kubernetes configurations. It has the following
features to manage application configuration files:</p><ul><li>generating resources from other sources</li><li>setting cross-cutting fields for resources</li><li>composing and customizing collections of resources</li></ul><h3 id="generating-resources">Generating Resources</h3><p>ConfigMaps and Secrets hold configuration or sensitive data that are used by other Kubernetes
objects, such as Pods. The source of truth of ConfigMaps or Secrets are usually external to
a cluster, such as a <code>.properties</code> file or an SSH keyfile.
Kustomize has <code>secretGenerator</code> and <code>configMapGenerator</code>, which generate Secret and ConfigMap from files or literals.</p><h4 id="configmapgenerator">configMapGenerator</h4><p>To generate a ConfigMap from a file, add an entry to the <code>files</code> list in <code>configMapGenerator</code>.
Here is an example of generating a ConfigMap with a data item from a <code>.properties</code> file:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Create a application.properties file</span>
</span></span><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt;application.properties
</span></span></span><span style="display:flex"><span><span style="color:#b44">FOO=Bar
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">configMapGenerator:
</span></span></span><span style="display:flex"><span><span style="color:#b44">- name: example-configmap-1
</span></span></span><span style="display:flex"><span><span style="color:#b44">  files:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  - application.properties
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span></code></pre></div><p>The generated ConfigMap can be examined with the following command:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl kustomize ./
</span></span></code></pre></div><p>The generated ConfigMap is:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">data</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">application.properties</span>:<span style="color:#bbb"> </span>|<span style="color:#b44;font-style:italic">
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">    FOO=Bar</span><span style="color:#bbb">    
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ConfigMap<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>example-configmap-1-8mbdf7882g<span style="color:#bbb">
</span></span></span></code></pre></div><p>To generate a ConfigMap from an env file, add an entry to the <code>envs</code> list in <code>configMapGenerator</code>.
Here is an example of generating a ConfigMap with a data item from a <code>.env</code> file:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Create a .env file</span>
</span></span><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt;.env
</span></span></span><span style="display:flex"><span><span style="color:#b44">FOO=Bar
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">configMapGenerator:
</span></span></span><span style="display:flex"><span><span style="color:#b44">- name: example-configmap-1
</span></span></span><span style="display:flex"><span><span style="color:#b44">  envs:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  - .env
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span></code></pre></div><p>The generated ConfigMap can be examined with the following command:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl kustomize ./
</span></span></code></pre></div><p>The generated ConfigMap is:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">data</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">FOO</span>:<span style="color:#bbb"> </span>Bar<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ConfigMap<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>example-configmap-1-42cfbf598f<span style="color:#bbb">
</span></span></span></code></pre></div><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>Each variable in the <code>.env</code> file becomes a separate key in the ConfigMap that you generate.
This is different from the previous example which embeds a file named <code>application.properties</code>
(and all its entries) as the value for a single key.</div><p>ConfigMaps can also be generated from literal key-value pairs. To generate a ConfigMap from
a literal key-value pair, add an entry to the <code>literals</code> list in configMapGenerator.
Here is an example of generating a ConfigMap with a data item from a key-value pair:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">configMapGenerator:
</span></span></span><span style="display:flex"><span><span style="color:#b44">- name: example-configmap-2
</span></span></span><span style="display:flex"><span><span style="color:#b44">  literals:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  - FOO=Bar
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span></code></pre></div><p>The generated ConfigMap can be checked by the following command:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl kustomize ./
</span></span></code></pre></div><p>The generated ConfigMap is:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">data</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">FOO</span>:<span style="color:#bbb"> </span>Bar<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ConfigMap<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>example-configmap-2-g2hdhfc6tk<span style="color:#bbb">
</span></span></span></code></pre></div><p>To use a generated ConfigMap in a Deployment, reference it by the name of the configMapGenerator.
Kustomize will automatically replace this name with the generated name.</p><p>This is an example deployment that uses a generated ConfigMap:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Create an application.properties file</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>cat &lt;&lt;EOF &gt;application.properties<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>FOO=Bar<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>EOF<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>cat &lt;&lt;EOF &gt;deployment.yaml<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-app<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>my-app<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>my-app<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>my-app<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>app<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>my-app<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">volumeMounts</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>config<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span>/config<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>config<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">configMap</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>example-configmap-1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>EOF<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>cat &lt;&lt;EOF &gt;./kustomization.yaml<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- deployment.yaml<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">configMapGenerator</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>example-configmap-1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">files</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- application.properties<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>EOF<span style="color:#bbb">
</span></span></span></code></pre></div><p>Generate the ConfigMap and Deployment:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl kustomize ./
</span></span></code></pre></div><p>The generated Deployment will refer to the generated ConfigMap by name:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">data</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">application.properties</span>:<span style="color:#bbb"> </span>|<span style="color:#b44;font-style:italic">
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">    FOO=Bar</span><span style="color:#bbb">    
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ConfigMap<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>example-configmap-1-g4hk9g2ff8<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#00f;font-weight:700">---</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>my-app<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-app<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>my-app<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>my-app<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>my-app<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>app<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">volumeMounts</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span>/config<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>config<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">configMap</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>example-configmap-1-g4hk9g2ff8<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>config<span style="color:#bbb">
</span></span></span></code></pre></div><h4 id="secretgenerator">secretGenerator</h4><p>You can generate Secrets from files or literal key-value pairs.
To generate a Secret from a file, add an entry to the <code>files</code> list in <code>secretGenerator</code>.
Here is an example of generating a Secret with a data item from a file:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Create a password.txt file</span>
</span></span><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt;./password.txt
</span></span></span><span style="display:flex"><span><span style="color:#b44">username=admin
</span></span></span><span style="display:flex"><span><span style="color:#b44">password=secret
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">secretGenerator:
</span></span></span><span style="display:flex"><span><span style="color:#b44">- name: example-secret-1
</span></span></span><span style="display:flex"><span><span style="color:#b44">  files:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  - password.txt
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span></code></pre></div><p>The generated Secret is as follows:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">data</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">password.txt</span>:<span style="color:#bbb"> </span>dXNlcm5hbWU9YWRtaW4KcGFzc3dvcmQ9c2VjcmV0Cg==<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Secret<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>example-secret-1-t2kt65hgtb<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>Opaque<span style="color:#bbb">
</span></span></span></code></pre></div><p>To generate a Secret from a literal key-value pair, add an entry to <code>literals</code> list
in <code>secretGenerator</code>. Here is an example of generating a Secret with a data item from a key-value pair:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">secretGenerator:
</span></span></span><span style="display:flex"><span><span style="color:#b44">- name: example-secret-2
</span></span></span><span style="display:flex"><span><span style="color:#b44">  literals:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  - username=admin
</span></span></span><span style="display:flex"><span><span style="color:#b44">  - password=secret
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span></code></pre></div><p>The generated Secret is as follows:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">data</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">password</span>:<span style="color:#bbb"> </span>c2VjcmV0<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">username</span>:<span style="color:#bbb"> </span>YWRtaW4=<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Secret<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>example-secret-2-t52t6g96d8<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>Opaque<span style="color:#bbb">
</span></span></span></code></pre></div><p>Like ConfigMaps, generated Secrets can be used in Deployments by referring to the name of the secretGenerator:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Create a password.txt file</span>
</span></span><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt;./password.txt
</span></span></span><span style="display:flex"><span><span style="color:#b44">username=admin
</span></span></span><span style="display:flex"><span><span style="color:#b44">password=secret
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt;deployment.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">apiVersion: apps/v1
</span></span></span><span style="display:flex"><span><span style="color:#b44">kind: Deployment
</span></span></span><span style="display:flex"><span><span style="color:#b44">metadata:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  name: my-app
</span></span></span><span style="display:flex"><span><span style="color:#b44">  labels:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    app: my-app
</span></span></span><span style="display:flex"><span><span style="color:#b44">spec:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  selector:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    matchLabels:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      app: my-app
</span></span></span><span style="display:flex"><span><span style="color:#b44">  template:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    metadata:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      labels:
</span></span></span><span style="display:flex"><span><span style="color:#b44">        app: my-app
</span></span></span><span style="display:flex"><span><span style="color:#b44">    spec:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      containers:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      - name: app
</span></span></span><span style="display:flex"><span><span style="color:#b44">        image: my-app
</span></span></span><span style="display:flex"><span><span style="color:#b44">        volumeMounts:
</span></span></span><span style="display:flex"><span><span style="color:#b44">        - name: password
</span></span></span><span style="display:flex"><span><span style="color:#b44">          mountPath: /secrets
</span></span></span><span style="display:flex"><span><span style="color:#b44">      volumes:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      - name: password
</span></span></span><span style="display:flex"><span><span style="color:#b44">        secret:
</span></span></span><span style="display:flex"><span><span style="color:#b44">          secretName: example-secret-1
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">resources:
</span></span></span><span style="display:flex"><span><span style="color:#b44">- deployment.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">secretGenerator:
</span></span></span><span style="display:flex"><span><span style="color:#b44">- name: example-secret-1
</span></span></span><span style="display:flex"><span><span style="color:#b44">  files:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  - password.txt
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span></code></pre></div><h4 id="generatoroptions">generatorOptions</h4><p>The generated ConfigMaps and Secrets have a content hash suffix appended. This ensures that
a new ConfigMap or Secret is generated when the contents are changed. To disable the behavior
of appending a suffix, one can use <code>generatorOptions</code>. Besides that, it is also possible to
specify cross-cutting options for generated ConfigMaps and Secrets.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">configMapGenerator:
</span></span></span><span style="display:flex"><span><span style="color:#b44">- name: example-configmap-3
</span></span></span><span style="display:flex"><span><span style="color:#b44">  literals:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  - FOO=Bar
</span></span></span><span style="display:flex"><span><span style="color:#b44">generatorOptions:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  disableNameSuffixHash: true
</span></span></span><span style="display:flex"><span><span style="color:#b44">  labels:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    type: generated
</span></span></span><span style="display:flex"><span><span style="color:#b44">  annotations:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    note: generated
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span></code></pre></div><p>Run<code>kubectl kustomize ./</code> to view the generated ConfigMap:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">data</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">FOO</span>:<span style="color:#bbb"> </span>Bar<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ConfigMap<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">annotations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">note</span>:<span style="color:#bbb"> </span>generated<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>generated<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>example-configmap-3<span style="color:#bbb">
</span></span></span></code></pre></div><h3 id="setting-cross-cutting-fields">Setting cross-cutting fields</h3><p>It is quite common to set cross-cutting fields for all Kubernetes resources in a project.
Some use cases for setting cross-cutting fields:</p><ul><li>setting the same namespace for all resources</li><li>adding the same name prefix or suffix</li><li>adding the same set of labels</li><li>adding the same set of annotations</li></ul><p>Here is an example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Create a deployment.yaml</span>
</span></span><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt;./deployment.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">apiVersion: apps/v1
</span></span></span><span style="display:flex"><span><span style="color:#b44">kind: Deployment
</span></span></span><span style="display:flex"><span><span style="color:#b44">metadata:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  name: nginx-deployment
</span></span></span><span style="display:flex"><span><span style="color:#b44">  labels:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    app: nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">spec:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  selector:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    matchLabels:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      app: nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">  template:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    metadata:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      labels:
</span></span></span><span style="display:flex"><span><span style="color:#b44">        app: nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">    spec:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      containers:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      - name: nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">        image: nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">namespace: my-namespace
</span></span></span><span style="display:flex"><span><span style="color:#b44">namePrefix: dev-
</span></span></span><span style="display:flex"><span><span style="color:#b44">nameSuffix: "-001"
</span></span></span><span style="display:flex"><span><span style="color:#b44">labels:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  - pairs:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      app: bingo
</span></span></span><span style="display:flex"><span><span style="color:#b44">    includeSelectors: true 
</span></span></span><span style="display:flex"><span><span style="color:#b44">commonAnnotations:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  oncallPager: 800-555-1212
</span></span></span><span style="display:flex"><span><span style="color:#b44">resources:
</span></span></span><span style="display:flex"><span><span style="color:#b44">- deployment.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span></code></pre></div><p>Run <code>kubectl kustomize ./</code> to view those fields are all set in the Deployment Resource:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">annotations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">oncallPager</span>:<span style="color:#bbb"> </span><span style="color:#666">800-555-1212</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>bingo<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>dev-nginx-deployment-001<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>my-namespace<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>bingo<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">annotations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">oncallPager</span>:<span style="color:#bbb"> </span><span style="color:#666">800-555-1212</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>bingo<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span></code></pre></div><h3 id="composing-and-customizing-resources">Composing and Customizing Resources</h3><p>It is common to compose a set of resources in a project and manage them inside the same file or directory.
Kustomize offers composing resources from different files and applying patches or other customization to them.</p><h4 id="composing">Composing</h4><p>Kustomize supports composition of different resources. The <code>resources</code> field, in the <code>kustomization.yaml</code> file,
defines the list of resources to include in a configuration. Set the path to a resource's configuration file in the <code>resources</code> list.
Here is an example of an NGINX application comprised of a Deployment and a Service:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Create a deployment.yaml file</span>
</span></span><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt; deployment.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">apiVersion: apps/v1
</span></span></span><span style="display:flex"><span><span style="color:#b44">kind: Deployment
</span></span></span><span style="display:flex"><span><span style="color:#b44">metadata:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  name: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">spec:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  selector:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    matchLabels:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      run: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">  replicas: 2
</span></span></span><span style="display:flex"><span><span style="color:#b44">  template:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    metadata:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      labels:
</span></span></span><span style="display:flex"><span><span style="color:#b44">        run: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">    spec:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      containers:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      - name: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">        image: nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">        ports:
</span></span></span><span style="display:flex"><span><span style="color:#b44">        - containerPort: 80
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># Create a service.yaml file</span>
</span></span><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt; service.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">apiVersion: v1
</span></span></span><span style="display:flex"><span><span style="color:#b44">kind: Service
</span></span></span><span style="display:flex"><span><span style="color:#b44">metadata:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  name: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">  labels:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    run: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">spec:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  ports:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  - port: 80
</span></span></span><span style="display:flex"><span><span style="color:#b44">    protocol: TCP
</span></span></span><span style="display:flex"><span><span style="color:#b44">  selector:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    run: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># Create a kustomization.yaml composing them</span>
</span></span><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">resources:
</span></span></span><span style="display:flex"><span><span style="color:#b44">- deployment.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">- service.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span></code></pre></div><p>The resources from <code>kubectl kustomize ./</code> contain both the Deployment and the Service objects.</p><h4 id="customizing">Customizing</h4><p>Patches can be used to apply different customizations to resources. Kustomize supports different patching
mechanisms through <code>StrategicMerge</code> and <code>Json6902</code> using the <code>patches</code> field. <code>patches</code> may be a file or
an inline string, targeting a single or multiple resources.</p><p>The <code>patches</code> field contains a list of patches applied in the order they are specified. The patch target
selects resources by <code>group</code>, <code>version</code>, <code>kind</code>, <code>name</code>, <code>namespace</code>, <code>labelSelector</code> and <code>annotationSelector</code>.</p><p>Small patches that do one thing are recommended. For example, create one patch for increasing the deployment
replica number and another patch for setting the memory limit. The target resource is matched using <code>group</code>, <code>version</code>,
<code>kind</code>, and <code>name</code> fields from the patch file.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Create a deployment.yaml file</span>
</span></span><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt; deployment.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">apiVersion: apps/v1
</span></span></span><span style="display:flex"><span><span style="color:#b44">kind: Deployment
</span></span></span><span style="display:flex"><span><span style="color:#b44">metadata:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  name: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">spec:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  selector:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    matchLabels:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      run: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">  replicas: 2
</span></span></span><span style="display:flex"><span><span style="color:#b44">  template:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    metadata:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      labels:
</span></span></span><span style="display:flex"><span><span style="color:#b44">        run: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">    spec:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      containers:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      - name: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">        image: nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">        ports:
</span></span></span><span style="display:flex"><span><span style="color:#b44">        - containerPort: 80
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># Create a patch increase_replicas.yaml</span>
</span></span><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt; increase_replicas.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">apiVersion: apps/v1
</span></span></span><span style="display:flex"><span><span style="color:#b44">kind: Deployment
</span></span></span><span style="display:flex"><span><span style="color:#b44">metadata:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  name: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">spec:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  replicas: 3
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># Create another patch set_memory.yaml</span>
</span></span><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt; set_memory.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">apiVersion: apps/v1
</span></span></span><span style="display:flex"><span><span style="color:#b44">kind: Deployment
</span></span></span><span style="display:flex"><span><span style="color:#b44">metadata:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  name: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">spec:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  template:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    spec:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      containers:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      - name: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">        resources:
</span></span></span><span style="display:flex"><span><span style="color:#b44">          limits:
</span></span></span><span style="display:flex"><span><span style="color:#b44">            memory: 512Mi
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">resources:
</span></span></span><span style="display:flex"><span><span style="color:#b44">- deployment.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">patches:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  - path: increase_replicas.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">  - path: set_memory.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span></code></pre></div><p>Run <code>kubectl kustomize ./</code> to view the Deployment:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">3</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">run</span>:<span style="color:#bbb"> </span>my-nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">run</span>:<span style="color:#bbb"> </span>my-nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">limits</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">memory</span>:<span style="color:#bbb"> </span>512Mi<span style="color:#bbb">
</span></span></span></code></pre></div><p>Not all resources or fields support <code>strategicMerge</code> patches. To support modifying arbitrary fields in arbitrary resources,
Kustomize offers applying <a href="https://tools.ietf.org/html/rfc6902">JSON patch</a> through <code>Json6902</code>.
To find the correct Resource for a <code>Json6902</code> patch, it is mandatory to specify the <code>target</code> field in <code>kustomization.yaml</code>.</p><p>For example, increasing the replica number of a Deployment object can also be done through <code>Json6902</code> patch. The target resource
is matched using <code>group</code>, <code>version</code>, <code>kind</code>, and <code>name</code> from the <code>target</code> field.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Create a deployment.yaml file</span>
</span></span><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt; deployment.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">apiVersion: apps/v1
</span></span></span><span style="display:flex"><span><span style="color:#b44">kind: Deployment
</span></span></span><span style="display:flex"><span><span style="color:#b44">metadata:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  name: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">spec:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  selector:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    matchLabels:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      run: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">  replicas: 2
</span></span></span><span style="display:flex"><span><span style="color:#b44">  template:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    metadata:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      labels:
</span></span></span><span style="display:flex"><span><span style="color:#b44">        run: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">    spec:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      containers:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      - name: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">        image: nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">        ports:
</span></span></span><span style="display:flex"><span><span style="color:#b44">        - containerPort: 80
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># Create a json patch</span>
</span></span><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt; patch.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">- op: replace
</span></span></span><span style="display:flex"><span><span style="color:#b44">  path: /spec/replicas
</span></span></span><span style="display:flex"><span><span style="color:#b44">  value: 3
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># Create a kustomization.yaml</span>
</span></span><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">resources:
</span></span></span><span style="display:flex"><span><span style="color:#b44">- deployment.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">
</span></span></span><span style="display:flex"><span><span style="color:#b44">patches:
</span></span></span><span style="display:flex"><span><span style="color:#b44">- target:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    group: apps
</span></span></span><span style="display:flex"><span><span style="color:#b44">    version: v1
</span></span></span><span style="display:flex"><span><span style="color:#b44">    kind: Deployment
</span></span></span><span style="display:flex"><span><span style="color:#b44">    name: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">  path: patch.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span></code></pre></div><p>Run <code>kubectl kustomize ./</code> to see the <code>replicas</code> field is updated:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">3</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">run</span>:<span style="color:#bbb"> </span>my-nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">run</span>:<span style="color:#bbb"> </span>my-nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>In addition to patches, Kustomize also offers customizing container images or injecting field values from other objects into containers
without creating patches. For example, you can change the image used inside containers by specifying the new image in the <code>images</code> field
in <code>kustomization.yaml</code>.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt; deployment.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">apiVersion: apps/v1
</span></span></span><span style="display:flex"><span><span style="color:#b44">kind: Deployment
</span></span></span><span style="display:flex"><span><span style="color:#b44">metadata:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  name: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">spec:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  selector:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    matchLabels:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      run: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">  replicas: 2
</span></span></span><span style="display:flex"><span><span style="color:#b44">  template:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    metadata:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      labels:
</span></span></span><span style="display:flex"><span><span style="color:#b44">        run: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">    spec:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      containers:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      - name: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">        image: nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">        ports:
</span></span></span><span style="display:flex"><span><span style="color:#b44">        - containerPort: 80
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">resources:
</span></span></span><span style="display:flex"><span><span style="color:#b44">- deployment.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">images:
</span></span></span><span style="display:flex"><span><span style="color:#b44">- name: nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">  newName: my.image.registry/nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">  newTag: "1.4.0"
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span></code></pre></div><p>Run <code>kubectl kustomize ./</code> to see that the image being used is updated:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">2</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">run</span>:<span style="color:#bbb"> </span>my-nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">run</span>:<span style="color:#bbb"> </span>my-nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>my.image.registry/nginx:1.4.0<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>Sometimes, the application running in a Pod may need to use configuration values from other objects. For example,
a Pod from a Deployment object need to read the corresponding Service name from Env or as a command argument.
Since the Service name may change as <code>namePrefix</code> or <code>nameSuffix</code> is added in the <code>kustomization.yaml</code> file. It is
not recommended to hard code the Service name in the command argument. For this usage, Kustomize can inject
the Service name into containers through <code>replacements</code>.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Create a deployment.yaml file (quoting the here doc delimiter)</span>
</span></span><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;'EOF' &gt; deployment.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">apiVersion: apps/v1
</span></span></span><span style="display:flex"><span><span style="color:#b44">kind: Deployment
</span></span></span><span style="display:flex"><span><span style="color:#b44">metadata:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  name: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">spec:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  selector:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    matchLabels:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      run: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">  replicas: 2
</span></span></span><span style="display:flex"><span><span style="color:#b44">  template:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    metadata:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      labels:
</span></span></span><span style="display:flex"><span><span style="color:#b44">        run: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">    spec:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      containers:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      - name: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">        image: nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">        command: ["start", "--host", "MY_SERVICE_NAME_PLACEHOLDER"]
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># Create a service.yaml file</span>
</span></span><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt; service.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">apiVersion: v1
</span></span></span><span style="display:flex"><span><span style="color:#b44">kind: Service
</span></span></span><span style="display:flex"><span><span style="color:#b44">metadata:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  name: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">  labels:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    run: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">spec:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  ports:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  - port: 80
</span></span></span><span style="display:flex"><span><span style="color:#b44">    protocol: TCP
</span></span></span><span style="display:flex"><span><span style="color:#b44">  selector:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    run: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">namePrefix: dev-
</span></span></span><span style="display:flex"><span><span style="color:#b44">nameSuffix: "-001"
</span></span></span><span style="display:flex"><span><span style="color:#b44">
</span></span></span><span style="display:flex"><span><span style="color:#b44">resources:
</span></span></span><span style="display:flex"><span><span style="color:#b44">- deployment.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">- service.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">
</span></span></span><span style="display:flex"><span><span style="color:#b44">replacements:
</span></span></span><span style="display:flex"><span><span style="color:#b44">- source:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    kind: Service
</span></span></span><span style="display:flex"><span><span style="color:#b44">    name: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">    fieldPath: metadata.name
</span></span></span><span style="display:flex"><span><span style="color:#b44">  targets:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  - select:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      kind: Deployment
</span></span></span><span style="display:flex"><span><span style="color:#b44">      name: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">    fieldPaths:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    - spec.template.spec.containers.0.command.2
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span></code></pre></div><p>Run <code>kubectl kustomize ./</code> to see that the Service name injected into containers is <code>dev-my-nginx-001</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>dev-my-nginx-001<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">2</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">run</span>:<span style="color:#bbb"> </span>my-nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">run</span>:<span style="color:#bbb"> </span>my-nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">command</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- start<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- --host<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- dev-my-nginx-001<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-nginx<span style="color:#bbb">
</span></span></span></code></pre></div><h2 id="bases-and-overlays">Bases and Overlays</h2><p>Kustomize has the concepts of <strong>bases</strong> and <strong>overlays</strong>. A <strong>base</strong> is a directory with a <code>kustomization.yaml</code>, which contains a
set of resources and associated customization. A base could be either a local directory or a directory from a remote repo,
as long as a <code>kustomization.yaml</code> is present inside. An <strong>overlay</strong> is a directory with a <code>kustomization.yaml</code> that refers to other
kustomization directories as its <code>bases</code>. A <strong>base</strong> has no knowledge of an overlay and can be used in multiple overlays.</p><p>The <code>kustomization.yaml</code> in an <strong>overlay</strong> directory may refer to multiple <code>bases</code>, combining all the resources defined
in these bases into a unified configuration. Additionally, it can apply customizations on top of these resources to meet specific
requirements.</p><p>Here is an example of a base:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Create a directory to hold the base</span>
</span></span><span style="display:flex"><span>mkdir base
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># Create a base/deployment.yaml</span>
</span></span><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt; base/deployment.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">apiVersion: apps/v1
</span></span></span><span style="display:flex"><span><span style="color:#b44">kind: Deployment
</span></span></span><span style="display:flex"><span><span style="color:#b44">metadata:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  name: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">spec:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  selector:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    matchLabels:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      run: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">  replicas: 2
</span></span></span><span style="display:flex"><span><span style="color:#b44">  template:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    metadata:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      labels:
</span></span></span><span style="display:flex"><span><span style="color:#b44">        run: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">    spec:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      containers:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      - name: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">        image: nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># Create a base/service.yaml file</span>
</span></span><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt; base/service.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">apiVersion: v1
</span></span></span><span style="display:flex"><span><span style="color:#b44">kind: Service
</span></span></span><span style="display:flex"><span><span style="color:#b44">metadata:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  name: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">  labels:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    run: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">spec:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  ports:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  - port: 80
</span></span></span><span style="display:flex"><span><span style="color:#b44">    protocol: TCP
</span></span></span><span style="display:flex"><span><span style="color:#b44">  selector:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    run: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># Create a base/kustomization.yaml</span>
</span></span><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt; base/kustomization.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">resources:
</span></span></span><span style="display:flex"><span><span style="color:#b44">- deployment.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">- service.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span></code></pre></div><p>This base can be used in multiple overlays. You can add different <code>namePrefix</code> or other cross-cutting fields
in different overlays. Here are two overlays using the same base.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>mkdir dev
</span></span><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt; dev/kustomization.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">resources:
</span></span></span><span style="display:flex"><span><span style="color:#b44">- ../base
</span></span></span><span style="display:flex"><span><span style="color:#b44">namePrefix: dev-
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>mkdir prod
</span></span><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt; prod/kustomization.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">resources:
</span></span></span><span style="display:flex"><span><span style="color:#b44">- ../base
</span></span></span><span style="display:flex"><span><span style="color:#b44">namePrefix: prod-
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span></code></pre></div><h2 id="how-to-apply-view-delete-objects-using-kustomize">How to apply/view/delete objects using Kustomize</h2><p>Use <code>--kustomize</code> or <code>-k</code> in <code>kubectl</code> commands to recognize resources managed by <code>kustomization.yaml</code>.
Note that <code>-k</code> should point to a kustomization directory, such as</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -k &lt;kustomization directory&gt;/
</span></span></code></pre></div><p>Given the following <code>kustomization.yaml</code>,</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Create a deployment.yaml file</span>
</span></span><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt; deployment.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">apiVersion: apps/v1
</span></span></span><span style="display:flex"><span><span style="color:#b44">kind: Deployment
</span></span></span><span style="display:flex"><span><span style="color:#b44">metadata:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  name: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">spec:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  selector:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    matchLabels:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      run: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">  replicas: 2
</span></span></span><span style="display:flex"><span><span style="color:#b44">  template:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    metadata:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      labels:
</span></span></span><span style="display:flex"><span><span style="color:#b44">        run: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">    spec:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      containers:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      - name: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">        image: nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">        ports:
</span></span></span><span style="display:flex"><span><span style="color:#b44">        - containerPort: 80
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># Create a kustomization.yaml</span>
</span></span><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">namePrefix: dev-
</span></span></span><span style="display:flex"><span><span style="color:#b44">labels:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  - pairs:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      app: my-nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">    includeSelectors: true 
</span></span></span><span style="display:flex"><span><span style="color:#b44">resources:
</span></span></span><span style="display:flex"><span><span style="color:#b44">- deployment.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span></code></pre></div><p>Run the following command to apply the Deployment object <code>dev-my-nginx</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>&gt; kubectl apply -k ./
</span></span><span style="display:flex"><span>deployment.apps/dev-my-nginx created
</span></span></code></pre></div><p>Run one of the following commands to view the Deployment object <code>dev-my-nginx</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get -k ./
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl describe -k ./
</span></span></code></pre></div><p>Run the following command to compare the Deployment object <code>dev-my-nginx</code> against the state
that the cluster would be in if the manifest was applied:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl diff -k ./
</span></span></code></pre></div><p>Run the following command to delete the Deployment object <code>dev-my-nginx</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>&gt; kubectl delete -k ./
</span></span><span style="display:flex"><span>deployment.apps <span style="color:#b44">"dev-my-nginx"</span> deleted
</span></span></code></pre></div><h2 id="kustomize-feature-list">Kustomize Feature List</h2><table><thead><tr><th>Field</th><th>Type</th><th>Explanation</th></tr></thead><tbody><tr><td>bases</td><td>[]string</td><td>Each entry in this list should resolve to a directory containing a kustomization.yaml file</td></tr><tr><td>commonAnnotations</td><td>map[string]string</td><td>annotations to add to all resources</td></tr><tr><td>commonLabels</td><td>map[string]string</td><td>labels to add to all resources and selectors</td></tr><tr><td>configMapGenerator</td><td>[]<a href="https://github.com/kubernetes-sigs/kustomize/blob/master/api/types/configmapargs.go#L7">ConfigMapArgs</a></td><td>Each entry in this list generates a ConfigMap</td></tr><tr><td>configurations</td><td>[]string</td><td>Each entry in this list should resolve to a file containing <a href="https://github.com/kubernetes-sigs/kustomize/tree/master/examples/transformerconfigs">Kustomize transformer configurations</a></td></tr><tr><td>crds</td><td>[]string</td><td>Each entry in this list should resolve to an OpenAPI definition file for Kubernetes types</td></tr><tr><td>generatorOptions</td><td><a href="https://github.com/kubernetes-sigs/kustomize/blob/master/api/types/generatoroptions.go#L7">GeneratorOptions</a></td><td>Modify behaviors of all ConfigMap and Secret generator</td></tr><tr><td>images</td><td>[]<a href="https://github.com/kubernetes-sigs/kustomize/blob/master/api/types/image.go#L8">Image</a></td><td>Each entry is to modify the name, tags and/or digest for one image without creating patches</td></tr><tr><td>labels</td><td>map[string]string</td><td>Add labels without automatically injecting corresponding selectors</td></tr><tr><td>namePrefix</td><td>string</td><td>value of this field is prepended to the names of all resources</td></tr><tr><td>nameSuffix</td><td>string</td><td>value of this field is appended to the names of all resources</td></tr><tr><td>patchesJson6902</td><td>[]<a href="https://github.com/kubernetes-sigs/kustomize/blob/master/api/types/patch.go#L10">Patch</a></td><td>Each entry in this list should resolve to a Kubernetes object and a Json Patch</td></tr><tr><td>patchesStrategicMerge</td><td>[]string</td><td>Each entry in this list should resolve a strategic merge patch of a Kubernetes object</td></tr><tr><td>replacements</td><td>[]<a href="https://github.com/kubernetes-sigs/kustomize/blob/master/api/types/replacement.go#L15">Replacements</a></td><td>copy the value from a resource's field into any number of specified targets.</td></tr><tr><td>resources</td><td>[]string</td><td>Each entry in this list must resolve to an existing resource configuration file</td></tr><tr><td>secretGenerator</td><td>[]<a href="https://github.com/kubernetes-sigs/kustomize/blob/master/api/types/secretargs.go#L7">SecretArgs</a></td><td>Each entry in this list generates a Secret</td></tr><tr><td>vars</td><td>[]<a href="https://github.com/kubernetes-sigs/kustomize/blob/master/api/types/var.go#L19">Var</a></td><td>Each entry is to capture text from one resource's field</td></tr></tbody></table><h2 id="what-s-next">What's next</h2><ul><li><a href="https://github.com/kubernetes-sigs/kustomize">Kustomize</a></li><li><a href="https://kubectl.docs.kubernetes.io">Kubectl Book</a></li><li><a href="/docs/reference/generated/kubectl/kubectl-commands/">Kubectl Command Reference</a></li><li><a href="/docs/reference/generated/kubernetes-api/v1.34/">Kubernetes API Reference</a></li></ul></div>
<hr>
<div class="td-content"><h1 data-pagefind-weight="10">Declarative Management of Kubernetes Objects Using Configuration Files</h1><p>Kubernetes objects can be created, updated, and deleted by storing multiple
object configuration files in a directory and using <code>kubectl apply</code> to
recursively create and update those objects as needed. This method
retains writes made to live objects without merging the changes
back into the object configuration files. <code>kubectl diff</code> also gives you a
preview of what changes <code>apply</code> will make.</p><h2 id="before-you-begin">Before you begin</h2><p>Install <a href="/docs/tasks/tools/"><code>kubectl</code></a>.</p><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul><p>To check the version, enter <code>kubectl version</code>.</p></p><h2 id="trade-offs">Trade-offs</h2><p>The <code>kubectl</code> tool supports three kinds of object management:</p><ul><li>Imperative commands</li><li>Imperative object configuration</li><li>Declarative object configuration</li></ul><p>See <a href="/docs/concepts/overview/working-with-objects/object-management/">Kubernetes Object Management</a>
for a discussion of the advantages and disadvantage of each kind of object management.</p><h2 id="overview">Overview</h2><p>Declarative object configuration requires a firm understanding of
the Kubernetes object definitions and configuration. Read and complete
the following documents if you have not already:</p><ul><li><a href="/docs/tasks/manage-kubernetes-objects/imperative-command/">Managing Kubernetes Objects Using Imperative Commands</a></li><li><a href="/docs/tasks/manage-kubernetes-objects/imperative-config/">Imperative Management of Kubernetes Objects Using Configuration Files</a></li></ul><p>Following are definitions for terms used in this document:</p><ul><li><em>object configuration file / configuration file</em>: A file that defines the
configuration for a Kubernetes object. This topic shows how to pass configuration
files to <code>kubectl apply</code>. Configuration files are typically stored in source control, such as Git.</li><li><em>live object configuration / live configuration</em>: The live configuration
values of an object, as observed by the Kubernetes cluster. These are kept in the Kubernetes
cluster storage, typically etcd.</li><li><em>declarative configuration writer / declarative writer</em>: A person or software component
that makes updates to a live object. The live writers referred to in this topic make changes
to object configuration files and run <code>kubectl apply</code> to write the changes.</li></ul><h2 id="how-to-create-objects">How to create objects</h2><p>Use <code>kubectl apply</code> to create all objects, except those that already exist,
defined by configuration files in a specified directory:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f &lt;directory&gt;
</span></span></code></pre></div><p>This sets the <code>kubectl.kubernetes.io/last-applied-configuration: '{...}'</code>
annotation on each object. The annotation contains the contents of the object
configuration file that was used to create the object.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>Add the <code>-R</code> flag to recursively process directories.</div><p>Here's an example of an object configuration file:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/simple_deployment.yaml" download="application/simple_deployment.yaml"><code>application/simple_deployment.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;application-simple-deployment-yaml&quot;)" title="Copy application/simple_deployment.yaml to clipboard"/></div><div class="includecode" id="application-simple-deployment-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx-deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">minReadySeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">5</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>nginx:1.14.2<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>Run <code>kubectl diff</code> to print the object that will be created:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl diff -f https://k8s.io/examples/application/simple_deployment.yaml
</span></span></code></pre></div><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4><p><code>diff</code> uses <a href="/docs/reference/using-api/api-concepts/#dry-run">server-side dry-run</a>,
which needs to be enabled on <code>kube-apiserver</code>.</p><p>Since <code>diff</code> performs a server-side apply request in dry-run mode,
it requires granting <code>PATCH</code>, <code>CREATE</code>, and <code>UPDATE</code> permissions.
See <a href="/docs/reference/using-api/api-concepts/#dry-run-authorization">Dry-Run Authorization</a>
for details.</p></div><p>Create the object using <code>kubectl apply</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f https://k8s.io/examples/application/simple_deployment.yaml
</span></span></code></pre></div><p>Print the live configuration using <code>kubectl get</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get -f https://k8s.io/examples/application/simple_deployment.yaml -o yaml
</span></span></code></pre></div><p>The output shows that the <code>kubectl.kubernetes.io/last-applied-configuration</code> annotation
was written to the live configuration, and it matches the configuration file:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">annotations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># This is the json representation of simple_deployment.yaml</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># It was written by kubectl apply when the object was created</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kubectl.kubernetes.io/last-applied-configuration</span>:<span style="color:#bbb"> </span>|<span style="color:#b44;font-style:italic">
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">      {"apiVersion":"apps/v1","kind":"Deployment",
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">      "metadata":{"annotations":{},"name":"nginx-deployment","namespace":"default"},
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">      "spec":{"minReadySeconds":5,"selector":{"matchLabels":{"app":nginx}},"template":{"metadata":{"labels":{"app":"nginx"}},
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">      "spec":{"containers":[{"image":"nginx:1.14.2","name":"nginx",
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">      "ports":[{"containerPort":80}]}]}}}}</span><span style="color:#bbb">      
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">minReadySeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">5</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>nginx:1.14.2<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span></code></pre></div><h2 id="how-to-update-objects">How to update objects</h2><p>You can also use <code>kubectl apply</code> to update all objects defined in a directory, even
if those objects already exist. This approach accomplishes the following:</p><ol><li>Sets fields that appear in the configuration file in the live configuration.</li><li>Clears fields removed from the configuration file in the live configuration.</li></ol><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl diff -f &lt;directory&gt;
</span></span><span style="display:flex"><span>kubectl apply -f &lt;directory&gt;
</span></span></code></pre></div><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>Add the <code>-R</code> flag to recursively process directories.</div><p>Here's an example configuration file:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/simple_deployment.yaml" download="application/simple_deployment.yaml"><code>application/simple_deployment.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;application-simple-deployment-yaml&quot;)" title="Copy application/simple_deployment.yaml to clipboard"/></div><div class="includecode" id="application-simple-deployment-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx-deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">minReadySeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">5</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>nginx:1.14.2<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>Create the object using <code>kubectl apply</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f https://k8s.io/examples/application/simple_deployment.yaml
</span></span></code></pre></div><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>For purposes of illustration, the preceding command refers to a single
configuration file instead of a directory.</div><p>Print the live configuration using <code>kubectl get</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get -f https://k8s.io/examples/application/simple_deployment.yaml -o yaml
</span></span></code></pre></div><p>The output shows that the <code>kubectl.kubernetes.io/last-applied-configuration</code> annotation
was written to the live configuration, and it matches the configuration file:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">annotations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># This is the json representation of simple_deployment.yaml</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># It was written by kubectl apply when the object was created</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kubectl.kubernetes.io/last-applied-configuration</span>:<span style="color:#bbb"> </span>|<span style="color:#b44;font-style:italic">
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">      {"apiVersion":"apps/v1","kind":"Deployment",
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">      "metadata":{"annotations":{},"name":"nginx-deployment","namespace":"default"},
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">      "spec":{"minReadySeconds":5,"selector":{"matchLabels":{"app":nginx}},"template":{"metadata":{"labels":{"app":"nginx"}},
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">      "spec":{"containers":[{"image":"nginx:1.14.2","name":"nginx",
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">      "ports":[{"containerPort":80}]}]}}}}</span><span style="color:#bbb">      
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">minReadySeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">5</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>nginx:1.14.2<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>Directly update the <code>replicas</code> field in the live configuration by using <code>kubectl scale</code>.
This does not use <code>kubectl apply</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl scale deployment/nginx-deployment --replicas<span style="color:#666">=</span><span style="color:#666">2</span>
</span></span></code></pre></div><p>Print the live configuration using <code>kubectl get</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get deployment nginx-deployment -o yaml
</span></span></code></pre></div><p>The output shows that the <code>replicas</code> field has been set to 2, and the <code>last-applied-configuration</code>
annotation does not contain a <code>replicas</code> field:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">annotations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># note that the annotation does not contain replicas</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># because it was not updated through apply</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kubectl.kubernetes.io/last-applied-configuration</span>:<span style="color:#bbb"> </span>|<span style="color:#b44;font-style:italic">
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">      {"apiVersion":"apps/v1","kind":"Deployment",
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">      "metadata":{"annotations":{},"name":"nginx-deployment","namespace":"default"},
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">      "spec":{"minReadySeconds":5,"selector":{"matchLabels":{"app":nginx}},"template":{"metadata":{"labels":{"app":"nginx"}},
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">      "spec":{"containers":[{"image":"nginx:1.14.2","name":"nginx",
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">      "ports":[{"containerPort":80}]}]}}}}</span><span style="color:#bbb">      
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">2</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># written by scale</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">minReadySeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">5</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>nginx:1.14.2<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>Update the <code>simple_deployment.yaml</code> configuration file to change the image from
<code>nginx:1.14.2</code> to <code>nginx:1.16.1</code>, and delete the <code>minReadySeconds</code> field:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/update_deployment.yaml" download="application/update_deployment.yaml"><code>application/update_deployment.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;application-update-deployment-yaml&quot;)" title="Copy application/update_deployment.yaml to clipboard"/></div><div class="includecode" id="application-update-deployment-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx-deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>nginx:1.16.1<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># update the image</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>Apply the changes made to the configuration file:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl diff -f https://k8s.io/examples/application/update_deployment.yaml
</span></span><span style="display:flex"><span>kubectl apply -f https://k8s.io/examples/application/update_deployment.yaml
</span></span></code></pre></div><p>Print the live configuration using <code>kubectl get</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get -f https://k8s.io/examples/application/update_deployment.yaml -o yaml
</span></span></code></pre></div><p>The output shows the following changes to the live configuration:</p><ul><li>The <code>replicas</code> field retains the value of 2 set by <code>kubectl scale</code>.
This is possible because it is omitted from the configuration file.</li><li>The <code>image</code> field has been updated to <code>nginx:1.16.1</code> from <code>nginx:1.14.2</code>.</li><li>The <code>last-applied-configuration</code> annotation has been updated with the new image.</li><li>The <code>minReadySeconds</code> field has been cleared.</li><li>The <code>last-applied-configuration</code> annotation no longer contains the <code>minReadySeconds</code> field.</li></ul><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">annotations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># The annotation contains the updated image to nginx 1.16.1,</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># but does not contain the updated replicas to 2</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kubectl.kubernetes.io/last-applied-configuration</span>:<span style="color:#bbb"> </span>|<span style="color:#b44;font-style:italic">
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">      {"apiVersion":"apps/v1","kind":"Deployment",
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">      "metadata":{"annotations":{},"name":"nginx-deployment","namespace":"default"},
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">      "spec":{"selector":{"matchLabels":{"app":nginx}},"template":{"metadata":{"labels":{"app":"nginx"}},
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">      "spec":{"containers":[{"image":"nginx:1.16.1","name":"nginx",
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">      "ports":[{"containerPort":80}]}]}}}}</span><span style="color:#bbb">      
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">2</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># Set by `kubectl scale`.  Ignored by `kubectl apply`.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># minReadySeconds cleared by `kubectl apply`</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>nginx:1.16.1<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># Set by `kubectl apply`</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span></code></pre></div><div class="alert alert-danger" role="alert"><h4 class="alert-heading">Warning:</h4>Mixing <code>kubectl apply</code> with the imperative object configuration commands
<code>create</code> and <code>replace</code> is not supported. This is because <code>create</code>
and <code>replace</code> do not retain the <code>kubectl.kubernetes.io/last-applied-configuration</code>
that <code>kubectl apply</code> uses to compute updates.</div><h2 id="how-to-delete-objects">How to delete objects</h2><p>There are two approaches to delete objects managed by <code>kubectl apply</code>.</p><h3 id="recommended-kubectl-delete-f-filename">Recommended: <code>kubectl delete -f &lt;filename&gt;</code></h3><p>Manually deleting objects using the imperative command is the recommended
approach, as it is more explicit about what is being deleted, and less likely
to result in the user deleting something unintentionally:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl delete -f &lt;filename&gt;
</span></span></code></pre></div><h3 id="alternative-kubectl-apply-f-directory-prune">Alternative: <code>kubectl apply -f &lt;directory&gt; --prune</code></h3><p>As an alternative to <code>kubectl delete</code>, you can use <code>kubectl apply</code> to identify objects to be deleted after
their manifests have been removed from a directory in the local filesystem.</p><p>In Kubernetes 1.34, there are two pruning modes available in kubectl apply:</p><ul><li>Allowlist-based pruning: This mode has existed since kubectl v1.5 but is still
in alpha due to usability, correctness and performance issues with its design.
The ApplySet-based mode is designed to replace it.</li><li>ApplySet-based pruning: An <em>apply set</em> is a server-side object (by default, a Secret)
that kubectl can use to accurately and efficiently track set membership across <strong>apply</strong>
operations. This mode was introduced in alpha in kubectl v1.27 as a replacement for allowlist-based pruning.</li></ul><ul class="nav nav-tabs" id="kubectl-apply-prune" role="tablist"><li class="nav-item"><a data-toggle="tab" class="nav-link active" href="#kubectl-apply-prune-0" role="tab" aria-controls="kubectl-apply-prune-0" aria-selected="true">Allow list</a></li><li class="nav-item"><a data-toggle="tab" class="nav-link" href="#kubectl-apply-prune-1" role="tab" aria-controls="kubectl-apply-prune-1">Apply set</a></li></ul><div class="tab-content" id="kubectl-apply-prune"><div id="kubectl-apply-prune-0" class="tab-pane show active" role="tabpanel" aria-labelledby="kubectl-apply-prune-0"><p><div class="feature-state-notice feature-alpha"><span class="feature-state-name">FEATURE STATE:</span>
<code>Kubernetes v1.5 [alpha]</code></div><div class="alert alert-danger" role="alert"><h4 class="alert-heading">Warning:</h4>Take care when using <code>--prune</code> with <code>kubectl apply</code> in allow list mode. Which
objects are pruned depends on the values of the <code>--prune-allowlist</code>, <code>--selector</code>
and <code>--namespace</code> flags, and relies on dynamic discovery of the objects in scope.
Especially if flag values are changed between invocations, this can lead to objects
being unexpectedly deleted or retained.</div><p>To use allowlist-based pruning, add the following flags to your <code>kubectl apply</code> invocation:</p><ul><li><code>--prune</code>: Delete previously applied objects that are not in the set passed to the current invocation.</li><li><code>--prune-allowlist</code>: A list of group-version-kinds (GVKs) to consider for pruning.
This flag is optional but strongly encouraged, as its default value is a partial
list of both namespaced and cluster-scoped types, which can lead to surprising results.</li><li><code>--selector/-l</code>: Use a label selector to constrain the set of objects selected
for pruning. This flag is optional but strongly encouraged.</li><li><code>--all</code>: use instead of <code>--selector/-l</code> to explicitly select all previously
applied objects of the allowlisted types.</li></ul><p>Allowlist-based pruning queries the API server for all objects of the allowlisted GVKs that match the given labels (if any), and attempts to match the returned live object configurations against the object
manifest files. If an object matches the query, and it does not have a
manifest in the directory, and it has a <code>kubectl.kubernetes.io/last-applied-configuration</code> annotation,
it is deleted.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f &lt;directory&gt; --prune -l &lt;labels&gt; --prune-allowlist<span style="color:#666">=</span>&lt;gvk-list&gt;
</span></span></code></pre></div><div class="alert alert-danger" role="alert"><h4 class="alert-heading">Warning:</h4>Apply with prune should only be run against the root directory
containing the object manifests. Running against sub-directories
can cause objects to be unintentionally deleted if they were previously applied,
have the labels given (if any), and do not appear in the subdirectory.</div></p></div><div id="kubectl-apply-prune-1" class="tab-pane" role="tabpanel" aria-labelledby="kubectl-apply-prune-1"><p><div class="feature-state-notice feature-alpha"><span class="feature-state-name">FEATURE STATE:</span>
<code>Kubernetes v1.27 [alpha]</code></div><div class="alert alert-caution" role="alert"><h4 class="alert-heading">Caution:</h4><code>kubectl apply --prune --applyset</code> is in alpha, and backwards incompatible
changes might be introduced in subsequent releases.</div><p>To use ApplySet-based pruning, set the <code>KUBECTL_APPLYSET=true</code> environment variable,
and add the following flags to your <code>kubectl apply</code> invocation:</p><ul><li><code>--prune</code>: Delete previously applied objects that are not in the set passed
to the current invocation.</li><li><code>--applyset</code>: The name of an object that kubectl can use to accurately and
efficiently track set membership across <code>apply</code> operations.</li></ul><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#b8860b">KUBECTL_APPLYSET</span><span style="color:#666">=</span><span style="color:#a2f">true</span> kubectl apply -f &lt;directory&gt; --prune --applyset<span style="color:#666">=</span>&lt;name&gt;
</span></span></code></pre></div><p>By default, the type of the ApplySet parent object used is a Secret. However,
ConfigMaps can also be used in the format: <code>--applyset=configmaps/&lt;name&gt;</code>.
When using a Secret or ConfigMap, kubectl will create the object if it does not already exist.</p><p>It is also possible to use custom resources as ApplySet parent objects. To enable
this, label the Custom Resource Definition (CRD) that defines the resource you want
to use with the following: <code>applyset.kubernetes.io/is-parent-type: true</code>. Then, create
the object you want to use as an ApplySet parent (kubectl does not do this automatically
for custom resources). Finally, refer to that object in the applyset flag as follows:
<code>--applyset=&lt;resource&gt;.&lt;group&gt;/&lt;name&gt;</code> (for example, <code>widgets.custom.example.com/widget-name</code>).</p><p>With ApplySet-based pruning, kubectl adds the <code>applyset.kubernetes.io/part-of=&lt;parentID&gt;</code>
label to each object in the set before they are sent to the server. For performance reasons,
it also collects the list of resource types and namespaces that the set contains and adds
these in annotations on the live parent object. Finally, at the end of the apply operation,
it queries the API server for objects of those types in those namespaces
(or in the cluster scope, as applicable) that belong to the set, as defined by the
<code>applyset.kubernetes.io/part-of=&lt;parentID&gt;</code> label.</p><p>Caveats and restrictions:</p><ul><li>Each object may be a member of at most one set.</li><li>The <code>--namespace</code> flag is required when using any namespaced parent, including
the default Secret. This means that ApplySets spanning multiple namespaces must
use a cluster-scoped custom resource as the parent object.</li><li>To safely use ApplySet-based pruning with multiple directories,
use a unique ApplySet name for each.</li></ul></p></div></div><h2 id="how-to-view-an-object">How to view an object</h2><p>You can use <code>kubectl get</code> with <code>-o yaml</code> to view the configuration of a live object:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get -f &lt;filename|url&gt; -o yaml
</span></span></code></pre></div><h2 id="how-apply-calculates-differences-and-merges-changes">How apply calculates differences and merges changes</h2><div class="alert alert-caution" role="alert"><h4 class="alert-heading">Caution:</h4>A <em>patch</em> is an update operation that is scoped to specific fields of an object
instead of the entire object. This enables updating only a specific set of fields
on an object without reading the object first.</div><p>When <code>kubectl apply</code> updates the live configuration for an object,
it does so by sending a patch request to the API server. The
patch defines updates scoped to specific fields of the live object
configuration. The <code>kubectl apply</code> command calculates this patch request
using the configuration file, the live configuration, and the
<code>last-applied-configuration</code> annotation stored in the live configuration.</p><h3 id="merge-patch-calculation">Merge patch calculation</h3><p>The <code>kubectl apply</code> command writes the contents of the configuration file to the
<code>kubectl.kubernetes.io/last-applied-configuration</code> annotation. This
is used to identify fields that have been removed from the configuration
file and need to be cleared from the live configuration. Here are the steps used
to calculate which fields should be deleted or set:</p><ol><li>Calculate the fields to delete. These are the fields present in
<code>last-applied-configuration</code> and missing from the configuration file.</li><li>Calculate the fields to add or set. These are the fields present in
the configuration file whose values don't match the live configuration.</li></ol><p>Here's an example. Suppose this is the configuration file for a Deployment object:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/update_deployment.yaml" download="application/update_deployment.yaml"><code>application/update_deployment.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;application-update-deployment-yaml&quot;)" title="Copy application/update_deployment.yaml to clipboard"/></div><div class="includecode" id="application-update-deployment-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx-deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>nginx:1.16.1<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># update the image</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>Also, suppose this is the live configuration for the same Deployment object:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">annotations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># note that the annotation does not contain replicas</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># because it was not updated through apply</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kubectl.kubernetes.io/last-applied-configuration</span>:<span style="color:#bbb"> </span>|<span style="color:#b44;font-style:italic">
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">      {"apiVersion":"apps/v1","kind":"Deployment",
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">      "metadata":{"annotations":{},"name":"nginx-deployment","namespace":"default"},
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">      "spec":{"minReadySeconds":5,"selector":{"matchLabels":{"app":nginx}},"template":{"metadata":{"labels":{"app":"nginx"}},
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">      "spec":{"containers":[{"image":"nginx:1.14.2","name":"nginx",
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">      "ports":[{"containerPort":80}]}]}}}}</span><span style="color:#bbb">      
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">2</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># written by scale</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">minReadySeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">5</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>nginx:1.14.2<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>Here are the merge calculations that would be performed by <code>kubectl apply</code>:</p><ol><li>Calculate the fields to delete by reading values from
<code>last-applied-configuration</code> and comparing them to values in the
configuration file.
Clear fields explicitly set to null in the local object configuration file
regardless of whether they appear in the <code>last-applied-configuration</code>.
In this example, <code>minReadySeconds</code> appears in the
<code>last-applied-configuration</code> annotation, but does not appear in the configuration file.
<strong>Action:</strong> Clear <code>minReadySeconds</code> from the live configuration.</li><li>Calculate the fields to set by reading values from the configuration
file and comparing them to values in the live configuration. In this example,
the value of <code>image</code> in the configuration file does not match
the value in the live configuration. <strong>Action:</strong> Set the value of <code>image</code> in the live configuration.</li><li>Set the <code>last-applied-configuration</code> annotation to match the value
of the configuration file.</li><li>Merge the results from 1, 2, 3 into a single patch request to the API server.</li></ol><p>Here is the live configuration that is the result of the merge:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">annotations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># The annotation contains the updated image to nginx 1.16.1,</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># but does not contain the updated replicas to 2</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kubectl.kubernetes.io/last-applied-configuration</span>:<span style="color:#bbb"> </span>|<span style="color:#b44;font-style:italic">
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">      {"apiVersion":"apps/v1","kind":"Deployment",
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">      "metadata":{"annotations":{},"name":"nginx-deployment","namespace":"default"},
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">      "spec":{"selector":{"matchLabels":{"app":nginx}},"template":{"metadata":{"labels":{"app":"nginx"}},
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">      "spec":{"containers":[{"image":"nginx:1.16.1","name":"nginx",
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">      "ports":[{"containerPort":80}]}]}}}}</span><span style="color:#bbb">      
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">2</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># Set by `kubectl scale`.  Ignored by `kubectl apply`.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># minReadySeconds cleared by `kubectl apply`</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>nginx:1.16.1<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># Set by `kubectl apply`</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span></code></pre></div><h3 id="how-different-types-of-fields-are-merged">How different types of fields are merged</h3><p>How a particular field in a configuration file is merged with
the live configuration depends on the
type of the field. There are several types of fields:</p><ul><li><p><em>primitive</em>: A field of type string, integer, or boolean.
For example, <code>image</code> and <code>replicas</code> are primitive fields. <strong>Action:</strong> Replace.</p></li><li><p><em>map</em>, also called <em>object</em>: A field of type map or a complex type that contains subfields. For example, <code>labels</code>,
<code>annotations</code>,<code>spec</code> and <code>metadata</code> are all maps. <strong>Action:</strong> Merge elements or subfields.</p></li><li><p><em>list</em>: A field containing a list of items that can be either primitive types or maps.
For example, <code>containers</code>, <code>ports</code>, and <code>args</code> are lists. <strong>Action:</strong> Varies.</p></li></ul><p>When <code>kubectl apply</code> updates a map or list field, it typically does
not replace the entire field, but instead updates the individual subelements.
For instance, when merging the <code>spec</code> on a Deployment, the entire <code>spec</code> is
not replaced. Instead the subfields of <code>spec</code>, such as <code>replicas</code>, are compared
and merged.</p><h3 id="merging-changes-to-primitive-fields">Merging changes to primitive fields</h3><p>Primitive fields are replaced or cleared.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4><code>-</code> is used for "not applicable" because the value is not used.</div><table><thead><tr><th>Field in object configuration file</th><th>Field in live object configuration</th><th>Field in last-applied-configuration</th><th>Action</th></tr></thead><tbody><tr><td>Yes</td><td>Yes</td><td>-</td><td>Set live to configuration file value.</td></tr><tr><td>Yes</td><td>No</td><td>-</td><td>Set live to local configuration.</td></tr><tr><td>No</td><td>-</td><td>Yes</td><td>Clear from live configuration.</td></tr><tr><td>No</td><td>-</td><td>No</td><td>Do nothing. Keep live value.</td></tr></tbody></table><h3 id="merging-changes-to-map-fields">Merging changes to map fields</h3><p>Fields that represent maps are merged by comparing each of the subfields or elements of the map:</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4><code>-</code> is used for "not applicable" because the value is not used.</div><table><thead><tr><th>Key in object configuration file</th><th>Key in live object configuration</th><th>Field in last-applied-configuration</th><th>Action</th></tr></thead><tbody><tr><td>Yes</td><td>Yes</td><td>-</td><td>Compare sub fields values.</td></tr><tr><td>Yes</td><td>No</td><td>-</td><td>Set live to local configuration.</td></tr><tr><td>No</td><td>-</td><td>Yes</td><td>Delete from live configuration.</td></tr><tr><td>No</td><td>-</td><td>No</td><td>Do nothing. Keep live value.</td></tr></tbody></table><h3 id="merging-changes-for-fields-of-type-list">Merging changes for fields of type list</h3><p>Merging changes to a list uses one of three strategies:</p><ul><li>Replace the list if all its elements are primitives.</li><li>Merge individual elements in a list of complex elements.</li><li>Merge a list of primitive elements.</li></ul><p>The choice of strategy is made on a per-field basis.</p><h4 id="replace-the-list-if-all-its-elements-are-primitives">Replace the list if all its elements are primitives</h4><p>Treat the list the same as a primitive field. Replace or delete the
entire list. This preserves ordering.</p><p><strong>Example:</strong> Use <code>kubectl apply</code> to update the <code>args</code> field of a Container in a Pod. This sets
the value of <code>args</code> in the live configuration to the value in the configuration file.
Any <code>args</code> elements that had previously been added to the live configuration are lost.
The order of the <code>args</code> elements defined in the configuration file is
retained in the live configuration.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#080;font-style:italic"># last-applied-configuration value</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">args</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"a"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"b"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># configuration file value</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">args</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"a"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"c"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># live configuration</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">args</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"a"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"b"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"d"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># result after merge</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">args</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"a"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"c"</span>]<span style="color:#bbb">
</span></span></span></code></pre></div><p><strong>Explanation:</strong> The merge used the configuration file value as the new list value.</p><h4 id="merge-individual-elements-of-a-list-of-complex-elements">Merge individual elements of a list of complex elements:</h4><p>Treat the list as a map, and treat a specific field of each element as a key.
Add, delete, or update individual elements. This does not preserve ordering.</p><p>This merge strategy uses a special tag on each field called a <code>patchMergeKey</code>. The
<code>patchMergeKey</code> is defined for each field in the Kubernetes source code:
<a href="https://github.com/kubernetes/api/blob/d04500c8c3dda9c980b668c57abc2ca61efcf5c4/core/v1/types.go#L2747">types.go</a>
When merging a list of maps, the field specified as the <code>patchMergeKey</code> for a given element
is used like a map key for that element.</p><p><strong>Example:</strong> Use <code>kubectl apply</code> to update the <code>containers</code> field of a PodSpec.
This merges the list as though it was a map where each element is keyed
by <code>name</code>.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#080;font-style:italic"># last-applied-configuration value</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>nginx:1.16<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name: nginx-helper-a # key</span>:<span style="color:#bbb"> </span>nginx-helper-a; will be deleted in result<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>helper:1.3<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name: nginx-helper-b # key</span>:<span style="color:#bbb"> </span>nginx-helper-b; will be retained<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>helper:1.3<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># configuration file value</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>nginx:1.16<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx-helper-b<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>helper:1.3<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name: nginx-helper-c # key</span>:<span style="color:#bbb"> </span>nginx-helper-c; will be added in result<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>helper:1.3<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># live configuration</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>nginx:1.16<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx-helper-a<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>helper:1.3<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx-helper-b<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>helper:1.3<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">args</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"run"</span>]<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># Field will be retained</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name: nginx-helper-d # key</span>:<span style="color:#bbb"> </span>nginx-helper-d; will be retained<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>helper:1.3<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># result after merge</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>nginx:1.16<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># Element nginx-helper-a was deleted</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx-helper-b<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>helper:1.3<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">args</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"run"</span>]<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># Field was retained</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx-helper-c<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># Element was added</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>helper:1.3<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx-helper-d<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># Element was ignored</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>helper:1.3<span style="color:#bbb">
</span></span></span></code></pre></div><p><strong>Explanation:</strong></p><ul><li>The container named "nginx-helper-a" was deleted because no container
named "nginx-helper-a" appeared in the configuration file.</li><li>The container named "nginx-helper-b" retained the changes to <code>args</code>
in the live configuration. <code>kubectl apply</code> was able to identify
that "nginx-helper-b" in the live configuration was the same
"nginx-helper-b" as in the configuration file, even though their fields
had different values (no <code>args</code> in the configuration file). This is
because the <code>patchMergeKey</code> field value (name) was identical in both.</li><li>The container named "nginx-helper-c" was added because no container
with that name appeared in the live configuration, but one with
that name appeared in the configuration file.</li><li>The container named "nginx-helper-d" was retained because
no element with that name appeared in the last-applied-configuration.</li></ul><h4 id="merge-a-list-of-primitive-elements">Merge a list of primitive elements</h4><p>As of Kubernetes 1.5, merging lists of primitive elements is not supported.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>Which of the above strategies is chosen for a given field is controlled by
the <code>patchStrategy</code> tag in <a href="https://github.com/kubernetes/api/blob/d04500c8c3dda9c980b668c57abc2ca61efcf5c4/core/v1/types.go#L2748">types.go</a>
If no <code>patchStrategy</code> is specified for a field of type list, then
the list is replaced.</div><h2 id="default-field-values">Default field values</h2><p>The API server sets certain fields to default values in the live configuration if they are
not specified when the object is created.</p><p>Here's a configuration file for a Deployment. The file does not specify <code>strategy</code>:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/simple_deployment.yaml" download="application/simple_deployment.yaml"><code>application/simple_deployment.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;application-simple-deployment-yaml&quot;)" title="Copy application/simple_deployment.yaml to clipboard"/></div><div class="includecode" id="application-simple-deployment-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx-deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">minReadySeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">5</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>nginx:1.14.2<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>Create the object using <code>kubectl apply</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f https://k8s.io/examples/application/simple_deployment.yaml
</span></span></code></pre></div><p>Print the live configuration using <code>kubectl get</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get -f https://k8s.io/examples/application/simple_deployment.yaml -o yaml
</span></span></code></pre></div><p>The output shows that the API server set several fields to default values in the live
configuration. These fields were not specified in the configuration file.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">minReadySeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">5</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># defaulted by apiserver</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">strategy</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">rollingUpdate</span>:<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># defaulted by apiserver - derived from strategy.type</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">maxSurge</span>:<span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">maxUnavailable</span>:<span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>RollingUpdate<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># defaulted by apiserver</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">creationTimestamp</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">null</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>nginx:1.14.2<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">imagePullPolicy</span>:<span style="color:#bbb"> </span>IfNotPresent<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># defaulted by apiserver</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">protocol</span>:<span style="color:#bbb"> </span>TCP<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># defaulted by apiserver</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb"> </span>{}<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># defaulted by apiserver</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">terminationMessagePath</span>:<span style="color:#bbb"> </span>/dev/termination-log<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># defaulted by apiserver</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">dnsPolicy</span>:<span style="color:#bbb"> </span>ClusterFirst<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># defaulted by apiserver</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">restartPolicy</span>:<span style="color:#bbb"> </span>Always<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># defaulted by apiserver</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">securityContext</span>:<span style="color:#bbb"> </span>{}<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># defaulted by apiserver</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">terminationGracePeriodSeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">30</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># defaulted by apiserver</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># ...</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>In a patch request, defaulted fields are not re-defaulted unless they are explicitly cleared
as part of a patch request. This can cause unexpected behavior for
fields that are defaulted based
on the values of other fields. When the other fields are later changed,
the values defaulted from them will not be updated unless they are
explicitly cleared.</p><p>For this reason, it is recommended that certain fields defaulted
by the server are explicitly defined in the configuration file, even
if the desired values match the server defaults. This makes it
easier to recognize conflicting values that will not be re-defaulted
by the server.</p><p><strong>Example:</strong></p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#080;font-style:italic"># last-applied-configuration</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>nginx:1.14.2<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># configuration file</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">strategy</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>Recreate<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># updated value</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>nginx:1.14.2<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># live configuration</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">strategy</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>RollingUpdate<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># defaulted value</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">rollingUpdate</span>:<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># defaulted value derived from type</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">maxSurge </span>:<span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">maxUnavailable</span>:<span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>nginx:1.14.2<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># result after merge - ERROR!</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">strategy</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">type: Recreate # updated value</span>:<span style="color:#bbb"> </span>incompatible with rollingUpdate<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">rollingUpdate: # defaulted value</span>:<span style="color:#bbb"> </span>incompatible with "type: Recreate"<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">maxSurge </span>:<span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">maxUnavailable</span>:<span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>nginx:1.14.2<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span></span></span></code></pre></div><p><strong>Explanation:</strong></p><ol><li>The user creates a Deployment without defining <code>strategy.type</code>.</li><li>The server defaults <code>strategy.type</code> to <code>RollingUpdate</code> and defaults the
<code>strategy.rollingUpdate</code> values.</li><li>The user changes <code>strategy.type</code> to <code>Recreate</code>. The <code>strategy.rollingUpdate</code>
values remain at their defaulted values, though the server expects them to be cleared.
If the <code>strategy.rollingUpdate</code> values had been defined initially in the configuration file,
it would have been more clear that they needed to be deleted.</li><li>Apply fails because <code>strategy.rollingUpdate</code> is not cleared. The <code>strategy.rollingupdate</code>
field cannot be defined with a <code>strategy.type</code> of <code>Recreate</code>.</li></ol><p>Recommendation: These fields should be explicitly defined in the object configuration file:</p><ul><li>Selectors and PodTemplate labels on workloads, such as Deployment, StatefulSet, Job, DaemonSet,
ReplicaSet, and ReplicationController</li><li>Deployment rollout strategy</li></ul><h3 id="how-to-clear-server-defaulted-fields-or-fields-set-by-other-writers">How to clear server-defaulted fields or fields set by other writers</h3><p>Fields that do not appear in the configuration file can be cleared by
setting their values to <code>null</code> and then applying the configuration file.
For fields defaulted by the server, this triggers re-defaulting
the values.</p><h2 id="how-to-change-ownership-of-a-field-between-the-configuration-file-and-direct-imperative-writers">How to change ownership of a field between the configuration file and direct imperative writers</h2><p>These are the only methods you should use to change an individual object field:</p><ul><li>Use <code>kubectl apply</code>.</li><li>Write directly to the live configuration without modifying the configuration file:
for example, use <code>kubectl scale</code>.</li></ul><h3 id="changing-the-owner-from-a-direct-imperative-writer-to-a-configuration-file">Changing the owner from a direct imperative writer to a configuration file</h3><p>Add the field to the configuration file. For the field, discontinue direct updates to
the live configuration that do not go through <code>kubectl apply</code>.</p><h3 id="changing-the-owner-from-a-configuration-file-to-a-direct-imperative-writer">Changing the owner from a configuration file to a direct imperative writer</h3><p>As of Kubernetes 1.5, changing ownership of a field from a configuration file to
an imperative writer requires manual steps:</p><ul><li>Remove the field from the configuration file.</li><li>Remove the field from the <code>kubectl.kubernetes.io/last-applied-configuration</code> annotation on the live object.</li></ul><h2 id="changing-management-methods">Changing management methods</h2><p>Kubernetes objects should be managed using only one method at a time.
Switching from one method to another is possible, but is a manual process.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>It is OK to use imperative deletion with declarative management.</div><h3 id="migrating-from-imperative-command-management-to-declarative-object-configuration">Migrating from imperative command management to declarative object configuration</h3><p>Migrating from imperative command management to declarative object
configuration involves several manual steps:</p><ol><li><p>Export the live object to a local configuration file:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get &lt;kind&gt;/&lt;name&gt; -o yaml &gt; &lt;kind&gt;_&lt;name&gt;.yaml
</span></span></code></pre></div></li><li><p>Manually remove the <code>status</code> field from the configuration file.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>This step is optional, as <code>kubectl apply</code> does not update the status field
even if it is present in the configuration file.</div></li><li><p>Set the <code>kubectl.kubernetes.io/last-applied-configuration</code> annotation on the object:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl replace --save-config -f &lt;kind&gt;_&lt;name&gt;.yaml
</span></span></code></pre></div></li><li><p>Change processes to use <code>kubectl apply</code> for managing the object exclusively.</p></li></ol><h3 id="migrating-from-imperative-object-configuration-to-declarative-object-configuration">Migrating from imperative object configuration to declarative object configuration</h3><ol><li><p>Set the <code>kubectl.kubernetes.io/last-applied-configuration</code> annotation on the object:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl replace --save-config -f &lt;kind&gt;_&lt;name&gt;.yaml
</span></span></code></pre></div></li><li><p>Change processes to use <code>kubectl apply</code> for managing the object exclusively.</p></li></ol><h2 id="defining-controller-selectors-and-podtemplate-labels">Defining controller selectors and PodTemplate labels</h2><div class="alert alert-danger" role="alert"><h4 class="alert-heading">Warning:</h4>Updating selectors on controllers is strongly discouraged.</div><p>The recommended approach is to define a single, immutable PodTemplate label
used only by the controller selector with no other semantic meaning.</p><p><strong>Example:</strong></p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">controller-selector</span>:<span style="color:#bbb"> </span><span style="color:#b44">"apps/v1/deployment/nginx"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">controller-selector</span>:<span style="color:#bbb"> </span><span style="color:#b44">"apps/v1/deployment/nginx"</span><span style="color:#bbb">
</span></span></span></code></pre></div><h2 id="what-s-next">What's next</h2><ul><li><a href="/docs/tasks/manage-kubernetes-objects/imperative-command/">Managing Kubernetes Objects Using Imperative Commands</a></li><li><a href="/docs/tasks/manage-kubernetes-objects/imperative-config/">Imperative Management of Kubernetes Objects Using Configuration Files</a></li><li><a href="/docs/reference/generated/kubectl/kubectl-commands/">Kubectl Command Reference</a></li><li><a href="/docs/reference/generated/kubernetes-api/v1.34/">Kubernetes API Reference</a></li></ul></div>
<hr>
<div class="td-content"><h1 data-pagefind-weight="10">Perform a Rollback on a DaemonSet</h1><p>This page shows how to perform a rollback on a <a class="glossary-tooltip" title="Ensures a copy of a Pod is running across a set of nodes in a cluster." data-toggle="tooltip" data-placement="top" href="/docs/concepts/workloads/controllers/daemonset" target="_blank" aria-label="DaemonSet">DaemonSet</a>.</p><h2 id="before-you-begin">Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul>Your Kubernetes server must be at or later than version 1.7.<p>To check the version, enter <code>kubectl version</code>.</p></p><p>You should already know how to <a href="/docs/tasks/manage-daemon/update-daemon-set/">perform a rolling update on a
DaemonSet</a>.</p><h2 id="performing-a-rollback-on-a-daemonset">Performing a rollback on a DaemonSet</h2><h3 id="step-1-find-the-daemonset-revision-you-want-to-roll-back-to">Step 1: Find the DaemonSet revision you want to roll back to</h3><p>You can skip this step if you only want to roll back to the last revision.</p><p>List all revisions of a DaemonSet:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl rollout <span style="color:#a2f">history</span> daemonset &lt;daemonset-name&gt;
</span></span></code></pre></div><p>This returns a list of DaemonSet revisions:</p><pre tabindex="0"><code>daemonsets "&lt;daemonset-name&gt;"
REVISION        CHANGE-CAUSE
1               ...
2               ...
...
</code></pre><ul><li>Change cause is copied from DaemonSet annotation <code>kubernetes.io/change-cause</code>
to its revisions upon creation. You may specify <code>--record=true</code> in <code>kubectl</code>
to record the command executed in the change cause annotation.</li></ul><p>To see the details of a specific revision:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl rollout <span style="color:#a2f">history</span> daemonset &lt;daemonset-name&gt; --revision<span style="color:#666">=</span><span style="color:#666">1</span>
</span></span></code></pre></div><p>This returns the details of that revision:</p><pre tabindex="0"><code>daemonsets "&lt;daemonset-name&gt;" with revision #1
Pod Template:
Labels:       foo=bar
Containers:
app:
 Image:        ...
 Port:         ...
 Environment:  ...
 Mounts:       ...
Volumes:      ...
</code></pre><h3 id="step-2-roll-back-to-a-specific-revision">Step 2: Roll back to a specific revision</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Specify the revision number you get from Step 1 in --to-revision</span>
</span></span><span style="display:flex"><span>kubectl rollout undo daemonset &lt;daemonset-name&gt; --to-revision<span style="color:#666">=</span>&lt;revision&gt;
</span></span></code></pre></div><p>If it succeeds, the command returns:</p><pre tabindex="0"><code>daemonset "&lt;daemonset-name&gt;" rolled back
</code></pre><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>If <code>--to-revision</code> flag is not specified, kubectl picks the most recent revision.</div><h3 id="step-3-watch-the-progress-of-the-daemonset-rollback">Step 3: Watch the progress of the DaemonSet rollback</h3><p><code>kubectl rollout undo daemonset</code> tells the server to start rolling back the
DaemonSet. The real rollback is done asynchronously inside the cluster
<a class="glossary-tooltip" title="The container orchestration layer that exposes the API and interfaces to define, deploy, and manage the lifecycle of containers." data-toggle="tooltip" data-placement="top" href="/docs/reference/glossary/?all=true#term-control-plane" target="_blank" aria-label="control plane">control plane</a>.</p><p>To watch the progress of the rollback:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl rollout status ds/&lt;daemonset-name&gt;
</span></span></code></pre></div><p>When the rollback is complete, the output is similar to:</p><pre tabindex="0"><code>daemonset "&lt;daemonset-name&gt;" successfully rolled out
</code></pre><h2 id="understanding-daemonset-revisions">Understanding DaemonSet revisions</h2><p>In the previous <code>kubectl rollout history</code> step, you got a list of DaemonSet
revisions. Each revision is stored in a resource named ControllerRevision.</p><p>To see what is stored in each revision, find the DaemonSet revision raw
resources:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get controllerrevision -l &lt;daemonset-selector-key&gt;<span style="color:#666">=</span>&lt;daemonset-selector-value&gt;
</span></span></code></pre></div><p>This returns a list of ControllerRevisions:</p><pre tabindex="0"><code>NAME                               CONTROLLER                     REVISION   AGE
&lt;daemonset-name&gt;-&lt;revision-hash&gt;   DaemonSet/&lt;daemonset-name&gt;     1          1h
&lt;daemonset-name&gt;-&lt;revision-hash&gt;   DaemonSet/&lt;daemonset-name&gt;     2          1h
</code></pre><p>Each ControllerRevision stores the annotations and template of a DaemonSet
revision.</p><p><code>kubectl rollout undo</code> takes a specific ControllerRevision and replaces
DaemonSet template with the template stored in the ControllerRevision.
<code>kubectl rollout undo</code> is equivalent to updating DaemonSet template to a
previous revision through other commands, such as <code>kubectl edit</code> or <code>kubectl apply</code>.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>DaemonSet revisions only roll forward. That is to say, after a
rollback completes, the revision number (<code>.revision</code> field) of the
ControllerRevision being rolled back to will advance. For example, if you
have revision 1 and 2 in the system, and roll back from revision 2 to revision
1, the ControllerRevision with <code>.revision: 1</code> will become <code>.revision: 3</code>.</div><h2 id="troubleshooting">Troubleshooting</h2><ul><li>See <a href="/docs/tasks/manage-daemon/update-daemon-set/#troubleshooting">troubleshooting DaemonSet rolling
update</a>.</li></ul></div>