<hr>
<div class="td-content"><h1 data-pagefind-weight="10">Running Kubelet in Standalone Mode</h1><p>This tutorial shows you how to run a standalone kubelet instance.</p><p>You may have different motivations for running a standalone kubelet.
This tutorial is aimed at introducing you to Kubernetes, even if you don't have
much experience with it. You can follow this tutorial and learn about node setup,
basic (static) Pods, and how Kubernetes manages containers.</p><p>Once you have followed this tutorial, you could try using a cluster that has a
<a class="glossary-tooltip" title="The container orchestration layer that exposes the API and interfaces to define, deploy, and manage the lifecycle of containers." data-toggle="tooltip" data-placement="top" href="/docs/reference/glossary/?all=true#term-control-plane" target="_blank" aria-label="control plane">control plane</a> to manage pods
and nodes, and other types of objects. For example,
<a href="/docs/tutorials/hello-minikube/">Hello, minikube</a>.</p><p>You can also run the kubelet in standalone mode to suit production use cases, such as
to run the control plane for a highly available, resiliently deployed cluster. This
tutorial does not cover the details you need for running a resilient control plane.</p><h2 id="objectives">Objectives</h2><ul><li>Install <code>cri-o</code>, and <code>kubelet</code> on a Linux system and run them as <code>systemd</code> services.</li><li>Launch a Pod running <code>nginx</code> that listens to requests on TCP port 80 on the Pod's IP address.</li><li>Learn how the different components of the solution interact among themselves.</li></ul><div class="alert alert-caution" role="alert"><h4 class="alert-heading">Caution:</h4>The kubelet configuration used for this tutorial is insecure by design and should
<em>not</em> be used in a production environment.</div><h2 id="before-you-begin">Before you begin</h2><ul><li>Admin (<code>root</code>) access to a Linux system that uses <code>systemd</code> and <code>iptables</code>
(or nftables with <code>iptables</code> emulation).</li><li>Access to the Internet to download the components needed for the tutorial, such as:<ul><li>A <a class="glossary-tooltip" title="The container runtime is the software that is responsible for running containers." data-toggle="tooltip" data-placement="top" href="/docs/setup/production-environment/container-runtimes" target="_blank" aria-label="container runtime">container runtime</a>
that implements the Kubernetes <a class="glossary-tooltip" title="Protocol for communication between the kubelet and the local container runtime." data-toggle="tooltip" data-placement="top" href="/docs/concepts/architecture/cri" target="_blank" aria-label="(CRI)">(CRI)</a>.</li><li>Network plugins (these are often known as
<a class="glossary-tooltip" title="Container network interface (CNI) plugins are a type of Network plugin that adheres to the appc/CNI specification." data-toggle="tooltip" data-placement="top" href="/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/" target="_blank" aria-label="Container Networking Interface (CNI)">Container Networking Interface (CNI)</a>)</li><li>Required CLI tools: <code>curl</code>, <code>tar</code>, <code>jq</code>.</li></ul></li></ul><h2 id="prepare-the-system">Prepare the system</h2><h3 id="swap-configuration">Swap configuration</h3><p>By default, kubelet fails to start if swap memory is detected on a node.
This means that swap should either be disabled or tolerated by kubelet.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>If you configure the kubelet to tolerate swap, the kubelet still configures Pods (and the
containers in those Pods) not to use swap space. To find out how Pods can actually
use the available swap, you can read more about
<a href="/docs/concepts/architecture/nodes/#swap-memory">swap memory management</a> on Linux nodes.</div><p>If you have swap memory enabled, either disable it or add <code>failSwapOn: false</code> to the
kubelet configuration file.</p><p>To check if swap is enabled:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>sudo swapon --show
</span></span></code></pre></div><p>If there is no output from the command, then swap memory is already disabled.</p><p>To disable swap temporarily:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>sudo swapoff -a
</span></span></code></pre></div><p>To make this change persistent across reboots:</p><p>Make sure swap is disabled in either <code>/etc/fstab</code> or <code>systemd.swap</code>, depending on how it was
configured on your system.</p><h3 id="enable-ipv4-packet-forwarding">Enable IPv4 packet forwarding</h3><p>To check if IPv4 packet forwarding is enabled:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>cat /proc/sys/net/ipv4/ip_forward
</span></span></code></pre></div><p>If the output is <code>1</code>, it is already enabled. If the output is <code>0</code>, then follow next steps.</p><p>To enable IPv4 packet forwarding, create a configuration file that sets the
<code>net.ipv4.ip_forward</code> parameter to <code>1</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>sudo tee /etc/sysctl.d/k8s.conf <span style="color:#b44">&lt;&lt;EOF
</span></span></span><span style="display:flex"><span><span style="color:#b44">net.ipv4.ip_forward = 1
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span></code></pre></div><p>Apply the changes to the system:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>sudo sysctl --system
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex="0"><code>...
* Applying /etc/sysctl.d/k8s.conf ...
net.ipv4.ip_forward = 1
* Applying /etc/sysctl.conf ...
</code></pre><h2 id="download-install-and-configure-the-components">Download, install, and configure the components</h2><div class="alert alert-secondary callout third-party-content" role="alert"><strong>Note:</strong> This section links to third party projects that provide functionality required by Kubernetes. The Kubernetes project authors aren't responsible for these projects, which are listed alphabetically. To add a project to this list, read the <a href="/docs/contribute/style/content-guide/#third-party-content">content guide</a> before submitting a change. <a href="#third-party-content-disclaimer">More information.</a></div><h3 id="container-runtime">Install a container runtime</h3><p>Download the latest available versions of the required packages (recommended).</p><p>This tutorial suggests installing the <a href="https://github.com/cri-o/cri-o">CRI-O container runtime</a>
(external link).</p><p>There are several <a href="https://github.com/cri-o/cri-o/blob/main/install.md">ways to install</a>
the CRI-O container runtime, depending on your particular Linux distribution. Although
CRI-O recommends using either <code>deb</code> or <code>rpm</code> packages, this tutorial uses the
<em>static binary bundle</em> script of the
<a href="https://github.com/cri-o/packaging/blob/main/README.md">CRI-O Packaging project</a>,
both to streamline the overall process, and to remain distribution agnostic.</p><p>The script installs and configures additional required software, such as
<a href="https://github.com/containernetworking/cni"><code>cni-plugins</code></a>, for container
networking, and <a href="https://github.com/containers/crun"><code>crun</code></a> and
<a href="https://github.com/opencontainers/runc"><code>runc</code></a>, for running containers.</p><p>The script will automatically detect your system's processor architecture
(<code>amd64</code> or <code>arm64</code>) and select and install the latest versions of the software packages.</p><h3 id="cri-o-setup">Set up CRI-O</h3><p>Visit the <a href="https://github.com/cri-o/cri-o/releases">releases</a> page (external link).</p><p>Download the static binary bundle script:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>curl https://raw.githubusercontent.com/cri-o/packaging/main/get &gt; crio-install
</span></span></code></pre></div><p>Run the installer script:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>sudo bash crio-install
</span></span></code></pre></div><p>Enable and start the <code>crio</code> service:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>sudo systemctl daemon-reload
</span></span><span style="display:flex"><span>sudo systemctl <span style="color:#a2f">enable</span> --now crio.service
</span></span></code></pre></div><p>Quick test:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>sudo systemctl is-active crio.service
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex="0"><code>active
</code></pre><p>Detailed service check:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>sudo journalctl -f -u crio.service
</span></span></code></pre></div><h3 id="install-network-plugins">Install network plugins</h3><p>The <code>cri-o</code> installer installs and configures the <code>cni-plugins</code> package. You can
verify the installation running the following command:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>/opt/cni/bin/bridge --version
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex="0"><code>CNI bridge plugin v1.5.1
CNI protocol versions supported: 0.1.0, 0.2.0, 0.3.0, 0.3.1, 0.4.0, 1.0.0
</code></pre><p>To check the default configuration:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>cat /etc/cni/net.d/11-crio-ipv4-bridge.conflist
</span></span></code></pre></div><p>The output is similar to:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="display:flex"><span>{
</span></span><span style="display:flex"><span>  <span style="color:green;font-weight:700">"cniVersion"</span>: <span style="color:#b44">"1.0.0"</span>,
</span></span><span style="display:flex"><span>  <span style="color:green;font-weight:700">"name"</span>: <span style="color:#b44">"crio"</span>,
</span></span><span style="display:flex"><span>  <span style="color:green;font-weight:700">"plugins"</span>: [
</span></span><span style="display:flex"><span>    {
</span></span><span style="display:flex"><span>      <span style="color:green;font-weight:700">"type"</span>: <span style="color:#b44">"bridge"</span>,
</span></span><span style="display:flex"><span>      <span style="color:green;font-weight:700">"bridge"</span>: <span style="color:#b44">"cni0"</span>,
</span></span><span style="display:flex"><span>      <span style="color:green;font-weight:700">"isGateway"</span>: <span style="color:#a2f;font-weight:700">true</span>,
</span></span><span style="display:flex"><span>      <span style="color:green;font-weight:700">"ipMasq"</span>: <span style="color:#a2f;font-weight:700">true</span>,
</span></span><span style="display:flex"><span>      <span style="color:green;font-weight:700">"hairpinMode"</span>: <span style="color:#a2f;font-weight:700">true</span>,
</span></span><span style="display:flex"><span>      <span style="color:green;font-weight:700">"ipam"</span>: {
</span></span><span style="display:flex"><span>        <span style="color:green;font-weight:700">"type"</span>: <span style="color:#b44">"host-local"</span>,
</span></span><span style="display:flex"><span>        <span style="color:green;font-weight:700">"routes"</span>: [
</span></span><span style="display:flex"><span>            { <span style="color:green;font-weight:700">"dst"</span>: <span style="color:#b44">"0.0.0.0/0"</span> }
</span></span><span style="display:flex"><span>        ],
</span></span><span style="display:flex"><span>        <span style="color:green;font-weight:700">"ranges"</span>: [
</span></span><span style="display:flex"><span>            [{ <span style="color:green;font-weight:700">"subnet"</span>: <span style="color:#b44">"10.85.0.0/16"</span> }]
</span></span><span style="display:flex"><span>        ]
</span></span><span style="display:flex"><span>      }
</span></span><span style="display:flex"><span>    }
</span></span><span style="display:flex"><span>  ]
</span></span><span style="display:flex"><span>}
</span></span></code></pre></div><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>Make sure that the default <code>subnet</code> range (<code>10.85.0.0/16</code>) does not overlap with
any of your active networks. If there is an overlap, you can edit the file and change it
accordingly. Restart the service after the change.</div><h3 id="download-and-set-up-the-kubelet">Download and set up the kubelet</h3><p>Download the <a href="/releases/download/">latest stable release</a> of the kubelet.</p><ul class="nav nav-tabs" id="download-kubelet" role="tablist"><li class="nav-item"><a data-toggle="tab" class="nav-link active" href="#download-kubelet-0" role="tab" aria-controls="download-kubelet-0" aria-selected="true">x86-64</a></li><li class="nav-item"><a data-toggle="tab" class="nav-link" href="#download-kubelet-1" role="tab" aria-controls="download-kubelet-1">ARM64</a></li></ul><div class="tab-content" id="download-kubelet"><div id="download-kubelet-0" class="tab-pane show active" role="tabpanel" aria-labelledby="download-kubelet-0"><p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>
</span></span><span style="display:flex"><span>curl -LO <span style="color:#b44">"https://dl.k8s.io/release/</span><span style="color:#a2f;font-weight:700">$(</span>curl -L -s https://dl.k8s.io/release/stable.txt<span style="color:#a2f;font-weight:700">)</span><span style="color:#b44">/bin/linux/amd64/kubelet"</span>
</span></span></code></pre></div></p></div><div id="download-kubelet-1" class="tab-pane" role="tabpanel" aria-labelledby="download-kubelet-1"><p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>
</span></span><span style="display:flex"><span>curl -LO <span style="color:#b44">"https://dl.k8s.io/release/</span><span style="color:#a2f;font-weight:700">$(</span>curl -L -s https://dl.k8s.io/release/stable.txt<span style="color:#a2f;font-weight:700">)</span><span style="color:#b44">/bin/linux/arm64/kubelet"</span>
</span></span></code></pre></div></p></div></div><p>Configure:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>sudo mkdir -p /etc/kubernetes/manifests
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>sudo tee /etc/kubernetes/kubelet.yaml <span style="color:#b44">&lt;&lt;EOF
</span></span></span><span style="display:flex"><span><span style="color:#b44">apiVersion: kubelet.config.k8s.io/v1beta1
</span></span></span><span style="display:flex"><span><span style="color:#b44">kind: KubeletConfiguration
</span></span></span><span style="display:flex"><span><span style="color:#b44">authentication:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  webhook:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    enabled: false # Do NOT use in production clusters!
</span></span></span><span style="display:flex"><span><span style="color:#b44">authorization:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  mode: AlwaysAllow # Do NOT use in production clusters!
</span></span></span><span style="display:flex"><span><span style="color:#b44">enableServer: false
</span></span></span><span style="display:flex"><span><span style="color:#b44">logging:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  format: text
</span></span></span><span style="display:flex"><span><span style="color:#b44">address: 127.0.0.1 # Restrict access to localhost
</span></span></span><span style="display:flex"><span><span style="color:#b44">readOnlyPort: 10255 # Do NOT use in production clusters!
</span></span></span><span style="display:flex"><span><span style="color:#b44">staticPodPath: /etc/kubernetes/manifests
</span></span></span><span style="display:flex"><span><span style="color:#b44">containerRuntimeEndpoint: unix:///var/run/crio/crio.sock
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span></code></pre></div><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4><p>Because you are not setting up a production cluster, you are using plain HTTP
(<code>readOnlyPort: 10255</code>) for unauthenticated queries to the kubelet's API.</p><p>The <em>authentication webhook</em> is disabled and <em>authorization mode</em> is set to <code>AlwaysAllow</code>
for the purpose of this tutorial. You can learn more about
<a href="/docs/reference/access-authn-authz/authorization/#authorization-modules">authorization modes</a>
and <a href="/docs/reference/access-authn-authz/webhook/">webhook authentication</a> to properly
configure kubelet in standalone mode in your environment.</p><p>See <a href="/docs/reference/networking/ports-and-protocols/">Ports and Protocols</a> to
understand which ports Kubernetes components use.</p></div><p>Install:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>chmod +x kubelet
</span></span><span style="display:flex"><span>sudo cp kubelet /usr/bin/
</span></span></code></pre></div><p>Create a <code>systemd</code> service unit file:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>sudo tee /etc/systemd/system/kubelet.service <span style="color:#b44">&lt;&lt;EOF
</span></span></span><span style="display:flex"><span><span style="color:#b44">[Unit]
</span></span></span><span style="display:flex"><span><span style="color:#b44">Description=Kubelet
</span></span></span><span style="display:flex"><span><span style="color:#b44">
</span></span></span><span style="display:flex"><span><span style="color:#b44">[Service]
</span></span></span><span style="display:flex"><span><span style="color:#b44">ExecStart=/usr/bin/kubelet \
</span></span></span><span style="display:flex"><span><span style="color:#b44"> --config=/etc/kubernetes/kubelet.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">Restart=always
</span></span></span><span style="display:flex"><span><span style="color:#b44">
</span></span></span><span style="display:flex"><span><span style="color:#b44">[Install]
</span></span></span><span style="display:flex"><span><span style="color:#b44">WantedBy=multi-user.target
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span></code></pre></div><p>The command line argument <code>--kubeconfig</code> has been intentionally omitted in the
service configuration file. This argument sets the path to a
<a href="/docs/concepts/configuration/organize-cluster-access-kubeconfig/">kubeconfig</a>
file that specifies how to connect to the API server, enabling API server mode.
Omitting it, enables standalone mode.</p><p>Enable and start the <code>kubelet</code> service:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>sudo systemctl daemon-reload
</span></span><span style="display:flex"><span>sudo systemctl <span style="color:#a2f">enable</span> --now kubelet.service
</span></span></code></pre></div><p>Quick test:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>sudo systemctl is-active kubelet.service
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex="0"><code>active
</code></pre><p>Detailed service check:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>sudo journalctl -u kubelet.service
</span></span></code></pre></div><p>Check the kubelet's API <code>/healthz</code> endpoint:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>curl http://localhost:10255/healthz?verbose
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex="0"><code>[+]ping ok
[+]log ok
[+]syncloop ok
healthz check passed
</code></pre><p>Query the kubelet's API <code>/pods</code> endpoint:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>curl http://localhost:10255/pods | jq <span style="color:#b44">'.'</span>
</span></span></code></pre></div><p>The output is similar to:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="display:flex"><span>{
</span></span><span style="display:flex"><span>  <span style="color:green;font-weight:700">"kind"</span>: <span style="color:#b44">"PodList"</span>,
</span></span><span style="display:flex"><span>  <span style="color:green;font-weight:700">"apiVersion"</span>: <span style="color:#b44">"v1"</span>,
</span></span><span style="display:flex"><span>  <span style="color:green;font-weight:700">"metadata"</span>: {},
</span></span><span style="display:flex"><span>  <span style="color:green;font-weight:700">"items"</span>: <span style="color:#a2f;font-weight:700">null</span>
</span></span><span style="display:flex"><span>}
</span></span></code></pre></div><h2 id="run-a-pod-in-the-kubelet">Run a Pod in the kubelet</h2><p>In standalone mode, you can run Pods using Pod manifests. The manifests can either
be on the local filesystem, or fetched via HTTP from a configuration source.</p><p>Create a manifest for a Pod:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt; static-web.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">apiVersion: v1
</span></span></span><span style="display:flex"><span><span style="color:#b44">kind: Pod
</span></span></span><span style="display:flex"><span><span style="color:#b44">metadata:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  name: static-web
</span></span></span><span style="display:flex"><span><span style="color:#b44">spec:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  containers:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    - name: web
</span></span></span><span style="display:flex"><span><span style="color:#b44">      image: nginx
</span></span></span><span style="display:flex"><span><span style="color:#b44">      ports:
</span></span></span><span style="display:flex"><span><span style="color:#b44">        - name: web
</span></span></span><span style="display:flex"><span><span style="color:#b44">          containerPort: 80
</span></span></span><span style="display:flex"><span><span style="color:#b44">          protocol: TCP
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span></code></pre></div><p>Copy the <code>static-web.yaml</code> manifest file to the <code>/etc/kubernetes/manifests</code> directory.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>sudo cp static-web.yaml /etc/kubernetes/manifests/
</span></span></code></pre></div><h3 id="find-out-information">Find out information about the kubelet and the Pod</h3><p>The Pod networking plugin creates a network bridge (<code>cni0</code>) and a pair of <code>veth</code> interfaces
for each Pod (one of the pair is inside the newly made Pod, and the other is at the host level).</p><p>Query the kubelet's API endpoint at <code>http://localhost:10255/pods</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>curl http://localhost:10255/pods | jq <span style="color:#b44">'.'</span>
</span></span></code></pre></div><p>To obtain the IP address of the <code>static-web</code> Pod:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>curl http://localhost:10255/pods | jq <span style="color:#b44">'.items[].status.podIP'</span>
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex="0"><code>"10.85.0.4"
</code></pre><p>Connect to the <code>nginx</code> server Pod on <code>http://&lt;IP&gt;:&lt;Port&gt;</code> (port 80 is the default), in this case:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>curl http://10.85.0.4
</span></span></code></pre></div><p>The output is similar to:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html"><span style="display:flex"><span><span style="color:#080">&lt;!DOCTYPE html&gt;</span>
</span></span><span style="display:flex"><span>&lt;<span style="color:green;font-weight:700">html</span>&gt;
</span></span><span style="display:flex"><span>&lt;<span style="color:green;font-weight:700">head</span>&gt;
</span></span><span style="display:flex"><span>&lt;<span style="color:green;font-weight:700">title</span>&gt;Welcome to nginx!&lt;/<span style="color:green;font-weight:700">title</span>&gt;
</span></span><span style="display:flex"><span>...
</span></span></code></pre></div><h2 id="where-to-look-for-more-details">Where to look for more details</h2><p>If you need to diagnose a problem getting this tutorial to work, you can look
within the following directories for monitoring and troubleshooting:</p><pre tabindex="0"><code>/var/lib/cni
/var/lib/containers
/var/lib/kubelet

/var/log/containers
/var/log/pods
</code></pre><h2 id="clean-up">Clean up</h2><h3 id="kubelet">kubelet</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>sudo systemctl disable --now kubelet.service
</span></span><span style="display:flex"><span>sudo systemctl daemon-reload
</span></span><span style="display:flex"><span>sudo rm /etc/systemd/system/kubelet.service
</span></span><span style="display:flex"><span>sudo rm /usr/bin/kubelet
</span></span><span style="display:flex"><span>sudo rm -rf /etc/kubernetes
</span></span><span style="display:flex"><span>sudo rm -rf /var/lib/kubelet
</span></span><span style="display:flex"><span>sudo rm -rf /var/log/containers
</span></span><span style="display:flex"><span>sudo rm -rf /var/log/pods
</span></span></code></pre></div><h3 id="container-runtime-1">Container Runtime</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>sudo systemctl disable --now crio.service
</span></span><span style="display:flex"><span>sudo systemctl daemon-reload
</span></span><span style="display:flex"><span>sudo rm -rf /usr/local/bin
</span></span><span style="display:flex"><span>sudo rm -rf /usr/local/lib
</span></span><span style="display:flex"><span>sudo rm -rf /usr/local/share
</span></span><span style="display:flex"><span>sudo rm -rf /usr/libexec/crio
</span></span><span style="display:flex"><span>sudo rm -rf /etc/crio
</span></span><span style="display:flex"><span>sudo rm -rf /etc/containers
</span></span></code></pre></div><h3 id="network-plugins">Network Plugins</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>sudo rm -rf /opt/cni
</span></span><span style="display:flex"><span>sudo rm -rf /etc/cni
</span></span><span style="display:flex"><span>sudo rm -rf /var/lib/cni
</span></span></code></pre></div><h2 id="conclusion">Conclusion</h2><p>This page covered the basic aspects of deploying a kubelet in standalone mode.
You are now ready to deploy Pods and test additional functionality.</p><p>Notice that in standalone mode the kubelet does <em>not</em> support fetching Pod
configurations from the control plane (because there is no control plane connection).</p><p>You also cannot use a <a class="glossary-tooltip" title="An API object used to store non-confidential data in key-value pairs. Can be consumed as environment variables, command-line arguments, or configuration files in a volume." data-toggle="tooltip" data-placement="top" href="/docs/concepts/configuration/configmap/" target="_blank" aria-label="ConfigMap">ConfigMap</a> or a
<a class="glossary-tooltip" title="Stores sensitive information, such as passwords, OAuth tokens, and ssh keys." data-toggle="tooltip" data-placement="top" href="/docs/concepts/configuration/secret/" target="_blank" aria-label="Secret">Secret</a> to configure the containers
in a static Pod.</p><h2 id="what-s-next">What's next</h2><ul><li>Follow <a href="/docs/tutorials/hello-minikube/">Hello, minikube</a> to learn about running Kubernetes
<em>with</em> a control plane. The minikube tool helps you set up a practice cluster on your own computer.</li><li>Learn more about <a href="/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/">Network Plugins</a></li><li>Learn more about <a href="/docs/setup/production-environment/container-runtimes/">Container Runtimes</a></li><li>Learn more about <a href="/docs/reference/command-line-tools-reference/kubelet/">kubelet</a></li><li>Learn more about <a href="/docs/tasks/configure-pod-container/static-pod/">static Pods</a></li></ul></div>
<hr>
<div class="td-content"><h1 data-pagefind-weight="10">Adopting Sidecar Containers</h1><p>This section is relevant for people adopting a new built-in
<a href="/docs/concepts/workloads/pods/sidecar-containers/">sidecar containers</a> feature for their workloads.</p><p>Sidecar container is not a new concept as posted in the
<a href="/blog/2015/06/the-distributed-system-toolkit-patterns/">blog post</a>.
Kubernetes allows running multiple containers in a Pod to implement this concept.
However, running a sidecar container as a regular container
has a lot of limitations being fixed with the new built-in sidecar containers support.</p><div class="feature-state-notice feature-stable" title="Feature Gate: SidecarContainers"><span class="feature-state-name">FEATURE STATE:</span>
<code>Kubernetes v1.33 [stable]</code> (enabled by default: true)</div><h2 id="objectives">Objectives</h2><ul><li>Understand the need for sidecar containers</li><li>Be able to troubleshoot issues with the sidecar containers</li><li>Understand options to universally "inject" sidecar containers to any workload</li></ul><h2 id="before-you-begin">Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul>Your Kubernetes server must be at or later than version 1.29.<p>To check the version, enter <code>kubectl version</code>.</p></p><h2 id="sidecar-containers-overview">Sidecar containers overview</h2><p>Sidecar containers are secondary containers that run along with the main
application container within the same <a class="glossary-tooltip" title="A Pod represents a set of running containers in your cluster." data-toggle="tooltip" data-placement="top" href="/docs/concepts/workloads/pods/" target="_blank" aria-label="Pod">Pod</a>.
These containers are used to enhance or to extend the functionality of the primary <em>app
container</em> by providing additional services, or functionalities such as logging, monitoring,
security, or data synchronization, without directly altering the primary application code.
You can read more in the <a href="/docs/concepts/workloads/pods/sidecar-containers/">Sidecar containers</a>
concept page.</p><p>The concept of sidecar containers is not new and there are multiple implementations of this concept.
As well as sidecar containers that you, the person defining the Pod, want to run, you can also find
that some <a class="glossary-tooltip" title="Resources that extend the functionality of Kubernetes." data-toggle="tooltip" data-placement="top" href="/docs/concepts/cluster-administration/addons/" target="_blank" aria-label="addons">addons</a> modify Pods - before the Pods
start running - so that there are extra sidecar containers. The mechanisms to <em>inject</em> those extra
sidecars are often <a href="/docs/reference/access-authn-authz/admission-controllers/#mutatingadmissionwebhook">mutating webhooks</a>.
For example, a service mesh addon might inject a sidecar that configures mutual TLS and encryption
in transit between different Pods.</p><p>While the concept of sidecar containers is not new,
the native implementation of this feature in Kubernetes, however, is new. And as with every new feature,
adopting this feature may present certain challenges.</p><p>This tutorial explores challenges and solutions that can be experienced by end users as well as
by authors of sidecar containers.</p><h2 id="benefits-of-a-built-in-sidecar-container">Benefits of a built-in sidecar container</h2><p>Using Kubernetes' native support for sidecar containers provides several benefits:</p><ol><li>You can configure a native sidecar container to start ahead of
<a class="glossary-tooltip" title="One or more initialization containers that must run to completion before any app containers run." data-toggle="tooltip" data-placement="top" href="/docs/concepts/workloads/pods/init-containers/" target="_blank" aria-label="init containers">init containers</a>.</li><li>The built-in sidecar containers can be authored to guarantee that they are terminated last.
Sidecar containers are terminated with a <code>SIGTERM</code> signal once all the regular containers
are completed and terminated. If the sidecar container isn’t gracefully shut down, a
<code>SIGKILL</code> signal will be used to terminate it.</li><li>With Jobs, when Pod's <code>restartPolicy: OnFailure</code> or <code>restartPolicy: Never</code>,
native sidecar containers do not block Pod completion. With legacy sidecar containers,
special care is needed to handle this situation.</li><li>Also, with Jobs, built-in sidecar containers would keep being restarted once they are done,
even if regular containers would not with Pod's <code>restartPolicy: Never</code>.</li></ol><p>See <a href="/docs/concepts/workloads/pods/sidecar-containers/#differences-from-application-containers">differences from init containers</a>
to learn more about it.</p><h2 id="adopting-built-in-sidecar-containers">Adopting built-in sidecar containers</h2><p>The <code>SidecarContainers</code> <a href="/docs/reference/command-line-tools-reference/feature-gates/">feature gate</a>
is in beta state starting from Kubernetes version 1.29 and is enabled by default.
Some clusters may have this feature disabled or have software installed that is incompatible with the feature.</p><p>When this happens, the Pod may be rejected or the sidecar containers may block Pod startup,
rendering the Pod useless. This condition is easy to detect as the Pod simply gets stuck on
initialization. However, it is often unclear what caused the problem.</p><p>Here are the considerations and troubleshooting steps that one can take while adopting sidecar containers for their workload.</p><h3 id="ensure-the-feature-gate-is-enabled">Ensure the feature gate is enabled</h3><p>As a very first step, make sure that both API server and Nodes are at Kubernetes version v1.29 or
later. The feature will break on clusters where Nodes are running earlier versions where it is not enabled.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note</h4>The feature can be enabled on nodes with the version 1.28. The behavior of built-in sidecar
container termination was different in version 1.28, and it is not recommended to adjust
the behavior of a sidecar to that behavior. However, if the only concern is the startup order, the
above statement can be changed to Nodes running version 1.28 with the feature gate enabled.</div><p>You should ensure that the feature gate is enabled for the API server(s) within the control plane
<strong>and</strong> for all nodes.</p><p>One of the ways to check the feature gate enablement is to run a command like this:</p><ul><li><p>For API Server:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get --raw /metrics | grep kubernetes_feature_enabled | grep SidecarContainers
</span></span></code></pre></div></li><li><p>For the individual node:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get --raw /api/v1/nodes/&lt;node-name&gt;/proxy/metrics | grep kubernetes_feature_enabled | grep SidecarContainers
</span></span></code></pre></div></li></ul><p>If you see something like this:</p><pre tabindex="0"><code>kubernetes_feature_enabled{name="SidecarContainers",stage="BETA"} 1
</code></pre><p>it means that the feature is enabled.</p><h3 id="check-for-3rd-party-tooling-and-mutating-webhooks">Check for 3rd party tooling and mutating webhooks</h3><p>If you experience issues when validating the feature, it may be an indication that one of the
3rd party tools or mutating webhooks are broken.</p><p>When the <code>SidecarContainers</code> feature gate is enabled, Pods gain a new field in their API.
Some tools or mutating webhooks might have been built with an earlier version of Kubernetes API.</p><p>If tools pass unknown fields as-is using various patching strategies to mutate a Pod object,
this will not be a problem. However, there are tools that will strip out unknown fields;
if you have those, they must be recompiled with the v1.28+ version of Kubernetes API client code.</p><p>The way to check this is to use the <code>kubectl describe pod</code> command with your Pod that has passed through
mutating admission. If any tools stripped out the new field (<code>restartPolicy:Always</code>),
you will not see it in the command output.</p><p>If you hit an issue like this, please advise the author of the tools or the webhooks
use one of the patching strategies for modifying objects instead of a full object update.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note</h4>Mutating webhook may update Pods based on some conditions.
Thus, sidecar containers may work for some Pods and fail for others.</div><h3 id="automatic-injection-of-sidecars">Automatic injection of sidecars</h3><p>If you are using software that injects sidecars automatically,
there are a few possible strategies you may follow to
ensure that native sidecar containers can be used.
All strategies are generally options you may choose to decide whether
the Pod the sidecar will be injected to will land on a Node supporting the feature or not.</p><p>As an example, you can follow <a href="https://github.com/istio/istio/issues/48794">this conversation in Istio community</a>.
The discussion explores the options listed below.</p><ol><li>Mark Pods that land to nodes supporting sidecars. You can use node labels
and node affinity to mark nodes supporting sidecar containers and Pods landing on those nodes.</li><li>Check Nodes compatibility on injection. During sidecar injection, you may use
the following strategies to check node compatibility:<ul><li>query node version and assume the feature gate is enabled on the version 1.29+</li><li>query node prometheus metrics and check feature enablement status</li><li>assume the nodes are running with a <a href="/releases/version-skew-policy/#supported-version-skew">supported version skew</a>
from the API server</li><li>there may be other custom ways to detect nodes compatibility.</li></ul></li><li>Develop a universal sidecar injector. The idea of a universal sidecar injector is to
inject a sidecar container as a regular container as well as a native sidecar container.
And have a runtime logic to decide which one will work. The universal sidecar injector
is wasteful, as it will account for requests twice, but may be considered as a workable
solution for special cases.<ul><li>One way would be on start of a native sidecar container
detect the node version and exit immediately if the version does not support the sidecar feature.</li><li>Consider a runtime feature detection design:<ul><li>Define an empty dir so containers can communicate with each other</li><li>Inject an init container, let's call it <code>NativeSidecar</code> with <code>restartPolicy=Always</code>.</li><li><code>NativeSidecar</code> must write a file to an empty directory indicating the first run and exit
immediately with exit code <code>0</code>.</li><li><code>NativeSidecar</code> on restart (when native sidecars are supported) checks that file already
exists in the empty dir and changes it - indicating that the built-in sidecar containers
are supported and running.</li><li>Inject regular container, let's call it <code>OldWaySidecar</code>.</li><li><code>OldWaySidecar</code> on start checks the presence of a file in an empty dir.</li><li>If the file indicates that the <code>NativeSidecar</code> is NOT running, it assumes that the sidecar
feature is not supported and works assuming it is the sidecar.</li><li>If the file indicates that the <code>NativeSidecar</code> is running, it either does nothing and sleeps
forever (in the case when Pod’s <code>restartPolicy=Always</code>) or exits immediately with exit code <code>0</code>
(in the case when Pod’s <code>restartPolicy!=Always</code>).</li></ul></li></ul></li></ol><h2 id="what-s-next">What's next</h2><ul><li>Learn more about <a href="/docs/concepts/workloads/pods/sidecar-containers/">sidecar containers</a>.</li></ul></div>
<hr>
<div class="td-content"><h1 data-pagefind-weight="10">Configuring Redis using a ConfigMap</h1><p>This page provides a real world example of how to configure Redis using a ConfigMap and builds upon the <a href="/docs/tasks/configure-pod-container/configure-pod-configmap/">Configure a Pod to Use a ConfigMap</a> task.</p><h2 id="objectives">Objectives</h2><ul><li>Create a ConfigMap with Redis configuration values</li><li>Create a Redis Pod that mounts and uses the created ConfigMap</li><li>Verify that the configuration was correctly applied.</li></ul><h2 id="before-you-begin">Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul><p>To check the version, enter <code>kubectl version</code>.</p></p><ul><li>The example shown on this page works with <code>kubectl</code> 1.14 and above.</li><li>Understand <a href="/docs/tasks/configure-pod-container/configure-pod-configmap/">Configure a Pod to Use a ConfigMap</a>.</li></ul><h2 id="real-world-example-configuring-redis-using-a-configmap">Real World Example: Configuring Redis using a ConfigMap</h2><p>Follow the steps below to configure a Redis cache using data stored in a ConfigMap.</p><p>First create a ConfigMap with an empty configuration block:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt;./example-redis-config.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">apiVersion: v1
</span></span></span><span style="display:flex"><span><span style="color:#b44">kind: ConfigMap
</span></span></span><span style="display:flex"><span><span style="color:#b44">metadata:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  name: example-redis-config
</span></span></span><span style="display:flex"><span><span style="color:#b44">data:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  redis-config: ""
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span></code></pre></div><p>Apply the ConfigMap created above, along with a Redis pod manifest:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f example-redis-config.yaml
</span></span><span style="display:flex"><span>kubectl apply -f https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/config/redis-pod.yaml
</span></span></code></pre></div><p>Examine the contents of the Redis pod manifest and note the following:</p><ul><li>A volume named <code>config</code> is created by <code>spec.volumes[1]</code></li><li>The <code>key</code> and <code>path</code> under <code>spec.volumes[1].configMap.items[0]</code> exposes the <code>redis-config</code> key from the
<code>example-redis-config</code> ConfigMap as a file named <code>redis.conf</code> on the <code>config</code> volume.</li><li>The <code>config</code> volume is then mounted at <code>/redis-master</code> by <code>spec.containers[0].volumeMounts[1]</code>.</li></ul><p>This has the net effect of exposing the data in <code>data.redis-config</code> from the <code>example-redis-config</code>
ConfigMap above as <code>/redis-master/redis.conf</code> inside the Pod.</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/config/redis-pod.yaml" download="pods/config/redis-pod.yaml"><code>pods/config/redis-pod.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;pods-config-redis-pod-yaml&quot;)" title="Copy pods/config/redis-pod.yaml to clipboard"/></div><div class="includecode" id="pods-config-redis-pod-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Pod<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>redis<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>redis<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>redis:8.0.2<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">command</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- redis-server<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:#b44">"/redis-master/redis.conf"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">env</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>MASTER<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">value</span>:<span style="color:#bbb"> </span><span style="color:#b44">"true"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">6379</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">limits</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">cpu</span>:<span style="color:#bbb"> </span><span style="color:#b44">"0.1"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">volumeMounts</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span>/redis-master-data<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>data<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span>/redis-master<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>config<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>data<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">emptyDir</span>:<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>config<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">configMap</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>example-redis-config<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">items</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">key</span>:<span style="color:#bbb"> </span>redis-config<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">path</span>:<span style="color:#bbb"> </span>redis.conf<span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>Examine the created objects:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pod/redis configmap/example-redis-config 
</span></span></code></pre></div><p>You should see the following output:</p><pre tabindex="0"><code>NAME        READY   STATUS    RESTARTS   AGE
pod/redis   1/1     Running   0          8s

NAME                             DATA   AGE
configmap/example-redis-config   1      14s
</code></pre><p>Recall that we left <code>redis-config</code> key in the <code>example-redis-config</code> ConfigMap blank:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl describe configmap/example-redis-config
</span></span></code></pre></div><p>You should see an empty <code>redis-config</code> key:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>Name:         example-redis-config
</span></span><span style="display:flex"><span>Namespace:    default
</span></span><span style="display:flex"><span>Labels:       &lt;none&gt;
</span></span><span style="display:flex"><span>Annotations:  &lt;none&gt;
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#b8860b">Data</span>
</span></span><span style="display:flex"><span><span style="color:#666">====</span>
</span></span><span style="display:flex"><span>redis-config:
</span></span></code></pre></div><p>Use <code>kubectl exec</code> to enter the pod and run the <code>redis-cli</code> tool to check the current configuration:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl <span style="color:#a2f">exec</span> -it pod/redis -- redis-cli
</span></span></code></pre></div><p>Check <code>maxmemory</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>127.0.0.1:6379&gt; CONFIG GET maxmemory
</span></span></code></pre></div><p>It should show the default value of 0:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>1<span style="color:#666">)</span> <span style="color:#b44">"maxmemory"</span>
</span></span><span style="display:flex"><span>2<span style="color:#666">)</span> <span style="color:#b44">"0"</span>
</span></span></code></pre></div><p>Similarly, check <code>maxmemory-policy</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>127.0.0.1:6379&gt; CONFIG GET maxmemory-policy
</span></span></code></pre></div><p>Which should also yield its default value of <code>noeviction</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>1<span style="color:#666">)</span> <span style="color:#b44">"maxmemory-policy"</span>
</span></span><span style="display:flex"><span>2<span style="color:#666">)</span> <span style="color:#b44">"noeviction"</span>
</span></span></code></pre></div><p>Now let's add some configuration values to the <code>example-redis-config</code> ConfigMap:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/config/example-redis-config.yaml" download="pods/config/example-redis-config.yaml"><code>pods/config/example-redis-config.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;pods-config-example-redis-config-yaml&quot;)" title="Copy pods/config/example-redis-config.yaml to clipboard"/></div><div class="includecode" id="pods-config-example-redis-config-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ConfigMap<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>example-redis-config<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">data</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">redis-config</span>:<span style="color:#bbb"> </span>|<span style="color:#b44;font-style:italic">
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">    maxmemory 2mb
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">    maxmemory-policy allkeys-lru</span><span style="color:#bbb">    
</span></span></span></code></pre></div></div></div><p>Apply the updated ConfigMap:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f example-redis-config.yaml
</span></span></code></pre></div><p>Confirm that the ConfigMap was updated:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl describe configmap/example-redis-config
</span></span></code></pre></div><p>You should see the configuration values we just added:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>Name:         example-redis-config
</span></span><span style="display:flex"><span>Namespace:    default
</span></span><span style="display:flex"><span>Labels:       &lt;none&gt;
</span></span><span style="display:flex"><span>Annotations:  &lt;none&gt;
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#b8860b">Data</span>
</span></span><span style="display:flex"><span><span style="color:#666">====</span>
</span></span><span style="display:flex"><span>redis-config:
</span></span><span style="display:flex"><span>----
</span></span><span style="display:flex"><span>maxmemory 2mb
</span></span><span style="display:flex"><span>maxmemory-policy allkeys-lru
</span></span></code></pre></div><p>Check the Redis Pod again using <code>redis-cli</code> via <code>kubectl exec</code> to see if the configuration was applied:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl <span style="color:#a2f">exec</span> -it pod/redis -- redis-cli
</span></span></code></pre></div><p>Check <code>maxmemory</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>127.0.0.1:6379&gt; CONFIG GET maxmemory
</span></span></code></pre></div><p>It remains at the default value of 0:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>1<span style="color:#666">)</span> <span style="color:#b44">"maxmemory"</span>
</span></span><span style="display:flex"><span>2<span style="color:#666">)</span> <span style="color:#b44">"0"</span>
</span></span></code></pre></div><p>Similarly, <code>maxmemory-policy</code> remains at the <code>noeviction</code> default setting:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>127.0.0.1:6379&gt; CONFIG GET maxmemory-policy
</span></span></code></pre></div><p>Returns:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>1<span style="color:#666">)</span> <span style="color:#b44">"maxmemory-policy"</span>
</span></span><span style="display:flex"><span>2<span style="color:#666">)</span> <span style="color:#b44">"noeviction"</span>
</span></span></code></pre></div><p>The configuration values have not changed because the Pod needs to be restarted to grab updated
values from associated ConfigMaps. Let's delete and recreate the Pod:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl delete pod redis
</span></span><span style="display:flex"><span>kubectl apply -f https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/config/redis-pod.yaml
</span></span></code></pre></div><p>Now re-check the configuration values one last time:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl <span style="color:#a2f">exec</span> -it pod/redis -- redis-cli
</span></span></code></pre></div><p>Check <code>maxmemory</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>127.0.0.1:6379&gt; CONFIG GET maxmemory
</span></span></code></pre></div><p>It should now return the updated value of 2097152:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>1<span style="color:#666">)</span> <span style="color:#b44">"maxmemory"</span>
</span></span><span style="display:flex"><span>2<span style="color:#666">)</span> <span style="color:#b44">"2097152"</span>
</span></span></code></pre></div><p>Similarly, <code>maxmemory-policy</code> has also been updated:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>127.0.0.1:6379&gt; CONFIG GET maxmemory-policy
</span></span></code></pre></div><p>It now reflects the desired value of <code>allkeys-lru</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>1<span style="color:#666">)</span> <span style="color:#b44">"maxmemory-policy"</span>
</span></span><span style="display:flex"><span>2<span style="color:#666">)</span> <span style="color:#b44">"allkeys-lru"</span>
</span></span></code></pre></div><p>Clean up your work by deleting the created resources:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl delete pod/redis configmap/example-redis-config
</span></span></code></pre></div><h2 id="what-s-next">What's next</h2><ul><li>Learn more about <a href="/docs/tasks/configure-pod-container/configure-pod-configmap/">ConfigMaps</a>.</li><li>Follow an example of <a href="/docs/tutorials/configuration/updating-configuration-via-a-configmap/">Updating configuration via a ConfigMap</a>.</li></ul></div>
<hr>
<div class="td-content"><h1 data-pagefind-weight="10">Updating Configuration via a ConfigMap</h1><p>This page provides a step-by-step example of updating configuration within a Pod via a ConfigMap
and builds upon the <a href="/docs/tasks/configure-pod-container/configure-pod-configmap/">Configure a Pod to Use a ConfigMap</a> task.<br/>At the end of this tutorial, you will understand how to change the configuration for a running application.<br/>This tutorial uses the <code>alpine</code> and <code>nginx</code> images as examples.</p><h2 id="before-you-begin">Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul><p>You need to have the <a href="https://curl.se/">curl</a> command-line tool for making HTTP requests from
the terminal or command prompt. If you do not have <code>curl</code> available, you can install it. Check the
documentation for your local operating system.</p><h2 id="objectives">Objectives</h2><ul><li>Update configuration via a ConfigMap mounted as a Volume</li><li>Update environment variables of a Pod via a ConfigMap</li><li>Update configuration via a ConfigMap in a multi-container Pod</li><li>Update configuration via a ConfigMap in a Pod possessing a Sidecar Container</li></ul><h2 id="rollout-configmap-volume">Update configuration via a ConfigMap mounted as a Volume</h2><p>Use the <code>kubectl create configmap</code> command to create a ConfigMap from
<a href="/docs/tasks/configure-pod-container/configure-pod-configmap/#create-configmaps-from-literal-values">literal values</a>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl create configmap sport --from-literal<span style="color:#666">=</span><span style="color:#b8860b">sport</span><span style="color:#666">=</span>football
</span></span></code></pre></div><p>Below is an example of a Deployment manifest with the ConfigMap <code>sport</code> mounted as a
<a class="glossary-tooltip" title="A directory containing data, accessible to the containers in a pod." data-toggle="tooltip" data-placement="top" href="/docs/concepts/storage/volumes/" target="_blank" aria-label="volume">volume</a> into the Pod's only container.</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/deployments/deployment-with-configmap-as-volume.yaml" download="deployments/deployment-with-configmap-as-volume.yaml"><code>deployments/deployment-with-configmap-as-volume.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;deployments-deployment-with-configmap-as-volume-yaml&quot;)" title="Copy deployments/deployment-with-configmap-as-volume.yaml to clipboard"/></div><div class="includecode" id="deployments-deployment-with-configmap-as-volume-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>configmap-volume<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">app.kubernetes.io/name</span>:<span style="color:#bbb"> </span>configmap-volume<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">3</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">app.kubernetes.io/name</span>:<span style="color:#bbb"> </span>configmap-volume<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app.kubernetes.io/name</span>:<span style="color:#bbb"> </span>configmap-volume<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>alpine<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>alpine:3<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">command</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span>- /bin/sh<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span>- -c<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span>- while true; do echo "$(date) My preferred sport is $(cat /etc/config/sport)";<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span>sleep 10; done;<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span>- <span style="color:green;font-weight:700">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">volumeMounts</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>config-volume<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span>/etc/config<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>config-volume<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">configMap</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>sport</span></span></code></pre></div></div></div><p>Create the Deployment:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f https://k8s.io/examples/deployments/deployment-with-configmap-as-volume.yaml
</span></span></code></pre></div><p>Check the pods for this Deployment to ensure they are ready (matching by
<a class="glossary-tooltip" title="Allows users to filter a list of resources based on labels." data-toggle="tooltip" data-placement="top" href="/docs/concepts/overview/working-with-objects/labels/" target="_blank" aria-label="selector">selector</a>):</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pods --selector<span style="color:#666">=</span>app.kubernetes.io/name<span style="color:#666">=</span>configmap-volume
</span></span></code></pre></div><p>You should see an output similar to:</p><pre tabindex="0"><code>NAME                                READY   STATUS    RESTARTS   AGE
configmap-volume-6b976dfdcf-qxvbm   1/1     Running   0          72s
configmap-volume-6b976dfdcf-skpvm   1/1     Running   0          72s
configmap-volume-6b976dfdcf-tbc6r   1/1     Running   0          72s
</code></pre><p>On each node where one of these Pods is running, the kubelet fetches the data for
that ConfigMap and translates it to files in a local volume.
The kubelet then mounts that volume into the container, as specified in the Pod template.
The code running in that container loads the information from the file
and uses it to print a report to stdout.
You can check this report by viewing the logs for one of the Pods in that Deployment:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Pick one Pod that belongs to the Deployment, and view its logs</span>
</span></span><span style="display:flex"><span>kubectl logs deployments/configmap-volume
</span></span></code></pre></div><p>You should see an output similar to:</p><pre tabindex="0"><code>Found 3 pods, using pod/configmap-volume-76d9c5678f-x5rgj
Thu Jan  4 14:06:46 UTC 2024 My preferred sport is football
Thu Jan  4 14:06:56 UTC 2024 My preferred sport is football
Thu Jan  4 14:07:06 UTC 2024 My preferred sport is football
Thu Jan  4 14:07:16 UTC 2024 My preferred sport is football
Thu Jan  4 14:07:26 UTC 2024 My preferred sport is football
</code></pre><p>Edit the ConfigMap:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl edit configmap sport
</span></span></code></pre></div><p>In the editor that appears, change the value of key <code>sport</code> from <code>football</code> to <code>cricket</code>. Save your changes.
The kubectl tool updates the ConfigMap accordingly (if you see an error, try again).</p><p>Here's an example of how that manifest could look after you edit it:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">data</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">sport</span>:<span style="color:#bbb"> </span>cricket<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ConfigMap<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># You can leave the existing metadata as they are.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># The values you'll see won't exactly match these.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">creationTimestamp</span>:<span style="color:#bbb"> </span><span style="color:#b44">"2024-01-04T14:05:06Z"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>sport<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">resourceVersion</span>:<span style="color:#bbb"> </span><span style="color:#b44">"1743935"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">uid</span>:<span style="color:#bbb"> </span>024ee001-fe72-487e-872e-34d6464a8a23<span style="color:#bbb">
</span></span></span></code></pre></div><p>You should see the following output:</p><pre tabindex="0"><code>configmap/sport edited
</code></pre><p>Tail (follow the latest entries in) the logs of one of the pods that belongs to this Deployment:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl logs deployments/configmap-volume --follow
</span></span></code></pre></div><p>After few seconds, you should see the log output change as follows:</p><pre tabindex="0"><code>Thu Jan  4 14:11:36 UTC 2024 My preferred sport is football
Thu Jan  4 14:11:46 UTC 2024 My preferred sport is football
Thu Jan  4 14:11:56 UTC 2024 My preferred sport is football
Thu Jan  4 14:12:06 UTC 2024 My preferred sport is cricket
Thu Jan  4 14:12:16 UTC 2024 My preferred sport is cricket
</code></pre><p>When you have a ConfigMap that is mapped into a running Pod using either a
<code>configMap</code> volume or a <code>projected</code> volume, and you update that ConfigMap,
the running Pod sees the update almost immediately.<br/>However, your application only sees the change if it is written to either poll for changes,
or watch for file updates.<br/>An application that loads its configuration once at startup will not notice a change.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>The total delay from the moment when the ConfigMap is updated to the moment when
new keys are projected to the Pod can be as long as kubelet sync period.<br/>Also check <a href="/docs/tasks/configure-pod-container/configure-pod-configmap/#mounted-configmaps-are-updated-automatically">Mounted ConfigMaps are updated automatically</a>.</div><h2 id="rollout-configmap-env">Update environment variables of a Pod via a ConfigMap</h2><p>Use the <code>kubectl create configmap</code> command to create a ConfigMap from
<a href="/docs/tasks/configure-pod-container/configure-pod-configmap/#create-configmaps-from-literal-values">literal values</a>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl create configmap fruits --from-literal<span style="color:#666">=</span><span style="color:#b8860b">fruits</span><span style="color:#666">=</span>apples
</span></span></code></pre></div><p>Below is an example of a Deployment manifest with an environment variable configured via the ConfigMap <code>fruits</code>.</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/deployments/deployment-with-configmap-as-envvar.yaml" download="deployments/deployment-with-configmap-as-envvar.yaml"><code>deployments/deployment-with-configmap-as-envvar.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;deployments-deployment-with-configmap-as-envvar-yaml&quot;)" title="Copy deployments/deployment-with-configmap-as-envvar.yaml to clipboard"/></div><div class="includecode" id="deployments-deployment-with-configmap-as-envvar-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>configmap-env-var<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">app.kubernetes.io/name</span>:<span style="color:#bbb"> </span>configmap-env-var<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">3</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">app.kubernetes.io/name</span>:<span style="color:#bbb"> </span>configmap-env-var<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app.kubernetes.io/name</span>:<span style="color:#bbb"> </span>configmap-env-var<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>alpine<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>alpine:3<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">env</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>FRUITS<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">valueFrom</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                </span><span style="color:green;font-weight:700">configMapKeyRef</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:green;font-weight:700">key</span>:<span style="color:#bbb"> </span>fruits<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>fruits<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">command</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span>- /bin/sh<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span>- -c<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span>- while true; do echo "$(date) The basket is full of $FRUITS";<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">                </span>sleep 10; done;<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span>- <span style="color:green;font-weight:700">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span></span></span></code></pre></div></div></div><p>Create the Deployment:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f https://k8s.io/examples/deployments/deployment-with-configmap-as-envvar.yaml
</span></span></code></pre></div><p>Check the pods for this Deployment to ensure they are ready (matching by
<a class="glossary-tooltip" title="Allows users to filter a list of resources based on labels." data-toggle="tooltip" data-placement="top" href="/docs/concepts/overview/working-with-objects/labels/" target="_blank" aria-label="selector">selector</a>):</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pods --selector<span style="color:#666">=</span>app.kubernetes.io/name<span style="color:#666">=</span>configmap-env-var
</span></span></code></pre></div><p>You should see an output similar to:</p><pre tabindex="0"><code>NAME                                 READY   STATUS    RESTARTS   AGE
configmap-env-var-59cfc64f7d-74d7z   1/1     Running   0          46s
configmap-env-var-59cfc64f7d-c4wmj   1/1     Running   0          46s
configmap-env-var-59cfc64f7d-dpr98   1/1     Running   0          46s
</code></pre><p>The key-value pair in the ConfigMap is configured as an environment variable in the container of the Pod.
Check this by viewing the logs of one Pod that belongs to the Deployment.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl logs deployment/configmap-env-var
</span></span></code></pre></div><p>You should see an output similar to:</p><pre tabindex="0"><code>Found 3 pods, using pod/configmap-env-var-7c994f7769-l74nq
Thu Jan  4 16:07:06 UTC 2024 The basket is full of apples
Thu Jan  4 16:07:16 UTC 2024 The basket is full of apples
Thu Jan  4 16:07:26 UTC 2024 The basket is full of apples
</code></pre><p>Edit the ConfigMap:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl edit configmap fruits
</span></span></code></pre></div><p>In the editor that appears, change the value of key <code>fruits</code> from <code>apples</code> to <code>mangoes</code>. Save your changes.
The kubectl tool updates the ConfigMap accordingly (if you see an error, try again).</p><p>Here's an example of how that manifest could look after you edit it:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">data</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">fruits</span>:<span style="color:#bbb"> </span>mangoes<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ConfigMap<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># You can leave the existing metadata as they are.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># The values you'll see won't exactly match these.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">creationTimestamp</span>:<span style="color:#bbb"> </span><span style="color:#b44">"2024-01-04T16:04:19Z"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>fruits<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">resourceVersion</span>:<span style="color:#bbb"> </span><span style="color:#b44">"1749472"</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>You should see the following output:</p><pre tabindex="0"><code>configmap/fruits edited
</code></pre><p>Tail the logs of the Deployment and observe the output for few seconds:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># As the text explains, the output does NOT change</span>
</span></span><span style="display:flex"><span>kubectl logs deployments/configmap-env-var --follow
</span></span></code></pre></div><p>Notice that the output remains <strong>unchanged</strong>, even though you edited the ConfigMap:</p><pre tabindex="0"><code>Thu Jan  4 16:12:56 UTC 2024 The basket is full of apples
Thu Jan  4 16:13:06 UTC 2024 The basket is full of apples
Thu Jan  4 16:13:16 UTC 2024 The basket is full of apples
Thu Jan  4 16:13:26 UTC 2024 The basket is full of apples
</code></pre><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>Although the value of the key inside the ConfigMap has changed, the environment variable
in the Pod still shows the earlier value. This is because environment variables for a
process running inside a Pod are <strong>not</strong> updated when the source data changes; if you
wanted to force an update, you would need to have Kubernetes replace your existing Pods.
The new Pods would then run with the updated information.</div><p>You can trigger that replacement. Perform a rollout for the Deployment, using
<a href="/docs/reference/kubectl/generated/kubectl_rollout/"><code>kubectl rollout</code></a>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Trigger the rollout</span>
</span></span><span style="display:flex"><span>kubectl rollout restart deployment configmap-env-var
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># Wait for the rollout to complete</span>
</span></span><span style="display:flex"><span>kubectl rollout status deployment configmap-env-var --watch<span style="color:#666">=</span><span style="color:#a2f">true</span>
</span></span></code></pre></div><p>Next, check the Deployment:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get deployment configmap-env-var
</span></span></code></pre></div><p>You should see an output similar to:</p><pre tabindex="0"><code>NAME                READY   UP-TO-DATE   AVAILABLE   AGE
configmap-env-var   3/3     3            3           12m
</code></pre><p>Check the Pods:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pods --selector<span style="color:#666">=</span>app.kubernetes.io/name<span style="color:#666">=</span>configmap-env-var
</span></span></code></pre></div><p>The rollout causes Kubernetes to make a new <a class="glossary-tooltip" title="ReplicaSet ensures that a specified number of Pod replicas are running at one time" data-toggle="tooltip" data-placement="top" href="/docs/concepts/workloads/controllers/replicaset/" target="_blank" aria-label="ReplicaSet">ReplicaSet</a>
for the Deployment; that means the existing Pods eventually terminate, and new ones are created.
After few seconds, you should see an output similar to:</p><pre tabindex="0"><code>NAME                                 READY   STATUS        RESTARTS   AGE
configmap-env-var-6d94d89bf5-2ph2l   1/1     Running       0          13s
configmap-env-var-6d94d89bf5-74twx   1/1     Running       0          8s
configmap-env-var-6d94d89bf5-d5vx8   1/1     Running       0          11s
</code></pre><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>Please wait for the older Pods to fully terminate before proceeding with the next steps.</div><p>View the logs for a Pod in this Deployment:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Pick one Pod that belongs to the Deployment, and view its logs</span>
</span></span><span style="display:flex"><span>kubectl logs deployment/configmap-env-var
</span></span></code></pre></div><p>You should see an output similar to the below:</p><pre tabindex="0"><code>Found 3 pods, using pod/configmap-env-var-6d9ff89fb6-bzcf6
Thu Jan  4 16:30:35 UTC 2024 The basket is full of mangoes
Thu Jan  4 16:30:45 UTC 2024 The basket is full of mangoes
Thu Jan  4 16:30:55 UTC 2024 The basket is full of mangoes
</code></pre><p>This demonstrates the scenario of updating environment variables in a Pod that are derived
from a ConfigMap. Changes to the ConfigMap values are applied to the Pod during the subsequent
rollout. If Pods get created for another reason, such as scaling up the Deployment, then the new Pods
also use the latest configuration values; if you don't trigger a rollout, then you might find that your
app is running with a mix of old and new environment variable values.</p><h2 id="rollout-configmap-multiple-containers">Update configuration via a ConfigMap in a multi-container Pod</h2><p>Use the <code>kubectl create configmap</code> command to create a ConfigMap from
<a href="/docs/tasks/configure-pod-container/configure-pod-configmap/#create-configmaps-from-literal-values">literal values</a>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl create configmap color --from-literal<span style="color:#666">=</span><span style="color:#b8860b">color</span><span style="color:#666">=</span>red
</span></span></code></pre></div><p>Below is an example manifest for a Deployment that manages a set of Pods, each with two containers.
The two containers share an <code>emptyDir</code> volume that they use to communicate.
The first container runs a web server (<code>nginx</code>). The mount path for the shared volume in the
web server container is <code>/usr/share/nginx/html</code>. The second helper container is based on <code>alpine</code>,
and for this container the <code>emptyDir</code> volume is mounted at <code>/pod-data</code>. The helper container writes
a file in HTML that has its content based on a ConfigMap. The web server container serves the HTML via HTTP.</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/deployments/deployment-with-configmap-two-containers.yaml" download="deployments/deployment-with-configmap-two-containers.yaml"><code>deployments/deployment-with-configmap-two-containers.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;deployments-deployment-with-configmap-two-containers-yaml&quot;)" title="Copy deployments/deployment-with-configmap-two-containers.yaml to clipboard"/></div><div class="includecode" id="deployments-deployment-with-configmap-two-containers-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>configmap-two-containers<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">app.kubernetes.io/name</span>:<span style="color:#bbb"> </span>configmap-two-containers<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">3</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">app.kubernetes.io/name</span>:<span style="color:#bbb"> </span>configmap-two-containers<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app.kubernetes.io/name</span>:<span style="color:#bbb"> </span>configmap-two-containers<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>shared-data<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">emptyDir</span>:<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>config-volume<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">configMap</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>color<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">volumeMounts</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>shared-data<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span>/usr/share/nginx/html<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>alpine<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>alpine:3<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">volumeMounts</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>shared-data<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span>/pod-data<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>config-volume<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span>/etc/config<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">command</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span>- /bin/sh<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span>- -c<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span>- while true; do echo "$(date) My preferred color is $(cat /etc/config/color)" &gt; /pod-data/index.html;<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span>sleep 10; done;<span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>Create the Deployment:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f https://k8s.io/examples/deployments/deployment-with-configmap-two-containers.yaml
</span></span></code></pre></div><p>Check the pods for this Deployment to ensure they are ready (matching by
<a class="glossary-tooltip" title="Allows users to filter a list of resources based on labels." data-toggle="tooltip" data-placement="top" href="/docs/concepts/overview/working-with-objects/labels/" target="_blank" aria-label="selector">selector</a>):</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pods --selector<span style="color:#666">=</span>app.kubernetes.io/name<span style="color:#666">=</span>configmap-two-containers
</span></span></code></pre></div><p>You should see an output similar to:</p><pre tabindex="0"><code>NAME                                        READY   STATUS    RESTARTS   AGE
configmap-two-containers-565fb6d4f4-2xhxf   2/2     Running   0          20s
configmap-two-containers-565fb6d4f4-g5v4j   2/2     Running   0          20s
configmap-two-containers-565fb6d4f4-mzsmf   2/2     Running   0          20s
</code></pre><p>Expose the Deployment (the <code>kubectl</code> tool creates a
<a class="glossary-tooltip" title="A way to expose an application running on a set of Pods as a network service." data-toggle="tooltip" data-placement="top" href="/docs/concepts/services-networking/service/" target="_blank" aria-label="Service">Service</a> for you):</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl expose deployment configmap-two-containers --name<span style="color:#666">=</span>configmap-service --port<span style="color:#666">=</span><span style="color:#666">8080</span> --target-port<span style="color:#666">=</span><span style="color:#666">80</span>
</span></span></code></pre></div><p>Use <code>kubectl</code> to forward the port:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># this stays running in the background</span>
</span></span><span style="display:flex"><span>kubectl port-forward service/configmap-service 8080:8080 &amp;
</span></span></code></pre></div><p>Access the service.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>curl http://localhost:8080
</span></span></code></pre></div><p>You should see an output similar to:</p><pre tabindex="0"><code>Fri Jan  5 08:08:22 UTC 2024 My preferred color is red
</code></pre><p>Edit the ConfigMap:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl edit configmap color
</span></span></code></pre></div><p>In the editor that appears, change the value of key <code>color</code> from <code>red</code> to <code>blue</code>. Save your changes.
The kubectl tool updates the ConfigMap accordingly (if you see an error, try again).</p><p>Here's an example of how that manifest could look after you edit it:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">data</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">color</span>:<span style="color:#bbb"> </span>blue<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ConfigMap<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># You can leave the existing metadata as they are.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># The values you'll see won't exactly match these.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">creationTimestamp</span>:<span style="color:#bbb"> </span><span style="color:#b44">"2024-01-05T08:12:05Z"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>color<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>configmap<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">resourceVersion</span>:<span style="color:#bbb"> </span><span style="color:#b44">"1801272"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">uid</span>:<span style="color:#bbb"> </span>80d33e4a-cbb4-4bc9-ba8c-544c68e425d6<span style="color:#bbb">
</span></span></span></code></pre></div><p>Loop over the service URL for few seconds.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Cancel this when you're happy with it (Ctrl-C)</span>
</span></span><span style="display:flex"><span><span style="color:#a2f;font-weight:700">while</span> true; <span style="color:#a2f;font-weight:700">do</span> curl --connect-timeout 7.5 http://localhost:8080; sleep 10; <span style="color:#a2f;font-weight:700">done</span>
</span></span></code></pre></div><p>You should see the output change as follows:</p><pre tabindex="0"><code>Fri Jan  5 08:14:00 UTC 2024 My preferred color is red
Fri Jan  5 08:14:02 UTC 2024 My preferred color is red
Fri Jan  5 08:14:20 UTC 2024 My preferred color is red
Fri Jan  5 08:14:22 UTC 2024 My preferred color is red
Fri Jan  5 08:14:32 UTC 2024 My preferred color is blue
Fri Jan  5 08:14:43 UTC 2024 My preferred color is blue
Fri Jan  5 08:15:00 UTC 2024 My preferred color is blue
</code></pre><h2 id="rollout-configmap-sidecar">Update configuration via a ConfigMap in a Pod possessing a sidecar container</h2><p>The above scenario can be replicated by using a <a href="/docs/concepts/workloads/pods/sidecar-containers/">Sidecar Container</a>
as a helper container to write the HTML file.<br/>As a Sidecar Container is conceptually an Init Container, it is guaranteed to start before the main web server container.<br/>This ensures that the HTML file is always available when the web server is ready to serve it.</p><p>If you are continuing from the previous scenario, you can reuse the ConfigMap named <code>color</code> for this scenario.<br/>If you are executing this scenario independently, use the <code>kubectl create configmap</code> command to create a ConfigMap
from <a href="/docs/tasks/configure-pod-container/configure-pod-configmap/#create-configmaps-from-literal-values">literal values</a>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl create configmap color --from-literal<span style="color:#666">=</span><span style="color:#b8860b">color</span><span style="color:#666">=</span>blue
</span></span></code></pre></div><p>Below is an example manifest for a Deployment that manages a set of Pods, each with a main container and
a sidecar container. The two containers share an <code>emptyDir</code> volume that they use to communicate.
The main container runs a web server (NGINX). The mount path for the shared volume in the web server container
is <code>/usr/share/nginx/html</code>. The second container is a Sidecar Container based on Alpine Linux which acts as
a helper container. For this container the <code>emptyDir</code> volume is mounted at <code>/pod-data</code>. The Sidecar Container
writes a file in HTML that has its content based on a ConfigMap. The web server container serves the HTML via HTTP.</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/deployments/deployment-with-configmap-and-sidecar-container.yaml" download="deployments/deployment-with-configmap-and-sidecar-container.yaml"><code>deployments/deployment-with-configmap-and-sidecar-container.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;deployments-deployment-with-configmap-and-sidecar-container-yaml&quot;)" title="Copy deployments/deployment-with-configmap-and-sidecar-container.yaml to clipboard"/></div><div class="includecode" id="deployments-deployment-with-configmap-and-sidecar-container-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>configmap-sidecar-container<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">app.kubernetes.io/name</span>:<span style="color:#bbb"> </span>configmap-sidecar-container<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">3</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">app.kubernetes.io/name</span>:<span style="color:#bbb"> </span>configmap-sidecar-container<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app.kubernetes.io/name</span>:<span style="color:#bbb"> </span>configmap-sidecar-container<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>shared-data<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">emptyDir</span>:<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>config-volume<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">configMap</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>color<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">volumeMounts</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>shared-data<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span>/usr/share/nginx/html<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">initContainers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>alpine<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>alpine:3<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">restartPolicy</span>:<span style="color:#bbb"> </span>Always<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">volumeMounts</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>shared-data<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span>/pod-data<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>config-volume<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span>/etc/config<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">command</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span>- /bin/sh<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span>- -c<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span>- while true; do echo "$(date) My preferred color is $(cat /etc/config/color)" &gt; /pod-data/index.html;<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span>sleep 10; done;<span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>Create the Deployment:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f https://k8s.io/examples/deployments/deployment-with-configmap-and-sidecar-container.yaml
</span></span></code></pre></div><p>Check the pods for this Deployment to ensure they are ready (matching by
<a class="glossary-tooltip" title="Allows users to filter a list of resources based on labels." data-toggle="tooltip" data-placement="top" href="/docs/concepts/overview/working-with-objects/labels/" target="_blank" aria-label="selector">selector</a>):</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pods --selector<span style="color:#666">=</span>app.kubernetes.io/name<span style="color:#666">=</span>configmap-sidecar-container
</span></span></code></pre></div><p>You should see an output similar to:</p><pre tabindex="0"><code>NAME                                           READY   STATUS    RESTARTS   AGE
configmap-sidecar-container-5fb59f558b-87rp7   2/2     Running   0          94s
configmap-sidecar-container-5fb59f558b-ccs7s   2/2     Running   0          94s
configmap-sidecar-container-5fb59f558b-wnmgk   2/2     Running   0          94s
</code></pre><p>Expose the Deployment (the <code>kubectl</code> tool creates a
<a class="glossary-tooltip" title="A way to expose an application running on a set of Pods as a network service." data-toggle="tooltip" data-placement="top" href="/docs/concepts/services-networking/service/" target="_blank" aria-label="Service">Service</a> for you):</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl expose deployment configmap-sidecar-container --name<span style="color:#666">=</span>configmap-sidecar-service --port<span style="color:#666">=</span><span style="color:#666">8081</span> --target-port<span style="color:#666">=</span><span style="color:#666">80</span>
</span></span></code></pre></div><p>Use <code>kubectl</code> to forward the port:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># this stays running in the background</span>
</span></span><span style="display:flex"><span>kubectl port-forward service/configmap-sidecar-service 8081:8081 &amp;
</span></span></code></pre></div><p>Access the service.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>curl http://localhost:8081
</span></span></code></pre></div><p>You should see an output similar to:</p><pre tabindex="0"><code>Sat Feb 17 13:09:05 UTC 2024 My preferred color is blue
</code></pre><p>Edit the ConfigMap:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl edit configmap color
</span></span></code></pre></div><p>In the editor that appears, change the value of key <code>color</code> from <code>blue</code> to <code>green</code>. Save your changes.
The kubectl tool updates the ConfigMap accordingly (if you see an error, try again).</p><p>Here's an example of how that manifest could look after you edit it:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">data</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">color</span>:<span style="color:#bbb"> </span>green<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ConfigMap<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># You can leave the existing metadata as they are.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># The values you'll see won't exactly match these.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">creationTimestamp</span>:<span style="color:#bbb"> </span><span style="color:#b44">"2024-02-17T12:20:30Z"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>color<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">resourceVersion</span>:<span style="color:#bbb"> </span><span style="color:#b44">"1054"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">uid</span>:<span style="color:#bbb"> </span>e40bb34c-58df-4280-8bea-6ed16edccfaa<span style="color:#bbb">
</span></span></span></code></pre></div><p>Loop over the service URL for few seconds.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Cancel this when you're happy with it (Ctrl-C)</span>
</span></span><span style="display:flex"><span><span style="color:#a2f;font-weight:700">while</span> true; <span style="color:#a2f;font-weight:700">do</span> curl --connect-timeout 7.5 http://localhost:8081; sleep 10; <span style="color:#a2f;font-weight:700">done</span>
</span></span></code></pre></div><p>You should see the output change as follows:</p><pre tabindex="0"><code>Sat Feb 17 13:12:35 UTC 2024 My preferred color is blue
Sat Feb 17 13:12:45 UTC 2024 My preferred color is blue
Sat Feb 17 13:12:55 UTC 2024 My preferred color is blue
Sat Feb 17 13:13:05 UTC 2024 My preferred color is blue
Sat Feb 17 13:13:15 UTC 2024 My preferred color is green
Sat Feb 17 13:13:25 UTC 2024 My preferred color is green
Sat Feb 17 13:13:35 UTC 2024 My preferred color is green
</code></pre><h2 id="rollout-configmap-immutable-volume">Update configuration via an immutable ConfigMap that is mounted as a volume</h2><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4><p>Immutable ConfigMaps are especially used for configuration that is constant and is <strong>not</strong> expected
to change over time. Marking a ConfigMap as immutable allows a performance improvement where the kubelet does not watch for changes.</p><p>If you do need to make a change, you should plan to either:</p><ul><li>change the name of the ConfigMap, and switch to running Pods that reference the new name</li><li>replace all the nodes in your cluster that have previously run a Pod that used the old value</li><li>restart the kubelet on any node where the kubelet previously loaded the old ConfigMap</li></ul></div><p>An example manifest for an <a href="/docs/concepts/configuration/configmap/#configmap-immutable">Immutable ConfigMap</a> is shown below.</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/configmap/immutable-configmap.yaml" download="configmap/immutable-configmap.yaml"><code>configmap/immutable-configmap.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;configmap-immutable-configmap-yaml&quot;)" title="Copy configmap/immutable-configmap.yaml to clipboard"/></div><div class="includecode" id="configmap-immutable-configmap-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">data</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">company_name</span>:<span style="color:#bbb"> </span><span style="color:#b44">"ACME, Inc."</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># existing fictional company name</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ConfigMap<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">immutable</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>company-name-20150801</span></span></code></pre></div></div></div><p>Create the Immutable ConfigMap:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f https://k8s.io/examples/configmap/immutable-configmap.yaml
</span></span></code></pre></div><p>Below is an example of a Deployment manifest with the Immutable ConfigMap <code>company-name-20150801</code> mounted as a
<a class="glossary-tooltip" title="A directory containing data, accessible to the containers in a pod." data-toggle="tooltip" data-placement="top" href="/docs/concepts/storage/volumes/" target="_blank" aria-label="volume">volume</a> into the Pod's only container.</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/deployments/deployment-with-immutable-configmap-as-volume.yaml" download="deployments/deployment-with-immutable-configmap-as-volume.yaml"><code>deployments/deployment-with-immutable-configmap-as-volume.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;deployments-deployment-with-immutable-configmap-as-volume-yaml&quot;)" title="Copy deployments/deployment-with-immutable-configmap-as-volume.yaml to clipboard"/></div><div class="includecode" id="deployments-deployment-with-immutable-configmap-as-volume-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>immutable-configmap-volume<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">app.kubernetes.io/name</span>:<span style="color:#bbb"> </span>immutable-configmap-volume<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">3</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">app.kubernetes.io/name</span>:<span style="color:#bbb"> </span>immutable-configmap-volume<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app.kubernetes.io/name</span>:<span style="color:#bbb"> </span>immutable-configmap-volume<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>alpine<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>alpine:3<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">command</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span>- /bin/sh<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span>- -c<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span>- while true; do echo "$(date) The name of the company is $(cat /etc/config/company_name)";<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span>sleep 10; done;<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span>- <span style="color:green;font-weight:700">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">volumeMounts</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>config-volume<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span>/etc/config<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>config-volume<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">configMap</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>company-name-20150801</span></span></code></pre></div></div></div><p>Create the Deployment:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f https://k8s.io/examples/deployments/deployment-with-immutable-configmap-as-volume.yaml
</span></span></code></pre></div><p>Check the pods for this Deployment to ensure they are ready (matching by
<a class="glossary-tooltip" title="Allows users to filter a list of resources based on labels." data-toggle="tooltip" data-placement="top" href="/docs/concepts/overview/working-with-objects/labels/" target="_blank" aria-label="selector">selector</a>):</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pods --selector<span style="color:#666">=</span>app.kubernetes.io/name<span style="color:#666">=</span>immutable-configmap-volume
</span></span></code></pre></div><p>You should see an output similar to:</p><pre tabindex="0"><code>NAME                                          READY   STATUS    RESTARTS   AGE
immutable-configmap-volume-78b6fbff95-5gsfh   1/1     Running   0          62s
immutable-configmap-volume-78b6fbff95-7vcj4   1/1     Running   0          62s
immutable-configmap-volume-78b6fbff95-vdslm   1/1     Running   0          62s
</code></pre><p>The Pod's container refers to the data defined in the ConfigMap and uses it to print a report to stdout.
You can check this report by viewing the logs for one of the Pods in that Deployment:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Pick one Pod that belongs to the Deployment, and view its logs</span>
</span></span><span style="display:flex"><span>kubectl logs deployments/immutable-configmap-volume
</span></span></code></pre></div><p>You should see an output similar to:</p><pre tabindex="0"><code>Found 3 pods, using pod/immutable-configmap-volume-78b6fbff95-5gsfh
Wed Mar 20 03:52:34 UTC 2024 The name of the company is ACME, Inc.
Wed Mar 20 03:52:44 UTC 2024 The name of the company is ACME, Inc.
Wed Mar 20 03:52:54 UTC 2024 The name of the company is ACME, Inc.
</code></pre><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>Once a ConfigMap is marked as immutable, it is not possible to revert this change
nor to mutate the contents of the data or the binaryData field.<br/>In order to modify the behavior of the Pods that use this configuration,
you will create a new immutable ConfigMap and edit the Deployment
to define a slightly different pod template, referencing the new ConfigMap.</div><p>Create a new immutable ConfigMap by using the manifest shown below:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/configmap/new-immutable-configmap.yaml" download="configmap/new-immutable-configmap.yaml"><code>configmap/new-immutable-configmap.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;configmap-new-immutable-configmap-yaml&quot;)" title="Copy configmap/new-immutable-configmap.yaml to clipboard"/></div><div class="includecode" id="configmap-new-immutable-configmap-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">data</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">company_name</span>:<span style="color:#bbb"> </span><span style="color:#b44">"Fiktivesunternehmen GmbH"</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># new fictional company name</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ConfigMap<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">immutable</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>company-name-20240312</span></span></code></pre></div></div></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f https://k8s.io/examples/configmap/new-immutable-configmap.yaml
</span></span></code></pre></div><p>You should see an output similar to:</p><pre tabindex="0"><code>configmap/company-name-20240312 created
</code></pre><p>Check the newly created ConfigMap:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get configmap
</span></span></code></pre></div><p>You should see an output displaying both the old and new ConfigMaps:</p><pre tabindex="0"><code>NAME                    DATA   AGE
company-name-20150801   1      22m
company-name-20240312   1      24s
</code></pre><p>Modify the Deployment to reference the new ConfigMap.</p><p>Edit the Deployment:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl edit deployment immutable-configmap-volume
</span></span></code></pre></div><p>In the editor that appears, update the existing volume definition to use the new ConfigMap.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">configMap</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">defaultMode</span>:<span style="color:#bbb"> </span><span style="color:#666">420</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>company-name-20240312<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># Update this field</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>config-volume<span style="color:#bbb">
</span></span></span></code></pre></div><p>You should see the following output:</p><pre tabindex="0"><code>deployment.apps/immutable-configmap-volume edited
</code></pre><p>This will trigger a rollout. Wait for all the previous Pods to terminate and the new Pods to be in a ready state.</p><p>Monitor the status of the Pods:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pods --selector<span style="color:#666">=</span>app.kubernetes.io/name<span style="color:#666">=</span>immutable-configmap-volume
</span></span></code></pre></div><pre tabindex="0"><code>NAME                                          READY   STATUS        RESTARTS   AGE
immutable-configmap-volume-5fdb88fcc8-29v8n   1/1     Running       0          13s
immutable-configmap-volume-5fdb88fcc8-52ddd   1/1     Running       0          14s
immutable-configmap-volume-5fdb88fcc8-n5jx4   1/1     Running       0          15s
immutable-configmap-volume-78b6fbff95-5gsfh   1/1     Terminating   0          32m
immutable-configmap-volume-78b6fbff95-7vcj4   1/1     Terminating   0          32m
immutable-configmap-volume-78b6fbff95-vdslm   1/1     Terminating   0          32m
</code></pre><p>You should eventually see an output similar to:</p><pre tabindex="0"><code>NAME                                          READY   STATUS    RESTARTS   AGE
immutable-configmap-volume-5fdb88fcc8-29v8n   1/1     Running   0          43s
immutable-configmap-volume-5fdb88fcc8-52ddd   1/1     Running   0          44s
immutable-configmap-volume-5fdb88fcc8-n5jx4   1/1     Running   0          45s
</code></pre><p>View the logs for a Pod in this Deployment:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Pick one Pod that belongs to the Deployment, and view its logs</span>
</span></span><span style="display:flex"><span>kubectl logs deployment/immutable-configmap-volume
</span></span></code></pre></div><p>You should see an output similar to the below:</p><pre tabindex="0"><code>Found 3 pods, using pod/immutable-configmap-volume-5fdb88fcc8-n5jx4
Wed Mar 20 04:24:17 UTC 2024 The name of the company is Fiktivesunternehmen GmbH
Wed Mar 20 04:24:27 UTC 2024 The name of the company is Fiktivesunternehmen GmbH
Wed Mar 20 04:24:37 UTC 2024 The name of the company is Fiktivesunternehmen GmbH
</code></pre><p>Once all the deployments have migrated to use the new immutable ConfigMap, it is advised to delete the old one.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl delete configmap company-name-20150801
</span></span></code></pre></div><h2 id="summary">Summary</h2><p>Changes to a ConfigMap mounted as a Volume on a Pod are available seamlessly after the subsequent kubelet sync.</p><p>Changes to a ConfigMap that configures environment variables for a Pod are available after the subsequent rollout for the Pod.</p><p>Once a ConfigMap is marked as immutable, it is not possible to revert this change
(you cannot make an immutable ConfigMap mutable), and you also cannot make any change
to the contents of the <code>data</code> or the <code>binaryData</code> field. You can delete and recreate
the ConfigMap, or you can make a new different ConfigMap. When you delete a ConfigMap,
running containers and their Pods maintain a mount point to any volume that referenced
that existing ConfigMap.</p><h2 id="cleaning-up">Cleaning up</h2><p>Terminate the <code>kubectl port-forward</code> commands in case they are running.</p><p>Delete the resources created during the tutorial:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl delete deployment configmap-volume configmap-env-var configmap-two-containers configmap-sidecar-container immutable-configmap-volume
</span></span><span style="display:flex"><span>kubectl delete service configmap-service configmap-sidecar-service
</span></span><span style="display:flex"><span>kubectl delete configmap sport fruits color company-name-20240312
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>kubectl delete configmap company-name-20150801 <span style="color:#080;font-style:italic"># In case it was not handled during the task execution</span>
</span></span></code></pre></div></div>
<hr>
<div class="td-content"><h1 data-pagefind-weight="10">Namespaces Walkthrough</h1><p>Kubernetes <a class="glossary-tooltip" title="An abstraction used by Kubernetes to support isolation of groups of resources within a single cluster." data-toggle="tooltip" data-placement="top" href="/docs/concepts/overview/working-with-objects/namespaces" target="_blank" aria-label="namespaces">namespaces</a>
help different projects, teams, or customers to share a Kubernetes cluster.</p><p>It does this by providing the following:</p><ol><li>A scope for <a href="/docs/concepts/overview/working-with-objects/names/">Names</a>.</li><li>A mechanism to attach authorization and policy to a subsection of the cluster.</li></ol><p>Use of multiple namespaces is optional.</p><p>This example demonstrates how to use Kubernetes namespaces to subdivide your cluster.</p><h2 id="before-you-begin">Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul><p>To check the version, enter <code>kubectl version</code>.</p></p><h2 id="prerequisites">Prerequisites</h2><p>This example assumes the following:</p><ol><li>You have an <a href="/docs/setup/">existing Kubernetes cluster</a>.</li><li>You have a basic understanding of Kubernetes <a class="glossary-tooltip" title="A Pod represents a set of running containers in your cluster." data-toggle="tooltip" data-placement="top" href="/docs/concepts/workloads/pods/" target="_blank" aria-label="Pods">Pods</a>, <a class="glossary-tooltip" title="A way to expose an application running on a set of Pods as a network service." data-toggle="tooltip" data-placement="top" href="/docs/concepts/services-networking/service/" target="_blank" aria-label="Services">Services</a>, and <a class="glossary-tooltip" title="Manages a replicated application on your cluster." data-toggle="tooltip" data-placement="top" href="/docs/concepts/workloads/controllers/deployment/" target="_blank" aria-label="Deployments">Deployments</a>.</li></ol><h2 id="understand-the-default-namespace">Understand the default namespace</h2><p>By default, a Kubernetes cluster will instantiate a default namespace when provisioning the cluster to hold the default set of Pods,
Services, and Deployments used by the cluster.</p><p>Assuming you have a fresh cluster, you can inspect the available namespaces by doing the following:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get namespaces
</span></span></code></pre></div><pre tabindex="0"><code>NAME      STATUS    AGE
default   Active    13m
</code></pre><h2 id="create-new-namespaces">Create new namespaces</h2><p>For this exercise, we will create two additional Kubernetes namespaces to hold our content.</p><p>Let's imagine a scenario where an organization is using a shared Kubernetes cluster for development and production use cases.</p><p>The development team would like to maintain a space in the cluster where they can get a view on the list of Pods, Services, and Deployments
they use to build and run their application. In this space, Kubernetes resources come and go, and the restrictions on who can or cannot modify resources
are relaxed to enable agile development.</p><p>The operations team would like to maintain a space in the cluster where they can enforce strict procedures on who can or cannot manipulate the set of
Pods, Services, and Deployments that run the production site.</p><p>One pattern this organization could follow is to partition the Kubernetes cluster into two namespaces: <code>development</code> and <code>production</code>.</p><p>Let's create two new namespaces to hold our work.</p><p>Use the file <a href="/examples/admin/namespace-dev.yaml"><code>namespace-dev.yaml</code></a> which describes a <code>development</code> namespace:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/namespace-dev.yaml" download="admin/namespace-dev.yaml"><code>admin/namespace-dev.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;admin-namespace-dev-yaml&quot;)" title="Copy admin/namespace-dev.yaml to clipboard"/></div><div class="includecode" id="admin-namespace-dev-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Namespace<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>development<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>development<span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>Create the <code>development</code> namespace using kubectl.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl create -f https://k8s.io/examples/admin/namespace-dev.yaml
</span></span></code></pre></div><p>Save the following contents into file <a href="/examples/admin/namespace-prod.yaml"><code>namespace-prod.yaml</code></a> which describes a <code>production</code> namespace:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/namespace-prod.yaml" download="admin/namespace-prod.yaml"><code>admin/namespace-prod.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;admin-namespace-prod-yaml&quot;)" title="Copy admin/namespace-prod.yaml to clipboard"/></div><div class="includecode" id="admin-namespace-prod-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Namespace<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>production<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>production<span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>And then let's create the <code>production</code> namespace using kubectl.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl create -f https://k8s.io/examples/admin/namespace-prod.yaml
</span></span></code></pre></div><p>To be sure things are right, let's list all of the namespaces in our cluster.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get namespaces --show-labels
</span></span></code></pre></div><pre tabindex="0"><code>NAME          STATUS    AGE       LABELS
default       Active    32m       &lt;none&gt;
development   Active    29s       name=development
production    Active    23s       name=production
</code></pre><h2 id="create-pods-in-each-namespace">Create pods in each namespace</h2><p>A Kubernetes namespace provides the scope for Pods, Services, and Deployments in the cluster.</p><p>Users interacting with one namespace do not see the content in another namespace.</p><p>To demonstrate this, let's spin up a simple Deployment and Pods in the <code>development</code> namespace.</p><p>We first check what is the current context:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl config view
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">clusters</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">cluster</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">certificate-authority-data</span>:<span style="color:#bbb"> </span>REDACTED<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">server</span>:<span style="color:#bbb"> </span>https://130.211.122.180<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>lithe-cocoa-92103_kubernetes<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">contexts</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">context</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">cluster</span>:<span style="color:#bbb"> </span>lithe-cocoa-92103_kubernetes<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">user</span>:<span style="color:#bbb"> </span>lithe-cocoa-92103_kubernetes<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>lithe-cocoa-92103_kubernetes<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">current-context</span>:<span style="color:#bbb"> </span>lithe-cocoa-92103_kubernetes<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Config<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">preferences</span>:<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">users</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>lithe-cocoa-92103_kubernetes<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">user</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">client-certificate-data</span>:<span style="color:#bbb"> </span>REDACTED<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">client-key-data</span>:<span style="color:#bbb"> </span>REDACTED<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">token</span>:<span style="color:#bbb"> </span>65rZW78y8HbwXXtSXuUw9DbP4FLjHi4b<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>lithe-cocoa-92103_kubernetes-basic-auth<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">user</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">password</span>:<span style="color:#bbb"> </span>h5M0FtUUIflBSdI7<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">username</span>:<span style="color:#bbb"> </span>admin<span style="color:#bbb">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl config current-context
</span></span></code></pre></div><pre tabindex="0"><code>lithe-cocoa-92103_kubernetes
</code></pre><p>The next step is to define a context for the kubectl client to work in each namespace. The value of "cluster" and "user" fields are copied from the current context.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl config set-context dev --namespace<span style="color:#666">=</span>development <span style="color:#b62;font-weight:700">\
</span></span></span><span style="display:flex"><span><span style="color:#b62;font-weight:700"/>  --cluster<span style="color:#666">=</span>lithe-cocoa-92103_kubernetes <span style="color:#b62;font-weight:700">\
</span></span></span><span style="display:flex"><span><span style="color:#b62;font-weight:700"/>  --user<span style="color:#666">=</span>lithe-cocoa-92103_kubernetes
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>kubectl config set-context prod --namespace<span style="color:#666">=</span>production <span style="color:#b62;font-weight:700">\
</span></span></span><span style="display:flex"><span><span style="color:#b62;font-weight:700"/>  --cluster<span style="color:#666">=</span>lithe-cocoa-92103_kubernetes <span style="color:#b62;font-weight:700">\
</span></span></span><span style="display:flex"><span><span style="color:#b62;font-weight:700"/>  --user<span style="color:#666">=</span>lithe-cocoa-92103_kubernetes
</span></span></code></pre></div><p>By default, the above commands add two contexts that are saved into file
<code>.kube/config</code>. You can now view the contexts and alternate against the two
new request contexts depending on which namespace you wish to work against.</p><p>To view the new contexts:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl config view
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">clusters</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">cluster</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">certificate-authority-data</span>:<span style="color:#bbb"> </span>REDACTED<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">server</span>:<span style="color:#bbb"> </span>https://130.211.122.180<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>lithe-cocoa-92103_kubernetes<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">contexts</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">context</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">cluster</span>:<span style="color:#bbb"> </span>lithe-cocoa-92103_kubernetes<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">user</span>:<span style="color:#bbb"> </span>lithe-cocoa-92103_kubernetes<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>lithe-cocoa-92103_kubernetes<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">context</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">cluster</span>:<span style="color:#bbb"> </span>lithe-cocoa-92103_kubernetes<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>development<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">user</span>:<span style="color:#bbb"> </span>lithe-cocoa-92103_kubernetes<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>dev<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">context</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">cluster</span>:<span style="color:#bbb"> </span>lithe-cocoa-92103_kubernetes<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>production<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">user</span>:<span style="color:#bbb"> </span>lithe-cocoa-92103_kubernetes<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>prod<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">current-context</span>:<span style="color:#bbb"> </span>lithe-cocoa-92103_kubernetes<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Config<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">preferences</span>:<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">users</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>lithe-cocoa-92103_kubernetes<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">user</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">client-certificate-data</span>:<span style="color:#bbb"> </span>REDACTED<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">client-key-data</span>:<span style="color:#bbb"> </span>REDACTED<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">token</span>:<span style="color:#bbb"> </span>65rZW78y8HbwXXtSXuUw9DbP4FLjHi4b<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>lithe-cocoa-92103_kubernetes-basic-auth<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">user</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">password</span>:<span style="color:#bbb"> </span>h5M0FtUUIflBSdI7<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">username</span>:<span style="color:#bbb"> </span>admin<span style="color:#bbb">
</span></span></span></code></pre></div><p>Let's switch to operate in the <code>development</code> namespace.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl config use-context dev
</span></span></code></pre></div><p>You can verify your current context by doing the following:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl config current-context
</span></span></code></pre></div><pre tabindex="0"><code>dev
</code></pre><p>At this point, all requests we make to the Kubernetes cluster from the command line are scoped to the <code>development</code> namespace.</p><p>Let's create some contents.</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/snowflake-deployment.yaml" download="admin/snowflake-deployment.yaml"><code>admin/snowflake-deployment.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;admin-snowflake-deployment-yaml&quot;)" title="Copy admin/snowflake-deployment.yaml to clipboard"/></div><div class="includecode" id="admin-snowflake-deployment-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>snowflake<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>snowflake<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">2</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>snowflake<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>snowflake<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>registry.k8s.io/serve_hostname<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">imagePullPolicy</span>:<span style="color:#bbb"> </span>Always<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>snowflake<span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>Apply the manifest to create a Deployment</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f https://k8s.io/examples/admin/snowflake-deployment.yaml
</span></span></code></pre></div><p>We have created a deployment whose replica size is 2 that is running the pod called <code>snowflake</code> with a basic container that serves the hostname.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get deployment
</span></span></code></pre></div><pre tabindex="0"><code>NAME         READY   UP-TO-DATE   AVAILABLE   AGE
snowflake    2/2     2            2           2m
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pods -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>snowflake
</span></span></code></pre></div><pre tabindex="0"><code>NAME                         READY     STATUS    RESTARTS   AGE
snowflake-3968820950-9dgr8   1/1       Running   0          2m
snowflake-3968820950-vgc4n   1/1       Running   0          2m
</code></pre><p>And this is great, developers are able to do what they want, and they do not have to worry about affecting content in the <code>production</code> namespace.</p><p>Let's switch to the <code>production</code> namespace and show how resources in one namespace are hidden from the other.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl config use-context prod
</span></span></code></pre></div><p>The <code>production</code> namespace should be empty, and the following commands should return nothing.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get deployment
</span></span><span style="display:flex"><span>kubectl get pods
</span></span></code></pre></div><p>Production likes to run cattle, so let's create some cattle pods.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl create deployment cattle --image<span style="color:#666">=</span>registry.k8s.io/serve_hostname --replicas<span style="color:#666">=</span><span style="color:#666">5</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>kubectl get deployment
</span></span></code></pre></div><pre tabindex="0"><code>NAME         READY   UP-TO-DATE   AVAILABLE   AGE
cattle       5/5     5            5           10s
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pods -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>cattle
</span></span></code></pre></div><pre tabindex="0"><code>NAME                      READY     STATUS    RESTARTS   AGE
cattle-2263376956-41xy6   1/1       Running   0          34s
cattle-2263376956-kw466   1/1       Running   0          34s
cattle-2263376956-n4v97   1/1       Running   0          34s
cattle-2263376956-p5p3i   1/1       Running   0          34s
cattle-2263376956-sxpth   1/1       Running   0          34s
</code></pre><p>At this point, it should be clear that the resources users create in one namespace are hidden from the other namespace.</p><p>As the policy support in Kubernetes evolves, we will extend this scenario to show how you can provide different
authorization rules for each namespace.</p></div>
<hr>
<div class="td-content"><h1 data-pagefind-weight="10">Configuring swap memory on Kubernetes nodes</h1><p>This page provides an example of how to provision and configure swap memory on a Kubernetes node using kubeadm.</p><h2 id="objectives">Objectives</h2><ul><li>Provision swap memory on a Kubernetes node using kubeadm.</li><li>Learn to configure both encrypted and unencrypted swap.</li><li>Learn to enable swap on boot.</li></ul><h2 id="before-you-begin">Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul>Your Kubernetes server must be at or later than version 1.33.<p>To check the version, enter <code>kubectl version</code>.</p></p><p>You need at least one worker node in your cluster which needs to run a Linux operating system.
It is required for this demo that the kubeadm tool be installed, following the steps outlined in the
<a href="/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/">kubeadm installation guide</a>.</p><p>On each worker node where you will configure swap use, you need:</p><ul><li><p><code>fallocate</code></p></li><li><p><code>mkswap</code></p></li><li><p><code>swapon</code></p></li><li><p>For encrypted swap space (recommended), you also need:</p></li><li><p><code>cryptsetup</code></p></li></ul><h2 id="install-a-swap-enabled-cluster-with-kubeadm">Install a swap-enabled cluster with kubeadm</h2><h3 id="create-a-swap-file-and-turn-swap-on">Create a swap file and turn swap on</h3><p>If swap is not enabled, there's a need to provision swap on the node.
The following sections demonstrate creating 4GiB of swap, both in the encrypted and unencrypted case.</p><ul class="nav nav-tabs" id="create-a-swap-file-and-turn-swap-on" role="tablist"><li class="nav-item"><a data-toggle="tab" class="nav-link active" href="#create-a-swap-file-and-turn-swap-on-0" role="tab" aria-controls="create-a-swap-file-and-turn-swap-on-0" aria-selected="true">Setting up encrypted swap</a></li><li class="nav-item"><a data-toggle="tab" class="nav-link" href="#create-a-swap-file-and-turn-swap-on-1" role="tab" aria-controls="create-a-swap-file-and-turn-swap-on-1">Setting up unencrypted swap</a></li></ul><div class="tab-content" id="create-a-swap-file-and-turn-swap-on"><div id="create-a-swap-file-and-turn-swap-on-0" class="tab-pane show active" role="tabpanel" aria-labelledby="create-a-swap-file-and-turn-swap-on-0"><p><p>An encrypted swap file can be set up as follows.
Bear in mind that this example uses the <code>cryptsetup</code> binary (which is available
on most Linux distributions).</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Allocate storage and restrict access</span>
</span></span><span style="display:flex"><span>fallocate --length 4GiB /swapfile
</span></span><span style="display:flex"><span>chmod <span style="color:#666">600</span> /swapfile
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># Create an encrypted device backed by the allocated storage</span>
</span></span><span style="display:flex"><span>cryptsetup --type plain --cipher aes-xts-plain64 --key-size <span style="color:#666">256</span> -d /dev/urandom open /swapfile cryptswap
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># Format the swap space</span>
</span></span><span style="display:flex"><span>mkswap /dev/mapper/cryptswap
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># Activate the swap space for paging</span>
</span></span><span style="display:flex"><span>swapon /dev/mapper/cryptswap
</span></span></code></pre></div></p></div><div id="create-a-swap-file-and-turn-swap-on-1" class="tab-pane" role="tabpanel" aria-labelledby="create-a-swap-file-and-turn-swap-on-1"><p><p>An unencrypted swap file can be set up as follows.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Allocate storage and restrict access</span>
</span></span><span style="display:flex"><span>fallocate --length 4GiB /swapfile
</span></span><span style="display:flex"><span>chmod <span style="color:#666">600</span> /swapfile
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># Format the swap space</span>
</span></span><span style="display:flex"><span>mkswap /swapfile
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># Activate the swap space for paging</span>
</span></span><span style="display:flex"><span>swapon /swapfile
</span></span></code></pre></div></p></div></div><h4 id="verify-that-swap-is-enabled">Verify that swap is enabled</h4><p>Swap can be verified to be enabled with both <code>swapon -s</code> command or the <code>free</code> command.</p><p>Using <code>swapon -s</code>:</p><pre tabindex="0"><code>Filename       Type		Size		Used		Priority
/dev/dm-0      partition 	4194300		0		-2
</code></pre><p>Using <code>free -h</code>:</p><pre tabindex="0"><code>               total        used        free      shared  buff/cache   available
Mem:           3.8Gi       1.3Gi       249Mi        25Mi       2.5Gi       2.5Gi
Swap:          4.0Gi          0B       4.0Gi
</code></pre><h4 id="enable-swap-on-boot">Enable swap on boot</h4><p>After setting up swap, to start the swap file at boot time,
you typically either set up a systemd unit to activate (encrypted) swap, or you
add a line similar to <code>/swapfile swap swap defaults 0 0</code> into <code>/etc/fstab</code>.</p><p>Using systemd for swap activation allows the system to delay kubelet start until swap is available,
if that is something you want to ensure.
In a similar way, using systemd allows your server to leave swap active until kubelet
(and, typically, your container runtime) have shut down.</p><h3 id="set-up-kubelet-configuration">Set up kubelet configuration</h3><p>After enabling swap on the node, kubelet needs to be configured to use it.
You need to select a <a href="/docs/reference/node/swap-behavior/">swap behavior</a>
for this node. You'll configure <em>LimitedSwap</em> behavior for this tutorial.</p><p>Find and edit the kubelet configuration file, and:</p><ul><li>set <code>failSwapOn</code> to false</li><li>set <code>memorySwap.swapBehavior</code> to LimitedSwap</li></ul><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># this fragment goes into the kubelet's configuration file</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"> </span><span style="color:green;font-weight:700">failSwapOn</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">false</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"> </span><span style="color:green;font-weight:700">memorySwap</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">     </span><span style="color:green;font-weight:700">swapBehavior</span>:<span style="color:#bbb"> </span>LimitedSwap<span style="color:#bbb">
</span></span></span></code></pre></div><p>In order for these configurations to take effect, kubelet needs to be restarted.
Typically you do that by running:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>systemctl restart kubelet.service
</span></span></code></pre></div><p>You should find that the kubelet is now healthy, and that you can run Pods
that use swap memory as needed.</p></div>
<hr>
<div class="td-content"><h1 data-pagefind-weight="10">Install Drivers and Allocate Devices with DRA</h1><div class="feature-state-notice feature-stable" title="Feature Gate: DynamicResourceAllocation"><span class="feature-state-name">FEATURE STATE:</span>
<code>Kubernetes v1.34 [stable]</code> (enabled by default: true)</div><p>This tutorial shows you how to install <a class="glossary-tooltip" title="A Kubernetes feature for requesting and sharing resources, like hardware accelerators, among Pods." data-toggle="tooltip" data-placement="top" href="/docs/concepts/scheduling-eviction/dynamic-resource-allocation/" target="_blank" aria-label="Dynamic Resource Allocation (DRA)">Dynamic Resource Allocation (DRA)</a> drivers in your cluster and how to
use them in conjunction with the DRA APIs to allocate <a class="glossary-tooltip" title="Any resource that's directly or indirectly attached your cluster's nodes, like GPUs or circuit boards." data-toggle="tooltip" data-placement="top" href="/docs/reference/glossary/?all=true#term-device" target="_blank" aria-label="devices">devices</a> to Pods. This page is intended for cluster administrators.</p><p><a class="glossary-tooltip" title="A Kubernetes feature for requesting and sharing resources, like hardware accelerators, among Pods." data-toggle="tooltip" data-placement="top" href="/docs/concepts/scheduling-eviction/dynamic-resource-allocation/" target="_blank" aria-label="Dynamic Resource Allocation (DRA)">Dynamic Resource Allocation (DRA)</a>
lets a cluster manage availability and allocation of hardware resources to
satisfy Pod-based claims for hardware requirements and preferences. To support
this, a mixture of Kubernetes built-in components (like the Kubernetes
scheduler, kubelet, and kube-controller-manager) and third-party drivers from
device owners (called DRA drivers) share the responsibility to advertise,
allocate, prepare, mount, healthcheck, unprepare, and cleanup resources
throughout the Pod lifecycle. These components share information via a series of
DRA specific APIs in the <code>resource.k8s.io</code> API group including <a class="glossary-tooltip" title="A category of devices in the cluster. Users can claim specific devices in a DeviceClass." data-toggle="tooltip" data-placement="top" href="/docs/concepts/scheduling-eviction/dynamic-resource-allocation/#deviceclass" target="_blank" aria-label="DeviceClasses">DeviceClasses</a>, <a class="glossary-tooltip" title="Represents one or more infrastructure resources, like devices, in a pool of similar resources." data-toggle="tooltip" data-placement="top" href="/docs/reference/kubernetes-api/workload-resources/resource-slice-v1beta1/" target="_blank" aria-label="ResourceSlices">ResourceSlices</a>, <a class="glossary-tooltip" title="Describes the resources that a workload needs, such as devices. ResourceClaims can request devices from DeviceClasses." data-toggle="tooltip" data-placement="top" href="/docs/concepts/scheduling-eviction/dynamic-resource-allocation/#resourceclaims-templates" target="_blank" aria-label="ResourceClaims">ResourceClaims</a>, as well as
new fields in the Pod spec itself.</p><h3 id="objectives">Objectives</h3><ul><li>Deploy an example DRA driver</li><li>Deploy a Pod requesting a hardware claim using DRA APIs</li><li>Delete a Pod that has a claim</li></ul><h2 id="before-you-begin">Before you begin</h2><p>Your cluster should support <a href="/docs/reference/access-authn-authz/rbac/">RBAC</a>.
You can try this tutorial with a cluster using a different authorization
mechanism, but in that case you will have to adapt the steps around defining
roles and permissions.</p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul><p>This tutorial has been tested with Linux nodes, though it may also work with
other types of nodes.</p>Your Kubernetes server must be version v1.34.<p>To check the version, enter <code>kubectl version</code>.</p><p>If your cluster is not currently running Kubernetes 1.34 then please check the documentation for the version of Kubernetes that you
plan to use.</p><h2 id="explore-initial-state">Explore the initial cluster state</h2><p>You can spend some time to observe the initial state of a cluster with DRA
enabled, especially if you have not used these APIs extensively before. If you
set up a new cluster for this tutorial, with no driver installed and no Pod
claims yet to satisfy, the output of these commands won't show any resources.</p><ol><li><p>Get a list of <a class="glossary-tooltip" title="A category of devices in the cluster. Users can claim specific devices in a DeviceClass." data-toggle="tooltip" data-placement="top" href="/docs/concepts/scheduling-eviction/dynamic-resource-allocation/#deviceclass" target="_blank" aria-label="DeviceClasses">DeviceClasses</a>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get deviceclasses
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex="0"><code>No resources found
</code></pre></li><li><p>Get a list of <a class="glossary-tooltip" title="Represents one or more infrastructure resources, like devices, in a pool of similar resources." data-toggle="tooltip" data-placement="top" href="/docs/reference/kubernetes-api/workload-resources/resource-slice-v1beta1/" target="_blank" aria-label="ResourceSlices">ResourceSlices</a>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get resourceslices
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex="0"><code>No resources found
</code></pre></li><li><p>Get a list of <a class="glossary-tooltip" title="Describes the resources that a workload needs, such as devices. ResourceClaims can request devices from DeviceClasses." data-toggle="tooltip" data-placement="top" href="/docs/concepts/scheduling-eviction/dynamic-resource-allocation/#resourceclaims-templates" target="_blank" aria-label="ResourceClaims">ResourceClaims</a> and <a class="glossary-tooltip" title="Defines a template for Kubernetes to create ResourceClaims. Used to provide per-Pod access to separate, similar resources." data-toggle="tooltip" data-placement="top" href="/docs/concepts/scheduling-eviction/dynamic-resource-allocation/#resourceclaims-templates" target="_blank" aria-label="ResourceClaimTemplates">ResourceClaimTemplates</a></p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get resourceclaims -A
</span></span><span style="display:flex"><span>kubectl get resourceclaimtemplates -A
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex="0"><code>No resources found
No resources found
</code></pre></li></ol><p>At this point, you have confirmed that DRA is enabled and configured properly in
the cluster, and that no DRA drivers have advertised any resources to the DRA
APIs yet.</p><h2 id="install-example-driver">Install an example DRA driver</h2><p>DRA drivers are third-party applications that run on each node of your cluster
to interface with the hardware of that node and Kubernetes' built-in DRA
components. The installation procedure depends on the driver you choose, but is
likely deployed as a <a class="glossary-tooltip" title="Ensures a copy of a Pod is running across a set of nodes in a cluster." data-toggle="tooltip" data-placement="top" href="/docs/concepts/workloads/controllers/daemonset" target="_blank" aria-label="DaemonSet">DaemonSet</a> to all or a
selection of the nodes (using <a class="glossary-tooltip" title="Allows users to filter a list of resources based on labels." data-toggle="tooltip" data-placement="top" href="/docs/concepts/overview/working-with-objects/labels/" target="_blank" aria-label="selectors">selectors</a> or similar mechanisms) in your cluster.</p><p>Check your driver's documentation for specific installation instructions, which
might include a Helm chart, a set of manifests, or other deployment tooling.</p><p>This tutorial uses an example driver which can be found in the
<a href="https://github.com/kubernetes-sigs/dra-example-driver">kubernetes-sigs/dra-example-driver</a>
repository to demonstrate driver installation. This example driver advertises
simulated GPUs to Kubernetes for your Pods to interact with.</p><h3 id="prepare-cluster-driver">Prepare your cluster for driver installation</h3><p>To simplify cleanup, create a namespace named dra-tutorial:</p><ol><li><p>Create the namespace:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl create namespace dra-tutorial 
</span></span></code></pre></div></li></ol><p>In a production environment, you would likely be using a previously released or
qualified image from the driver vendor or your own organization, and your nodes
would need to have access to the image registry where the driver image is
hosted. In this tutorial, you will use a publicly released image of the
dra-example-driver to simulate access to a DRA driver image.</p><ol><li><p>Confirm your nodes have access to the image by running the following
from within one of your cluster's nodes:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>docker pull registry.k8s.io/dra-example-driver/dra-example-driver:v0.2.0
</span></span></code></pre></div></li></ol><h3 id="deploy-the-dra-driver-components">Deploy the DRA driver components</h3><p>For this tutorial, you will install the critical example resource driver
components individually with <code>kubectl</code>.</p><ol><li><p>Create the DeviceClass representing the device types this DRA driver
supports:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/dra/driver-install/deviceclass.yaml" download="dra/driver-install/deviceclass.yaml"><code>dra/driver-install/deviceclass.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;dra-driver-install-deviceclass-yaml&quot;)" title="Copy dra/driver-install/deviceclass.yaml to clipboard"/></div><div class="includecode" id="dra-driver-install-deviceclass-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>resource.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>DeviceClass<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>gpu.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selectors</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">cel</span>:<span style="color:#bbb"> 
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">expression</span>:<span style="color:#bbb"> </span><span style="color:#b44">"device.driver == 'gpu.example.com'"</span></span></span></code></pre></div></div></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply --server-side -f http://k8s.io/examples/dra/driver-install/deviceclass.yaml
</span></span></code></pre></div></li><li><p>Create the ServiceAccount, ClusterRole and ClusterRoleBinding that will
be used by the driver to gain permissions to interact with the Kubernetes API
on this cluster:</p><ol><li><p>Create the Service Account:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/dra/driver-install/serviceaccount.yaml" download="dra/driver-install/serviceaccount.yaml"><code>dra/driver-install/serviceaccount.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;dra-driver-install-serviceaccount-yaml&quot;)" title="Copy dra/driver-install/serviceaccount.yaml to clipboard"/></div><div class="includecode" id="dra-driver-install-serviceaccount-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ServiceAccount<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>dra-example-driver-service-account<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>dra-tutorial<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">app.kubernetes.io/name</span>:<span style="color:#bbb"> </span>dra-example-driver<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">app.kubernetes.io/instance</span>:<span style="color:#bbb"> </span>dra-example-driver</span></span></code></pre></div></div></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply --server-side -f http://k8s.io/examples/dra/driver-install/serviceaccount.yaml
</span></span></code></pre></div></li><li><p>Create the ClusterRole:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/dra/driver-install/clusterrole.yaml" download="dra/driver-install/clusterrole.yaml"><code>dra/driver-install/clusterrole.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;dra-driver-install-clusterrole-yaml&quot;)" title="Copy dra/driver-install/clusterrole.yaml to clipboard"/></div><div class="includecode" id="dra-driver-install-clusterrole-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>rbac.authorization.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ClusterRole<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>dra-example-driver-role<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">rules</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">apiGroups</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"resource.k8s.io"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"resourceclaims"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">verbs</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"get"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">apiGroups</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">""</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"nodes"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">verbs</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"get"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">apiGroups</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"resource.k8s.io"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"resourceslices"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">verbs</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"get"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"list"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"watch"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"create"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"update"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"patch"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"delete"</span>]</span></span></code></pre></div></div></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply --server-side -f http://k8s.io/examples/dra/driver-install/clusterrole.yaml
</span></span></code></pre></div></li><li><p>Create the ClusterRoleBinding:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/dra/driver-install/clusterrolebinding.yaml" download="dra/driver-install/clusterrolebinding.yaml"><code>dra/driver-install/clusterrolebinding.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;dra-driver-install-clusterrolebinding-yaml&quot;)" title="Copy dra/driver-install/clusterrolebinding.yaml to clipboard"/></div><div class="includecode" id="dra-driver-install-clusterrolebinding-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>rbac.authorization.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ClusterRoleBinding<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>dra-example-driver-role-binding<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">subjects</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ServiceAccount<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>dra-example-driver-service-account<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>dra-tutorial<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">roleRef</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ClusterRole<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>dra-example-driver-role<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">apiGroup</span>:<span style="color:#bbb"> </span>rbac.authorization.k8s.io</span></span></code></pre></div></div></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply --server-side -f http://k8s.io/examples/dra/driver-install/clusterrolebinding.yaml
</span></span></code></pre></div></li></ol></li><li><p>Create a <a class="glossary-tooltip" title="A mapping from a class name to the scheduling priority that a Pod should have." data-toggle="tooltip" data-placement="top" href="/docs/concepts/scheduling-eviction/pod-priority-preemption/#priorityclass" target="_blank" aria-label="PriorityClass">PriorityClass</a> for the DRA
driver. The PriorityClass prevents preemption of th DRA driver component,
which is responsible for important lifecycle operations for Pods with
claims. Learn more about <a href="/docs/concepts/scheduling-eviction/pod-priority-preemption/">pod priority and preemption
here</a>.</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/dra/driver-install/priorityclass.yaml" download="dra/driver-install/priorityclass.yaml"><code>dra/driver-install/priorityclass.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;dra-driver-install-priorityclass-yaml&quot;)" title="Copy dra/driver-install/priorityclass.yaml to clipboard"/></div><div class="includecode" id="dra-driver-install-priorityclass-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>scheduling.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>PriorityClass<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>dra-driver-high-priority<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">value</span>:<span style="color:#bbb"> </span><span style="color:#666">1000000</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">globalDefault</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">false</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">description</span>:<span style="color:#bbb"> </span><span style="color:#b44">"This priority class should be used for DRA driver pods only."</span></span></span></code></pre></div></div></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply --server-side -f http://k8s.io/examples/dra/driver-install/priorityclass.yaml
</span></span></code></pre></div></li><li><p>Deploy the actual DRA driver as a DaemonSet configured to run the example
driver binary with the permissions provisioned above. The DaemonSet has the
permissions that you granted to the ServiceAccount in the previous steps.</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/dra/driver-install/daemonset.yaml" download="dra/driver-install/daemonset.yaml"><code>dra/driver-install/daemonset.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;dra-driver-install-daemonset-yaml&quot;)" title="Copy dra/driver-install/daemonset.yaml to clipboard"/></div><div class="includecode" id="dra-driver-install-daemonset-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>DaemonSet<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>dra-example-driver-kubeletplugin<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>dra-tutorial<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">app.kubernetes.io/name</span>:<span style="color:#bbb"> </span>dra-example-driver<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">app.kubernetes.io/name</span>:<span style="color:#bbb"> </span>dra-example-driver<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">updateStrategy</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>RollingUpdate<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app.kubernetes.io/name</span>:<span style="color:#bbb"> </span>dra-example-driver<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">priorityClassName</span>:<span style="color:#bbb"> </span>dra-driver-high-priority<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">serviceAccountName</span>:<span style="color:#bbb"> </span>dra-example-driver-service-account<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">securityContext</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>plugin<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">securityContext</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">privileged</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>registry.k8s.io/dra-example-driver/dra-example-driver:v0.2.0<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">imagePullPolicy</span>:<span style="color:#bbb"> </span>IfNotPresent<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">command</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"dra-example-kubeletplugin"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic"># Production drivers should always implement a liveness probe</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic"># For the tutorial we simply omit it</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic"># livenessProbe:</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic">#   grpc:</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic">#     port: 51515</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic">#     service: liveness</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic">#   failureThreshold: 3</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic">#   periodSeconds: 10</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">env</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>CDI_ROOT<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">value</span>:<span style="color:#bbb"> </span>/var/run/cdi<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>KUBELET_REGISTRAR_DIRECTORY_PATH<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">value</span>:<span style="color:#bbb"> </span><span style="color:#b44">"/var/lib/kubelet/plugins_registry"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>KUBELET_PLUGINS_DIRECTORY_PATH<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">value</span>:<span style="color:#bbb"> </span><span style="color:#b44">"/var/lib/kubelet/plugins"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>NODE_NAME<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">valueFrom</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">fieldRef</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">fieldPath</span>:<span style="color:#bbb"> </span>spec.nodeName<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>NAMESPACE<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">valueFrom</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">fieldRef</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">              </span><span style="color:green;font-weight:700">fieldPath</span>:<span style="color:#bbb"> </span>metadata.namespace<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic"># Simulated number of devices the example driver will pretend to have.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>NUM_DEVICES<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">value</span>:<span style="color:#bbb"> </span><span style="color:#b44">"9"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>HEALTHCHECK_PORT<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">value</span>:<span style="color:#bbb"> </span><span style="color:#b44">"51515"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">volumeMounts</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>plugins-registry<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span><span style="color:#b44">"/var/lib/kubelet/plugins_registry"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>plugins<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span><span style="color:#b44">"/var/lib/kubelet/plugins"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>cdi<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span>/var/run/cdi<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>plugins-registry<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">hostPath</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">path</span>:<span style="color:#bbb"> </span><span style="color:#b44">"/var/lib/kubelet/plugins_registry"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>plugins<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">hostPath</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">path</span>:<span style="color:#bbb"> </span><span style="color:#b44">"/var/lib/kubelet/plugins"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>cdi<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">hostPath</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">path</span>:<span style="color:#bbb"> </span>/var/run/cdi</span></span></code></pre></div></div></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply --server-side -f http://k8s.io/examples/dra/driver-install/daemonset.yaml
</span></span></code></pre></div><p>The DaemonSet is configured with
the volume mounts necessary to interact with the underlying Container Device
Interface (CDI) directory, and to expose its socket to <code>kubelet</code> via the
<code>kubelet/plugins</code> directory.</p></li></ol><h3 id="verify-driver-install">Verify the DRA driver installation</h3><ol><li><p>Get a list of the Pods of the DRA driver DaemonSet across all worker nodes:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pod -l app.kubernetes.io/name<span style="color:#666">=</span>dra-example-driver -n dra-tutorial
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex="0"><code>NAME                                     READY   STATUS    RESTARTS   AGE
dra-example-driver-kubeletplugin-4sk2x   1/1     Running   0          13s
dra-example-driver-kubeletplugin-cttr2   1/1     Running   0          13s
</code></pre></li><li><p>The initial responsibility of each node's local DRA driver is to update the
cluster with what devices are available to Pods on that node, by publishing its
metadata to the ResourceSlices API. You can check that API to see that each node
with a driver is advertising the device class it represents.</p><p>Check for available ResourceSlices:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get resourceslices
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex="0"><code>NAME                                 NODE           DRIVER            POOL           AGE
kind-worker-gpu.example.com-k69gd    kind-worker    gpu.example.com   kind-worker    19s
kind-worker2-gpu.example.com-qdgpn   kind-worker2   gpu.example.com   kind-worker2   19s
</code></pre></li></ol><p>At this point, you have successfully installed the example DRA driver, and
confirmed its initial configuration. You're now ready to use DRA to schedule
Pods.</p><h2 id="claim-resources-pod">Claim resources and deploy a Pod</h2><p>To request resources using DRA, you create ResourceClaims or
ResourceClaimTemplates that define the resources that your Pods need. In the
example driver, a memory capacity attribute is exposed for mock GPU devices.
This section shows you how to use <a class="glossary-tooltip" title="An expression language that's designed to be safe for executing user code." data-toggle="tooltip" data-placement="top" href="https://cel.dev" target="_blank" aria-label="Common Expression Language">Common Expression Language</a> to
express your requirements in a ResourceClaim, select that ResourceClaim in a Pod
specification, and observe the resource allocation.</p><p>This tutorial showcases only one basic example of a DRA ResourceClaim. Read
<a href="/docs/concepts/scheduling-eviction/dynamic-resource-allocation/">Dynamic Resource
Allocation</a> to
learn more about ResourceClaims.</p><h3 id="create-the-resourceclaim">Create the ResourceClaim</h3><p>In this section, you create a ResourceClaim and reference it in a Pod. Whatever
the claim, the <code>deviceClassName</code> is a required field, narrowing down the scope
of the request to a specific device class. The request itself can include a <a class="glossary-tooltip" title="An expression language that's designed to be safe for executing user code." data-toggle="tooltip" data-placement="top" href="https://cel.dev" target="_blank" aria-label="Common Expression Language">Common Expression Language</a> expression that references attributes that
may be advertised by the driver managing that device class.</p><p>In this example, you will create a request for any GPU advertising over 10Gi
memory capacity. The attribute exposing capacity from the example driver takes
the form <code>device.capacity['gpu.example.com'].memory</code>. Note also that the name of
the claim is set to <code>some-gpu</code>.</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/dra/driver-install/example/resourceclaim.yaml" download="dra/driver-install/example/resourceclaim.yaml"><code>dra/driver-install/example/resourceclaim.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;dra-driver-install-example-resourceclaim-yaml&quot;)" title="Copy dra/driver-install/example/resourceclaim.yaml to clipboard"/></div><div class="includecode" id="dra-driver-install-example-resourceclaim-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>resource.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ResourceClaim<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"> </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>some-gpu<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"> </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>dra-tutorial<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">   </span><span style="color:green;font-weight:700">devices</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">     </span><span style="color:green;font-weight:700">requests</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">     </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>some-gpu<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">       </span><span style="color:green;font-weight:700">exactly</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">         </span><span style="color:green;font-weight:700">deviceClassName</span>:<span style="color:#bbb"> </span>gpu.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">         </span><span style="color:green;font-weight:700">selectors</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">         </span>- <span style="color:green;font-weight:700">cel</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">             </span><span style="color:green;font-weight:700">expression</span>:<span style="color:#bbb"> </span><span style="color:#b44">"device.capacity['gpu.example.com'].memory.compareTo(quantity('10Gi')) &gt;= 0"</span></span></span></code></pre></div></div></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply --server-side -f http://k8s.io/examples/dra/driver-install/example/resourceclaim.yaml
</span></span></code></pre></div><h3 id="create-the-pod-that-references-that-resourceclaim">Create the Pod that references that ResourceClaim</h3><p>Below is the Pod manifest referencing the ResourceClaim you just made,
<code>some-gpu</code>, in the <code>spec.resourceClaims.resourceClaimName</code> field. The local name
for that claim, <code>gpu</code>, is then used in the
<code>spec.containers.resources.claims.name</code> field to allocate the claim to the Pod's
underlying container.</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/dra/driver-install/example/pod.yaml" download="dra/driver-install/example/pod.yaml"><code>dra/driver-install/example/pod.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;dra-driver-install-example-pod-yaml&quot;)" title="Copy dra/driver-install/example/pod.yaml to clipboard"/></div><div class="includecode" id="dra-driver-install-example-pod-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Pod<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>pod0<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>dra-tutorial<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>pod<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>ctr0<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>ubuntu:24.04<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">command</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"bash"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"-c"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">args</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"export; trap 'exit 0' TERM; sleep 9999 &amp; wait"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">claims</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>gpu<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">resourceClaims</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>gpu<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">resourceClaimName</span>:<span style="color:#bbb"> </span>some-gpu</span></span></code></pre></div></div></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply --server-side -f http://k8s.io/examples/dra/driver-install/example/pod.yaml
</span></span></code></pre></div><ol><li><p>Confirm the pod has deployed:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pod pod0 -n dra-tutorial
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex="0"><code>NAME   READY   STATUS    RESTARTS   AGE
pod0   1/1     Running   0          9s
</code></pre></li></ol><h3 id="explore-the-dra-state">Explore the DRA state</h3><p>After you create the Pod, the cluster tries to schedule that Pod to a node where
Kubernetes can satisfy the ResourceClaim. In this tutorial, the DRA driver is
deployed on all nodes, and is advertising mock GPUs on all nodes, all of which
have enough capacity advertised to satisfy the Pod's claim, so Kubernetes can
schedule this Pod on any node and can allocate any of the mock GPUs on that
node.</p><p>When Kubernetes allocates a mock GPU to a Pod, the example driver adds
environment variables in each container it is allocated to in order to indicate
which GPUs <em>would</em> have been injected into them by a real resource driver and
how they would have been configured, so you can check those environment
variables to see how the Pods have been handled by the system.</p><ol><li><p>Check the Pod logs, which report the name of the mock GPU that was allocated:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl logs pod0 -c ctr0 -n dra-tutorial | grep -E <span style="color:#b44">"GPU_DEVICE_[0-9]+="</span> | grep -v <span style="color:#b44">"RESOURCE_CLAIM"</span>
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex="0"><code>declare -x GPU_DEVICE_0="gpu-0"
</code></pre></li><li><p>Check the state of the ResourceClaim object:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get resourceclaims -n dra-tutorial
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex="0"><code>NAME       STATE                AGE
some-gpu   allocated,reserved   34s
</code></pre><p>In this output, the <code>STATE</code> column shows that the ResourceClaim is allocated
and reserved.</p></li><li><p>Check the details of the <code>some-gpu</code> ResourceClaim. The <code>status</code> stanza of
the ResourceClaim has information about the allocated device and the Pod it
has been reserved for:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get resourceclaim some-gpu -n dra-tutorial -o yaml
</span></span></code></pre></div><p>The output is similar to this:<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>resource.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ResourceClaim<span style="color:#bbb">
</span></span></span><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">creationTimestamp</span>:<span style="color:#bbb"> </span><span style="color:#b44">"2025-08-20T18:17:31Z"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">finalizers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style="color:#bbb">    </span>- resource.kubernetes.io/delete-protection<span style="color:#bbb">
</span></span></span><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>some-gpu<span style="color:#bbb">
</span></span></span><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>dra-tutorial<span style="color:#bbb">
</span></span></span><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">resourceVersion</span>:<span style="color:#bbb"> </span><span style="color:#b44">"2326"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">uid</span>:<span style="color:#bbb"> </span>d3e48dbf-40da-47c3-a7b9-f7d54d1051c3<span style="color:#bbb">
</span></span></span><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">devices</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">requests</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">exactly</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">allocationMode</span>:<span style="color:#bbb"> </span>ExactCount<span style="color:#bbb">
</span></span></span><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">count</span>:<span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">deviceClassName</span>:<span style="color:#bbb"> </span>gpu.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">selectors</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style="color:#bbb">            </span>- <span style="color:green;font-weight:700">cel</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style="color:#bbb">                </span><span style="color:green;font-weight:700">expression</span>:<span style="color:#bbb"> </span>device.capacity['gpu.example.com'].memory.compareTo(quantity('10Gi'))<span style="color:#bbb">
</span></span></span><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style="color:#bbb">                </span>&gt;= 0<span style="color:#bbb">
</span></span></span><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>some-gpu<span style="color:#bbb">
</span></span></span><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style="color:#bbb"/><span style="color:green;font-weight:700">status</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">allocation</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">devices</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">results</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;background-color:#dfdfdf"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">device</span>:<span style="color:#bbb"> </span>gpu-0<span style="color:#bbb">
</span></span></span><span style="display:flex;background-color:#dfdfdf"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">driver</span>:<span style="color:#bbb"> </span>gpu.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex;background-color:#dfdfdf"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">pool</span>:<span style="color:#bbb"> </span>kind-worker<span style="color:#bbb">
</span></span></span><span style="display:flex;background-color:#dfdfdf"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">request</span>:<span style="color:#bbb"> </span>some-gpu<span style="color:#bbb">
</span></span></span><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">nodeSelector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">nodeSelectorTerms</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">matchFields</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style="color:#bbb">            </span>- <span style="color:green;font-weight:700">key</span>:<span style="color:#bbb"> </span>metadata.name<span style="color:#bbb">
</span></span></span><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">operator</span>:<span style="color:#bbb"> </span>In<span style="color:#bbb">
</span></span></span><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">values</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style="color:#bbb">            </span>- kind-worker<span style="color:#bbb">
</span></span></span><span style="display:flex;background-color:#dfdfdf"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">reservedFor</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;background-color:#dfdfdf"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>pod0<span style="color:#bbb">
</span></span></span><span style="display:flex;background-color:#dfdfdf"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">resource</span>:<span style="color:#bbb"> </span>pods<span style="color:#bbb">
</span></span></span><span style="display:flex;background-color:#dfdfdf"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">uid</span>:<span style="color:#bbb"> </span>c4dadf20-392a-474d-a47b-ab82080c8bd7</span></span></code></pre></div></p></li><li><p>To check how the driver handled device allocation, get the logs for the
driver DaemonSet Pods:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl logs -l app.kubernetes.io/name<span style="color:#666">=</span>dra-example-driver -n dra-tutorial
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex="0"><code>I0820 18:17:44.131324       1 driver.go:106] PrepareResourceClaims is called: number of claims: 1
I0820 18:17:44.135056       1 driver.go:133] Returning newly prepared devices for claim 'd3e48dbf-40da-47c3-a7b9-f7d54d1051c3': [{[some-gpu] kind-worker gpu-0 [k8s.gpu.example.com/gpu=common k8s.gpu.example.com/gpu=d3e48dbf-40da-47c3-a7b9-f7d54d1051c3-gpu-0]}]
</code></pre></li></ol><p>You have now successfully deployed a Pod that claims devices using DRA, verified
that the Pod was scheduled to an appropriate node, and saw that the associated
DRA APIs kinds were updated with the allocation status.</p><h2 id="delete-pod-claim">Delete a Pod that has a claim</h2><p>When a Pod with a claim is deleted, the DRA driver deallocates the resource so
it can be available for future scheduling. To validate this behavior, delete the
Pod that you created in the previous steps and watch the corresponding changes
to the ResourceClaim and driver.</p><ol><li><p>Delete the <code>pod0</code> Pod:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl delete pod pod0 -n dra-tutorial
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex="0"><code>pod "pod0" deleted
</code></pre></li></ol><h3 id="observe-the-dra-state">Observe the DRA state</h3><p>When the Pod is deleted, the driver deallocates the device from the
ResourceClaim and updates the ResourceClaim resource in the Kubernetes API. The
ResourceClaim has a <code>pending</code> state until it's referenced in a new Pod.</p><ol><li><p>Check the state of the <code>some-gpu</code> ResourceClaim:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get resourceclaims -n dra-tutorial
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex="0"><code>NAME       STATE     AGE
some-gpu   pending   76s
</code></pre></li><li><p>Verify that the driver has processed unpreparing the device for this claim by
checking the driver logs:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl logs -l app.kubernetes.io/name<span style="color:#666">=</span>dra-example-driver -n dra-tutorial
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex="0"><code>I0820 18:22:15.629376       1 driver.go:138] UnprepareResourceClaims is called: number of claims: 1
</code></pre></li></ol><p>You have now deleted a Pod that had a claim, and observed that the driver took
action to unprepare the underlying hardware resource and update the DRA APIs to
reflect that the resource is available again for future scheduling.</p><h2 id="cleaning-up">Cleaning up</h2><p>To clean up the resources that you created in this tutorial, follow these steps:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl delete namespace dra-tutorial
</span></span><span style="display:flex"><span>kubectl delete deviceclass gpu.example.com
</span></span><span style="display:flex"><span>kubectl delete clusterrole dra-example-driver-role
</span></span><span style="display:flex"><span>kubectl delete clusterrolebinding dra-example-driver-role-binding
</span></span><span style="display:flex"><span>kubectl delete priorityclass dra-driver-high-priority
</span></span></code></pre></div><h2 id="what-s-next">What's next</h2><ul><li><a href="/docs/concepts/scheduling-eviction/dynamic-resource-allocation/">Learn more about DRA</a></li><li><a href="/docs/tasks/configure-pod-container/assign-resources/allocate-devices-dra/">Allocate Devices to Workloads with DRA</a></li></ul></div>
<hr>
<div class="td-content"><h1>Configuration</h1><div class="section-index"><hr class="panel-line"/><div class="entry"><h5><a href="/docs/tutorials/configuration/updating-configuration-via-a-configmap/">Updating Configuration via a ConfigMap</a></h5><p/></div><div class="entry"><h5><a href="/docs/tutorials/configuration/configure-redis-using-configmap/">Configuring Redis using a ConfigMap</a></h5><p/></div><div class="entry"><h5><a href="/docs/tutorials/configuration/pod-sidecar-containers/">Adopting Sidecar Containers</a></h5><p/></div></div></div>
<hr>
<div class="td-content"><h1>Cluster Management</h1><div class="section-index"><hr class="panel-line"/><div class="entry"><h5><a href="/docs/tutorials/cluster-management/kubelet-standalone/">Running Kubelet in Standalone Mode</a></h5><p/></div><div class="entry"><h5><a href="/docs/tutorials/cluster-management/provision-swap-memory/">Configuring swap memory on Kubernetes nodes</a></h5><p/></div><div class="entry"><h5><a href="/docs/tutorials/cluster-management/install-use-dra/">Install Drivers and Allocate Devices with DRA</a></h5><p/></div><div class="entry"><h5><a href="/docs/tutorials/cluster-management/namespaces-walkthrough/">Namespaces Walkthrough</a></h5><p/></div></div></div>