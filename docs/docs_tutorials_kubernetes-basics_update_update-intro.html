<div class="td-content"><h1 data-pagefind-weight="10">Performing a Rolling Update</h1><h2 id="objectives">Objectives</h2><p>Perform a rolling update using kubectl.</p><h2 id="updating-an-application">Updating an application</h2><div class="alert alert-primary" role="alert"><em>Rolling updates allow Deployments' update to take place with zero downtime by
incrementally updating Pods instances with new ones.</em></div><p>Users expect applications to be available all the time, and developers are expected
to deploy new versions of them several times a day. In Kubernetes this is done with
rolling updates. A <strong>rolling update</strong> allows a Deployment update to take place with
zero downtime. It does this by incrementally replacing the current Pods with new ones.
The new Pods are scheduled on Nodes with available resources, and Kubernetes waits
for those new Pods to start before removing the old Pods.</p><p>In the previous module we scaled our application to run multiple instances. This
is a requirement for performing updates without affecting application availability.
By default, the maximum number of Pods that can be unavailable during the update
and the maximum number of new Pods that can be created, is one. Both options can
be configured to either numbers or percentages (of Pods). In Kubernetes, updates are
versioned and any Deployment update can be reverted to a previous (stable) version.</p><h2 id="rolling-updates-overview">Rolling updates overview</h2><div class="col-md-8"><div id="myCarousel" class="carousel" data-ride="carousel" data-interval="3000"><div class="carousel-inner" role="listbox"><div class="item carousel-item active"><img src="/docs/tutorials/kubernetes-basics/public/images/module_06_rollingupdates1.svg"/></div><div class="item carousel-item"><img src="/docs/tutorials/kubernetes-basics/public/images/module_06_rollingupdates2.svg"/></div><div class="item carousel-item"><img src="/docs/tutorials/kubernetes-basics/public/images/module_06_rollingupdates3.svg"/></div><div class="item carousel-item"><img src="/docs/tutorials/kubernetes-basics/public/images/module_06_rollingupdates4.svg"/></div></div></div></div><div class="alert alert-primary" role="alert"><em>If a Deployment is exposed publicly, the Service will load-balance the traffic
only to available Pods during the update.</em></div><p>Similar to application Scaling, if a Deployment is exposed publicly, the Service
will load-balance the traffic only to available Pods during the update. An available
Pod is an instance that is available to the users of the application.</p><p>Rolling updates allow the following actions:</p><ul><li>Promote an application from one environment to another (via container image updates)</li><li>Rollback to previous versions</li><li>Continuous Integration and Continuous Delivery of applications with zero downtime</li></ul><p>In the following interactive tutorial, we'll update our application to a new version,
and also perform a rollback.</p><h3 id="update-the-version-of-the-app">Update the version of the app</h3><p>To list your Deployments, run the <code>get deployments</code> subcommand:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get deployments
</span></span></code></pre></div><p>To list the running Pods, run the <code>get pods</code> subcommand:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pods
</span></span></code></pre></div><p>To view the current image version of the app, run the <code>describe pods</code> subcommand
and look for the <code>Image</code> field:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl describe pods
</span></span></code></pre></div><p>To update the image of the application to version 2, use the <code>set image</code> subcommand,
followed by the deployment name and the new image version:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl <span style="color:#a2f">set</span> image deployments/kubernetes-bootcamp kubernetes-bootcamp<span style="color:#666">=</span>docker.io/jocatalin/kubernetes-bootcamp:v2
</span></span></code></pre></div><p>The command notified the Deployment to use a different image for your app and initiated
a rolling update. Check the status of the new Pods, and view the old one terminating
with the <code>get pods</code> subcommand:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pods
</span></span></code></pre></div><h3 id="verify-an-update">Verify an update</h3><p>First, check that the service is running, as you might have deleted it in previous
tutorial step, run <code>describe services/kubernetes-bootcamp</code>. If it's missing,
you can create it again with:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl expose deployment/kubernetes-bootcamp --type<span style="color:#666">=</span><span style="color:#b44">"NodePort"</span> --port <span style="color:#666">8080</span>
</span></span></code></pre></div><p>Create an environment variable called <code>NODE_PORT</code> that has the value of the Node
port assigned:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#a2f">export</span> <span style="color:#b8860b">NODE_PORT</span><span style="color:#666">=</span><span style="color:#b44">"</span><span style="color:#a2f;font-weight:700">$(</span>kubectl get services/kubernetes-bootcamp -o go-template<span style="color:#666">=</span><span style="color:#b44">'{{(index .spec.ports 0).nodePort}}'</span><span style="color:#a2f;font-weight:700">)</span><span style="color:#b44">"</span>
</span></span><span style="display:flex"><span><span style="color:#a2f">echo</span> <span style="color:#b44">"NODE_PORT=</span><span style="color:#b8860b">$NODE_PORT</span><span style="color:#b44">"</span>
</span></span></code></pre></div><p>Next, do a <code>curl</code> to the exposed IP and port:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>curl http://<span style="color:#b44">"</span><span style="color:#a2f;font-weight:700">$(</span>minikube ip<span style="color:#a2f;font-weight:700">)</span><span style="color:#b44">:</span><span style="color:#b8860b">$NODE_PORT</span><span style="color:#b44">"</span>
</span></span></code></pre></div><p>Every time you run the <code>curl</code> command, you will hit a different Pod. Notice that
all Pods are now running the latest version (<code>v2</code>).</p><p>You can also confirm the update by running the <code>rollout status</code> subcommand:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl rollout status deployments/kubernetes-bootcamp
</span></span></code></pre></div><p>To view the current image version of the app, run the describe pods subcommand:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl describe pods
</span></span></code></pre></div><p>In the <code>Image</code> field of the output, verify that you are running the latest image
version (<code>v2</code>).</p><h3 id="roll-back-an-update">Roll back an update</h3><p>Letâ€™s perform another update, and try to deploy an image tagged with <code>v10</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl <span style="color:#a2f">set</span> image deployments/kubernetes-bootcamp kubernetes-bootcamp<span style="color:#666">=</span>gcr.io/google-samples/kubernetes-bootcamp:v10
</span></span></code></pre></div><p>Use <code>get deployments</code> to see the status of the deployment:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get deployments
</span></span></code></pre></div><p>Notice that the output doesn't list the desired number of available Pods. Run the
<code>get pods</code> subcommand to list all Pods:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pods
</span></span></code></pre></div><p>Notice that some of the Pods have a status of <code>ImagePullBackOff</code>.</p><p>To get more insight into the problem, run the <code>describe pods</code> subcommand:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl describe pods
</span></span></code></pre></div><p>In the <code>Events</code> section of the output for the affected Pods, notice that the <code>v10</code>
image version did not exist in the repository.</p><p>To roll back the deployment to your last working version, use the <code>rollout undo</code>
subcommand:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl rollout undo deployments/kubernetes-bootcamp
</span></span></code></pre></div><p>The <code>rollout undo</code> command reverts the deployment to the previous known state
(<code>v2</code> of the image). Updates are versioned and you can revert to any previously
known state of a Deployment.</p><p>Use the <code>get pods</code> subcommand to list the Pods again:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pods
</span></span></code></pre></div><p>To check the image deployed on the running Pods, use the <code>describe pods</code> subcommand:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl describe pods
</span></span></code></pre></div><p>The Deployment is once again using a stable version of the app (<code>v2</code>). The rollback
was successful.</p><p>Remember to clean up your local cluster.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl delete deployments/kubernetes-bootcamp services/kubernetes-bootcamp
</span></span></code></pre></div><h2 id="what-s-next">What's next</h2><ul><li>Learn more about <a href="/docs/concepts/workloads/controllers/deployment/">Deployments</a>.</li></ul></div>