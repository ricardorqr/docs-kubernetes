<div class="td-content"><h1 data-pagefind-weight="10">Configure a kubelet image credential provider</h1><div class="feature-state-notice feature-stable"><span class="feature-state-name">FEATURE STATE:</span>
<code>Kubernetes v1.26 [stable]</code></div><p>Starting from Kubernetes v1.20, the kubelet can dynamically retrieve credentials for a container image registry
using exec plugins. The kubelet and the exec plugin communicate through stdio (stdin, stdout, and stderr) using
Kubernetes versioned APIs. These plugins allow the kubelet to request credentials for a container registry dynamically
as opposed to storing static credentials on disk. For example, the plugin may talk to a local metadata server to retrieve
short-lived credentials for an image that is being pulled by the kubelet.</p><p>You may be interested in using this capability if any of the below are true:</p><ul><li>API calls to a cloud provider service are required to retrieve authentication information for a registry.</li><li>Credentials have short expiration times and requesting new credentials frequently is required.</li><li>Storing registry credentials on disk or in imagePullSecrets is not acceptable.</li></ul><p>This guide demonstrates how to configure the kubelet's image credential provider plugin mechanism.</p><h2 id="service-account-token-for-image-pulls">Service Account Token for Image Pulls</h2><div class="feature-state-notice feature-beta" title="Feature Gate: KubeletServiceAccountTokenForCredentialProviders"><span class="feature-state-name">FEATURE STATE:</span>
<code>Kubernetes v1.34 [beta]</code> (enabled by default: true)</div><p>Starting from Kubernetes v1.33,
the kubelet can be configured to send a service account token
bound to the pod for which the image pull is being performed
to the credential provider plugin.</p><p>This allows the plugin to exchange the token for credentials
to access the image registry.</p><p>To enable this feature,
the <code>KubeletServiceAccountTokenForCredentialProviders</code> feature gate
must be enabled on the kubelet,
and the <code>tokenAttributes</code> field must be set
in the <code>CredentialProviderConfig</code> file for the plugin.</p><p>The <code>tokenAttributes</code> field contains information
about the service account token that will be passed to the plugin,
including the intended audience for the token
and whether the plugin requires the pod to have a service account.</p><p>Using service account token credentials can enable the following use-cases:</p><ul><li>Avoid needing a kubelet/node-based identity to pull images from a registry.</li><li>Allow workloads to pull images based on their own runtime identity
without long-lived/persisted secrets.</li></ul><h2 id="before-you-begin">Before you begin</h2><ul><li>You need a Kubernetes cluster with nodes that support kubelet credential
provider plugins. This support is available in Kubernetes 1.34;
Kubernetes v1.24 and v1.25 included this as a beta feature, enabled by default.</li><li>If you are configuring a credential provider plugin
that requires the service account token,
you need a Kubernetes cluster with nodes running Kubernetes v1.33 or later
and the <code>KubeletServiceAccountTokenForCredentialProviders</code> feature gate
enabled on the kubelet.</li><li>A working implementation of a credential provider exec plugin. You can build your own plugin or use one provided by cloud providers.</li></ul>Your Kubernetes server must be at or later than version v1.26.<p>To check the version, enter <code>kubectl version</code>.</p><h2 id="installing-plugins-on-nodes">Installing Plugins on Nodes</h2><p>A credential provider plugin is an executable binary that will be run by the kubelet. Ensure that the plugin binary exists on
every node in your cluster and stored in a known directory. The directory will be required later when configuring kubelet flags.</p><h2 id="configuring-the-kubelet">Configuring the Kubelet</h2><p>In order to use this feature, the kubelet expects two flags to be set:</p><ul><li><code>--image-credential-provider-config</code> - the path to the credential provider plugin config file.</li><li><code>--image-credential-provider-bin-dir</code> - the path to the directory where credential provider plugin binaries are located.</li></ul><h3 id="configure-a-kubelet-credential-provider">Configure a kubelet credential provider</h3><p>The configuration file passed into <code>--image-credential-provider-config</code> is read by the kubelet to determine which exec plugins
should be invoked for which container images. Here's an example configuration file you may end up using if you are using the
<a href="https://github.com/kubernetes/cloud-provider-aws/tree/master/cmd/ecr-credential-provider">ECR-based plugin</a>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>kubelet.config.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>CredentialProviderConfig<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># providers is a list of credential provider helper plugins that will be enabled by the kubelet.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># Multiple providers may match against a single image, in which case credentials</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># from all providers will be returned to the kubelet. If multiple providers are called</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># for a single image, the results are combined. If providers return overlapping</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># auth keys, the value from the provider earlier in this list is used.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">providers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># name is the required name of the credential provider. It must match the name of the</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># provider executable as seen by the kubelet. The executable must be in the kubelet's</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># bin directory (set by the --image-credential-provider-bin-dir flag).</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>ecr-credential-provider<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># matchImages is a required list of strings used to match against images in order to</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># determine if this provider should be invoked. If one of the strings matches the</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># requested image from the kubelet, the plugin will be invoked and given a chance</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># to provide credentials. Images are expected to contain the registry domain</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># and URL path.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic">#</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># Each entry in matchImages is a pattern which can optionally contain a port and a path.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># Globs can be used in the domain, but not in the port or the path. Globs are supported</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># as subdomains like '*.k8s.io' or 'k8s.*.io', and top-level-domains such as 'k8s.*'.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># Matching partial subdomains like 'app*.k8s.io' is also supported. Each glob can only match</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># a single subdomain segment, so `*.io` does **not** match `*.k8s.io`.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic">#</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># A match exists between an image and a matchImage when all of the below are true:</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># - Both contain the same number of domain parts and each part matches.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># - The URL path of an matchImages must be a prefix of the target image URL path.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># - If the matchImages contains a port, then the port must match in the image as well.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic">#</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># Example values of matchImages:</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># - 123456789.dkr.ecr.us-east-1.amazonaws.com</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># - *.azurecr.io</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># - gcr.io</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># - *.*.registry.io</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># - registry.io:8080/path</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchImages</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:#b44">"*.dkr.ecr.*.amazonaws.com"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:#b44">"*.dkr.ecr.*.amazonaws.com.cn"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:#b44">"*.dkr.ecr-fips.*.amazonaws.com"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:#b44">"*.dkr.ecr.us-iso-east-1.c2s.ic.gov"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:#b44">"*.dkr.ecr.us-isob-east-1.sc2s.sgov.gov"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># defaultCacheDuration is the default duration the plugin will cache credentials in-memory</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># if a cache duration is not provided in the plugin response. This field is required.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">defaultCacheDuration</span>:<span style="color:#bbb"> </span><span style="color:#b44">"12h"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># Required input version of the exec CredentialProviderRequest. The returned CredentialProviderResponse</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># MUST use the same encoding version as the input. Current supported values are:</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># - credentialprovider.kubelet.k8s.io/v1</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>credentialprovider.kubelet.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># Arguments to pass to the command when executing it.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># +optional</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># args:</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic">#   - --example-argument</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># Env defines additional environment variables to expose to the process. These</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># are unioned with the host's environment, as well as variables client-go uses</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># to pass argument to the plugin.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># +optional</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">env</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>AWS_PROFILE<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">value</span>:<span style="color:#bbb"> </span>example_profile<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># tokenAttributes is the configuration for the service account token that will be passed to the plugin.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># The credential provider opts in to using service account tokens for image pull by setting this field.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># if this field is set without the `KubeletServiceAccountTokenForCredentialProviders` feature gate enabled, </span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># kubelet will fail to start with invalid configuration error.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># +optional</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">tokenAttributes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># serviceAccountTokenAudience is the intended audience for the projected service account token.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># +required</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">serviceAccountTokenAudience</span>:<span style="color:#bbb"> </span><span style="color:#b44">"&lt;audience for the token&gt;"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># cacheType indicates the type of cache key use for caching the credentials returned by the plugin</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># when the service account token is used.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># The most conservative option is to set this to "Token", which means the kubelet will cache</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># returned credentials on a per-token basis. This should be set if the returned credential's</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># lifetime is limited to the service account token's lifetime.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># If the plugin's credential retrieval logic depends only on the service account and not on</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># pod-specific claims, then the plugin can set this to "ServiceAccount". In this case, the</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># kubelet will cache returned credentials on a per-serviceaccount basis. Use this when the</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># returned credential is valid for all pods using the same service account.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># +required</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">cacheType</span>:<span style="color:#bbb"> </span><span style="color:#b44">"&lt;Token or ServiceAccount&gt;"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># requireServiceAccount indicates whether the plugin requires the pod to have a service account.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># If set to true, kubelet will only invoke the plugin if the pod has a service account.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># If set to false, kubelet will invoke the plugin even if the pod does not have a service account</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># and will not include a token in the CredentialProviderRequest. This is useful for plugins</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># that are used to pull images for pods without service accounts (e.g., static pods).</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># +required</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">requireServiceAccount</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># requiredServiceAccountAnnotationKeys is the list of annotation keys that the plugin is interested in</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># and that are required to be present in the service account.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># The keys defined in this list will be extracted from the corresponding service account and passed</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># to the plugin as part of the CredentialProviderRequest. If any of the keys defined in this list</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># are not present in the service account, kubelet will not invoke the plugin and will return an error.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># This field is optional and may be empty. Plugins may use this field to extract additional information</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># required to fetch credentials or allow workloads to opt in to using service account tokens for image pull.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># If non-empty, requireServiceAccount must be set to true.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># The keys defined in this list must be unique and not overlap with the keys defined in the</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># optionalServiceAccountAnnotationKeys list.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># +optional</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">requiredServiceAccountAnnotationKeys</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:#b44">"example.com/required-annotation-key-1"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:#b44">"example.com/required-annotation-key-2"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># optionalServiceAccountAnnotationKeys is the list of annotation keys that the plugin is interested in</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># and that are optional to be present in the service account.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># The keys defined in this list will be extracted from the corresponding service account and passed</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># to the plugin as part of the CredentialProviderRequest. The plugin is responsible for validating the</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># existence of annotations and their values. This field is optional and may be empty.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># Plugins may use this field to extract additional information required to fetch credentials.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># The keys defined in this list must be unique and not overlap with the keys defined in the</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># requiredServiceAccountAnnotationKeys list.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># +optional</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">optionalServiceAccountAnnotationKeys</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:#b44">"example.com/optional-annotation-key-1"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:#b44">"example.com/optional-annotation-key-2"</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>The <code>providers</code> field is a list of enabled plugins used by the kubelet. Each entry has a few required fields:</p><ul><li><code>name</code>: the name of the plugin which MUST match the name of the executable binary that exists
in the directory passed into <code>--image-credential-provider-bin-dir</code>.</li><li><code>matchImages</code>: a list of strings used to match against images in order to determine
if this provider should be invoked. More on this below.</li><li><code>defaultCacheDuration</code>: the default duration the kubelet will cache credentials in-memory
if a cache duration was not specified by the plugin.</li><li><code>apiVersion</code>: the API version that the kubelet and the exec plugin will use when communicating.</li></ul><p>Each credential provider can also be given optional args and environment variables as well.
Consult the plugin implementors to determine what set of arguments and environment variables are required for a given plugin.</p><p>If you are using the KubeletServiceAccountTokenForCredentialProviders feature gate
and configuring the plugin to use the service account token
by setting the tokenAttributes field,
the following fields are required:</p><ul><li><code>serviceAccountTokenAudience</code>:
the intended audience for the projected service account token.
This cannot be the empty string.</li><li><code>cacheType</code>:
the type of cache key used for caching the credentials returned by the plugin
when the service account token is used.
The most conservative option is to set this to <code>Token</code>,
which means the kubelet will cache returned credentials
on a per-token basis.
This should be set if the returned credential's lifetime
is limited to the service account token's lifetime.
If the plugin's credential retrieval logic depends only on the service account
and not on pod-specific claims,
then the plugin can set this to <code>ServiceAccount</code>.
In this case, the kubelet will cache returned credentials
on a per-service account basis.
Use this when the returned credential is valid for all pods using the same service account.</li><li><code>requireServiceAccount</code>:
whether the plugin requires the pod to have a service account.<ul><li>If set to <code>true</code>, kubelet will only invoke the plugin
if the pod has a service account.</li><li>If set to <code>false</code>, kubelet will invoke the plugin
even if the pod does not have a service account
and will not include a token in the <code>CredentialProviderRequest</code>.</li></ul></li></ul><p>This is useful for plugins that are used
to pull images for pods without service accounts
(e.g., static pods).</p><h4 id="configure-image-matching">Configure image matching</h4><p>The <code>matchImages</code> field for each credential provider is used by the kubelet to determine whether a plugin should be invoked
for a given image that a Pod is using. Each entry in <code>matchImages</code> is an image pattern which can optionally contain a port and a path.
Globs can be used in the domain, but not in the port or the path. Globs are supported as subdomains like <code>*.k8s.io</code> or <code>k8s.*.io</code>,
and top-level domains such as <code>k8s.*</code>. Matching partial subdomains like <code>app*.k8s.io</code> is also supported. Each glob can only match
a single subdomain segment, so <code>*.io</code> does NOT match <code>*.k8s.io</code>.</p><p>A match exists between an image name and a <code>matchImage</code> entry when all of the below are true:</p><ul><li>Both contain the same number of domain parts and each part matches.</li><li>The URL path of match image must be a prefix of the target image URL path.</li><li>If the matchImages contains a port, then the port must match in the image as well.</li></ul><p>Some example values of <code>matchImages</code> patterns are:</p><ul><li><code>123456789.dkr.ecr.us-east-1.amazonaws.com</code></li><li><code>*.azurecr.io</code></li><li><code>gcr.io</code></li><li><code>*.*.registry.io</code></li><li><code>foo.registry.io:8080/path</code></li></ul><h2 id="what-s-next">What's next</h2><ul><li>Read the details about <code>CredentialProviderConfig</code> in the
<a href="/docs/reference/config-api/kubelet-config.v1/">kubelet configuration API (v1) reference</a>.</li><li>Read the <a href="/docs/reference/config-api/kubelet-credentialprovider.v1/">kubelet credential provider API reference (v1)</a>.</li></ul></div>