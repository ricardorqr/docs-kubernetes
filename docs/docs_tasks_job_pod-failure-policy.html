<div class="td-content"><h1 data-pagefind-weight="10">Handling retriable and non-retriable pod failures with Pod failure policy</h1><div class="feature-state-notice feature-stable" title="Feature Gate: JobPodFailurePolicy"><span class="feature-state-name">FEATURE STATE:</span>
<code>Kubernetes v1.31 [stable]</code> (enabled by default: true)</div><p>This document shows you how to use the
<a href="/docs/concepts/workloads/controllers/job/#pod-failure-policy">Pod failure policy</a>,
in combination with the default
<a href="/docs/concepts/workloads/controllers/job/#pod-backoff-failure-policy">Pod backoff failure policy</a>,
to improve the control over the handling of container- or Pod-level failure
within a <a class="glossary-tooltip" title="A finite or batch task that runs to completion." data-toggle="tooltip" data-placement="top" href="/docs/concepts/workloads/controllers/job/" target="_blank" aria-label="Job">Job</a>.</p><p>The definition of Pod failure policy may help you to:</p><ul><li>better utilize the computational resources by avoiding unnecessary Pod retries.</li><li>avoid Job failures due to Pod disruptions (such <a class="glossary-tooltip" title="Preemption logic in Kubernetes helps a pending Pod to find a suitable Node by evicting low priority Pods existing on that Node." data-toggle="tooltip" data-placement="top" href="/docs/concepts/scheduling-eviction/pod-priority-preemption/#preemption" target="_blank" aria-label="preemption">preemption</a>,
<a class="glossary-tooltip" title="API-initiated eviction is the process by which you use the Eviction API to create an Eviction object that triggers graceful pod termination." data-toggle="tooltip" data-placement="top" href="/docs/concepts/scheduling-eviction/api-eviction/" target="_blank" aria-label="API-initiated eviction">API-initiated eviction</a>
or <a class="glossary-tooltip" title="A core object consisting of three required properties: key, value, and effect. Taints prevent the scheduling of pods on nodes or node groups." data-toggle="tooltip" data-placement="top" href="/docs/concepts/scheduling-eviction/taint-and-toleration/" target="_blank" aria-label="taint">taint</a>-based eviction).</li></ul><h2 id="before-you-begin">Before you begin</h2><p>You should already be familiar with the basic use of <a href="/docs/concepts/workloads/controllers/job/">Job</a>.</p><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul>Your Kubernetes server must be at or later than version v1.25.<p>To check the version, enter <code>kubectl version</code>.</p></p><h2 id="usage-scenarios">Usage scenarios</h2><p>Consider the following usage scenarios for Jobs that define a Pod failure policy :</p><ul><li><a href="#pod-failure-policy-failjob">Avoiding unnecessary Pod retries</a></li><li><a href="#pod-failure-policy-ignore">Ignoring Pod disruptions</a></li><li><a href="#pod-failure-policy-config-issue">Avoiding unnecessary Pod retries based on custom Pod Conditions</a></li><li><a href="#backoff-limit-per-index-failindex">Avoiding unnecessary Pod retries per index</a></li></ul><h3 id="pod-failure-policy-failjob">Using Pod failure policy to avoid unnecessary Pod retries</h3><p>With the following example, you can learn how to use Pod failure policy to
avoid unnecessary Pod restarts when a Pod failure indicates a non-retriable
software bug.</p><ol><li><p>Examine the following manifest:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples//controllers/job-pod-failure-policy-failjob.yaml" download="/controllers/job-pod-failure-policy-failjob.yaml"><code>/controllers/job-pod-failure-policy-failjob.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;controllers-job-pod-failure-policy-failjob-yaml&quot;)" title="Copy /controllers/job-pod-failure-policy-failjob.yaml to clipboard"/></div><div class="includecode" id="controllers-job-pod-failure-policy-failjob-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>batch/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Job<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>job-pod-failure-policy-failjob<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">completions</span>:<span style="color:#bbb"> </span><span style="color:#666">8</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">parallelism</span>:<span style="color:#bbb"> </span><span style="color:#666">2</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">restartPolicy</span>:<span style="color:#bbb"> </span>Never<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>main<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>docker.io/library/bash:5<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">command</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"bash"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">args</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- -c<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- echo "Hello world! I'm going to exit with 42 to simulate a software bug." &amp;&amp; sleep 30 &amp;&amp; exit 42<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">backoffLimit</span>:<span style="color:#bbb"> </span><span style="color:#666">6</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">podFailurePolicy</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">rules</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">action</span>:<span style="color:#bbb"> </span>FailJob<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">onExitCodes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">containerName</span>:<span style="color:#bbb"> </span>main<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">operator</span>:<span style="color:#bbb"> </span>In<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">values</span>:<span style="color:#bbb"> </span>[<span style="color:#666">42</span>]<span style="color:#bbb">
</span></span></span></code></pre></div></div></div></li><li><p>Apply the manifest:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="display:flex"><span>kubectl create -f https://k8s.io/examples/controllers/job-pod-failure-policy-failjob.yaml
</span></span></code></pre></div></li><li><p>After around 30 seconds the entire Job should be terminated. Inspect the status of the Job by running:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="display:flex"><span>kubectl get <span style="color:#a2f">jobs</span> -l job-name<span style="color:#666">=</span>job-pod-failure-policy-failjob -o yaml
</span></span></code></pre></div><p>In the Job status, the following conditions display:</p><ul><li><code>FailureTarget</code> condition: has a <code>reason</code> field set to <code>PodFailurePolicy</code> and
a <code>message</code> field with more information about the termination, like
<code>Container main for pod default/job-pod-failure-policy-failjob-8ckj8 failed with exit code 42 matching FailJob rule at index 0</code>.
The Job controller adds this condition as soon as the Job is considered a failure.
For details, see <a href="/docs/concepts/workloads/controllers/job/#termination-of-job-pods">Termination of Job Pods</a>.</li><li><code>Failed</code> condition: same <code>reason</code> and <code>message</code> as the <code>FailureTarget</code>
condition. The Job controller adds this condition after all of the Job's Pods
are terminated.</li></ul><p>For comparison, if the Pod failure policy was disabled it would take 6 retries
of the Pod, taking at least 2 minutes.</p></li></ol><h4 id="clean-up">Clean up</h4><p>Delete the Job you created:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="display:flex"><span>kubectl delete jobs/job-pod-failure-policy-failjob
</span></span></code></pre></div><p>The cluster automatically cleans up the Pods.</p><h3 id="pod-failure-policy-ignore">Using Pod failure policy to ignore Pod disruptions</h3><p>With the following example, you can learn how to use Pod failure policy to
ignore Pod disruptions from incrementing the Pod retry counter towards the
<code>.spec.backoffLimit</code> limit.</p><div class="alert alert-caution" role="alert"><h4 class="alert-heading">Caution:</h4>Timing is important for this example, so you may want to read the steps before
execution. In order to trigger a Pod disruption it is important to drain the
node while the Pod is running on it (within 90s since the Pod is scheduled).</div><ol><li><p>Examine the following manifest:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples//controllers/job-pod-failure-policy-ignore.yaml" download="/controllers/job-pod-failure-policy-ignore.yaml"><code>/controllers/job-pod-failure-policy-ignore.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;controllers-job-pod-failure-policy-ignore-yaml&quot;)" title="Copy /controllers/job-pod-failure-policy-ignore.yaml to clipboard"/></div><div class="includecode" id="controllers-job-pod-failure-policy-ignore-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>batch/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Job<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>job-pod-failure-policy-ignore<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">completions</span>:<span style="color:#bbb"> </span><span style="color:#666">4</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">parallelism</span>:<span style="color:#bbb"> </span><span style="color:#666">2</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">restartPolicy</span>:<span style="color:#bbb"> </span>Never<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>main<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>docker.io/library/bash:5<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">command</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"bash"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">args</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- -c<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- echo "Hello world! I'm going to exit with 0 (success)." &amp;&amp; sleep 90 &amp;&amp; exit 0<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">backoffLimit</span>:<span style="color:#bbb"> </span><span style="color:#666">0</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">podFailurePolicy</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">rules</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">action</span>:<span style="color:#bbb"> </span>Ignore<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">onPodConditions</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>DisruptionTarget<span style="color:#bbb">
</span></span></span></code></pre></div></div></div></li><li><p>Apply the manifest:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="display:flex"><span>kubectl create -f https://k8s.io/examples/controllers/job-pod-failure-policy-ignore.yaml
</span></span></code></pre></div></li><li><p>Run this command to check the <code>nodeName</code> the Pod is scheduled to:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="display:flex"><span><span style="color:#b8860b">nodeName</span><span style="color:#666">=</span><span style="color:#a2f;font-weight:700">$(</span>kubectl get pods -l job-name<span style="color:#666">=</span>job-pod-failure-policy-ignore -o <span style="color:#b8860b">jsonpath</span><span style="color:#666">=</span><span style="color:#b44">'{.items[0].spec.nodeName}'</span><span style="color:#a2f;font-weight:700">)</span>
</span></span></code></pre></div></li><li><p>Drain the node to evict the Pod before it completes (within 90s):</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="display:flex"><span>kubectl drain nodes/<span style="color:#b8860b">$nodeName</span> --ignore-daemonsets --grace-period<span style="color:#666">=</span><span style="color:#666">0</span>
</span></span></code></pre></div></li><li><p>Inspect the <code>.status.failed</code> to check the counter for the Job is not incremented:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="display:flex"><span>kubectl get <span style="color:#a2f">jobs</span> -l job-name<span style="color:#666">=</span>job-pod-failure-policy-ignore -o yaml
</span></span></code></pre></div></li><li><p>Uncordon the node:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="display:flex"><span>kubectl uncordon nodes/<span style="color:#b8860b">$nodeName</span>
</span></span></code></pre></div></li></ol><p>The Job resumes and succeeds.</p><p>For comparison, if the Pod failure policy was disabled the Pod disruption would
result in terminating the entire Job (as the <code>.spec.backoffLimit</code> is set to 0).</p><h4 id="cleaning-up">Cleaning up</h4><p>Delete the Job you created:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="display:flex"><span>kubectl delete jobs/job-pod-failure-policy-ignore
</span></span></code></pre></div><p>The cluster automatically cleans up the Pods.</p><h3 id="pod-failure-policy-config-issue">Using Pod failure policy to avoid unnecessary Pod retries based on custom Pod Conditions</h3><p>With the following example, you can learn how to use Pod failure policy to
avoid unnecessary Pod restarts based on custom Pod Conditions.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>The example below works since version 1.27 as it relies on transitioning of
deleted pods, in the <code>Pending</code> phase, to a terminal phase
(see: <a href="/docs/concepts/workloads/pods/pod-lifecycle/#pod-phase">Pod Phase</a>).</div><ol><li><p>Examine the following manifest:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples//controllers/job-pod-failure-policy-config-issue.yaml" download="/controllers/job-pod-failure-policy-config-issue.yaml"><code>/controllers/job-pod-failure-policy-config-issue.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;controllers-job-pod-failure-policy-config-issue-yaml&quot;)" title="Copy /controllers/job-pod-failure-policy-config-issue.yaml to clipboard"/></div><div class="includecode" id="controllers-job-pod-failure-policy-config-issue-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>batch/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Job<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>job-pod-failure-policy-config-issue<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">completions</span>:<span style="color:#bbb"> </span><span style="color:#666">8</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">parallelism</span>:<span style="color:#bbb"> </span><span style="color:#666">2</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">restartPolicy</span>:<span style="color:#bbb"> </span>Never<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>main<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span><span style="color:#b44">"non-existing-repo/non-existing-image:example"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">backoffLimit</span>:<span style="color:#bbb"> </span><span style="color:#666">6</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">podFailurePolicy</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">rules</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">action</span>:<span style="color:#bbb"> </span>FailJob<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">onPodConditions</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>ConfigIssue<span style="color:#bbb">
</span></span></span></code></pre></div></div></div></li><li><p>Apply the manifest:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="display:flex"><span>kubectl create -f https://k8s.io/examples/controllers/job-pod-failure-policy-config-issue.yaml
</span></span></code></pre></div><p>Note that, the image is misconfigured, as it does not exist.</p></li><li><p>Inspect the status of the job's Pods by running:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="display:flex"><span>kubectl get pods -l job-name<span style="color:#666">=</span>job-pod-failure-policy-config-issue -o yaml
</span></span></code></pre></div><p>You will see output similar to this:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">containerStatuses</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>non-existing-repo/non-existing-image:example<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">   </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">   </span><span style="color:green;font-weight:700">state</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">   </span><span style="color:green;font-weight:700">waiting</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">message</span>:<span style="color:#bbb"> </span>Back-off pulling image "non-existing-repo/non-existing-image:example"<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">reason</span>:<span style="color:#bbb"> </span>ImagePullBackOff<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">phase</span>:<span style="color:#bbb"> </span>Pending<span style="color:#bbb">
</span></span></span></code></pre></div><p>Note that the pod remains in the <code>Pending</code> phase as it fails to pull the
misconfigured image. This, in principle, could be a transient issue and the
image could get pulled. However, in this case, the image does not exist so
we indicate this fact by a custom condition.</p></li><li><p>Add the custom condition. First prepare the patch by running:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF &gt; patch.yaml
</span></span></span><span style="display:flex"><span><span style="color:#b44">status:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  conditions:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  - type: ConfigIssue
</span></span></span><span style="display:flex"><span><span style="color:#b44">    status: "True"
</span></span></span><span style="display:flex"><span><span style="color:#b44">    reason: "NonExistingImage"
</span></span></span><span style="display:flex"><span><span style="color:#b44">    lastTransitionTime: "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span></code></pre></div><p>Second, select one of the pods created by the job by running:</p><pre tabindex="0"><code>podName=$(kubectl get pods -l job-name=job-pod-failure-policy-config-issue -o jsonpath='{.items[0].metadata.name}')
</code></pre><p>Then, apply the patch on one of the pods by running the following command:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="display:flex"><span>kubectl patch pod <span style="color:#b8860b">$podName</span> --subresource<span style="color:#666">=</span>status --patch-file<span style="color:#666">=</span>patch.yaml
</span></span></code></pre></div><p>If applied successfully, you will get a notification like this:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="display:flex"><span>pod/job-pod-failure-policy-config-issue-k6pvp patched
</span></span></code></pre></div></li><li><p>Delete the pod to transition it to <code>Failed</code> phase, by running the command:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="display:flex"><span>kubectl delete pods/<span style="color:#b8860b">$podName</span>
</span></span></code></pre></div></li><li><p>Inspect the status of the Job by running:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="display:flex"><span>kubectl get <span style="color:#a2f">jobs</span> -l job-name<span style="color:#666">=</span>job-pod-failure-policy-config-issue -o yaml
</span></span></code></pre></div><p>In the Job status, see a job <code>Failed</code> condition with the field <code>reason</code>
equal <code>PodFailurePolicy</code>. Additionally, the <code>message</code> field contains a
more detailed information about the Job termination, such as:
<code>Pod default/job-pod-failure-policy-config-issue-k6pvp has condition ConfigIssue matching FailJob rule at index 0</code>.</p></li></ol><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>In a production environment, the steps 3 and 4 should be automated by a
user-provided controller.</div><h4 id="cleaning-up-1">Cleaning up</h4><p>Delete the Job you created:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="display:flex"><span>kubectl delete jobs/job-pod-failure-policy-config-issue
</span></span></code></pre></div><p>The cluster automatically cleans up the Pods.</p><h3 id="backoff-limit-per-index-failindex">Using Pod Failure Policy to avoid unnecessary Pod retries per index</h3><p>To avoid unnecessary Pod restarts per index, you can use the <em>Pod failure policy</em> and
<em>backoff limit per index</em> features. This section of the page shows how to use these features
together.</p><ol><li><p>Examine the following manifest:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples//controllers/job-backoff-limit-per-index-failindex.yaml" download="/controllers/job-backoff-limit-per-index-failindex.yaml"><code>/controllers/job-backoff-limit-per-index-failindex.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;controllers-job-backoff-limit-per-index-failindex-yaml&quot;)" title="Copy /controllers/job-backoff-limit-per-index-failindex.yaml to clipboard"/></div><div class="includecode" id="controllers-job-backoff-limit-per-index-failindex-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>batch/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Job<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>job-backoff-limit-per-index-failindex<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">completions</span>:<span style="color:#bbb"> </span><span style="color:#666">4</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">parallelism</span>:<span style="color:#bbb"> </span><span style="color:#666">2</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">completionMode</span>:<span style="color:#bbb"> </span>Indexed<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">backoffLimitPerIndex</span>:<span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">restartPolicy</span>:<span style="color:#bbb"> </span>Never<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>main<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>docker.io/library/python:3<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">command</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:#080;font-style:italic"># The script:</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:#080;font-style:italic"># - fails the Pod with index 0 with exit code 1, which results in one retry;</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:#080;font-style:italic"># - fails the Pod with index 1 with exit code 42 which results</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:#080;font-style:italic">#   in failing the index without retry.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:#080;font-style:italic"># - succeeds Pods with any other index.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span>- python3<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span>- -c<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span>- |<span style="color:#b44;font-style:italic">
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">            import os, sys
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">            index = int(os.environ.get("JOB_COMPLETION_INDEX"))
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">            if index == 0:
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">              sys.exit(1)
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">            elif index == 1:
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">              sys.exit(42)
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">            else:
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">              sys.exit(0)</span><span style="color:#bbb">            
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">backoffLimit</span>:<span style="color:#bbb"> </span><span style="color:#666">6</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">podFailurePolicy</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">rules</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">action</span>:<span style="color:#bbb"> </span>FailIndex<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">onExitCodes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">containerName</span>:<span style="color:#bbb"> </span>main<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">operator</span>:<span style="color:#bbb"> </span>In<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">values</span>:<span style="color:#bbb"> </span>[<span style="color:#666">42</span>]<span style="color:#bbb">
</span></span></span></code></pre></div></div></div></li><li><p>Apply the manifest:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="display:flex"><span>kubectl create -f https://k8s.io/examples/controllers/job-backoff-limit-per-index-failindex.yaml
</span></span></code></pre></div></li><li><p>After around 15 seconds, inspect the status of the Pods for the Job. You can do that by running:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pods -l job-name<span style="color:#666">=</span>job-backoff-limit-per-index-failindex -o yaml
</span></span></code></pre></div><p>You will see output similar to this:</p><pre tabindex="0"><code class="language-none" data-lang="none">NAME                                            READY   STATUS      RESTARTS   AGE
job-backoff-limit-per-index-failindex-0-4g4cm   0/1     Error       0          4s
job-backoff-limit-per-index-failindex-0-fkdzq   0/1     Error       0          15s
job-backoff-limit-per-index-failindex-1-2bgdj   0/1     Error       0          15s
job-backoff-limit-per-index-failindex-2-vs6lt   0/1     Completed   0          11s
job-backoff-limit-per-index-failindex-3-s7s47   0/1     Completed   0          6s
</code></pre><p>Note that the output shows the following:</p><ul><li>Two Pods have index 0, because of the backoff limit allowed for one retry
of the index.</li><li>Only one Pod has index 1, because the exit code of the failed Pod matched
the Pod failure policy with the <code>FailIndex</code> action.</li></ul></li><li><p>Inspect the status of the Job by running:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="display:flex"><span>kubectl get <span style="color:#a2f">jobs</span> -l job-name<span style="color:#666">=</span>job-backoff-limit-per-index-failindex -o yaml
</span></span></code></pre></div><p>In the Job status, see that the <code>failedIndexes</code> field shows "0,1", because
both indexes failed. Because the index 1 was not retried the number of failed
Pods, indicated by the status field "failed" equals 3.</p></li></ol><h4 id="cleaning-up-2">Cleaning up</h4><p>Delete the Job you created:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="display:flex"><span>kubectl delete jobs/job-backoff-limit-per-index-failindex
</span></span></code></pre></div><p>The cluster automatically cleans up the Pods.</p><h2 id="alternatives">Alternatives</h2><p>You could rely solely on the
<a href="/docs/concepts/workloads/controllers/job/#pod-backoff-failure-policy">Pod backoff failure policy</a>,
by specifying the Job's <code>.spec.backoffLimit</code> field. However, in many situations
it is problematic to find a balance between setting a low value for <code>.spec.backoffLimit</code>
to avoid unnecessary Pod retries, yet high enough to make sure the Job would
not be terminated by Pod disruptions.</p></div>