<div class="td-content"><h1 data-pagefind-weight="10">Dynamic Admission Control</h1><p>In addition to <a href="/docs/reference/access-authn-authz/admission-controllers/">compiled-in admission plugins</a>,
admission plugins can be developed as extensions and run as webhooks configured at runtime.
This page describes how to build, configure, use, and monitor admission webhooks.</p><h2 id="what-are-admission-webhooks">What are admission webhooks?</h2><p>Admission webhooks are HTTP callbacks that receive admission requests and do
something with them. You can define two types of admission webhooks,
<a href="/docs/reference/access-authn-authz/admission-controllers/#validatingadmissionwebhook">validating admission webhook</a>
and
<a href="/docs/reference/access-authn-authz/admission-controllers/#mutatingadmissionwebhook">mutating admission webhook</a>.
Mutating admission webhooks are invoked first, and can modify objects sent to the API server to enforce custom defaults.
After all object modifications are complete, and after the incoming object is validated by the API server,
validating admission webhooks are invoked and can reject requests to enforce custom policies.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>Admission webhooks that need to guarantee they see the final state of the object in order to enforce policy
should use a validating admission webhook, since objects can be modified after being seen by mutating webhooks.</div><h2 id="experimenting-with-admission-webhooks">Experimenting with admission webhooks</h2><p>Admission webhooks are essentially part of the cluster control-plane. You should
write and deploy them with great caution. Please read the
<a href="/docs/reference/access-authn-authz/extensible-admission-controllers/#write-an-admission-webhook-server">user guides</a>
for instructions if you intend to write/deploy production-grade admission webhooks.
In the following, we describe how to quickly experiment with admission webhooks.</p><h3 id="prerequisites">Prerequisites</h3><ul><li><p>Ensure that MutatingAdmissionWebhook and ValidatingAdmissionWebhook
admission controllers are enabled.
<a href="/docs/reference/access-authn-authz/admission-controllers/#is-there-a-recommended-set-of-admission-controllers-to-use">Here</a>
is a recommended set of admission controllers to enable in general.</p></li><li><p>Ensure that the <code>admissionregistration.k8s.io/v1</code> API is enabled.</p></li></ul><h3 id="write-an-admission-webhook-server">Write an admission webhook server</h3><p>Please refer to the implementation of the <a href="https://github.com/kubernetes/kubernetes/blob/release-1.21/test/images/agnhost/webhook/main.go">admission webhook server</a>
that is validated in a Kubernetes e2e test. The webhook handles the
<code>AdmissionReview</code> request sent by the API servers, and sends back its decision
as an <code>AdmissionReview</code> object in the same version it received.</p><p>See the <a href="#request">webhook request</a> section for details on the data sent to webhooks.</p><p>See the <a href="#response">webhook response</a> section for the data expected from webhooks.</p><p>The example admission webhook server leaves the <code>ClientAuth</code> field
<a href="https://github.com/kubernetes/kubernetes/blob/v1.22.0/test/images/agnhost/webhook/config.go#L38-L39">empty</a>,
which defaults to <code>NoClientCert</code>. This means that the webhook server does not
authenticate the identity of the clients, supposedly API servers. If you need
mutual TLS or other ways to authenticate the clients, see
how to <a href="#authenticate-apiservers">authenticate API servers</a>.</p><h3 id="deploy-the-admission-webhook-service">Deploy the admission webhook service</h3><p>The webhook server in the e2e test is deployed in the Kubernetes cluster, via
the <a href="/docs/reference/generated/kubernetes-api/v1.34/#deployment-v1-apps">deployment API</a>.
The test also creates a <a href="/docs/reference/generated/kubernetes-api/v1.34/#service-v1-core">service</a>
as the front-end of the webhook server. See
<a href="https://github.com/kubernetes/kubernetes/blob/v1.22.0/test/e2e/apimachinery/webhook.go#L748">code</a>.</p><p>You may also deploy your webhooks outside of the cluster. You will need to update
your webhook configurations accordingly.</p><h3 id="configure-admission-webhooks-on-the-fly">Configure admission webhooks on the fly</h3><p>You can dynamically configure what resources are subject to what admission
webhooks via
<a href="/docs/reference/generated/kubernetes-api/v1.34/#validatingwebhookconfiguration-v1-admissionregistration-k8s-io">ValidatingWebhookConfiguration</a>
or
<a href="/docs/reference/generated/kubernetes-api/v1.34/#mutatingwebhookconfiguration-v1-admissionregistration-k8s-io">MutatingWebhookConfiguration</a>.</p><p>The following is an example <code>ValidatingWebhookConfiguration</code>, a mutating webhook configuration is similar.
See the <a href="#webhook-configuration">webhook configuration</a> section for details about each config field.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>admissionregistration.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ValidatingWebhookConfiguration<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span><span style="color:#b44">"pod-policy.example.com"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">webhooks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span><span style="color:#b44">"pod-policy.example.com"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">rules</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">apiGroups</span>:<span style="color:#bbb">   </span>[<span style="color:#b44">""</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">apiVersions</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"v1"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">operations</span>:<span style="color:#bbb">  </span>[<span style="color:#b44">"CREATE"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb">   </span>[<span style="color:#b44">"pods"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">scope</span>:<span style="color:#bbb">       </span><span style="color:#b44">"Namespaced"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">clientConfig</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">service</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span><span style="color:#b44">"example-namespace"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span><span style="color:#b44">"example-service"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">caBundle</span>:<span style="color:#bbb"> </span>&lt;CA_BUNDLE&gt;<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">admissionReviewVersions</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"v1"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">sideEffects</span>:<span style="color:#bbb"> </span>None<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">timeoutSeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">5</span><span style="color:#bbb">
</span></span></span></code></pre></div><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>You must replace the <code>&lt;CA_BUNDLE&gt;</code> in the above example by a valid CA bundle
which is a PEM-encoded (field value is Base64 encoded) CA bundle for validating the webhook's server certificate.</div><p>The <code>scope</code> field specifies if only cluster-scoped resources ("Cluster") or namespace-scoped
resources ("Namespaced") will match this rule. "âˆ—" means that there are no scope restrictions.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>When using <code>clientConfig.service</code>, the server cert must be valid for
<code>&lt;svc_name&gt;.&lt;svc_namespace&gt;.svc</code>.</div><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>Default timeout for a webhook call is 10 seconds,
You can set the <code>timeout</code> and it is encouraged to use a short timeout for webhooks.
If the webhook call times out, the request is handled according to the webhook's
failure policy.</div><p>When an API server receives a request that matches one of the <code>rules</code>, the
API server sends an <code>admissionReview</code> request to webhook as specified in the
<code>clientConfig</code>.</p><p>After you create the webhook configuration, the system will take a few seconds
to honor the new configuration.</p><h3 id="authenticate-apiservers">Authenticate API servers</h3><p>If your admission webhooks require authentication, you can configure the
API servers to use basic auth, bearer token, or a cert to authenticate itself to
the webhooks. There are three steps to complete the configuration.</p><ul><li><p>When starting the API server, specify the location of the admission control
configuration file via the <code>--admission-control-config-file</code> flag.</p></li><li><p>In the admission control configuration file, specify where the
MutatingAdmissionWebhook controller and ValidatingAdmissionWebhook controller
should read the credentials. The credentials are stored in kubeConfig files
(yes, the same schema that's used by kubectl), so the field name is
<code>kubeConfigFile</code>. Here is an example admission control configuration file:</p></li></ul><ul class="nav nav-tabs" id="admissionconfiguration-example1" role="tablist"><li class="nav-item"><a data-toggle="tab" class="nav-link active" href="#admissionconfiguration-example1-0" role="tab" aria-controls="admissionconfiguration-example1-0" aria-selected="true">apiserver.config.k8s.io/v1</a></li><li class="nav-item"><a data-toggle="tab" class="nav-link" href="#admissionconfiguration-example1-1" role="tab" aria-controls="admissionconfiguration-example1-1">apiserver.k8s.io/v1alpha1</a></li></ul><div class="tab-content" id="admissionconfiguration-example1"><div id="admissionconfiguration-example1-0" class="tab-pane show active" role="tabpanel" aria-labelledby="admissionconfiguration-example1-0"><p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiserver.config.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>AdmissionConfiguration<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">plugins</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>ValidatingAdmissionWebhook<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">configuration</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiserver.config.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>WebhookAdmissionConfiguration<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kubeConfigFile</span>:<span style="color:#bbb"> </span><span style="color:#b44">"&lt;path-to-kubeconfig-file&gt;"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>MutatingAdmissionWebhook<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">configuration</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiserver.config.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>WebhookAdmissionConfiguration<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kubeConfigFile</span>:<span style="color:#bbb"> </span><span style="color:#b44">"&lt;path-to-kubeconfig-file&gt;"</span><span style="color:#bbb">
</span></span></span></code></pre></div></p></div><div id="admissionconfiguration-example1-1" class="tab-pane" role="tabpanel" aria-labelledby="admissionconfiguration-example1-1"><p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Deprecated in v1.17 in favor of apiserver.config.k8s.io/v1</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiserver.k8s.io/v1alpha1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>AdmissionConfiguration<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">plugins</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>ValidatingAdmissionWebhook<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">configuration</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># Deprecated in v1.17 in favor of apiserver.config.k8s.io/v1, kind=WebhookAdmissionConfiguration</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiserver.config.k8s.io/v1alpha1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>WebhookAdmission<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kubeConfigFile</span>:<span style="color:#bbb"> </span><span style="color:#b44">"&lt;path-to-kubeconfig-file&gt;"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>MutatingAdmissionWebhook<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">configuration</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># Deprecated in v1.17 in favor of apiserver.config.k8s.io/v1, kind=WebhookAdmissionConfiguration</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apiserver.config.k8s.io/v1alpha1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>WebhookAdmission<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kubeConfigFile</span>:<span style="color:#bbb"> </span><span style="color:#b44">"&lt;path-to-kubeconfig-file&gt;"</span><span style="color:#bbb">
</span></span></span></code></pre></div></p></div></div><p>For more information about <code>AdmissionConfiguration</code>, see the
<a href="/docs/reference/config-api/apiserver-webhookadmission.v1/">AdmissionConfiguration (v1) reference</a>.
See the <a href="#webhook-configuration">webhook configuration</a> section for details about each config field.</p><p>In the kubeConfig file, provide the credentials:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Config<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">users</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># name should be set to the DNS name of the service or the host (including port) of the URL the webhook is configured to speak to.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># If a non-443 port is used for services, it must be included in the name when configuring 1.16+ API servers.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic">#</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># For a webhook configured to speak to a service on the default port (443), specify the DNS name of the service:</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># - name: webhook1.ns1.svc</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic">#   user: ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic">#</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># For a webhook configured to speak to a service on non-default port (e.g. 8443), specify the DNS name and port of the service in 1.16+:</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># - name: webhook1.ns1.svc:8443</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic">#   user: ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># and optionally create a second stanza using only the DNS name of the service for compatibility with 1.15 API servers:</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># - name: webhook1.ns1.svc</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic">#   user: ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic">#</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># For webhooks configured to speak to a URL, match the host (and port) specified in the webhook's URL. Examples:</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># A webhook with `url: https://www.example.com`:</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># - name: www.example.com</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic">#   user: ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic">#</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># A webhook with `url: https://www.example.com:443`:</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># - name: www.example.com:443</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic">#   user: ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic">#</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># A webhook with `url: https://www.example.com:8443`:</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># - name: www.example.com:8443</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic">#   user: ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic">#</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span><span style="color:#b44">'webhook1.ns1.svc'</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">user</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">client-certificate-data</span>:<span style="color:#bbb"> </span><span style="color:#b44">"&lt;pem encoded certificate&gt;"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">client-key-data</span>:<span style="color:#bbb"> </span><span style="color:#b44">"&lt;pem encoded key&gt;"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># The `name` supports using * to wildcard-match prefixing segments.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span><span style="color:#b44">'*.webhook-company.org'</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">user</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">password</span>:<span style="color:#bbb"> </span><span style="color:#b44">"&lt;password&gt;"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">username</span>:<span style="color:#bbb"> </span><span style="color:#b44">"&lt;name&gt;"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># '*' is the default match.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span><span style="color:#b44">'*'</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">user</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">token</span>:<span style="color:#bbb"> </span><span style="color:#b44">"&lt;token&gt;"</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>Of course you need to set up the webhook server to handle these authentication requests.</p><h2 id="webhook-request-and-response">Webhook request and response</h2><h3 id="request">Request</h3><p>Webhooks are sent as POST requests, with <code>Content-Type: application/json</code>,
with an <code>AdmissionReview</code> API object in the <code>admission.k8s.io</code> API group
serialized to JSON as the body.</p><p>Webhooks can specify what versions of <code>AdmissionReview</code> objects they accept
with the <code>admissionReviewVersions</code> field in their configuration:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>admissionregistration.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ValidatingWebhookConfiguration<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">webhooks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-webhook.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">admissionReviewVersions</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"v1"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"v1beta1"</span>]<span style="color:#bbb">
</span></span></span></code></pre></div><p><code>admissionReviewVersions</code> is a required field when creating webhook configurations.
Webhooks are required to support at least one <code>AdmissionReview</code>
version understood by the current and previous API server.</p><p>API servers send the first <code>AdmissionReview</code> version in the <code>admissionReviewVersions</code> list they support.
If none of the versions in the list are supported by the API server, the configuration will not be allowed to be created.
If an API server encounters a webhook configuration that was previously created and does not support any of the <code>AdmissionReview</code>
versions the API server knows how to send, attempts to call to the webhook will fail and be subject to the <a href="#failure-policy">failure policy</a>.</p><p>This example shows the data contained in an <code>AdmissionReview</code> object
for a request to update the <code>scale</code> subresource of an <code>apps/v1</code> <code>Deployment</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">"apiVersion": </span><span style="color:#b44">"admission.k8s.io/v1"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">"kind": </span><span style="color:#b44">"AdmissionReview"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">"request": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># Random uid uniquely identifying this admission call</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"uid": </span><span style="color:#b44">"705ab4f5-6393-11e8-b7cc-42010a800002"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># Fully-qualified group/version/kind of the incoming object</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"kind": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"group": </span><span style="color:#b44">"autoscaling"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"version": </span><span style="color:#b44">"v1"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"kind": </span><span style="color:#b44">"Scale"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># Fully-qualified group/version/kind of the resource being modified</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"resource": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"group": </span><span style="color:#b44">"apps"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"version": </span><span style="color:#b44">"v1"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"resource": </span><span style="color:#b44">"deployments"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># Subresource, if the request is to a subresource</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"subResource": </span><span style="color:#b44">"scale"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># Fully-qualified group/version/kind of the incoming object in the original request to the API server</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># This only differs from `kind` if the webhook specified `matchPolicy: Equivalent` and the original</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># request to the API server was converted to a version the webhook registered for</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"requestKind": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"group": </span><span style="color:#b44">"autoscaling"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"version": </span><span style="color:#b44">"v1"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"kind": </span><span style="color:#b44">"Scale"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># Fully-qualified group/version/kind of the resource being modified in the original request to the API server</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># This only differs from `resource` if the webhook specified `matchPolicy: Equivalent` and the original</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># request to the API server was converted to a version the webhook registered for</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"requestResource": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"group": </span><span style="color:#b44">"apps"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"version": </span><span style="color:#b44">"v1"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"resource": </span><span style="color:#b44">"deployments"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># Subresource, if the request is to a subresource</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># This only differs from `subResource` if the webhook specified `matchPolicy: Equivalent` and the original</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># request to the API server was converted to a version the webhook registered for</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"requestSubResource": </span><span style="color:#b44">"scale"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># Name of the resource being modified</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"name": </span><span style="color:#b44">"my-deployment"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># Namespace of the resource being modified, if the resource is namespaced (or is a Namespace object)</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"namespace": </span><span style="color:#b44">"my-namespace"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># operation can be CREATE, UPDATE, DELETE, or CONNECT</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"operation": </span><span style="color:#b44">"UPDATE"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"userInfo": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># Username of the authenticated user making the request to the API server</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"username": </span><span style="color:#b44">"admin"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># UID of the authenticated user making the request to the API server</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"uid": </span><span style="color:#b44">"014fbff9a07c"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># Group memberships of the authenticated user making the request to the API server</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"groups": </span>[<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:#b44">"system:authenticated"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:#b44">"my-admin-group"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>],<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># Arbitrary extra info associated with the user making the request to the API server</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:#080;font-style:italic"># This is populated by the API server authentication layer</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"extra": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"some-key": </span>[<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:#b44">"some-value1"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:#b44">"some-value2"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># object is the new object being admitted. It is null for DELETE operations</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"object": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"apiVersion": </span><span style="color:#b44">"autoscaling/v1"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"kind": </span><span style="color:#b44">"Scale"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># oldObject is the existing object. It is null for CREATE and CONNECT operations</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"oldObject": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"apiVersion": </span><span style="color:#b44">"autoscaling/v1"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"kind": </span><span style="color:#b44">"Scale"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># options contain the options for the operation being admitted, like meta.k8s.io/v1 CreateOptions,</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># UpdateOptions, or DeleteOptions. It is null for CONNECT operations</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"options": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"apiVersion": </span><span style="color:#b44">"meta.k8s.io/v1"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"kind": </span><span style="color:#b44">"UpdateOptions"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># dryRun indicates the API request is running in dry run mode and will not be persisted</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># Webhooks with side effects should avoid actuating those side effects when dryRun is true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"dryRun": </span><span style="color:#a2f;font-weight:700">false</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>}<span style="color:#bbb">
</span></span></span></code></pre></div><h3 id="response">Response</h3><p>Webhooks respond with a 200 HTTP status code, <code>Content-Type: application/json</code>,
and a body containing an <code>AdmissionReview</code> object (in the same version they were sent),
with the <code>response</code> stanza populated, serialized to JSON.</p><p>At a minimum, the <code>response</code> stanza must contain the following fields:</p><ul><li><code>uid</code>, copied from the <code>request.uid</code> sent to the webhook</li><li><code>allowed</code>, either set to <code>true</code> or <code>false</code></li></ul><p>Example of a minimal response from a webhook to allow a request:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="display:flex"><span>{
</span></span><span style="display:flex"><span>  <span style="color:green;font-weight:700">"apiVersion"</span>: <span style="color:#b44">"admission.k8s.io/v1"</span>,
</span></span><span style="display:flex"><span>  <span style="color:green;font-weight:700">"kind"</span>: <span style="color:#b44">"AdmissionReview"</span>,
</span></span><span style="display:flex"><span>  <span style="color:green;font-weight:700">"response"</span>: {
</span></span><span style="display:flex"><span>    <span style="color:green;font-weight:700">"uid"</span>: <span style="color:#b44">"&lt;value from request.uid&gt;"</span>,
</span></span><span style="display:flex"><span>    <span style="color:green;font-weight:700">"allowed"</span>: <span style="color:#a2f;font-weight:700">true</span>
</span></span><span style="display:flex"><span>  }
</span></span><span style="display:flex"><span>}
</span></span></code></pre></div><p>Example of a minimal response from a webhook to forbid a request:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="display:flex"><span>{
</span></span><span style="display:flex"><span>  <span style="color:green;font-weight:700">"apiVersion"</span>: <span style="color:#b44">"admission.k8s.io/v1"</span>,
</span></span><span style="display:flex"><span>  <span style="color:green;font-weight:700">"kind"</span>: <span style="color:#b44">"AdmissionReview"</span>,
</span></span><span style="display:flex"><span>  <span style="color:green;font-weight:700">"response"</span>: {
</span></span><span style="display:flex"><span>    <span style="color:green;font-weight:700">"uid"</span>: <span style="color:#b44">"&lt;value from request.uid&gt;"</span>,
</span></span><span style="display:flex"><span>    <span style="color:green;font-weight:700">"allowed"</span>: <span style="color:#a2f;font-weight:700">false</span>
</span></span><span style="display:flex"><span>  }
</span></span><span style="display:flex"><span>}
</span></span></code></pre></div><p>When rejecting a request, the webhook can customize the http code and message returned to the user
using the <code>status</code> field. The specified status object is returned to the user.
See the <a href="/docs/reference/generated/kubernetes-api/v1.34/#status-v1-meta">API documentation</a>
for details about the <code>status</code> type.
Example of a response to forbid a request, customizing the HTTP status code and message presented to the user:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="display:flex"><span>{
</span></span><span style="display:flex"><span>  <span style="color:green;font-weight:700">"apiVersion"</span>: <span style="color:#b44">"admission.k8s.io/v1"</span>,
</span></span><span style="display:flex"><span>  <span style="color:green;font-weight:700">"kind"</span>: <span style="color:#b44">"AdmissionReview"</span>,
</span></span><span style="display:flex"><span>  <span style="color:green;font-weight:700">"response"</span>: {
</span></span><span style="display:flex"><span>    <span style="color:green;font-weight:700">"uid"</span>: <span style="color:#b44">"&lt;value from request.uid&gt;"</span>,
</span></span><span style="display:flex"><span>    <span style="color:green;font-weight:700">"allowed"</span>: <span style="color:#a2f;font-weight:700">false</span>,
</span></span><span style="display:flex"><span>    <span style="color:green;font-weight:700">"status"</span>: {
</span></span><span style="display:flex"><span>      <span style="color:green;font-weight:700">"code"</span>: <span style="color:#666">403</span>,
</span></span><span style="display:flex"><span>      <span style="color:green;font-weight:700">"message"</span>: <span style="color:#b44">"You cannot do this because it is Tuesday and your name starts with A"</span>
</span></span><span style="display:flex"><span>    }
</span></span><span style="display:flex"><span>  }
</span></span><span style="display:flex"><span>}
</span></span></code></pre></div><p>When allowing a request, a mutating admission webhook may optionally modify the incoming object as well.
This is done using the <code>patch</code> and <code>patchType</code> fields in the response.
The only currently supported <code>patchType</code> is <code>JSONPatch</code>.
See <a href="https://jsonpatch.com/">JSON patch</a> documentation for more details.
For <code>patchType: JSONPatch</code>, the <code>patch</code> field contains a base64-encoded array of JSON patch operations.</p><p>As an example, a single patch operation that would set <code>spec.replicas</code> would be
<code>[{"op": "add", "path": "/spec/replicas", "value": 3}]</code></p><p>Base64-encoded, this would be <code>W3sib3AiOiAiYWRkIiwgInBhdGgiOiAiL3NwZWMvcmVwbGljYXMiLCAidmFsdWUiOiAzfV0=</code></p><p>So a webhook response to add that label would be:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="display:flex"><span>{
</span></span><span style="display:flex"><span>  <span style="color:green;font-weight:700">"apiVersion"</span>: <span style="color:#b44">"admission.k8s.io/v1"</span>,
</span></span><span style="display:flex"><span>  <span style="color:green;font-weight:700">"kind"</span>: <span style="color:#b44">"AdmissionReview"</span>,
</span></span><span style="display:flex"><span>  <span style="color:green;font-weight:700">"response"</span>: {
</span></span><span style="display:flex"><span>    <span style="color:green;font-weight:700">"uid"</span>: <span style="color:#b44">"&lt;value from request.uid&gt;"</span>,
</span></span><span style="display:flex"><span>    <span style="color:green;font-weight:700">"allowed"</span>: <span style="color:#a2f;font-weight:700">true</span>,
</span></span><span style="display:flex"><span>    <span style="color:green;font-weight:700">"patchType"</span>: <span style="color:#b44">"JSONPatch"</span>,
</span></span><span style="display:flex"><span>    <span style="color:green;font-weight:700">"patch"</span>: <span style="color:#b44">"W3sib3AiOiAiYWRkIiwgInBhdGgiOiAiL3NwZWMvcmVwbGljYXMiLCAidmFsdWUiOiAzfV0="</span>
</span></span><span style="display:flex"><span>  }
</span></span><span style="display:flex"><span>}
</span></span></code></pre></div><p>Admission webhooks can optionally return warning messages that are returned to the requesting client
in HTTP <code>Warning</code> headers with a warning code of 299. Warnings can be sent with allowed or rejected admission responses.</p><p>If you're implementing a webhook that returns a warning:</p><ul><li>Don't include a "Warning:" prefix in the message</li><li>Use warning messages to describe problems the client making the API request should correct or be aware of</li><li>Limit warnings to 120 characters if possible</li></ul><div class="alert alert-caution" role="alert"><h4 class="alert-heading">Caution:</h4>Individual warning messages over 256 characters may be truncated by the API server before being returned to clients.
If more than 4096 characters of warning messages are added (from all sources), additional warning messages are ignored.</div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="display:flex"><span>{
</span></span><span style="display:flex"><span>  <span style="color:green;font-weight:700">"apiVersion"</span>: <span style="color:#b44">"admission.k8s.io/v1"</span>,
</span></span><span style="display:flex"><span>  <span style="color:green;font-weight:700">"kind"</span>: <span style="color:#b44">"AdmissionReview"</span>,
</span></span><span style="display:flex"><span>  <span style="color:green;font-weight:700">"response"</span>: {
</span></span><span style="display:flex"><span>    <span style="color:green;font-weight:700">"uid"</span>: <span style="color:#b44">"&lt;value from request.uid&gt;"</span>,
</span></span><span style="display:flex"><span>    <span style="color:green;font-weight:700">"allowed"</span>: <span style="color:#a2f;font-weight:700">true</span>,
</span></span><span style="display:flex"><span>    <span style="color:green;font-weight:700">"warnings"</span>: [
</span></span><span style="display:flex"><span>      <span style="color:#b44">"duplicate envvar entries specified with name MY_ENV"</span>,
</span></span><span style="display:flex"><span>      <span style="color:#b44">"memory request less than 4MB specified for container mycontainer, which will not start successfully"</span>
</span></span><span style="display:flex"><span>    ]
</span></span><span style="display:flex"><span>  }
</span></span><span style="display:flex"><span>}
</span></span></code></pre></div><h2 id="webhook-configuration">Webhook configuration</h2><p>To register admission webhooks, create <code>MutatingWebhookConfiguration</code> or <code>ValidatingWebhookConfiguration</code> API objects.
The name of a <code>MutatingWebhookConfiguration</code> or a <code>ValidatingWebhookConfiguration</code> object must be a valid
<a href="/docs/concepts/overview/working-with-objects/names/#dns-subdomain-names">DNS subdomain name</a>.</p><p>Each configuration can contain one or more webhooks.
If multiple webhooks are specified in a single configuration, each must be given a unique name.
This is required in order to make resulting audit logs and metrics easier to match up to active
configurations.</p><p>Each webhook defines the following things.</p><h3 id="matching-requests-rules">Matching requests: rules</h3><p>Each webhook must specify a list of rules used to determine if a request to the API server should be sent to the webhook.
Each rule specifies one or more operations, apiGroups, apiVersions, and resources, and a resource scope:</p><ul><li><p><code>operations</code> lists one or more operations to match. Can be <code>"CREATE"</code>, <code>"UPDATE"</code>, <code>"DELETE"</code>, <code>"CONNECT"</code>,
or <code>"*"</code> to match all.</p></li><li><p><code>apiGroups</code> lists one or more API groups to match. <code>""</code> is the core API group. <code>"*"</code> matches all API groups.</p></li><li><p><code>apiVersions</code> lists one or more API versions to match. <code>"*"</code> matches all API versions.</p></li><li><p><code>resources</code> lists one or more resources to match.</p><ul><li><code>"*"</code> matches all resources, but not subresources.</li><li><code>"*/*"</code> matches all resources and subresources.</li><li><code>"pods/*"</code> matches all subresources of pods.</li><li><code>"*/status"</code> matches all status subresources.</li></ul></li><li><p><code>scope</code> specifies a scope to match. Valid values are <code>"Cluster"</code>, <code>"Namespaced"</code>, and <code>"*"</code>.
Subresources match the scope of their parent resource. Default is <code>"*"</code>.</p><ul><li><code>"Cluster"</code> means that only cluster-scoped resources will match this rule (Namespace API objects are cluster-scoped).</li><li><code>"Namespaced"</code> means that only namespaced resources will match this rule.</li><li><code>"*"</code> means that there are no scope restrictions.</li></ul></li></ul><p>If an incoming request matches one of the specified <code>operations</code>, <code>groups</code>, <code>versions</code>,
<code>resources</code>, and <code>scope</code> for any of a webhook's <code>rules</code>, the request is sent to the webhook.</p><p>Here are other examples of rules that could be used to specify which resources should be intercepted.</p><p>Match <code>CREATE</code> or <code>UPDATE</code> requests to <code>apps/v1</code> and <code>apps/v1beta1</code> <code>deployments</code> and <code>replicasets</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>admissionregistration.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ValidatingWebhookConfiguration<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#00f;font-weight:700">...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">webhooks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-webhook.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">rules</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">operations</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"CREATE"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"UPDATE"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">apiGroups</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"apps"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">apiVersions</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"v1"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"v1beta1"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"deployments"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"replicasets"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">scope</span>:<span style="color:#bbb"> </span><span style="color:#b44">"Namespaced"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>...<span style="color:#bbb">
</span></span></span></code></pre></div><p>Match create requests for all resources (but not subresources) in all API groups and versions:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>admissionregistration.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ValidatingWebhookConfiguration<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">webhooks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-webhook.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">rules</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">operations</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"CREATE"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">apiGroups</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"*"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">apiVersions</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"*"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"*"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">scope</span>:<span style="color:#bbb"> </span><span style="color:#b44">"*"</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>Match update requests for all <code>status</code> subresources in all API groups and versions:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>admissionregistration.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ValidatingWebhookConfiguration<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">webhooks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-webhook.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">rules</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">operations</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"UPDATE"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">apiGroups</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"*"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">apiVersions</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"*"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"*/status"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">scope</span>:<span style="color:#bbb"> </span><span style="color:#b44">"*"</span><span style="color:#bbb">
</span></span></span></code></pre></div><h3 id="matching-requests-objectselector">Matching requests: objectSelector</h3><p>Webhooks may optionally limit which requests are intercepted based on the labels of the
objects they would be sent, by specifying an <code>objectSelector</code>. If specified, the objectSelector
is evaluated against both the object and oldObject that would be sent to the webhook,
and is considered to match if either object matches the selector.</p><p>A null object (<code>oldObject</code> in the case of create, or <code>newObject</code> in the case of delete),
or an object that cannot have labels (like a <code>DeploymentRollback</code> or a <code>PodProxyOptions</code> object)
is not considered to match.</p><p>Use the object selector only if the webhook is opt-in, because end users may skip
the admission webhook by setting the labels.</p><p>This example shows a mutating webhook that would match a <code>CREATE</code> of any resource (but not subresources) with the label <code>foo: bar</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>admissionregistration.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>MutatingWebhookConfiguration<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">webhooks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-webhook.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">objectSelector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">foo</span>:<span style="color:#bbb"> </span>bar<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">rules</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">operations</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"CREATE"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">apiGroups</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"*"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">apiVersions</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"*"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"*"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">scope</span>:<span style="color:#bbb"> </span><span style="color:#b44">"*"</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>See <a href="/docs/concepts/overview/working-with-objects/labels/">labels concept</a>
for more examples of label selectors.</p><h3 id="matching-requests-namespaceselector">Matching requests: namespaceSelector</h3><p>Webhooks may optionally limit which requests for namespaced resources are intercepted,
based on the labels of the containing namespace, by specifying a <code>namespaceSelector</code>.</p><p>The <code>namespaceSelector</code> decides whether to run the webhook on a request for a namespaced resource
(or a Namespace object), based on whether the namespace's labels match the selector.
If the object itself is a namespace, the matching is performed on object.metadata.labels.
If the object is a cluster scoped resource other than a Namespace, <code>namespaceSelector</code> has no effect.</p><p>This example shows a mutating webhook that matches a <code>CREATE</code> of any namespaced resource inside a namespace
that does not have a "runlevel" label of "0" or "1":</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>admissionregistration.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>MutatingWebhookConfiguration<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">webhooks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-webhook.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">namespaceSelector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">matchExpressions</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">key</span>:<span style="color:#bbb"> </span>runlevel<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">operator</span>:<span style="color:#bbb"> </span>NotIn<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">values</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"0"</span>,<span style="color:#b44">"1"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">rules</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">operations</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"CREATE"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">apiGroups</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"*"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">apiVersions</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"*"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"*"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">scope</span>:<span style="color:#bbb"> </span><span style="color:#b44">"Namespaced"</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>This example shows a validating webhook that matches a <code>CREATE</code> of any namespaced resource inside
a namespace that is associated with the "environment" of "prod" or "staging":</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>admissionregistration.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ValidatingWebhookConfiguration<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">webhooks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-webhook.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">namespaceSelector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">matchExpressions</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">key</span>:<span style="color:#bbb"> </span>environment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">operator</span>:<span style="color:#bbb"> </span>In<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">values</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"prod"</span>,<span style="color:#b44">"staging"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">rules</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">operations</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"CREATE"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">apiGroups</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"*"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">apiVersions</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"*"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"*"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">scope</span>:<span style="color:#bbb"> </span><span style="color:#b44">"Namespaced"</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>See <a href="/docs/concepts/overview/working-with-objects/labels/">labels concept</a>
for more examples of label selectors.</p><h3 id="matching-requests-matchpolicy">Matching requests: matchPolicy</h3><p>API servers can make objects available via multiple API groups or versions.</p><p>For example, if a webhook only specified a rule for some API groups/versions
(like <code>apiGroups:["apps"], apiVersions:["v1","v1beta1"]</code>),
and a request was made to modify the resource via another API group/version (like <code>extensions/v1beta1</code>),
the request would not be sent to the webhook.</p><p>The <code>matchPolicy</code> lets a webhook define how its <code>rules</code> are used to match incoming requests.
Allowed values are <code>Exact</code> or <code>Equivalent</code>.</p><ul><li><code>Exact</code> means a request should be intercepted only if it exactly matches a specified rule.</li><li><code>Equivalent</code> means a request should be intercepted if it modifies a resource listed in <code>rules</code>,
even via another API group or version.</li></ul><p>In the example given above, the webhook that only registered for <code>apps/v1</code> could use <code>matchPolicy</code>:</p><ul><li><code>matchPolicy: Exact</code> would mean the <code>extensions/v1beta1</code> request would not be sent to the webhook</li><li><code>matchPolicy: Equivalent</code> means the <code>extensions/v1beta1</code> request would be sent to the webhook
(with the objects converted to a version the webhook had specified: <code>apps/v1</code>)</li></ul><p>Specifying <code>Equivalent</code> is recommended, and ensures that webhooks continue to intercept the
resources they expect when upgrades enable new versions of the resource in the API server.</p><p>When a resource stops being served by the API server, it is no longer considered equivalent to
other versions of that resource that are still served.
For example, <code>extensions/v1beta1</code> deployments were first deprecated and then removed (in Kubernetes v1.16).</p><p>Since that removal, a webhook with a <code>apiGroups:["extensions"], apiVersions:["v1beta1"], resources:["deployments"]</code> rule
does not intercept deployments created via <code>apps/v1</code> APIs. For that reason, webhooks should prefer registering
for stable versions of resources.</p><p>This example shows a validating webhook that intercepts modifications to deployments (no matter the API group or version),
and is always sent an <code>apps/v1</code> <code>Deployment</code> object:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>admissionregistration.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ValidatingWebhookConfiguration<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">webhooks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-webhook.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">matchPolicy</span>:<span style="color:#bbb"> </span>Equivalent<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">rules</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">operations</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"CREATE"</span>,<span style="color:#b44">"UPDATE"</span>,<span style="color:#b44">"DELETE"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">apiGroups</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"apps"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">apiVersions</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"v1"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"deployments"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">scope</span>:<span style="color:#bbb"> </span><span style="color:#b44">"Namespaced"</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>The <code>matchPolicy</code> for an admission webhooks defaults to <code>Equivalent</code>.</p><h3 id="matching-requests-matchconditions">Matching requests: <code>matchConditions</code></h3><div class="feature-state-notice feature-stable" title="Feature Gate: AdmissionWebhookMatchConditions"><span class="feature-state-name">FEATURE STATE:</span>
<code>Kubernetes v1.30 [stable]</code> (enabled by default: true)</div><p>You can define <em>match conditions</em> for webhooks if you need fine-grained request filtering. These
conditions are useful if you find that match rules, <code>objectSelectors</code> and <code>namespaceSelectors</code> still
doesn't provide the filtering you want over when to call out over HTTP. Match conditions are
<a href="/docs/reference/using-api/cel/">CEL expressions</a>. All match conditions must evaluate to true for the
webhook to be called.</p><p>Here is an example illustrating a few different uses for match conditions:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>admissionregistration.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ValidatingWebhookConfiguration<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">webhooks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-webhook.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchPolicy</span>:<span style="color:#bbb"> </span>Equivalent<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">rules</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">operations</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">'CREATE'</span>,<span style="color:#b44">'UPDATE'</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">apiGroups</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">'*'</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">apiVersions</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">'*'</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">'*'</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">failurePolicy</span>:<span style="color:#bbb"> </span><span style="color:#b44">'Ignore'</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># Fail-open (optional)</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">sideEffects</span>:<span style="color:#bbb"> </span>None<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">clientConfig</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">service</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>my-namespace<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-webhook<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">caBundle</span>:<span style="color:#bbb"> </span><span style="color:#b44">'&lt;omitted&gt;'</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># You can have up to 64 matchConditions per webhook</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchConditions</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span><span style="color:#b44">'exclude-leases'</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># Each match condition must have a unique name</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">expression</span>:<span style="color:#bbb"> </span><span style="color:#b44">'!(request.resource.group == "coordination.k8s.io" &amp;&amp; request.resource.resource == "leases")'</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># Match non-lease resources.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span><span style="color:#b44">'exclude-kubelet-requests'</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">expression</span>:<span style="color:#bbb"> </span><span style="color:#b44">'!("system:nodes" in request.userInfo.groups)'</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># Match requests made by non-node users.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span><span style="color:#b44">'rbac'</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># Skip RBAC requests, which are handled by the second webhook.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">expression</span>:<span style="color:#bbb"> </span><span style="color:#b44">'request.resource.group != "rbac.authorization.k8s.io"'</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># This example illustrates the use of the 'authorizer'. The authorization check is more expensive</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># than a simple expression, so in this example it is scoped to only RBAC requests by using a second</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># webhook. Both webhooks can be served by the same endpoint.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>rbac.my-webhook.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchPolicy</span>:<span style="color:#bbb"> </span>Equivalent<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">rules</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">operations</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">'CREATE'</span>,<span style="color:#b44">'UPDATE'</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">apiGroups</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">'rbac.authorization.k8s.io'</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">apiVersions</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">'*'</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">'*'</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">failurePolicy</span>:<span style="color:#bbb"> </span><span style="color:#b44">'Fail'</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># Fail-closed (the default)</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">sideEffects</span>:<span style="color:#bbb"> </span>None<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">clientConfig</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">service</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>my-namespace<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-webhook<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">caBundle</span>:<span style="color:#bbb"> </span><span style="color:#b44">'&lt;omitted&gt;'</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># You can have up to 64 matchConditions per webhook</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchConditions</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span><span style="color:#b44">'breakglass'</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic"># Skip requests made by users authorized to 'breakglass' on this webhook.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic"># The 'breakglass' API verb does not need to exist outside this check.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">expression</span>:<span style="color:#bbb"> </span><span style="color:#b44">'!authorizer.group("admissionregistration.k8s.io").resource("validatingwebhookconfigurations").name("my-webhook.example.com").check("breakglass").allowed()'</span><span style="color:#bbb">
</span></span></span></code></pre></div><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>You can define up to 64 elements in the <code>matchConditions</code> field per webhook.</div><p>Match conditions have access to the following CEL variables:</p><ul><li><code>object</code> - The object from the incoming request. The value is null for DELETE requests. The object
version may be converted based on the <a href="#matching-requests-matchpolicy">matchPolicy</a>.</li><li><code>oldObject</code> - The existing object. The value is null for CREATE requests.</li><li><code>request</code> - The request portion of the <a href="#request">AdmissionReview</a>, excluding <code>object</code> and <code>oldObject</code>.</li><li><code>authorizer</code> - A CEL Authorizer. May be used to perform authorization checks for the principal
(authenticated user) of the request. See
<a href="https://pkg.go.dev/k8s.io/apiserver/pkg/cel/library#Authz">Authz</a> in the Kubernetes CEL library
documentation for more details.</li><li><code>authorizer.requestResource</code> - A shortcut for an authorization check configured with the request
resource (group, resource, (subresource), namespace, name).</li></ul><p>For more information on CEL expressions, refer to the
<a href="/docs/reference/using-api/cel/">Common Expression Language in Kubernetes reference</a>.</p><p>In the event of an error evaluating a match condition the webhook is never called. Whether to reject
the request is determined as follows:</p><ol><li>If <strong>any</strong> match condition evaluated to <code>false</code> (regardless of other errors), the API server skips the webhook.</li><li>Otherwise:<ul><li>for <a href="#failure-policy"><code>failurePolicy: Fail</code></a>, reject the request (without calling the webhook).</li><li>for <a href="#failure-policy"><code>failurePolicy: Ignore</code></a>, proceed with the request but skip the webhook.</li></ul></li></ol><h3 id="contacting-the-webhook">Contacting the webhook</h3><p>Once the API server has determined a request should be sent to a webhook,
it needs to know how to contact the webhook. This is specified in the <code>clientConfig</code>
stanza of the webhook configuration.</p><p>Webhooks can either be called via a URL or a service reference,
and can optionally include a custom CA bundle to use to verify the TLS connection.</p><h4 id="url">URL</h4><p><code>url</code> gives the location of the webhook, in standard URL form
(<code>scheme://host:port/path</code>).</p><p>The <code>host</code> should not refer to a service running in the cluster; use
a service reference by specifying the <code>service</code> field instead.
The host might be resolved via external DNS in some API servers
(e.g., <code>kube-apiserver</code> cannot resolve in-cluster DNS as that would
be a layering violation). <code>host</code> may also be an IP address.</p><p>Please note that using <code>localhost</code> or <code>127.0.0.1</code> as a <code>host</code> is
risky unless you take great care to run this webhook on all hosts
which run an API server which might need to make calls to this
webhook. Such installations are likely to be non-portable or not readily
run in a new cluster.</p><p>The scheme must be "https"; the URL must begin with "https://".</p><p>Attempting to use a user or basic auth (for example <code>user:password@</code>) is not allowed.
Fragments (<code>#...</code>) and query parameters (<code>?...</code>) are also not allowed.</p><p>Here is an example of a mutating webhook configured to call a URL
(and expects the TLS certificate to be verified using system trust roots, so does not specify a caBundle):</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>admissionregistration.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>MutatingWebhookConfiguration<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">webhooks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-webhook.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">clientConfig</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">url</span>:<span style="color:#bbb"> </span><span style="color:#b44">"https://my-webhook.example.com:9443/my-webhook-path"</span><span style="color:#bbb">
</span></span></span></code></pre></div><h4 id="service-reference">Service reference</h4><p>The <code>service</code> stanza inside <code>clientConfig</code> is a reference to the service for this webhook.
If the webhook is running within the cluster, then you should use <code>service</code> instead of <code>url</code>.
The service namespace and name are required. The port is optional and defaults to 443.
The path is optional and defaults to "/".</p><p>Here is an example of a mutating webhook configured to call a service on port "1234"
at the subpath "/my-path", and to verify the TLS connection against the ServerName
<code>my-service-name.my-service-namespace.svc</code> using a custom CA bundle:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>admissionregistration.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>MutatingWebhookConfiguration<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">webhooks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-webhook.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">clientConfig</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">caBundle</span>:<span style="color:#bbb"> </span>&lt;CA_BUNDLE&gt;<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">service</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>my-service-namespace<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-service-name<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">path</span>:<span style="color:#bbb"> </span>/my-path<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">port</span>:<span style="color:#bbb"> </span><span style="color:#666">1234</span><span style="color:#bbb">
</span></span></span></code></pre></div><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>You must replace the <code>&lt;CA_BUNDLE&gt;</code> in the above example by a valid CA bundle
which is a PEM-encoded CA bundle for validating the webhook's server certificate.</div><h3 id="side-effects">Side effects</h3><p>Webhooks typically operate only on the content of the <code>AdmissionReview</code> sent to them.
Some webhooks, however, make out-of-band changes as part of processing admission requests.</p><p>Webhooks that make out-of-band changes ("side effects") must also have a reconciliation mechanism
(like a controller) that periodically determines the actual state of the world, and adjusts
the out-of-band data modified by the admission webhook to reflect reality.
This is because a call to an admission webhook does not guarantee the admitted object will be persisted as is, or at all.
Later webhooks can modify the content of the object, a conflict could be encountered while writing to storage,
or the server could power off before persisting the object.</p><p>Additionally, webhooks with side effects must skip those side-effects when <code>dryRun: true</code> admission requests are handled.
A webhook must explicitly indicate that it will not have side-effects when run with <code>dryRun</code>,
or the dry-run request will not be sent to the webhook and the API request will fail instead.</p><p>Webhooks indicate whether they have side effects using the <code>sideEffects</code> field in the webhook configuration:</p><ul><li><code>None</code>: calling the webhook will have no side effects.</li><li><code>NoneOnDryRun</code>: calling the webhook will possibly have side effects, but if a request with
<code>dryRun: true</code> is sent to the webhook, the webhook will suppress the side effects (the webhook
is <code>dryRun</code>-aware).</li></ul><p>Here is an example of a validating webhook indicating it has no side effects on <code>dryRun: true</code> requests:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>admissionregistration.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ValidatingWebhookConfiguration<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">webhooks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-webhook.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">sideEffects</span>:<span style="color:#bbb"> </span>NoneOnDryRun<span style="color:#bbb">
</span></span></span></code></pre></div><h3 id="timeouts">Timeouts</h3><p>Because webhooks add to API request latency, they should evaluate as quickly as possible.
<code>timeoutSeconds</code> allows configuring how long the API server should wait for a webhook to respond
before treating the call as a failure.</p><p>If the timeout expires before the webhook responds, the webhook call will be ignored or
the API call will be rejected based on the <a href="#failure-policy">failure policy</a>.</p><p>The timeout value must be between 1 and 30 seconds.</p><p>Here is an example of a validating webhook with a custom timeout of 2 seconds:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>admissionregistration.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ValidatingWebhookConfiguration<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">webhooks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-webhook.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">timeoutSeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">2</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>The timeout for an admission webhook defaults to 10 seconds.</p><h3 id="reinvocation-policy">Reinvocation policy</h3><p>A single ordering of mutating admissions plugins (including webhooks) does not work for all cases
(see <a href="https://issue.k8s.io/64333">https://issue.k8s.io/64333</a> as an example). A mutating webhook can add a new sub-structure
to the object (like adding a <code>container</code> to a <code>pod</code>), and other mutating plugins which have already
run may have opinions on those new structures (like setting an <code>imagePullPolicy</code> on all containers).</p><p>To allow mutating admission plugins to observe changes made by other plugins,
built-in mutating admission plugins are re-run if a mutating webhook modifies an object,
and mutating webhooks can specify a <code>reinvocationPolicy</code> to control whether they are reinvoked as well.</p><p><code>reinvocationPolicy</code> may be set to <code>Never</code> or <code>IfNeeded</code>. It defaults to <code>Never</code>.</p><ul><li><code>Never</code>: the webhook must not be called more than once in a single admission evaluation.</li><li><code>IfNeeded</code>: the webhook may be called again as part of the admission evaluation if the object
being admitted is modified by other admission plugins after the initial webhook call.</li></ul><p>The important elements to note are:</p><ul><li>The number of additional invocations is not guaranteed to be exactly one.</li><li>If additional invocations result in further modifications to the object, webhooks are not
guaranteed to be invoked again.</li><li>Webhooks that use this option may be reordered to minimize the number of additional invocations.</li><li>To validate an object after all mutations are guaranteed complete, use a validating admission
webhook instead (recommended for webhooks with side-effects).</li></ul><p>Here is an example of a mutating webhook opting into being re-invoked if later admission plugins
modify the object:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>admissionregistration.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>MutatingWebhookConfiguration<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">webhooks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-webhook.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">reinvocationPolicy</span>:<span style="color:#bbb"> </span>IfNeeded<span style="color:#bbb">
</span></span></span></code></pre></div><p>Mutating webhooks must be <a href="#idempotence">idempotent</a>, able to successfully process an object they have already admitted
and potentially modified. This is true for all mutating admission webhooks, since any change they can make
in an object could already exist in the user-provided object, but it is essential for webhooks that opt into reinvocation.</p><h3 id="failure-policy">Failure policy</h3><p><code>failurePolicy</code> defines how unrecognized errors and timeout errors from the admission webhook
are handled. Allowed values are <code>Ignore</code> or <code>Fail</code>.</p><ul><li><code>Ignore</code> means that an error calling the webhook is ignored and the API request is allowed to continue.</li><li><code>Fail</code> means that an error calling the webhook causes the admission to fail and the API request to be rejected.</li></ul><p>Here is a mutating webhook configured to reject an API request if errors are encountered calling the admission webhook:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>admissionregistration.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>MutatingWebhookConfiguration<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">webhooks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-webhook.example.com<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">failurePolicy</span>:<span style="color:#bbb"> </span>Fail<span style="color:#bbb">
</span></span></span></code></pre></div><p>The default <code>failurePolicy</code> for an admission webhooks is <code>Fail</code>.</p><h2 id="monitoring-admission-webhooks">Monitoring admission webhooks</h2><p>The API server provides ways to monitor admission webhook behaviors. These
monitoring mechanisms help cluster admins to answer questions like:</p><ol><li><p>Which mutating webhook mutated the object in a API request?</p></li><li><p>What change did the mutating webhook applied to the object?</p></li><li><p>Which webhooks are frequently rejecting API requests? What's the reason for a rejection?</p></li></ol><h3 id="mutating-webhook-auditing-annotations">Mutating webhook auditing annotations</h3><p>Sometimes it's useful to know which mutating webhook mutated the object in a API request, and what change did the
webhook apply.</p><p>The Kubernetes API server performs <a href="/docs/tasks/debug/debug-cluster/audit/">auditing</a> on each
mutating webhook invocation. Each invocation generates an auditing annotation
capturing if a request object is mutated by the invocation, and optionally generates an annotation
capturing the applied patch from the webhook admission response. The annotations are set in the
audit event for given request on given stage of its execution, which is then pre-processed
according to a certain policy and written to a backend.</p><p>The audit level of a event determines which annotations get recorded:</p><ul><li><p>At <code>Metadata</code> audit level or higher, an annotation with key
<code>mutation.webhook.admission.k8s.io/round_{round idx}_index_{order idx}</code> gets logged with JSON
payload indicating a webhook gets invoked for given request and whether it mutated the object or not.</p><p>For example, the following annotation gets recorded for a webhook being reinvoked. The webhook is
ordered the third in the mutating webhook chain, and didn't mutated the request object during the
invocation.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#080;font-style:italic"># the audit event recorded</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"kind": </span><span style="color:#b44">"Event"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"apiVersion": </span><span style="color:#b44">"audit.k8s.io/v1"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"annotations": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"mutation.webhook.admission.k8s.io/round_1_index_2": "{\"configuration\":\"my-mutating-webhook-configuration.example.com\",\"webhook\":\"my-webhook.example.com\",\"mutated\": </span><span style="color:#a2f;font-weight:700">false</span>}"<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic"># other annotations</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># other fields</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>}<span style="color:#bbb">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#080;font-style:italic"># the annotation value deserialized</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"configuration": </span><span style="color:#b44">"my-mutating-webhook-configuration.example.com"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"webhook": </span><span style="color:#b44">"my-webhook.example.com"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"mutated": </span><span style="color:#a2f;font-weight:700">false</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>The following annotation gets recorded for a webhook being invoked in the first round. The webhook
is ordered the first in the mutating webhook chain, and mutated the request object during the
invocation.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#080;font-style:italic"># the audit event recorded</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"kind": </span><span style="color:#b44">"Event"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"apiVersion": </span><span style="color:#b44">"audit.k8s.io/v1"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"annotations": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"mutation.webhook.admission.k8s.io/round_0_index_0": "{\"configuration\":\"my-mutating-webhook-configuration.example.com\",\"webhook\":\"my-webhook-always-mutate.example.com\",\"mutated\": </span><span style="color:#a2f;font-weight:700">true</span>}"<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic"># other annotations</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># other fields</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>}<span style="color:#bbb">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#080;font-style:italic"># the annotation value deserialized</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"configuration": </span><span style="color:#b44">"my-mutating-webhook-configuration.example.com"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"webhook": </span><span style="color:#b44">"my-webhook-always-mutate.example.com"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"mutated": </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>}<span style="color:#bbb">
</span></span></span></code></pre></div></li><li><p>At <code>Request</code> audit level or higher, an annotation with key
<code>patch.webhook.admission.k8s.io/round_{round idx}_index_{order idx}</code> gets logged with JSON payload indicating
a webhook gets invoked for given request and what patch gets applied to the request object.</p><p>For example, the following annotation gets recorded for a webhook being reinvoked. The webhook is ordered the fourth in the
mutating webhook chain, and responded with a JSON patch which got applied to the request object.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#080;font-style:italic"># the audit event recorded</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"kind": </span><span style="color:#b44">"Event"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"apiVersion": </span><span style="color:#b44">"audit.k8s.io/v1"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"annotations": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">"patch.webhook.admission.k8s.io/round_1_index_3": </span><span style="color:#b44">"{\"configuration\":\"my-other-mutating-webhook-configuration.example.com\",\"webhook\":\"my-webhook-always-mutate.example.com\",\"patch\":[{\"op\":\"add\",\"path\":\"/data/mutation-stage\",\"value\":\"yes\"}],\"patchType\":\"JSONPatch\"}"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic"># other annotations</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># other fields</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>}<span style="color:#bbb">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#080;font-style:italic"># the annotation value deserialized</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"configuration": </span><span style="color:#b44">"my-other-mutating-webhook-configuration.example.com"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"webhook": </span><span style="color:#b44">"my-webhook-always-mutate.example.com"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"patchType": </span><span style="color:#b44">"JSONPatch"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"patch": </span>[<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">"op": </span><span style="color:#b44">"add"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">"path": </span><span style="color:#b44">"/data/mutation-stage"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">            </span><span style="color:green;font-weight:700">"value": </span><span style="color:#b44">"yes"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>}<span style="color:#bbb">
</span></span></span></code></pre></div></li></ul><h3 id="admission-webhook-metrics">Admission webhook metrics</h3><p>The API server exposes Prometheus metrics from the <code>/metrics</code> endpoint, which can be used for monitoring and
diagnosing API server status. The following metrics record status related to admission webhooks.</p><h4 id="api-server-admission-webhook-rejection-count">API server admission webhook rejection count</h4><p>Sometimes it's useful to know which admission webhooks are frequently rejecting API requests, and the
reason for a rejection.</p><p>The API server exposes a Prometheus counter metric recording admission webhook rejections. The
metrics are labelled to identify the causes of webhook rejection(s):</p><ul><li><p><code>name</code>: the name of the webhook that rejected a request.</p></li><li><p><code>operation</code>: the operation type of the request, can be one of <code>CREATE</code>,
<code>UPDATE</code>, <code>DELETE</code> and <code>CONNECT</code>.</p></li><li><p><code>type</code>: the admission webhook type, can be one of <code>admit</code> and <code>validating</code>.</p></li><li><p><code>error_type</code>: identifies if an error occurred during the webhook invocation
that caused the rejection. Its value can be one of:</p><ul><li><code>calling_webhook_error</code>: unrecognized errors or timeout errors from the admission webhook happened and the
webhook's <a href="#failure-policy">Failure policy</a> is set to <code>Fail</code>.</li><li><code>no_error</code>: no error occurred. The webhook rejected the request with <code>allowed: false</code> in the admission
response. The metrics label <code>rejection_code</code> records the <code>.status.code</code> set in the admission response.</li><li><code>apiserver_internal_error</code>: an API server internal error happened.</li></ul></li><li><p><code>rejection_code</code>: the HTTP status code set in the admission response when a
webhook rejected a request.</p></li></ul><p>Example of the rejection count metrics:</p><pre tabindex="0"><code># HELP apiserver_admission_webhook_rejection_count [ALPHA] Admission webhook rejection count, identified by name and broken out for each admission type (validating or admit) and operation. Additional labels specify an error type (calling_webhook_error or apiserver_internal_error if an error occurred; no_error otherwise) and optionally a non-zero rejection code if the webhook rejects the request with an HTTP status code (honored by the apiserver when the code is greater or equal to 400). Codes greater than 600 are truncated to 600, to keep the metrics cardinality bounded.
# TYPE apiserver_admission_webhook_rejection_count counter
apiserver_admission_webhook_rejection_count{error_type="calling_webhook_error",name="always-timeout-webhook.example.com",operation="CREATE",rejection_code="0",type="validating"} 1
apiserver_admission_webhook_rejection_count{error_type="calling_webhook_error",name="invalid-admission-response-webhook.example.com",operation="CREATE",rejection_code="0",type="validating"} 1
apiserver_admission_webhook_rejection_count{error_type="no_error",name="deny-unwanted-configmap-data.example.com",operation="CREATE",rejection_code="400",type="validating"} 13
</code></pre><h2 id="best-practices-and-warnings">Best practices and warnings</h2><p>For recommendations and considerations when writing mutating admission webhooks,
see
<a href="/docs/concepts/cluster-administration/admission-webhooks-good-practices/">Admission Webhooks Good Practices</a>.</p></div>