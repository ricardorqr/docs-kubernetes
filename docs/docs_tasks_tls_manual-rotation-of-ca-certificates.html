<div class="td-content"><h1 data-pagefind-weight="10">Manual Rotation of CA Certificates</h1><p>This page shows how to manually rotate the certificate authority (CA) certificates.</p><h2 id="before-you-begin">Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul><ul><li>For more information about authentication in Kubernetes, see
<a href="/docs/reference/access-authn-authz/authentication/">Authenticating</a>.</li><li>For more information about best practices for CA certificates, see
<a href="/docs/setup/best-practices/certificates/#single-root-ca">Single root CA</a>.</li></ul><h2 id="rotate-the-ca-certificates-manually">Rotate the CA certificates manually</h2><div class="alert alert-caution" role="alert"><h4 class="alert-heading">Caution:</h4><p>Make sure to back up your certificate directory along with configuration files and any other necessary files.</p><p>This approach assumes operation of the Kubernetes control plane in a HA configuration with multiple API servers.
Graceful termination of the API server is also assumed so clients can cleanly disconnect from one API server and
reconnect to another.</p><p>Configurations with a single API server will experience unavailability while the API server is being restarted.</p></div><ol><li><p>Distribute the new CA certificates and private keys (for example: <code>ca.crt</code>, <code>ca.key</code>, <code>front-proxy-ca.crt</code>,
and <code>front-proxy-ca.key</code>) to all your control plane nodes in the Kubernetes certificates directory.</p></li><li><p>Update the <code>--root-ca-file</code> flag for the <a class="glossary-tooltip" title="Control Plane component that runs controller processes." data-toggle="tooltip" data-placement="top" href="/docs/reference/command-line-tools-reference/kube-controller-manager/" target="_blank" aria-label="kube-controller-manager">kube-controller-manager</a> to include
both old and new CA, then restart the kube-controller-manager.</p><p>Any <a class="glossary-tooltip" title="Provides an identity for processes that run in a Pod." data-toggle="tooltip" data-placement="top" href="/docs/tasks/configure-pod-container/configure-service-account/" target="_blank" aria-label="ServiceAccount">ServiceAccount</a> created after this point will get
Secrets that include both old and new CAs.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4><p>The files specified by the kube-controller-manager flags <code>--client-ca-file</code> and <code>--cluster-signing-cert-file</code>
cannot be CA bundles. If these flags and <code>--root-ca-file</code> point to the same <code>ca.crt</code> file which is now a
bundle (includes both old and new CA) you will face an error. To workaround this problem you can copy the new CA
to a separate file and make the flags <code>--client-ca-file</code> and <code>--cluster-signing-cert-file</code> point to the copy.
Once <code>ca.crt</code> is no longer a bundle you can restore the problem flags to point to <code>ca.crt</code> and delete the copy.</p><p><a href="https://github.com/kubernetes/kubeadm/issues/1350">Issue 1350</a> for kubeadm tracks an bug with the
kube-controller-manager being unable to accept a CA bundle.</p></div></li><li><p>Wait for the controller manager to update <code>ca.crt</code> in the service account Secrets to include both old and new CA certificates.</p><p>If any Pods are started before new CA is used by API servers, the new Pods get this update and will trust both
old and new CAs.</p></li><li><p>Restart all pods using in-cluster configurations (for example: kube-proxy, CoreDNS, etc) so they can use the
updated certificate authority data from Secrets that link to ServiceAccounts.</p><ul><li>Make sure CoreDNS, kube-proxy and other Pods using in-cluster configurations are working as expected.</li></ul></li><li><p>Append the both old and new CA to the file against <code>--client-ca-file</code> and <code>--kubelet-certificate-authority</code>
flag in the <code>kube-apiserver</code> configuration.</p></li><li><p>Append the both old and new CA to the file against <code>--client-ca-file</code> flag in the <code>kube-scheduler</code> configuration.</p></li><li><p>Update certificates for user accounts by replacing the content of <code>client-certificate-data</code> and <code>client-key-data</code>
respectively.</p><p>For information about creating certificates for individual user accounts, see
<a href="/docs/setup/best-practices/certificates/#configure-certificates-for-user-accounts">Configure certificates for user accounts</a>.</p><p>Additionally, update the <code>certificate-authority-data</code> section in the kubeconfig files,
respectively with Base64-encoded old and new certificate authority data</p></li><li><p>Update the <code>--root-ca-file</code> flag for the <a class="glossary-tooltip" title="Control plane component that integrates Kubernetes with third-party cloud providers." data-toggle="tooltip" data-placement="top" href="/docs/concepts/architecture/cloud-controller/" target="_blank" aria-label="Cloud Controller Manager">Cloud Controller Manager</a> to include
both old and new CA, then restart the cloud-controller-manager.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>If your cluster does not have a cloud-controller-manager, you can skip this step.</div></li><li><p>Follow the steps below in a rolling fashion.</p><ol><li><p>Restart any other
<a href="/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/">aggregated API servers</a> or
webhook handlers to trust the new CA certificates.</p></li><li><p>Restart the kubelet by update the file against <code>clientCAFile</code> in kubelet configuration and
<code>certificate-authority-data</code> in <code>kubelet.conf</code> to use both the old and new CA on all nodes.</p><p>If your kubelet is not using client certificate rotation, update <code>client-certificate-data</code> and
<code>client-key-data</code> in <code>kubelet.conf</code> on all nodes along with the kubelet client certificate file
usually found in <code>/var/lib/kubelet/pki</code>.</p></li><li><p>Restart API servers with the certificates (<code>apiserver.crt</code>, <code>apiserver-kubelet-client.crt</code> and
<code>front-proxy-client.crt</code>) signed by new CA.
You can use the existing private keys or new private keys.
If you changed the private keys then update these in the Kubernetes certificates directory as well.</p><p>Since the Pods in your cluster trust both old and new CAs, there will be a momentarily disconnection
after which pods' Kubernetes clients reconnect to the new API server.
The new API server uses a certificate signed by the new CA.</p><ul><li>Restart the <a class="glossary-tooltip" title="Control plane component that watches for newly created pods with no assigned node, and selects a node for them to run on." data-toggle="tooltip" data-placement="top" href="/docs/reference/command-line-tools-reference/kube-scheduler/" target="_blank" aria-label="kube-scheduler">kube-scheduler</a> to use and
trust the new CAs.</li><li>Make sure control plane components logs no TLS errors.</li></ul><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4><pre><code>  To generate certificates and private keys for your cluster using the `openssl` command line tool,
  see [Certificates (`openssl`)](/docs/tasks/administer-cluster/certificates/#openssl).
  You can also use [`cfssl`](/docs/tasks/administer-cluster/certificates/#cfssl).
</code></pre></div></li><li><p>Annotate any DaemonSets and Deployments to trigger pod replacement in a safer rolling fashion.</p></li></ol><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#a2f;font-weight:700">for</span> namespace in <span style="color:#a2f;font-weight:700">$(</span>kubectl get namespace -o <span style="color:#b8860b">jsonpath</span><span style="color:#666">=</span><span style="color:#b44">'{.items[*].metadata.name}'</span><span style="color:#a2f;font-weight:700">)</span>; <span style="color:#a2f;font-weight:700">do</span>
</span></span><span style="display:flex"><span>    <span style="color:#a2f;font-weight:700">for</span> name in <span style="color:#a2f;font-weight:700">$(</span>kubectl get deployments -n <span style="color:#b8860b">$namespace</span> -o <span style="color:#b8860b">jsonpath</span><span style="color:#666">=</span><span style="color:#b44">'{.items[*].metadata.name}'</span><span style="color:#a2f;font-weight:700">)</span>; <span style="color:#a2f;font-weight:700">do</span>
</span></span><span style="display:flex"><span>        kubectl patch deployment -n <span style="color:#b68;font-weight:700">${</span><span style="color:#b8860b">namespace</span><span style="color:#b68;font-weight:700">}</span> <span style="color:#b68;font-weight:700">${</span><span style="color:#b8860b">name</span><span style="color:#b68;font-weight:700">}</span> -p <span style="color:#b44">'{"spec":{"template":{"metadata":{"annotations":{"ca-rotation": "1"}}}}}'</span>;
</span></span><span style="display:flex"><span>    <span style="color:#a2f;font-weight:700">done</span>
</span></span><span style="display:flex"><span>    <span style="color:#a2f;font-weight:700">for</span> name in <span style="color:#a2f;font-weight:700">$(</span>kubectl get daemonset -n <span style="color:#b8860b">$namespace</span> -o <span style="color:#b8860b">jsonpath</span><span style="color:#666">=</span><span style="color:#b44">'{.items[*].metadata.name}'</span><span style="color:#a2f;font-weight:700">)</span>; <span style="color:#a2f;font-weight:700">do</span>
</span></span><span style="display:flex"><span>        kubectl patch daemonset -n <span style="color:#b68;font-weight:700">${</span><span style="color:#b8860b">namespace</span><span style="color:#b68;font-weight:700">}</span> <span style="color:#b68;font-weight:700">${</span><span style="color:#b8860b">name</span><span style="color:#b68;font-weight:700">}</span> -p <span style="color:#b44">'{"spec":{"template":{"metadata":{"annotations":{"ca-rotation": "1"}}}}}'</span>;
</span></span><span style="display:flex"><span>    <span style="color:#a2f;font-weight:700">done</span>
</span></span><span style="display:flex"><span><span style="color:#a2f;font-weight:700">done</span>
</span></span></code></pre></div><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4><pre><code>  To limit the number of concurrent disruptions that your application experiences,
  see [configure pod disruption budget](/docs/tasks/run-application/configure-pdb/).
</code></pre></div><pre><code> Depending on how you use StatefulSets you may also need to perform similar rolling replacement.
</code></pre></li><li><p>If your cluster is using bootstrap tokens to join nodes, update the ConfigMap <code>cluster-info</code> in the <code>kube-public</code>
namespace with new CA.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#b8860b">base64_encoded_ca</span><span style="color:#666">=</span><span style="color:#b44">"</span><span style="color:#a2f;font-weight:700">$(</span>base64 -w0 /etc/kubernetes/pki/ca.crt<span style="color:#a2f;font-weight:700">)</span><span style="color:#b44">"</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>kubectl get cm/cluster-info --namespace kube-public -o yaml | <span style="color:#b62;font-weight:700">\
</span></span></span><span style="display:flex"><span><span style="color:#b62;font-weight:700"/>    /bin/sed <span style="color:#b44">"s/\(certificate-authority-data:\).*/\1 </span><span style="color:#b68;font-weight:700">${</span><span style="color:#b8860b">base64_encoded_ca</span><span style="color:#b68;font-weight:700">}</span><span style="color:#b44">/"</span> | <span style="color:#b62;font-weight:700">\
</span></span></span><span style="display:flex"><span><span style="color:#b62;font-weight:700"/>    kubectl apply -f -
</span></span></code></pre></div></li><li><p>Verify the cluster functionality.</p><ol><li><p>Check the logs from control plane components, along with the kubelet and the kube-proxy.
Ensure those components are not reporting any TLS errors; see
<a href="/docs/tasks/debug/debug-cluster/#looking-at-logs">looking at the logs</a> for more details.</p></li><li><p>Validate logs from any aggregated api servers and pods using in-cluster config.</p></li></ol></li><li><p>Once the cluster functionality is successfully verified:</p><ol><li><p>Update all service account tokens to include new CA certificate only.</p><ul><li>All pods using an in-cluster kubeconfig will eventually need to be restarted to pick up the new Secret,
so that no Pods are relying on the old cluster CA.</li></ul></li><li><p>Restart the control plane components by removing the old CA from the kubeconfig files and the files against
<code>--client-ca-file</code>, <code>--root-ca-file</code> flags resp.</p></li><li><p>On each node, restart the kubelet by removing the old CA from file against the <code>clientCAFile</code> flag
and from the kubelet kubeconfig file. You should carry this out as a rolling update.</p><p>If your cluster lets you make this change, you can also roll it out by replacing nodes rather than
reconfiguring them.</p></li></ol></li></ol></div>