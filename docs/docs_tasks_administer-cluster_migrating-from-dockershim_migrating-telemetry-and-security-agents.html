<div class="td-content"><h1 data-pagefind-weight="10">Migrating telemetry and security agents from dockershim</h1><div class="alert alert-secondary callout third-party-content" role="alert"><strong>Note:</strong>â€ˆThis section links to third party projects that provide functionality required by Kubernetes. The Kubernetes project authors aren't responsible for these projects, which are listed alphabetically. To add a project to this list, read the <a href="/docs/contribute/style/content-guide/#third-party-content">content guide</a> before submitting a change. <a href="#third-party-content-disclaimer">More information.</a></div><p>Kubernetes' support for direct integration with Docker Engine is deprecated and
has been removed. Most apps do not have a direct dependency on runtime hosting
containers. However, there are still a lot of telemetry and monitoring agents
that have a dependency on Docker to collect containers metadata, logs, and
metrics. This document aggregates information on how to detect these
dependencies as well as links on how to migrate these agents to use generic tools or
alternative runtimes.</p><h2 id="telemetry-and-security-agents">Telemetry and security agents</h2><p>Within a Kubernetes cluster there are a few different ways to run telemetry or
security agents. Some agents have a direct dependency on Docker Engine when
they run as DaemonSets or directly on nodes.</p><h3 id="why-do-some-telemetry-agents-communicate-with-docker-engine">Why do some telemetry agents communicate with Docker Engine?</h3><p>Historically, Kubernetes was written to work specifically with Docker Engine.
Kubernetes took care of networking and scheduling, relying on Docker Engine for
launching and running containers (within Pods) on a node. Some information that
is relevant to telemetry, such as a pod name, is only available from Kubernetes
components. Other data, such as container metrics, is not the responsibility of
the container runtime. Early telemetry agents needed to query the container
runtime <em>and</em> Kubernetes to report an accurate picture. Over time, Kubernetes
gained the ability to support multiple runtimes, and now supports any runtime
that is compatible with the <a href="/docs/concepts/architecture/cri/">container runtime interface</a>.</p><p>Some telemetry agents rely specifically on Docker Engine tooling. For example, an agent
might run a command such as
<a href="https://docs.docker.com/engine/reference/commandline/ps/"><code>docker ps</code></a>
or <a href="https://docs.docker.com/engine/reference/commandline/top/"><code>docker top</code></a> to list
containers and processes or <a href="https://docs.docker.com/engine/reference/commandline/logs/"><code>docker logs</code></a>
to receive streamed logs. If nodes in your existing cluster use
Docker Engine, and you switch to a different container runtime,
these commands will not work any longer.</p><h3 id="identify-docker-dependency">Identify DaemonSets that depend on Docker Engine</h3><p>If a pod wants to make calls to the <code>dockerd</code> running on the node, the pod must either:</p><ul><li>mount the filesystem containing the Docker daemon's privileged socket, as a
<a class="glossary-tooltip" title="A directory containing data, accessible to the containers in a pod." data-toggle="tooltip" data-placement="top" href="/docs/concepts/storage/volumes/" target="_blank" aria-label="volume">volume</a>; or</li><li>mount the specific path of the Docker daemon's privileged socket directly, also as a volume.</li></ul><p>For example: on COS images, Docker exposes its Unix domain socket at
<code>/var/run/docker.sock</code> This means that the pod spec will include a
<code>hostPath</code> volume mount of <code>/var/run/docker.sock</code>.</p><p>Here's a sample shell script to find Pods that have a mount directly mapping the
Docker socket. This script outputs the namespace and name of the pod. You can
remove the <code>grep '/var/run/docker.sock'</code> to review other mounts.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl get pods --all-namespaces <span style="color:#b62;font-weight:700">\
</span></span></span><span style="display:flex"><span><span style="color:#b62;font-weight:700"/>-o<span style="color:#666">=</span><span style="color:#b8860b">jsonpath</span><span style="color:#666">=</span><span style="color:#b44">'{range .items[*]}{"\n"}{.metadata.namespace}{":\t"}{.metadata.name}{":\t"}{range .spec.volumes[*]}{.hostPath.path}{", "}{end}{end}'</span> <span style="color:#b62;font-weight:700">\
</span></span></span><span style="display:flex"><span><span style="color:#b62;font-weight:700"/>| sort <span style="color:#b62;font-weight:700">\
</span></span></span><span style="display:flex"><span><span style="color:#b62;font-weight:700"/>| grep <span style="color:#b44">'/var/run/docker.sock'</span>
</span></span></code></pre></div><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>There are alternative ways for a pod to access Docker on the host. For instance, the parent
directory <code>/var/run</code> may be mounted instead of the full path (like in <a href="https://gist.github.com/itaysk/7bc3e56d69c4d72a549286d98fd557dd">this
example</a>).
The script above only detects the most common uses.</div><h3 id="detecting-docker-dependency-from-node-agents">Detecting Docker dependency from node agents</h3><p>If your cluster nodes are customized and install additional security and
telemetry agents on the node, check with the agent vendor
to verify whether it has any dependency on Docker.</p><h3 id="telemetry-and-security-agent-vendors">Telemetry and security agent vendors</h3><p>This section is intended to aggregate information about various telemetry and
security agents that may have a dependency on container runtimes.</p><p>We keep the work in progress version of migration instructions for various telemetry and security agent vendors
in <a href="https://docs.google.com/document/d/1ZFi4uKit63ga5sxEiZblfb-c23lFhvy6RXVPikS8wf0/edit">Google doc</a>.
Please contact the vendor to get up to date instructions for migrating from dockershim.</p><h2 id="migration-from-dockershim">Migration from dockershim</h2><h3 id="aqua-https-www-aquasec-com"><a href="https://www.aquasec.com">Aqua</a></h3><p>No changes are needed: everything should work seamlessly on the runtime switch.</p><h3 id="datadog-https-www-datadoghq-com-product"><a href="https://www.datadoghq.com/product/">Datadog</a></h3><p>How to migrate:
<a href="https://docs.datadoghq.com/agent/guide/docker-deprecation/">Docker deprecation in Kubernetes</a>
The pod that accesses Docker Engine may have a name containing any of:</p><ul><li><code>datadog-agent</code></li><li><code>datadog</code></li><li><code>dd-agent</code></li></ul><h3 id="dynatrace-https-www-dynatrace-com"><a href="https://www.dynatrace.com/">Dynatrace</a></h3><p>How to migrate:
<a href="https://community.dynatrace.com/t5/Best-practices/Migrating-from-Docker-only-to-generic-container-metrics-in/m-p/167030#M49">Migrating from Docker-only to generic container metrics in Dynatrace</a></p><p>Containerd support announcement: <a href="https://www.dynatrace.com/news/blog/get-automated-full-stack-visibility-into-containerd-based-kubernetes-environments/">Get automated full-stack visibility into
containerd-based Kubernetes
environments</a></p><p>CRI-O support announcement: <a href="https://www.dynatrace.com/news/blog/get-automated-full-stack-visibility-into-your-cri-o-kubernetes-containers-beta/">Get automated full-stack visibility into your CRI-O Kubernetes containers (Beta)</a></p><p>The pod accessing Docker may have name containing:</p><ul><li><code>dynatrace-oneagent</code></li></ul><h3 id="falco-https-falco-org"><a href="https://falco.org">Falco</a></h3><p>How to migrate:</p><p><a href="https://falco.org/docs/getting-started/deployment/#docker-deprecation-in-kubernetes">Migrate Falco from dockershim</a>
Falco supports any CRI-compatible runtime (containerd is used in the default configuration); the documentation explains all details.
The pod accessing Docker may have name containing:</p><ul><li><code>falco</code></li></ul><h3 id="prisma-cloud-compute-https-docs-paloaltonetworks-com-prisma-prisma-cloud-html"><a href="https://docs.paloaltonetworks.com/prisma/prisma-cloud.html">Prisma Cloud Compute</a></h3><p>Check <a href="https://docs.paloaltonetworks.com/prisma/prisma-cloud/prisma-cloud-admin-compute/install/install_kubernetes.html">documentation for Prisma Cloud</a>,
under the "Install Prisma Cloud on a CRI (non-Docker) cluster" section.
The pod accessing Docker may be named like:</p><ul><li><code>twistlock-defender-ds</code></li></ul><h3 id="signalfx-splunk-https-www-splunk-com-en-us-investor-relations-acquisitions-signalfx-html"><a href="https://www.splunk.com/en_us/investor-relations/acquisitions/signalfx.html">SignalFx (Splunk)</a></h3><p>The SignalFx Smart Agent (deprecated) uses several different monitors for Kubernetes including
<code>kubernetes-cluster</code>, <code>kubelet-stats/kubelet-metrics</code>, and <code>docker-container-stats</code>.
The <code>kubelet-stats</code> monitor was previously deprecated by the vendor, in favor of <code>kubelet-metrics</code>.
The <code>docker-container-stats</code> monitor is the one affected by dockershim removal.
Do not use the <code>docker-container-stats</code> with container runtimes other than Docker Engine.</p><p>How to migrate from dockershim-dependent agent:</p><ol><li>Remove <code>docker-container-stats</code> from the list of <a href="https://github.com/signalfx/signalfx-agent/blob/main/docs/monitor-config.md">configured monitors</a>.
Note, keeping this monitor enabled with non-dockershim runtime will result in incorrect metrics
being reported when docker is installed on node and no metrics when docker is not installed.</li><li><a href="https://github.com/signalfx/signalfx-agent/blob/main/docs/monitors/kubelet-metrics.md">Enable and configure <code>kubelet-metrics</code></a> monitor.</li></ol><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>The set of collected metrics will change. Review your alerting rules and dashboards.</div><p>The Pod accessing Docker may be named something like:</p><ul><li><code>signalfx-agent</code></li></ul><h3 id="yahoo-kubectl-flame">Yahoo Kubectl Flame</h3><p>Flame does not support container runtimes other than Docker. See
<a href="https://github.com/yahoo/kubectl-flame/issues/51">https://github.com/yahoo/kubectl-flame/issues/51</a></p></div>