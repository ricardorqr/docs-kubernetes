<div class="td-content"><h1 data-pagefind-weight="10">Use a SOCKS5 Proxy to Access the Kubernetes API</h1><div class="feature-state-notice feature-stable"><span class="feature-state-name">FEATURE STATE:</span>
<code>Kubernetes v1.24 [stable]</code></div><p>This page shows how to use a SOCKS5 proxy to access the API of a remote Kubernetes cluster.
This is useful when the cluster you want to access does not expose its API directly on the public internet.</p><h2 id="before-you-begin">Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul>Your Kubernetes server must be at or later than version v1.24.<p>To check the version, enter <code>kubectl version</code>.</p></p><p>You need SSH client software (the <code>ssh</code> tool), and an SSH service running on the remote server.
You must be able to log in to the SSH service on the remote server.</p><h2 id="task-context">Task context</h2><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>This example tunnels traffic using SSH, with the SSH client and server acting as a SOCKS proxy.
You can instead use any other kind of <a href="https://en.wikipedia.org/wiki/SOCKS#SOCKS5">SOCKS5</a> proxies.</div><p>Figure 1 represents what you're going to achieve in this task.</p><ul><li>You have a client computer, referred to as local in the steps ahead, from where you're going to create requests to talk to the Kubernetes API.</li><li>The Kubernetes server/API is hosted on a remote server.</li><li>You will use SSH client and server software to create a secure SOCKS5 tunnel between the local and
the remote server. The HTTPS traffic between the client and the Kubernetes API will flow over the SOCKS5
tunnel, which is itself tunnelled over SSH.</li></ul><p><figure><div class="mermaid">graph LR;
subgraph local[Local client machine]
client([client])-. local<br/>traffic .-&gt; local_ssh[Local SSH<br/>SOCKS5 proxy];
end
local_ssh[SSH<br/>SOCKS5<br/>proxy]-- SSH Tunnel --&gt;sshd
subgraph remote[Remote server]
sshd[SSH<br/>server]-- local traffic --&gt;service1;
end
client([client])-. proxied HTTPs traffic<br/>going through the proxy .-&gt;service1[Kubernetes API];
classDef plain fill:#ddd,stroke:#fff,stroke-width:4px,color:#000;
classDef k8s fill:#326ce5,stroke:#fff,stroke-width:4px,color:#fff;
classDef cluster fill:#fff,stroke:#bbb,stroke-width:2px,color:#326ce5;
class ingress,service1,service2,pod1,pod2,pod3,pod4 k8s;
class client plain;
class cluster cluster;</div></figure><noscript><div class="alert alert-secondary callout" role="alert"><em class="javascript-required">JavaScript must be <a href="https://www.enable-javascript.com/">enabled</a> to view this content</em></div></noscript>Figure 1. SOCKS5 tutorial components</p><h2 id="using-ssh-to-create-a-socks5-proxy">Using ssh to create a SOCKS5 proxy</h2><p>The following command starts a SOCKS5 proxy between your client machine and the remote SOCKS server:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># The SSH tunnel continues running in the foreground after you run this</span>
</span></span><span style="display:flex"><span>ssh -D <span style="color:#666">1080</span> -q -N username@kubernetes-remote-server.example
</span></span></code></pre></div><p>The SOCKS5 proxy lets you connect to your cluster's API server based on the following configuration:</p><ul><li><code>-D 1080</code>: opens a SOCKS proxy on local port :1080.</li><li><code>-q</code>: quiet mode. Causes most warning and diagnostic messages to be suppressed.</li><li><code>-N</code>: Do not execute a remote command. Useful for just forwarding ports.</li><li><code>username@kubernetes-remote-server.example</code>: the remote SSH server behind which the Kubernetes cluster
is running (eg: a bastion host).</li></ul><h2 id="client-configuration">Client configuration</h2><p>To access the Kubernetes API server through the proxy you must instruct <code>kubectl</code> to send queries through
the <code>SOCKS</code> proxy we created earlier. Do this by either setting the appropriate environment variable,
or via the <code>proxy-url</code> attribute in the kubeconfig file. Using an environment variable:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#a2f">export</span> <span style="color:#b8860b">HTTPS_PROXY</span><span style="color:#666">=</span>socks5://localhost:1080
</span></span></code></pre></div><p>To always use this setting on a specific <code>kubectl</code> context, specify the <code>proxy-url</code> attribute in the relevant
<code>cluster</code> entry within the <code>~/.kube/config</code> file. For example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">clusters</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">cluster</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">certificate-authority-data</span>:<span style="color:#bbb"> </span>LRMEMMW2<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># shortened for readability </span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">server</span>:<span style="color:#bbb"> </span>https://&lt;API_SERVER_IP_ADDRESS&gt;:6443 <span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># the "Kubernetes API" server, in other words the IP address of kubernetes-remote-server.example</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">proxy-url</span>:<span style="color:#bbb"> </span>socks5://localhost:1080  <span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># the "SSH SOCKS5 proxy" in the diagram above</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">contexts</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">context</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">cluster</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">user</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">current-context</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Config<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">preferences</span>:<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">users</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">user</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">client-certificate-data</span>:<span style="color:#bbb"> </span>LS0tLS1CR==<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># shortened for readability</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">client-key-data</span>:<span style="color:#bbb"> </span>LS0tLS1CRUdJT=     <span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># shortened for readability</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>Once you have created the tunnel via the ssh command mentioned earlier, and defined either the environment variable or
the <code>proxy-url</code> attribute, you can interact with your cluster through that proxy. For example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pods
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console"><span style="display:flex"><span><span style="color:#888">NAMESPACE     NAME                                     READY   STATUS      RESTARTS   AGE
</span></span></span><span style="display:flex"><span><span style="color:#888">kube-system   coredns-85cb69466-klwq8                  1/1     Running     0          5m46s
</span></span></span></code></pre></div><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4><ul><li>Before <code>kubectl</code> 1.24, most <code>kubectl</code> commands worked when using a socks proxy, except <code>kubectl exec</code>.</li><li><code>kubectl</code> supports both <code>HTTPS_PROXY</code> and <code>https_proxy</code> environment variables. These are used by other
programs that support SOCKS, such as <code>curl</code>. Therefore in some cases it
will be better to define the environment variable on the command line:<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#b8860b">HTTPS_PROXY</span><span style="color:#666">=</span>socks5://localhost:1080 kubectl get pods
</span></span></code></pre></div></li><li>When using <code>proxy-url</code>, the proxy is used only for the relevant <code>kubectl</code> context,
whereas the environment variable will affect all contexts.</li><li>The k8s API server hostname can be further protected from DNS leakage by using the <code>socks5h</code> protocol name
instead of the more commonly known <code>socks5</code> protocol shown above. In this case, <code>kubectl</code> will ask the proxy server
(such as an ssh bastion) to resolve the k8s API server domain name, instead of resolving it on the system running
<code>kubectl</code>. Note also that with <code>socks5h</code>, a k8s API server URL like <code>https://localhost:6443/api</code> does not refer
to your local client computer. Instead, it refers to <code>localhost</code> as known on the proxy server (eg the ssh bastion).</li></ul></div><h2 id="clean-up">Clean up</h2><p>Stop the ssh port-forwarding process by pressing <code>CTRL+C</code> on the terminal where it is running.</p><p>Type <code>unset https_proxy</code> in a terminal to stop forwarding http traffic through the proxy.</p><h2 id="further-reading">Further reading</h2><ul><li><a href="https://man.openbsd.org/ssh">OpenSSH remote login client</a></li></ul></div>