<div class="td-content"><h1 data-pagefind-weight="10">Kubernetes Default ServiceCIDR Reconfiguration</h1><div class="feature-state-notice feature-stable" title="Feature Gate: MultiCIDRServiceAllocator"><span class="feature-state-name">FEATURE STATE:</span>
<code>Kubernetes v1.33 [stable]</code> (enabled by default: true)</div><p>This document shares how to reconfigure the default Service IP range(s) assigned
to a cluster.</p><h2 id="before-you-begin">Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul>Your Kubernetes server must be at or later than version v1.33.<p>To check the version, enter <code>kubectl version</code>.</p><h2 id="kubernetes-default-servicecidr-reconfiguration">Kubernetes Default ServiceCIDR Reconfiguration</h2><p>This document explains how to manage the Service IP address range within a
Kubernetes cluster, which also influences the cluster's supported IP families
for Services.</p><p>The IP families available for Service ClusterIPs are determined by the
<code>--service-cluster-ip-range</code> flag to kube-apiserver. For a better
understanding of Service IP address allocation, refer to the
<a href="/docs/reference/networking/virtual-ips/#ip-address-objects">Services IP address allocation tracking</a> documentation.</p><p>Since Kubernetes 1.33, the Service IP families configured for the cluster are
reflected by the ServiceCIDR object named <code>kubernetes</code>. The <code>kubernetes</code> ServiceCIDR
object is created by the first kube-apiserver instance that starts, based on its
configured <code>--service-cluster-ip-range</code> flag. To ensure consistent cluster behavior,
all kube-apiserver instances must be configured with the same <code>--service-cluster-ip-range</code> values,
which must match the default <code>kubernetes</code> ServiceCIDR object.</p><h3 id="kubernetes-servicecidr-reconfiguration-categories">Kubernetes ServiceCIDR Reconfiguration Categories</h3><p>ServiceCIDR reconfiguration typically falls into one of the following categories:</p><ul><li><p><strong>Extending the existing ServiceCIDRs:</strong> This can be done dynamically by
adding new ServiceCIDR objects without the need for reconfiguring the
kube-apiserver. Please refer to the dedicated documentation on
<a href="/docs/tasks/network/extend-service-ip-ranges/">Extending Service IP Ranges</a>.</p></li><li><p><strong>Single-to-dual-stack conversion preserving the primary ServiceCIDR:</strong> This
involves introducing a secondary IP family (IPv6 to an IPv4-only cluster, or
IPv4 to an IPv6-only cluster) while keeping the original IP family as
primary. This requires an update to the kube-apiserver configuration and a
corresponding modification of various cluster components that need to handle
this additional IP family. These components include, but are not limited to,
kube-proxy, the CNI or network plugin, service mesh implementations, and DNS
services.</p></li><li><p><strong>Dual-to-single conversion preserving the primary ServiceCIDR:</strong> This
involves removing the secondary IP family from a dual-stack cluster,
reverting to a single IP family while retaining the original primary IP
family. In addition to reconfiguring the components to match the
new IP family, you might need to address Services that were explicitly
configured to use the removed IP family.</p></li><li><p><strong>Anything that results in changing the primary ServiceCIDR:</strong> Completely
replacing the default ServiceCIDR is a complex operation. If the new
ServiceCIDR does not overlap with the existing one, it will require
<a href="#illustrative-reconfiguration-steps">renumbering all existing Services and changing the <code>kubernetes.default</code> Service</a>.
The case where the primary IP family also changes is even more complicated,
and may require changing multiple cluster components (kubelet, network plugins, etc.)
to match the new primary IP family.</p></li></ul><h3 id="manual-operations-for-replacing-the-default-servicecidr">Manual Operations for Replacing the Default ServiceCIDR</h3><p>Reconfiguring the default ServiceCIDR necessitates manual steps performed by
the cluster operator, administrator, or the software managing the cluster
lifecycle. These typically include:</p><ol><li><strong>Updating</strong> the kube-apiserver configuration: Modify the
<code>--service-cluster-ip-range</code> flag with the new IP range(s).</li><li><strong>Reconfiguring</strong> the network components: This is a critical step and the
specific procedure depends on the different networking components in use. It
might involve updating configuration files, restarting agent pods, or
updating the components to manage the new ServiceCIDR(s) and the desired IP
family configuration for Pods. Typical components can be the implementation
of Kubernetes Services, such as kube-proxy, and the configured networking
plugin, and potentially other networking components like service mesh
controllers and DNS servers, to ensure they can correctly handle traffic and
perform service discovery with the new IP family configuration.</li><li><strong>Managing existing Services:</strong> Services with IPs from the old CIDR need to
be addressed if they are not within the new configured ranges. Options
include recreation (leading to downtime and new IP assignments) or
potentially more complex reconfiguration strategies.</li><li><strong>Recreating internal Kubernetes services:</strong> The <code>kubernetes.default</code>
Service must be deleted and recreated to obtain an IP address from the new
ServiceCIDR if the primary IP family is changed or replaced by a different
network.</li></ol><h3 id="illustrative-reconfiguration-steps">Illustrative Reconfiguration Steps</h3><p>The following steps describe a controlled reconfiguration focusing on the
complete replacement of the default ServiceCIDR and the recreation of the
<code>kubernetes.default</code> Service:</p><ol><li>Start the kube-apiserver with the initial <code>--service-cluster-ip-range</code>.</li><li>Create initial Services that obtain IPs from this range.</li><li>Introduce a new ServiceCIDR as a temporary target for reconfiguration.</li><li>Mark the <code>kubernetes</code> default ServiceCIDR for deletion (it will remain
pending due to existing IPs and finalizers). This prevents new allocations
from the old range.</li><li>Recreate existing Services. They should now be allocated IPs from the new,
temporary ServiceCIDR.</li><li>Restart the kube-apiserver with the new ServiceCIDR(s) configured and shut
down the old instance.</li><li>Delete the <code>kubernetes.default</code> Service. The new kube-apiserver will
recreate it within the new ServiceCIDR.</li></ol><h2 id="what-s-next">What's next</h2><ul><li><a href="/docs/concepts/cluster-administration/networking/">Kubernetes Networking Concepts</a></li><li><a href="/docs/concepts/services-networking/dual-stack/">Kubernetes Dual-Stack Services</a></li><li><a href="/docs/tasks/network/extend-service-ip-ranges/">Extending Kubernetes Service IP Ranges</a></li></ul></div>