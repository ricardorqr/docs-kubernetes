<div class="td-content"><h1 data-pagefind-weight="10">StatefulSet Basics</h1><p>This tutorial provides an introduction to managing applications with
<a class="glossary-tooltip" title="A StatefulSet manages deployment and scaling of a set of Pods, with durable storage and persistent identifiers for each Pod." data-toggle="tooltip" data-placement="top" href="/docs/concepts/workloads/controllers/statefulset/" target="_blank" aria-label="StatefulSets">StatefulSets</a>.
It demonstrates how to create, delete, scale, and update the Pods of StatefulSets.</p><h2 id="before-you-begin">Before you begin</h2><p>Before you begin this tutorial, you should familiarize yourself with the
following Kubernetes concepts:</p><ul><li><a href="/docs/concepts/workloads/pods/">Pods</a></li><li><a href="/docs/concepts/services-networking/dns-pod-service/">Cluster DNS</a></li><li><a href="/docs/concepts/services-networking/service/#headless-services">Headless Services</a></li><li><a href="/docs/concepts/storage/persistent-volumes/">PersistentVolumes</a></li><li>The <a href="/docs/reference/kubectl/kubectl/">kubectl</a> command line tool</li></ul><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul><p>You should configure <code>kubectl</code> to use a context that uses the <code>default</code>
namespace.
If you are using an existing cluster, make sure that it's OK to use that
cluster's default namespace to practice. Ideally, practice in a cluster
that doesn't run any real workloads.</p><p>It's also useful to read the concept page about <a href="/docs/concepts/workloads/controllers/statefulset/">StatefulSets</a>.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>This tutorial assumes that your cluster is configured to dynamically provision
PersistentVolumes. You'll also need to have a <a href="/docs/concepts/storage/storage-classes/#default-storageclass">default StorageClass</a>.
If your cluster is not configured to provision storage dynamically, you
will have to manually provision two 1 GiB volumes prior to starting this
tutorial and
set up your cluster so that those PersistentVolumes map to the
PersistentVolumeClaim templates that the StatefulSet defines.</div><h2 id="objectives">Objectives</h2><p>StatefulSets are intended to be used with stateful applications and distributed
systems. However, the administration of stateful applications and
distributed systems on Kubernetes is a broad, complex topic. In order to
demonstrate the basic features of a StatefulSet, and not to conflate the former
topic with the latter, you will deploy a simple web application using a StatefulSet.</p><p>After this tutorial, you will be familiar with the following.</p><ul><li>How to create a StatefulSet</li><li>How a StatefulSet manages its Pods</li><li>How to delete a StatefulSet</li><li>How to scale a StatefulSet</li><li>How to update a StatefulSet's Pods</li></ul><h2 id="creating-a-statefulset">Creating a StatefulSet</h2><p>Begin by creating a StatefulSet (and the Service that it relies upon) using
the example below. It is similar to the example presented in the
<a href="/docs/concepts/workloads/controllers/statefulset/">StatefulSets</a> concept.
It creates a <a href="/docs/concepts/services-networking/service/#headless-services">headless Service</a>,
<code>nginx</code>, to publish the IP addresses of Pods in the StatefulSet, <code>web</code>.</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/web/web.yaml" download="application/web/web.yaml"><code>application/web/web.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;application-web-web-yaml&quot;)" title="Copy application/web/web.yaml to clipboard"/></div><div class="includecode" id="application-web-web-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Service<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">port</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>web<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">clusterIP</span>:<span style="color:#bbb"> </span>None<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#00f;font-weight:700">---</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>StatefulSet<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>web<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">serviceName</span>:<span style="color:#bbb"> </span><span style="color:#b44">"nginx"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">2</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>registry.k8s.io/nginx-slim:0.21<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>web<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">volumeMounts</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>www<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span>/usr/share/nginx/html<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">volumeClaimTemplates</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>www<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">accessModes</span>:<span style="color:#bbb"> </span>[<span style="color:#bbb"> </span><span style="color:#b44">"ReadWriteOnce"</span><span style="color:#bbb"> </span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">requests</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">storage</span>:<span style="color:#bbb"> </span>1Gi<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>You will need to use at least two terminal windows. In the first terminal, use
<a href="/docs/reference/generated/kubectl/kubectl-commands/#get"><code>kubectl get</code></a> to <a class="glossary-tooltip" title="A verb that is used to track changes to an object in Kubernetes as a stream." data-toggle="tooltip" data-placement="top" href="/docs/reference/using-api/api-concepts/#api-verbs" target="_blank" aria-label="watch">watch</a> the creation
of the StatefulSet's Pods.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># use this terminal to run commands that specify --watch</span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># end this watch when you are asked to start a new watch</span>
</span></span><span style="display:flex"><span>kubectl get pods --watch -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>nginx
</span></span></code></pre></div><p>In the second terminal, use
<a href="/docs/reference/generated/kubectl/kubectl-commands/#apply"><code>kubectl apply</code></a> to create the
headless Service and StatefulSet:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f https://k8s.io/examples/application/web/web.yaml
</span></span></code></pre></div><pre tabindex="0"><code>service/nginx created
statefulset.apps/web created
</code></pre><p>The command above creates two Pods, each running an
<a href="https://www.nginx.com">NGINX</a> webserver. Get the <code>nginx</code> Service...</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get service nginx
</span></span></code></pre></div><pre tabindex="0"><code>NAME      TYPE         CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
nginx     ClusterIP    None         &lt;none&gt;        80/TCP    12s
</code></pre><p>...then get the <code>web</code> StatefulSet, to verify that both were created successfully:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get statefulset web
</span></span></code></pre></div><pre tabindex="0"><code>NAME   READY   AGE
web    2/2     37s
</code></pre><h3 id="ordered-pod-creation">Ordered Pod creation</h3><p>A StatefulSet defaults to creating its Pods in a strict order.</p><p>For a StatefulSet with <em>n</em> replicas, when Pods are being deployed, they are
created sequentially, ordered from <em>{0..n-1}</em>. Examine the output of the
<code>kubectl get</code> command in the first terminal. Eventually, the output will
look like the example below.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Do not start a new watch;</span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># this should already be running</span>
</span></span><span style="display:flex"><span>kubectl get pods --watch -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>nginx
</span></span></code></pre></div><pre tabindex="0"><code>NAME      READY     STATUS    RESTARTS   AGE
web-0     0/1       Pending   0          0s
web-0     0/1       Pending   0         0s
web-0     0/1       ContainerCreating   0         0s
web-0     1/1       Running   0         19s
web-1     0/1       Pending   0         0s
web-1     0/1       Pending   0         0s
web-1     0/1       ContainerCreating   0         0s
web-1     1/1       Running   0         18s
</code></pre><p>Notice that the <code>web-1</code> Pod is not launched until the <code>web-0</code> Pod is
<em>Running</em> (see <a href="/docs/concepts/workloads/pods/pod-lifecycle/#pod-phase">Pod Phase</a>)
and <em>Ready</em> (see <code>type</code> in <a href="/docs/concepts/workloads/pods/pod-lifecycle/#pod-conditions">Pod Conditions</a>).</p><p>Later in this tutorial you will practice <a href="#parallel-pod-management">parallel startup</a>.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>To configure the integer ordinal assigned to each Pod in a StatefulSet, see
<a href="/docs/concepts/workloads/controllers/statefulset/#start-ordinal">Start ordinal</a>.</div><h2 id="pods-in-a-statefulset">Pods in a StatefulSet</h2><p>Pods in a StatefulSet have a unique ordinal index and a stable network identity.</p><h3 id="examining-the-pod-s-ordinal-index">Examining the Pod's ordinal index</h3><p>Get the StatefulSet's Pods:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pods -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>nginx
</span></span></code></pre></div><pre tabindex="0"><code>NAME      READY     STATUS    RESTARTS   AGE
web-0     1/1       Running   0          1m
web-1     1/1       Running   0          1m
</code></pre><p>As mentioned in the <a href="/docs/concepts/workloads/controllers/statefulset/">StatefulSets</a>
concept, the Pods in a StatefulSet have a sticky, unique identity. This identity
is based on a unique ordinal index that is assigned to each Pod by the
StatefulSet <a class="glossary-tooltip" title="A control loop that watches the shared state of the cluster through the apiserver and makes changes attempting to move the current state towards the desired state." data-toggle="tooltip" data-placement="top" href="/docs/concepts/architecture/controller/" target="_blank" aria-label="controller">controller</a>.<br/>The Pods' names take the form <code>&lt;statefulset name&gt;-&lt;ordinal index&gt;</code>.
Since the <code>web</code> StatefulSet has two replicas, it creates two Pods, <code>web-0</code> and <code>web-1</code>.</p><h3 id="using-stable-network-identities">Using stable network identities</h3><p>Each Pod has a stable hostname based on its ordinal index. Use
<a href="/docs/reference/generated/kubectl/kubectl-commands/#exec"><code>kubectl exec</code></a> to execute the
<code>hostname</code> command in each Pod:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#a2f;font-weight:700">for</span> i in <span style="color:#666">0</span> 1; <span style="color:#a2f;font-weight:700">do</span> kubectl <span style="color:#a2f">exec</span> <span style="color:#b44">"web-</span><span style="color:#b8860b">$i</span><span style="color:#b44">"</span> -- sh -c <span style="color:#b44">'hostname'</span>; <span style="color:#a2f;font-weight:700">done</span>
</span></span></code></pre></div><pre tabindex="0"><code>web-0
web-1
</code></pre><p>Use <a href="/docs/reference/generated/kubectl/kubectl-commands/#run"><code>kubectl run</code></a> to execute
a container that provides the <code>nslookup</code> command from the <code>dnsutils</code> package.
Using <code>nslookup</code> on the Pods' hostnames, you can examine their in-cluster DNS
addresses:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl run -i --tty --image busybox:1.28 dns-test --restart<span style="color:#666">=</span>Never --rm
</span></span></code></pre></div><p>which starts a new shell. In that new shell, run:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Run this in the dns-test container shell</span>
</span></span><span style="display:flex"><span>nslookup web-0.nginx
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex="0"><code>Server:    10.0.0.10
Address 1: 10.0.0.10 kube-dns.kube-system.svc.cluster.local

Name:      web-0.nginx
Address 1: 10.244.1.6

nslookup web-1.nginx
Server:    10.0.0.10
Address 1: 10.0.0.10 kube-dns.kube-system.svc.cluster.local

Name:      web-1.nginx
Address 1: 10.244.2.6
</code></pre><p>(and now exit the container shell: <code>exit</code>)</p><p>The CNAME of the headless service points to SRV records (one for each Pod that
is Running and Ready). The SRV records point to A record entries that
contain the Pods' IP addresses.</p><p>In one terminal, watch the StatefulSet's Pods:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Start a new watch</span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># End this watch when you've seen that the delete is finished</span>
</span></span><span style="display:flex"><span>kubectl get pod --watch -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>nginx
</span></span></code></pre></div><p>In a second terminal, use
<a href="/docs/reference/generated/kubectl/kubectl-commands/#delete"><code>kubectl delete</code></a> to delete all
the Pods in the StatefulSet:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl delete pod -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>nginx
</span></span></code></pre></div><pre tabindex="0"><code>pod "web-0" deleted
pod "web-1" deleted
</code></pre><p>Wait for the StatefulSet to restart them, and for both Pods to transition to
Running and Ready:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># This should already be running</span>
</span></span><span style="display:flex"><span>kubectl get pod --watch -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>nginx
</span></span></code></pre></div><pre tabindex="0"><code>NAME      READY     STATUS              RESTARTS   AGE
web-0     0/1       ContainerCreating   0          0s
NAME      READY     STATUS    RESTARTS   AGE
web-0     1/1       Running   0          2s
web-1     0/1       Pending   0         0s
web-1     0/1       Pending   0         0s
web-1     0/1       ContainerCreating   0         0s
web-1     1/1       Running   0         34s
</code></pre><p>Use <code>kubectl exec</code> and <code>kubectl run</code> to view the Pods' hostnames and in-cluster
DNS entries. First, view the Pods' hostnames:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#a2f;font-weight:700">for</span> i in <span style="color:#666">0</span> 1; <span style="color:#a2f;font-weight:700">do</span> kubectl <span style="color:#a2f">exec</span> web-<span style="color:#b8860b">$i</span> -- sh -c <span style="color:#b44">'hostname'</span>; <span style="color:#a2f;font-weight:700">done</span>
</span></span></code></pre></div><pre tabindex="0"><code>web-0
web-1
</code></pre><p>then, run:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl run -i --tty --image busybox:1.28 dns-test --restart<span style="color:#666">=</span>Never --rm
</span></span></code></pre></div><p>which starts a new shell.<br/>In that new shell, run:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Run this in the dns-test container shell</span>
</span></span><span style="display:flex"><span>nslookup web-0.nginx
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex="0"><code>Server:    10.0.0.10
Address 1: 10.0.0.10 kube-dns.kube-system.svc.cluster.local

Name:      web-0.nginx
Address 1: 10.244.1.7

nslookup web-1.nginx
Server:    10.0.0.10
Address 1: 10.0.0.10 kube-dns.kube-system.svc.cluster.local

Name:      web-1.nginx
Address 1: 10.244.2.8
</code></pre><p>(and now exit the container shell: <code>exit</code>)</p><p>The Pods' ordinals, hostnames, SRV records, and A record names have not changed,
but the IP addresses associated with the Pods may have changed. In the cluster
used for this tutorial, they have. This is why it is important not to configure
other applications to connect to Pods in a StatefulSet by the IP address
of a particular Pod (it is OK to connect to Pods by resolving their hostname).</p><h4 id="discovery-for-specific-pods-in-a-statefulset">Discovery for specific Pods in a StatefulSet</h4><p>If you need to find and connect to the active members of a StatefulSet, you
should query the CNAME of the headless Service
(<code>nginx.default.svc.cluster.local</code>). The SRV records associated with the
CNAME will contain only the Pods in the StatefulSet that are Running and
Ready.</p><p>If your application already implements connection logic that tests for
liveness and readiness, you can use the SRV records of the Pods (
<code>web-0.nginx.default.svc.cluster.local</code>,
<code>web-1.nginx.default.svc.cluster.local</code>), as they are stable, and your
application will be able to discover the Pods' addresses when they transition
to Running and Ready.</p><p>If your application wants to find any healthy Pod in a StatefulSet,
and therefore does not need to track each specific Pod,
you could also connect to the IP address of a <code>type: ClusterIP</code> Service,
backed by the Pods in that StatefulSet. You can use the same Service that
tracks the StatefulSet (specified in the <code>serviceName</code> of the StatefulSet)
or a separate Service that selects the right set of Pods.</p><h3 id="writing-to-stable-storage">Writing to stable storage</h3><p>Get the PersistentVolumeClaims for <code>web-0</code> and <code>web-1</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pvc -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>nginx
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex="0"><code>NAME        STATUS    VOLUME                                     CAPACITY   ACCESSMODES   AGE
www-web-0   Bound     pvc-15c268c7-b507-11e6-932f-42010a800002   1Gi        RWO           48s
www-web-1   Bound     pvc-15c79307-b507-11e6-932f-42010a800002   1Gi        RWO           48s
</code></pre><p>The StatefulSet controller created two
<a class="glossary-tooltip" title="Claims storage resources defined in a PersistentVolume so that it can be mounted as a volume in a container." data-toggle="tooltip" data-placement="top" href="/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims" target="_blank" aria-label="PersistentVolumeClaims">PersistentVolumeClaims</a>
that are bound to two
<a class="glossary-tooltip" title="API object that represents a piece of storage in the cluster." data-toggle="tooltip" data-placement="top" href="/docs/concepts/storage/persistent-volumes/" target="_blank" aria-label="PersistentVolumes">PersistentVolumes</a>.</p><p>As the cluster used in this tutorial is configured to dynamically provision PersistentVolumes,
the PersistentVolumes were created and bound automatically.</p><p>The NGINX webserver, by default, serves an index file from
<code>/usr/share/nginx/html/index.html</code>. The <code>volumeMounts</code> field in the
StatefulSet's <code>spec</code> ensures that the <code>/usr/share/nginx/html</code> directory is
backed by a PersistentVolume.</p><p>Write the Pods' hostnames to their <code>index.html</code> files and verify that the NGINX
webservers serve the hostnames:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#a2f;font-weight:700">for</span> i in <span style="color:#666">0</span> 1; <span style="color:#a2f;font-weight:700">do</span> kubectl <span style="color:#a2f">exec</span> <span style="color:#b44">"web-</span><span style="color:#b8860b">$i</span><span style="color:#b44">"</span> -- sh -c <span style="color:#b44">'echo "$(hostname)" &gt; /usr/share/nginx/html/index.html'</span>; <span style="color:#a2f;font-weight:700">done</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#a2f;font-weight:700">for</span> i in <span style="color:#666">0</span> 1; <span style="color:#a2f;font-weight:700">do</span> kubectl <span style="color:#a2f">exec</span> -i -t <span style="color:#b44">"web-</span><span style="color:#b8860b">$i</span><span style="color:#b44">"</span> -- curl http://localhost/; <span style="color:#a2f;font-weight:700">done</span>
</span></span></code></pre></div><pre tabindex="0"><code>web-0
web-1
</code></pre><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4><p>If you instead see <strong>403 Forbidden</strong> responses for the above curl command,
you will need to fix the permissions of the directory mounted by the <code>volumeMounts</code>
(due to a <a href="https://github.com/kubernetes/kubernetes/issues/2630">bug when using hostPath volumes</a>),
by running:</p><p><code>for i in 0 1; do kubectl exec web-$i -- chmod 755 /usr/share/nginx/html; done</code></p><p>before retrying the <code>curl</code> command above.</p></div><p>In one terminal, watch the StatefulSet's Pods:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># End this watch when you've reached the end of the section.</span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># At the start of "Scaling a StatefulSet" you'll start a new watch.</span>
</span></span><span style="display:flex"><span>kubectl get pod --watch -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>nginx
</span></span></code></pre></div><p>In a second terminal, delete all of the StatefulSet's Pods:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl delete pod -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>nginx
</span></span></code></pre></div><pre tabindex="0"><code>pod "web-0" deleted
pod "web-1" deleted
</code></pre><p>Examine the output of the <code>kubectl get</code> command in the first terminal, and wait
for all of the Pods to transition to Running and Ready.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># This should already be running</span>
</span></span><span style="display:flex"><span>kubectl get pod --watch -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>nginx
</span></span></code></pre></div><pre tabindex="0"><code>NAME      READY     STATUS              RESTARTS   AGE
web-0     0/1       ContainerCreating   0          0s
NAME      READY     STATUS    RESTARTS   AGE
web-0     1/1       Running   0          2s
web-1     0/1       Pending   0         0s
web-1     0/1       Pending   0         0s
web-1     0/1       ContainerCreating   0         0s
web-1     1/1       Running   0         34s
</code></pre><p>Verify the web servers continue to serve their hostnames:</p><pre tabindex="0"><code>for i in 0 1; do kubectl exec -i -t "web-$i" -- curl http://localhost/; done
</code></pre><pre tabindex="0"><code>web-0
web-1
</code></pre><p>Even though <code>web-0</code> and <code>web-1</code> were rescheduled, they continue to serve their
hostnames because the PersistentVolumes associated with their
PersistentVolumeClaims are remounted to their <code>volumeMounts</code>. No matter what
node <code>web-0</code>and <code>web-1</code> are scheduled on, their PersistentVolumes will be
mounted to the appropriate mount points.</p><h2 id="scaling-a-statefulset">Scaling a StatefulSet</h2><p>Scaling a StatefulSet refers to increasing or decreasing the number of replicas
(horizontal scaling).
This is accomplished by updating the <code>replicas</code> field. You can use either
<a href="/docs/reference/generated/kubectl/kubectl-commands/#scale"><code>kubectl scale</code></a> or
<a href="/docs/reference/generated/kubectl/kubectl-commands/#patch"><code>kubectl patch</code></a> to scale a StatefulSet.</p><h3 id="scaling-up">Scaling up</h3><p>Scaling up means adding more replicas.
Provided that your app is able to distribute work across the StatefulSet, the new
larger set of Pods can perform more of that work.</p><p>In one terminal window, watch the Pods in the StatefulSet:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># If you already have a watch running, you can continue using that.</span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># Otherwise, start one.</span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># End this watch when there are 5 healthy Pods for the StatefulSet</span>
</span></span><span style="display:flex"><span>kubectl get pods --watch -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>nginx
</span></span></code></pre></div><p>In another terminal window, use <code>kubectl scale</code> to scale the number of replicas
to 5:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl scale sts web --replicas<span style="color:#666">=</span><span style="color:#666">5</span>
</span></span></code></pre></div><pre tabindex="0"><code>statefulset.apps/web scaled
</code></pre><p>Examine the output of the <code>kubectl get</code> command in the first terminal, and wait
for the three additional Pods to transition to Running and Ready.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># This should already be running</span>
</span></span><span style="display:flex"><span>kubectl get pod --watch -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>nginx
</span></span></code></pre></div><pre tabindex="0"><code>NAME      READY     STATUS    RESTARTS   AGE
web-0     1/1       Running   0          2h
web-1     1/1       Running   0          2h
NAME      READY     STATUS    RESTARTS   AGE
web-2     0/1       Pending   0          0s
web-2     0/1       Pending   0         0s
web-2     0/1       ContainerCreating   0         0s
web-2     1/1       Running   0         19s
web-3     0/1       Pending   0         0s
web-3     0/1       Pending   0         0s
web-3     0/1       ContainerCreating   0         0s
web-3     1/1       Running   0         18s
web-4     0/1       Pending   0         0s
web-4     0/1       Pending   0         0s
web-4     0/1       ContainerCreating   0         0s
web-4     1/1       Running   0         19s
</code></pre><p>The StatefulSet controller scaled the number of replicas. As with
<a href="#ordered-pod-creation">StatefulSet creation</a>, the StatefulSet controller
created each Pod sequentially with respect to its ordinal index, and it
waited for each Pod's predecessor to be Running and Ready before launching the
subsequent Pod.</p><h3 id="scaling-down">Scaling down</h3><p>Scaling down means reducing the number of replicas. For example, you
might do this because the level of traffic to a service has decreased,
and at the current scale there are idle resources.</p><p>In one terminal, watch the StatefulSet's Pods:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># End this watch when there are only 3 Pods for the StatefulSet</span>
</span></span><span style="display:flex"><span>kubectl get pod --watch -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>nginx
</span></span></code></pre></div><p>In another terminal, use <code>kubectl patch</code> to scale the StatefulSet back down to
three replicas:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl patch sts web -p <span style="color:#b44">'{"spec":{"replicas":3}}'</span>
</span></span></code></pre></div><pre tabindex="0"><code>statefulset.apps/web patched
</code></pre><p>Wait for <code>web-4</code> and <code>web-3</code> to transition to Terminating.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># This should already be running</span>
</span></span><span style="display:flex"><span>kubectl get pods --watch -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>nginx
</span></span></code></pre></div><pre tabindex="0"><code>NAME      READY     STATUS              RESTARTS   AGE
web-0     1/1       Running             0          3h
web-1     1/1       Running             0          3h
web-2     1/1       Running             0          55s
web-3     1/1       Running             0          36s
web-4     0/1       ContainerCreating   0          18s
NAME      READY     STATUS    RESTARTS   AGE
web-4     1/1       Running   0          19s
web-4     1/1       Terminating   0         24s
web-4     1/1       Terminating   0         24s
web-3     1/1       Terminating   0         42s
web-3     1/1       Terminating   0         42s
</code></pre><h3 id="ordered-pod-termination">Ordered Pod termination</h3><p>The control plane deleted one Pod at a time, in reverse order with respect
to its ordinal index, and it waited for each Pod to be completely shut down
before deleting the next one.</p><p>Get the StatefulSet's PersistentVolumeClaims:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pvc -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>nginx
</span></span></code></pre></div><pre tabindex="0"><code>NAME        STATUS    VOLUME                                     CAPACITY   ACCESSMODES   AGE
www-web-0   Bound     pvc-15c268c7-b507-11e6-932f-42010a800002   1Gi        RWO           13h
www-web-1   Bound     pvc-15c79307-b507-11e6-932f-42010a800002   1Gi        RWO           13h
www-web-2   Bound     pvc-e1125b27-b508-11e6-932f-42010a800002   1Gi        RWO           13h
www-web-3   Bound     pvc-e1176df6-b508-11e6-932f-42010a800002   1Gi        RWO           13h
www-web-4   Bound     pvc-e11bb5f8-b508-11e6-932f-42010a800002   1Gi        RWO           13h
</code></pre><p>There are still five PersistentVolumeClaims and five PersistentVolumes.
When exploring a Pod's <a href="#writing-to-stable-storage">stable storage</a>, you saw that
the PersistentVolumes mounted to the Pods of a StatefulSet are not deleted when the
StatefulSet's Pods are deleted. This is still true when Pod deletion is caused by
scaling the StatefulSet down.</p><h2 id="updating-statefulsets">Updating StatefulSets</h2><p>The StatefulSet controller supports automated updates. The
strategy used is determined by the <code>spec.updateStrategy</code> field of the
StatefulSet API object. This feature can be used to upgrade the container
images, resource requests and/or limits, labels, and annotations of the Pods in a
StatefulSet.</p><p>There are two valid update strategies, <code>RollingUpdate</code> (the default) and
<code>OnDelete</code>.</p><h3 id="rolling-update">RollingUpdate</h3><p>The <code>RollingUpdate</code> update strategy will update all Pods in a StatefulSet, in
reverse ordinal order, while respecting the StatefulSet guarantees.</p><p>You can split updates to a StatefulSet that uses the <code>RollingUpdate</code> strategy
into <em>partitions</em>, by specifying <code>.spec.updateStrategy.rollingUpdate.partition</code>.
You'll practice that later in this tutorial.</p><p>First, try a simple rolling update.</p><p>In one terminal window, patch the <code>web</code> StatefulSet to change the container
image again:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl patch statefulset web --type<span style="color:#666">=</span><span style="color:#b44">'json'</span> -p<span style="color:#666">=</span><span style="color:#b44">'[{"op": "replace", "path": "/spec/template/spec/containers/0/image", "value":"registry.k8s.io/nginx-slim:0.24"}]'</span>
</span></span></code></pre></div><pre tabindex="0"><code>statefulset.apps/web patched
</code></pre><p>In another terminal, watch the Pods in the StatefulSet:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># End this watch when the rollout is complete</span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic">#</span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># If you're not sure, leave it running one more minute</span>
</span></span><span style="display:flex"><span>kubectl get pod -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>nginx --watch
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex="0"><code>NAME      READY     STATUS    RESTARTS   AGE
web-0     1/1       Running   0          7m
web-1     1/1       Running   0          7m
web-2     1/1       Running   0          8m
web-2     1/1       Terminating   0         8m
web-2     1/1       Terminating   0         8m
web-2     0/1       Terminating   0         8m
web-2     0/1       Terminating   0         8m
web-2     0/1       Terminating   0         8m
web-2     0/1       Terminating   0         8m
web-2     0/1       Pending   0         0s
web-2     0/1       Pending   0         0s
web-2     0/1       ContainerCreating   0         0s
web-2     1/1       Running   0         19s
web-1     1/1       Terminating   0         8m
web-1     0/1       Terminating   0         8m
web-1     0/1       Terminating   0         8m
web-1     0/1       Terminating   0         8m
web-1     0/1       Pending   0         0s
web-1     0/1       Pending   0         0s
web-1     0/1       ContainerCreating   0         0s
web-1     1/1       Running   0         6s
web-0     1/1       Terminating   0         7m
web-0     1/1       Terminating   0         7m
web-0     0/1       Terminating   0         7m
web-0     0/1       Terminating   0         7m
web-0     0/1       Terminating   0         7m
web-0     0/1       Terminating   0         7m
web-0     0/1       Pending   0         0s
web-0     0/1       Pending   0         0s
web-0     0/1       ContainerCreating   0         0s
web-0     1/1       Running   0         10s
</code></pre><p>The Pods in the StatefulSet are updated in reverse ordinal order. The
StatefulSet controller terminates each Pod, and waits for it to transition to Running and
Ready prior to updating the next Pod. Note that, even though the StatefulSet
controller will not proceed to update the next Pod until its ordinal successor
is Running and Ready, it will restore any Pod that fails during the update to
that Pod's existing version.</p><p>Pods that have already received the update will be restored to the updated version,
and Pods that have not yet received the update will be restored to the previous
version. In this way, the controller attempts to continue to keep the application
healthy and the update consistent in the presence of intermittent failures.</p><p>Get the Pods to view their container images:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#a2f;font-weight:700">for</span> p in <span style="color:#666">0</span> <span style="color:#666">1</span> 2; <span style="color:#a2f;font-weight:700">do</span> kubectl get pod <span style="color:#b44">"web-</span><span style="color:#b8860b">$p</span><span style="color:#b44">"</span> --template <span style="color:#b44">'{{range $i, $c := .spec.containers}}{{$c.image}}{{end}}'</span>; echo; <span style="color:#a2f;font-weight:700">done</span>
</span></span></code></pre></div><pre tabindex="0"><code>registry.k8s.io/nginx-slim:0.24
registry.k8s.io/nginx-slim:0.24
registry.k8s.io/nginx-slim:0.24
</code></pre><p>All the Pods in the StatefulSet are now running the previous container image.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>You can also use <code>kubectl rollout status sts/&lt;name&gt;</code> to view
the status of a rolling update to a StatefulSet</div><h4 id="staging-an-update">Staging an update</h4><p>You can split updates to a StatefulSet that uses the <code>RollingUpdate</code> strategy
into <em>partitions</em>, by specifying <code>.spec.updateStrategy.rollingUpdate.partition</code>.</p><p>For more context, you can read <a href="/docs/concepts/workloads/controllers/statefulset/#partitions">Partitioned rolling updates</a>
in the StatefulSet concept page.</p><p>You can stage an update to a StatefulSet by using the <code>partition</code> field within
<code>.spec.updateStrategy.rollingUpdate</code>.
For this update, you will keep the existing Pods in the StatefulSet
unchanged whilst you change the pod template for the StatefulSet.
Then you - or, outside of a tutorial, some external automation - can
trigger that prepared update.</p><p>First, patch the <code>web</code> StatefulSet to add a partition to the <code>updateStrategy</code> field:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># The value of "partition" determines which ordinals a change applies to</span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># Make sure to use a number bigger than the last ordinal for the</span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># StatefulSet</span>
</span></span><span style="display:flex"><span>kubectl patch statefulset web -p <span style="color:#b44">'{"spec":{"updateStrategy":{"type":"RollingUpdate","rollingUpdate":{"partition":3}}}}'</span>
</span></span></code></pre></div><pre tabindex="0"><code>statefulset.apps/web patched
</code></pre><p>Patch the StatefulSet again to change the container image that this
StatefulSet uses:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl patch statefulset web --type<span style="color:#666">=</span><span style="color:#b44">'json'</span> -p<span style="color:#666">=</span><span style="color:#b44">'[{"op": "replace", "path": "/spec/template/spec/containers/0/image", "value":"registry.k8s.io/nginx-slim:0.21"}]'</span>
</span></span></code></pre></div><pre tabindex="0"><code>statefulset.apps/web patched
</code></pre><p>Delete a Pod in the StatefulSet:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl delete pod web-2
</span></span></code></pre></div><pre tabindex="0"><code>pod "web-2" deleted
</code></pre><p>Wait for the replacement <code>web-2</code> Pod to be Running and Ready:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># End the watch when you see that web-2 is healthy</span>
</span></span><span style="display:flex"><span>kubectl get pod -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>nginx --watch
</span></span></code></pre></div><pre tabindex="0"><code>NAME      READY     STATUS              RESTARTS   AGE
web-0     1/1       Running             0          4m
web-1     1/1       Running             0          4m
web-2     0/1       ContainerCreating   0          11s
web-2     1/1       Running   0         18s
</code></pre><p>Get the Pod's container image:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pod web-2 --template <span style="color:#b44">'{{range $i, $c := .spec.containers}}{{$c.image}}{{end}}'</span>
</span></span></code></pre></div><pre tabindex="0"><code>registry.k8s.io/nginx-slim:0.24
</code></pre><p>Notice that, even though the update strategy is <code>RollingUpdate</code> the StatefulSet
restored the Pod with the original container image. This is because the
ordinal of the Pod is less than the <code>partition</code> specified by the
<code>updateStrategy</code>.</p><h4 id="rolling-out-a-canary">Rolling out a canary</h4><p>You're now going to try a <a href="https://glossary.cncf.io/canary-deployment/">canary rollout</a>
of that staged change.</p><p>You can roll out a canary (to test the modified template) by decrementing the <code>partition</code>
you specified <a href="#staging-an-update">above</a>.</p><p>Patch the StatefulSet to decrement the partition:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># The value of "partition" should match the highest existing ordinal for</span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># the StatefulSet</span>
</span></span><span style="display:flex"><span>kubectl patch statefulset web -p <span style="color:#b44">'{"spec":{"updateStrategy":{"type":"RollingUpdate","rollingUpdate":{"partition":2}}}}'</span>
</span></span></code></pre></div><pre tabindex="0"><code>statefulset.apps/web patched
</code></pre><p>The control plane triggers replacement for <code>web-2</code> (implemented by
a graceful <strong>delete</strong> followed by creating a new Pod once the deletion
is complete).
Wait for the new <code>web-2</code> Pod to be Running and Ready.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># This should already be running</span>
</span></span><span style="display:flex"><span>kubectl get pod -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>nginx --watch
</span></span></code></pre></div><pre tabindex="0"><code>NAME      READY     STATUS              RESTARTS   AGE
web-0     1/1       Running             0          4m
web-1     1/1       Running             0          4m
web-2     0/1       ContainerCreating   0          11s
web-2     1/1       Running   0         18s
</code></pre><p>Get the Pod's container:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pod web-2 --template <span style="color:#b44">'{{range $i, $c := .spec.containers}}{{$c.image}}{{end}}'</span>
</span></span></code></pre></div><pre tabindex="0"><code>registry.k8s.io/nginx-slim:0.21
</code></pre><p>When you changed the <code>partition</code>, the StatefulSet controller automatically
updated the <code>web-2</code> Pod because the Pod's ordinal was greater than or equal to
the <code>partition</code>.</p><p>Delete the <code>web-1</code> Pod:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl delete pod web-1
</span></span></code></pre></div><pre tabindex="0"><code>pod "web-1" deleted
</code></pre><p>Wait for the <code>web-1</code> Pod to be Running and Ready.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># This should already be running</span>
</span></span><span style="display:flex"><span>kubectl get pod -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>nginx --watch
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex="0"><code>NAME      READY     STATUS        RESTARTS   AGE
web-0     1/1       Running       0          6m
web-1     0/1       Terminating   0          6m
web-2     1/1       Running       0          2m
web-1     0/1       Terminating   0         6m
web-1     0/1       Terminating   0         6m
web-1     0/1       Terminating   0         6m
web-1     0/1       Pending   0         0s
web-1     0/1       Pending   0         0s
web-1     0/1       ContainerCreating   0         0s
web-1     1/1       Running   0         18s
</code></pre><p>Get the <code>web-1</code> Pod's container image:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pod web-1 --template <span style="color:#b44">'{{range $i, $c := .spec.containers}}{{$c.image}}{{end}}'</span>
</span></span></code></pre></div><pre tabindex="0"><code>registry.k8s.io/nginx-slim:0.24
</code></pre><p><code>web-1</code> was restored to its original configuration because the Pod's ordinal
was less than the partition. When a partition is specified, all Pods with an
ordinal that is greater than or equal to the partition will be updated when the
StatefulSet's <code>.spec.template</code> is updated. If a Pod that has an ordinal less
than the partition is deleted or otherwise terminated, it will be restored to
its original configuration.</p><h4 id="phased-roll-outs">Phased roll outs</h4><p>You can perform a phased roll out (e.g. a linear, geometric, or exponential
roll out) using a partitioned rolling update in a similar manner to how you
rolled out a <a href="#rolling-out-a-canary">canary</a>. To perform a phased roll out, set
the <code>partition</code> to the ordinal at which you want the controller to pause the
update.</p><p>The partition is currently set to <code>2</code>. Set the partition to <code>0</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl patch statefulset web -p <span style="color:#b44">'{"spec":{"updateStrategy":{"type":"RollingUpdate","rollingUpdate":{"partition":0}}}}'</span>
</span></span></code></pre></div><pre tabindex="0"><code>statefulset.apps/web patched
</code></pre><p>Wait for all of the Pods in the StatefulSet to become Running and Ready.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># This should already be running</span>
</span></span><span style="display:flex"><span>kubectl get pod -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>nginx --watch
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex="0"><code>NAME      READY     STATUS              RESTARTS   AGE
web-0     1/1       Running             0          3m
web-1     0/1       ContainerCreating   0          11s
web-2     1/1       Running             0          2m
web-1     1/1       Running   0         18s
web-0     1/1       Terminating   0         3m
web-0     1/1       Terminating   0         3m
web-0     0/1       Terminating   0         3m
web-0     0/1       Terminating   0         3m
web-0     0/1       Terminating   0         3m
web-0     0/1       Terminating   0         3m
web-0     0/1       Pending   0         0s
web-0     0/1       Pending   0         0s
web-0     0/1       ContainerCreating   0         0s
web-0     1/1       Running   0         3s
</code></pre><p>Get the container image details for the Pods in the StatefulSet:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#a2f;font-weight:700">for</span> p in <span style="color:#666">0</span> <span style="color:#666">1</span> 2; <span style="color:#a2f;font-weight:700">do</span> kubectl get pod <span style="color:#b44">"web-</span><span style="color:#b8860b">$p</span><span style="color:#b44">"</span> --template <span style="color:#b44">'{{range $i, $c := .spec.containers}}{{$c.image}}{{end}}'</span>; echo; <span style="color:#a2f;font-weight:700">done</span>
</span></span></code></pre></div><pre tabindex="0"><code>registry.k8s.io/nginx-slim:0.21
registry.k8s.io/nginx-slim:0.21
registry.k8s.io/nginx-slim:0.21
</code></pre><p>By moving the <code>partition</code> to <code>0</code>, you allowed the StatefulSet to
continue the update process.</p><h3 id="on-delete">OnDelete</h3><p>You select this update strategy for a StatefulSet by setting the
<code>.spec.template.updateStrategy.type</code> to <code>OnDelete</code>.</p><p>Patch the <code>web</code> StatefulSet to use the <code>OnDelete</code> update strategy:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl patch statefulset web -p <span style="color:#b44">'{"spec":{"updateStrategy":{"type":"OnDelete", "rollingUpdate": null}}}'</span>
</span></span></code></pre></div><pre tabindex="0"><code>statefulset.apps/web patched
</code></pre><p>When you select this update strategy, the StatefulSet controller does not
automatically update Pods when a modification is made to the StatefulSet's
<code>.spec.template</code> field. You need to manage the rollout yourself - either
manually, or using separate automation.</p><h2 id="deleting-statefulsets">Deleting StatefulSets</h2><p>StatefulSet supports both <em>non-cascading</em> and <em>cascading</em> deletion. In a
non-cascading <strong>delete</strong>, the StatefulSet's Pods are not deleted when the
StatefulSet is deleted. In a cascading <strong>delete</strong>, both the StatefulSet and
its Pods are deleted.</p><p>Read <a href="/docs/tasks/administer-cluster/use-cascading-deletion/">Use Cascading Deletion in a Cluster</a>
to learn about cascading deletion generally.</p><h3 id="non-cascading-delete">Non-cascading delete</h3><p>In one terminal window, watch the Pods in the StatefulSet.</p><pre tabindex="0"><code># End this watch when there are no Pods for the StatefulSet
kubectl get pods --watch -l app=nginx
</code></pre><p>Use <a href="/docs/reference/generated/kubectl/kubectl-commands/#delete"><code>kubectl delete</code></a> to delete the
StatefulSet. Make sure to supply the <code>--cascade=orphan</code> parameter to the
command. This parameter tells Kubernetes to only delete the StatefulSet, and to
<strong>not</strong> delete any of its Pods.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl delete statefulset web --cascade<span style="color:#666">=</span>orphan
</span></span></code></pre></div><pre tabindex="0"><code>statefulset.apps "web" deleted
</code></pre><p>Get the Pods, to examine their status:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pods -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>nginx
</span></span></code></pre></div><pre tabindex="0"><code>NAME      READY     STATUS    RESTARTS   AGE
web-0     1/1       Running   0          6m
web-1     1/1       Running   0          7m
web-2     1/1       Running   0          5m
</code></pre><p>Even though <code>web</code> has been deleted, all of the Pods are still Running and Ready.
Delete <code>web-0</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl delete pod web-0
</span></span></code></pre></div><pre tabindex="0"><code>pod "web-0" deleted
</code></pre><p>Get the StatefulSet's Pods:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pods -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>nginx
</span></span></code></pre></div><pre tabindex="0"><code>NAME      READY     STATUS    RESTARTS   AGE
web-1     1/1       Running   0          10m
web-2     1/1       Running   0          7m
</code></pre><p>As the <code>web</code> StatefulSet has been deleted, <code>web-0</code> has not been relaunched.</p><p>In one terminal, watch the StatefulSet's Pods.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Leave this watch running until the next time you start a watch</span>
</span></span><span style="display:flex"><span>kubectl get pods --watch -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>nginx
</span></span></code></pre></div><p>In a second terminal, recreate the StatefulSet. Note that, unless
you deleted the <code>nginx</code> Service (which you should not have), you will see
an error indicating that the Service already exists.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f https://k8s.io/examples/application/web/web.yaml
</span></span></code></pre></div><pre tabindex="0"><code>statefulset.apps/web created
service/nginx unchanged
</code></pre><p>Ignore the error. It only indicates that an attempt was made to create the <em>nginx</em>
headless Service even though that Service already exists.</p><p>Examine the output of the <code>kubectl get</code> command running in the first terminal.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># This should already be running</span>
</span></span><span style="display:flex"><span>kubectl get pods --watch -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>nginx
</span></span></code></pre></div><pre tabindex="0"><code>NAME      READY     STATUS    RESTARTS   AGE
web-1     1/1       Running   0          16m
web-2     1/1       Running   0          2m
NAME      READY     STATUS    RESTARTS   AGE
web-0     0/1       Pending   0          0s
web-0     0/1       Pending   0         0s
web-0     0/1       ContainerCreating   0         0s
web-0     1/1       Running   0         18s
web-2     1/1       Terminating   0         3m
web-2     0/1       Terminating   0         3m
web-2     0/1       Terminating   0         3m
web-2     0/1       Terminating   0         3m
</code></pre><p>When the <code>web</code> StatefulSet was recreated, it first relaunched <code>web-0</code>.
Since <code>web-1</code> was already Running and Ready, when <code>web-0</code> transitioned to
Running and Ready, it adopted this Pod. Since you recreated the StatefulSet
with <code>replicas</code> equal to 2, once <code>web-0</code> had been recreated, and once
<code>web-1</code> had been determined to already be Running and Ready, <code>web-2</code> was
terminated.</p><p>Now take another look at the contents of the <code>index.html</code> file served by the
Pods' webservers:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#a2f;font-weight:700">for</span> i in <span style="color:#666">0</span> 1; <span style="color:#a2f;font-weight:700">do</span> kubectl <span style="color:#a2f">exec</span> -i -t <span style="color:#b44">"web-</span><span style="color:#b8860b">$i</span><span style="color:#b44">"</span> -- curl http://localhost/; <span style="color:#a2f;font-weight:700">done</span>
</span></span></code></pre></div><pre tabindex="0"><code>web-0
web-1
</code></pre><p>Even though you deleted both the StatefulSet and the <code>web-0</code> Pod, it still
serves the hostname originally entered into its <code>index.html</code> file. This is
because the StatefulSet never deletes the PersistentVolumes associated with a
Pod. When you recreated the StatefulSet and it relaunched <code>web-0</code>, its original
PersistentVolume was remounted.</p><h3 id="cascading-delete">Cascading delete</h3><p>In one terminal window, watch the Pods in the StatefulSet.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Leave this running until the next page section</span>
</span></span><span style="display:flex"><span>kubectl get pods --watch -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>nginx
</span></span></code></pre></div><p>In another terminal, delete the StatefulSet again. This time, omit the
<code>--cascade=orphan</code> parameter.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl delete statefulset web
</span></span></code></pre></div><pre tabindex="0"><code>statefulset.apps "web" deleted
</code></pre><p>Examine the output of the <code>kubectl get</code> command running in the first terminal,
and wait for all of the Pods to transition to Terminating.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># This should already be running</span>
</span></span><span style="display:flex"><span>kubectl get pods --watch -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>nginx
</span></span></code></pre></div><pre tabindex="0"><code>NAME      READY     STATUS    RESTARTS   AGE
web-0     1/1       Running   0          11m
web-1     1/1       Running   0          27m
NAME      READY     STATUS        RESTARTS   AGE
web-0     1/1       Terminating   0          12m
web-1     1/1       Terminating   0         29m
web-0     0/1       Terminating   0         12m
web-0     0/1       Terminating   0         12m
web-0     0/1       Terminating   0         12m
web-1     0/1       Terminating   0         29m
web-1     0/1       Terminating   0         29m
web-1     0/1       Terminating   0         29m
</code></pre><p>As you saw in the <a href="#scaling-down">Scaling Down</a> section, the Pods
are terminated one at a time, with respect to the reverse order of their ordinal
indices. Before terminating a Pod, the StatefulSet controller waits for
the Pod's successor to be completely terminated.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>Although a cascading delete removes a StatefulSet together with its Pods,
the cascade does <strong>not</strong> delete the headless Service associated with the StatefulSet.
You must delete the <code>nginx</code> Service manually.</div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl delete service nginx
</span></span></code></pre></div><pre tabindex="0"><code>service "nginx" deleted
</code></pre><p>Recreate the StatefulSet and headless Service one more time:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f https://k8s.io/examples/application/web/web.yaml
</span></span></code></pre></div><pre tabindex="0"><code>service/nginx created
statefulset.apps/web created
</code></pre><p>When all of the StatefulSet's Pods transition to Running and Ready, retrieve
the contents of their <code>index.html</code> files:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#a2f;font-weight:700">for</span> i in <span style="color:#666">0</span> 1; <span style="color:#a2f;font-weight:700">do</span> kubectl <span style="color:#a2f">exec</span> -i -t <span style="color:#b44">"web-</span><span style="color:#b8860b">$i</span><span style="color:#b44">"</span> -- curl http://localhost/; <span style="color:#a2f;font-weight:700">done</span>
</span></span></code></pre></div><pre tabindex="0"><code>web-0
web-1
</code></pre><p>Even though you completely deleted the StatefulSet, and all of its Pods, the
Pods are recreated with their PersistentVolumes mounted, and <code>web-0</code> and
<code>web-1</code> continue to serve their hostnames.</p><p>Finally, delete the <code>nginx</code> Service...</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl delete service nginx
</span></span></code></pre></div><pre tabindex="0"><code>service "nginx" deleted
</code></pre><p>...and the <code>web</code> StatefulSet:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl delete statefulset web
</span></span></code></pre></div><pre tabindex="0"><code>statefulset "web" deleted
</code></pre><h2 id="pod-management-policy">Pod management policy</h2><p>For some distributed systems, the StatefulSet ordering guarantees are
unnecessary and/or undesirable. These systems require only uniqueness and
identity.</p><p>You can specify a <a href="/docs/concepts/workloads/controllers/statefulset/#pod-management-policies">Pod management policy</a>
to avoid this strict ordering; either <code>OrderedReady</code> (the default), or <code>Parallel</code>.</p><h3 id="orderedready-pod-management">OrderedReady Pod management</h3><p><code>OrderedReady</code> pod management is the default for StatefulSets. It tells the
StatefulSet controller to respect the ordering guarantees demonstrated
above.</p><p>Use this when your application requires or expects that changes, such as rolling out a new
version of your application, happen in the strict order of the ordinal (pod number) that the StatefulSet provides.
In other words, if you have Pods <code>app-0</code>, <code>app-1</code> and <code>app-2</code>, Kubernetes will update <code>app-0</code> first and check it.
Once the checks are good, Kubernetes updates <code>app-1</code> and finally <code>app-2</code>.</p><p>If you added two more Pods, Kubernetes would set up <code>app-3</code> and wait for that to become healthy before deploying
<code>app-4</code>.</p><p>Because this is the default setting, you've already practised using it.</p><h3 id="parallel-pod-management">Parallel Pod management</h3><p>The alternative, <code>Parallel</code> pod management, tells the StatefulSet controller to launch or
terminate all Pods in parallel, and not to wait for Pods to become <code>Running</code>
and <code>Ready</code> or completely terminated prior to launching or terminating another
Pod.</p><p>The <code>Parallel</code> pod management option only affects the behavior for scaling operations. Updates are not affected;
Kubernetes still rolls out changes in order. For this tutorial, the application is very simple: a webserver that
tells you its hostname (because this is a StatefulSet, the hostname for each Pod is different and predictable).</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/web/web-parallel.yaml" download="application/web/web-parallel.yaml"><code>application/web/web-parallel.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;application-web-web-parallel-yaml&quot;)" title="Copy application/web/web-parallel.yaml to clipboard"/></div><div class="includecode" id="application-web-web-parallel-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Service<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">port</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>web<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">clusterIP</span>:<span style="color:#bbb"> </span>None<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#00f;font-weight:700">---</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>StatefulSet<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>web<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">serviceName</span>:<span style="color:#bbb"> </span><span style="color:#b44">"nginx"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">podManagementPolicy</span>:<span style="color:#bbb"> </span><span style="color:#b44">"Parallel"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">2</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>registry.k8s.io/nginx-slim:0.24<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>web<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">volumeMounts</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>www<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span>/usr/share/nginx/html<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">volumeClaimTemplates</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>www<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">accessModes</span>:<span style="color:#bbb"> </span>[<span style="color:#bbb"> </span><span style="color:#b44">"ReadWriteOnce"</span><span style="color:#bbb"> </span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">requests</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">storage</span>:<span style="color:#bbb"> </span>1Gi<span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>This manifest is identical to the one you downloaded above except that the <code>.spec.podManagementPolicy</code>
of the <code>web</code> StatefulSet is set to <code>Parallel</code>.</p><p>In one terminal, watch the Pods in the StatefulSet.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Leave this watch running until the end of the section</span>
</span></span><span style="display:flex"><span>kubectl get pod -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>nginx --watch
</span></span></code></pre></div><p>In another terminal, reconfigure the StatefulSet for <code>Parallel</code> Pod management:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f https://k8s.io/examples/application/web/web-parallel.yaml
</span></span></code></pre></div><pre tabindex="0"><code>service/nginx updated
statefulset.apps/web updated
</code></pre><p>Keep the terminal open where you're running the watch. In another terminal window, scale the
StatefulSet:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl scale statefulset/web --replicas<span style="color:#666">=</span><span style="color:#666">5</span>
</span></span></code></pre></div><pre tabindex="0"><code>statefulset.apps/web scaled
</code></pre><p>Examine the output of the terminal where the <code>kubectl get</code> command is running. It may look something like</p><pre tabindex="0"><code>web-3     0/1       Pending   0         0s
web-3     0/1       Pending   0         0s
web-3     0/1       Pending   0         7s
web-3     0/1       ContainerCreating   0         7s
web-2     0/1       Pending   0         0s
web-4     0/1       Pending   0         0s
web-2     1/1       Running   0         8s
web-4     0/1       ContainerCreating   0         4s
web-3     1/1       Running   0         26s
web-4     1/1       Running   0         2s
</code></pre><p>The StatefulSet launched three new Pods, and it did not wait for
the first to become Running and Ready prior to launching the second and third Pods.</p><p>This approach is useful if your workload has a stateful element, or needs Pods to be able to identify each other
with predictable naming, and especially if you sometimes need to provide a lot more capacity quickly. If this
simple web service for the tutorial suddenly got an extra 1,000,000 requests per minute then you would want to run
some more Pods - but you also would not want to wait for each new Pod to launch. Starting the extra Pods in parallel
cuts the time between requesting the extra capacity and having it available for use.</p><h2 id="cleaning-up">Cleaning up</h2><p>You should have two terminals open, ready for you to run <code>kubectl</code> commands as
part of cleanup.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl delete sts web
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># sts is an abbreviation for statefulset</span>
</span></span></code></pre></div><p>You can watch <code>kubectl get</code> to see those Pods being deleted.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># end the watch when you've seen what you need to</span>
</span></span><span style="display:flex"><span>kubectl get pod -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>nginx --watch
</span></span></code></pre></div><pre tabindex="0"><code>web-3     1/1       Terminating   0         9m
web-2     1/1       Terminating   0         9m
web-3     1/1       Terminating   0         9m
web-2     1/1       Terminating   0         9m
web-1     1/1       Terminating   0         44m
web-0     1/1       Terminating   0         44m
web-0     0/1       Terminating   0         44m
web-3     0/1       Terminating   0         9m
web-2     0/1       Terminating   0         9m
web-1     0/1       Terminating   0         44m
web-0     0/1       Terminating   0         44m
web-2     0/1       Terminating   0         9m
web-2     0/1       Terminating   0         9m
web-2     0/1       Terminating   0         9m
web-1     0/1       Terminating   0         44m
web-1     0/1       Terminating   0         44m
web-1     0/1       Terminating   0         44m
web-0     0/1       Terminating   0         44m
web-0     0/1       Terminating   0         44m
web-0     0/1       Terminating   0         44m
web-3     0/1       Terminating   0         9m
web-3     0/1       Terminating   0         9m
web-3     0/1       Terminating   0         9m
</code></pre><p>During deletion, a StatefulSet removes all Pods concurrently; it does not wait for
a Pod's ordinal successor to terminate prior to deleting that Pod.</p><p>Close the terminal where the <code>kubectl get</code> command is running and delete the <code>nginx</code>
Service:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl delete svc nginx
</span></span></code></pre></div><p>Delete the persistent storage media for the PersistentVolumes used in this tutorial.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pvc
</span></span></code></pre></div><pre tabindex="0"><code>NAME        STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
www-web-0   Bound    pvc-2bf00408-d366-4a12-bad0-1869c65d0bee   1Gi        RWO            standard       25m
www-web-1   Bound    pvc-ba3bfe9c-413e-4b95-a2c0-3ea8a54dbab4   1Gi        RWO            standard       24m
www-web-2   Bound    pvc-cba6cfa6-3a47-486b-a138-db5930207eaf   1Gi        RWO            standard       15m
www-web-3   Bound    pvc-0c04d7f0-787a-4977-8da3-d9d3a6d8d752   1Gi        RWO            standard       15m
www-web-4   Bound    pvc-b2c73489-e70b-4a4e-9ec1-9eab439aa43e   1Gi        RWO            standard       14m
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pv
</span></span></code></pre></div><pre tabindex="0"><code>NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM               STORAGECLASS   REASON   AGE
pvc-0c04d7f0-787a-4977-8da3-d9d3a6d8d752   1Gi        RWO            Delete           Bound    default/www-web-3   standard                15m
pvc-2bf00408-d366-4a12-bad0-1869c65d0bee   1Gi        RWO            Delete           Bound    default/www-web-0   standard                25m
pvc-b2c73489-e70b-4a4e-9ec1-9eab439aa43e   1Gi        RWO            Delete           Bound    default/www-web-4   standard                14m
pvc-ba3bfe9c-413e-4b95-a2c0-3ea8a54dbab4   1Gi        RWO            Delete           Bound    default/www-web-1   standard                24m
pvc-cba6cfa6-3a47-486b-a138-db5930207eaf   1Gi        RWO            Delete           Bound    default/www-web-2   standard                15m
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl delete pvc www-web-0 www-web-1 www-web-2 www-web-3 www-web-4
</span></span></code></pre></div><pre tabindex="0"><code>persistentvolumeclaim "www-web-0" deleted
persistentvolumeclaim "www-web-1" deleted
persistentvolumeclaim "www-web-2" deleted
persistentvolumeclaim "www-web-3" deleted
persistentvolumeclaim "www-web-4" deleted
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pvc
</span></span></code></pre></div><pre tabindex="0"><code>No resources found in default namespace.
</code></pre><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>You also need to delete the persistent storage media for the PersistentVolumes
used in this tutorial.
Follow the necessary steps, based on your environment, storage configuration,
and provisioning method, to ensure that all storage is reclaimed.</div></div>