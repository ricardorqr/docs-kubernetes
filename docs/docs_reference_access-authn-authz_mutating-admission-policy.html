<div class="td-content"><h1 data-pagefind-weight="10">Mutating Admission Policy</h1><div class="feature-state-notice feature-beta"><span class="feature-state-name">FEATURE STATE:</span>
<code>Kubernetes v1.34 [beta]</code></div><p>This page provides an overview of <em>MutatingAdmissionPolicies</em>.
MutatingAdmissionPolicies allow you change what happens when someone writes a change to the Kubernetes API.
If you want to use declarative policies just to prevent a particular kind of change to resources (for example: protecting platform namespaces from deletion),
<a href="/docs/reference/access-authn-authz/validating-admission-policy/">ValidatingAdmissionPolicy</a>
is
a simpler and more effective alternative.</p><p>To use the feature, enable the <code>MutatingAdmissionPolicy</code> feature gate (which is off by default) and set <code>--runtime-config=admissionregistration.k8s.io/v1beta1=true</code> on the kube-apiserver.</p><h2 id="what-are-mutatingadmissionpolicies">What are MutatingAdmissionPolicies?</h2><p>Mutating admission policies offer a declarative, in-process alternative to mutating admission webhooks.</p><p>Mutating admission policies use the Common Expression Language (CEL) to declare mutations to resources.
Mutations can be defined either with an <em>apply configuration</em> that is merged using the
<a href="/docs/reference/using-api/server-side-apply/#merge-strategy">server side apply merge strategy</a>,
or a <a href="https://jsonpatch.com/">JSON patch</a>.</p><p>Mutating admission policies are highly configurable, enabling policy authors to define policies
that can be parameterized and scoped to resources as needed by cluster administrators.</p><h2 id="what-resources-make-a-policy">What resources make a policy</h2><p>A policy is generally made up of three resources:</p><ul><li><p>The MutatingAdmissionPolicy describes the abstract logic of a policy
(think: "this policy sets a particular label to a particular value").</p></li><li><p>A <em>parameter resource</em> provides information to a MutatingAdmissionPolicy to make it a concrete
statement (think "set the <code>owner</code> label to something like <code>company.example.com</code>").
Parameter resources refer to Kubernetes resources, available in the Kubernetes API. They can be built-in types or extensions,
such as a <a class="glossary-tooltip" title="Custom code that defines a resource to add to your Kubernetes API server without building a complete custom server." data-toggle="tooltip" data-placement="top" href="/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/" target="_blank" aria-label="CustomResourceDefinition">CustomResourceDefinition</a> (CRD). For example, you can use a ConfigMap as a parameter.</p></li><li><p>A MutatingAdmissionPolicyBinding links the above (MutatingAdmissionPolicy and parameter) resources together and provides scoping.
If you only want to set an <code>owner</code> label for <code>Pods</code>, and not other API kinds, the binding is where you
specify this mutation.</p></li></ul><p>At least a MutatingAdmissionPolicy and a corresponding MutatingAdmissionPolicyBinding
must be defined for a policy to have an effect.</p><p>If a MutatingAdmissionPolicy does not need to be configured via parameters, simply leave
<code>spec.paramKind</code> in MutatingAdmissionPolicy not specified.</p><h2 id="getting-started-with-mutatingadmissionpolicies">Getting Started with MutatingAdmissionPolicies</h2><p>Mutating admission policy is part of the cluster control-plane. You should write
and deploy them with great caution. The following describes how to quickly
experiment with Mutating admission policy.</p><h3 id="create-a-mutatingadmissionpolicy">Create a MutatingAdmissionPolicy</h3><p>The following is an example of a MutatingAdmissionPolicy. This policy mutates newly created Pods to have a sidecar container if it does not exist.</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/mutatingadmissionpolicy/applyconfiguration-example.yaml" download="mutatingadmissionpolicy/applyconfiguration-example.yaml"><code>mutatingadmissionpolicy/applyconfiguration-example.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;mutatingadmissionpolicy-applyconfiguration-example-yaml&quot;)" title="Copy mutatingadmissionpolicy/applyconfiguration-example.yaml to clipboard"/></div><div class="includecode" id="mutatingadmissionpolicy-applyconfiguration-example-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>admissionregistration.k8s.io/v1beta1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>MutatingAdmissionPolicy<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span><span style="color:#b44">"sidecar-policy.example.com"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">paramKind</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Sidecar<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>mutations.example.com/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">matchConstraints</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">resourceRules</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">apiGroups</span>:<span style="color:#bbb">   </span>[<span style="color:#b44">""</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">apiVersions</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"v1"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">operations</span>:<span style="color:#bbb">  </span>[<span style="color:#b44">"CREATE"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb">   </span>[<span style="color:#b44">"pods"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">matchConditions</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>does-not-already-have-sidecar<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">expression</span>:<span style="color:#bbb"> </span><span style="color:#b44">"!object.spec.initContainers.exists(ic, ic.name == \"mesh-proxy\")"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">failurePolicy</span>:<span style="color:#bbb"> </span>Fail<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">reinvocationPolicy</span>:<span style="color:#bbb"> </span>IfNeeded<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">mutations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">patchType</span>:<span style="color:#bbb"> </span><span style="color:#b44">"ApplyConfiguration"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">applyConfiguration</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">expression</span>:<span style="color:#bbb"> </span>&gt;<span style="color:#b44;font-style:italic">
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">          Object{
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">            spec: Object.spec{
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">              initContainers: [
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">                Object.spec.initContainers{
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">                  name: "mesh-proxy",
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">                  image: "mesh/proxy:v1.0.0",
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">                  args: ["proxy", "sidecar"],
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">                  restartPolicy: "Always"
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">                }
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">              ]
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">            }
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">          }</span><span style="color:#bbb">          
</span></span></span></code></pre></div></div></div><p>The <code>.spec.mutations</code> field consists of a list of expressions that evaluate to resource patches.
The emitted patches may be either <a href="#patch-type-apply-configuration">apply configurations</a> or <a href="#patch-type-json-patch">JSON Patch</a>
patches. You cannot specify an empty list of mutations. After evaluating all the
expressions, the API server applies those changes to the resource that is
passing through admission.</p><p>To configure a mutating admission policy for use in a cluster, a binding is
required. The MutatingAdmissionPolicy will only be active if a corresponding
binding exists with the referenced <code>spec.policyName</code> matching the <code>spec.name</code> of
a policy.</p><p>Once the binding and policy are created, any resource request that matches the
<code>spec.matchConditions</code> of a policy will trigger the set of mutations defined.</p><p>In the example above, creating a Pod will add the <code>mesh-proxy</code> initContainer mutation:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Pod<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>myapp<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">initContainers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>mesh-proxy<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>mesh/proxy:v1.0.0<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">args</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"proxy"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"sidecar"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">restartPolicy</span>:<span style="color:#bbb"> </span>Always<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>myapp-initializer<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>example/initializer:v1.0.0<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>...<span style="color:#bbb">
</span></span></span></code></pre></div><h4 id="parameter-resources">Parameter resources</h4><p>Parameter resources allow a policy configuration to be separate from its
definition. A policy can define <code>paramKind</code>, which outlines GVK of the parameter
resource, and then a policy binding ties a policy by name (via <code>policyName</code>) to a
particular parameter resource via <code>paramRef</code>.</p><p>Please refer to <a href="/docs/reference/access-authn-authz/validating-admission-policy/#parameter-resources">parameter resources</a> for more information.</p><h4 id="patch-type-apply-configuration"><code>ApplyConfiguration</code></h4><p>MutatingAdmissionPolicy expressions are always CEL. Each apply configuration
<code>expression</code> must evaluate to a CEL object (declared using <code>Object()</code>
initialization).</p><p>Apply configurations may not modify atomic structs, maps or arrays due to the risk of accidental deletion of
values not included in the apply configuration.</p><p>CEL expressions have access to the object types needed to create apply configurations:</p><ul><li><code>Object</code> - CEL type of the resource object.</li><li><code>Object.&lt;fieldName&gt;</code> - CEL type of object field (such as <code>Object.spec</code>)</li><li><code>Object.&lt;fieldName1&gt;.&lt;fieldName2&gt;...&lt;fieldNameN&gt;</code> - CEL type of nested field (such as <code>Object.spec.containers</code>)</li></ul><p>CEL expressions have access to the contents of the API request, organized into CEL variables as well as some other useful variables:</p><ul><li><code>object</code> - The object from the incoming request. The value is null for DELETE requests.</li><li><code>oldObject</code> - The existing object. The value is null for CREATE requests.</li><li><code>request</code> - Attributes of the API request.</li><li><code>params</code> - Parameter resource referred to by the policy binding being evaluated. Only populated if the policy has a ParamKind.</li><li><code>namespaceObject</code> - The namespace object that the incoming object belongs to. The value is null for cluster-scoped resources.</li><li><code>variables</code> - Map of composited variables, from its name to its lazily evaluated value.
For example, a variable named <code>foo</code> can be accessed as <code>variables.foo</code>.</li><li><code>authorizer</code> - A CEL Authorizer. May be used to perform authorization checks for the principal (user or service account) of the request.
See <a href="https://pkg.go.dev/k8s.io/apiserver/pkg/cel/library#Authz">https://pkg.go.dev/k8s.io/apiserver/pkg/cel/library#Authz</a></li><li><code>authorizer.requestResource</code> - A CEL ResourceCheck constructed from the <code>authorizer</code> and configured with the
request resource.</li></ul><p>The <code>apiVersion</code>, <code>kind</code>, <code>metadata.name</code>, <code>metadata.generateName</code> and <code>metadata.labels</code> are always accessible from the root of the<br/>object. No other metadata properties are accessible.</p><h4 id="patch-type-json-patch"><code>JSONPatch</code></h4><p>The same mutation can be written as a <a href="https://jsonpatch.com/">JSON Patch</a> as follows:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/mutatingadmissionpolicy/json-patch-example.yaml" download="mutatingadmissionpolicy/json-patch-example.yaml"><code>mutatingadmissionpolicy/json-patch-example.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;mutatingadmissionpolicy-json-patch-example-yaml&quot;)" title="Copy mutatingadmissionpolicy/json-patch-example.yaml to clipboard"/></div><div class="includecode" id="mutatingadmissionpolicy-json-patch-example-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>admissionregistration.k8s.io/v1beta1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>MutatingAdmissionPolicy<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span><span style="color:#b44">"sidecar-policy.example.com"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">paramKind</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Sidecar<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>mutations.example.com/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">matchConstraints</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">resourceRules</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">apiGroups</span>:<span style="color:#bbb">   </span>[<span style="color:#b44">""</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">apiVersions</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"v1"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">operations</span>:<span style="color:#bbb">  </span>[<span style="color:#b44">"CREATE"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb">   </span>[<span style="color:#b44">"pods"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">matchConditions</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>does-not-already-have-sidecar<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">expression</span>:<span style="color:#bbb"> </span><span style="color:#b44">"!object.spec.initContainers.exists(ic, ic.name == \"mesh-proxy\")"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">failurePolicy</span>:<span style="color:#bbb"> </span>Fail<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">reinvocationPolicy</span>:<span style="color:#bbb"> </span>IfNeeded<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">mutations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">patchType</span>:<span style="color:#bbb"> </span><span style="color:#b44">"JSONPatch"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">jsonPatch</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">expression</span>:<span style="color:#bbb"> </span>&gt;<span style="color:#b44;font-style:italic">
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">          [
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">            JSONPatch{
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">              op: "add", path: "/spec/initContainers/-",
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">              value: Object.spec.initContainers{
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">                name: "mesh-proxy",
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">                image: "mesh-proxy/v1.0.0",
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">                restartPolicy: "Always"
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">              }
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">            }
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">          ]</span><span style="color:#bbb">          
</span></span></span></code></pre></div></div></div><p>The expression will be evaluated by CEL to create a <a href="https://jsonpatch.com/">JSON patch</a>.
ref: <a href="https://github.com/google/cel-spec">https://github.com/google/cel-spec</a></p><p>Each evaluated <code>expression</code> must return an array of <code>JSONPatch</code> values. The<br/><code>JSONPatch</code> type represents one operation from a JSON patch.</p><p>For example, this CEL expression returns a JSON patch to conditionally modify a value:</p><pre tabindex="0"><code>  [
    JSONPatch{op: "test", path: "/spec/example", value: "Red"},
    JSONPatch{op: "replace", path: "/spec/example", value: "Green"}
  ]
</code></pre><p>To define a JSON object for the patch operation <code>value</code>, use CEL <code>Object</code> types. For example:</p><pre tabindex="0"><code>  [
    JSONPatch{
      op: "add",
      path: "/spec/selector",
      value: Object.spec.selector{matchLabels: {"environment": "test"}}
    }
  ]
</code></pre><p>To use strings containing '/' and '~' as JSONPatch path keys, use <code>jsonpatch.escapeKey()</code>. For example:</p><pre tabindex="0"><code>  [
    JSONPatch{
      op: "add",
      path: "/metadata/labels/" + jsonpatch.escapeKey("example.com/environment"),
      value: "test"
    },
  ]
</code></pre><p>CEL expressions have access to the types needed to create JSON patches and objects:</p><ul><li><code>JSONPatch</code> - CEL type of JSON Patch operations. JSONPatch has the fields <code>op</code>, <code>from</code>, <code>path</code> and <code>value</code>.
See <a href="https://jsonpatch.com/">JSON patch</a> for more details. The <code>value</code> field may be set to any of: string,
integer, array, map or object. If set, the <code>path</code> and <code>from</code> fields must be set to a
<a href="https://datatracker.ietf.org/doc/html/rfc6901/">JSON pointer</a> string, where the <code>jsonpatch.escapeKey()</code> CEL
function may be used to escape path keys containing <code>/</code> and <code>~</code>.</li><li><code>Object</code> - CEL type of the resource object.</li><li><code>Object.&lt;fieldName&gt;</code> - CEL type of object field (such as <code>Object.spec</code>)</li><li><code>Object.&lt;fieldName1&gt;.&lt;fieldName2&gt;...&lt;fieldNameN&gt;</code> - CEL type of nested field (such as <code>Object.spec.containers</code>)</li></ul><p>CEL expressions have access to the contents of the API request, organized into CEL variables as well as some other useful variables:</p><ul><li><code>object</code> - The object from the incoming request. The value is null for DELETE requests.</li><li><code>oldObject</code> - The existing object. The value is null for CREATE requests.</li><li><code>request</code> - Attributes of the API request.</li><li><code>params</code> - Parameter resource referred to by the policy binding being evaluated. Only populated if the policy has a ParamKind.</li><li><code>namespaceObject</code> - The namespace object that the incoming object belongs to. The value is null for cluster-scoped resources.</li><li><code>variables</code> - Map of composited variables, from its name to its lazily evaluated value.
For example, a variable named <code>foo</code> can be accessed as <code>variables.foo</code>.</li><li><code>authorizer</code> - A CEL Authorizer. May be used to perform authorization checks for the principal (user or service account) of the request.
See <a href="https://pkg.go.dev/k8s.io/apiserver/pkg/cel/library#Authz">https://pkg.go.dev/k8s.io/apiserver/pkg/cel/library#Authz</a></li><li><code>authorizer.requestResource</code> - A CEL ResourceCheck constructed from the <code>authorizer</code> and configured with the
request resource.</li></ul><p>CEL expressions have access to <a href="/docs/reference/using-api/cel/#cel-options-language-features-and-libraries">Kubernetes CEL function libraries</a>
as well as:</p><ul><li><code>jsonpatch.escapeKey</code> - Performs JSONPatch key escaping. <code>~</code> and <code>/</code> are escaped as <code>~0</code> and <code>~1</code> respectively.</li></ul><p>Only property names of the form <code>[a-zA-Z_.-/][a-zA-Z0-9_.-/]*</code> are accessible.</p><h2 id="api-kinds-exempt-from-mutating-admission">API kinds exempt from mutating admission</h2><p>There are certain API kinds that are exempt from admission-time mutation. For example, you can't create a MutatingAdmissionPolicy that changes a MutatingAdmissionPolicy.</p><p>The list of exempt API kinds is:</p><ul><li><a href="/docs/reference/kubernetes-api/policy-resources/validating-admission-policy-v1/">ValidatingAdmissionPolicies</a></li><li><a href="/docs/reference/kubernetes-api/policy-resources/validating-admission-policy-binding-v1/">ValidatingAdmissionPolicyBindings</a></li><li>MutatingAdmissionPolicies</li><li>MutatingAdmissionPolicyBindings</li><li><a href="/docs/reference/kubernetes-api/authentication-resources/token-review-v1/">TokenReviews</a></li><li><a href="/docs/reference/kubernetes-api/authorization-resources/local-subject-access-review-v1/">LocalSubjectAccessReviews</a></li><li><a href="/docs/reference/kubernetes-api/authorization-resources/self-subject-access-review-v1/">SelfSubjectAccessReviews</a></li><li><a href="/docs/reference/kubernetes-api/authentication-resources/self-subject-review-v1/">SelfSubjectReviews</a></li></ul></div>