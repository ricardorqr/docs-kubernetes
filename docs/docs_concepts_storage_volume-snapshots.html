<div class="td-content"><h1 data-pagefind-weight="10">Volume Snapshots</h1><p>In Kubernetes, a <em>VolumeSnapshot</em> represents a snapshot of a volume on a storage
system. This document assumes that you are already familiar with Kubernetes
<a href="/docs/concepts/storage/persistent-volumes/">persistent volumes</a>.</p><h2 id="introduction">Introduction</h2><p>Similar to how API resources <code>PersistentVolume</code> and <code>PersistentVolumeClaim</code> are
used to provision volumes for users and administrators, <code>VolumeSnapshotContent</code>
and <code>VolumeSnapshot</code> API resources are provided to create volume snapshots for
users and administrators.</p><p>A <code>VolumeSnapshotContent</code> is a snapshot taken from a volume in the cluster that
has been provisioned by an administrator. It is a resource in the cluster just
like a PersistentVolume is a cluster resource.</p><p>A <code>VolumeSnapshot</code> is a request for snapshot of a volume by a user. It is similar
to a PersistentVolumeClaim.</p><p><code>VolumeSnapshotClass</code> allows you to specify different attributes belonging to a
<code>VolumeSnapshot</code>. These attributes may differ among snapshots taken from the same
volume on the storage system and therefore cannot be expressed by using the same
<code>StorageClass</code> of a <code>PersistentVolumeClaim</code>.</p><p>Volume snapshots provide Kubernetes users with a standardized way to copy a volume's
contents at a particular point in time without creating an entirely new volume. This
functionality enables, for example, database administrators to backup databases before
performing edit or delete modifications.</p><p>Users need to be aware of the following when using this feature:</p><ul><li>API Objects <code>VolumeSnapshot</code>, <code>VolumeSnapshotContent</code>, and <code>VolumeSnapshotClass</code>
are <a class="glossary-tooltip" title="Custom code that defines a resource to add to your Kubernetes API server without building a complete custom server." data-toggle="tooltip" data-placement="top" href="/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/" target="_blank" aria-label="CRDs">CRDs</a>, not
part of the core API.</li><li><code>VolumeSnapshot</code> support is only available for CSI drivers.</li><li>As part of the deployment process of <code>VolumeSnapshot</code>, the Kubernetes team provides
a snapshot controller to be deployed into the control plane, and a sidecar helper
container called csi-snapshotter to be deployed together with the CSI driver.
The snapshot controller watches <code>VolumeSnapshot</code> and <code>VolumeSnapshotContent</code> objects
and is responsible for the creation and deletion of <code>VolumeSnapshotContent</code> object.
The sidecar csi-snapshotter watches <code>VolumeSnapshotContent</code> objects and triggers
<code>CreateSnapshot</code> and <code>DeleteSnapshot</code> operations against a CSI endpoint.</li><li>There is also a validating webhook server which provides tightened validation on
snapshot objects. This should be installed by the Kubernetes distros along with
the snapshot controller and CRDs, not CSI drivers. It should be installed in all
Kubernetes clusters that has the snapshot feature enabled.</li><li>CSI drivers may or may not have implemented the volume snapshot functionality.
The CSI drivers that have provided support for volume snapshot will likely use
the csi-snapshotter. See <a href="https://kubernetes-csi.github.io/docs/">CSI Driver documentation</a> for details.</li><li>The CRDs and snapshot controller installations are the responsibility of the Kubernetes distribution.</li></ul><p>For advanced use cases, such as creating group snapshots of multiple volumes, see the external
<a href="https://kubernetes-csi.github.io/docs/group-snapshot-restore-feature.html">CSI Volume Group Snapshot documentation</a>.</p><h2 id="lifecycle-of-a-volume-snapshot-and-volume-snapshot-content">Lifecycle of a volume snapshot and volume snapshot content</h2><p><code>VolumeSnapshotContents</code> are resources in the cluster. <code>VolumeSnapshots</code> are requests
for those resources. The interaction between <code>VolumeSnapshotContents</code> and <code>VolumeSnapshots</code>
follow this lifecycle:</p><h3 id="provisioning-volume-snapshot">Provisioning Volume Snapshot</h3><p>There are two ways snapshots may be provisioned: pre-provisioned or dynamically provisioned.</p><h4 id="static">Pre-provisioned</h4><p>A cluster administrator creates a number of <code>VolumeSnapshotContents</code>. They carry the details
of the real volume snapshot on the storage system which is available for use by cluster users.
They exist in the Kubernetes API and are available for consumption.</p><h4 id="dynamic">Dynamic</h4><p>Instead of using a pre-existing snapshot, you can request that a snapshot to be dynamically
taken from a PersistentVolumeClaim. The <a href="/docs/concepts/storage/volume-snapshot-classes/">VolumeSnapshotClass</a>
specifies storage provider-specific parameters to use when taking a snapshot.</p><h3 id="binding">Binding</h3><p>The snapshot controller handles the binding of a <code>VolumeSnapshot</code> object with an appropriate
<code>VolumeSnapshotContent</code> object, in both pre-provisioned and dynamically provisioned scenarios.
The binding is a one-to-one mapping.</p><p>In the case of pre-provisioned binding, the VolumeSnapshot will remain unbound until the
requested VolumeSnapshotContent object is created.</p><h3 id="persistent-volume-claim-as-snapshot-source-protection">Persistent Volume Claim as Snapshot Source Protection</h3><p>The purpose of this protection is to ensure that in-use
<a class="glossary-tooltip" title="Claims storage resources defined in a PersistentVolume so that it can be mounted as a volume in a container." data-toggle="tooltip" data-placement="top" href="/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims" target="_blank" aria-label="PersistentVolumeClaim">PersistentVolumeClaim</a>
API objects are not removed from the system while a snapshot is being taken from it
(as this may result in data loss).</p><p>While a snapshot is being taken of a PersistentVolumeClaim, that PersistentVolumeClaim
is in-use. If you delete a PersistentVolumeClaim API object in active use as a snapshot
source, the PersistentVolumeClaim object is not removed immediately. Instead, removal of
the PersistentVolumeClaim object is postponed until the snapshot is readyToUse or aborted.</p><h3 id="delete">Delete</h3><p>Deletion is triggered by deleting the <code>VolumeSnapshot</code> object, and the <code>DeletionPolicy</code>
will be followed. If the <code>DeletionPolicy</code> is <code>Delete</code>, then the underlying storage snapshot
will be deleted along with the <code>VolumeSnapshotContent</code> object. If the <code>DeletionPolicy</code> is
<code>Retain</code>, then both the underlying snapshot and <code>VolumeSnapshotContent</code> remain.</p><h2 id="volumesnapshots">VolumeSnapshots</h2><p>Each VolumeSnapshot contains a spec and a status.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>snapshot.storage.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>VolumeSnapshot<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>new-snapshot-test<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">volumeSnapshotClassName</span>:<span style="color:#bbb"> </span>csi-hostpath-snapclass<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">source</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">persistentVolumeClaimName</span>:<span style="color:#bbb"> </span>pvc-test<span style="color:#bbb">
</span></span></span></code></pre></div><p><code>persistentVolumeClaimName</code> is the name of the PersistentVolumeClaim data source
for the snapshot. This field is required for dynamically provisioning a snapshot.</p><p>A volume snapshot can request a particular class by specifying the name of a
<a href="/docs/concepts/storage/volume-snapshot-classes/">VolumeSnapshotClass</a>
using the attribute <code>volumeSnapshotClassName</code>. If nothing is set, then the
default class is used if available.</p><p>For pre-provisioned snapshots, you need to specify a <code>volumeSnapshotContentName</code>
as the source for the snapshot as shown in the following example. The
<code>volumeSnapshotContentName</code> source field is required for pre-provisioned snapshots.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>snapshot.storage.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>VolumeSnapshot<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>test-snapshot<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">source</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">volumeSnapshotContentName</span>:<span style="color:#bbb"> </span>test-content<span style="color:#bbb">
</span></span></span></code></pre></div><h2 id="volume-snapshot-contents">Volume Snapshot Contents</h2><p>Each VolumeSnapshotContent contains a spec and status. In dynamic provisioning,
the snapshot common controller creates <code>VolumeSnapshotContent</code> objects. Here is an example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>snapshot.storage.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>VolumeSnapshotContent<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>snapcontent-72d9a349-aacd-42d2-a240-d775650d2455<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">deletionPolicy</span>:<span style="color:#bbb"> </span>Delete<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">driver</span>:<span style="color:#bbb"> </span>hostpath.csi.k8s.io<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">source</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">volumeHandle</span>:<span style="color:#bbb"> </span>ee0cfb94-f8d4-11e9-b2d8-0242ac110002<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">sourceVolumeMode</span>:<span style="color:#bbb"> </span>Filesystem<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">volumeSnapshotClassName</span>:<span style="color:#bbb"> </span>csi-hostpath-snapclass<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">volumeSnapshotRef</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>new-snapshot-test<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">uid</span>:<span style="color:#bbb"> </span>72d9a349-aacd-42d2-a240-d775650d2455<span style="color:#bbb">
</span></span></span></code></pre></div><p><code>volumeHandle</code> is the unique identifier of the volume created on the storage
backend and returned by the CSI driver during the volume creation. This field
is required for dynamically provisioning a snapshot.
It specifies the volume source of the snapshot.</p><p>For pre-provisioned snapshots, you (as cluster administrator) are responsible
for creating the <code>VolumeSnapshotContent</code> object as follows.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>snapshot.storage.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>VolumeSnapshotContent<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>new-snapshot-content-test<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">deletionPolicy</span>:<span style="color:#bbb"> </span>Delete<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">driver</span>:<span style="color:#bbb"> </span>hostpath.csi.k8s.io<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">source</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">snapshotHandle</span>:<span style="color:#bbb"> </span>7bdd0de3-aaeb-11e8-9aae-0242ac110002<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">sourceVolumeMode</span>:<span style="color:#bbb"> </span>Filesystem<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">volumeSnapshotRef</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>new-snapshot-test<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span></span></span></code></pre></div><p><code>snapshotHandle</code> is the unique identifier of the volume snapshot created on
the storage backend. This field is required for the pre-provisioned snapshots.
It specifies the CSI snapshot id on the storage system that this
<code>VolumeSnapshotContent</code> represents.</p><p><code>sourceVolumeMode</code> is the mode of the volume whose snapshot is taken. The value
of the <code>sourceVolumeMode</code> field can be either <code>Filesystem</code> or <code>Block</code>. If the
source volume mode is not specified, Kubernetes treats the snapshot as if the
source volume's mode is unknown.</p><p><code>volumeSnapshotRef</code> is the reference of the corresponding <code>VolumeSnapshot</code>. Note that
when the <code>VolumeSnapshotContent</code> is being created as a pre-provisioned snapshot, the
<code>VolumeSnapshot</code> referenced in <code>volumeSnapshotRef</code> might not exist yet.</p><h2 id="convert-volume-mode">Converting the volume mode of a Snapshot</h2><p>If the <code>VolumeSnapshots</code> API installed on your cluster supports the <code>sourceVolumeMode</code>
field, then the API has the capability to prevent unauthorized users from converting
the mode of a volume.</p><p>To check if your cluster has capability for this feature, run the following command:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span>$ kubectl get crd volumesnapshotcontent -o yaml<span style="color:#bbb">
</span></span></span></code></pre></div><p>If you want to allow users to create a <code>PersistentVolumeClaim</code> from an existing
<code>VolumeSnapshot</code>, but with a different volume mode than the source, the annotation
<code>snapshot.storage.kubernetes.io/allow-volume-mode-change: "true"</code>needs to be added to
the <code>VolumeSnapshotContent</code> that corresponds to the <code>VolumeSnapshot</code>.</p><p>For pre-provisioned snapshots, <code>spec.sourceVolumeMode</code> needs to be populated
by the cluster administrator.</p><p>An example <code>VolumeSnapshotContent</code> resource with this feature enabled would look like:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>snapshot.storage.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>VolumeSnapshotContent<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>new-snapshot-content-test<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">annotations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">snapshot.storage.kubernetes.io/allow-volume-mode-change</span>:<span style="color:#bbb"> </span><span style="color:#b44">"true"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">deletionPolicy</span>:<span style="color:#bbb"> </span>Delete<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">driver</span>:<span style="color:#bbb"> </span>hostpath.csi.k8s.io<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">source</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">snapshotHandle</span>:<span style="color:#bbb"> </span>7bdd0de3-aaeb-11e8-9aae-0242ac110002<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">sourceVolumeMode</span>:<span style="color:#bbb"> </span>Filesystem<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">volumeSnapshotRef</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>new-snapshot-test<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span></span></span></code></pre></div><h2 id="provisioning-volumes-from-snapshots">Provisioning Volumes from Snapshots</h2><p>You can provision a new volume, pre-populated with data from a snapshot, by using
the <em>dataSource</em> field in the <code>PersistentVolumeClaim</code> object.</p><p>For more details, see
<a href="/docs/concepts/storage/persistent-volumes/#volume-snapshot-and-restore-volume-from-snapshot-support">Volume Snapshot and Restore Volume from Snapshot</a>.</p></div>