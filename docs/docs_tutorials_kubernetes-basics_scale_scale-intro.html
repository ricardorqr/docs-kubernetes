<div class="td-content"><h1 data-pagefind-weight="10">Running Multiple Instances of Your App</h1><h2 id="objectives">Objectives</h2><ul><li>Scale an existing app manually using kubectl.</li></ul><h2 id="scaling-an-application">Scaling an application</h2><div class="alert alert-primary" role="alert"><em>You can create from the start a Deployment with multiple instances using the --replicas
parameter for the kubectl create deployment command.</em></div><p>Previously we created a <a href="/docs/concepts/workloads/controllers/deployment/">Deployment</a>,
and then exposed it publicly via a <a href="/docs/concepts/services-networking/service/">Service</a>.
The Deployment created only one Pod for running our application. When traffic increases,
we will need to scale the application to keep up with user demand.</p><p>If you haven't worked through the earlier sections, start from
<a href="/docs/tutorials/kubernetes-basics/create-cluster/cluster-intro/">Using minikube to create a cluster</a>.</p><p><em>Scaling</em> is accomplished by changing the number of replicas in a Deployment.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4><p>If you are trying this after the
<a href="/docs/tutorials/kubernetes-basics/expose/expose-intro/">previous section</a>, then you
may have deleted the service you created, or have created a Service of <code>type: NodePort</code>.
In this section, it is assumed that a service with <code>type: LoadBalancer</code> is created
for the kubernetes-bootcamp Deployment.</p><p>If you have <em>not</em> deleted the Service created in
<a href="/docs/tutorials/kubernetes-basics/expose/expose-intro/">the previous section</a>,
first delete that Service and then run the following command to create a new Service
with its <code>type</code> set to <code>LoadBalancer</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl expose deployment/kubernetes-bootcamp --type<span style="color:#666">=</span><span style="color:#b44">"LoadBalancer"</span> --port <span style="color:#666">8080</span>
</span></span></code></pre></div></div><h2 id="scaling-overview">Scaling overview</h2><div class="col-md-8"><div id="myCarousel" class="carousel" data-ride="carousel" data-interval="3000"><div class="carousel-inner" role="listbox"><div class="item carousel-item active"><img src="/docs/tutorials/kubernetes-basics/public/images/module_05_scaling1.svg"/></div><div class="item carousel-item"><img src="/docs/tutorials/kubernetes-basics/public/images/module_05_scaling2.svg"/></div></div></div></div><div class="alert alert-primary" role="alert"><em>Scaling is accomplished by changing the number of replicas in a Deployment.</em></div><p>Scaling out a Deployment will ensure new Pods are created and scheduled to Nodes
with available resources. Scaling will increase the number of Pods to the new desired
state. Kubernetes also supports <a href="/docs/tasks/run-application/horizontal-pod-autoscale/">autoscaling</a>
of Pods, but it is outside of the scope of this tutorial. Scaling to zero is also
possible, and it will terminate all Pods of the specified Deployment.</p><p>Running multiple instances of an application will require a way to distribute the
traffic to all of them. Services have an integrated load-balancer that will distribute
network traffic to all Pods of an exposed Deployment. Services will monitor continuously
the running Pods using endpoints, to ensure the traffic is sent only to available Pods.</p><p>Once you have multiple instances of an application running, you would be able to
do Rolling updates without downtime. We'll cover that in the next section of the
tutorial. Now, let's go to the terminal and scale our application.</p><h3 id="scaling-a-deployment">Scaling a Deployment</h3><p>To list your Deployments, use the <code>get deployments</code> subcommand:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get deployments
</span></span></code></pre></div><p>The output should be similar to:</p><pre tabindex="0"><code>NAME                  READY   UP-TO-DATE   AVAILABLE   AGE
kubernetes-bootcamp   1/1     1            1           11m
</code></pre><p>We should have 1 Pod. If not, run the command again. This shows:</p><ul><li><em>NAME</em> lists the names of the Deployments in the cluster.</li><li><em>READY</em> shows the ratio of CURRENT/DESIRED replicas</li><li><em>UP-TO-DATE</em> displays the number of replicas that have been updated to achieve the desired state.</li><li><em>AVAILABLE</em> displays how many replicas of the application are available to your users.</li><li><em>AGE</em> displays the amount of time that the application has been running.</li></ul><p>To see the ReplicaSet created by the Deployment, run:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get rs
</span></span></code></pre></div><p>Notice that the name of the ReplicaSet is always formatted as
<nobr>[DEPLOYMENT-NAME]-[RANDOM-STRING]</nobr>.
The random string is randomly generated and uses the pod-template-hash as a seed.</p><p>Two important columns of this output are:</p><ul><li><em>DESIRED</em> displays the desired number of replicas of the application, which you
define when you create the Deployment. This is the desired state.</li><li><em>CURRENT</em> displays how many replicas are currently running.</li></ul><p>Next, let’s scale the Deployment to 4 replicas. We’ll use the <code>kubectl scale</code> command,
followed by the Deployment type, name and desired number of instances:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl scale deployments/kubernetes-bootcamp --replicas<span style="color:#666">=</span><span style="color:#666">4</span>
</span></span></code></pre></div><p>To list your Deployments once again, use <code>get deployments</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get deployments
</span></span></code></pre></div><p>The change was applied, and we have 4 instances of the application available. Next,
let’s check if the number of Pods changed:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pods -o wide
</span></span></code></pre></div><p>There are 4 Pods now, with different IP addresses. The change was registered in
the Deployment events log. To check that, use the <code>describe</code> subcommand:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl describe deployments/kubernetes-bootcamp
</span></span></code></pre></div><p>You can also view in the output of this command that there are 4 replicas now.</p><h3 id="load-balancing">Load Balancing</h3><p>Let's check that the Service is load-balancing the traffic. To find out the exposed
IP and Port we can use <code>describe service</code> as we learned in the previous part of the tutorial:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl describe services/kubernetes-bootcamp
</span></span></code></pre></div><p>Create an environment variable called NODE_PORT that has a value as the Node port:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#a2f">export</span> <span style="color:#b8860b">NODE_PORT</span><span style="color:#666">=</span><span style="color:#b44">"</span><span style="color:#a2f;font-weight:700">$(</span>kubectl get services/kubernetes-bootcamp -o go-template<span style="color:#666">=</span><span style="color:#b44">'{{(index .spec.ports 0).nodePort}}'</span><span style="color:#a2f;font-weight:700">)</span><span style="color:#b44">"</span>
</span></span><span style="display:flex"><span><span style="color:#a2f">echo</span> <span style="color:#b8860b">NODE_PORT</span><span style="color:#666">=</span><span style="color:#b8860b">$NODE_PORT</span>
</span></span></code></pre></div><p>Next, we’ll do a <code>curl</code> to the exposed IP address and port. Execute the command multiple times:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>curl http://<span style="color:#b44">"</span><span style="color:#a2f;font-weight:700">$(</span>minikube ip<span style="color:#a2f;font-weight:700">)</span><span style="color:#b44">:</span><span style="color:#b8860b">$NODE_PORT</span><span style="color:#b44">"</span>
</span></span></code></pre></div><p>We hit a different Pod with every request. This demonstrates that the load-balancing is working.</p><p>The output should be similar to:</p><pre tabindex="0"><code>Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-644c5687f4-wp67j | v=1
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-644c5687f4-hs9dj | v=1
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-644c5687f4-4hjvf | v=1
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-644c5687f4-wp67j | v=1
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-644c5687f4-4hjvf | v=1
</code></pre><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4><p>If you're running minikube with Docker Desktop as the container driver, a minikube
tunnel is needed. This is because containers inside Docker Desktop are isolated
from your host computer.</p><p>In a separate terminal window, execute:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>minikube service kubernetes-bootcamp --url
</span></span></code></pre></div><p>The output looks like this:</p><pre tabindex="0"><code>http://127.0.0.1:51082
!  Because you are using a Docker driver on darwin, the terminal needs to be open to run it.
</code></pre><p>Then use the given URL to access the app:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>curl 127.0.0.1:51082
</span></span></code></pre></div></div><h3 id="scale-down">Scale Down</h3><p>To scale down the Deployment to 2 replicas, run again the <code>scale</code> subcommand:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl scale deployments/kubernetes-bootcamp --replicas<span style="color:#666">=</span><span style="color:#666">2</span>
</span></span></code></pre></div><p>List the Deployments to check if the change was applied with the <code>get deployments</code> subcommand:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get deployments
</span></span></code></pre></div><p>The number of replicas decreased to 2. List the number of Pods, with <code>get pods</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pods -o wide
</span></span></code></pre></div><p>This confirms that 2 Pods were terminated.</p><h2 id="what-s-next">What's next</h2><ul><li>Tutorial
<a href="/docs/tutorials/kubernetes-basics/update/update-intro/">Performing a Rolling Update</a>.</li><li>Learn more about <a href="/docs/concepts/workloads/controllers/replicaset/">ReplicaSet</a>.</li><li>Learn more about <a href="/docs/concepts/workloads/autoscaling/">Autoscaling</a>.</li></ul></div>