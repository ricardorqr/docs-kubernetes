<div class="td-content"><h1 data-pagefind-weight="10">Configure Service Accounts for Pods</h1><p>Kubernetes offers two distinct ways for clients that run within your
cluster, or that otherwise have a relationship to your cluster's
<a class="glossary-tooltip" title="The container orchestration layer that exposes the API and interfaces to define, deploy, and manage the lifecycle of containers." data-toggle="tooltip" data-placement="top" href="/docs/reference/glossary/?all=true#term-control-plane" target="_blank" aria-label="control plane">control plane</a>
to authenticate to the
<a class="glossary-tooltip" title="Control plane component that serves the Kubernetes API." data-toggle="tooltip" data-placement="top" href="/docs/concepts/architecture/#kube-apiserver" target="_blank" aria-label="API server">API server</a>.</p><p>A <em>service account</em> provides an identity for processes that run in a Pod,
and maps to a ServiceAccount object. When you authenticate to the API
server, you identify yourself as a particular <em>user</em>. Kubernetes recognises
the concept of a user, however, Kubernetes itself does <strong>not</strong> have a User
API.</p><p>This task guide is about ServiceAccounts, which do exist in the Kubernetes
API. The guide shows you some ways to configure ServiceAccounts for Pods.</p><h2 id="before-you-begin">Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul><h2 id="use-the-default-service-account-to-access-the-api-server">Use the default service account to access the API server</h2><p>When Pods contact the API server, Pods authenticate as a particular
ServiceAccount (for example, <code>default</code>). There is always at least one
ServiceAccount in each <a class="glossary-tooltip" title="An abstraction used by Kubernetes to support isolation of groups of resources within a single cluster." data-toggle="tooltip" data-placement="top" href="/docs/concepts/overview/working-with-objects/namespaces" target="_blank" aria-label="namespace">namespace</a>.</p><p>Every Kubernetes namespace contains at least one ServiceAccount: the default
ServiceAccount for that namespace, named <code>default</code>.
If you do not specify a ServiceAccount when you create a Pod, Kubernetes
automatically assigns the ServiceAccount named <code>default</code> in that namespace.</p><p>You can fetch the details for a Pod you have created. For example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get pods/&lt;podname&gt; -o yaml
</span></span></code></pre></div><p>In the output, you see a field <code>spec.serviceAccountName</code>.
Kubernetes automatically
sets that value if you don't specify it when you create a Pod.</p><p>An application running inside a Pod can access the Kubernetes API using
automatically mounted service account credentials.
See <a href="/docs/tasks/access-application-cluster/access-cluster/">accessing the Cluster</a> to learn more.</p><p>When a Pod authenticates as a ServiceAccount, its level of access depends on the
<a href="/docs/reference/access-authn-authz/authorization/#authorization-modules">authorization plugin and policy</a>
in use.</p><p>The API credentials are automatically revoked when the Pod is deleted, even if
finalizers are in place. In particular, the API credentials are revoked 60 seconds
beyond the <code>.metadata.deletionTimestamp</code> set on the Pod (the deletion timestamp
is typically the time that the <strong>delete</strong> request was accepted plus the Pod's
termination grace period).</p><h3 id="opt-out-of-api-credential-automounting">Opt out of API credential automounting</h3><p>If you don't want the <a class="glossary-tooltip" title="An agent that runs on each node in the cluster. It makes sure that containers are running in a pod." data-toggle="tooltip" data-placement="top" href="/docs/reference/command-line-tools-reference/kubelet" target="_blank" aria-label="kubelet">kubelet</a>
to automatically mount a ServiceAccount's API credentials, you can opt out of
the default behavior.
You can opt out of automounting API credentials on <code>/var/run/secrets/kubernetes.io/serviceaccount/token</code>
for a service account by setting <code>automountServiceAccountToken: false</code> on the ServiceAccount:</p><p>For example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ServiceAccount<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>build-robot<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">automountServiceAccountToken</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">false</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#00f;font-weight:700">...</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>You can also opt out of automounting API credentials for a particular Pod:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Pod<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>my-pod<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">serviceAccountName</span>:<span style="color:#bbb"> </span>build-robot<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">automountServiceAccountToken</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">false</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>...<span style="color:#bbb">
</span></span></span></code></pre></div><p>If both the ServiceAccount and the Pod's <code>.spec</code> specify a value for
<code>automountServiceAccountToken</code>, the Pod spec takes precedence.</p><h2 id="use-multiple-service-accounts">Use more than one ServiceAccount</h2><p>Every namespace has at least one ServiceAccount: the default ServiceAccount
resource, called <code>default</code>. You can list all ServiceAccount resources in your
<a href="/docs/concepts/overview/working-with-objects/namespaces/#setting-the-namespace-preference">current namespace</a>
with:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get serviceaccounts
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex="0"><code>NAME      SECRETS    AGE
default   1          1d
</code></pre><p>You can create additional ServiceAccount objects like this:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f - <span style="color:#b44">&lt;&lt;EOF
</span></span></span><span style="display:flex"><span><span style="color:#b44">apiVersion: v1
</span></span></span><span style="display:flex"><span><span style="color:#b44">kind: ServiceAccount
</span></span></span><span style="display:flex"><span><span style="color:#b44">metadata:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  name: build-robot
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span></code></pre></div><p>The name of a ServiceAccount object must be a valid
<a href="/docs/concepts/overview/working-with-objects/names/#dns-subdomain-names">DNS subdomain name</a>.</p><p>If you get a complete dump of the service account object, like this:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get serviceaccounts/build-robot -o yaml
</span></span></code></pre></div><p>The output is similar to this:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ServiceAccount<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">creationTimestamp</span>:<span style="color:#bbb"> </span>2019-06-16T00:12:34Z<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>build-robot<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">resourceVersion</span>:<span style="color:#bbb"> </span><span style="color:#b44">"272500"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">uid</span>:<span style="color:#bbb"> </span>721ab723-13bc-11e5-aec2-42010af0021e<span style="color:#bbb">
</span></span></span></code></pre></div><p>You can use authorization plugins to
<a href="/docs/reference/access-authn-authz/rbac/#service-account-permissions">set permissions on service accounts</a>.</p><p>To use a non-default service account, set the <code>spec.serviceAccountName</code>
field of a Pod to the name of the ServiceAccount you wish to use.</p><p>You can only set the <code>serviceAccountName</code> field when creating a Pod, or in a
template for a new Pod. You cannot update the <code>.spec.serviceAccountName</code> field
of a Pod that already exists.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>The <code>.spec.serviceAccount</code> field is a deprecated alias for <code>.spec.serviceAccountName</code>.
If you want to remove the fields from a workload resource, set both fields to empty explicitly
on the <a href="/docs/concepts/workloads/pods/#pod-templates">pod template</a>.</div><h3 id="cleanup-use-multiple-service-accounts">Cleanup</h3><p>If you tried creating <code>build-robot</code> ServiceAccount from the example above,
you can clean it up by running:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl delete serviceaccount/build-robot
</span></span></code></pre></div><h2 id="manually-create-an-api-token-for-a-serviceaccount">Manually create an API token for a ServiceAccount</h2><p>Suppose you have an existing service account named "build-robot" as mentioned earlier.</p><p>You can get a time-limited API token for that ServiceAccount using <code>kubectl</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl create token build-robot
</span></span></code></pre></div><p>The output from that command is a token that you can use to authenticate as that
ServiceAccount. You can request a specific token duration using the <code>--duration</code>
command line argument to <code>kubectl create token</code> (the actual duration of the issued
token might be shorter, or could even be longer).</p><div class="feature-state-notice feature-stable" title="Feature Gate: ServiceAccountTokenNodeBinding"><span class="feature-state-name">FEATURE STATE:</span>
<code>Kubernetes v1.33 [stable]</code> (enabled by default: true)</div><p>Using <code>kubectl</code> v1.31 or later, it is possible to create a service
account token that is directly bound to a Node:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl create token build-robot --bound-object-kind Node --bound-object-name node-001 --bound-object-uid 123...456
</span></span></code></pre></div><p>The token will be valid until it expires or either the associated Node or service account are deleted.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4><p>Versions of Kubernetes before v1.22 automatically created long term credentials for
accessing the Kubernetes API. This older mechanism was based on creating token Secrets
that could then be mounted into running Pods. In more recent versions, including
Kubernetes v1.34, API credentials are obtained directly by using the
<a href="/docs/reference/kubernetes-api/authentication-resources/token-request-v1/">TokenRequest</a> API,
and are mounted into Pods using a
<a href="/docs/reference/access-authn-authz/service-accounts-admin/#bound-service-account-token-volume">projected volume</a>.
The tokens obtained using this method have bounded lifetimes, and are automatically
invalidated when the Pod they are mounted into is deleted.</p><p>You can still manually create a service account token Secret; for example,
if you need a token that never expires. However, using the
<a href="/docs/reference/kubernetes-api/authentication-resources/token-request-v1/">TokenRequest</a>
subresource to obtain a token to access the API is recommended instead.</p></div><h3 id="manually-create-a-long-lived-api-token-for-a-serviceaccount">Manually create a long-lived API token for a ServiceAccount</h3><p>If you want to obtain an API token for a ServiceAccount, you create a new Secret
with a special annotation, <code>kubernetes.io/service-account.name</code>.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f - <span style="color:#b44">&lt;&lt;EOF
</span></span></span><span style="display:flex"><span><span style="color:#b44">apiVersion: v1
</span></span></span><span style="display:flex"><span><span style="color:#b44">kind: Secret
</span></span></span><span style="display:flex"><span><span style="color:#b44">metadata:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  name: build-robot-secret
</span></span></span><span style="display:flex"><span><span style="color:#b44">  annotations:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    kubernetes.io/service-account.name: build-robot
</span></span></span><span style="display:flex"><span><span style="color:#b44">type: kubernetes.io/service-account-token
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span></code></pre></div><p>If you view the Secret using:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get secret/build-robot-secret -o yaml
</span></span></code></pre></div><p>you can see that the Secret now contains an API token for the "build-robot" ServiceAccount.</p><p>Because of the annotation you set, the control plane automatically generates a token for that
ServiceAccounts, and stores them into the associated Secret. The control plane also cleans up
tokens for deleted ServiceAccounts.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl describe secrets/build-robot-secret
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex="0"><code>Name:           build-robot-secret
Namespace:      default
Labels:         &lt;none&gt;
Annotations:    kubernetes.io/service-account.name: build-robot
                kubernetes.io/service-account.uid: da68f9c6-9d26-11e7-b84e-002dc52800da

Type:   kubernetes.io/service-account-token

Data
====
ca.crt:         1338 bytes
namespace:      7 bytes
token:          ...
</code></pre><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4><p>The content of <code>token</code> is omitted here.</p><p>Take care not to display the contents of a <code>kubernetes.io/service-account-token</code>
Secret somewhere that your terminal / computer screen could be seen by an onlooker.</p></div><p>When you delete a ServiceAccount that has an associated Secret, the Kubernetes
control plane automatically cleans up the long-lived token from that Secret.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4><p>If you view the ServiceAccount using:</p><p><code>kubectl get serviceaccount build-robot -o yaml</code></p><p>You can't see the <code>build-robot-secret</code> Secret in the ServiceAccount API objects
<a href="/docs/reference/kubernetes-api/authentication-resources/service-account-v1/"><code>.secrets</code></a> field
because that field is only populated with auto-generated Secrets.</p></div><h2 id="add-imagepullsecrets-to-a-service-account">Add ImagePullSecrets to a service account</h2><p>First, <a href="/docs/concepts/containers/images/#specifying-imagepullsecrets-on-a-pod">create an imagePullSecret</a>.
Next, verify it has been created. For example:</p><ul><li><p>Create an imagePullSecret, as described in
<a href="/docs/concepts/containers/images/#specifying-imagepullsecrets-on-a-pod">Specifying ImagePullSecrets on a Pod</a>.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl create secret docker-registry myregistrykey --docker-server<span style="color:#666">=</span>&lt;registry name&gt; <span style="color:#b62;font-weight:700">\
</span></span></span><span style="display:flex"><span><span style="color:#b62;font-weight:700"/>        --docker-username<span style="color:#666">=</span>DUMMY_USERNAME --docker-password<span style="color:#666">=</span>DUMMY_DOCKER_PASSWORD <span style="color:#b62;font-weight:700">\
</span></span></span><span style="display:flex"><span><span style="color:#b62;font-weight:700"/>        --docker-email<span style="color:#666">=</span>DUMMY_DOCKER_EMAIL
</span></span></code></pre></div></li><li><p>Verify it has been created.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get secrets myregistrykey
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex="0"><code>NAME             TYPE                              DATA    AGE
myregistrykey    kubernetes.io/.dockerconfigjson   1       1d
</code></pre></li></ul><h3 id="add-image-pull-secret-to-service-account">Add image pull secret to service account</h3><p>Next, modify the default service account for the namespace to use this Secret as an imagePullSecret.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl patch serviceaccount default -p <span style="color:#b44">'{"imagePullSecrets": [{"name": "myregistrykey"}]}'</span>
</span></span></code></pre></div><p>You can achieve the same outcome by editing the object manually:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl edit serviceaccount/default
</span></span></code></pre></div><p>The output of the <code>sa.yaml</code> file is similar to this:</p><p>Your selected text editor will open with a configuration looking something like this:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ServiceAccount<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">creationTimestamp</span>:<span style="color:#bbb"> </span>2021-07-07T22:02:39Z<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">resourceVersion</span>:<span style="color:#bbb"> </span><span style="color:#b44">"243024"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">uid</span>:<span style="color:#bbb"> </span>052fb0f4-3d50-11e5-b066-42010af0d7b6<span style="color:#bbb">
</span></span></span></code></pre></div><p>Using your editor, delete the line with key <code>resourceVersion</code>, add lines for
<code>imagePullSecrets:</code> and save it. Leave the <code>uid</code> value set the same as you found it.</p><p>After you made those changes, the edited ServiceAccount looks something like this:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ServiceAccount<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">creationTimestamp</span>:<span style="color:#bbb"> </span>2021-07-07T22:02:39Z<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">uid</span>:<span style="color:#bbb"> </span>052fb0f4-3d50-11e5-b066-42010af0d7b6<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">imagePullSecrets</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>myregistrykey<span style="color:#bbb">
</span></span></span></code></pre></div><h3 id="verify-that-imagepullsecrets-are-set-for-new-pods">Verify that imagePullSecrets are set for new Pods</h3><p>Now, when a new Pod is created in the current namespace and using the default
ServiceAccount, the new Pod has its <code>spec.imagePullSecrets</code> field set automatically:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl run nginx --image<span style="color:#666">=</span>&lt;registry name&gt;/nginx --restart<span style="color:#666">=</span>Never
</span></span><span style="display:flex"><span>kubectl get pod nginx -o<span style="color:#666">=</span><span style="color:#b8860b">jsonpath</span><span style="color:#666">=</span><span style="color:#b44">'{.spec.imagePullSecrets[0].name}{"\n"}'</span>
</span></span></code></pre></div><p>The output is:</p><pre tabindex="0"><code>myregistrykey
</code></pre><h2 id="serviceaccount-token-volume-projection">ServiceAccount token volume projection</h2><div class="feature-state-notice feature-stable"><span class="feature-state-name">FEATURE STATE:</span>
<code>Kubernetes v1.20 [stable]</code></div><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4><p>To enable and use token request projection, you must specify each of the following
command line arguments to <code>kube-apiserver</code>:</p><dl><dt><code>--service-account-issuer</code></dt><dd>defines the Identifier of the service account token issuer. You can specify the
<code>--service-account-issuer</code> argument multiple times, this can be useful to enable
a non-disruptive change of the issuer. When this flag is specified multiple times,
the first is used to generate tokens and all are used to determine which issuers
are accepted. You must be running Kubernetes v1.22 or later to be able to specify
<code>--service-account-issuer</code> multiple times.</dd><dt><code>--service-account-key-file</code></dt><dd>specifies the path to a file containing PEM-encoded X.509 private or public keys
(RSA or ECDSA), used to verify ServiceAccount tokens. The specified file can contain
multiple keys, and the flag can be specified multiple times with different files.
If specified multiple times, tokens signed by any of the specified keys are considered
valid by the Kubernetes API server.</dd><dt><code>--service-account-signing-key-file</code></dt><dd>specifies the path to a file that contains the current private key of the service
account token issuer. The issuer signs issued ID tokens with this private key.</dd><dt><code>--api-audiences</code> (can be omitted)</dt><dd>defines audiences for ServiceAccount tokens. The service account token authenticator
validates that tokens used against the API are bound to at least one of these audiences.
If <code>api-audiences</code> is specified multiple times, tokens for any of the specified audiences
are considered valid by the Kubernetes API server. If you specify the <code>--service-account-issuer</code>
command line argument but you don't set <code>--api-audiences</code>, the control plane defaults to
a single element audience list that contains only the issuer URL.</dd></dl></div><p>The kubelet can also project a ServiceAccount token into a Pod. You can
specify desired properties of the token, such as the audience and the validity
duration. These properties are <em>not</em> configurable on the default ServiceAccount
token. The token will also become invalid against the API when either the Pod
or the ServiceAccount is deleted.</p><p>You can configure this behavior for the <code>spec</code> of a Pod using a
<a href="/docs/concepts/storage/volumes/#projected">projected volume</a> type called
<code>ServiceAccountToken</code>.</p><p>The token from this projected volume is a <a class="glossary-tooltip" title="A means of representing claims to be transferred between two parties." data-toggle="tooltip" data-placement="top" href="https://www.rfc-editor.org/rfc/rfc7519" target="_blank" aria-label="JSON Web Token">JSON Web Token</a> (JWT).
The JSON payload of this token follows a well defined schema - an example payload for a pod bound token:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">"aud": </span>[<span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># matches the requested audiences, or the API server's default audiences when none are explicitly requested</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:#b44">"https://kubernetes.default.svc"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>],<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">"exp": </span><span style="color:#666">1731613413</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">"iat": </span><span style="color:#666">1700077413</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">"iss": </span><span style="color:#b44">"https://kubernetes.default.svc"</span>,<span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># matches the first value passed to the --service-account-issuer flag</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">"jti": </span><span style="color:#b44">"ea28ed49-2e11-4280-9ec5-bc3d1d84661a"</span>,<span style="color:#bbb"> 
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">"kubernetes.io": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"namespace": </span><span style="color:#b44">"kube-system"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"node": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"name": </span><span style="color:#b44">"127.0.0.1"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"uid": </span><span style="color:#b44">"58456cb0-dd00-45ed-b797-5578fdceaced"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"pod": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"name": </span><span style="color:#b44">"coredns-69cbfb9798-jv9gn"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"uid": </span><span style="color:#b44">"778a530c-b3f4-47c0-9cd5-ab018fb64f33"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"serviceaccount": </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"name": </span><span style="color:#b44">"coredns"</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">"uid": </span><span style="color:#b44">"a087d5a0-e1dd-43ec-93ac-f13d89cd13af"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">"warnafter": </span><span style="color:#666">1700081020</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">"nbf": </span><span style="color:#666">1700077413</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">"sub": </span><span style="color:#b44">"system:serviceaccount:kube-system:coredns"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>}<span style="color:#bbb">
</span></span></span></code></pre></div><h3 id="launch-a-pod-using-service-account-token-projection">Launch a Pod using service account token projection</h3><p>To provide a Pod with a token with an audience of <code>vault</code> and a validity duration
of two hours, you could define a Pod manifest that is similar to:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/pod-projected-svc-token.yaml" download="pods/pod-projected-svc-token.yaml"><code>pods/pod-projected-svc-token.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;pods-pod-projected-svc-token-yaml&quot;)" title="Copy pods/pod-projected-svc-token.yaml to clipboard"/></div><div class="includecode" id="pods-pod-projected-svc-token-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Pod<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">volumeMounts</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">mountPath</span>:<span style="color:#bbb"> </span>/var/run/secrets/tokens<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>vault-token<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">serviceAccountName</span>:<span style="color:#bbb"> </span>build-robot<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>vault-token<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">projected</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">sources</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">serviceAccountToken</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">path</span>:<span style="color:#bbb"> </span>vault-token<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">expirationSeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">7200</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">audience</span>:<span style="color:#bbb"> </span>vault<span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>Create the Pod:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl create -f https://k8s.io/examples/pods/pod-projected-svc-token.yaml
</span></span></code></pre></div><p>The kubelet will: request and store the token on behalf of the Pod; make
the token available to the Pod at a configurable file path; and refresh
the token as it approaches expiration. The kubelet proactively requests rotation
for the token if it is older than 80% of its total time-to-live (TTL),
or if the token is older than 24 hours.</p><p>The application is responsible for reloading the token when it rotates. It's
often good enough for the application to load the token on a schedule
(for example: once every 5 minutes), without tracking the actual expiry time.</p><h3 id="service-account-issuer-discovery">Service account issuer discovery</h3><div class="feature-state-notice feature-stable"><span class="feature-state-name">FEATURE STATE:</span>
<code>Kubernetes v1.21 [stable]</code></div><p>If you have enabled <a href="#serviceaccount-token-volume-projection">token projection</a>
for ServiceAccounts in your cluster, then you can also make use of the discovery
feature. Kubernetes provides a way for clients to federate as an <em>identity provider</em>,
so that one or more external systems can act as a <em>relying party</em>.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4><p>The issuer URL must comply with the
<a href="https://openid.net/specs/openid-connect-discovery-1_0.html">OIDC Discovery Spec</a>. In
practice, this means it must use the <code>https</code> scheme, and should serve an OpenID
provider configuration at <code>{service-account-issuer}/.well-known/openid-configuration</code>.</p><p>If the URL does not comply, ServiceAccount issuer discovery endpoints are not
registered or accessible.</p></div><p>When enabled, the Kubernetes API server publishes an OpenID Provider
Configuration document via HTTP. The configuration document is published at
<code>/.well-known/openid-configuration</code>.
The OpenID Provider Configuration is sometimes referred to as the <em>discovery document</em>.
The Kubernetes API server publishes the related
JSON Web Key Set (JWKS), also via HTTP, at <code>/openid/v1/jwks</code>.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>The responses served at <code>/.well-known/openid-configuration</code> and
<code>/openid/v1/jwks</code> are designed to be OIDC compatible, but not strictly OIDC
compliant. Those documents contain only the parameters necessary to perform
validation of Kubernetes service account tokens.</div><p>Clusters that use <a class="glossary-tooltip" title="Manages authorization decisions, allowing admins to dynamically configure access policies through the Kubernetes API." data-toggle="tooltip" data-placement="top" href="/docs/reference/access-authn-authz/rbac/" target="_blank" aria-label="RBAC">RBAC</a> include a
default ClusterRole called <code>system:service-account-issuer-discovery</code>.
A default ClusterRoleBinding assigns this role to the <code>system:serviceaccounts</code> group,
which all ServiceAccounts implicitly belong to.
This allows pods running on the cluster to access the service account discovery document
via their mounted service account token. Administrators may, additionally, choose to
bind the role to <code>system:authenticated</code> or <code>system:unauthenticated</code> depending on their
security requirements and which external systems they intend to federate with.</p><p>The JWKS response contains public keys that a relying party can use to validate
the Kubernetes service account tokens. Relying parties first query for the
OpenID Provider Configuration, and use the <code>jwks_uri</code> field in the response to
find the JWKS.</p><p>In many cases, Kubernetes API servers are not available on the public internet,
but public endpoints that serve cached responses from the API server can be made
available by users or by service providers. In these cases, it is possible to
override the <code>jwks_uri</code> in the OpenID Provider Configuration so that it points
to the public endpoint, rather than the API server's address, by passing the
<code>--service-account-jwks-uri</code> flag to the API server. Like the issuer URL, the
JWKS URI is required to use the <code>https</code> scheme.</p><h2 id="what-s-next">What's next</h2><p>See also:</p><ul><li>Read the <a href="/docs/reference/access-authn-authz/service-accounts-admin/">Cluster Admin Guide to Service Accounts</a></li><li>Read about <a href="/docs/reference/access-authn-authz/authorization/">Authorization in Kubernetes</a></li><li>Read about <a href="/docs/concepts/configuration/secret/">Secrets</a><ul><li>or learn to <a href="/docs/tasks/inject-data-application/distribute-credentials-secure/">distribute credentials securely using Secrets</a></li><li>but also bear in mind that using Secrets for authenticating as a ServiceAccount
is deprecated. The recommended alternative is
<a href="#serviceaccount-token-volume-projection">ServiceAccount token volume projection</a>.</li></ul></li><li>Read about <a href="/docs/tasks/configure-pod-container/configure-projected-volume-storage/">projected volumes</a>.</li><li>For background on OIDC discovery, read the
<a href="https://github.com/kubernetes/enhancements/tree/master/keps/sig-auth/1393-oidc-discovery">ServiceAccount signing key retrieval</a>
Kubernetes Enhancement Proposal</li><li>Read the <a href="https://openid.net/specs/openid-connect-discovery-1_0.html">OIDC Discovery Spec</a></li></ul></div>