<div class="td-content"><h1 data-pagefind-weight="10">Validating Admission Policy</h1><div class="feature-state-notice feature-stable"><span class="feature-state-name">FEATURE STATE:</span>
<code>Kubernetes v1.30 [stable]</code></div><p>This page provides an overview of Validating Admission Policy.</p><h2 id="what-is-validating-admission-policy">What is Validating Admission Policy?</h2><p>Validating admission policies offer a declarative, in-process alternative to validating admission webhooks.</p><p>Validating admission policies use the Common Expression Language (CEL) to declare the validation
rules of a policy.
Validation admission policies are highly configurable, enabling policy authors to define policies
that can be parameterized and scoped to resources as needed by cluster administrators.</p><h2 id="what-resources-make-a-policy">What Resources Make a Policy</h2><p>A policy is generally made up of three resources:</p><ul><li><p>The <code>ValidatingAdmissionPolicy</code> describes the abstract logic of a policy
(think: "this policy makes sure a particular label is set to a particular value").</p></li><li><p>A parameter resource provides information to a ValidatingAdmissionPolicy to make it a concrete
statement (think "the <code>owner</code> label must be set to something that ends in <code>.company.com</code>").
A native type such as ConfigMap or a CRD defines the schema of a parameter resource.
<code>ValidatingAdmissionPolicy</code> objects specify what Kind they are expecting for their parameter resource.</p></li><li><p>A <code>ValidatingAdmissionPolicyBinding</code> links the above resources together and provides scoping.
If you only want to require an <code>owner</code> label to be set for <code>Pods</code>, the binding is where you would
specify this restriction.</p></li></ul><p>At least a <code>ValidatingAdmissionPolicy</code> and a corresponding <code>ValidatingAdmissionPolicyBinding</code>
must be defined for a policy to have an effect.</p><p>If a <code>ValidatingAdmissionPolicy</code> does not need to be configured via parameters, simply leave
<code>spec.paramKind</code> in <code>ValidatingAdmissionPolicy</code> not specified.</p><h2 id="getting-started-with-validating-admission-policy">Getting Started with Validating Admission Policy</h2><p>Validating Admission Policy is part of the cluster control-plane. You should write and deploy them
with great caution. The following describes how to quickly experiment with Validating Admission Policy.</p><h3 id="creating-a-validatingadmissionpolicy">Creating a ValidatingAdmissionPolicy</h3><p>The following is an example of a ValidatingAdmissionPolicy.</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/validatingadmissionpolicy/basic-example-policy.yaml" download="validatingadmissionpolicy/basic-example-policy.yaml"><code>validatingadmissionpolicy/basic-example-policy.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;validatingadmissionpolicy-basic-example-policy-yaml&quot;)" title="Copy validatingadmissionpolicy/basic-example-policy.yaml to clipboard"/></div><div class="includecode" id="validatingadmissionpolicy-basic-example-policy-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>admissionregistration.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ValidatingAdmissionPolicy<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span><span style="color:#b44">"demo-policy.example.com"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">failurePolicy</span>:<span style="color:#bbb"> </span>Fail<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">matchConstraints</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">resourceRules</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">apiGroups</span>:<span style="color:#bbb">   </span>[<span style="color:#b44">"apps"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">apiVersions</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"v1"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">operations</span>:<span style="color:#bbb">  </span>[<span style="color:#b44">"CREATE"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"UPDATE"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb">   </span>[<span style="color:#b44">"deployments"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">validations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">expression</span>:<span style="color:#bbb"> </span><span style="color:#b44">"object.spec.replicas &lt;= 5"</span></span></span></code></pre></div></div></div><p><code>spec.validations</code> contains CEL expressions which use the <a href="https://github.com/google/cel-spec">Common Expression Language (CEL)</a>
to validate the request. If an expression evaluates to false, the validation check is enforced
according to the <code>spec.failurePolicy</code> field.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>You can quickly test CEL expressions in <a href="https://playcel.undistro.io">CEL Playground</a>.</div><p>To configure a validating admission policy for use in a cluster, a binding is required.
The following is an example of a ValidatingAdmissionPolicyBinding.:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/validatingadmissionpolicy/basic-example-binding.yaml" download="validatingadmissionpolicy/basic-example-binding.yaml"><code>validatingadmissionpolicy/basic-example-binding.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;validatingadmissionpolicy-basic-example-binding-yaml&quot;)" title="Copy validatingadmissionpolicy/basic-example-binding.yaml to clipboard"/></div><div class="includecode" id="validatingadmissionpolicy-basic-example-binding-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>admissionregistration.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ValidatingAdmissionPolicyBinding<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span><span style="color:#b44">"demo-binding-test.example.com"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">policyName</span>:<span style="color:#bbb"> </span><span style="color:#b44">"demo-policy.example.com"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">validationActions</span>:<span style="color:#bbb"> </span>[Deny]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">matchResources</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">namespaceSelector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">environment</span>:<span style="color:#bbb"> </span>test<span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>When trying to create a deployment with replicas set not satisfying the validation expression, an
error will return containing message:</p><pre tabindex="0"><code class="language-none" data-lang="none">ValidatingAdmissionPolicy 'demo-policy.example.com' with binding 'demo-binding-test.example.com' denied request: failed expression: object.spec.replicas &lt;= 5
</code></pre><p>The above provides a simple example of using ValidatingAdmissionPolicy without a parameter configured.</p><h4 id="validation-actions">Validation actions</h4><p>Each <code>ValidatingAdmissionPolicyBinding</code> must specify one or more
<code>validationActions</code> to declare how <code>validations</code> of a policy are enforced.</p><p>The supported <code>validationActions</code> are:</p><ul><li><code>Deny</code>: Validation failure results in a denied request.</li><li><code>Warn</code>: Validation failure is reported to the request client
as a <a href="/blog/2020/09/03/warnings/">warning</a>.</li><li><code>Audit</code>: Validation failure is included in the audit event for the API request.</li></ul><p>For example, to both warn clients about a validation failure and to audit the
validation failures, use:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">validationActions</span>:<span style="color:#bbb"> </span>[Warn, Audit]<span style="color:#bbb">
</span></span></span></code></pre></div><p><code>Deny</code> and <code>Warn</code> may not be used together since this combination
needlessly duplicates the validation failure both in the
API response body and the HTTP warning headers.</p><p>A <code>validation</code> that evaluates to false is always enforced according to these
actions. Failures defined by the <code>failurePolicy</code> are enforced
according to these actions only if the <code>failurePolicy</code> is set to <code>Fail</code> (or not specified),
otherwise the failures are ignored.</p><p>See <a href="/docs/reference/labels-annotations-taints/audit-annotations/#validation-policy-admission-k8s-io-validation-failure">Audit Annotations: validation failures</a>
for more details about the validation failure audit annotation.</p><h3 id="parameter-resources">Parameter resources</h3><p>Parameter resources allow a policy configuration to be separate from its definition.
A policy can define paramKind, which outlines GVK of the parameter resource,
and then a policy binding ties a policy by name (via policyName) to a particular parameter resource via paramRef.</p><p>If parameter configuration is needed, the following is an example of a ValidatingAdmissionPolicy
with parameter configuration.</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/validatingadmissionpolicy/policy-with-param.yaml" download="validatingadmissionpolicy/policy-with-param.yaml"><code>validatingadmissionpolicy/policy-with-param.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;validatingadmissionpolicy-policy-with-param-yaml&quot;)" title="Copy validatingadmissionpolicy/policy-with-param.yaml to clipboard"/></div><div class="includecode" id="validatingadmissionpolicy-policy-with-param-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>admissionregistration.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ValidatingAdmissionPolicy<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span><span style="color:#b44">"replicalimit-policy.example.com"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">failurePolicy</span>:<span style="color:#bbb"> </span>Fail<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">paramKind</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>rules.example.com/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ReplicaLimit<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">matchConstraints</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">resourceRules</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">apiGroups</span>:<span style="color:#bbb">   </span>[<span style="color:#b44">"apps"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">apiVersions</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"v1"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">operations</span>:<span style="color:#bbb">  </span>[<span style="color:#b44">"CREATE"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"UPDATE"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb">   </span>[<span style="color:#b44">"deployments"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">validations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">expression</span>:<span style="color:#bbb"> </span><span style="color:#b44">"object.spec.replicas &lt;= params.maxReplicas"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">reason</span>:<span style="color:#bbb"> </span>Invalid</span></span></code></pre></div></div></div><p>The <code>spec.paramKind</code> field of the ValidatingAdmissionPolicy specifies the kind of resources used
to parameterize this policy. For this example, it is configured by ReplicaLimit custom resources.
Note in this example how the CEL expression references the parameters via the CEL params variable,
e.g. <code>params.maxReplicas</code>. <code>spec.matchConstraints</code> specifies what resources this policy is
designed to validate. Note that the native types such like <code>ConfigMap</code> could also be used as
parameter reference.</p><p>The <code>spec.validations</code> fields contain CEL expressions. If an expression evaluates to false, the
validation check is enforced according to the <code>spec.failurePolicy</code> field.</p><p>The validating admission policy author is responsible for providing the ReplicaLimit parameter CRD.</p><p>To configure an validating admission policy for use in a cluster, a binding and parameter resource
are created. The following is an example of a ValidatingAdmissionPolicyBinding
that uses a <strong>cluster-wide</strong> param - the same param will be used to validate
every resource request that matches the binding:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/validatingadmissionpolicy/binding-with-param.yaml" download="validatingadmissionpolicy/binding-with-param.yaml"><code>validatingadmissionpolicy/binding-with-param.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;validatingadmissionpolicy-binding-with-param-yaml&quot;)" title="Copy validatingadmissionpolicy/binding-with-param.yaml to clipboard"/></div><div class="includecode" id="validatingadmissionpolicy-binding-with-param-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>admissionregistration.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ValidatingAdmissionPolicyBinding<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span><span style="color:#b44">"replicalimit-binding-test.example.com"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">policyName</span>:<span style="color:#bbb"> </span><span style="color:#b44">"replicalimit-policy.example.com"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">validationActions</span>:<span style="color:#bbb"> </span>[Deny]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">paramRef</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span><span style="color:#b44">"replica-limit-test.example.com"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span><span style="color:#b44">"default"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">parameterNotFoundAction</span>:<span style="color:#bbb"> </span>Deny<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">matchResources</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">namespaceSelector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">environment</span>:<span style="color:#bbb"> </span>test<span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>Notice this binding applies a parameter to the policy for all resources which
are in the <code>test</code> environment.</p><p>The parameter resource could be as following:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/validatingadmissionpolicy/replicalimit-param.yaml" download="validatingadmissionpolicy/replicalimit-param.yaml"><code>validatingadmissionpolicy/replicalimit-param.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;validatingadmissionpolicy-replicalimit-param-yaml&quot;)" title="Copy validatingadmissionpolicy/replicalimit-param.yaml to clipboard"/></div><div class="includecode" id="validatingadmissionpolicy-replicalimit-param-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>rules.example.com/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ReplicaLimit<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span><span style="color:#b44">"replica-limit-test.example.com"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span><span style="color:#b44">"default"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">maxReplicas</span>:<span style="color:#bbb"> </span><span style="color:#666">3</span><span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>This policy parameter resource limits deployments to a max of 3 replicas.</p><p>An admission policy may have multiple bindings. To bind all other environments
to have a maxReplicas limit of 100, create another ValidatingAdmissionPolicyBinding:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/validatingadmissionpolicy/binding-with-param-prod.yaml" download="validatingadmissionpolicy/binding-with-param-prod.yaml"><code>validatingadmissionpolicy/binding-with-param-prod.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;validatingadmissionpolicy-binding-with-param-prod-yaml&quot;)" title="Copy validatingadmissionpolicy/binding-with-param-prod.yaml to clipboard"/></div><div class="includecode" id="validatingadmissionpolicy-binding-with-param-prod-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>admissionregistration.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ValidatingAdmissionPolicyBinding<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span><span style="color:#b44">"replicalimit-binding-nontest"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">policyName</span>:<span style="color:#bbb"> </span><span style="color:#b44">"replicalimit-policy.example.com"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">validationActions</span>:<span style="color:#bbb"> </span>[Deny]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">paramRef</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span><span style="color:#b44">"replica-limit-prod.example.com"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">namespace</span>:<span style="color:#bbb"> </span><span style="color:#b44">"default"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">parameterNotFoundAction</span>:<span style="color:#bbb"> </span>Deny<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">matchResources</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">namespaceSelector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">matchExpressions</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">key</span>:<span style="color:#bbb"> </span>environment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">operator</span>:<span style="color:#bbb"> </span>NotIn<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">values</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span>- test<span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>Notice this binding applies a different parameter to resources which
are not in the <code>test</code> environment.</p><p>And have a parameter resource:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/validatingadmissionpolicy/replicalimit-param-prod.yaml" download="validatingadmissionpolicy/replicalimit-param-prod.yaml"><code>validatingadmissionpolicy/replicalimit-param-prod.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;validatingadmissionpolicy-replicalimit-param-prod-yaml&quot;)" title="Copy validatingadmissionpolicy/replicalimit-param-prod.yaml to clipboard"/></div><div class="includecode" id="validatingadmissionpolicy-replicalimit-param-prod-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>rules.example.com/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ReplicaLimit<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span><span style="color:#b44">"replica-limit-prod.example.com"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">maxReplicas</span>:<span style="color:#bbb"> </span><span style="color:#666">100</span></span></span></code></pre></div></div></div><p>For each admission request, the API server evaluates CEL expressions of each
(policy, binding, param) combination that match the request. For a request
to be admitted it must pass <strong>all</strong> evaluations.</p><p>If multiple bindings match the request, the policy will be evaluated for each,
and they must all pass evaluation for the policy to be considered passed.</p><p>If multiple parameters match a single binding, the policy rules will be evaluated
for each param, and they too must all pass for the binding to be considered passed.
Bindings can have overlapping match criteria. The policy is evaluated for each
matching binding-parameter combination. A policy may even be evaluated multiple
times if multiple bindings match it, or a single binding that matches multiple
parameters.</p><p>The params object representing a parameter resource will not be set if a parameter resource has
not been bound, so for policies requiring a parameter resource, it can be useful to add a check to
ensure one has been bound. A parameter resource will not be bound and <code>params</code> will be null
if <code>paramKind</code> of the policy, or <code>paramRef</code> of the binding are not specified.</p><p>For the use cases requiring parameter configuration, we recommend to add a param check in
<code>spec.validations[0].expression</code>:</p><pre tabindex="0"><code>- expression: "params != null"
  message: "params missing but required to bind to this policy"
</code></pre><h4 id="optional-parameters">Optional parameters</h4><p>It can be convenient to be able to have optional parameters as part of a parameter resource, and
only validate them if present. CEL provides <code>has()</code>, which checks if the key passed to it exists.
CEL also implements Boolean short-circuiting. If the first half of a logical OR evaluates to true,
it won’t evaluate the other half (since the result of the entire OR will be true regardless).</p><p>Combining the two, we can provide a way to validate optional parameters:</p><p><code>!has(params.optionalNumber) || (params.optionalNumber &gt;= 5 &amp;&amp; params.optionalNumber &lt;= 10)</code></p><p>Here, we first check that the optional parameter is present with <code>!has(params.optionalNumber)</code>.</p><ul><li>If <code>optionalNumber</code> hasn’t been defined, then the expression short-circuits since
<code>!has(params.optionalNumber)</code> will evaluate to true.</li><li>If <code>optionalNumber</code> has been defined, then the latter half of the CEL expression will be
evaluated, and optionalNumber will be checked to ensure that it contains a value between 5 and
10 inclusive.</li></ul><h4 id="per-namespace-parameters">Per-namespace Parameters</h4><p>As the author of a ValidatingAdmissionPolicy and its ValidatingAdmissionPolicyBinding,
you can choose to specify cluster-wide, or per-namespace parameters.
If you specify a <code>namespace</code> for the binding's <code>paramRef</code>, the control plane only
searches for parameters in that namespace.</p><p>However, if <code>namespace</code> is not specified in the ValidatingAdmissionPolicyBinding, the
API server can search for relevant parameters in the namespace that a request is against.
For example, if you make a request to modify a ConfigMap in the <code>default</code> namespace and
there is a relevant ValidatingAdmissionPolicyBinding with no <code>namespace</code> set, then the
API server looks for a parameter object in <code>default</code>.
This design enables policy configuration that depends on the namespace
of the resource being manipulated, for more fine-tuned control.</p><h4 id="parameter-selector">Parameter selector</h4><p>In addition to specify a parameter in a binding by <code>name</code>, you may
choose instead to specify label selector, such that all resources of the
policy's <code>paramKind</code>, and the param's <code>namespace</code> (if applicable) that match the
label selector are selected for evaluation. See <a class="glossary-tooltip" title="Allows users to filter a list of resources based on labels." data-toggle="tooltip" data-placement="top" href="/docs/concepts/overview/working-with-objects/labels/" target="_blank" aria-label="selector">selector</a> for more information on how label selectors match resources.</p><p>If multiple parameters are found to meet the condition, the policy's rules are
evaluated for each parameter found and the results will be ANDed together.</p><p>If <code>namespace</code> is provided, only objects of the <code>paramKind</code> in the provided
namespace are eligible for selection. Otherwise, when <code>namespace</code> is empty and
<code>paramKind</code> is namespace-scoped, the <code>namespace</code> used in the request being
admitted will be used.</p><h4 id="authorization-check">Authorization checks</h4><p>We introduced the authorization check for parameter resources.
User is expected to have <code>read</code> access to the resources referenced by <code>paramKind</code> in
<code>ValidatingAdmissionPolicy</code> and <code>paramRef</code> in <code>ValidatingAdmissionPolicyBinding</code>.</p><p>Note that if a resource in <code>paramKind</code> fails resolving via the restmapper, <code>read</code> access to all
resources of groups is required.</p><h4 id="paramref"><code>paramRef</code></h4><p>The <code>paramRef</code> field specifies the parameter resource used by the policy. It has the following fields:</p><ul><li><p><strong>name</strong>: The name of the parameter resource.</p></li><li><p><strong>namespace</strong>: The namespace of the parameter resource.</p></li><li><p><strong>selector</strong>: A label selector to match multiple parameter resources.</p></li><li><p><strong>parameterNotFoundAction</strong>: (Required) Controls the behavior when the specified parameters are not found.</p><ul><li><strong>Allowed Values</strong>:<ul><li><strong><code>Allow</code></strong>: The absence of matched parameters is treated as a successful validation by the binding.</li><li><strong><code>Deny</code></strong>: The absence of matched parameters is subject to the <code>failurePolicy</code> of the policy.</li></ul></li></ul></li></ul><p>One of <code>name</code> or <code>selector</code> must be set, but not both.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4><p>The <code>parameterNotFoundAction</code> field in <code>paramRef</code> is <strong>required</strong>. It specifies the action to take when no parameters are found matching the <code>paramRef</code>. If not specified, the policy binding may be considered invalid and will be ignored or could lead to unexpected behavior.</p><ul><li><strong><code>Allow</code></strong>: If set to <code>Allow</code>, and no parameters are found, the binding treats the absence of parameters as a successful validation, and the policy is considered to have passed.</li><li><strong><code>Deny</code></strong>: If set to <code>Deny</code>, and no parameters are found, the binding enforces the <code>failurePolicy</code> of the policy. If the <code>failurePolicy</code> is <code>Fail</code>, the request is rejected.</li></ul><p>Make sure to set <code>parameterNotFoundAction</code> according to the desired behavior when parameters are missing.</p></div><h4 id="handling-missing-parameters-with-parameternotfoundaction">Handling Missing Parameters with <code>parameterNotFoundAction</code></h4><p>When using <code>paramRef</code> with a selector, it's possible that no parameters match the selector. The <code>parameterNotFoundAction</code> field determines how the binding behaves in this scenario.</p><p><strong>Example:</strong></p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>admissionregistration.k8s.io/v1alpha1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ValidatingAdmissionPolicyBinding<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>example-binding<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">policyName</span>:<span style="color:#bbb"> </span>example-policy<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">paramRef</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">selector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">environment</span>:<span style="color:#bbb"> </span>test<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">parameterNotFoundAction</span>:<span style="color:#bbb"> </span>Allow<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">validationActions</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- Deny<span style="color:#bbb">
</span></span></span></code></pre></div><h3 id="failure-policy">Failure Policy</h3><p><code>failurePolicy</code> defines how mis-configurations and CEL expressions evaluating to error from the
admission policy are handled. Allowed values are <code>Ignore</code> or <code>Fail</code>.</p><ul><li><code>Ignore</code> means that an error calling the ValidatingAdmissionPolicy is ignored and the API
request is allowed to continue.</li><li><code>Fail</code> means that an error calling the ValidatingAdmissionPolicy causes the admission to fail
and the API request to be rejected.</li></ul><p>Note that the <code>failurePolicy</code> is defined inside <code>ValidatingAdmissionPolicy</code>:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/validatingadmissionpolicy/failure-policy-ignore.yaml" download="validatingadmissionpolicy/failure-policy-ignore.yaml"><code>validatingadmissionpolicy/failure-policy-ignore.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;validatingadmissionpolicy-failure-policy-ignore-yaml&quot;)" title="Copy validatingadmissionpolicy/failure-policy-ignore.yaml to clipboard"/></div><div class="includecode" id="validatingadmissionpolicy-failure-policy-ignore-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>admissionregistration.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ValidatingAdmissionPolicy<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#00f;font-weight:700">...</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">failurePolicy</span>:<span style="color:#bbb"> </span>Ignore<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># The default is "Fail"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">validations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/>- <span style="color:green;font-weight:700">expression</span>:<span style="color:#bbb"> </span><span style="color:#b44">"object.spec.xyz == params.x"</span><span style="color:#bbb">  </span></span></span></code></pre></div></div></div><h3 id="validation-expression">Validation Expression</h3><p><code>spec.validations[i].expression</code> represents the expression which will be evaluated by CEL.
To learn more, see the <a href="https://github.com/google/cel-spec">CEL language specification</a>
CEL expressions have access to the contents of the Admission request/response, organized into CEL
variables as well as some other useful variables:</p><ul><li>'object' - The object from the incoming request. The value is null for DELETE requests.</li><li>'oldObject' - The existing object. The value is null for CREATE requests.</li><li>'request' - Attributes of the <a href="/docs/reference/config-api/apiserver-admission.v1/#admission-k8s-io-v1-AdmissionRequest">admission request</a>.</li><li>'params' - Parameter resource referred to by the policy binding being evaluated. The value is
null if <code>ParamKind</code> is not specified.</li><li><code>namespaceObject</code> - The namespace, as a Kubernetes resource, that the incoming object belongs to.
The value is null if the incoming object is cluster-scoped.</li><li><code>authorizer</code> - A CEL Authorizer. May be used to perform authorization checks for the principal
(authenticated user) of the request. See
<a href="https://pkg.go.dev/k8s.io/apiserver/pkg/cel/library#AuthzSelectors">AuthzSelectors</a> and
<a href="https://pkg.go.dev/k8s.io/apiserver/pkg/cel/library#Authz">Authz</a> in the Kubernetes CEL library
documentation for more details.</li><li><code>authorizer.requestResource</code> - A shortcut for an authorization check configured with the request
resource (group, resource, (subresource), namespace, name).</li></ul><p>In CEL expressions, variables like <code>object</code> and <code>oldObject</code> are strongly-typed.
You can access any field in the object's schema, such as <code>object.metadata.labels</code> and fields in <code>spec</code>.</p><p>For any Kubernetes object, including schemaless Custom Resources, CEL guarantees access to a minimal set of properties:
<code>apiVersion</code>, <code>kind</code>, <code>metadata.name</code>, and <code>metadata.generateName</code>.</p><p>Equality on arrays with list type of 'set' or 'map' ignores element order, i.e. [1, 2] == [2, 1].
Concatenation on arrays with x-kubernetes-list-type use the semantics of the list type:</p><ul><li>'set': <code>X + Y</code> performs a union where the array positions of all elements in <code>X</code> are preserved and
non-intersecting elements in <code>Y</code> are appended, retaining their partial order.</li><li>'map': <code>X + Y</code> performs a merge where the array positions of all keys in <code>X</code> are preserved but the values
are overwritten by values in <code>Y</code> when the key sets of <code>X</code> and <code>Y</code> intersect. Elements in <code>Y</code> with
non-intersecting keys are appended, retaining their partial order.</li></ul><h4 id="validation-expression-examples">Validation expression examples</h4><table><thead><tr><th>Expression</th><th>Purpose</th></tr></thead><tbody><tr><td><code>object.minReplicas &lt;= object.replicas &amp;&amp; object.replicas &lt;= object.maxReplicas</code></td><td>Validate that the three fields defining replicas are ordered appropriately</td></tr><tr><td><code>'Available' in object.stateCounts</code></td><td>Validate that an entry with the 'Available' key exists in a map</td></tr><tr><td><code>(size(object.list1) == 0) != (size(object.list2) == 0)</code></td><td>Validate that one of two lists is non-empty, but not both</td></tr><tr><td><code>!('MY_KEY' in object.map1) || object['MY_KEY'].matches('^[a-zA-Z]*$')</code></td><td>Validate the value of a map for a specific key, if it is in the map</td></tr><tr><td><code>object.envars.filter(e, e.name == 'MY_ENV').all(e, e.value.matches('^[a-zA-Z]*$')</code></td><td>Validate the 'value' field of a listMap entry where key field 'name' is 'MY_ENV'</td></tr><tr><td><code>has(object.expired) &amp;&amp; object.created + object.ttl &lt; object.expired</code></td><td>Validate that 'expired' date is after a 'create' date plus a 'ttl' duration</td></tr><tr><td><code>object.health.startsWith('ok')</code></td><td>Validate a 'health' string field has the prefix 'ok'</td></tr><tr><td><code>object.widgets.exists(w, w.key == 'x' &amp;&amp; w.foo &lt; 10)</code></td><td>Validate that the 'foo' property of a listMap item with a key 'x' is less than 10</td></tr><tr><td><code>type(object) == string ? object == '100%' : object == 1000</code></td><td>Validate an int-or-string field for both the int and string cases</td></tr><tr><td><code>object.metadata.name.startsWith(object.prefix)</code></td><td>Validate that an object's name has the prefix of another field value</td></tr><tr><td><code>object.set1.all(e, !(e in object.set2))</code></td><td>Validate that two listSets are disjoint</td></tr><tr><td><code>size(object.names) == size(object.details) &amp;&amp; object.names.all(n, n in object.details)</code></td><td>Validate the 'details' map is keyed by the items in the 'names' listSet</td></tr><tr><td><code>size(object.clusters.filter(c, c.name == object.primary)) == 1</code></td><td>Validate that the 'primary' property has one and only one occurrence in the 'clusters' listMap</td></tr></tbody></table><p>Read <a href="https://github.com/google/cel-spec/blob/v0.6.0/doc/langdef.md#evaluation">Supported evaluation on CEL</a>
for more information about CEL rules.</p><p><code>spec.validation[i].reason</code> represents a machine-readable description of why this validation failed.
If this is the first validation in the list to fail, this reason, as well as the corresponding
HTTP response code, are used in the HTTP response to the client.
The currently supported reasons are: <code>Unauthorized</code>, <code>Forbidden</code>, <code>Invalid</code>, <code>RequestEntityTooLarge</code>.
If not set, <code>StatusReasonInvalid</code> is used in the response to the client.</p><h3 id="matching-requests-matchconditions">Matching requests: <code>matchConditions</code></h3><p>You can define <em>match conditions</em> for a <code>ValidatingAdmissionPolicy</code> if you need fine-grained request filtering. These
conditions are useful if you find that match rules, <code>objectSelectors</code> and <code>namespaceSelectors</code> still
doesn't provide the filtering you want. Match conditions are
<a href="/docs/reference/using-api/cel/">CEL expressions</a>. All match conditions must evaluate to true for the
resource to be evaluated.</p><p>Here is an example illustrating a few different uses for match conditions:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/access/validating-admission-policy-match-conditions.yaml" download="access/validating-admission-policy-match-conditions.yaml"><code>access/validating-admission-policy-match-conditions.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;access-validating-admission-policy-match-conditions-yaml&quot;)" title="Copy access/validating-admission-policy-match-conditions.yaml to clipboard"/></div><div class="includecode" id="access-validating-admission-policy-match-conditions-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>admissionregistration.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ValidatingAdmissionPolicy<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span><span style="color:#b44">"demo-policy.example.com"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">failurePolicy</span>:<span style="color:#bbb"> </span>Fail<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">matchConstraints</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">resourceRules</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">apiGroups</span>:<span style="color:#bbb">   </span>[<span style="color:#b44">"*"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">apiVersions</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"*"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">operations</span>:<span style="color:#bbb">  </span>[<span style="color:#b44">"CREATE"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"UPDATE"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb">   </span>[<span style="color:#b44">"*"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">matchConditions</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span><span style="color:#b44">'exclude-leases'</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># Each match condition must have a unique name</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">expression</span>:<span style="color:#bbb"> </span><span style="color:#b44">'!(request.resource.group == "coordination.k8s.io" &amp;&amp; request.resource.resource == "leases")'</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># Match non-lease resources.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span><span style="color:#b44">'exclude-kubelet-requests'</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">expression</span>:<span style="color:#bbb"> </span><span style="color:#b44">'!("system:nodes" in request.userInfo.groups)'</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># Match requests made by non-node users.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span><span style="color:#b44">'rbac'</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># Skip RBAC requests.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">expression</span>:<span style="color:#bbb"> </span><span style="color:#b44">'request.resource.group != "rbac.authorization.k8s.io"'</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">validations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">expression</span>:<span style="color:#bbb"> </span><span style="color:#b44">"!object.metadata.name.contains('demo') || object.metadata.namespace == 'demo'"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>Match conditions have access to the same CEL variables as validation expressions.</p><p>In the event of an error evaluating a match condition the policy is not evaluated. Whether to reject
the request is determined as follows:</p><ol><li>If <strong>any</strong> match condition evaluated to <code>false</code> (regardless of other errors), the API server skips the policy.</li><li>Otherwise:<ul><li>for <a href="#failure-policy"><code>failurePolicy: Fail</code></a>, reject the request (without evaluating the policy).</li><li>for <a href="#failure-policy"><code>failurePolicy: Ignore</code></a>, proceed with the request but skip the policy.</li></ul></li></ol><h3 id="audit-annotations">Audit annotations</h3><p><code>auditAnnotations</code> may be used to include audit annotations in the audit event of the API request.</p><p>For example, here is an admission policy with an audit annotation:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/access/validating-admission-policy-audit-annotation.yaml" download="access/validating-admission-policy-audit-annotation.yaml"><code>access/validating-admission-policy-audit-annotation.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;access-validating-admission-policy-audit-annotation-yaml&quot;)" title="Copy access/validating-admission-policy-audit-annotation.yaml to clipboard"/></div><div class="includecode" id="access-validating-admission-policy-audit-annotation-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>admissionregistration.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ValidatingAdmissionPolicy<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span><span style="color:#b44">"demo-policy.example.com"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">failurePolicy</span>:<span style="color:#bbb"> </span>Fail<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">matchConstraints</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">resourceRules</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">apiGroups</span>:<span style="color:#bbb">   </span>[<span style="color:#b44">"apps"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">apiVersions</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"v1"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">operations</span>:<span style="color:#bbb">  </span>[<span style="color:#b44">"CREATE"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"UPDATE"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb">   </span>[<span style="color:#b44">"deployments"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">validations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">expression</span>:<span style="color:#bbb"> </span><span style="color:#b44">"object.spec.replicas &gt; 50"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">messageExpression</span>:<span style="color:#bbb"> </span><span style="color:#b44">"'Deployment spec.replicas set to ' + string(object.spec.replicas)"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">auditAnnotations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">key</span>:<span style="color:#bbb"> </span><span style="color:#b44">"high-replica-count"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">valueExpression</span>:<span style="color:#bbb"> </span><span style="color:#b44">"'Deployment spec.replicas set to ' + string(object.spec.replicas)"</span><span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>When an API request is validated with this admission policy, the resulting audit event will look like:</p><pre tabindex="0"><code># the audit event recorded
{
    "kind": "Event",
    "apiVersion": "audit.k8s.io/v1",
    "annotations": {
        "demo-policy.example.com/high-replica-count": "Deployment spec.replicas set to 128"
        # other annotations
        ...
    }
    # other fields
    ...
}
</code></pre><p>In this example the annotation will only be included if the <code>spec.replicas</code> of the Deployment is more than
50, otherwise the CEL expression evaluates to null and the annotation will not be included.</p><p>Note that audit annotation keys are prefixed by the name of the <code>ValidatingAdmissionPolicy</code> and a <code>/</code>. If
another admission controller, such as an admission webhook, uses the exact same audit annotation key, the
value of the first admission controller to include the audit annotation will be included in the audit
event and all other values will be ignored.</p><h3 id="message-expression">Message expression</h3><p>To return a more friendly message when the policy rejects a request, we can use a CEL expression
to composite a message with <code>spec.validations[i].messageExpression</code>. Similar to the validation expression,
a message expression has access to <code>object</code>, <code>oldObject</code>, <code>request</code>, <code>params</code>, and <code>namespaceObject</code>.
Unlike validations, message expression must evaluate to a string.</p><p>For example, to better inform the user of the reason of denial when the policy refers to a parameter,
we can have the following validation:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/access/deployment-replicas-policy.yaml" download="access/deployment-replicas-policy.yaml"><code>access/deployment-replicas-policy.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;access-deployment-replicas-policy-yaml&quot;)" title="Copy access/deployment-replicas-policy.yaml to clipboard"/></div><div class="includecode" id="access-deployment-replicas-policy-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>admissionregistration.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ValidatingAdmissionPolicy<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span><span style="color:#b44">"deploy-replica-policy.example.com"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">paramKind</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>rules.example.com/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ReplicaLimit<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">matchConstraints</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">resourceRules</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">apiGroups</span>:<span style="color:#bbb">   </span>[<span style="color:#b44">"apps"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">apiVersions</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"v1"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">operations</span>:<span style="color:#bbb">  </span>[<span style="color:#b44">"CREATE"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"UPDATE"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb">   </span>[<span style="color:#b44">"deployments"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">validations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">expression</span>:<span style="color:#bbb"> </span><span style="color:#b44">"object.spec.replicas &lt;= params.maxReplicas"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">messageExpression</span>:<span style="color:#bbb"> </span><span style="color:#b44">"'object.spec.replicas must be no greater than ' + string(params.maxReplicas)"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">reason</span>:<span style="color:#bbb"> </span>Invalid<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>After creating a params object that limits the replicas to 3 and setting up the binding,
when we try to create a deployment with 5 replicas, we will receive the following message.</p><pre tabindex="0"><code>$ kubectl create deploy --image=nginx nginx --replicas=5
error: failed to create deployment: deployments.apps "nginx" is forbidden: ValidatingAdmissionPolicy 'deploy-replica-policy.example.com' with binding 'demo-binding-test.example.com' denied request: object.spec.replicas must be no greater than 3
</code></pre><p>This is more informative than a static message of "too many replicas".</p><p>The message expression takes precedence over the static message defined in <code>spec.validations[i].message</code> if both are defined.
However, if the message expression fails to evaluate, the static message will be used instead.
Additionally, if the message expression evaluates to a multi-line string,
the evaluation result will be discarded and the static message will be used if present.
Note that static message is validated against multi-line strings.</p><h3 id="type-checking">Type checking</h3><p>When a policy definition is created or updated, the validation process parses the expressions it contains
and reports any syntax errors, rejecting the definition if any errors are found.
Afterward, the referred variables are checked for type errors, including missing fields and type confusion,
against the matched types of <code>spec.matchConstraints</code>.
The result of type checking can be retrieved from <code>status.typeChecking</code>.
The presence of <code>status.typeChecking</code> indicates the completion of type checking,
and an empty <code>status.typeChecking</code> means that no errors were detected.</p><p>For example, given the following policy definition:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/validatingadmissionpolicy/typechecking.yaml" download="validatingadmissionpolicy/typechecking.yaml"><code>validatingadmissionpolicy/typechecking.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;validatingadmissionpolicy-typechecking-yaml&quot;)" title="Copy validatingadmissionpolicy/typechecking.yaml to clipboard"/></div><div class="includecode" id="validatingadmissionpolicy-typechecking-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>admissionregistration.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ValidatingAdmissionPolicy<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span><span style="color:#b44">"deploy-replica-policy.example.com"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">matchConstraints</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">resourceRules</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">apiGroups</span>:<span style="color:#bbb">   </span>[<span style="color:#b44">"apps"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">apiVersions</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"v1"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">operations</span>:<span style="color:#bbb">  </span>[<span style="color:#b44">"CREATE"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"UPDATE"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb">   </span>[<span style="color:#b44">"deployments"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">validations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">expression</span>:<span style="color:#bbb"> </span><span style="color:#b44">"object.replicas &gt; 1"</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># should be "object.spec.replicas &gt; 1"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">message</span>:<span style="color:#bbb"> </span><span style="color:#b44">"must be replicated"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">reason</span>:<span style="color:#bbb"> </span>Invalid<span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>The status will yield the following information:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">status</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">typeChecking</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">expressionWarnings</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">fieldRef</span>:<span style="color:#bbb"> </span>spec.validations[0].expression<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">warning</span>:<span style="color:#bbb"> </span>|-<span style="color:#b44;font-style:italic">
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">        apps/v1, Kind=Deployment: ERROR: &lt;input&gt;:1:7: undefined field 'replicas'
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">         | object.replicas &gt; 1
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">         | ......^</span><span style="color:#bbb">        
</span></span></span></code></pre></div><p>If multiple resources are matched in <code>spec.matchConstraints</code>, all of matched resources will be checked against.
For example, the following policy definition</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/validatingadmissionpolicy/typechecking-multiple-match.yaml" download="validatingadmissionpolicy/typechecking-multiple-match.yaml"><code>validatingadmissionpolicy/typechecking-multiple-match.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;validatingadmissionpolicy-typechecking-multiple-match-yaml&quot;)" title="Copy validatingadmissionpolicy/typechecking-multiple-match.yaml to clipboard"/></div><div class="includecode" id="validatingadmissionpolicy-typechecking-multiple-match-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>admissionregistration.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ValidatingAdmissionPolicy<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span><span style="color:#b44">"replica-policy.example.com"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">matchConstraints</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">resourceRules</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">apiGroups</span>:<span style="color:#bbb">   </span>[<span style="color:#b44">"apps"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">apiVersions</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"v1"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">operations</span>:<span style="color:#bbb">  </span>[<span style="color:#b44">"CREATE"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"UPDATE"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb">   </span>[<span style="color:#b44">"deployments"</span>,<span style="color:#b44">"replicasets"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">validations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">expression</span>:<span style="color:#bbb"> </span><span style="color:#b44">"object.replicas &gt; 1"</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># should be "object.spec.replicas &gt; 1"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">message</span>:<span style="color:#bbb"> </span><span style="color:#b44">"must be replicated"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">reason</span>:<span style="color:#bbb"> </span>Invalid</span></span></code></pre></div></div></div><p>will have multiple types and type checking result of each type in the warning message.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">status</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">typeChecking</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">expressionWarnings</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">fieldRef</span>:<span style="color:#bbb"> </span>spec.validations[0].expression<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">warning</span>:<span style="color:#bbb"> </span>|-<span style="color:#b44;font-style:italic">
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">        apps/v1, Kind=Deployment: ERROR: &lt;input&gt;:1:7: undefined field 'replicas'
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">         | object.replicas &gt; 1
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">         | ......^
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">        apps/v1, Kind=ReplicaSet: ERROR: &lt;input&gt;:1:7: undefined field 'replicas'
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">         | object.replicas &gt; 1
</span></span></span><span style="display:flex"><span><span style="color:#b44;font-style:italic">         | ......^</span><span style="color:#bbb">        
</span></span></span></code></pre></div><p>Type Checking has the following limitation:</p><ul><li>No wildcard matching. If <code>spec.matchConstraints.resourceRules</code> contains <code>"*"</code> in any of <code>apiGroups</code>, <code>apiVersions</code> or <code>resources</code>,
the types that <code>"*"</code> matches will not be checked.</li><li>The number of matched types is limited to 10. This is to prevent a policy that manually specifying too many types.
to consume excessive computing resources. In the order of ascending group, version, and then resource, 11th combination and beyond are ignored.</li><li>Type Checking does not affect the policy behavior in any way. Even if the type checking detects errors, the policy will continue
to evaluate. If errors do occur during evaluate, the failure policy will decide its outcome.</li><li>Type Checking does not apply to CRDs, including matched CRD types and reference of paramKind. The support for CRDs will come in future release.</li></ul><h3 id="variable-composition">Variable composition</h3><p>If an expression grows too complicated, or part of the expression is reusable and computationally expensive to evaluate,
you can extract some part of the expressions into variables. A variable is a named expression that can be referred later
in <code>variables</code> in other expressions.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">variables</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>foo<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">expression</span>:<span style="color:#bbb"> </span><span style="color:#b44">"'foo' in object.spec.metadata.labels ? object.spec.metadata.labels['foo'] : 'default'"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">validations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">expression</span>:<span style="color:#bbb"> </span>variables.foo == 'bar'<span style="color:#bbb">
</span></span></span></code></pre></div><p>A variable is lazily evaluated when it is first referred. Any error that occurs during the evaluation will be
reported during the evaluation of the referring expression. Both the result and potential error are memorized and
count only once towards the runtime cost.</p><p>The order of variables are important because a variable can refer to other variables that are defined before it.
This ordering prevents circular references.</p><p>The following is a more complex example of enforcing that image repo names match the environment defined in its namespace.</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/access/image-matches-namespace-environment.policy.yaml" download="access/image-matches-namespace-environment.policy.yaml"><code>access/image-matches-namespace-environment.policy.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;access-image-matches-namespace-environment-policy-yaml&quot;)" title="Copy access/image-matches-namespace-environment.policy.yaml to clipboard"/></div><div class="includecode" id="access-image-matches-namespace-environment-policy-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#080;font-style:italic"># This policy enforces that all containers of a deployment has the image repo match the environment label of its namespace.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># Except for "exempt" deployments, or any containers that do not belong to the "example.com" organization (e.g. common sidecars).</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># For example, if the namespace has a label of {"environment": "staging"}, all container images must be either staging.example.com/*</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># or do not contain "example.com" at all, unless the deployment has {"exempt": "true"} label.</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>admissionregistration.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>ValidatingAdmissionPolicy<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span><span style="color:#b44">"image-matches-namespace-environment.policy.example.com"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">failurePolicy</span>:<span style="color:#bbb"> </span>Fail<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">matchConstraints</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">resourceRules</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">apiGroups</span>:<span style="color:#bbb">   </span>[<span style="color:#b44">"apps"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">apiVersions</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"v1"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">operations</span>:<span style="color:#bbb">  </span>[<span style="color:#b44">"CREATE"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"UPDATE"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">resources</span>:<span style="color:#bbb">   </span>[<span style="color:#b44">"deployments"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">variables</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>environment<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">expression</span>:<span style="color:#bbb"> </span><span style="color:#b44">"'environment' in namespaceObject.metadata.labels ? namespaceObject.metadata.labels['environment'] : 'prod'"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>exempt<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">expression</span>:<span style="color:#bbb"> </span><span style="color:#b44">"'exempt' in object.metadata.labels &amp;&amp; object.metadata.labels['exempt'] == 'true'"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>containers<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">expression</span>:<span style="color:#bbb"> </span><span style="color:#b44">"object.spec.template.spec.containers"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>containersToCheck<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">expression</span>:<span style="color:#bbb"> </span><span style="color:#b44">"variables.containers.filter(c, c.image.contains('example.com/'))"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">validations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">expression</span>:<span style="color:#bbb"> </span><span style="color:#b44">"variables.exempt || variables.containersToCheck.all(c, c.image.startsWith(variables.environment + '.'))"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">messageExpression</span>:<span style="color:#bbb"> </span><span style="color:#b44">"'only ' + variables.environment + ' images are allowed in namespace ' + namespaceObject.metadata.name"</span></span></span></code></pre></div></div></div><p>With the policy bound to the namespace <code>default</code>, which is labeled <code>environment: prod</code>,
the following attempt to create a deployment would be rejected.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl create deploy --image<span style="color:#666">=</span>dev.example.com/nginx invalid
</span></span></code></pre></div><p>The error message is similar to this.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console"><span style="display:flex"><span><span style="color:#888">error: failed to create deployment: deployments.apps "invalid" is forbidden: ValidatingAdmissionPolicy 'image-matches-namespace-environment.policy.example.com' with binding 'demo-binding-test.example.com' denied request: only prod images are allowed in namespace default
</span></span></span></code></pre></div><h2 id="api-kinds-exempt-from-admission-validation">API kinds exempt from admission validation</h2><p>There are certain API kinds that are exempt from admission-time validation checks. For example, you can't create a ValidatingAdmissionPolicy that prevents changes to ValidatingAdmissionPolicyBindings.</p><p>The list of exempt API kinds is:</p><ul><li><a href="/docs/reference/kubernetes-api/policy-resources/validating-admission-policy-v1/">ValidatingAdmissionPolicies</a></li><li><a href="/docs/reference/kubernetes-api/policy-resources/validating-admission-policy-binding-v1/">ValidatingAdmissionPolicyBindings</a></li><li>MutatingAdmissionPolicies</li><li>MutatingAdmissionPolicyBindings</li><li><a href="/docs/reference/kubernetes-api/authentication-resources/token-review-v1/">TokenReviews</a></li><li><a href="/docs/reference/kubernetes-api/authorization-resources/local-subject-access-review-v1/">LocalSubjectAccessReviews</a></li><li><a href="/docs/reference/kubernetes-api/authorization-resources/self-subject-access-review-v1/">SelfSubjectAccessReviews</a></li><li><a href="/docs/reference/kubernetes-api/authentication-resources/self-subject-review-v1/">SelfSubjectReviews</a></li></ul></div>