<div class="td-content"><h1 data-pagefind-weight="10">Running Kubernetes Node Components as a Non-root User</h1><div class="feature-state-notice feature-alpha"><span class="feature-state-name">FEATURE STATE:</span>
<code>Kubernetes v1.22 [alpha]</code></div><p>This document describes how to run Kubernetes Node components such as kubelet, CRI, OCI, and CNI
without root privileges, by using a <a class="glossary-tooltip" title="A Linux kernel feature to emulate superuser privilege for unprivileged users." data-toggle="tooltip" data-placement="top" href="https://man7.org/linux/man-pages/man7/user_namespaces.7.html" target="_blank" aria-label="user namespace">user namespace</a>.</p><p>This technique is also known as <em>rootless mode</em>.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4><p>This document describes how to run Kubernetes Node components (and hence pods) as a non-root user.</p><p>If you are just looking for how to run a pod as a non-root user, see <a href="/docs/tasks/configure-pod-container/security-context/">SecurityContext</a>.</p></div><h2 id="before-you-begin">Before you begin</h2><p>Your Kubernetes server must be at or later than version 1.22.</p><p>To check the version, enter <code>kubectl version</code>.</p><ul><li><a href="https://rootlesscontaine.rs/getting-started/common/cgroup2/">Enable Cgroup v2</a></li><li><a href="https://rootlesscontaine.rs/getting-started/common/login/">Enable systemd with user session</a></li><li><a href="https://rootlesscontaine.rs/getting-started/common/sysctl/">Configure several sysctl values, depending on host Linux distribution</a></li><li><a href="https://rootlesscontaine.rs/getting-started/common/subuid/">Ensure that your unprivileged user is listed in <code>/etc/subuid</code> and <code>/etc/subgid</code></a></li><li>Enable the <code>KubeletInUserNamespace</code> <a href="/docs/reference/command-line-tools-reference/feature-gates/">feature gate</a></li></ul><h2 id="running-kubernetes-inside-rootless-docker-podman">Running Kubernetes inside Rootless Docker/Podman</h2><h3 id="kind">kind</h3><p><a href="https://kind.sigs.k8s.io/">kind</a> supports running Kubernetes inside Rootless Docker or Rootless Podman.</p><p>See <a href="https://kind.sigs.k8s.io/docs/user/rootless/">Running kind with Rootless Docker</a>.</p><h3 id="minikube">minikube</h3><p><a href="https://minikube.sigs.k8s.io/">minikube</a> also supports running Kubernetes inside Rootless Docker or Rootless Podman.</p><p>See the Minikube documentation:</p><ul><li><a href="https://minikube.sigs.k8s.io/docs/drivers/docker/">Rootless Docker</a></li><li><a href="https://minikube.sigs.k8s.io/docs/drivers/podman/">Rootless Podman</a></li></ul><h2 id="running-kubernetes-inside-unprivileged-containers">Running Kubernetes inside Unprivileged Containers</h2><div class="alert alert-secondary callout third-party-content" role="alert"><strong>Note:</strong> This section links to third party projects that provide functionality required by Kubernetes. The Kubernetes project authors aren't responsible for these projects, which are listed alphabetically. To add a project to this list, read the <a href="/docs/contribute/style/content-guide/#third-party-content">content guide</a> before submitting a change. <a href="#third-party-content-disclaimer">More information.</a></div><h3 id="sysbox">sysbox</h3><p><a href="https://github.com/nestybox/sysbox">Sysbox</a> is an open-source container runtime
(similar to "runc") that supports running system-level workloads such as Docker
and Kubernetes inside unprivileged containers isolated with the Linux user
namespace.</p><p>See <a href="https://github.com/nestybox/sysbox/blob/master/docs/quickstart/kind.md">Sysbox Quick Start Guide: Kubernetes-in-Docker</a> for more info.</p><p>Sysbox supports running Kubernetes inside unprivileged containers without
requiring Cgroup v2 and without the <code>KubeletInUserNamespace</code> feature gate. It
does this by exposing specially crafted <code>/proc</code> and <code>/sys</code> filesystems inside
the container plus several other advanced OS virtualization techniques.</p><h2 id="running-rootless-kubernetes-directly-on-a-host">Running Rootless Kubernetes directly on a host</h2><div class="alert alert-secondary callout third-party-content" role="alert"><strong>Note:</strong> This section links to third party projects that provide functionality required by Kubernetes. The Kubernetes project authors aren't responsible for these projects, which are listed alphabetically. To add a project to this list, read the <a href="/docs/contribute/style/content-guide/#third-party-content">content guide</a> before submitting a change. <a href="#third-party-content-disclaimer">More information.</a></div><h3 id="k3s">K3s</h3><p><a href="https://k3s.io/">K3s</a> experimentally supports rootless mode.</p><p>See <a href="https://rancher.com/docs/k3s/latest/en/advanced/#running-k3s-with-rootless-mode-experimental">Running K3s with Rootless mode</a> for the usage.</p><h3 id="usernetes">Usernetes</h3><p><a href="https://github.com/rootless-containers/usernetes">Usernetes</a> is a reference distribution of Kubernetes that can be installed under <code>$HOME</code> directory without the root privilege.</p><p>Usernetes supports both containerd and CRI-O as CRI runtimes.
Usernetes supports multi-node clusters using Flannel (VXLAN).</p><p>See <a href="https://github.com/rootless-containers/usernetes">the Usernetes repo</a> for the usage.</p><h2 id="userns-the-hard-way">Manually deploy a node that runs the kubelet in a user namespace</h2><p>This section provides hints for running Kubernetes in a user namespace manually.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>This section is intended to be read by developers of Kubernetes distributions, not by end users.</div><h3 id="creating-a-user-namespace">Creating a user namespace</h3><p>The first step is to create a <a class="glossary-tooltip" title="A Linux kernel feature to emulate superuser privilege for unprivileged users." data-toggle="tooltip" data-placement="top" href="https://man7.org/linux/man-pages/man7/user_namespaces.7.html" target="_blank" aria-label="user namespace">user namespace</a>.</p><p>If you are trying to run Kubernetes in a user-namespaced container such as
Rootless Docker/Podman or LXC/LXD, you are all set, and you can go to the next subsection.</p><p>Otherwise you have to create a user namespace by yourself, by calling <code>unshare(2)</code> with <code>CLONE_NEWUSER</code>.</p><p>A user namespace can be also unshared by using command line tools such as:</p><ul><li><a href="https://man7.org/linux/man-pages/man1/unshare.1.html"><code>unshare(1)</code></a></li><li><a href="https://github.com/rootless-containers/rootlesskit">RootlessKit</a></li><li><a href="https://github.com/giuseppe/become-root">become-root</a></li></ul><p>After unsharing the user namespace, you will also have to unshare other namespaces such as mount namespace.</p><p>You do <em>not</em> need to call <code>chroot()</code> nor <code>pivot_root()</code> after unsharing the mount namespace,
however, you have to mount writable filesystems on several directories <em>in</em> the namespace.</p><p>At least, the following directories need to be writable <em>in</em> the namespace (not <em>outside</em> the namespace):</p><ul><li><code>/etc</code></li><li><code>/run</code></li><li><code>/var/logs</code></li><li><code>/var/lib/kubelet</code></li><li><code>/var/lib/cni</code></li><li><code>/var/lib/containerd</code> (for containerd)</li><li><code>/var/lib/containers</code> (for CRI-O)</li></ul><h3 id="creating-a-delegated-cgroup-tree">Creating a delegated cgroup tree</h3><p>In addition to the user namespace, you also need to have a writable cgroup tree with cgroup v2.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>Kubernetes support for running Node components in user namespaces requires cgroup v2.
Cgroup v1 is not supported.</div><p>If you are trying to run Kubernetes in Rootless Docker/Podman or LXC/LXD on a systemd-based host, you are all set.</p><p>Otherwise you have to create a systemd unit with <code>Delegate=yes</code> property to delegate a cgroup tree with writable permission.</p><p>On your node, systemd must already be configured to allow delegation; for more details, see
<a href="https://rootlesscontaine.rs/getting-started/common/cgroup2/">cgroup v2</a> in the Rootless
Containers documentation.</p><h3 id="configuring-network">Configuring network</h3><div class="alert alert-secondary callout third-party-content" role="alert"><strong>Note:</strong> This section links to third party projects that provide functionality required by Kubernetes. The Kubernetes project authors aren't responsible for these projects, which are listed alphabetically. To add a project to this list, read the <a href="/docs/contribute/style/content-guide/#third-party-content">content guide</a> before submitting a change. <a href="#third-party-content-disclaimer">More information.</a></div><p>The network namespace of the Node components has to have a non-loopback interface, which can be for example configured with
<a href="https://github.com/rootless-containers/slirp4netns">slirp4netns</a>,
<a href="https://github.com/moby/vpnkit">VPNKit</a>, or
<a href="https://www.man7.org/linux/man-pages/man1/lxc-user-nic.1.html">lxc-user-nic(1)</a>.</p><p>The network namespaces of the Pods can be configured with regular CNI plugins.
For multi-node networking, Flannel (VXLAN, 8472/UDP) is known to work.</p><p>Ports such as the kubelet port (10250/TCP) and <code>NodePort</code> service ports have to be exposed from the Node network namespace to
the host with an external port forwarder, such as RootlessKit, slirp4netns, or
<a href="https://linux.die.net/man/1/socat">socat(1)</a>.</p><p>You can use the port forwarder from K3s.
See <a href="https://rancher.com/docs/k3s/latest/en/advanced/#known-issues-with-rootless-mode">Running K3s in Rootless Mode</a>
for more details.
The implementation can be found in <a href="https://github.com/k3s-io/k3s/blob/v1.22.3+k3s1/pkg/rootlessports/controller.go">the <code>pkg/rootlessports</code> package</a> of k3s.</p><h3 id="configuring-cri">Configuring CRI</h3><p>The kubelet relies on a container runtime. You should deploy a container runtime such as
containerd or CRI-O and ensure that it is running within the user namespace before the kubelet starts.</p><ul class="nav nav-tabs" id="cri" role="tablist"><li class="nav-item"><a data-toggle="tab" class="nav-link active" href="#cri-0" role="tab" aria-controls="cri-0" aria-selected="true">containerd</a></li><li class="nav-item"><a data-toggle="tab" class="nav-link" href="#cri-1" role="tab" aria-controls="cri-1">CRI-O</a></li></ul><div class="tab-content" id="cri"><div id="cri-0" class="tab-pane show active" role="tabpanel" aria-labelledby="cri-0"><p><p>Running CRI plugin of containerd in a user namespace is supported since containerd 1.4.</p><p>Running containerd within a user namespace requires the following configurations.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-toml" data-lang="toml"><span style="display:flex"><span>version = <span style="color:#666">2</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>[plugins.<span style="color:#b44">"io.containerd.grpc.v1.cri"</span>]
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># Disable AppArmor</span>
</span></span><span style="display:flex"><span>  disable_apparmor = <span style="color:#a2f;font-weight:700">true</span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># Ignore an error during setting oom_score_adj</span>
</span></span><span style="display:flex"><span>  restrict_oom_score_adj = <span style="color:#a2f;font-weight:700">true</span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># Disable hugetlb cgroup v2 controller (because systemd does not support delegating hugetlb controller)</span>
</span></span><span style="display:flex"><span>  disable_hugetlb_controller = <span style="color:#a2f;font-weight:700">true</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>[plugins.<span style="color:#b44">"io.containerd.grpc.v1.cri"</span>.containerd]
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># Using non-fuse overlayfs is also possible for kernel &gt;= 5.11, but requires SELinux to be disabled</span>
</span></span><span style="display:flex"><span>  snapshotter = <span style="color:#b44">"fuse-overlayfs"</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>[plugins.<span style="color:#b44">"io.containerd.grpc.v1.cri"</span>.containerd.runtimes.runc.options]
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># We use cgroupfs that is delegated by systemd, so we do not use SystemdCgroup driver</span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># (unless you run another systemd in the namespace)</span>
</span></span><span style="display:flex"><span>  SystemdCgroup = <span style="color:#a2f;font-weight:700">false</span>
</span></span></code></pre></div><p>The default path of the configuration file is <code>/etc/containerd/config.toml</code>.
The path can be specified with <code>containerd -c /path/to/containerd/config.toml</code>.</p></p></div><div id="cri-1" class="tab-pane" role="tabpanel" aria-labelledby="cri-1"><p><p>Running CRI-O in a user namespace is supported since CRI-O 1.22.</p><p>CRI-O requires an environment variable <code>_CRIO_ROOTLESS=1</code> to be set.</p><p>The following configurations are also recommended:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-toml" data-lang="toml"><span style="display:flex"><span>[crio]
</span></span><span style="display:flex"><span>  storage_driver = <span style="color:#b44">"overlay"</span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># Using non-fuse overlayfs is also possible for kernel &gt;= 5.11, but requires SELinux to be disabled</span>
</span></span><span style="display:flex"><span>  storage_option = [<span style="color:#b44">"overlay.mount_program=/usr/local/bin/fuse-overlayfs"</span>]
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>[crio.runtime]
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># We use cgroupfs that is delegated by systemd, so we do not use "systemd" driver</span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># (unless you run another systemd in the namespace)</span>
</span></span><span style="display:flex"><span>  cgroup_manager = <span style="color:#b44">"cgroupfs"</span>
</span></span></code></pre></div><p>The default path of the configuration file is <code>/etc/crio/crio.conf</code>.
The path can be specified with <code>crio --config /path/to/crio/crio.conf</code>.</p></p></div></div><h3 id="configuring-kubelet">Configuring kubelet</h3><p>Running kubelet in a user namespace requires the following configuration:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>kubelet.config.k8s.io/v1beta1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>KubeletConfiguration<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">featureGates</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">KubeletInUserNamespace</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># We use cgroupfs that is delegated by systemd, so we do not use "systemd" driver</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># (unless you run another systemd in the namespace)</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">cgroupDriver</span>:<span style="color:#bbb"> </span><span style="color:#b44">"cgroupfs"</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>When the <code>KubeletInUserNamespace</code> feature gate is enabled, the kubelet ignores errors
that may happen during setting the following sysctl values on the node.</p><ul><li><code>vm.overcommit_memory</code></li><li><code>vm.panic_on_oom</code></li><li><code>kernel.panic</code></li><li><code>kernel.panic_on_oops</code></li><li><code>kernel.keys.root_maxkeys</code></li><li><code>kernel.keys.root_maxbytes</code>.</li></ul><p>Within a user namespace, the kubelet also ignores any error raised from trying to open <code>/dev/kmsg</code>.
This feature gate also allows kube-proxy to ignore an error during setting <code>RLIMIT_NOFILE</code>.</p><p>The <code>KubeletInUserNamespace</code> feature gate was introduced in Kubernetes v1.22 with "alpha" status.</p><p>Running kubelet in a user namespace without using this feature gate is also possible
by mounting a specially crafted proc filesystem (as done by <a href="https://github.com/nestybox/sysbox">Sysbox</a>), but not officially supported.</p><h3 id="configuring-kube-proxy">Configuring kube-proxy</h3><p>Running kube-proxy in a user namespace requires the following configuration:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>kubeproxy.config.k8s.io/v1alpha1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>KubeProxyConfiguration<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">mode</span>:<span style="color:#bbb"> </span><span style="color:#b44">"iptables"</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># or "userspace"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">conntrack</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># Skip setting sysctl value "net.netfilter.nf_conntrack_max"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">maxPerCore</span>:<span style="color:#bbb"> </span><span style="color:#666">0</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># Skip setting "net.netfilter.nf_conntrack_tcp_timeout_established"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">tcpEstablishedTimeout</span>:<span style="color:#bbb"> </span>0s<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:#080;font-style:italic"># Skip setting "net.netfilter.nf_conntrack_tcp_timeout_close"</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">tcpCloseWaitTimeout</span>:<span style="color:#bbb"> </span>0s<span style="color:#bbb">
</span></span></span></code></pre></div><h2 id="caveats">Caveats</h2><ul><li><p>Most of "non-local" volume drivers such as <code>nfs</code> and <code>iscsi</code> do not work.
Local volumes like <code>local</code>, <code>hostPath</code>, <code>emptyDir</code>, <code>configMap</code>, <code>secret</code>, and <code>downwardAPI</code> are known to work.</p></li><li><p>Some CNI plugins may not work. Flannel (VXLAN) is known to work.</p></li></ul><p>For more on this, see the <a href="https://rootlesscontaine.rs/caveats/">Caveats and Future work</a> page
on the rootlesscontaine.rs website.</p><h2 id="see-also">See Also</h2><ul><li><a href="https://rootlesscontaine.rs/">rootlesscontaine.rs</a></li><li><a href="https://www.slideshare.net/AkihiroSuda/kubecon-na-2020-containerd-rootless-containers-2020">Rootless Containers 2020 (KubeCon NA 2020)</a></li><li><a href="https://kind.sigs.k8s.io/docs/user/rootless/">Running kind with Rootless Docker</a></li><li><a href="https://github.com/rootless-containers/usernetes">Usernetes</a></li><li><a href="https://rancher.com/docs/k3s/latest/en/advanced/#running-k3s-with-rootless-mode-experimental">Running K3s with rootless mode</a></li><li><a href="https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/2033-kubelet-in-userns-aka-rootless">KEP-2033: Kubelet-in-UserNS (aka Rootless mode)</a></li></ul></div>