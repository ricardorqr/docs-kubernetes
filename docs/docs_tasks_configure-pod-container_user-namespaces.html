<div class="td-content"><h1 data-pagefind-weight="10">Use a User Namespace With a Pod</h1><div class="feature-state-notice feature-beta" title="Feature Gate: UserNamespacesSupport"><span class="feature-state-name">FEATURE STATE:</span>
<code>Kubernetes v1.33 [beta]</code> (enabled by default: true)</div><p>This page shows how to configure a user namespace for pods. This allows you to
isolate the user running inside the container from the one in the host.</p><p>A process running as root in a container can run as a different (non-root) user
in the host; in other words, the process has full privileges for operations
inside the user namespace, but is unprivileged for operations outside the
namespace.</p><p>You can use this feature to reduce the damage a compromised container can do to
the host or other pods in the same node. There are <a href="https://github.com/kubernetes/enhancements/tree/217d790720c5aef09b8bd4d6ca96284a0affe6c2/keps/sig-node/127-user-namespaces#motivation">several security
vulnerabilities</a> rated either <strong>HIGH</strong> or <strong>CRITICAL</strong> that were not
exploitable when user namespaces is active. It is expected user namespace will
mitigate some future vulnerabilities too.</p><p>Without using a user namespace a container running as root, in the case of a
container breakout, has root privileges on the node. And if some capability were
granted to the container, the capabilities are valid on the host too. None of
this is true when user namespaces are used.</p><h2 id="before-you-begin">Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul>Your Kubernetes server must be at or later than version v1.25.<p>To check the version, enter <code>kubectl version</code>.</p></p><div class="alert alert-secondary callout third-party-content" role="alert">ðŸ›‡ This item links to a third party project or product that is not part of Kubernetes itself. <a class="alert-more-info" href="#third-party-content-disclaimer">More information</a></div><ul><li>The node OS needs to be Linux</li><li>You need to exec commands in the host</li><li>You need to be able to exec into pods</li><li>You need to enable the <code>UserNamespacesSupport</code>
<a href="/docs/reference/command-line-tools-reference/feature-gates/">feature gate</a></li></ul><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>The feature gate to enable user namespaces was previously named
<code>UserNamespacesStatelessPodsSupport</code>, when only stateless pods were supported.
Only Kubernetes v1.25 through to v1.27 recognise <code>UserNamespacesStatelessPodsSupport</code>.</div><p>The cluster that you're using <strong>must</strong> include at least one node that meets the
<a href="/docs/concepts/workloads/pods/user-namespaces/#before-you-begin">requirements</a>
for using user namespaces with Pods.</p><p>If you have a mixture of nodes and only some of the nodes provide user namespace support for
Pods, you also need to ensure that the user namespace Pods are
<a href="/docs/concepts/scheduling-eviction/assign-pod-node/">scheduled</a> to suitable nodes.</p><h2 id="create-pod">Run a Pod that uses a user namespace</h2><p>A user namespace for a pod is enabled setting the <code>hostUsers</code> field of <code>.spec</code>
to <code>false</code>. For example:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/user-namespaces-stateless.yaml" download="pods/user-namespaces-stateless.yaml"><code>pods/user-namespaces-stateless.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;pods-user-namespaces-stateless-yaml&quot;)" title="Copy pods/user-namespaces-stateless.yaml to clipboard"/></div><div class="includecode" id="pods-user-namespaces-stateless-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Pod<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>userns<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">hostUsers</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:700">false</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>shell<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">command</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"sleep"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"infinity"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>debian<span style="color:#bbb">
</span></span></span></code></pre></div></div></div><ol><li><p>Create the pod on your cluster:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f https://k8s.io/examples/pods/user-namespaces-stateless.yaml
</span></span></code></pre></div></li><li><p>Exec into the pod and run <code>readlink /proc/self/ns/user</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl <span style="color:#a2f">exec</span> -ti userns -- bash
</span></span></code></pre></div></li></ol><p>Run this command:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>readlink /proc/self/ns/user
</span></span></code></pre></div><p>The output is similar to:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>user:<span style="color:#666">[</span>4026531837<span style="color:#666">]</span>
</span></span></code></pre></div><p>Also run:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>cat /proc/self/uid_map
</span></span></code></pre></div><p>The output is similar to:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#666">0</span>  <span style="color:#666">833617920</span>      <span style="color:#666">65536</span>
</span></span></code></pre></div><p>Then, open a shell in the host and run the same commands.</p><p>The <code>readlink</code> command shows the user namespace the process is running in. It
should be different when it is run on the host and inside the container.</p><p>The last number of the <code>uid_map</code> file inside the container must be 65536, on the
host it must be a bigger number.</p><p>If you are running the kubelet inside a user namespace, you need to compare the
output from running the command in the pod to the output of running in the host:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>readlink /proc/<span style="color:#b8860b">$pid</span>/ns/user
</span></span></code></pre></div><p>replacing <code>$pid</code> with the kubelet PID.</p></div>