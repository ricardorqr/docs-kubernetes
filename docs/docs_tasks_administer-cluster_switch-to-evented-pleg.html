<div class="td-content"><h1 data-pagefind-weight="10">Switching from Polling to CRI Event-based Updates to Container Status</h1><div class="feature-state-notice feature-alpha" title="Feature Gate: EventedPLEG"><span class="feature-state-name">FEATURE STATE:</span>
<code>Kubernetes v1.26 [alpha]</code> (enabled by default: false)</div><p>This page shows how to migrate nodes to use event based updates for container status. The event-based
implementation reduces node resource consumption by the kubelet, compared to the legacy approach
that relies on polling.
You may know this feature as <em>evented Pod lifecycle event generator (PLEG)</em>. That's the name used
internally within the Kubernetes project for a key implementation detail.</p><p>The polling based approach is referred to as <em>generic PLEG</em>.</p><h2 id="before-you-begin">Before you begin</h2><ul><li>You need to run a version of Kubernetes that provides this feature.
Kubernetes v1.27 includes beta support for event-based container
status updates. The feature is beta but is <em>disabled</em> by default
because it requires support from the container runtime.</li><li>Your Kubernetes server must be at or later than version 1.26.<p>To check the version, enter <code>kubectl version</code>.</p>If you are running a different version of Kubernetes, check the documentation for that release.</li><li>The container runtime in use must support container lifecycle events.
The kubelet automatically switches back to the legacy generic PLEG
mechanism if the container runtime does not announce support for
container lifecycle events, even if you have this feature gate enabled.</li></ul><h2 id="why-switch-to-evented-pleg">Why switch to Evented PLEG?</h2><ul><li>The <em>Generic PLEG</em> incurs non-negligible overhead due to frequent polling of container statuses.</li><li>This overhead is exacerbated by Kubelet's parallelized polling of container states, thus limiting
its scalability and causing poor performance and reliability problems.</li><li>The goal of <em>Evented PLEG</em> is to reduce unnecessary work during inactivity
by replacing periodic polling.</li></ul><h2 id="switching-to-evented-pleg">Switching to Evented PLEG</h2><ol><li><p>Start the Kubelet with the <a href="/docs/reference/command-line-tools-reference/feature-gates/">feature gate</a>
<code>EventedPLEG</code> enabled. You can manage the kubelet feature gates editing the kubelet
<a href="/docs/tasks/administer-cluster/kubelet-config-file/">config file</a> and restarting the kubelet service.
You need to do this on each node where you are using this feature.</p></li><li><p>Make sure the node is <a href="/docs/tasks/administer-cluster/safely-drain-node/">drained</a> before proceeding.</p></li><li><p>Start the container runtime with the container event generation enabled.</p><ul class="nav nav-tabs" id="tab-with-code" role="tablist"><li class="nav-item"><a data-toggle="tab" class="nav-link active" href="#tab-with-code-0" role="tab" aria-controls="tab-with-code-0" aria-selected="true">Containerd</a></li><li class="nav-item"><a data-toggle="tab" class="nav-link" href="#tab-with-code-1" role="tab" aria-controls="tab-with-code-1">CRI-O</a></li></ul><div class="tab-content" id="tab-with-code"><div id="tab-with-code-0" class="tab-pane show active" role="tabpanel" aria-labelledby="tab-with-code-0"><p><p>Version 1.7+</p></p></div><div id="tab-with-code-1" class="tab-pane" role="tabpanel" aria-labelledby="tab-with-code-1"><p><p>Version 1.26+</p><p>Check if the CRI-O is already configured to emit CRI events by verifying the configuration,</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>crio config | grep enable_pod_events
</span></span></code></pre></div><p>If it is enabled, the output should be similar to the following:</p><pre tabindex="0"><code class="language-none" data-lang="none">enable_pod_events = true
</code></pre><p>To enable it, start the CRI-O daemon with the flag <code>--enable-pod-events=true</code> or
use a dropin config with the following lines:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-toml" data-lang="toml"><span style="display:flex"><span>[crio.runtime]
</span></span><span style="display:flex"><span>enable_pod_events<span>:</span> <span style="color:#a2f;font-weight:700">true</span>
</span></span></code></pre></div></p></div></div>Your Kubernetes server must be at or later than version 1.26.<p>To check the version, enter <code>kubectl version</code>.</p></li><li><p>Verify that the kubelet is using event-based container stage change monitoring.
To check, look for the term <code>EventedPLEG</code> in the kubelet logs.</p><p>The output should be similar to this:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console"><span style="display:flex"><span><span style="color:#888">I0314 11:10:13.909915 1105457 feature_gate.go:249] feature gates: &amp;{map[EventedPLEG:true]}
</span></span></span></code></pre></div><p>If you have set <code>--v</code> to 4 and above, you might see more entries that indicate
that the kubelet is using event-based container state monitoring.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console"><span style="display:flex"><span><span style="color:#888">I0314 11:12:42.009542 1110177 evented.go:238] "Evented PLEG: Generated pod status from the received event" podUID=3b2c6172-b112-447a-ba96-94e7022912dc
</span></span></span><span style="display:flex"><span><span style="color:#888">I0314 11:12:44.623326 1110177 evented.go:238] "Evented PLEG: Generated pod status from the received event" podUID=b3fba5ea-a8c5-4b76-8f43-481e17e8ec40
</span></span></span><span style="display:flex"><span><span style="color:#888">I0314 11:12:44.714564 1110177 evented.go:238] "Evented PLEG: Generated pod status from the received event" podUID=b3fba5ea-a8c5-4b76-8f43-481e17e8ec40
</span></span></span></code></pre></div></li></ol><h2 id="what-s-next">What's next</h2><ul><li>Learn more about the design in the Kubernetes Enhancement Proposal (KEP):
<a href="https://github.com/kubernetes/enhancements/blob/5b258a990adabc2ffdc9d84581ea6ed696f7ce6c/keps/sig-node/3386-kubelet-evented-pleg/README.md">Kubelet Evented PLEG for Better Performance</a>.</li></ul></div>