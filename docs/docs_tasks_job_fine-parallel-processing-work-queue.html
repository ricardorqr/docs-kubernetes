<div class="td-content"><h1 data-pagefind-weight="10">Fine Parallel Processing Using a Work Queue</h1><p>In this example, you will run a Kubernetes Job that runs multiple parallel
tasks as worker processes, each running as a separate Pod.</p><p>In this example, as each pod is created, it picks up one unit of work
from a task queue, processes it, and repeats until the end of the queue is reached.</p><p>Here is an overview of the steps in this example:</p><ol><li><strong>Start a storage service to hold the work queue.</strong> In this example, you will use Redis to store
work items. In the <a href="/docs/tasks/job/coarse-parallel-processing-work-queue/">previous example</a>,
you used RabbitMQ. In this example, you will use Redis and a custom work-queue client library;
this is because AMQP does not provide a good way for clients to
detect when a finite-length work queue is empty. In practice you would set up a store such
as Redis once and reuse it for the work queues of many jobs, and other things.</li><li><strong>Create a queue, and fill it with messages.</strong> Each message represents one task to be done. In
this example, a message is an integer that we will do a lengthy computation on.</li><li><strong>Start a Job that works on tasks from the queue</strong>. The Job starts several pods. Each pod takes
one task from the message queue, processes it, and repeats until the end of the queue is reached.</li></ol><h2 id="before-you-begin">Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul><p>You will need a container image registry where you can upload images to run in your cluster.
The example uses <a href="https://hub.docker.com/">Docker Hub</a>, but you could adapt it to a different
container image registry.</p><p>This task example also assumes that you have Docker installed locally. You use Docker to
build container images.</p><p>Be familiar with the basic,
non-parallel, use of <a href="/docs/concepts/workloads/controllers/job/">Job</a>.</p><h2 id="starting-redis">Starting Redis</h2><p>For this example, for simplicity, you will start a single instance of Redis.
See the <a href="https://github.com/kubernetes/examples/tree/master/web/guestbook/">Redis Example</a> for an example
of deploying Redis scalably and redundantly.</p><p>You could also download the following files directly:</p><ul><li><a href="/examples/application/job/redis/redis-pod.yaml"><code>redis-pod.yaml</code></a></li><li><a href="/examples/application/job/redis/redis-service.yaml"><code>redis-service.yaml</code></a></li><li><a href="/examples/application/job/redis/Dockerfile"><code>Dockerfile</code></a></li><li><a href="/examples/application/job/redis/job.yaml"><code>job.yaml</code></a></li><li><a href="/examples/application/job/redis/rediswq.py"><code>rediswq.py</code></a></li><li><a href="/examples/application/job/redis/worker.py"><code>worker.py</code></a></li></ul><p>To start a single instance of Redis, you need to create the redis pod and redis service:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl apply -f https://k8s.io/examples/application/job/redis/redis-pod.yaml
</span></span><span style="display:flex"><span>kubectl apply -f https://k8s.io/examples/application/job/redis/redis-service.yaml
</span></span></code></pre></div><h2 id="filling-the-queue-with-tasks">Filling the queue with tasks</h2><p>Now let's fill the queue with some "tasks". In this example, the tasks are strings to be
printed.</p><p>Start a temporary interactive pod for running the Redis CLI.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl run -i --tty temp --image redis --command <span style="color:#b44">"/bin/sh"</span>
</span></span></code></pre></div><pre tabindex="0"><code>Waiting for pod default/redis2-c7h78 to be running, status is Pending, pod ready: false
Hit enter for command prompt
</code></pre><p>Now hit enter, start the Redis CLI, and create a list with some work items in it.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>redis-cli -h redis
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console"><span style="display:flex"><span><span style="color:#888">redis:6379&gt; rpush job2 "apple"
</span></span></span><span style="display:flex"><span><span style="color:#888">(integer) 1
</span></span></span><span style="display:flex"><span><span style="color:#888">redis:6379&gt; rpush job2 "banana"
</span></span></span><span style="display:flex"><span><span style="color:#888">(integer) 2
</span></span></span><span style="display:flex"><span><span style="color:#888">redis:6379&gt; rpush job2 "cherry"
</span></span></span><span style="display:flex"><span><span style="color:#888">(integer) 3
</span></span></span><span style="display:flex"><span><span style="color:#888">redis:6379&gt; rpush job2 "date"
</span></span></span><span style="display:flex"><span><span style="color:#888">(integer) 4
</span></span></span><span style="display:flex"><span><span style="color:#888">redis:6379&gt; rpush job2 "fig"
</span></span></span><span style="display:flex"><span><span style="color:#888">(integer) 5
</span></span></span><span style="display:flex"><span><span style="color:#888">redis:6379&gt; rpush job2 "grape"
</span></span></span><span style="display:flex"><span><span style="color:#888">(integer) 6
</span></span></span><span style="display:flex"><span><span style="color:#888">redis:6379&gt; rpush job2 "lemon"
</span></span></span><span style="display:flex"><span><span style="color:#888">(integer) 7
</span></span></span><span style="display:flex"><span><span style="color:#888">redis:6379&gt; rpush job2 "melon"
</span></span></span><span style="display:flex"><span><span style="color:#888">(integer) 8
</span></span></span><span style="display:flex"><span><span style="color:#888">redis:6379&gt; rpush job2 "orange"
</span></span></span><span style="display:flex"><span><span style="color:#888">(integer) 9
</span></span></span><span style="display:flex"><span><span style="color:#888">redis:6379&gt; lrange job2 0 -1
</span></span></span><span style="display:flex"><span><span style="color:#888">1) "apple"
</span></span></span><span style="display:flex"><span><span style="color:#888">2) "banana"
</span></span></span><span style="display:flex"><span><span style="color:#888">3) "cherry"
</span></span></span><span style="display:flex"><span><span style="color:#888">4) "date"
</span></span></span><span style="display:flex"><span><span style="color:#888">5) "fig"
</span></span></span><span style="display:flex"><span><span style="color:#888">6) "grape"
</span></span></span><span style="display:flex"><span><span style="color:#888">7) "lemon"
</span></span></span><span style="display:flex"><span><span style="color:#888">8) "melon"
</span></span></span><span style="display:flex"><span><span style="color:#888">9) "orange"
</span></span></span></code></pre></div><p>So, the list with key <code>job2</code> will be the work queue.</p><p>Note: if you do not have Kube DNS setup correctly, you may need to change
the first step of the above block to <code>redis-cli -h $REDIS_SERVICE_HOST</code>.</p><h2 id="create-an-image">Create a container image</h2><p>Now you are ready to create an image that will process the work in that queue.</p><p>You're going to use a Python worker program with a Redis client to read
the messages from the message queue.</p><p>A simple Redis work queue client library is provided,
called <code>rediswq.py</code> (<a href="/examples/application/job/redis/rediswq.py">Download</a>).</p><p>The "worker" program in each Pod of the Job uses the work queue
client library to get work. Here it is:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/job/redis/worker.py" download="application/job/redis/worker.py"><code>application/job/redis/worker.py</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;application-job-redis-worker-py&quot;)" title="Copy application/job/redis/worker.py to clipboard"/></div><div class="includecode" id="application-job-redis-worker-py"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="display:flex"><span><span style="color:#080;font-style:italic">#!/usr/bin/env python</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#a2f;font-weight:700">import</span> <span style="color:#00f;font-weight:700">time</span>
</span></span><span style="display:flex"><span><span style="color:#a2f;font-weight:700">import</span> <span style="color:#00f;font-weight:700">rediswq</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>host<span style="color:#666">=</span><span style="color:#b44">"redis"</span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># Uncomment next two lines if you do not have Kube-DNS working.</span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># import os</span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># host = os.getenv("REDIS_SERVICE_HOST")</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>q <span style="color:#666">=</span> rediswq<span style="color:#666">.</span>RedisWQ(name<span style="color:#666">=</span><span style="color:#b44">"job2"</span>, host<span style="color:#666">=</span>host)
</span></span><span style="display:flex"><span><span style="color:#a2f">print</span>(<span style="color:#b44">"Worker with sessionID: "</span> <span style="color:#666">+</span>  q<span style="color:#666">.</span>sessionID())
</span></span><span style="display:flex"><span><span style="color:#a2f">print</span>(<span style="color:#b44">"Initial queue state: empty="</span> <span style="color:#666">+</span> <span style="color:#a2f">str</span>(q<span style="color:#666">.</span>empty()))
</span></span><span style="display:flex"><span><span style="color:#a2f;font-weight:700">while</span> <span style="color:#a2f;font-weight:700">not</span> q<span style="color:#666">.</span>empty():
</span></span><span style="display:flex"><span>  item <span style="color:#666">=</span> q<span style="color:#666">.</span>lease(lease_secs<span style="color:#666">=</span><span style="color:#666">10</span>, block<span style="color:#666">=</span><span style="color:#a2f;font-weight:700">True</span>, timeout<span style="color:#666">=</span><span style="color:#666">2</span>) 
</span></span><span style="display:flex"><span>  <span style="color:#a2f;font-weight:700">if</span> item <span style="color:#a2f;font-weight:700">is</span> <span style="color:#a2f;font-weight:700">not</span> <span style="color:#a2f;font-weight:700">None</span>:
</span></span><span style="display:flex"><span>    itemstr <span style="color:#666">=</span> item<span style="color:#666">.</span>decode(<span style="color:#b44">"utf-8"</span>)
</span></span><span style="display:flex"><span>    <span style="color:#a2f">print</span>(<span style="color:#b44">"Working on "</span> <span style="color:#666">+</span> itemstr)
</span></span><span style="display:flex"><span>    time<span style="color:#666">.</span>sleep(<span style="color:#666">10</span>) <span style="color:#080;font-style:italic"># Put your actual work here instead of sleep.</span>
</span></span><span style="display:flex"><span>    q<span style="color:#666">.</span>complete(item)
</span></span><span style="display:flex"><span>  <span style="color:#a2f;font-weight:700">else</span>:
</span></span><span style="display:flex"><span>    <span style="color:#a2f">print</span>(<span style="color:#b44">"Waiting for work"</span>)
</span></span><span style="display:flex"><span><span style="color:#a2f">print</span>(<span style="color:#b44">"Queue empty, exiting"</span>)
</span></span></code></pre></div></div></div><p>You could also download <a href="/examples/application/job/redis/worker.py"><code>worker.py</code></a>,
<a href="/examples/application/job/redis/rediswq.py"><code>rediswq.py</code></a>, and
<a href="/examples/application/job/redis/Dockerfile"><code>Dockerfile</code></a> files, then build
the container image. Here's an example using Docker to do the image build:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>docker build -t job-wq-2 .
</span></span></code></pre></div><h3 id="push-the-image">Push the image</h3><p>For the <a href="https://hub.docker.com/">Docker Hub</a>, tag your app image with
your username and push to the Hub with the below commands. Replace
<code>&lt;username&gt;</code> with your Hub username.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>docker tag job-wq-2 &lt;username&gt;/job-wq-2
</span></span><span style="display:flex"><span>docker push &lt;username&gt;/job-wq-2
</span></span></code></pre></div><p>You need to push to a public repository or <a href="/docs/concepts/containers/images/">configure your cluster to be able to access
your private repository</a>.</p><h2 id="defining-a-job">Defining a Job</h2><p>Here is a manifest for the Job you will create:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/job/redis/job.yaml" download="application/job/redis/job.yaml"><code>application/job/redis/job.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;application-job-redis-job-yaml&quot;)" title="Copy application/job/redis/job.yaml to clipboard"/></div><div class="includecode" id="application-job-redis-job-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>batch/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Job<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>job-wq-2<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">parallelism</span>:<span style="color:#bbb"> </span><span style="color:#666">2</span><span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">template</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>job-wq-2<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>c<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>gcr.io/myproject/job-wq-2<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">restartPolicy</span>:<span style="color:#bbb"> </span>OnFailure<span style="color:#bbb">
</span></span></span></code></pre></div></div></div><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>Be sure to edit the manifest to
change <code>gcr.io/myproject</code> to your own path.</div><p>In this example, each pod works on several items from the queue and then exits when there are no more items.
Since the workers themselves detect when the workqueue is empty, and the Job controller does not
know about the workqueue, it relies on the workers to signal when they are done working.
The workers signal that the queue is empty by exiting with success. So, as soon as <strong>any</strong> worker
exits with success, the controller knows the work is done, and that the Pods will exit soon.
So, you need to leave the completion count of the Job unset. The job controller will wait for
the other pods to complete too.</p><h2 id="running-the-job">Running the Job</h2><p>So, now run the Job:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># this assumes you downloaded and then edited the manifest already</span>
</span></span><span style="display:flex"><span>kubectl apply -f ./job.yaml
</span></span></code></pre></div><p>Now wait a bit, then check on the Job:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl describe jobs/job-wq-2
</span></span></code></pre></div><pre tabindex="0"><code>Name:             job-wq-2
Namespace:        default
Selector:         controller-uid=b1c7e4e3-92e1-11e7-b85e-fa163ee3c11f
Labels:           controller-uid=b1c7e4e3-92e1-11e7-b85e-fa163ee3c11f
                  job-name=job-wq-2
Annotations:      &lt;none&gt;
Parallelism:      2
Completions:      &lt;unset&gt;
Start Time:       Mon, 11 Jan 2022 17:07:59 +0000
Pods Statuses:    1 Running / 0 Succeeded / 0 Failed
Pod Template:
  Labels:       controller-uid=b1c7e4e3-92e1-11e7-b85e-fa163ee3c11f
                job-name=job-wq-2
  Containers:
   c:
    Image:              container-registry.example/exampleproject/job-wq-2
    Port:
    Environment:        &lt;none&gt;
    Mounts:             &lt;none&gt;
  Volumes:              &lt;none&gt;
Events:
  FirstSeen    LastSeen    Count    From            SubobjectPath    Type        Reason            Message
  ---------    --------    -----    ----            -------------    --------    ------            -------
  33s          33s         1        {job-controller }                Normal      SuccessfulCreate  Created pod: job-wq-2-lglf8
</code></pre><p>You can wait for the Job to succeed, with a timeout:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># The check for condition name is case insensitive</span>
</span></span><span style="display:flex"><span>kubectl <span style="color:#a2f">wait</span> --for<span style="color:#666">=</span><span style="color:#b8860b">condition</span><span style="color:#666">=</span><span style="color:#a2f">complete</span> --timeout<span style="color:#666">=</span>300s job/job-wq-2
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl logs pods/job-wq-2-7r7b2
</span></span></code></pre></div><pre tabindex="0"><code>Worker with sessionID: bbd72d0a-9e5c-4dd6-abf6-416cc267991f
Initial queue state: empty=False
Working on banana
Working on date
Working on lemon
</code></pre><p>As you can see, one of the pods for this Job worked on several work units.</p><h2 id="alternatives">Alternatives</h2><p>If running a queue service or modifying your containers to use a work queue is inconvenient, you may
want to consider one of the other
<a href="/docs/concepts/workloads/controllers/job/#job-patterns">job patterns</a>.</p><p>If you have a continuous stream of background processing work to run, then
consider running your background workers with a ReplicaSet instead,
and consider running a background processing library such as
<a href="https://github.com/resque/resque">https://github.com/resque/resque</a>.</p></div>