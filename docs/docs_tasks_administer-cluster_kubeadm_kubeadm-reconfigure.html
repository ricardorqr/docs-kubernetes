<div class="td-content"><h1 data-pagefind-weight="10">Reconfiguring a kubeadm cluster</h1><p>kubeadm does not support automated ways of reconfiguring components that
were deployed on managed nodes. One way of automating this would be
by using a custom <a href="/docs/concepts/extend-kubernetes/operator/">operator</a>.</p><p>To modify the components configuration you must manually edit associated cluster
objects and files on disk.</p><p>This guide shows the correct sequence of steps that need to be performed
to achieve kubeadm cluster reconfiguration.</p><h2 id="before-you-begin">Before you begin</h2><ul><li>You need a cluster that was deployed using kubeadm</li><li>Have administrator credentials (<code>/etc/kubernetes/admin.conf</code>) and network connectivity
to a running kube-apiserver in the cluster from a host that has kubectl installed</li><li>Have a text editor installed on all hosts</li></ul><h2 id="reconfiguring-the-cluster">Reconfiguring the cluster</h2><p>kubeadm writes a set of cluster wide component configuration options in
ConfigMaps and other objects. These objects must be manually edited. The command <code>kubectl edit</code>
can be used for that.</p><p>The <code>kubectl edit</code> command will open a text editor where you can edit and save the object directly.</p><p>You can use the environment variables <code>KUBECONFIG</code> and <code>KUBE_EDITOR</code> to specify the location of
the kubectl consumed kubeconfig file and preferred text editor.</p><p>For example:</p><pre tabindex="0"><code>KUBECONFIG=/etc/kubernetes/admin.conf KUBE_EDITOR=nano kubectl edit &lt;parameters&gt;
</code></pre><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>Upon saving any changes to these cluster objects, components running on nodes may not be
automatically updated. The steps below instruct you on how to perform that manually.</div><div class="alert alert-danger" role="alert"><h4 class="alert-heading">Warning:</h4>Component configuration in ConfigMaps is stored as unstructured data (YAML string).
This means that validation will not be performed upon updating the contents of a ConfigMap.
You have to be careful to follow the documented API format for a particular
component configuration and avoid introducing typos and YAML indentation mistakes.</div><h3 id="applying-cluster-configuration-changes">Applying cluster configuration changes</h3><h4 id="updating-the-clusterconfiguration">Updating the <code>ClusterConfiguration</code></h4><p>During cluster creation and upgrade, kubeadm writes its
<a href="/docs/reference/config-api/kubeadm-config.v1beta4/"><code>ClusterConfiguration</code></a>
in a ConfigMap called <code>kubeadm-config</code> in the <code>kube-system</code> namespace.</p><p>To change a particular option in the <code>ClusterConfiguration</code> you can edit the ConfigMap with this command:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl edit cm -n kube-system kubeadm-config
</span></span></code></pre></div><p>The configuration is located under the <code>data.ClusterConfiguration</code> key.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>The <code>ClusterConfiguration</code> includes a variety of options that affect the configuration of individual
components such as kube-apiserver, kube-scheduler, kube-controller-manager, CoreDNS, etcd and kube-proxy.
Changes to the configuration must be reflected on node components manually.</div><h4 id="reflecting-clusterconfiguration-changes-on-control-plane-nodes">Reflecting <code>ClusterConfiguration</code> changes on control plane nodes</h4><p>kubeadm manages the control plane components as static Pod manifests located in
the directory <code>/etc/kubernetes/manifests</code>.
Any changes to the <code>ClusterConfiguration</code> under the <code>apiServer</code>, <code>controllerManager</code>, <code>scheduler</code> or <code>etcd</code>
keys must be reflected in the associated files in the manifests directory on a control plane node.</p><p>Such changes may include:</p><ul><li><code>extraArgs</code> - requires updating the list of flags passed to a component container</li><li><code>extraVolumes</code> - requires updating the volume mounts for a component container</li><li><code>*SANs</code> - requires writing new certificates with updated Subject Alternative Names</li></ul><p>Before proceeding with these changes, make sure you have backed up the directory <code>/etc/kubernetes/</code>.</p><p>To write new certificates you can use:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubeadm init phase certs &lt;component-name&gt; --config &lt;config-file&gt;
</span></span></code></pre></div><p>To write new manifest files in <code>/etc/kubernetes/manifests</code> you can use:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># For Kubernetes control plane components</span>
</span></span><span style="display:flex"><span>kubeadm init phase control-plane &lt;component-name&gt; --config &lt;config-file&gt;
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># For local etcd</span>
</span></span><span style="display:flex"><span>kubeadm init phase etcd <span style="color:#a2f">local</span> --config &lt;config-file&gt;
</span></span></code></pre></div><p>The <code>&lt;config-file&gt;</code> contents must match the updated <code>ClusterConfiguration</code>.
The <code>&lt;component-name&gt;</code> value must be a name of a Kubernetes control plane component (<code>apiserver</code>, <code>controller-manager</code> or <code>scheduler</code>).</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>Updating a file in <code>/etc/kubernetes/manifests</code> will tell the kubelet to restart the static Pod for the corresponding component.
Try doing these changes one node at a time to leave the cluster without downtime.</div><h3 id="applying-kubelet-configuration-changes">Applying kubelet configuration changes</h3><h4 id="updating-the-kubeletconfiguration">Updating the <code>KubeletConfiguration</code></h4><p>During cluster creation and upgrade, kubeadm writes its
<a href="/docs/reference/config-api/kubelet-config.v1beta1/"><code>KubeletConfiguration</code></a>
in a ConfigMap called <code>kubelet-config</code> in the <code>kube-system</code> namespace.</p><p>You can edit the ConfigMap with this command:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl edit cm -n kube-system kubelet-config
</span></span></code></pre></div><p>The configuration is located under the <code>data.kubelet</code> key.</p><h4 id="reflecting-the-kubelet-changes">Reflecting the kubelet changes</h4><p>To reflect the change on kubeadm nodes you must do the following:</p><ul><li>Log in to a kubeadm node</li><li>Run <code>kubeadm upgrade node phase kubelet-config</code> to download the latest <code>kubelet-config</code>
ConfigMap contents into the local file <code>/var/lib/kubelet/config.yaml</code></li><li>Edit the file <code>/var/lib/kubelet/kubeadm-flags.env</code> to apply additional configuration with
flags</li><li>Restart the kubelet service with <code>systemctl restart kubelet</code></li></ul><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>Do these changes one node at a time to allow workloads to be rescheduled properly.</div><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>During <code>kubeadm upgrade</code>, kubeadm downloads the <code>KubeletConfiguration</code> from the
<code>kubelet-config</code> ConfigMap and overwrite the contents of <code>/var/lib/kubelet/config.yaml</code>.
This means that node local configuration must be applied either by flags in
<code>/var/lib/kubelet/kubeadm-flags.env</code> or by manually updating the contents of
<code>/var/lib/kubelet/config.yaml</code> after <code>kubeadm upgrade</code>, and then restarting the kubelet.</div><h3 id="applying-kube-proxy-configuration-changes">Applying kube-proxy configuration changes</h3><h4 id="updating-the-kubeproxyconfiguration">Updating the <code>KubeProxyConfiguration</code></h4><p>During cluster creation and upgrade, kubeadm writes its
<a href="/docs/reference/config-api/kube-proxy-config.v1alpha1/"><code>KubeProxyConfiguration</code></a>
in a ConfigMap in the <code>kube-system</code> namespace called <code>kube-proxy</code>.</p><p>This ConfigMap is used by the <code>kube-proxy</code> DaemonSet in the <code>kube-system</code> namespace.</p><p>To change a particular option in the <code>KubeProxyConfiguration</code>, you can edit the ConfigMap with this command:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl edit cm -n kube-system kube-proxy
</span></span></code></pre></div><p>The configuration is located under the <code>data.config.conf</code> key.</p><h4 id="reflecting-the-kube-proxy-changes">Reflecting the kube-proxy changes</h4><p>Once the <code>kube-proxy</code> ConfigMap is updated, you can restart all kube-proxy Pods:</p><p>Delete the Pods with:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl delete po -n kube-system -l k8s-app<span style="color:#666">=</span>kube-proxy
</span></span></code></pre></div><p>New Pods that use the updated ConfigMap will be created.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>Because kubeadm deploys kube-proxy as a DaemonSet, node specific configuration is unsupported.</div><h3 id="applying-coredns-configuration-changes">Applying CoreDNS configuration changes</h3><h4 id="updating-the-coredns-deployment-and-service">Updating the CoreDNS Deployment and Service</h4><p>kubeadm deploys CoreDNS as a Deployment called <code>coredns</code> and with a Service <code>kube-dns</code>,
both in the <code>kube-system</code> namespace.</p><p>To update any of the CoreDNS settings, you can edit the Deployment and
Service objects:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl edit deployment -n kube-system coredns
</span></span><span style="display:flex"><span>kubectl edit service -n kube-system kube-dns
</span></span></code></pre></div><h4 id="reflecting-the-coredns-changes">Reflecting the CoreDNS changes</h4><p>Once the CoreDNS changes are applied you can restart the CoreDNS deployment:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl rollout restart deployment -n kube-system coredns
</span></span></code></pre></div><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>kubeadm does not allow CoreDNS configuration during cluster creation and upgrade.
This means that if you execute <code>kubeadm upgrade apply</code>, your changes to the CoreDNS
objects will be lost and must be reapplied.</div><h2 id="persisting-the-reconfiguration">Persisting the reconfiguration</h2><p>During the execution of <code>kubeadm upgrade</code> on a managed node, kubeadm might overwrite configuration
that was applied after the cluster was created (reconfiguration).</p><h3 id="persisting-node-object-reconfiguration">Persisting Node object reconfiguration</h3><p>kubeadm writes Labels, Taints, CRI socket and other information on the Node object for a particular
Kubernetes node. To change any of the contents of this Node object you can use:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl edit no &lt;node-name&gt;
</span></span></code></pre></div><p>During <code>kubeadm upgrade</code> the contents of such a Node might get overwritten.
If you would like to persist your modifications to the Node object after upgrade,
you can prepare a <a href="/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/">kubectl patch</a>
and apply it to the Node object:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl patch no &lt;node-name&gt; --patch-file &lt;patch-file&gt;
</span></span></code></pre></div><h4 id="persisting-control-plane-component-reconfiguration">Persisting control plane component reconfiguration</h4><p>The main source of control plane configuration is the <code>ClusterConfiguration</code>
object stored in the cluster. To extend the static Pod manifests configuration,
<a href="/docs/setup/production-environment/tools/kubeadm/control-plane-flags/#patches">patches</a> can be used.</p><p>These patch files must remain as files on the control plane nodes to ensure that
they can be used by the <code>kubeadm upgrade ... --patches &lt;directory&gt;</code>.</p><p>If reconfiguration is done to the <code>ClusterConfiguration</code> and static Pod manifests on disk,
the set of node specific patches must be updated accordingly.</p><h4 id="persisting-kubelet-reconfiguration">Persisting kubelet reconfiguration</h4><p>Any changes to the <code>KubeletConfiguration</code> stored in <code>/var/lib/kubelet/config.yaml</code> will be overwritten on
<code>kubeadm upgrade</code> by downloading the contents of the cluster wide <code>kubelet-config</code> ConfigMap.
To persist kubelet node specific configuration either the file <code>/var/lib/kubelet/config.yaml</code>
has to be updated manually post-upgrade or the file <code>/var/lib/kubelet/kubeadm-flags.env</code> can include flags.
The kubelet flags override the associated <code>KubeletConfiguration</code> options, but note that
some of the flags are deprecated.</p><p>A kubelet restart will be required after changing <code>/var/lib/kubelet/config.yaml</code> or
<code>/var/lib/kubelet/kubeadm-flags.env</code>.</p><h2 id="what-s-next">What's next</h2><ul><li><a href="/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/">Upgrading kubeadm clusters</a></li><li><a href="/docs/setup/production-environment/tools/kubeadm/control-plane-flags/">Customizing components with the kubeadm API</a></li><li><a href="/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/">Certificate management with kubeadm</a></li><li><a href="/docs/reference/setup-tools/kubeadm/">Find more about kubeadm set-up</a></li></ul></div>