<div class="td-content"><h1 data-pagefind-weight="10">Issue a Certificate for a Kubernetes API Client Using A CertificateSigningRequest</h1><p>Kubernetes lets you use a public key infrastructure (PKI) to authenticate to your cluster
as a client.</p><p>A few steps are required in order to get a normal user to be able to
authenticate and invoke an API. First, this user must have an <a href="https://www.itu.int/rec/T-REC-X.509">X.509</a> certificate
issued by an authority that your Kubernetes cluster trusts. The client must then present that certificate to the Kubernetes API.</p><p>You use a <a href="/concepts/security/certificate-signing-requests/">CertificateSigningRequest</a>
as part of this process, and either you or some other principal must approve the request.</p><p>You will create a private key, and then get a certificate issued, and finally configure
that private key for a client.</p><h2 id="before-you-begin">Before you begin</h2><ul><li><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul></li><li><p>You need the <code>kubectl</code>, <code>openssl</code> and <code>base64</code> utilities.</p></li></ul><p>This page assumes you are using Kubernetes <a class="glossary-tooltip" title="Manages authorization decisions, allowing admins to dynamically configure access policies through the Kubernetes API." data-toggle="tooltip" data-placement="top" href="/docs/reference/access-authn-authz/rbac/" target="_blank" aria-label="role based access control">role based access control</a> (RBAC).
If you have alternative or additional security mechanisms around authorization, you need to account for those as well.</p><h2 id="create-private-key">Create private key</h2><p>In this step, you create a private key. You need to keep this document secret; anyone who has it can impersonate the user.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Create a private key</span>
</span></span><span style="display:flex"><span>openssl genrsa -out myuser.key <span style="color:#666">3072</span>
</span></span></code></pre></div><h2 id="create-x.509-certificatessigningrequest">Create an X.509 certificate signing request</h2><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>This is not the same as the similarly-named CertificateSigningRequest API; the file you generate here goes into the
CertificateSigningRequest.</div><p>It is important to set CN and O attribute of the CSR. CN is the name of the user and O is the group that this user will belong to.
You can refer to <a href="/docs/reference/access-authn-authz/rbac/">RBAC</a> for standard groups.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># Change the common name "myuser" to the actual username that you want to use</span>
</span></span><span style="display:flex"><span>openssl req -new -key myuser.key -out myuser.csr -subj <span style="color:#b44">"/CN=myuser"</span>
</span></span></code></pre></div><h2 id="create-k8s-certificatessigningrequest">Create a Kubernetes CertificateSigningRequest</h2><p>Encode the CSR document using this command:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>cat myuser.csr | base64 | tr -d <span style="color:#b44">"\n"</span>
</span></span></code></pre></div><p>Create a <a href="/docs/reference/kubernetes-api/authentication-resources/certificate-signing-request-v1/">CertificateSigningRequest</a>
and submit it to a Kubernetes Cluster via kubectl. Below is a snippet of shell that you can use to generate the
CertificateSigningRequest.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>cat <span style="color:#b44">&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style="display:flex"><span><span style="color:#b44">apiVersion: certificates.k8s.io/v1
</span></span></span><span style="display:flex"><span><span style="color:#b44">kind: CertificateSigningRequest
</span></span></span><span style="display:flex"><span><span style="color:#b44">metadata:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  name: myuser # example
</span></span></span><span style="display:flex"><span><span style="color:#b44">spec:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  # This is an encoded CSR. Change this to the base64-encoded contents of myuser.csr
</span></span></span><span style="display:flex"><span><span style="color:#b44">  request: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0KTUlJQ1ZqQ0NBVDRDQVFBd0VURVBNQTBHQTFVRUF3d0dZVzVuWld4aE1JSUJJakFOQmdrcWhraUc5dzBCQVFFRgpBQU9DQVE4QU1JSUJDZ0tDQVFFQTByczhJTHRHdTYxakx2dHhWTTJSVlRWMDNHWlJTWWw0dWluVWo4RElaWjBOCnR2MUZtRVFSd3VoaUZsOFEzcWl0Qm0wMUFSMkNJVXBGd2ZzSjZ4MXF3ckJzVkhZbGlBNVhwRVpZM3ExcGswSDQKM3Z3aGJlK1o2MVNrVHF5SVBYUUwrTWM5T1Nsbm0xb0R2N0NtSkZNMUlMRVI3QTVGZnZKOEdFRjJ6dHBoaUlFMwpub1dtdHNZb3JuT2wzc2lHQ2ZGZzR4Zmd4eW8ybmlneFNVekl1bXNnVm9PM2ttT0x1RVF6cXpkakJ3TFJXbWlECklmMXBMWnoyalVnald4UkhCM1gyWnVVV1d1T09PZnpXM01LaE8ybHEvZi9DdS8wYk83c0x0MCt3U2ZMSU91TFcKcW90blZtRmxMMytqTy82WDNDKzBERHk5aUtwbXJjVDBnWGZLemE1dHJRSURBUUFCb0FBd0RRWUpLb1pJaHZjTgpBUUVMQlFBRGdnRUJBR05WdmVIOGR4ZzNvK21VeVRkbmFjVmQ1N24zSkExdnZEU1JWREkyQTZ1eXN3ZFp1L1BVCkkwZXpZWFV0RVNnSk1IRmQycVVNMjNuNVJsSXJ3R0xuUXFISUh5VStWWHhsdnZsRnpNOVpEWllSTmU3QlJvYXgKQVlEdUI5STZXT3FYbkFvczFqRmxNUG5NbFpqdU5kSGxpT1BjTU1oNndLaTZzZFhpVStHYTJ2RUVLY01jSVUyRgpvU2djUWdMYTk0aEpacGk3ZnNMdm1OQUxoT045UHdNMGM1dVJVejV4T0dGMUtCbWRSeEgvbUNOS2JKYjFRQm1HCkkwYitEUEdaTktXTU0xMzhIQXdoV0tkNjVoVHdYOWl4V3ZHMkh4TG1WQzg0L1BHT0tWQW9FNkpsYWFHdTlQVmkKdjlOSjVaZlZrcXdCd0hKbzZXdk9xVlA3SVFjZmg3d0drWm89Ci0tLS0tRU5EIENFUlRJRklDQVRFIFJFUVVFU1QtLS0tLQo=
</span></span></span><span style="display:flex"><span><span style="color:#b44">  signerName: kubernetes.io/kube-apiserver-client
</span></span></span><span style="display:flex"><span><span style="color:#b44">  expirationSeconds: 86400  # one day
</span></span></span><span style="display:flex"><span><span style="color:#b44">  usages:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  - client auth
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span></code></pre></div><p>Some points to note:</p><ul><li><code>usages</code> has to be <code>client auth</code></li><li><code>expirationSeconds</code> could be made longer (i.e. <code>864000</code> for ten days) or shorter (i.e. <code>3600</code> for one hour).
You cannot request a duration shorter than 10 minutes.</li><li><code>request</code> is the base64 encoded value of the CSR file content.</li></ul><h2 id="approve-certificate-signing-request">Approve the CertificateSigningRequest</h2><p>Use kubectl to find the CSR you made, and manually approve it.</p><p>Get the list of CSRs:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get csr
</span></span></code></pre></div><p>Approve the CSR:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl certificate approve myuser
</span></span></code></pre></div><h2 id="get-the-certificate">Get the certificate</h2><p>Retrieve the certificate from the CSR, to check it looks OK.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get csr/myuser -o yaml
</span></span></code></pre></div><p>The certificate value is in Base64-encoded format under <code>.status.certificate</code>.</p><p>Export the issued certificate from the CertificateSigningRequest.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl get csr myuser -o <span style="color:#b8860b">jsonpath</span><span style="color:#666">=</span><span style="color:#b44">'{.status.certificate}'</span>| base64 -d &gt; myuser.crt
</span></span></code></pre></div><h2 id="configure-the-certificate-into-kubeconfig">Configure the certificate into kubeconfig</h2><p>The next step is to add this user into the kubeconfig file.</p><p>First, you need to add new credentials:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl config set-credentials myuser --client-key<span style="color:#666">=</span>myuser.key --client-certificate<span style="color:#666">=</span>myuser.crt --embed-certs<span style="color:#666">=</span><span style="color:#a2f">true</span>
</span></span></code></pre></div><p>Then, you need to add the context:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl config set-context myuser --cluster<span style="color:#666">=</span>kubernetes --user<span style="color:#666">=</span>myuser
</span></span></code></pre></div><p>To test it:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl --context myuser auth whoami
</span></span></code></pre></div><p>You should see output confirming that you are “myuser“.</p><h2 id="create-role-and-rolebinding">Create Role and RoleBinding</h2><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>If you don't use Kubernetes RBAC, skip this step and make the appropriate changes for the authorization mechanism
your cluster actually uses.</div><p>With the certificate created it is time to define the Role and RoleBinding for
this user to access Kubernetes cluster resources.</p><p>This is a sample command to create a Role for this new user:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl create role developer --verb<span style="color:#666">=</span>create --verb<span style="color:#666">=</span>get --verb<span style="color:#666">=</span>list --verb<span style="color:#666">=</span>update --verb<span style="color:#666">=</span>delete --resource<span style="color:#666">=</span>pods
</span></span></code></pre></div><p>This is a sample command to create a RoleBinding for this new user:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl create rolebinding developer-binding-myuser --role<span style="color:#666">=</span>developer --user<span style="color:#666">=</span>myuser
</span></span></code></pre></div><h2 id="what-s-next">What's next</h2><ul><li>Read <a href="/docs/tasks/tls/managing-tls-in-a-cluster/">Manage TLS Certificates in a Cluster</a></li><li>For details of X.509 itself, refer to <a href="https://tools.ietf.org/html/rfc5280#section-3.1">RFC 5280</a> section 3.1</li><li>For information on the syntax of PKCS#10 certificate signing requests, refer to <a href="https://tools.ietf.org/html/rfc2986">RFC 2986</a></li><li>Read about <a href="/docs/reference/access-authn-authz/certificate-signing-requests/#cluster-trust-bundles">ClusterTrustBundles</a></li></ul></div>