<div class="td-content"><h1 data-pagefind-weight="10">Attach Handlers to Container Lifecycle Events</h1><p>This page shows how to attach handlers to Container lifecycle events. Kubernetes supports
the postStart and preStop events. Kubernetes sends the postStart event immediately
after a Container is started, and it sends the preStop event immediately before the
Container is terminated. A Container may specify one handler per event.</p><h2 id="before-you-begin">Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul><p>To check the version, enter <code>kubectl version</code>.</p></p><h2 id="define-poststart-and-prestop-handlers">Define postStart and preStop handlers</h2><p>In this exercise, you create a Pod that has one Container. The Container has handlers
for the postStart and preStop events.</p><p>Here is the configuration file for the Pod:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/lifecycle-events.yaml" download="pods/lifecycle-events.yaml"><code>pods/lifecycle-events.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;pods-lifecycle-events-yaml&quot;)" title="Copy pods/lifecycle-events.yaml to clipboard"/></div><div class="includecode" id="pods-lifecycle-events-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Pod<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>lifecycle-demo<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>lifecycle-demo-container<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">lifecycle</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">postStart</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">exec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">command</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"/bin/sh"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"-c"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"echo Hello from the postStart handler &gt; /usr/share/message"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">preStop</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">exec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">command</span>:<span style="color:#bbb"> </span>[<span style="color:#b44">"/bin/sh"</span>,<span style="color:#b44">"-c"</span>,<span style="color:#b44">"nginx -s quit; while killall -0 nginx; do sleep 1; done"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>In the configuration file, you can see that the postStart command writes a <code>message</code>
file to the Container's <code>/usr/share</code> directory. The preStop command shuts down
nginx gracefully. This is helpful if the Container is being terminated because of a failure.</p><p>Create the Pod:</p><pre><code>kubectl apply -f https://k8s.io/examples/pods/lifecycle-events.yaml
</code></pre><p>Verify that the Container in the Pod is running:</p><pre><code>kubectl get pod lifecycle-demo
</code></pre><p>Get a shell into the Container running in your Pod:</p><pre><code>kubectl exec -it lifecycle-demo -- /bin/bash
</code></pre><p>In your shell, verify that the <code>postStart</code> handler created the <code>message</code> file:</p><pre><code>root@lifecycle-demo:/# cat /usr/share/message
</code></pre><p>The output shows the text written by the postStart handler:</p><pre><code>Hello from the postStart handler
</code></pre><h2 id="discussion">Discussion</h2><p>Kubernetes sends the postStart event immediately after the Container is created.
There is no guarantee, however, that the postStart handler is called before
the Container's entrypoint is called. The postStart handler runs asynchronously
relative to the Container's code, but Kubernetes' management of the container
blocks until the postStart handler completes. The Container's status is not
set to RUNNING until the postStart handler completes.</p><p>Kubernetes sends the preStop event immediately before the Container is terminated.
Kubernetes' management of the Container blocks until the preStop handler completes,
unless the Pod's grace period expires. For more details, see
<a href="/docs/concepts/workloads/pods/pod-lifecycle/">Pod Lifecycle</a>.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>Kubernetes only sends the preStop event when a Pod or a container in the Pod is <em>terminated</em>.
This means that the preStop hook is not invoked when the Pod is <em>completed</em>.
About this limitation, please see <a href="/docs/concepts/containers/container-lifecycle-hooks/#container-hooks">Container hooks</a> for the detail.</div><h2 id="what-s-next">What's next</h2><ul><li>Learn more about <a href="/docs/concepts/containers/container-lifecycle-hooks/">Container lifecycle hooks</a>.</li><li>Learn more about the <a href="/docs/concepts/workloads/pods/pod-lifecycle/">lifecycle of a Pod</a>.</li></ul><h3 id="reference">Reference</h3><ul><li><a href="/docs/reference/generated/kubernetes-api/v1.34/#lifecycle-v1-core">Lifecycle</a></li><li><a href="/docs/reference/generated/kubernetes-api/v1.34/#container-v1-core">Container</a></li><li>See <code>terminationGracePeriodSeconds</code> in <a href="/docs/reference/generated/kubernetes-api/v1.34/#podspec-v1-core">PodSpec</a></li></ul></div>