<div class="td-content"><h1 data-pagefind-weight="10">Declare Network Policy</h1><p>This document helps you get started using the Kubernetes <a href="/docs/concepts/services-networking/network-policies/">NetworkPolicy API</a> to declare network policies that govern how pods communicate with each other.</p><div class="alert alert-secondary callout third-party-content" role="alert"><strong>Note:</strong>â€ˆThis section links to third party projects that provide functionality required by Kubernetes. The Kubernetes project authors aren't responsible for these projects, which are listed alphabetically. To add a project to this list, read the <a href="/docs/contribute/style/content-guide/#third-party-content">content guide</a> before submitting a change. <a href="#third-party-content-disclaimer">More information.</a></div><h2 id="before-you-begin">Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href="https://labs.iximiuz.com/playgrounds?category=kubernetes&amp;filter=all">iximiuz Labs</a></li><li><a href="https://killercoda.com/playgrounds/scenario/kubernetes">Killercoda</a></li><li><a href="https://kodekloud.com/public-playgrounds">KodeKloud</a></li><li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li></ul>Your Kubernetes server must be at or later than version v1.8.<p>To check the version, enter <code>kubectl version</code>.</p></p><p>Make sure you've configured a network provider with network policy support. There are a number of network providers that support NetworkPolicy, including:</p><ul><li><a href="/docs/tasks/administer-cluster/network-policy-provider/antrea-network-policy/">Antrea</a></li><li><a href="/docs/tasks/administer-cluster/network-policy-provider/calico-network-policy/">Calico</a></li><li><a href="/docs/tasks/administer-cluster/network-policy-provider/cilium-network-policy/">Cilium</a></li><li><a href="/docs/tasks/administer-cluster/network-policy-provider/kube-router-network-policy/">Kube-router</a></li><li><a href="/docs/tasks/administer-cluster/network-policy-provider/romana-network-policy/">Romana</a></li><li><a href="/docs/tasks/administer-cluster/network-policy-provider/weave-network-policy/">Weave Net</a></li></ul><h2 id="create-an-nginx-deployment-and-expose-it-via-a-service">Create an <code>nginx</code> deployment and expose it via a service</h2><p>To see how Kubernetes network policy works, start off by creating an <code>nginx</code> Deployment.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console"><span style="display:flex"><span><span style="color:#888">kubectl create deployment nginx --image=nginx
</span></span></span></code></pre></div><pre tabindex="0"><code class="language-none" data-lang="none">deployment.apps/nginx created
</code></pre><p>Expose the Deployment through a Service called <code>nginx</code>.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console"><span style="display:flex"><span><span style="color:#888">kubectl expose deployment nginx --port=80
</span></span></span></code></pre></div><pre tabindex="0"><code class="language-none" data-lang="none">service/nginx exposed
</code></pre><p>The above commands create a Deployment with an nginx Pod and expose the Deployment through a Service named <code>nginx</code>. The <code>nginx</code> Pod and Deployment are found in the <code>default</code> namespace.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console"><span style="display:flex"><span><span style="color:#888">kubectl get svc,pod
</span></span></span></code></pre></div><pre tabindex="0"><code class="language-none" data-lang="none">NAME                        CLUSTER-IP    EXTERNAL-IP   PORT(S)    AGE
service/kubernetes          10.100.0.1    &lt;none&gt;        443/TCP    46m
service/nginx               10.100.0.16   &lt;none&gt;        80/TCP     33s

NAME                        READY         STATUS        RESTARTS   AGE
pod/nginx-701339712-e0qfq   1/1           Running       0          35s
</code></pre><h2 id="test-the-service-by-accessing-it-from-another-pod">Test the service by accessing it from another Pod</h2><p>You should be able to access the new <code>nginx</code> service from other Pods. To access the <code>nginx</code> Service from another Pod in the <code>default</code> namespace, start a busybox container:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console"><span style="display:flex"><span><span style="color:#888">kubectl run busybox --rm -ti --image=busybox -- /bin/sh
</span></span></span></code></pre></div><p>In your shell, run the following command:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>wget --spider --timeout<span style="color:#666">=</span><span style="color:#666">1</span> nginx
</span></span></code></pre></div><pre tabindex="0"><code class="language-none" data-lang="none">Connecting to nginx (10.100.0.16:80)
remote file exists
</code></pre><h2 id="limit-access-to-the-nginx-service">Limit access to the <code>nginx</code> service</h2><p>To limit the access to the <code>nginx</code> service so that only Pods with the label <code>access: true</code> can query it, create a NetworkPolicy object as follows:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/service/networking/nginx-policy.yaml" download="service/networking/nginx-policy.yaml"><code>service/networking/nginx-policy.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;service-networking-nginx-policy-yaml&quot;)" title="Copy service/networking/nginx-policy.yaml to clipboard"/></div><div class="includecode" id="service-networking-nginx-policy-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>networking.k8s.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>NetworkPolicy<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>access-nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">podSelector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">ingress</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">from</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span>- <span style="color:green;font-weight:700">podSelector</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">        </span><span style="color:green;font-weight:700">matchLabels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">          </span><span style="color:green;font-weight:700">access</span>:<span style="color:#bbb"> </span><span style="color:#b44">"true"</span><span style="color:#bbb">
</span></span></span></code></pre></div></div></div><p>The name of a NetworkPolicy object must be a valid
<a href="/docs/concepts/overview/working-with-objects/names/#dns-subdomain-names">DNS subdomain name</a>.</p><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>NetworkPolicy includes a <code>podSelector</code> which selects the grouping of Pods to which the policy applies. You can see this policy selects Pods with the label <code>app=nginx</code>. The label was automatically added to the Pod in the <code>nginx</code> Deployment. An empty <code>podSelector</code> selects all pods in the namespace.</div><h2 id="assign-the-policy-to-the-service">Assign the policy to the service</h2><p>Use kubectl to create a NetworkPolicy from the above <code>nginx-policy.yaml</code> file:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console"><span style="display:flex"><span><span style="color:#888">kubectl apply -f https://k8s.io/examples/service/networking/nginx-policy.yaml
</span></span></span></code></pre></div><pre tabindex="0"><code class="language-none" data-lang="none">networkpolicy.networking.k8s.io/access-nginx created
</code></pre><h2 id="test-access-to-the-service-when-access-label-is-not-defined">Test access to the service when access label is not defined</h2><p>When you attempt to access the <code>nginx</code> Service from a Pod without the correct labels, the request times out:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console"><span style="display:flex"><span><span style="color:#888">kubectl run busybox --rm -ti --image=busybox -- /bin/sh
</span></span></span></code></pre></div><p>In your shell, run the command:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>wget --spider --timeout<span style="color:#666">=</span><span style="color:#666">1</span> nginx
</span></span></code></pre></div><pre tabindex="0"><code class="language-none" data-lang="none">Connecting to nginx (10.100.0.16:80)
wget: download timed out
</code></pre><h2 id="define-access-label-and-test-again">Define access label and test again</h2><p>You can create a Pod with the correct labels to see that the request is allowed:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console"><span style="display:flex"><span><span style="color:#888">kubectl run busybox --rm -ti --labels="access=true" --image=busybox -- /bin/sh
</span></span></span></code></pre></div><p>In your shell, run the command:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>wget --spider --timeout<span style="color:#666">=</span><span style="color:#666">1</span> nginx
</span></span></code></pre></div><pre tabindex="0"><code class="language-none" data-lang="none">Connecting to nginx (10.100.0.16:80)
remote file exists
</code></pre></div>