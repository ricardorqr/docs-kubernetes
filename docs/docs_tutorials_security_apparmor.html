<div class="td-content"><h1 data-pagefind-weight="10">Restrict a Container's Access to Resources with AppArmor</h1><div class="feature-state-notice feature-stable" title="Feature Gate: AppArmor"><span class="feature-state-name">FEATURE STATE:</span>
<code>Kubernetes v1.31 [stable]</code> (enabled by default: true)</div><p>This page shows you how to load AppArmor profiles on your nodes and enforce
those profiles in Pods. To learn more about how Kubernetes can confine Pods using
AppArmor, see
<a href="/docs/concepts/security/linux-kernel-security-constraints/#apparmor">Linux kernel security constraints for Pods and containers</a>.</p><h2 id="objectives">Objectives</h2><ul><li>See an example of how to load a profile on a Node</li><li>Learn how to enforce the profile on a Pod</li><li>Learn how to check that the profile is loaded</li><li>See what happens when a profile is violated</li><li>See what happens when a profile cannot be loaded</li></ul><h2 id="before-you-begin">Before you begin</h2><p>AppArmor is an optional kernel module and Kubernetes feature, so verify it is supported on your
Nodes before proceeding:</p><ol><li><p>AppArmor kernel module is enabled -- For the Linux kernel to enforce an AppArmor profile, the
AppArmor kernel module must be installed and enabled. Several distributions enable the module by
default, such as Ubuntu and SUSE, and many others provide optional support. To check whether the
module is enabled, check the <code>/sys/module/apparmor/parameters/enabled</code> file:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>cat /sys/module/apparmor/parameters/enabled
</span></span><span style="display:flex"><span>Y
</span></span></code></pre></div><p>The kubelet verifies that AppArmor is enabled on the host before admitting a pod with AppArmor
explicitly configured.</p></li><li><p>Container runtime supports AppArmor -- All common Kubernetes-supported container
runtimes should support AppArmor, including <a class="glossary-tooltip" title="A container runtime with an emphasis on simplicity, robustness and portability" data-toggle="tooltip" data-placement="top" href="https://containerd.io/docs/" target="_blank" aria-label="containerd">containerd</a> and
<a class="glossary-tooltip" title="A lightweight container runtime specifically for Kubernetes" data-toggle="tooltip" data-placement="top" href="https://cri-o.io/#what-is-cri-o" target="_blank" aria-label="CRI-O">CRI-O</a>. Please refer to the corresponding runtime
documentation and verify that the cluster fulfills the requirements to use AppArmor.</p></li><li><p>Profile is loaded -- AppArmor is applied to a Pod by specifying an AppArmor profile that each
container should be run with. If any of the specified profiles are not loaded in the
kernel, the kubelet will reject the Pod. You can view which profiles are loaded on a
node by checking the <code>/sys/kernel/security/apparmor/profiles</code> file. For example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>ssh gke-test-default-pool-239f5d02-gyn2 <span style="color:#b44">"sudo cat /sys/kernel/security/apparmor/profiles | sort"</span>
</span></span></code></pre></div><pre tabindex="0"><code>apparmor-test-deny-write (enforce)
apparmor-test-audit-write (enforce)
docker-default (enforce)
k8s-nginx (enforce)
</code></pre><p>For more details on loading profiles on nodes, see
<a href="#setting-up-nodes-with-profiles">Setting up nodes with profiles</a>.</p></li></ol><h2 id="securing-a-pod">Securing a Pod</h2><div class="alert alert-info" role="alert"><h4 class="alert-heading">Note:</h4>Prior to Kubernetes v1.30, AppArmor was specified through annotations. Use the documentation version
selector to view the documentation with this deprecated API.</div><p>AppArmor profiles can be specified at the pod level or container level. The container AppArmor
profile takes precedence over the pod profile.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">securityContext</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">appArmorProfile</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>&lt;profile_type&gt;<span style="color:#bbb">
</span></span></span></code></pre></div><p>Where <code>&lt;profile_type&gt;</code> is one of:</p><ul><li><code>RuntimeDefault</code> to use the runtime's default profile</li><li><code>Localhost</code> to use a profile loaded on the host (see below)</li><li><code>Unconfined</code> to run without AppArmor</li></ul><p>See <a href="#specifying-apparmor-confinement">Specifying AppArmor Confinement</a> for full details on the AppArmor profile API.</p><p>To verify that the profile was applied, you can check that the container's root process is
running with the correct profile by examining its proc attr:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl <span style="color:#a2f">exec</span> &lt;pod_name&gt; -- cat /proc/1/attr/current
</span></span></code></pre></div><p>The output should look something like this:</p><pre tabindex="0"><code>cri-containerd.apparmor.d (enforce)
</code></pre><h2 id="example">Example</h2><p><em>This example assumes you have already set up a cluster with AppArmor support.</em></p><p>First, load the profile you want to use onto your Nodes. This profile blocks all file write operations:</p><pre tabindex="0"><code>#include &lt;tunables/global&gt;

profile k8s-apparmor-example-deny-write flags=(attach_disconnected) {
  #include &lt;abstractions/base&gt;

  file,

  # Deny all file writes.
  deny /** w,
}
</code></pre><p>The profile needs to be loaded onto all nodes, since you don't know where the pod will be scheduled.
For this example you can use SSH to install the profiles, but other approaches are
discussed in <a href="#setting-up-nodes-with-profiles">Setting up nodes with profiles</a>.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#080;font-style:italic"># This example assumes that node names match host names, and are reachable via SSH.</span>
</span></span><span style="display:flex"><span><span style="color:#b8860b">NODES</span><span style="color:#666">=(</span><span style="color:#a2f;font-weight:700">$(</span> kubectl get node -o <span style="color:#b8860b">jsonpath</span><span style="color:#666">=</span><span style="color:#b44">'{.items[*].status.addresses[?(.type == "Hostname")].address}'</span> <span style="color:#a2f;font-weight:700">)</span><span style="color:#666">)</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#a2f;font-weight:700">for</span> NODE in <span style="color:#b68;font-weight:700">${</span><span style="color:#b8860b">NODES</span>[*]<span style="color:#b68;font-weight:700">}</span>; <span style="color:#a2f;font-weight:700">do</span> ssh <span style="color:#b8860b">$NODE</span> <span style="color:#b44">'sudo apparmor_parser -q &lt;&lt;EOF
</span></span></span><span style="display:flex"><span><span style="color:#b44">#include &lt;tunables/global&gt;
</span></span></span><span style="display:flex"><span><span style="color:#b44">
</span></span></span><span style="display:flex"><span><span style="color:#b44">profile k8s-apparmor-example-deny-write flags=(attach_disconnected) {
</span></span></span><span style="display:flex"><span><span style="color:#b44">  #include &lt;abstractions/base&gt;
</span></span></span><span style="display:flex"><span><span style="color:#b44">
</span></span></span><span style="display:flex"><span><span style="color:#b44">  file,
</span></span></span><span style="display:flex"><span><span style="color:#b44">
</span></span></span><span style="display:flex"><span><span style="color:#b44">  # Deny all file writes.
</span></span></span><span style="display:flex"><span><span style="color:#b44">  deny /** w,
</span></span></span><span style="display:flex"><span><span style="color:#b44">}
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF'</span>
</span></span><span style="display:flex"><span><span style="color:#a2f;font-weight:700">done</span>
</span></span></code></pre></div><p>Next, run a simple "Hello AppArmor" Pod with the deny-write profile:</p><div class="highlight code-sample"><div class="copy-code-icon"><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/security/hello-apparmor.yaml" download="pods/security/hello-apparmor.yaml"><code>pods/security/hello-apparmor.yaml</code>
</a><img src="/images/copycode.svg" class="icon-copycode" onclick="copyCode(&quot;pods-security-hello-apparmor-yaml&quot;)" title="Copy pods/security/hello-apparmor.yaml to clipboard"/></div><div class="includecode" id="pods-security-hello-apparmor-yaml"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:green;font-weight:700">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">kind</span>:<span style="color:#bbb"> </span>Pod<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>hello-apparmor<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb"/><span style="color:green;font-weight:700">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">securityContext</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">appArmorProfile</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">type</span>:<span style="color:#bbb"> </span>Localhost<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">      </span><span style="color:green;font-weight:700">localhostProfile</span>:<span style="color:#bbb"> </span>k8s-apparmor-example-deny-write<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span><span style="color:green;font-weight:700">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">  </span>- <span style="color:green;font-weight:700">name</span>:<span style="color:#bbb"> </span>hello<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">image</span>:<span style="color:#bbb"> </span>busybox:1.28<span style="color:#bbb">
</span></span></span><span style="display:flex"><span><span style="color:#bbb">    </span><span style="color:green;font-weight:700">command</span>:<span style="color:#bbb"> </span>[<span style="color:#bbb"> </span><span style="color:#b44">"sh"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"-c"</span>,<span style="color:#bbb"> </span><span style="color:#b44">"echo 'Hello AppArmor!' &amp;&amp; sleep 1h"</span><span style="color:#bbb"> </span>]<span style="color:#bbb">
</span></span></span></code></pre></div></div></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl create -f hello-apparmor.yaml
</span></span></code></pre></div><p>You can verify that the container is actually running with that profile by checking <code>/proc/1/attr/current</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl <span style="color:#a2f">exec</span> hello-apparmor -- cat /proc/1/attr/current
</span></span></code></pre></div><p>The output should be:</p><pre tabindex="0"><code>k8s-apparmor-example-deny-write (enforce)
</code></pre><p>Finally, you can see what happens if you violate the profile by writing to a file:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl <span style="color:#a2f">exec</span> hello-apparmor -- touch /tmp/test
</span></span></code></pre></div><pre tabindex="0"><code>touch: /tmp/test: Permission denied
error: error executing remote command: command terminated with non-zero exit code: Error executing in Docker Container: 1
</code></pre><p>To wrap up, see what happens if you try to specify a profile that hasn't been loaded:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl create -f /dev/stdin <span style="color:#b44">&lt;&lt;EOF
</span></span></span><span style="display:flex"><span><span style="color:#b44">apiVersion: v1
</span></span></span><span style="display:flex"><span><span style="color:#b44">kind: Pod
</span></span></span><span style="display:flex"><span><span style="color:#b44">metadata:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  name: hello-apparmor-2
</span></span></span><span style="display:flex"><span><span style="color:#b44">spec:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  securityContext:
</span></span></span><span style="display:flex"><span><span style="color:#b44">    appArmorProfile:
</span></span></span><span style="display:flex"><span><span style="color:#b44">      type: Localhost
</span></span></span><span style="display:flex"><span><span style="color:#b44">      localhostProfile: k8s-apparmor-example-allow-write
</span></span></span><span style="display:flex"><span><span style="color:#b44">  containers:
</span></span></span><span style="display:flex"><span><span style="color:#b44">  - name: hello
</span></span></span><span style="display:flex"><span><span style="color:#b44">    image: busybox:1.28
</span></span></span><span style="display:flex"><span><span style="color:#b44">    command: [ "sh", "-c", "echo 'Hello AppArmor!' &amp;&amp; sleep 1h" ]
</span></span></span><span style="display:flex"><span><span style="color:#b44">EOF</span>
</span></span></code></pre></div><pre tabindex="0"><code>pod/hello-apparmor-2 created
</code></pre><p>Although the Pod was created successfully, further examination will show that it is stuck in pending:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl describe pod hello-apparmor-2
</span></span></code></pre></div><pre tabindex="0"><code>Name:          hello-apparmor-2
Namespace:     default
Node:          gke-test-default-pool-239f5d02-x1kf/10.128.0.27
Start Time:    Tue, 30 Aug 2016 17:58:56 -0700
Labels:        &lt;none&gt;
Annotations:   container.apparmor.security.beta.kubernetes.io/hello=localhost/k8s-apparmor-example-allow-write
Status:        Pending
... 
Events:
  Type     Reason     Age              From               Message
  ----     ------     ----             ----               -------
  Normal   Scheduled  10s              default-scheduler  Successfully assigned default/hello-apparmor to gke-test-default-pool-239f5d02-x1kf
  Normal   Pulled     8s               kubelet            Successfully pulled image "busybox:1.28" in 370.157088ms (370.172701ms including waiting)
  Normal   Pulling    7s (x2 over 9s)  kubelet            Pulling image "busybox:1.28"
  Warning  Failed     7s (x2 over 8s)  kubelet            Error: failed to get container spec opts: failed to generate apparmor spec opts: apparmor profile not found k8s-apparmor-example-allow-write
  Normal   Pulled     7s               kubelet            Successfully pulled image "busybox:1.28" in 90.980331ms (91.005869ms including waiting)
</code></pre><p>An Event provides the error message with the reason, the specific wording is runtime-dependent:</p><pre tabindex="0"><code>  Warning  Failed     7s (x2 over 8s)  kubelet            Error: failed to get container spec opts: failed to generate apparmor spec opts: apparmor profile not found 
</code></pre><h2 id="administration">Administration</h2><h3 id="setting-up-nodes-with-profiles">Setting up Nodes with profiles</h3><p>Kubernetes 1.34 does not provide any built-in mechanisms for loading AppArmor profiles onto
Nodes. Profiles can be loaded through custom infrastructure or tools like the
<a href="https://github.com/kubernetes-sigs/security-profiles-operator">Kubernetes Security Profiles Operator</a>.</p><p>The scheduler is not aware of which profiles are loaded onto which Node, so the full set of profiles
must be loaded onto every Node. An alternative approach is to add a Node label for each profile (or
class of profiles) on the Node, and use a
<a href="/docs/concepts/scheduling-eviction/assign-pod-node/">node selector</a> to ensure the Pod is run on a
Node with the required profile.</p><h2 id="authoring-profiles">Authoring Profiles</h2><p>Getting AppArmor profiles specified correctly can be a tricky business. Fortunately there are some
tools to help with that:</p><ul><li><code>aa-genprof</code> and <code>aa-logprof</code> generate profile rules by monitoring an application's activity and
logs, and admitting the actions it takes. Further instructions are provided by the
<a href="https://gitlab.com/apparmor/apparmor/wikis/Profiling_with_tools">AppArmor documentation</a>.</li><li><a href="https://github.com/jfrazelle/bane">bane</a> is an AppArmor profile generator for Docker that uses a
simplified profile language.</li></ul><p>To debug problems with AppArmor, you can check the system logs to see what, specifically, was
denied. AppArmor logs verbose messages to <code>dmesg</code>, and errors can usually be found in the system
logs or through <code>journalctl</code>. More information is provided in
<a href="https://gitlab.com/apparmor/apparmor/wikis/AppArmor_Failures">AppArmor failures</a>.</p><h2 id="specifying-apparmor-confinement">Specifying AppArmor confinement</h2><div class="alert alert-caution" role="alert"><h4 class="alert-heading">Caution:</h4>Prior to Kubernetes v1.30, AppArmor was specified through annotations. Use the documentation version
selector to view the documentation with this deprecated API.</div><h3 id="appArmorProfile">AppArmor profile within security context</h3><p>You can specify the <code>appArmorProfile</code> on either a container's <code>securityContext</code> or on a Pod's
<code>securityContext</code>. If the profile is set at the pod level, it will be used as the default profile
for all containers in the pod (including init, sidecar, and ephemeral containers). If both a pod &amp; container
AppArmor profile are set, the container's profile will be used.</p><p>An AppArmor profile has 2 fields:</p><p><code>type</code> <em>(required)</em> - indicates which kind of AppArmor profile will be applied. Valid options are:</p><dl><dt><code>Localhost</code></dt><dd>a profile pre-loaded on the node (specified by <code>localhostProfile</code>).</dd><dt><code>RuntimeDefault</code></dt><dd>the container runtime's default profile.</dd><dt><code>Unconfined</code></dt><dd>no AppArmor enforcement.</dd></dl><p><code>localhostProfile</code> - The name of a profile loaded on the node that should be used.
The profile must be preconfigured on the node to work.
This option must be provided if and only if the <code>type</code> is <code>Localhost</code>.</p><h2 id="what-s-next">What's next</h2><p>Additional resources:</p><ul><li><a href="https://gitlab.com/apparmor/apparmor/wikis/QuickProfileLanguage">Quick guide to the AppArmor profile language</a></li><li><a href="https://gitlab.com/apparmor/apparmor/wikis/Policy_Layout">AppArmor core policy reference</a></li></ul></div>