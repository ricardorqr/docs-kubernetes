<div class="td-content"><h1 data-pagefind-weight="10">Changing the Container Runtime on a Node from Docker Engine to containerd</h1><p>This task outlines the steps needed to update your container runtime to containerd from Docker. It
is applicable for cluster operators running Kubernetes 1.23 or earlier. This also covers an
example scenario for migrating from dockershim to containerd. Alternative container runtimes
can be picked from this <a href="/docs/setup/production-environment/container-runtimes/">page</a>.</p><h2 id="before-you-begin">Before you begin</h2><div class="alert alert-secondary callout third-party-content" role="alert"><strong>Note:</strong> This section links to third party projects that provide functionality required by Kubernetes. The Kubernetes project authors aren't responsible for these projects, which are listed alphabetically. To add a project to this list, read the <a href="/docs/contribute/style/content-guide/#third-party-content">content guide</a> before submitting a change. <a href="#third-party-content-disclaimer">More information.</a></div><p>Install containerd. For more information see
<a href="https://containerd.io/docs/getting-started/">containerd's installation documentation</a>
and for specific prerequisite follow
<a href="/docs/setup/production-environment/container-runtimes/#containerd">the containerd guide</a>.</p><h2 id="drain-the-node">Drain the node</h2><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl drain &lt;node-to-drain&gt; --ignore-daemonsets
</span></span></code></pre></div><p>Replace <code>&lt;node-to-drain&gt;</code> with the name of your node you are draining.</p><h2 id="stop-the-docker-daemon">Stop the Docker daemon</h2><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>systemctl stop kubelet
</span></span><span style="display:flex"><span>systemctl disable docker.service --now
</span></span></code></pre></div><h2 id="install-containerd">Install Containerd</h2><p>Follow the <a href="/docs/setup/production-environment/container-runtimes/#containerd">guide</a>
for detailed steps to install containerd.</p><ul class="nav nav-tabs" id="tab-cri-containerd-installation" role="tablist"><li class="nav-item"><a data-toggle="tab" class="nav-link active" href="#tab-cri-containerd-installation-0" role="tab" aria-controls="tab-cri-containerd-installation-0" aria-selected="true">Linux</a></li><li class="nav-item"><a data-toggle="tab" class="nav-link" href="#tab-cri-containerd-installation-1" role="tab" aria-controls="tab-cri-containerd-installation-1">Windows (PowerShell)</a></li></ul><div class="tab-content" id="tab-cri-containerd-installation"><div id="tab-cri-containerd-installation-0" class="tab-pane show active" role="tabpanel" aria-labelledby="tab-cri-containerd-installation-0"><p><ol><li><p>Install the <code>containerd.io</code> package from the official Docker repositories.
Instructions for setting up the Docker repository for your respective Linux distribution and
installing the <code>containerd.io</code> package can be found at
<a href="https://github.com/containerd/containerd/blob/main/docs/getting-started.md">Getting started with containerd</a>.</p></li><li><p>Configure containerd:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>sudo mkdir -p /etc/containerd
</span></span><span style="display:flex"><span>containerd config default | sudo tee /etc/containerd/config.toml
</span></span></code></pre></div></li><li><p>Restart containerd:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>sudo systemctl restart containerd
</span></span></code></pre></div></li></ol></p></div><div id="tab-cri-containerd-installation-1" class="tab-pane" role="tabpanel" aria-labelledby="tab-cri-containerd-installation-1"><p><p>Start a Powershell session, set <code>$Version</code> to the desired version (ex: <code>$Version="1.4.3"</code>), and
then run the following commands:</p><ol><li><p>Download containerd:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="display:flex"><span>curl.exe -L https<span>:</span>//github.com/containerd/containerd/releases/download/v<span style="color:#b8860b">$Version</span>/containerd-<span style="color:#b8860b">$Version</span>-windows-amd64.tar.gz -o <span style="color:#a2f">containerd-windows</span>-amd64.tar.gz
</span></span><span style="display:flex"><span>tar.exe xvf .\<span style="color:#a2f">containerd-windows</span>-amd64.tar.gz
</span></span></code></pre></div></li><li><p>Extract and configure:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="display:flex"><span><span style="color:#a2f">Copy-Item</span> -Path <span style="color:#b44">".\bin\"</span> -Destination <span style="color:#b44">"</span><span style="color:#b8860b">$Env:ProgramFiles</span><span style="color:#b44">\containerd"</span> -Recurse -Force
</span></span><span style="display:flex"><span><span style="color:#a2f">cd </span><span style="color:#b8860b">$Env:ProgramFiles</span>\containerd\
</span></span><span style="display:flex"><span>.\containerd.exe config <span style="color:#a2f;font-weight:700">default</span> | <span style="color:#a2f">Out-File</span> config.toml -Encoding ascii
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># Review the configuration. Depending on setup you may want to adjust:</span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># - the sandbox_image (Kubernetes pause image)</span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># - cni bin_dir and conf_dir locations</span>
</span></span><span style="display:flex"><span><span style="color:#a2f">Get-Content</span> config.toml
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#080;font-style:italic"># (Optional - but highly recommended) Exclude containerd from Windows Defender Scans</span>
</span></span><span style="display:flex"><span><span style="color:#a2f">Add-MpPreference</span> -ExclusionProcess <span style="color:#b44">"</span><span style="color:#b8860b">$Env:ProgramFiles</span><span style="color:#b44">\containerd\containerd.exe"</span>
</span></span></code></pre></div></li><li><p>Start containerd:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="display:flex"><span>.\containerd.exe --register-service
</span></span><span style="display:flex"><span><span style="color:#a2f">Start-Service</span> containerd
</span></span></code></pre></div></li></ol></p></div></div><h2 id="configure-the-kubelet-to-use-containerd-as-its-container-runtime">Configure the kubelet to use containerd as its container runtime</h2><p>Edit the file <code>/var/lib/kubelet/kubeadm-flags.env</code> and add the containerd runtime to the flags;
<code>--container-runtime-endpoint=unix:///run/containerd/containerd.sock</code>.</p><p>Users using kubeadm should be aware that the kubeadm tool stores the host's CRI socket in the</p><p><code>/var/lib/kubelet/instance-config.yaml</code> file on each node. You can create this <code>/var/lib/kubelet/instance-config.yaml</code> file on the node.</p><p>The <code>/var/lib/kubelet/instance-config.yaml</code> file allows setting the <code>containerRuntimeEndpoint</code> parameter.</p><p>You can set this parameter's value to the path of your chosen CRI socket (for example <code>unix:///run/containerd/containerd.sock</code>).</p><h2 id="restart-the-kubelet">Restart the kubelet</h2><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>systemctl start kubelet
</span></span></code></pre></div><h2 id="verify-that-the-node-is-healthy">Verify that the node is healthy</h2><p>Run <code>kubectl get nodes -o wide</code> and containerd appears as the runtime for the node we just changed.</p><h2 id="remove-docker-engine">Remove Docker Engine</h2><div class="alert alert-secondary callout third-party-content" role="alert"><strong>Note:</strong> This section links to third party projects that provide functionality required by Kubernetes. The Kubernetes project authors aren't responsible for these projects, which are listed alphabetically. To add a project to this list, read the <a href="/docs/contribute/style/content-guide/#third-party-content">content guide</a> before submitting a change. <a href="#third-party-content-disclaimer">More information.</a></div><p>If the node appears healthy, remove Docker.</p><ul class="nav nav-tabs" id="tab-remove-docker-engine" role="tablist"><li class="nav-item"><a data-toggle="tab" class="nav-link active" href="#tab-remove-docker-engine-0" role="tab" aria-controls="tab-remove-docker-engine-0" aria-selected="true">CentOS</a></li><li class="nav-item"><a data-toggle="tab" class="nav-link" href="#tab-remove-docker-engine-1" role="tab" aria-controls="tab-remove-docker-engine-1">Debian</a></li><li class="nav-item"><a data-toggle="tab" class="nav-link" href="#tab-remove-docker-engine-2" role="tab" aria-controls="tab-remove-docker-engine-2">Fedora</a></li><li class="nav-item"><a data-toggle="tab" class="nav-link" href="#tab-remove-docker-engine-3" role="tab" aria-controls="tab-remove-docker-engine-3">Ubuntu</a></li></ul><div class="tab-content" id="tab-remove-docker-engine"><div id="tab-remove-docker-engine-0" class="tab-pane show active" role="tabpanel" aria-labelledby="tab-remove-docker-engine-0"><p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>sudo yum remove docker-ce docker-ce-cli
</span></span></code></pre></div></p></div><div id="tab-remove-docker-engine-1" class="tab-pane" role="tabpanel" aria-labelledby="tab-remove-docker-engine-1"><p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>sudo apt-get purge docker-ce docker-ce-cli
</span></span></code></pre></div></p></div><div id="tab-remove-docker-engine-2" class="tab-pane" role="tabpanel" aria-labelledby="tab-remove-docker-engine-2"><p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>sudo dnf remove docker-ce docker-ce-cli
</span></span></code></pre></div></p></div><div id="tab-remove-docker-engine-3" class="tab-pane" role="tabpanel" aria-labelledby="tab-remove-docker-engine-3"><p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>sudo apt-get purge docker-ce docker-ce-cli
</span></span></code></pre></div></p></div></div><p>The preceding commands don't remove images, containers, volumes, or customized configuration files on your host.
To delete them, follow Docker's instructions to <a href="https://docs.docker.com/engine/install/ubuntu/#uninstall-docker-engine">Uninstall Docker Engine</a>.</p><div class="alert alert-caution" role="alert"><h4 class="alert-heading">Caution:</h4>Docker's instructions for uninstalling Docker Engine create a risk of deleting containerd. Be careful when executing commands.</div><h2 id="uncordon-the-node">Uncordon the node</h2><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>kubectl uncordon &lt;node-to-uncordon&gt;
</span></span></code></pre></div><p>Replace <code>&lt;node-to-uncordon&gt;</code> with the name of your node you previously drained.</p></div>